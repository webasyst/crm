import{aL as I,h as A,R as q,d as L,aM as J,o as s,c as v,b as O,$ as se,X as z,aN as le,ae as P,aO as Y,l as W,i as x,w as H,F as C,q as ee,P as N,u as E,H as re,a0 as ne,a4 as R,a as y,n as j,p as M,j as $,r as G,A as K,e as D}from"./main-82f77a11.js";import{_ as ue}from"./SortableList.vue_vue_type_script_setup_true_lang-70c99b80.js";import{_ as ie}from"./InputWithContacts.vue_vue_type_script_setup_true_lang-cc1fd72c.js";import{C as te}from"./CustomColumn-096f9d5b.js";import{a as oe}from"./FieldCheckbox-c89d2635.js";import{F as B}from"./FieldSelect-342147aa.js";import{f as T}from"./fields-b3506619.js";function ce(m){let f=JSON.stringify(I(m));const r=A(!1);q(m,()=>{r.value=f!==JSON.stringify(I(m))},{deep:!0});function V(){setTimeout(()=>{f=JSON.stringify(I(m)),r.value=!1})}return{modified:r,reset:V}}const de={class:"tw-flex tw-space-x-2"},me=L({__name:"FieldBirthday",props:{modelValue:{},optionsForDaySelect:{},optionsForMonthSelect:{},errors:{}},emits:["update:modelValue"],setup(m,{emit:f}){const r=m,V=J({day:"",month:"",year:"",...Object.fromEntries(r.modelValue.map(p=>[p.field,p.value??""]))});q(V,p=>{f("update:modelValue",Object.entries(p).filter(c=>c[1]).map(c=>({field:c[0],value:c[1]})))});function g(p){if(r.errors)return r.errors.find(c=>c.field.split(".")[1]===p)}return(p,c)=>{var b,U,h;return s(),v("div",de,[O(B,{modelValue:V.day,"onUpdate:modelValue":c[0]||(c[0]=F=>V.day=F),options:r.optionsForDaySelect,"error-message":(b=g("day"))==null?void 0:b.description,class:"tw-w-18 md:tw-w-20"},null,8,["modelValue","options","error-message"]),O(B,{modelValue:V.month,"onUpdate:modelValue":c[1]||(c[1]=F=>V.month=F),options:r.optionsForMonthSelect,"error-message":(U=g("month"))==null?void 0:U.description,class:"tw-w-auto md:tw-w-36"},null,8,["modelValue","options","error-message"]),O(oe,{modelValue:V.year,"onUpdate:modelValue":c[2]||(c[2]=F=>V.year=F),"error-message":(h=g("year"))==null?void 0:h.description,type:"number",class:"tw-w-20"},null,8,["modelValue","error-message"])])}}}),pe=se("regions",()=>{const m=A({});function f(r){return r in m.value||(m.value[r]=z(`crm.region.list?country=${r}`).get().json()),m.value[r]}return{regions:m,getRegionByCode:f}}),ve=L({__name:"FieldAddress",props:{modelValue:{},fields:{},errors:{}},emits:["update:modelValue"],setup(m,{emit:f}){const r=m,{getRegionByCode:V}=pe(),g=A(U()),p=A([]),{pause:c,resume:b}=le(g,()=>f("update:modelValue",g.value.filter(a=>a.value).map(a=>({field:a.id,value:a.value}))),{deep:!0,immediate:!0});q(()=>r.modelValue,async()=>{c(),g.value=U(),await P(),b()}),q(()=>{var a;return(a=g.value.find(n=>n.id==="country"))==null?void 0:a.value},async a=>{if(p.value=[],a){const{data:n}=await V(a);n.value&&(p.value=n.value.sort((o,d)=>+d.is_favorite-+o.is_favorite))}},{immediate:!0}),q(()=>{var a;return(a=g.value.find(n=>n.id==="country"))==null?void 0:a.value},()=>{const a=g.value.find(n=>n.id==="region");a&&(a.value="")});function U(){return r.fields.map(a=>{var n;return{...a,value:((n=r.modelValue.find(o=>o.field===a.id))==null?void 0:n.value)??""}})}async function h(a){var n;if(await P(),a.el){const o=document.createElement("option");o.innerText="──────────",o.setAttribute("disabled","disabled"),(n=a.el.querySelector("select").querySelectorAll("option")[p.value.filter(d=>d.is_favorite).length||-1])==null||n.after(o)}}const F=Y((a,n)=>n&&n.find(o=>{if(o.description&&typeof o.description=="object"){for(const d of Object.keys(o.description))if(d===a)return!0}return o.field.split(".")[1]===a})),S=W(()=>a=>{const n=F(a,r.errors);return n?n.description&&typeof n.description=="object"?n.description[a]:n.description:""});return(a,n)=>(s(),x(te,{space:"2"},{default:H(()=>[(s(!0),v(C,null,ee(g.value,o=>(s(),v(C,{key:o.id},[o.id==="country"?(s(),x(B,{key:0,modelValue:o.value,"onUpdate:modelValue":d=>o.value=d,options:o.type==="select"?o.option_values:[],placeholder:o.name,"error-message":S.value(o.id)},null,8,["modelValue","onUpdate:modelValue","options","placeholder","error-message"])):o.id==="region"?(s(),v(C,{key:1},[p.value.length?(s(),x(B,{key:p.value.length,modelValue:o.value,"onUpdate:modelValue":d=>o.value=d,options:p.value.map(d=>({id:d.code,value:d.name})),placeholder:o.name,"error-message":S.value(o.id),onVnodeMounted:n[0]||(n[0]=d=>h(d))},null,8,["modelValue","onUpdate:modelValue","options","placeholder","error-message"])):(s(),x(oe,{key:1,modelValue:o.value,"onUpdate:modelValue":d=>o.value=d,type:"text",placeholder:o.name,"error-message":S.value(o.id)},null,8,["modelValue","onUpdate:modelValue","placeholder","error-message"]))],64)):o.type==="select"||o.type==="radio"?(s(),x(N(E(T)[o.type]),{key:2,modelValue:o.value,"onUpdate:modelValue":d=>o.value=d,options:o.option_values,vertical:!0,placeholder:o.name,"error-message":S.value(o.id)},null,8,["modelValue","onUpdate:modelValue","options","placeholder","error-message"])):(s(),x(N(E(T)[o.type]),{key:3,modelValue:o.value,"onUpdate:modelValue":d=>o.value=d,placeholder:o.name,"error-message":S.value(o.id)},null,8,["modelValue","onUpdate:modelValue","placeholder","error-message"]))],64))),128))]),_:1}))}});async function Q(){var r;await P();const m=document.querySelector(".dialog-content"),f=m==null?void 0:m.querySelector(".state-error");m&&f&&(m.scrollTop=(f.offsetTop||((r=f.offsetParent)==null?void 0:r.offsetTop)||0)-200)}const ye={key:0},we={class:"toggle rounded small"},_e={key:1,class:"tw-text-center"},he=y("div",{class:"spinner custom-p-16 tw-mt-6"},null,-1),fe=[he],ge={key:2},Ve={key:0,class:"tw-flex tw-flex-col md:tw-flex-row tw-space-y-1 md:tw-space-y-0 md:tw-space-x-2"},xe={class:"md:tw-flex-none md:tw-w-32 small gray tw-break-words md:tw-pt-1.5"},ke={class:"tw-flex-auto"},Fe={class:"tw-w-full md:tw-w-60 tw-flex-none tw-flex tw-space-x-2"},Ue={class:"tw-flex-auto"},Se={key:0,class:"text-yellow"},$e={class:"tw-flex-auto"},be={key:0,class:"handle tw-pt-1.5"},Ae=y("i",{class:"fas fa-grip-vertical gray"},null,-1),qe=[Ae],Ce={class:"tw-flex tw-flex-wrap tw-flex-auto tw-flex-col md:tw-flex-row tw-gap-2 tw-items-start"},Me={class:"tw-w-full md:tw-w-60 tw-flex-none tw-flex tw-space-x-2"},Ne={class:"tw-flex-auto"},Ee=["onClick"],Te=y("i",{class:"fas fa-trash-alt"},null,-1),je=[Te],Oe={class:"tw-w-full md:tw-w-auto tw-flex tw-space-x-2 empty:tw-hidden"},Be={key:0,class:"tw-w-1/2 md:tw-w-28 tw-flex-none"},Ie={key:1,class:"tw-w-1/2 md:tw-w-28 tw-flex-none"},Re=["onClick"],De=y("i",{class:"fas fa-trash-alt"},null,-1),Je=[De],ze=["onClick"],Pe=y("i",{class:"fas fa-plus"},null,-1),Qe=L({__name:"FormContactUpdateInfo",props:{contact:{}},setup(m,{expose:f}){var X;const r=m,{t:V}=re(),g=ne(),p=!!r.contact,c=A(((X=r.contact)==null?void 0:X.details.is_company)??!1),b=A(!1),U=A(null),h=A([]),F=J({company_contact_id:p&&r.contact.main.company_contact_id?r.contact.main.company_contact_id:"",is_company:W(()=>+c.value)}),S=J({person:null,company:null}),a={person:null,company:null};f({modified:W(()=>{var i;return(i=S[c.value?"company":"person"])==null?void 0:i.modified}),submit:d});const n=Y(async i=>{const{data:l,error:e}=await z(`crm.field.list?scope=${i}`).get().json();return{fields:l.value,error:e.value}});q(c,async i=>{var t;b.value=!0;const{fields:l,error:e}=await n(i?"company":"person");if(b.value=!1,Array.isArray(l)){a[i?"person":"company"]=h.value.length?h.value:null;const _=a[i?"company":"person"];_?h.value=_:(o(l),S[i?"company":"person"]=ce(h),(t=S[i?"company":"person"])==null||t.reset())}else U.value=e,n.clear()},{immediate:!0});function o(i){if(h.value=i.map(l=>{var _;const e=(_=r.contact)==null?void 0:_.data.filter(w=>w.field===l.id);let t;if(l.type==="composite"){const w={value:[],...l.ext?{ext:l.id==="address"?"":l.ext[0].id}:{}};t={...l,error:[],dummy:{...w},value:Array.isArray(e)&&e.length?e.map(k=>({value:Array.isArray(k.value)?k.value:[],...l.ext?{ext:k.ext}:{}})):[{...w}]}}else{const w={value:"",...l.ext?{ext:l.ext[0].id}:{}};t={...l,error:[],dummy:{...w},value:Array.isArray(e)&&e.length?e.map(k=>({value:Array.isArray(k.value)?"":k.value,...l.ext?{ext:k.ext}:{}})):[{...w}]}}return{...t,...l.is_required?{validate:R.object({value:R.string().min(1,{message:V("validation.required")})}).array()}:{}}}),g.query.phone){const l=h.value.find(e=>e.id==="phone");l&&(l.value[0].value=g.query.phone.toString())}}function d(){let i;if(h.value.forEach(e=>{if(["name","company","firstname","middlename","lastname"].includes(e.id)&&(e.value[0].value=String(e.value[0].value).trim()),e.validate)try{e.validate.parse(e.value)}catch(t){if(t instanceof R.ZodError){if(e.is_required&&t.errors[0]){const _=Array.isArray(e.value[0].value)?e.value[0].value[0].value:e.value[0].value;e.error=[{code:t.errors[0].code,description:t.errors[0].message,field:e.id,value:_}]}i=!0}}}),i)return setTimeout(()=>Q()),null;const l=h.value.filter(e=>e.value.filter(t=>t.value&&(Array.isArray(t.value)?t.value.filter(_=>_).length:!0)).length).reduce((e,t)=>{const{value:_}=t;return e.push(..._.map(w=>({field:t.id,value:w.value,ext:w.ext}))),e},[]);return l.push(...Object.entries(F).filter(e=>e[1]!=="").map(e=>({field:e[0],value:e[1]}))),z(`crm.contact.${p?`update?id=${r.contact.id}`:"add"}`,{onFetchError(e){try{const t=JSON.parse(e.data);"error_fields"in t&&ae(t.error_fields)}catch{}return e}})[p?"put":"post"](JSON.stringify(l))}function ae(i){var l;for(const e of i)for(const t of e.field.split(", ")){const _=t.includes(".")?t.split(".")[0]:t,w=h.value.find(k=>k.id===_);w&&(w.type==="composite"?w.error=i:(l=w.error)==null||l.push(e))}Q()}return(i,l)=>(s(),x(te,{space:"4"},{default:H(()=>[p?$("",!0):(s(),v("div",ye,[y("div",we,[y("span",{class:j({selected:!c.value}),onClick:l[0]||(l[0]=e=>c.value=!1)},M(i.$t("person")),3),y("span",{class:j({selected:c.value}),onClick:l[1]||(l[1]=e=>c.value=!0)},M(i.$t("company")),3)])])),b.value?(s(),v("div",_e,fe)):U.value?(s(),v("div",ge,M(U.value),1)):(s(),v(C,{key:3},[i.$slots.firstFieldValue?(s(),v("div",Ve,[y("div",xe,[G(i.$slots,"firstFieldTitle")]),y("div",ke,[y("div",Fe,[y("div",Ue,[G(i.$slots,"firstFieldValue")])])])])):$("",!0),(s(!0),v(C,null,ee(h.value,e=>(s(),v("div",{key:e.id,class:"tw-flex tw-flex-col md:tw-flex-row tw-space-y-1 md:tw-space-y-0 md:tw-space-x-2"},[y("div",{class:j(["md:tw-flex-none md:tw-w-32 small gray tw-break-words",{"md:tw-pt-1.5":!["radio","checkbox"].includes(e.type)}])},[K(M(e.name),1),e.is_required?(s(),v("span",Se,"*")):$("",!0)],2),y("div",$e,[O(ue,{list:e.value,"use-sort":!0,"min-length":2,onUpdate:t=>{e.value=t}},{default:H(({index:t})=>{var _,w,k,Z;return[y("div",{class:j(["tw-flex tw-space-x-2",t>0&&"bordered-top tw-pt-2"])},[e.value.length>1?(s(),v("div",be,qe)):$("",!0),y("div",Ce,[e.id==="birthday"&&e.type==="composite"?(s(),x(me,{key:0,modelValue:e.value[t].value,"onUpdate:modelValue":u=>e.value[t].value=u,"options-for-day-select":((_=e.fields.find(u=>u.id==="day"&&u.type==="select"))==null?void 0:_.option_values)||[],"options-for-month-select":((w=e.fields.find(u=>u.id==="month"&&u.type==="select"))==null?void 0:w.option_values)||[],errors:e.error},null,8,["modelValue","onUpdate:modelValue","options-for-day-select","options-for-month-select","errors"])):(s(),v(C,{key:1},[y("div",Me,[y("div",Ne,[e.id==="company"&&!c.value?(s(),x(ie,{key:0,"is-multiple":!1,"text-value":e.value[t].value,"is-company":!0,"on-item-select":u=>{F.company_contact_id=u.id,e.value[t].value=u.name},onInput:u=>{F.company_contact_id="",e.value[t].value=u}},null,8,["text-value","on-item-select","onInput"])):e.id==="address"&&e.type==="composite"?(s(),x(ve,{key:1,modelValue:e.value[t].value,"onUpdate:modelValue":u=>e.value[t].value=u,fields:e.fields,errors:e.error},null,8,["modelValue","onUpdate:modelValue","fields","errors"])):(s(),x(N(E(T)[e.type]),{key:2,modelValue:e.value[t].value,"onUpdate:modelValue":u=>e.value[t].value=u,"error-message":(Z=(k=e.error)==null?void 0:k.find(u=>u.value===e.value[t].value))==null?void 0:Z.description,options:e.type==="select"||e.type==="radio"?e.option_values:void 0,fields:e.type==="composite"?e.fields:void 0,required:e.is_required,placeholder:t>0?`${e.name} ${t+1}`:void 0,vertical:e.type==="radio"?!0:void 0},null,8,["modelValue","onUpdate:modelValue","error-message","options","fields","required","placeholder","vertical"]))]),t>0?(s(),v("a",{key:0,class:"md:tw-hidden !tw-mt-1.5",onClick:D(u=>e.value.splice(t,1),["prevent"])},je,8,Ee)):$("",!0)]),y("div",Oe,[e.ext?(s(),v("div",Be,[(s(),x(N(E(T).select),{modelValue:e.value[t].ext,"onUpdate:modelValue":u=>e.value[t].ext=u,required:!0,options:[...e.ext,{id:e.ext.filter(u=>u.id===e.value[t].ext).length?"":e.value[t].ext??"",value:i.$t("other")}]},null,8,["modelValue","onUpdate:modelValue","options"]))])):$("",!0),Array.isArray(e.ext)&&!e.ext.find(u=>u.id===e.value[t].ext)?(s(),v("div",Ie,[(s(),x(N(E(T).string),{modelValue:e.value[t].ext,"onUpdate:modelValue":u=>e.value[t].ext=u},null,8,["modelValue","onUpdate:modelValue"]))])):$("",!0)])],64)),t>0?(s(),v("a",{key:2,class:"tw-hidden md:tw-block !tw-mt-1.5",onClick:D(()=>{e.value.splice(t,1)},["prevent"])},Je,8,Re)):$("",!0)])],2)]}),_:2},1032,["list","onUpdate"]),e.is_multi?(s(),v("a",{key:0,class:"button rounded outlined light-gray smaller !tw-mt-2",onClick:D(t=>e.value.push({...e.dummy}),["prevent"])},[Pe,K(" "+M(i.$t("addMore")),1)],8,ze)):$("",!0)])]))),128))],64))]),_:3}))}});export{Qe as _,Q as s,ce as u};
