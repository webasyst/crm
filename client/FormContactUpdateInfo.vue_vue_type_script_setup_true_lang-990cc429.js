import{aI as z,a as b,P as C,d as K,aJ as P,o as s,c as m,e as N,Z as se,U as W,aK as le,ad as H,aL as ee,A as L,b as k,w as Z,F as q,l as te,N as T,g as B,H as re,$ as ne,a3 as D,i as p,n as I,k as M,f as F,r as Q,m as X,p as J}from"./main-07d84941.js";import{_ as ue}from"./SortableList.vue_vue_type_script_setup_true_lang-e995921a.js";import{_ as ie}from"./InputWithContacts.vue_vue_type_script_setup_true_lang-4ab9d7cb.js";import{C as oe}from"./CustomColumn-36c752a1.js";import{F as ae}from"./FieldString-83da0a5f.js";import{F as R}from"./FieldSelect-efa962b1.js";import{f as O}from"./fields-198fafc2.js";function ce(d){let h=JSON.stringify(z(d));const r=b(!1);C(d,()=>{r.value=h!==JSON.stringify(z(d))},{deep:!0});function g(){setTimeout(()=>{h=JSON.stringify(z(d)),r.value=!1})}return{modified:r,reset:g}}const de={class:"tw-flex tw-space-x-2"},me=K({__name:"FieldBirthday",props:{modelValue:{},optionsForDaySelect:{},optionsForMonthSelect:{},errors:{}},emits:["update:modelValue"],setup(d,{emit:h}){const r=d,g=P({day:"",month:"",year:"",...Object.fromEntries(r.modelValue.map(v=>[v.field,v.value??""]))});C(g,v=>{h("update:modelValue",Object.entries(v).filter(i=>i[1]).map(i=>({field:i[0],value:i[1]})))});function f(v){if(r.errors)return r.errors.find(i=>i.field.split(".")[1]===v)}return(v,i)=>{var $,U,_;return s(),m("div",de,[N(R,{modelValue:g.day,"onUpdate:modelValue":i[0]||(i[0]=x=>g.day=x),options:r.optionsForDaySelect,"error-message":($=f("day"))==null?void 0:$.description,class:"tw-w-18 md:tw-w-20"},null,8,["modelValue","options","error-message"]),N(R,{modelValue:g.month,"onUpdate:modelValue":i[1]||(i[1]=x=>g.month=x),options:r.optionsForMonthSelect,"error-message":(U=f("month"))==null?void 0:U.description,class:"tw-w-auto md:tw-w-36"},null,8,["modelValue","options","error-message"]),N(ae,{modelValue:g.year,"onUpdate:modelValue":i[2]||(i[2]=x=>g.year=x),"error-message":(_=f("year"))==null?void 0:_.description,type:"number",class:"tw-w-20"},null,8,["modelValue","error-message"])])}}}),pe=se("regions",()=>{const d=b({});function h(r){return r in d.value||(d.value[r]=W(`crm.region.list?country=${r}`).get().json()),d.value[r]}return{regions:d,getRegionByCode:h}}),ve=K({__name:"FieldAddress",props:{modelValue:{},fields:{},errors:{}},emits:["update:modelValue"],setup(d,{emit:h}){const r=d,{getRegionByCode:g}=pe(),f=b(U()),v=b([]),{pause:i,resume:$}=le(f,()=>h("update:modelValue",f.value.filter(l=>l.value).map(l=>({field:l.id,value:l.value}))),{deep:!0,immediate:!0});C(()=>r.modelValue,async()=>{i(),f.value=U(),await H(),$()}),C(()=>{var l;return(l=f.value.find(c=>c.id==="country"))==null?void 0:l.value},async l=>{if(v.value=[],l){const{data:c}=await g(l);c.value&&(v.value=c.value.sort((o,A)=>+A.is_favorite-+o.is_favorite))}},{immediate:!0}),C(()=>{var l;return(l=f.value.find(c=>c.id==="country"))==null?void 0:l.value},()=>{const l=f.value.find(c=>c.id==="region");l&&(l.value="")});function U(){return r.fields.map(l=>{var c;return{...l,value:((c=r.modelValue.find(o=>o.field===l.id))==null?void 0:c.value)??""}})}async function _(l){var c;if(await H(),l.el){const o=document.createElement("option");o.innerText="──────────",o.setAttribute("disabled","disabled"),(c=l.el.querySelector("select").querySelectorAll("option")[v.value.filter(A=>A.is_favorite).length||-1])==null||c.after(o)}}const x=ee((l,c)=>c&&c.find(o=>o.field.split(".")[1]===l)),S=L(()=>l=>x(l,r.errors));return(l,c)=>(s(),k(oe,{space:"2"},{default:Z(()=>[(s(!0),m(q,null,te(f.value,o=>{var A,j,E,n,a;return s(),m(q,{key:o.id},[o.id==="country"?(s(),k(R,{key:0,modelValue:o.value,"onUpdate:modelValue":e=>o.value=e,options:o.type==="select"?o.option_values:[],placeholder:o.name,"error-message":(A=S.value(o.id))==null?void 0:A.description},null,8,["modelValue","onUpdate:modelValue","options","placeholder","error-message"])):o.id==="region"?(s(),m(q,{key:1},[v.value.length?(s(),k(R,{key:v.value.length,modelValue:o.value,"onUpdate:modelValue":e=>o.value=e,options:v.value.map(e=>({id:e.code,value:e.name})),placeholder:o.name,"error-message":(j=S.value(o.id))==null?void 0:j.description,onVnodeMounted:c[0]||(c[0]=e=>_(e))},null,8,["modelValue","onUpdate:modelValue","options","placeholder","error-message"])):(s(),k(ae,{key:1,modelValue:o.value,"onUpdate:modelValue":e=>o.value=e,type:"text",placeholder:o.name,"error-message":(E=S.value(o.id))==null?void 0:E.description},null,8,["modelValue","onUpdate:modelValue","placeholder","error-message"]))],64)):o.type==="select"||o.type==="radio"?(s(),k(T(B(O)[o.type]),{key:2,modelValue:o.value,"onUpdate:modelValue":e=>o.value=e,options:o.option_values,vertical:!0,placeholder:o.name,"error-message":(n=S.value(o.id))==null?void 0:n.description},null,8,["modelValue","onUpdate:modelValue","options","placeholder","error-message"])):(s(),k(T(B(O)[o.type]),{key:3,modelValue:o.value,"onUpdate:modelValue":e=>o.value=e,placeholder:o.name,"error-message":(a=S.value(o.id))==null?void 0:a.description},null,8,["modelValue","onUpdate:modelValue","placeholder","error-message"]))],64)}),128))]),_:1}))}});async function Y(){var r;await H();const d=document.querySelector(".dialog-content"),h=d==null?void 0:d.querySelector(".state-error");d&&h&&(d.scrollTop=(h.offsetTop||((r=h.offsetParent)==null?void 0:r.offsetTop)||0)-200)}const ye={key:0},we={class:"toggle rounded small"},_e={key:1,class:"tw-text-center"},he=p("div",{class:"spinner custom-p-16 tw-mt-6"},null,-1),fe=[he],ge={key:2},Ve={key:0,class:"tw-flex tw-flex-col md:tw-flex-row tw-space-y-1 md:tw-space-y-0 md:tw-space-x-2"},ke={class:"md:tw-flex-none md:tw-w-32 small gray tw-break-words md:tw-pt-1.5"},xe={class:"tw-flex-auto"},Fe={class:"tw-w-full md:tw-w-60 tw-flex-none tw-flex tw-space-x-2"},Ue={class:"tw-flex-auto"},Se={key:0,class:"text-yellow"},$e={class:"tw-flex-auto"},Ae={key:0,class:"handle tw-pt-1.5"},be=p("i",{class:"fas fa-grip-vertical gray"},null,-1),Ce=[be],qe={class:"tw-flex tw-flex-wrap tw-flex-auto tw-flex-col md:tw-flex-row tw-gap-2 tw-items-start"},Ee={key:1,class:"tw-flex tw-space-x-2 tw-w-full md:tw-w-60 tw-flex-none"},Me=["onClick"],Ne=p("i",{class:"fas fa-trash-alt"},null,-1),Te=[Ne],Be={class:"tw-w-full md:tw-w-60 tw-flex-none tw-flex tw-space-x-2"},Oe={class:"tw-flex-auto"},je=["onClick"],Ie=p("i",{class:"fas fa-trash-alt"},null,-1),Je=[Ie],Re={class:"tw-w-full md:tw-w-auto tw-flex tw-space-x-2 empty:tw-hidden"},ze={key:0,class:"tw-w-1/2 md:tw-w-28 tw-flex-none"},De={key:1,class:"tw-w-1/2 md:tw-w-28 tw-flex-none"},Pe=["onClick"],We=p("i",{class:"fas fa-trash-alt"},null,-1),He=[We],Le=["onClick"],Ze=p("i",{class:"fas fa-plus"},null,-1),ot=K({__name:"FormContactUpdateInfo",props:{contact:{}},setup(d,{expose:h}){var E;const r=d,{t:g}=re(),f=ne(),v=!!r.contact,i=b(((E=r.contact)==null?void 0:E.details.is_company)??!1),$=b(!1),U=b(null),_=b([]),x=P({company_contact_id:v&&r.contact.main.company_contact_id?r.contact.main.company_contact_id:"",is_company:L(()=>+i.value)}),S=P({person:null,company:null}),l={person:null,company:null};h({modified:L(()=>{var n;return(n=S[i.value?"company":"person"])==null?void 0:n.modified}),submit:A});const c=ee(async n=>{const{data:a,error:e}=await W(`crm.field.list?scope=${n}`).get().json();return{fields:a.value,error:e.value}});C(i,async n=>{var t;$.value=!0;const{fields:a,error:e}=await c(n?"company":"person");if($.value=!1,Array.isArray(a)){l[n?"person":"company"]=_.value.length?_.value:null;const w=l[n?"company":"person"];w?_.value=w:(o(a),S[n?"company":"person"]=ce(_),(t=S[n?"company":"person"])==null||t.reset())}else U.value=e,c.clear()},{immediate:!0});function o(n){if(_.value=n.map(a=>{var w;const e=(w=r.contact)==null?void 0:w.data.filter(y=>y.field===a.id);let t;if(a.type==="composite"){const y={value:[],...a.ext?{ext:a.ext[0].id}:{}};t={...a,error:[],dummy:{...y},value:Array.isArray(e)&&e.length?e.map(V=>({value:Array.isArray(V.value)?V.value:[],...a.ext?{ext:V.ext}:{}})):[{...y}]}}else{const y={value:"",...a.ext?{ext:a.ext[0].id}:{}};t={...a,error:[],dummy:{...y},value:Array.isArray(e)&&e.length?e.map(V=>({value:Array.isArray(V.value)?"":V.value,...a.ext?{ext:V.ext}:{}})):[{...y}]}}return{...t,...a.is_required?{validate:D.object({value:D.string().min(1,{message:g("validation.required")})}).array()}:{}}}),f.query.phone){const a=_.value.find(e=>e.id==="phone");a&&(a.value[0].value=f.query.phone.toString())}}function A(){let n;if(_.value.forEach(e=>{if(["name","company","firstname","middlename","lastname"].includes(e.id)&&(e.value[0].value=String(e.value[0].value).trim()),e.validate)try{e.validate.parse(e.value)}catch(t){if(t instanceof D.ZodError){if(e.is_required&&t.errors[0]){const w=Array.isArray(e.value[0].value)?e.value[0].value[0].value:e.value[0].value;e.error=[{code:t.errors[0].code,description:t.errors[0].message,field:e.id,value:w}]}n=!0}}}),n)return setTimeout(()=>Y()),null;const a=_.value.filter(e=>e.value.filter(t=>t.value&&(Array.isArray(t.value)?t.value.filter(w=>w).length:!0)).length).reduce((e,t)=>{const{value:w}=t;return e.push(...w.map(y=>({field:t.id,value:y.value,ext:y.ext}))),e},[]);return a.push(...Object.entries(x).filter(e=>e[1]!=="").map(e=>({field:e[0],value:e[1]}))),W(`crm.contact.${v?`update?id=${r.contact.id}`:"add"}`,{onFetchError(e){try{const t=JSON.parse(e.data);"error_fields"in t&&j(t.error_fields)}catch{}return e}})[v?"put":"post"](JSON.stringify(a))}function j(n){var a;for(const e of n)for(const t of e.field.split(", ")){const w=t.includes(".")?t.split(".")[0]:t,y=_.value.find(V=>V.id===w);y&&(y.type==="composite"?y.error=n:(a=y.error)==null||a.push(e))}Y()}return(n,a)=>(s(),k(oe,{space:"4"},{default:Z(()=>[v?F("",!0):(s(),m("div",ye,[p("div",we,[p("span",{class:I({selected:!i.value}),onClick:a[0]||(a[0]=e=>i.value=!1)},M(n.$t("person")),3),p("span",{class:I({selected:i.value}),onClick:a[1]||(a[1]=e=>i.value=!0)},M(n.$t("company")),3)])])),$.value?(s(),m("div",_e,fe)):U.value?(s(),m("div",ge,M(U.value),1)):(s(),m(q,{key:3},[n.$slots.firstFieldValue?(s(),m("div",Ve,[p("div",ke,[Q(n.$slots,"firstFieldTitle")]),p("div",xe,[p("div",Fe,[p("div",Ue,[Q(n.$slots,"firstFieldValue")])])])])):F("",!0),(s(!0),m(q,null,te(_.value,e=>(s(),m("div",{key:e.id,class:"tw-flex tw-flex-col md:tw-flex-row tw-space-y-1 md:tw-space-y-0 md:tw-space-x-2"},[p("div",{class:I(["md:tw-flex-none md:tw-w-32 small gray tw-break-words",{"md:tw-pt-1.5":!["radio","checkbox"].includes(e.type)}])},[X(M(e.name),1),e.is_required?(s(),m("span",Se,"*")):F("",!0)],2),p("div",$e,[N(ue,{list:e.value,"use-sort":!0,"min-length":2,onUpdate:t=>{e.value=t}},{default:Z(({index:t})=>{var w,y,V,G;return[p("div",{class:I(["tw-flex tw-space-x-2",t>0&&"bordered-top tw-pt-2"])},[e.value.length>1?(s(),m("div",Ae,Ce)):F("",!0),p("div",qe,[e.id==="birthday"&&e.type==="composite"?(s(),k(me,{key:0,modelValue:e.value[t].value,"onUpdate:modelValue":u=>e.value[t].value=u,"options-for-day-select":((w=e.fields.find(u=>u.id==="day"&&u.type==="select"))==null?void 0:w.option_values)||[],"options-for-month-select":((y=e.fields.find(u=>u.id==="month"&&u.type==="select"))==null?void 0:y.option_values)||[],errors:e.error},null,8,["modelValue","onUpdate:modelValue","options-for-day-select","options-for-month-select","errors"])):e.id==="address"&&e.type==="composite"?(s(),m("div",Ee,[N(ve,{modelValue:e.value[t].value,"onUpdate:modelValue":u=>e.value[t].value=u,fields:e.fields,errors:e.error},null,8,["modelValue","onUpdate:modelValue","fields","errors"]),t>0?(s(),m("a",{key:0,class:"md:tw-hidden !tw-mt-1.5",onClick:J(u=>e.value.splice(t,1),["prevent"])},Te,8,Me)):F("",!0)])):(s(),m(q,{key:2},[p("div",Be,[p("div",Oe,[e.id==="company"&&!i.value?(s(),k(ie,{key:0,"is-multiple":!1,"text-value":e.value[t].value,"is-company":!0,"on-item-select":u=>{x.company_contact_id=u.id,e.value[t].value=u.name},onInput:u=>{x.company_contact_id="",e.value[t].value=u}},null,8,["text-value","on-item-select","onInput"])):(s(),k(T(B(O)[e.type]),{key:1,modelValue:e.value[t].value,"onUpdate:modelValue":u=>e.value[t].value=u,"error-message":(G=(V=e.error)==null?void 0:V.find(u=>u.value===e.value[t].value))==null?void 0:G.description,options:e.type==="select"||e.type==="radio"?e.option_values:void 0,fields:e.type==="composite"?e.fields:void 0,required:e.is_required,placeholder:t>0?`${e.name} ${t+1}`:void 0,vertical:e.type==="radio"?!0:void 0},null,8,["modelValue","onUpdate:modelValue","error-message","options","fields","required","placeholder","vertical"]))]),t>0?(s(),m("a",{key:0,class:"md:tw-hidden !tw-mt-1.5",onClick:J(u=>e.value.splice(t,1),["prevent"])},Je,8,je)):F("",!0)]),p("div",Re,[e.ext?(s(),m("div",ze,[(s(),k(T(B(O).select),{modelValue:e.value[t].ext,"onUpdate:modelValue":u=>e.value[t].ext=u,required:!0,options:[...e.ext,{id:e.ext.filter(u=>u.id===e.value[t].ext).length?"":e.value[t].ext??"",value:n.$t("other")}]},null,8,["modelValue","onUpdate:modelValue","options"]))])):F("",!0),e.ext&&!e.ext.find(u=>u.id===e.value[t].ext)?(s(),m("div",De,[(s(),k(T(B(O).string),{modelValue:e.value[t].ext,"onUpdate:modelValue":u=>e.value[t].ext=u},null,8,["modelValue","onUpdate:modelValue"]))])):F("",!0)])],64)),t>0?(s(),m("a",{key:3,class:"tw-hidden md:tw-block !tw-mt-1.5",onClick:J(()=>{e.value.splice(t,1)},["prevent"])},He,8,Pe)):F("",!0)])],2)]}),_:2},1032,["list","onUpdate"]),e.is_multi?(s(),m("a",{key:0,class:"button rounded outlined light-gray smaller !tw-mt-2",onClick:J(t=>e.value.push({...e.dummy}),["prevent"])},[Ze,X(" "+M(n.$t("addMore")),1)],8,Le)):F("",!0)])]))),128))],64))]),_:3}))}});export{ot as _,Y as s,ce as u};
