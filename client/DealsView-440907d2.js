import{d as F,az as L,aA as Y,aB as X,l as B,I as le,o as t,i as $,w as d,b as y,k as A,a as s,p as b,v as J,u,c as g,F as x,q as T,e as C,n as D,B as O,ag as G,t as N,j as S,s as Z,x as ee,_ as se,J as ue,A as U,H as ne,N as fe,aC as me,h as q,aD as he,D as ve,aE as ge,at as $e,aq as we,R as Q,aF as ye,aG as be,a2 as ke,a1 as oe,S as K,r as de,aH as Fe,ao as Se,aI as Ce,V as Ie,m as Ve,T as De,Z as Be,aJ as xe,aK as re,aL as Re,aM as Ne}from"./main-d7f03521.js";import{Q as Me,b as Pe,c as Le}from"./index-884c82be.js";import{U as M}from"./UserPic-c11efadd.js";import{M as j,_ as P,D as W}from"./DropDown-7a0f8902.js";import{D as H}from"./DropDownButton-b07233c5.js";import{C as Ee,a as He}from"./ChipsList-ee14164a.js";import{v as _e}from"./vTooltip-95186f83.js";import{_ as pe}from"./WaDialogOpener.vue_vue_type_script_setup_true_lang-3fb68752.js";import{_ as Te,a as Ue,b as Ae}from"./FormFields.vue_vue_type_script_setup_true_lang-461a1a71.js";import{D as ze}from"./DropdownModal-9b06143e.js";import{W as qe}from"./WaSpinner-49827d4a.js";import{a as Qe,_ as Oe}from"./DealNavigateBack.vue_vue_type_script_setup_true_lang-fe2b6086.js";import{a as je}from"./FieldCheckbox-2a93227f.js";import{e as We}from"./emit-b4342586.js";import Ke from"./FormDealAdd-d9b7ad91.js";import"./index-dc17eb5d.js";import"./CustomColumn-83646d88.js";import"./DropdownAddTags.vue_vue_type_script_setup_true_lang-fb37638e.js";import"./useSortable-eb883c7d.js";import"./WaDialogLoading.vue_vue_type_script_setup_true_lang-5cab029d.js";import"./object_hash-44c1703e.js";import"./ButtonSubmit-bbd5ca4e.js";import"./fields-39e1f9f0.js";import"./FieldSelect-ae6f0f9b.js";import"./FormContactUpdateInfo.vue_vue_type_script_setup_true_lang-953db84b.js";import"./SortableList.vue_vue_type_script_setup_true_lang-43da3720.js";import"./InputWithContacts.vue_vue_type_script_setup_true_lang-941f63e0.js";import"./InputWithPerformers.vue_vue_type_script_setup_true_lang-47aeec90.js";import"./recentContacts-8eea64ba.js";import"./dayjs-8b9f8f59.js";import"./TextAreaAutoresize-64fc87cf.js";const z=(l,n)=>{if(l=String(l),n!=null&&n.includes(l))return l;const e=Number(l);return isNaN(e)?null:e},E=l=>typeof l=="string"?l:null;function Ye(l){const n=!!Object.keys(l).length;if(n)for(const e in l)l[e]=decodeURIComponent(l[e]);return{filters:(()=>{const e={};if(!n)return e;const o=E(l.funnel);o&&(e.funnel=z(o));const a=E(l.stage);a&&(e.stage=z(a,["won","lost"]));const f=E(l.tag);f&&(e.tag=z(f));const c=E(l.user_id);c&&(e.user_id=z(c));const h=E(l.pinned_only);h&&(e.pinned_only=z(h));const m=E(l.search);return m&&(e.search=m),e})(),sort:(()=>{const e={};if(!n)return e;const o=E(l.sort);o&&(e.sort=o);const a=E(l.asc);return a&&(e.asc=z(a)?1:0),e})()}}const Xe=["onClick"],Je=F({__name:"DropdownSort",setup(l){const n=["reminder_datetime","create_datetime","last_action","name","amount","user_name"],e=L(),o=Y(X(),"isKanban"),a=B(()=>[...o.value?[]:["stage_id"],...n]),f=B(()=>`sort-amount-${e.sort.asc?"up":"down"}`),c=B(()=>o.value&&!n.includes(e.sort.sort)?"reminder_datetime":e.sort.sort),h=r=>{o.value&&e.sort.sort==="stage_id"?e.updateSort({sort:r,asc:e.sort.asc?0:1}):e.toggleSort(r)},m=le(Me);return(r,_)=>(t(),$(W,{right:!0},{default:d(()=>[y(H,{class:"nobutton mobile:tw-px-1","mobile-w-full":!0,width:"auto",title:r.$t(`sort_${c.value}`)},{icon:d(()=>[y(M,{"fa-icon":f.value,size:14},null,8,["fa-icon"])]),default:d(()=>[A(s("span",null,b(r.$t(`sort_${c.value}`)),513),[[J,!u(m)]])]),_:1},8,["title"])]),body:d(({hide:v})=>[y(j,null,{default:d(()=>[(t(!0),g(x,null,T(a.value,p=>(t(),$(P,{key:p,selected:c.value===p},{default:d(()=>[s("a",{onClick:C(i=>{h(p),v()},["prevent"])},b(r.$t(`sort_${p}`)),9,Xe)]),_:2},1032,["selected"]))),128))]),_:2},1024)]),_:1}))}}),Ge=["onClick"],Ze=s("i",{class:"fas fa-star",style:{color:"inherit"}},null,-1),es=[Ze],ss=F({__name:"PinnedFunnelToggler",props:{modelValue:{type:Boolean},funnelId:{}},emits:["update:modelValue"],setup(l,{emit:n}){const e=l,o=async()=>{var c;const a=!e.modelValue,f={id:e.funnelId,state:a?"pin":"unpin"};(c=window.$)==null||c.post(`${O.baseUrl}?module=funnel&action=pin`,f,h=>{h.status==="ok"&&(n("update:modelValue",a),window.document.documentElement.dispatchEvent(new Event("spa:reloadSidebar")))})};return(a,f)=>(t(),g("span",{class:D(["icon size-16",[e.modelValue?"tw-text-waAccent":"text-light-gray"]]),onClick:C(o,["stop","prevent"])},es,10,Ge))}}),ts={class:"tw-truncate tw-ml-0.5 tw-mr-1"},as={key:0,class:"tw-ml-1 small"},ls=["onClick"],ns=["onClick"],os={class:"icon"},is={key:0,class:"tw-ml-1"},rs={class:"count"},cs={class:"tw-mr-1"},us=F({__name:"DropdownFunnels",props:{hideOptionAll:{type:Boolean},roundedButton:{type:Boolean}},setup(l){const n=l,e=G(),{funnels:o,selectedFunnel:a,isFetching:f}=N(e);e.fetch();const c=L(),{filterParams:h}=N(c);function m(r,_){var v;r==="all"?c.updateFilterParams({funnel:void 0,stage:void 0}):c.updateFilterParams({funnel:r,...((v=h.value)==null?void 0:v.funnel)!==r?{stage:void 0}:{}}),typeof _=="function"&&_()}return(r,_)=>(t(),$(W,{width:"300px"},{default:d(()=>[y(H,{rounded:n.roundedButton,"is-skeleton":u(f)&&!u(a),width:"auto","skeleton-min-width":"12rem",style:{color:"var(--text-color-stronger)"}},{icon:d(()=>[u(a)?(t(),$(M,{key:u(a).icon,size:16,"icon-class":u(a).icon,"icon-color":u(a).color},null,8,["icon-class","icon-color"])):S("",!0)]),default:d(()=>{var v,p;return[s("span",{class:D(["tw-flex tw-items-center",{gray:(v=u(a))==null?void 0:v.is_archived}])},[s("span",ts,b(u(a)?u(a).name:r.$t("allFunnels")),1),(p=u(a))!=null&&p.is_archived?(t(),g("span",as,b(r.$t("archived")),1)):S("",!0)],2)]}),_:1},8,["rounded","is-skeleton"])]),body:d(({hide:v})=>[y(j,null,{default:d(()=>[n.hideOptionAll?S("",!0):(t(),$(P,{key:"all"},{default:d(()=>[s("a",{onClick:C(p=>m("all",v),["prevent"])},[s("span",null,b(r.$t("allFunnels")),1)],8,ls)]),_:2},1024)),(t(!0),g(x,null,T(u(o),p=>(t(),$(P,{key:p.id},{default:d(()=>[s("a",{onClick:C(i=>m(p.id,v),["prevent"])},[s("div",os,[y(M,{size:10,"icon-class":p.icon,"icon-color":p.color},null,8,["icon-class","icon-color"])]),s("span",{class:D({gray:p.is_archived})},[s("span",null,b(p.name),1),p.is_archived?(t(),g("span",is,b(r.$t("archived")),1)):S("",!0)],2),s("span",rs,[s("span",cs,b(p.deal_count),1),!u(O).webView&&!p.is_archived?(t(),$(ss,{key:0,modelValue:p.is_pinned,"onUpdate:modelValue":i=>p.is_pinned=i,"funnel-id":p.id},null,8,["modelValue","onUpdate:modelValue","funnel-id"])):S("",!0)])],8,ns)]),_:2},1024))),128))]),_:2},1024)]),_:1}))}}),ie=l=>(Z("data-v-295feeb8"),l=l(),ee(),l),ds={class:"filters-button"},_s={key:0},ps=ie(()=>s("i",{class:"fas fa-spinner wa-animation-spin"},null,-1)),fs=[ps],ms={key:1},hs=ie(()=>s("i",{class:"fas fa-filter"},null,-1)),vs=[hs],gs={key:0,class:"icon size-8 rounded filters-button__has"},$s=ie(()=>s("i",{class:"fas fa-circle text-red circle"},null,-1)),ws=[$s],ys=F({__name:"DealsHeaderFiltersButton",props:{modelValue:{type:Boolean},hasFilters:{type:Boolean},loading:{type:Boolean}},emits:["update:modelValue"],setup(l,{emit:n}){const e=l;return(o,a)=>(t(),g("span",ds,[s("button",{class:D(["button circle blank !tw-shadow-none",{"filters-button--active":e.modelValue}]),onClick:a[0]||(a[0]=C(f=>!e.loading&&n("update:modelValue",!e.modelValue),["prevent"]))},[e.loading?(t(),g("span",_s,fs)):(t(),g("span",ms,vs))],2),!e.loading&&e.hasFilters?(t(),g("span",gs,ws)):S("",!0)]))}});const bs=se(ys,[["__scopeId","data-v-295feeb8"]]),ks=["onClick"],Fs={class:"tw-p-2"},Ss=["onClick"],Cs={class:"tw-flex-auto tw-truncate"},Is=F({__name:"DropdownTags",setup(l){const n=ue(),{tags:e}=N(n),o=L(),{filterParams:a,firstDeal:f}=N(o),c=B(()=>{var h,m;if(typeof a.value.tag=="number"){const r=e.value.find(_=>_.id===a.value.tag);return!r&&((m=(h=f.value)==null?void 0:h.tags)!=null&&m.length)?f.value.tags.find(_=>_.id===a.value.tag):r}});return(h,m)=>(t(),$(W,{width:"270px"},{default:d(()=>[y(H,{small:!0,highlight:!!c.value,width:"9rem"},{icon:d(()=>[y(M,{size:14,"fa-icon":"hashtag"})]),default:d(()=>[U(" "+b(c.value?c.value.name:h.$t("Tags")),1)]),_:1},8,["highlight"])]),body:d(({hide:r})=>[c.value?(t(),$(j,{key:0},{default:d(()=>[y(P,null,{default:d(()=>[s("a",{onClick:C(_=>{u(o).deleteFilterParam("tag"),r()},["prevent"])},[s("span",null,b(h.$t("showAll")),1)],8,ks)]),_:2},1024)]),_:2},1024)):S("",!0),s("div",Fs,[y(Ee,null,{default:d(()=>[(t(!0),g(x,null,T(u(e),_=>{var v;return t(),$(He,{key:_.id+String(_.color),color:_.color,"bg-color":_.bg_color,class:D(["smaller",{selected:((v=c.value)==null?void 0:v.id)===_.id}])},{default:d(()=>[s("a",{onClick:C(p=>{u(o).updateFilterParams({tag:_.id}),r()},["prevent"])},[s("span",Cs,b(_.name),1)],8,Ss)]),_:2},1032,["color","bg-color","class"])}),128))]),_:2},1024)])]),_:1}))}}),Vs=["onClick"],Ds=["onClick"],Bs={class:"icon small"},xs={class:"count"},Rs=s("hr",{class:"tw-m-0"},null,-1),Ns=["onClick"],Ms={class:"icon small"},Ps=F({__name:"DropdownStages",setup(l){const{t:n}=ne(),{selectedFunnel:e}=N(G()),o=L(),{filterParams:a,firstDeal:f}=N(o),c=B(()=>{var _;return e.value&&((_=e.value.stages)!=null&&_.length)?e.value.stages:[]}),h=B(()=>c.value.length),m=B(()=>{var _,v;return[{id:"won",name:n("wons"),color:((_=e.value)==null?void 0:_.color)||"",icon:"flag-checkered"},{id:"lost",name:n("losts"),color:((v=e.value)==null?void 0:v.color)||"",icon:"ban"}]}),r=B(()=>{var _,v,p;switch(typeof((_=a.value)==null?void 0:_.stage)){case"number":if(h.value)return c.value.find(i=>i.id===a.value.stage);if((v=f.value)!=null&&v.stage)return{...(p=f.value)==null?void 0:p.stage,icon:null};break;case"string":return m.value.find(i=>i.id===a.value.stage)}});return(_,v)=>(t(),$(W,{disabled:!h.value},fe({default:d(()=>[y(H,{small:!0,disabled:!h.value,highlight:!!r.value},{icon:d(()=>[r.value?(t(),g(x,{key:0},[r.value.icon?(t(),$(M,{key:r.value.color,size:10,"fa-icon":r.value.icon,"icon-color":r.value.color},null,8,["fa-icon","icon-color"])):(t(),$(M,{key:r.value.id,size:10,"disable-rounded":"","bg-color":r.value.color},null,8,["bg-color"]))],64)):S("",!0)]),default:d(()=>[U(" "+b(r.value?r.value.name:_.$t("allStages")),1)]),_:1},8,["disabled","highlight"])]),_:2},[h.value?{name:"body",fn:d(({hide:p})=>[y(j,null,{default:d(()=>[(t(),$(P,{key:"all"},{default:d(()=>[s("a",{onClick:C(i=>{u(o).deleteFilterParam("stage"),p()},["prevent"])},[s("span",null,b(_.$t("allStages")),1)],8,Vs)]),_:2},1024)),(t(!0),g(x,null,T(c.value,i=>(t(),$(P,{key:i.id},{default:d(()=>[s("a",{onClick:C(w=>{u(o).updateFilterParams({stage:i.id}),p()},["prevent"])},[s("div",Bs,[y(M,{size:10,"disable-rounded":"","bg-color":i.color},null,8,["bg-color"])]),s("span",null,b(i.name),1),s("span",xs,b(i.deal_count),1)],8,Ds)]),_:2},1024))),128)),Rs,(t(!0),g(x,null,T(m.value,i=>(t(),$(P,{key:i.id},{default:d(()=>[s("a",{onClick:C(w=>{u(o).updateFilterParams({stage:i.id}),p()},["prevent"])},[s("div",Ms,[(t(),$(M,{key:i.color,size:10,"fa-icon":i.icon,"icon-color":i.color},null,8,["fa-icon","icon-color"]))]),s("span",null,b(i.name),1)],8,Ns)]),_:2},1024))),128))]),_:2},1024)]),key:"0"}:void 0]),1032,["disabled"]))}}),Ls=s("i",{class:"fas fa-user-slash"},null,-1),Es=s("i",{class:"fas fa-users"},null,-1),Hs=["onClick"],Ts=s("div",{class:"icon"},[s("i",{class:"fas fa-users"})],-1),Us=["onClick"],As=s("div",{class:"icon"},[s("i",{class:"fas fa-user-slash"})],-1),zs=["onClick"],qs={class:"icon"},Qs={class:"count"},Os=F({__name:"DropdownResponsibles",setup(l){const n=me(),{responsibles:e}=N(n),o=L(),{filterParams:a}=N(o),f=B(()=>{if(typeof a.value.user_id=="number")return n.getResponsibleById(a.value.user_id)}),c=B(()=>{var m;return((m=a.value)==null?void 0:m.user_id)===0});function h(m){m==="all"?o.deleteFilterParam("user_id"):o.updateFilterParams({user_id:m})}return(m,r)=>(t(),$(W,null,{default:d(()=>[f.value?(t(),$(H,{key:0,small:!0,highlight:!0},{icon:d(()=>[y(M,{size:16,url:f.value.responsible.userpic},null,8,["url"])]),default:d(()=>[U(" "+b(f.value.responsible.name),1)]),_:1})):c.value?(t(),$(H,{key:1,small:!0,highlight:!0},{icon:d(()=>[Ls]),default:d(()=>[U(" "+b(m.$t("noResponsible")),1)]),_:1})):(t(),$(H,{key:2,small:!0},{icon:d(()=>[Es]),default:d(()=>[U(" "+b(m.$t("allResponsibles")),1)]),_:1}))]),body:d(({hide:_})=>[y(j,null,{default:d(()=>[(t(),$(P,{key:"all"},{default:d(()=>[s("a",{onClick:C(v=>{h("all"),_()},["prevent"])},[Ts,s("span",null,b(m.$t("allResponsibles")),1)],8,Hs)]),_:2},1024)),(t(),$(P,{key:0},{default:d(()=>[s("a",{onClick:C(v=>{h(0),_()},["prevent"])},[As,s("span",null,b(m.$t("noResponsible")),1)],8,Us)]),_:2},1024)),(t(!0),g(x,null,T(u(e),v=>(t(),$(P,{key:v.responsible.id},{default:d(()=>[s("a",{onClick:C(p=>{h(v.responsible.id),_()},["prevent"])},[s("div",qs,[y(M,{size:10,url:v.responsible.userpic},null,8,["url"])]),s("span",null,b(v.responsible.name),1),s("span",Qs,b(v.count),1)],8,zs)]),_:2},1024))),128))]),_:2},1024)]),_:1}))}}),te=l=>(Z("data-v-0d899fca"),l=l(),ee(),l),js={key:0,class:"state-with-inner-icon left"},Ws=["placeholder"],Ks={key:0,class:"icon icon-spinner"},Ys=te(()=>s("i",{class:"fas fa-spinner wa-animation-spin"},null,-1)),Xs=[Ys],Js={key:1,class:"icon icon-search"},Gs=te(()=>s("i",{class:"fas fa-search"},null,-1)),Zs=[Gs],et=te(()=>s("i",{class:"fas fa-times"},null,-1)),st=[et],tt=te(()=>s("span",{class:"icon"},[s("i",{class:"fas fa-search"})],-1)),at=[tt],lt=F({__name:"InputSearch",props:{modelValue:{},isFetching:{type:Boolean}},emits:["update:modelValue","close"],setup(l,{emit:n}){const e=l,o=q(),a=he(e,"modelValue");return ve(o,f=>{f.focus()}),(f,c)=>(t(),g("div",null,[u(a)!==void 0?(t(),g("div",js,[A(s("input",$e({ref_key:"inputEl",ref:o,"onUpdate:modelValue":c[0]||(c[0]=h=>we(a)?a.value=h:null),type:"search",class:"small",placeholder:f.$t("search")},f.$attrs),null,16,Ws),[[ge,u(a)]]),f.isFetching?(t(),g("span",Ks,Xs)):(t(),g("span",Js,Zs)),s("span",{class:"icon icon-close",onClick:c[1]||(c[1]=h=>{a.value=void 0,n("close")})},st)])):(t(),g("button",{key:1,class:"button square light-gray",onClick:c[2]||(c[2]=C(h=>a.value="",["prevent"]))},at))]))}});const nt=se(lt,[["__scopeId","data-v-0d899fca"]]),ot=F({__name:"DealsHeaderSearch",setup(l){const n=L(),{onBeforeClearFilters:e,updateFilterParams:o,deleteFilterParam:a}=n,f=Y(n,"filterParams"),c=q(f.value.search);Q(f,r=>{c.value=r.search});const h=ye(r=>{r=r.trim(),o({search:r})},550);e(m);function m(){c.value=void 0,a("search")}return(r,_)=>(t(),$(nt,{modelValue:c.value,"onUpdate:modelValue":_[0]||(_[0]=v=>c.value=v),onInput:_[1]||(_[1]=v=>u(h)(v.target.value)),onClose:m},null,8,["modelValue"]))}}),it=["onClick"],rt=s("i",{class:"fas fa-star"},null,-1),ct=[rt],ut=F({__name:"DealsHeaderFavorites",setup(l){const n=L(),e=B(()=>!!n.filterParams.pinned_only);function o(){n.updateFilterParams({pinned_only:e.value?void 0:1})}return(a,f)=>(t(),g("div",null,[A((t(),g("button",{class:D(["button square",[e.value?"orange":"light-gray"]]),onClick:C(o,["prevent"])},[s("span",{class:D(["icon size-14",{"!tw-text-waBlank":e.value}])},ct,2)],10,it)),[[u(_e),a.$t("showFavorites"),void 0,{bottom:!0}]])]))}}),dt=l=>(Z("data-v-53039755"),l=l(),ee(),l),_t={class:"deals-header__filters"},pt=dt(()=>s("i",{class:"fas fa-times-circle text-gray"},null,-1)),ft=[pt],mt={key:0,class:"skeleton deals-header__filters"},ht=F({__name:"DealsHeaderFilters",props:{hideStages:{type:Boolean},hasFilters:{type:Boolean},showSkeleton:{type:Boolean}},emits:["clear"],setup(l,{emit:n}){const e=l;return(o,a)=>(t(),g(x,null,[A(s("div",_t,[e.hideStages?S("",!0):(t(),$(Ps,{key:0})),y(Os),y(Is),y(ut),y(ot),e.hasFilters?(t(),g("button",{key:1,class:"deals-header__filters-clear button small nobutton light-gray",onClick:a[0]||(a[0]=f=>n("clear"))},ft)):S("",!0)],512),[[J,!e.showSkeleton]]),e.showSkeleton?(t(),g("div",mt,[(t(),g(x,null,T(3,f=>s("span",{key:f,class:"skeleton-line deals-header__filters-skeleton"})),64))])):S("",!0)],64))}});const vt=se(ht,[["__scopeId","data-v-53039755"]]),gt=F({__name:"FormDealsListFields",setup(l){const{t:n}=ne(),e=be(),{isKanban:o}=X(),a=[{id:"id",name:"ID",value:"",sort:0},{id:"amount",name:n("amount"),value:"",sort:0},{id:"user",name:n("responsible"),value:"",sort:0,hide:o},{id:"tags",name:n("tags"),value:"",sort:0},{id:"last_action",name:n("lastAction"),value:"",sort:0,hide:o}];return(f,c)=>(t(),$(Te,{scope:"deal","except-fields":[],"static-fields":a,"prepare-fetch-params":h=>({deal_funnel_columns:[{funnel_id:String(u(e).fetchParams.funnel),columns:h.map(m=>({field:m}))}]}),"sort-params-if-field-removed":{sort:"create_datetime",asc:0}},null,8,["prepare-fetch-params"]))}}),$t=l=>(Z("data-v-c404687f"),l=l(),ee(),l),wt=["title","onClick"],yt=$t(()=>s("div",{class:"icon"},[s("i",{class:"fas fa-table"})],-1)),bt={key:0,class:"tw-ml-1.5"},kt=F({__name:"DealsHeaderFieldsButton",props:{label:{},hideLabel:{type:Boolean}},setup(l){const n=l;return(e,o)=>(t(),$(pe,{component:gt},{default:d(({open:a})=>[s("button",{class:"deals-form-fields-button button light-gray square",title:n.label,onClick:C(a,["prevent"])},[yt,n.hideLabel?S("",!0):(t(),g("span",bt,b(n.label),1))],8,wt)]),_:1}))}});const Ft=se(kt,[["__scopeId","data-v-c404687f"]]),St=["disabled","onClick"],Ct={class:"tw-flex tw-items-center tw-gap-2"},It={class:"icon"},Vt=F({__name:"ActionButtonList",props:{items:{},space:{}},setup(l){const n=l;return(e,o)=>(t(),g("div",{class:D(`tw-flex tw-gap-${n.space||0}`)},[(t(!0),g(x,null,T(n.items,(a,f)=>(t(),g(x,{key:f},[a.hide?S("",!0):(t(),g("button",{key:0,disabled:a.disableClick,class:"light-gray",onClick:c=>!a.disableClick&&a.clickHandler()},[s("div",Ct,[s("span",It,[s("i",{class:D(["fas",a.classIcon])},null,2)]),s("span",null,b(a.label),1)])],8,St))],64))),128))],2))}}),Dt=["src"],Bt=F({__name:"FormDealExportCSV",props:{ids:{}},setup(l){const n=l,e=q(!0),o={height:"400px",width:"100%"};return(a,f)=>(t(),$(ke,{"hide-buttons":!0},{default:d(()=>[e.value?(t(),$(qe,{key:0,style:o})):S("",!0),A(s("iframe",{src:`${u(O).baseUrl}?module=deal&action=export&ids=${n.ids.join(",")}`,style:o,frameborder:"0",onLoad:f[0]||(f[0]=c=>e.value=!1)},null,40,Dt),[[J,!e.value]])]),_:1}))}}),xt={class:"deals-header__edit small"},Rt={class:"deals-header__edit-selected-deals"},Nt={class:"tw-hidden xl:tw-inline-block tw-mr-2"},Mt={class:"badge user tw-bg-waAccent tw-min-w-[0.5rem] tw-justify-center"},Pt={class:"deals-header__edit-buttons"},Lt=s("span",{class:"icon"},[s("i",{class:"fas fa-times-circle"})],-1),Et={class:"tw-hidden xl:tw-inline-block tw-ml-2"},Ht=F({__name:"DealsHeaderBulkEdit",setup(l){var v;const n=oe(),{t:e}=ne(),o=L(),{countChecked:a,isAllChecked:f,bulkSelectIds:c}=N(o),h=le(Pe),m=q(f.value?"1":""),r=q([...(v=O.rights)!=null&&v.export?[{label:e("export"),classIcon:"fas fa-download",clickHandler:()=>{K(Bt,{ids:c.value}).show()}}]:[],{label:e("merge"),classIcon:"fas fa-users",hide:!0,clickHandler:()=>n.push({name:"dealMerge",query:{ids:c.value.join(",")}})},{label:e("changeResponsible"),classIcon:"fas fa-user-check",hide:!0,clickHandler:()=>({})},{label:e("changeFunnelOrStage"),classIcon:"fas fa-exchange-alt",hide:!0,clickHandler:()=>({})},{label:e("addTags"),classIcon:"fas fa-hashtag",clickHandler:()=>K(Ue,{entityType:"deal",entityIds:c.value}).show()},{label:e("removeTags"),classIcon:"fas fa-hashtag",clickHandler:()=>K(Ae,{entityType:"deal",entityIds:c.value}).show()},{label:e("close"),classIcon:"fas fa-flag-checkered",hide:!0,clickHandler:()=>({})},{label:e("delete"),classIcon:"fas fa-trash-alt text-red",clickHandler:()=>K(Qe,{ids:c.value,isBulkMode:!0}).show()}]);Q(a,p=>{r.value[1].hide=p<2},{immediate:!0}),Q(f,p=>{p?m.value="1":m.value="",(a.value===0||p)&&_(p)});function _(p){o.toggleChecked(p)}return(p,i)=>(t(),g("div",xt,[s("div",Rt,[y(je,{modelValue:m.value,"onUpdate:modelValue":i[0]||(i[0]=w=>m.value=w),size:16,onChange:i[1]||(i[1]=w=>_(!!w))},{default:d(()=>[s("span",Nt,b(p.$t("selected")),1),s("span",Mt,b(u(a)),1)]),_:1},8,["modelValue"])]),s("div",Pt,[u(h)?(t(),$(ze,{key:0,items:r.value},{default:d(()=>[y(H,{width:"8rem"},{default:d(()=>[U(b(p.$t("actions")),1)]),_:1})]),_:1},8,["items"])):(t(),$(Vt,{key:1,class:"deals-header__edit-actions",items:r.value,space:"2"},null,8,["items"])),s("button",{type:"button",class:"button outlined gray small",onClick:i[2]||(i[2]=C(w=>_(!1),["prevent"]))},[Lt,s("span",Et,b(p.$t("cancel")),1)])])]))}});const ce=F({__name:"ToggleListItem",props:{modelValue:{},value:{}},emits:["update:modelValue"],setup(l,{emit:n}){return(e,o)=>(t(),g("span",{class:D({selected:e.modelValue===e.value}),onClick:o[0]||(o[0]=a=>n("update:modelValue",e.value))},[de(e.$slots,"default")],2))}}),Tt=F({__name:"ToggleList",props:{size:{},rounded:{type:Boolean}},setup(l){const n=l;return(e,o)=>(t(),g("div",{class:D(["toggle",n.size,n.rounded?"rounded":""])},[de(e.$slots,"default")],2))}}),Ut={class:"deals-header"},At={class:"deals-header__inner"},zt={key:0,class:"deals-header__heading--native"},qt={key:1,class:"deals-header__heading--web"},Qt={key:0,class:"skeleton h1 md:tw-w-64 !tw-my-2"},Ot=s("span",{class:"skeleton-line !tw-h-7 mobile:!tw-h-6"},null,-1),jt=[Ot],Wt={class:"deals-header__left-buttons tw-space-x-4 tw-mr-4"},Kt=["title","onClick","onVnodeMounted"],Yt=s("i",{class:"fas fa-plus"},null,-1),Xt=[Yt],Jt=s("i",{class:"fas fa-columns"},null,-1),Gt=s("i",{class:"fas fa-list-ul"},null,-1),Zt={class:"deals-header__all-filters tw-flex tw-items-center tw-flex-auto tw-min-w-0 tw-flex-wrap mobile:tw-w-full mobile:tw-contents"},ea={class:"tw-flex-auto tw-flex tw-flex-wrap tw-min-w-0"},sa={class:"tw-ml-auto mobile:tw-ml-1 tw-flex tw-items-center tw-flex-nowrap tw-gap-1"},ta=F({__name:"DealsHeader",setup(l){const n=le(Le),e=L(),{hasFilters:o,countChecked:a,isSingleFunnelMode:f}=N(e),c=X(),{currentView:h,isKanban:m}=N(c),r=G();r.fetch();const _=oe(),v=q(!1),p=_.currentRoute.value.path==="/deal/new/",i=B(()=>{var k;return!!((k=r.selectedFunnel)!=null&&k.is_archived)});function w(k){c.switchViewMode(k),_.push({name:Fe[k],query:_.currentRoute.value.query}).then(()=>e.forceUpdate())}return(k,I)=>{var V;return t(),g("div",Ut,[u(a)?(t(),$(Ht,{key:0})):S("",!0),A(s("div",At,[u(O).webView?(t(),g("div",zt,[y(Oe)])):(t(),g("div",qt,[u(f)?(t(),g(x,{key:0},[u(r).isFetching?(t(),g("div",Qt,jt)):(V=u(r).selectedFunnel)!=null&&V.name?A((t(),g("h1",{key:u(r).selectedFunnel.name,class:"h1"},[U(b(u(r).selectedFunnel.name),1)])),[[u(_e),u(r).selectedFunnel.name,void 0,{top:!0}]]):S("",!0)],64)):(t(),$(us,{key:1,"hide-option-all":u(m),"rounded-button":!0,class:"tw-mr-4"},null,8,["hide-option-all"])),s("div",Wt,[y(pe,{component:Ke,"component-props":{funnelId:u(e).filterParams.funnel,...p&&k.$route.query.contact?{contactId:k.$route.query.contact}:{},onAdded:u(We)}},{default:d(({open:R})=>[s("button",{title:i.value?k.$t("archivedFunnelIsNotAvailableForDealCreation"):k.$t("newDeal"),class:D(["circle",{"tw-opacity-40 tw-cursor-default":i.value}]),onClick:C(ae=>!i.value&&R(),["prevent"]),onVnodeMounted:ae=>!i.value&&p&&R()},Xt,10,Kt)]),_:1},8,["component-props"]),u(h)?(t(),$(Tt,{key:0,rounded:""},{default:d(()=>[y(ce,{"model-value":u(h),value:"kanban","onUpdate:modelValue":I[0]||(I[0]=R=>w(R))},{default:d(()=>[Jt]),_:1},8,["model-value"]),y(ce,{"model-value":u(h),value:"list","onUpdate:modelValue":I[1]||(I[1]=R=>w(R))},{default:d(()=>[Gt]),_:1},8,["model-value"])]),_:1})):S("",!0)])])),s("div",Zt,[s("div",{class:D(["deals-header__filters-container",{"deals-header__filters-container--hide":!v.value}])},[y(vt,{"has-filters":u(o),"hide-stages":u(m),"show-skeleton":!u(e).filtersIsLoaded,onClear:u(e).clearFilters},null,8,["has-filters","hide-stages","show-skeleton","onClear"])],2),s("div",ea,[y(bs,{modelValue:v.value,"onUpdate:modelValue":I[2]||(I[2]=R=>v.value=R),class:"deals-header__filters-button tw-hidden","has-filters":u(o),loading:!u(e).filtersIsLoaded},null,8,["modelValue","has-filters","loading"]),s("div",sa,[u(r).selectedFunnel&&!u(n)?(t(),$(Ft,{key:0,label:k.$t(u(m)?"customizeFields":"customizeColumns"),"hide-label":u(m)},null,8,["label","hide-label"])):S("",!0),u(n)||u(m)?(t(),$(Je,{key:1})):S("",!0)])])])],512),[[J,!u(a)]])])}}});const aa={class:"deals blank box contentbox"},Pa=F({__name:"DealsView",props:{routeName:{},routeQuery:{}},setup(l){const n=l,e=oe(),o=L(),a=X(),f=ue(),c=Y(o,"isSingleFunnelMode"),h=Y(G(),"funnels");let m=c.value;o.updateIsSingleFunnelMode(),console.log("first loading",n.routeName),e.currentRoute.value.path!=="/deal/new/"&&(e.replace({name:r(n.routeName),query:n.routeQuery}),_(n.routeQuery).then(i=>{const w={...n.routeQuery};i&&(w.funnel=String(i)),console.log("first loading:query",w),p(w)})),Se(()=>{f.refetchIfHasChanges()}),Q([()=>o.filterParams,()=>o.sort],async([i,w])=>{console.log("watch:filterParams",w),await v({...xe(i),...w.sort===re.sort&&w.asc===re.asc?{}:w})},{deep:!0}),Ce((i,w,k)=>{if(console.log("onBeforeRouteUpdate",{to:i,from:w}),("all_funnels"in i.query||"funnel"in i.query)&&(m=c.value,o.updateIsSingleFunnelMode(i.query.all_funnels!=="1")),i.name==="deals"){if(w.query.all_funnels!=="1"&&i.query.funnel&&i.query.funnel===w.query.funnel||w.query.all_funnels==="1"&&i.query.all_funnels==="1"){o.reloadList();return}r(i.name),p(i.query);return}else i.name!==w.name&&r(i.name);k()}),Ie(Re).on(o.reloadList);function r(i){return c.value?a.switchViewModeWithLocalStorage(i):a.switchViewModeWithAppState(i)}async function _({funnel:i}){return new Promise(w=>{const k=I=>{var R;let V=null;i&&!isNaN(Number(i))&&(V=parseInt(i)),I.find(ae=>ae.id===V)||(V=((R=o.currentFiltersStorage.deal_list_filter)==null?void 0:R.funnel_id)||null),c.value&&!V&&I[0]&&(V=I[0].id),w(V)};if(h.value.length)k(h.value);else{const I=Q(h,V=>{k(V),I()})}})}async function v(i){const w={};for(const[I,V]of Object.entries(i))Ne.includes(I)&&V!=null&&(w[I]=encodeURIComponent(String(V)));c.value||(w.all_funnels="1");const k=a.currentViewName;return console.log("updateFiltersInURL:name",k),await e.replace({name:k,query:w})}function p(i){const{filters:w,sort:k}=Ye(i);console.log("isSingleFunnelMode",c.value),console.log("previousIsSingleFunnelMode",m),console.log("filters:",w),console.log("sort:",k),o.updateFilterParamsFromQuery(w,k)}return(i,w)=>{const k=Ve("router-view");return t(),g("div",aa,[y(ta),y(k,null,{default:d(({Component:I})=>[y(De,{name:"fade",mode:"out-in"},{default:d(()=>[(t(),$(Be(I)))]),_:2},1024)]),_:1})])}}});export{Pa as default};
