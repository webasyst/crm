import{d as X,aR as B,h as k,H as Z,am as ee,o as A,i as R,w as g,a as b,p as C,b as Q,c as V,k as te,n as ae,aB as se,j as q,e as j,A as F,a0 as Y,Q as ne,l as L,u as oe,ad as H,M as N,br as re,R as G,ay as le}from"./main-46836c41.js";import{b as K}from"./emit-c388f0d7.js";import{a as ie}from"./alert-1ed8dffa.js";import{B as P}from"./ButtonSubmit-c3bae343.js";import{F as ue}from"./FieldSelect-19a80dbd.js";const ce={class:"gray"},de={class:"smaller break-words"},fe={class:"fields"},ve={class:"field"},me={class:"name"},_e={class:"value"},he={key:0,class:"field"},pe=b("div",{class:"name"},null,-1),ge={class:"value"},ye=["placeholder"],Se={key:0,class:"state-error-hint"},M="0",be=X({__name:"FormConfirmLostReasonStage",props:{scopeActions:{},dealName:{}},setup(n){const f=n,o=B({reasonId:"",customText:""}),u=B({reasonId:!1,customText:!1}),_=k(!0),h=k([]),v=k(!1),p=k(""),{lostReasonList:O,changeCloseStage:D}=f.scopeActions,{t:y}=Z();ee(async()=>{p.value="";const{error:i,data:c}=await O();c.value&&(_.value=c.value.required,c.value.lostreasons.forEach(e=>{var t;(t=h.value)==null||t.push({id:String(e.id),value:e.name})}),c.value.allow_custom&&h.value.push({id:M,value:y("otherReason")})),p.value=i.value||""});function I(){return Object.values(u).every(i=>i===!1)}function E(){for(const i in u)u[i]=!1}async function $(){var s;if(p.value="",u.reasonId=_.value&&!o.reasonId,u.customText=o.reasonId===M&&!o.customText,!I())return;const i=o.reasonId&&o.reasonId!==M,c=i?Number(o.reasonId):null,e=i?((s=h.value.find(a=>a.id===o.reasonId))==null?void 0:s.value)||"":o.reasonId===M?o.customText:"";v.value=!0;const{error:t}=await D({status_id:"LOST",lost_id:c,lost_text:e});v.value=!1,p.value=t.value||""}return(i,c)=>(A(),R(Y,{"use-cancel-as-button-label":"","hide-close-icon":""},{header:g(()=>[b("div",ce,C(i.$t("closeDeal")),1),b("div",de,C(f.dealName),1)]),default:g(()=>[b("div",fe,[b("div",ve,[b("div",me,C(i.$t("lostReason")),1),b("div",_e,[Q(ue,{modelValue:o.reasonId,"onUpdate:modelValue":[c[0]||(c[0]=e=>o.reasonId=e),E],"error-message":u.reasonId?i.$t("validation.required"):void 0,options:h.value},null,8,["modelValue","error-message","options"])])]),o.reasonId===M?(A(),V("div",he,[pe,b("div",ge,[te(b("input",{"onUpdate:modelValue":c[1]||(c[1]=e=>o.customText=e),type:"text",class:ae(["width-100",{"state-error":u.customText}]),placeholder:i.$t("customReason"),onChange:E},null,42,ye),[[se,o.customText]])])])):q("",!0)])]),submit:g(()=>[Q(P,{bg:"red","is-fetching":v.value,onClick:j($,["prevent"])},{default:g(()=>[F(C(i.$t("lost")),1)]),_:1},8,["is-fetching","onClick"])]),error:g(()=>[p.value?(A(),V("span",Se,C(p.value),1)):q("",!0)]),_:1}))}}),we=["innerHTML"],Ce={key:0,class:"state-error-hint"},ke=X({__name:"FormConfirmChangeStage",props:{scopeActions:{},orderActionData:{}},setup(n){const f=n,o=k(),u=k(!1),_=k(""),h=document.createElement("div");h.innerHTML=f.orderActionData.dialog_html.trim();let v;h&&(v=h.querySelector(".crm-dialog-content"),((t,s)=>{if(v){const a=v.querySelector(t);a instanceof HTMLElement&&(a.style.display=s)}})(".js-form-footer-actions","none")),ne(o,e=>{if(!e)return;const t=e.getElementsByTagName("script");if(t!=null&&t.length){const s=a=>{const m=window.eval;if(typeof m!="function"||a.src){a.remove();const r=document.createElement("script");a.type&&(r.type=a.type),a.src?r.src=a.src:r.innerHTML=a.innerHTML,e.append(r)}else m(a.innerHTML)};Array.from(t).forEach(s),e.querySelectorAll("input.hasDatepicker").forEach(a=>{a.setAttribute("type","date")}),e.querySelectorAll("input.ui-timepicker-input").forEach(a=>{a.setAttribute("type","time")})}});const{formChangeStageOrderAction:p,forceChangeStage:O,closeModal:D}=f.scopeActions,y=L(()=>h.querySelector(".crm-dialog-header").innerText.trim()),I=L(()=>v.innerHTML),E=L(()=>{var t;const e=(t=o.value)==null?void 0:t.getElementsByTagName("form");return e!=null&&e.length?e[0]:null}),$=L(()=>f.orderActionData.action_id!==null&&E.value);async function i(){if(u.value=!0,_.value="",E.value){const e=await p({action_id:String(f.orderActionData.action_id),order_id:f.orderActionData.order_id},E.value);u.value=!1,_.value=e.error.value||""}}async function c(){u.value=!0,_.value="";const e=await O();u.value=!1,e&&(_.value=e.error.value||"")}return(e,t)=>(A(),R(Y,{"use-cancel-as-button-label":"","hide-close-icon":"",onClose:oe(D)},{header:g(()=>[F(C(y.value),1)]),default:g(()=>[b("div",{ref_key:"contentRef",ref:o,class:"break-words",innerHTML:I.value},null,8,we)]),submit:g(()=>[$.value?(A(),R(P,{key:0,"is-fetching":u.value,onClick:j(i,["prevent"])},{default:g(()=>[F(C(e.$t("submit")),1)]),_:1},8,["is-fetching","onClick"])):(A(),R(P,{key:1,"is-fetching":u.value,onClick:j(c,["prevent"])},{default:g(()=>[F(C(e.$t("changeStage")),1)]),_:1},8,["is-fetching","onClick"]))]),error:g(()=>[_.value?(A(),V("span",Ce,C(_.value),1)):q("",!0)]),_:1},8,["onClose"]))}}),l=k(null),T=k();function Oe(n){const f=B({cbSuccess:null,cbError:null,cbCancel:null});function o(e,t=null,s){var a,m;switch((a=e.response.value)==null?void 0:a.status){case 409:if(!t)return;T.value=G(ke,{scopeActions:{formChangeStageOrderAction:_,forceChangeStage:p,closeModal:I},orderActionData:t}),T.value.show();break;case 204:K(),n.value&&(l.value?("stage_id"in l.value?c(l.value.stage_id,n.value.stage_id):"status_id"in l.value&&c(null,n.value.stage_id),n.value={...n.value,...l.value,closed_datetime:new Date().toISOString()},l.value=null):c(n.value.stage_id,null)),(m=T.value)==null||m.hide(),y("success");break;default:s&&e.error.value&&ie(e.error.value),l.value=null,y("error");break}}async function u(e,t){var d;l.value=e;let s=null;const a=t?{...e,force:!0}:e,m=H.stringify({id:(d=n.value)==null?void 0:d.id}),r=await N(`crm.deal.move?${m}`,{onFetchError(w){if(typeof w.data=="string"){const S=JSON.parse(w.data);S&&"dialog_html"in S&&(s=S)}return w}}).post(a);return o(r,s,!t),r}async function _(e,t){var S,U,W,J,z;const s=re(t),a=H.stringify(e);l.value&&"lost_id"in l.value&&Object.assign(s,{crm_change_workflow_data:{id:(S=n.value)==null?void 0:S.id,action:l.value.status_id,lost_id:l.value.lost_id,lost_text:l.value.lost_text}});const m=H.stringify(s),{response:r,data:d,error:w}=await N(`crm.deal.shopaction?${a}`,{beforeFetch({options:x}){return x.headers=new Headers(x.headers),x.headers.set("Content-Type","application/x-www-form-urlencoded"),{options:x}}}).post(m).json();return(U=r.value)!=null&&U.ok&&d.value&&n.value?((W=d.value)==null?void 0:W.status_id)===n.value.status_id&&((J=d.value)==null?void 0:J.stage_id)===n.value.stage_id?y("cancel"):(K(),n.value={...n.value,stage_id:d.value.stage_id,funnel_id:d.value.funnel_id,status_id:d.value.status_id,lost_id:d.value.lost_id,lost_text:d.value.lost_text,...typeof d.value.shop_order=="object"?d.value.shop_order:{}},y("success")):y("error"),l.value=null,(z=T.value)==null||z.hide(),{response:r,data:d,error:w}}async function h(e){var t;return e==="LOST"?(T.value=G(be,{scopeActions:{lostReasonList:D,changeCloseStage:v},dealName:((t=n.value)==null?void 0:t.name)||""}),T.value.show(),!1):v({status_id:"WON"})}async function v(e,t){var d;l.value=e;let s=null;const a=t?{...e,force:!0}:e,m=H.stringify({id:(d=n.value)==null?void 0:d.id}),r=await N(`crm.deal.close?${m}`,{onFetchError(w){if(typeof w.data=="string"){const S=JSON.parse(w.data);S&&"dialog_html"in S&&(s=S)}return w}}).post(a);return o(r,s,!t&&(e==null?void 0:e.status_id)==="WON"),r}async function p(){return l.value?"status_id"in l.value?v(l.value,!0):u(l.value,!0):!1}async function O(){var t,s;const e=await N(`crm.deal.reopen?id=${(t=n.value)==null?void 0:t.id}`).post();return((s=e.response.value)==null?void 0:s.status)===204&&n.value&&(n.value={...n.value,status_id:"OPEN"}),o(e,null,!0),e}async function D(){var t;return await N(`crm.deal.lostreason.list?funnel_id=${(t=n.value)==null?void 0:t.funnel_id}`).json()}function y(e){var s;const t=`cb${e[0].toUpperCase()}${e.slice(1)}`;typeof f[t]=="function"&&((s=f[t])==null||s.call(null))}function I(){var e;(e=T.value)==null||e.hide(),y("cancel")}function E(e){f.cbSuccess=e}function $(e){f.cbError=e}function i(e){f.cbCancel=e}function c(e,t){le().funnels.forEach(s=>{s.deal_count=s.stages.reduce((a,m)=>{const r=m;return r.id===e&&(r.deal_count+=1),r.id===t&&(r.deal_count-=1),a+r.deal_count},0)})}return{modal:T,changeOpenStage:u,formChangeStageOrderAction:_,closeDeal:h,changeCloseStage:v,lostReasonList:D,forceChangeStage:p,reopenDeal:O,closeModal:I,onSuccess:E,onError:$,onCancel:i}}export{Oe as u};
