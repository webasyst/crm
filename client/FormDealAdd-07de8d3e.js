import{d as z,ao as ie,B as X,M as G,a as S,P as de,g as F,o as p,c as I,e as r,w as m,m as O,k as i,i as e,F as B,l as K,f as k,W as R,b as A,G as pe,z as Q,p as T,am as fe,q as ue,s as ce,_ as J,ap as _e,aq as he,h as ve,ar as ge,as as ye,at as be,au as $e,av as we,H as Ce,S as Ve,A as Y,j as ke,v as Ie,n as le,U as Se}from"./main-ad3d4b2a.js";import{W as Ae}from"./WaDialog-48ef549a.js";import{C as Fe,I as De,_ as Ee,D as Z,a as Ue,b as Ne,u as qe}from"./InputWithPerformers.vue_vue_type_script_setup_true_lang-c5140a20.js";import{f as Oe}from"./fields-00e92370.js";import{s as P}from"./dialog-55612c15.js";import{F as U}from"./FieldString-77b19497.js";import{i as Me,a as Re}from"./helpers-c0c14d27.js";import{d as je}from"./dayjs-e01b34a2.js";import{b as Te}from"./index-38eb481c.js";import{W as xe}from"./WaSpinner-8364792b.js";import{U as x}from"./UserPic-e76d468d.js";import{M as te,_ as se}from"./MenuList-d27c7173.js";import{D as oe}from"./DropDown-6640089d.js";import{u as Be}from"./funnels-5e77cb0b.js";import{C as ze}from"./CustomColumn-d0d2dfb9.js";import{B as ne}from"./ButtonSubmit-66512fc6.js";import"./recentContacts-6dcec390.js";import"./FieldSelect-fbb8732d.js";import"./index-f0757591.js";import"./FieldCheckbox-ea76a60e.js";const Le={key:0,class:"deal-add-custom-fields"},We={class:"fields"},He={class:"name"},Ye={class:"value"},Ge=z({__name:"FormDealAddSectionFields",props:{modelValue:{}},setup(y){const u=ie(y,"modelValue"),{t:h}=X(),_=G("crm.field.list?scope=deal").get().json(),v=S([]);return de(_.data,a=>{Array.isArray(a)&&(v.value=a.map(l=>(u.value.push({value:{field:l.id,value:""},error:"",...l.is_required?{validate:R.object({value:R.string().min(1,{message:h("validation.required")})}).array()}:{}}),l)))}),(a,l)=>F(u).length?(p(),I("section",Le,[r(Fe,null,{name:m(()=>[O(i(a.$t("addtnlInfo")),1)]),default:m(()=>[e("div",We,[(p(!0),I(B,null,K(v.value,(f,b)=>(p(),I("div",{key:f.id,class:"field"},[e("div",He,i(f.name),1),e("div",Ye,[(p(),A(pe(F(Oe)[f.type]),{modelValue:F(u)[b].value.value,"onUpdate:modelValue":$=>F(u)[b].value.value=$,vertical:f.type==="radio",options:(f.type==="select"||f.type==="radio")&&f.option_values,required:f.is_required,"error-message":F(u)[b].error},null,8,["modelValue","onUpdate:modelValue","vertical","options","required","error-message"]))])]))),128))])]),_:1})])):k("",!0)}}),Pe=y=>(ue("data-v-48f88a12"),y=y(),ce(),y),Je={class:"deal-add-customer"},Ke={class:"fields tw-mt-5 tw-mb-5"},Qe={class:"field"},Ze={class:"name"},Xe={class:"value"},ea={key:0,class:"tw-flex tw-gap-x-1 tw-mt-2"},aa=["disabled","onClick"],la=Pe(()=>e("span",{class:"tw-mr-1"},[e("i",{class:"fas fa-plus-circle"})],-1)),ta={key:0,class:"fields"},sa={class:"field"},oa={class:"name"},na={class:"value"},ra={class:"field"},ia={class:"name"},da={class:"value"},ua={class:"field"},ca={class:"name"},va={class:"value"},ma={class:"field"},pa={class:"name"},fa={class:"value"},_a={class:"field"},ha={class:"name"},ga={class:"value"},ya={class:"field"},ba={class:"name"},$a={class:"value"},wa={class:"field"},Ca={class:"name"},Va={class:"value"},ka={class:"field"},Ia={class:"name"},Sa={class:"value"},Aa=z({__name:"FormDealAddSectionCustomer",props:{initContactId:{}},emits:["updateContactId","updateContactLabel"],setup(y,{expose:w,emit:u}){const h=y,{t:_}=X(),v=S(),a=S(!1),l=S(D()),f=S("");w({validate:L,createContactOrGetExistsId:W,isFetchingContacts:Q(()=>{var s;return(s=v==null?void 0:v.value)==null?void 0:s.isFetchingContacts})});function b(s){var o,n;s?(a.value=!1,l.value={id:{value:s.id},name:{value:s.name},jobtitle:{value:s.jobtitle||""},company:{value:s.company||""},email:{value:((o=s.fields.find(N=>N.id==="email"))==null?void 0:o.value[0])??""},phone:{value:((n=s.fields.find(N=>N.id==="phone"))==null?void 0:n.value[0])??""}}):l.value=D(),u("updateContactId",(s==null?void 0:s.id)||null)}function $(){var s;a.value||(a.value=!0,(s=v.value)==null||s.clearValue(),f.value="",u("updateContactId",null))}function D(){return{id:{value:null,is_required:!a.value,validate:R.coerce.number().min(1,{message:_("validation.required")})},name:{value:""},firstname:{value:"",is_required:!0,validate:R.string().trim().min(1,{message:_("validation.required")})},middlename:{value:""},lastname:{value:""},jobtitle:{value:""},company:{value:""},email:{value:""},phone:{value:""},is_company:{value:0}}}function L(){let s=!1;return Object.entries(l.value).forEach(([,o])=>{if(o.error="",o.is_required&&o.validate)try{o.validate.parse(o.value)}catch(n){n instanceof R.ZodError&&(o.error=n.issues[0].message,s=!0)}}),s?(P(),!1):!0}async function W(){var N;if((N=l.value.id)!=null&&N.value)return l.value.id.value;if(l.value.name.value||(l.value.name.value=`${l.value.firstname.value} ${l.value.middlename.value} ${l.value.lastname.value}`),!L())return null;const s=[];Object.entries(l.value).forEach(([d,t])=>{d!=="id"&&s.push({field:d,value:t.value})});const{data:o,error:n}=await G("crm.contact.add",{onFetchError(d){var t;return typeof d.data=="string"&&((t=JSON.parse(d.data).error_fields)==null||t.forEach(C=>{if(l.value){if(C.field==="name")l.value.firstname.error=C.description;else if(C.field){const j=C.field;l.value[j].error=C.description}}}),P()),d}}).post(JSON.stringify(s));return n.value?n.value:Number(o.value)}return(s,o)=>(p(),I("section",Je,[e("div",Ke,[e("div",Qe,[e("div",Ze,i(s.$t("customers")),1),e("div",Xe,[r(De,{ref_key:"inputWithCustomersRef",ref:v,width:"320px",placeholder:s.$t("searchByNameEmailPhone"),"with-fields":["email","phone","company","jobtitle"],"init-contact-id":h.initContactId,disabled:!!h.initContactId,"error-message":l.value.id.error,onUpdate:b,onClear:o[0]||(o[0]=n=>b(null))},null,8,["placeholder","init-contact-id","disabled","error-message"]),h.initContactId?k("",!0):(p(),I("div",ea,[e("span",null,i(s.$t("or")),1),e("a",{class:"tw-font-semibold",disabled:a.value,onClick:T($,["prevent"])},[la,e("span",null,i(s.$t("addNew")),1)],8,aa)]))])])]),r(fe,{name:"fade",mode:"out-in"},{default:m(()=>[a.value||l.value.id.value?(p(),I("div",ta,[a.value?(p(),I(B,{key:0},[e("h3",null,i(s.$t("addContact")),1),e("div",sa,[e("div",oa,i(s.$t("firstName")),1),e("div",na,[r(U,{modelValue:l.value.firstname.value,"onUpdate:modelValue":o[1]||(o[1]=n=>l.value.firstname.value=n),type:"text",readonly:!a.value,"error-message":l.value.firstname.error,onKeydown:o[2]||(o[2]=n=>l.value.firstname.error="")},null,8,["modelValue","readonly","error-message"])])]),e("div",ra,[e("div",ia,i(s.$t("middleName")),1),e("div",da,[r(U,{modelValue:l.value.middlename.value,"onUpdate:modelValue":o[3]||(o[3]=n=>l.value.middlename.value=n),type:"text",readonly:!a.value,"error-message":l.value.middlename.error},null,8,["modelValue","readonly","error-message"])])]),e("div",ua,[e("div",ca,i(s.$t("lastName")),1),e("div",va,[r(U,{modelValue:l.value.lastname.value,"onUpdate:modelValue":o[4]||(o[4]=n=>l.value.lastname.value=n),type:"text",readonly:!a.value,"error-message":l.value.lastname.error},null,8,["modelValue","readonly","error-message"])])])],64)):k("",!0),e("div",ma,[e("div",pa,i(s.$t("company")),1),e("div",fa,[r(U,{modelValue:l.value.company.value,"onUpdate:modelValue":o[5]||(o[5]=n=>l.value.company.value=n),type:"text",readonly:!a.value,"error-message":l.value.company.error},null,8,["modelValue","readonly","error-message"])])]),e("div",_a,[e("div",ha,i(s.$t("jobTitle")),1),e("div",ga,[r(U,{modelValue:l.value.jobtitle.value,"onUpdate:modelValue":o[6]||(o[6]=n=>l.value.jobtitle.value=n),type:"text",readonly:!a.value,"error-message":l.value.jobtitle.error},null,8,["modelValue","readonly","error-message"])])]),e("div",ya,[e("div",ba,i(s.$t("roleInDeal")),1),e("div",$a,[r(Ee,{modelValue:f.value,"onUpdate:modelValue":[o[7]||(o[7]=n=>f.value=n),o[8]||(o[8]=n=>u("updateContactLabel",n))],scope:"CLIENT",right:!1,width:"320px"},null,8,["modelValue"])])]),e("div",wa,[e("div",Ca,i(s.$t("phone")),1),e("div",Va,[r(U,{modelValue:l.value.phone.value,"onUpdate:modelValue":o[9]||(o[9]=n=>l.value.phone.value=n),type:"text",readonly:!a.value,"error-message":l.value.phone.error},null,8,["modelValue","readonly","error-message"])])]),e("div",ka,[e("div",Ia,i(s.$t("email")),1),e("div",Sa,[r(U,{modelValue:l.value.email.value,"onUpdate:modelValue":o[10]||(o[10]=n=>l.value.email.value=n),type:"email",readonly:!a.value,"error-message":l.value.email.error},null,8,["modelValue","readonly","error-message"])])])])):k("",!0)]),_:1})]))}});const Fa=J(Aa,[["__scopeId","data-v-48f88a12"]]),Da={key:0,class:"state-error-hint tw-mt-1"},Ea=1e3,Ua=26,Na=z({__name:"TextAreaAutoresize",props:{modelValue:{},maxRows:{},errorMessage:{}},setup(y){const w=y,u=ie(w,"modelValue"),h=S();_e(h,_),he(h,["change","cut","paste","drop","input"],_);function _(){if(h.value){if((w.maxRows||Ea)*Ua<h.value.scrollHeight)return;h.value.style.height="auto",h.value.style.height=h.value.scrollHeight+"px"}}return(v,a)=>(p(),I(B,null,[ve(e("textarea",ye({ref_key:"textAreaRef",ref:h,"onUpdate:modelValue":a[0]||(a[0]=l=>be(u)?u.value=l:null),rows:"1",class:{"state-error":w.errorMessage}},v.$attrs),null,16),[[ge,F(u)]]),w.errorMessage?(p(),I("div",Da,i(w.errorMessage),1)):k("",!0)],64))}});const re=J(Na,[["__scopeId","data-v-71a56661"]]),qa={class:"select-funnel-and-stage"},Oa=["onClick"],Ma={class:"icon small"},Ra=["onClick"],ja={class:"icon small"},Ta=z({__name:"SelectFunnelAndStage",props:{funnelId:{},forceFetch:{type:Boolean}},emits:["updateStageId"],setup(y,{emit:w}){const u=y,h=Be(),_=$e(h,"funnels");u.forceFetch&&!_.value.length&&h.refetch();const v=S(),a=S();return we(()=>_.value.length,()=>{const l=_.value[0];v.value=_.value.find(f=>f.id===u.funnelId)||l,a.value=v.value.stages[0],a.value&&w("updateStageId",a.value.id)},{immediate:!0}),de(a,l=>{l&&w("updateStageId",l.id)}),(l,f)=>(p(),I("div",qa,[!_.value.length||_.value.length>1?(p(),A(oe,{key:0,class:"select-dropdown"},{body:m(({hide:b})=>[_.value.length?(p(),A(te,{key:0},{default:m(()=>[(p(!0),I(B,null,K(_.value,$=>(p(),A(se,{key:$.id},{default:m(()=>[e("a",{onClick:T(D=>{v.value=$,a.value=$.stages[0],b()},["prevent"])},[e("div",Ma,[r(x,{size:10,"disable-rounded":"","bg-color":$.color},null,8,["bg-color"])]),e("span",null,i($.name),1)],8,Oa)]),_:2},1024))),128))]),_:2},1024)):k("",!0)]),default:m(()=>[r(Z,{"color-class":"blank","mobile-w-full":"","is-skeleton":!_.value.length},{icon:m(()=>[v.value?(p(),A(x,{key:v.value.id,size:10,"disable-rounded":"","bg-color":v.value.color},null,8,["bg-color"])):k("",!0)]),title:m(()=>[O(i(v.value?v.value.name:l.$t("allStages")),1)]),_:1},8,["is-skeleton"])]),_:1})):k("",!0),r(oe,{class:"select-dropdown",disabled:!a.value},{body:m(({hide:b})=>[v.value?(p(),A(te,{key:0},{default:m(()=>[(p(!0),I(B,null,K(v.value.stages,$=>(p(),A(se,{key:$.id},{default:m(()=>[e("a",{onClick:T(D=>{a.value=$,b()},["prevent"])},[e("div",ja,[r(x,{size:10,"disable-rounded":"","bg-color":$.color},null,8,["bg-color"])]),e("span",null,i($.name),1)],8,Ra)]),_:2},1024))),128))]),_:2},1024)):k("",!0)]),default:m(()=>[r(Z,{"color-class":"blank","mobile-w-full":"","is-skeleton":!_.value.length},{icon:m(()=>[a.value?(p(),A(x,{key:a.value.id,size:10,"disable-rounded":"","bg-color":a.value.color},null,8,["bg-color"])):k("",!0)]),title:m(()=>[O(i(a.value?a.value.name:l.$t("allStages")),1)]),_:1},8,["is-skeleton"])]),_:1},8,["disabled"])]))}});const xa=J(Ta,[["__scopeId","data-v-7a630f80"]]),Ba=y=>(ue("data-v-f68f600d"),y=y(),ce(),y),za={class:"deal-add-main"},La={class:"fields"},Wa={class:"field"},Ha={class:"name"},Ya={class:"value"},Ga={class:"field"},Pa={class:"name"},Ja={class:"value"},Ka={class:"field"},Qa={class:"name"},Za={class:"value"},Xa={class:"field"},el={class:"name"},al={class:"value"},ll={class:"field-amount-wrapper"},tl={key:0,class:"hint break-word"},sl=["href"],ol=Ba(()=>e("i",{class:"fas fa-external-link-alt fa-sm"},null,-1)),nl={class:"field"},rl={class:"name"},il={class:"value"},dl={class:"field"},ul={class:"tw-flex tw-gap-x-3 tw-mr-2"},cl={class:"state-error-hint"},vl=z({__name:"FormDealAdd",props:{funnelId:{},contactId:{},conversationId:{},disableNavigateToDeal:{type:Boolean},onAdded:{type:Function}},emits:["close"],setup(y,{emit:w}){const u=y,{t:h}=X(),_=Ce(),v=Ve(Te),a=S({stage_id:{value:null,is_required:!0},name:{value:"",is_required:!0,validate:R.string().trim().min(1,{message:h("validation.required")})},description:{value:""},expected_date:{value:je().add(2,"w").format("YYYY-MM-DD")},amount:{value:""},currency_id:{value:""},contact_id:{value:Number(u.contactId)||null},contact_label:{value:""},user_contact_id:{value:Y.user.id},fields:[]}),l=S(new Map),f=S(""),b=S(null),$=Q(()=>v.value||Me()),D=Q(()=>qe().isEmptyCurrencies);function L(){var t;let d=!1;return Object.entries(a.value).forEach(([,V])=>{if(V.error="",V.is_required&&V.validate)try{V.validate.parse(V.value)}catch(C){C instanceof R.ZodError&&(V.error=C.issues[0].message,d=!0)}}),d||!((t=b.value)!=null&&t.validate())?(P(),!1):!0}async function W(d){var H,ee;if(l.value.clear(),f.value="",!L())return null;l.value.set(d,!0);const t=await((H=b.value)==null?void 0:H.createContactOrGetExistsId());if(typeof t=="number")a.value.contact_id.value=t;else return t instanceof Error&&(f.value=t.message),l.value.clear(),null;const V=new Map;Object.keys(a.value).forEach(q=>{const E=q,M=a.value[E];if(Array.isArray(M))V.set(E,M.filter(g=>g.value.value).map(g=>({field:g.value.field,value:g.value.value})));else if(M!=null&&M.value){let{value:g}=M;E==="description"&&typeof g=="string"&&(g=Re(g),g=g.replace(/\n/g,"<br>")),V.set(E,g)}});const{data:C,response:j,error:c}=await G("crm.deal.add",{onFetchError(q){var E;return typeof q.data=="string"&&((E=JSON.parse(q.data).error_fields)==null||E.forEach(g=>{if(g.code==="fields"){const ae=a.value.fields.find(me=>me.value.field===g.field);ae&&(ae.error=g.description)}else g.field in a.value&&(a.value[g.field].error=g.description)}),P()),q}}).post(Object.fromEntries(V));if(l.value.clear(),f.value=c.value instanceof Error?c.value.message:"",!f.value&&((ee=j.value)!=null&&ee.ok)&&C.value){const q=Number(C.value);if(!isNaN(Number(u.conversationId))){const{error:E}=await s(q,Number(u.conversationId));if(f.value=E.value,f.value)return null}return w("close"),q}return null}async function s(d,t){return await G("crm.conversation.deal").post({deal_id:d,conversation_id:t})}function o(){Se.emit("spa:navigateBack"),w("close")}async function n(){await W("create")&&typeof u.onAdded=="function"&&u.onAdded()}async function N(){const d=await W("createAndOpen");d&&(typeof u.onAdded=="function"&&u.onAdded(),u.disableNavigateToDeal||_.push({name:"deal",params:{id:d},replace:!!Y.webView}))}return(d,t)=>{const V=ke("i18n-t");return p(),A(Ae,{"vertical-stretch":!0,"use-cancel-as-button-label":!0,"hide-close-icon":"",onClose:o},{header:m(()=>[O(i(d.$t("newDeal")),1)]),default:m(()=>{var C,j;return[ve(r(ze,{space:"4",class:"tw-relative tw-h-full"},{default:m(()=>[e("section",za,[e("div",La,[e("div",Wa,[e("div",Ha,i(d.$t("title")),1),e("div",Ya,[r(re,{modelValue:a.value.name.value,"onUpdate:modelValue":t[0]||(t[0]=c=>a.value.name.value=c),class:"field-title-textarea tw-font-bold","aria-required":"true","max-rows":10,"error-message":a.value.name.error,onKeydown:t[1]||(t[1]=c=>a.value.name.error="")},null,8,["modelValue","error-message"])])]),e("div",Ga,[e("div",Pa,i(d.$t("currentStage")),1),e("div",Ja,[r(xa,{"funnel-id":u.funnelId,"force-fetch":d.$route.meta.menuItemType==="frame",onUpdateStageId:t[2]||(t[2]=c=>a.value.stage_id.value=c)},null,8,["funnel-id","force-fetch"])])]),e("div",Ka,[e("div",Qa,i(d.$t("responsible")),1),e("div",Za,[r(Ue,{contact:F(Y).user,width:"320px",class:"width-100 tw-h-[30px]","hide-clear":"",onUpdate:t[3]||(t[3]=c=>a.value.user_contact_id.value=c.id)},{preview:m(({model:c,showInput:H})=>[r(Z,{class:"tw-pl-1","color-class":"blank","mobile-w-full":"",onClick:T(H,["prevent"])},{icon:m(()=>[r(x,{size:20,url:c.userpic},null,8,["url"])]),title:m(()=>[O(i(c.name),1)]),_:2},1032,["onClick"])]),_:1},8,["contact"])])]),e("div",Xa,[e("div",el,i(d.$t("estimatedAmount")),1),e("div",al,[e("div",ll,[r(U,{modelValue:a.value.amount.value,"onUpdate:modelValue":t[4]||(t[4]=c=>a.value.amount.value=c),"fallback-type-number":$.value,"error-message":a.value.amount.error,disabled:D.value,class:"!tw-text-left",type:"number",min:"0"},null,8,["modelValue","fallback-type-number","error-message","disabled"]),r(Ne,{"model-value":a.value.currency_id.value,"error-message":a.value.currency_id.error,disabled:D.value,required:!D.value,"onUpdate:modelValue":t[5]||(t[5]=c=>a.value.currency_id.value=c)},null,8,["model-value","error-message","disabled","required"])]),D.value?(p(),I("div",tl,[r(V,{keypath:"currenciesNotSetUp"},{default:m(()=>[e("a",{class:le(d.$constant.parentAppDisableRouterClass),href:`${F(Y).baseUrl}settings/currencies/`,target:"_blank"},[O(i(d.$t("settingsCurrencies"))+" ",1),ol],10,sl)]),_:1})])):k("",!0)])]),e("div",nl,[e("div",rl,i(d.$t("expectedCloseDate")),1),e("div",il,[r(U,{modelValue:a.value.expected_date.value,"onUpdate:modelValue":t[6]||(t[6]=c=>a.value.expected_date.value=c),type:"date",class:"!tw-w-auto","error-message":a.value.expected_date.error},null,8,["modelValue","error-message"])])]),e("div",dl,[r(re,{modelValue:a.value.description.value,"onUpdate:modelValue":t[7]||(t[7]=c=>a.value.description.value=c),class:"field-description-textarea",rows:"2",placeholder:d.$t("dealDescr"),"error-message":a.value.description.error,onKeydown:t[8]||(t[8]=c=>a.value.description.error="")},null,8,["modelValue","placeholder","error-message"])])])]),r(Fa,{ref_key:"formDealAddSectionCustomerRef",ref:b,"init-contact-id":Number(u.contactId),class:"tw-pb-1",onUpdateContactId:t[9]||(t[9]=c=>a.value.contact_id.value=c),onUpdateContactLabel:t[10]||(t[10]=c=>a.value.contact_label.value=c)},null,8,["init-contact-id"]),r(Ge,{modelValue:a.value.fields,"onUpdate:modelValue":t[11]||(t[11]=c=>a.value.fields=c),class:"tw-pb-7"},null,8,["modelValue"])]),_:1},512),[[Ie,!((C=b.value)!=null&&C.isFetchingContacts)]]),(j=b.value)!=null&&j.isFetchingContacts?(p(),A(xe,{key:0})):k("",!0)]}),submit:m(()=>[e("div",ul,[r(ne,{"is-fetching":l.value.get("createAndOpen"),class:le([F(v)?"":"gray"]),onClick:T(N,["prevent"])},{default:m(()=>[O(i(d.$t(F(v)?"create":"createAndOpen")),1)]),_:1},8,["is-fetching","class","onClick"]),F(v)?k("",!0):(p(),A(ne,{key:0,"is-fetching":l.value.get("create"),onClick:T(n,["prevent"])},{default:m(()=>[O(i(d.$t("create")),1)]),_:1},8,["is-fetching","onClick"]))])]),error:m(()=>[e("span",cl,i(f.value),1)]),_:1})}}});const Nl=J(vl,[["__scopeId","data-v-f68f600d"]]);export{Nl as default};
