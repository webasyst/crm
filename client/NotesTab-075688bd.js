import{_ as Q,o as n,c as a,a as e,d as U,H as W,h as y,l as O,b as x,w as m,k as q,al as G,p as r,u as h,j as $,F as N,q as H,a9 as X,n as M,e as T,i as B,O as I,S as K,am as Y,an as ee,M as z,A as te}from"./main-d7f03521.js";import{h as se}from"./object_hash-44c1703e.js";import{S as ne}from"./SkeletonList-27785815.js";import{E as oe}from"./EmptyList-ca1e10b8.js";import{C as V}from"./CustomColumn-83646d88.js";import{U as ae}from"./UserPic-c11efadd.js";import{D as le,M as ie,_ as R}from"./DropDown-7a0f8902.js";import{_ as j}from"./ConfirmDialog.vue_vue_type_script_setup_true_lang-148646e7.js";import{d as P}from"./dayjs-8b9f8f59.js";import{d as Z}from"./downloadFile-76c29dbf.js";import{f as ce}from"./imageUrlToBase64-bf4bcddf.js";import"./index-dc17eb5d.js";const J={mounted:C=>{C.addEventListener("paste",d=>{var u;d.preventDefault();const s=(u=d.clipboardData)==null?void 0:u.getData("text/plain");s&&(window.document.execCommand("insertText",!1,s),C.dispatchEvent(new Event("input")))})}},re={},ue={width:"16",height:"20",viewBox:"0 0 16 20",fill:"none",xmlns:"http://www.w3.org/2000/svg"},de=e("path",{d:"M3.31445 19.1816H12.6836C14.5732 19.1816 15.5488 18.1885 15.5488 16.29V8.30957C15.5488 7.0791 15.3906 6.5166 14.626 5.73438L10.0293 1.06738C9.28223 0.311523 8.66699 0.135742 7.55957 0.135742H3.31445C1.43359 0.135742 0.449219 1.12891 0.449219 3.03613V16.29C0.449219 18.1885 1.43359 19.1816 3.31445 19.1816ZM3.46387 17.4238C2.62012 17.4238 2.19824 16.9844 2.19824 16.1758V3.1416C2.19824 2.3418 2.62012 1.89355 3.47266 1.89355H7.19922V6.6748C7.19922 7.94922 7.82324 8.56445 9.08887 8.56445H13.7998V16.1758C13.7998 16.9844 13.3779 17.4238 12.5254 17.4238H3.46387ZM9.25586 7.02637C8.88672 7.02637 8.72852 6.86816 8.72852 6.50781V2.12207L13.5625 7.02637H9.25586ZM11.0928 10.8672H4.74707C4.41309 10.8672 4.17578 11.1045 4.17578 11.4121C4.17578 11.7285 4.41309 11.9746 4.74707 11.9746H11.0928C11.4092 11.9746 11.6465 11.7285 11.6465 11.4121C11.6465 11.1045 11.4092 10.8672 11.0928 10.8672ZM11.0928 13.8027H4.74707C4.41309 13.8027 4.17578 14.0488 4.17578 14.3652C4.17578 14.6729 4.41309 14.9102 4.74707 14.9102H11.0928C11.4092 14.9102 11.6465 14.6729 11.6465 14.3652C11.6465 14.0488 11.4092 13.8027 11.0928 13.8027Z",fill:"#8E8E93"},null,-1),we=[de];function _e(C,d){return n(),a("svg",ue,we)}const ve=Q(re,[["render",_e]]),fe={key:0,class:"tw-p-4 tw-rounded-md tw-bg-waEditable"},pe={key:0},me=["textContent"],he={key:0,class:"tw-flex tw-space-x-2"},ye={class:"tw-w-16 tw-h-16 tw-flex-none"},be=["href","onClick"],ke={class:"tw-flex-auto tw-overflow-hidden"},xe={class:"tw-truncate"},$e=["href","onClick"],Ce={class:"smaller tw-opacity-50"},ge=["title","onClick"],Te=e("i",{class:"fas fa-trash-alt red"},null,-1),De=[Te],Ne={class:"tw-flex tw-items-center tw-gap-2"},Fe={class:"tw-flex-auto tw-flex tw-items-baseline tw-gap-2 tw-overflow-hidden"},Be=["title"],Ie={class:"smaller tw-opacity-50"},Ee={key:0,class:"!tw-ml-auto tw-relative"},He=e("a",{class:"tw-text-waText hover:tw-text-waText tw-opacity-50"},[e("i",{class:"fas fa-ellipsis-h"})],-1),Me=["onClick"],Ve=e("div",{class:"icon"},[e("i",{class:"fas fa-pen"})],-1),Ae=["onClick"],Le=e("div",{class:"icon"},[e("i",{class:"fas fa-trash-alt"})],-1),Se=U({__name:"NotesTabItem",props:{note:{}},emits:["update","delete"],setup(C,{emit:d}){const s=C,{t:u}=W(),w=y(null),l=y(s.note.content),F=O(()=>s.note.content!==l.value),p=y(!1);async function D(){const{error:i}=await I(`crm.note.update?id=${s.note.id}`).put({content:l.value});i.value||d("update",{...s.note,content:l.value})}function b(){w.value&&(l.value=s.note.content,w.value.innerText=s.note.content,w.value.blur())}function E(){setTimeout(()=>p.value=!1,500)}async function A(){const{show:i,hide:_}=K(j,{message:u("confirmDeleteNote"),buttonText:u("delete"),onSubmit:async()=>{const{error:k}=await I(`crm.note.delete?id=${s.note.id}`).delete();k.value||d("delete"),_()}});i()}async function L(i){const{show:_,hide:k}=K(j,{message:u("confirmDeleteFile"),buttonText:u("delete"),onSubmit:async()=>{var v;const{error:t}=await I(`crm.file.delete?id=${i}`).delete();t.value||d("update",{...s.note,files:(v=s.note.files)==null?void 0:v.filter(o=>o.id!==i)}),k()}});_()}return(i,_)=>{var k;return s.note.content||(k=s.note.files)!=null&&k.length?(n(),a("div",fe,[x(V,{space:"2"},{default:m(()=>[s.note.content?(n(),a("div",pe,[x(V,{space:"2"},{default:m(()=>[q(e("div",{ref_key:"noteRef",ref:w,contenteditable:"",class:"tw-whitespace-pre-wrap focus-visible:tw-outline-none focus-visible:tw-bg-waBlank focus-visible:tw-p-1 focus-visible:-tw-m-1 tw-rounded-md",onInput:_[0]||(_[0]=t=>{l.value=t.target.innerText.trim()}),onKeydown:_[1]||(_[1]=G(t=>{t.shiftKey||t.preventDefault()},["enter"])),onBlur:E,textContent:r(s.note.content)},null,40,me),[[h(J)]]),F.value?(n(),a("div",he,[e("button",{class:"small",onClick:D},r(i.$t("save")),1),e("button",{class:"light-gray small",onClick:b},r(i.$t("cancel")),1)])):$("",!0)]),_:1})])):$("",!0),(n(!0),a(N,null,H(s.note.files,t=>(n(),a("div",{key:t.id,class:"tw-flex tw-space-x-2"},[e("div",ye,[e("a",{href:t.url,style:X(t!=null&&t.thumb_url?{background:"no-repeat url('"+t.thumb_url+"')"}:{}),class:M([i.$constant.parentAppDisableRouterClass,"tw-w-16 tw-h-16 tw-rounded-lg tw-bg-waBackground tw-flex tw-justify-center tw-items-center"]),onClick:T(v=>h(Z)(t.url,t.id,t.name),["prevent"])},[t!=null&&t.thumb_url?$("",!0):(n(),B(ve,{key:0}))],14,be)]),e("div",ke,[e("div",xe,[e("a",{href:t.url,class:M(i.$constant.parentAppDisableRouterClass),onClick:T(v=>h(Z)(t.url,t.id,t.name),["prevent"])},r(t.name),11,$e)]),e("div",Ce,r((t.size/1024).toFixed(1))+" KB ",1),p.value?(n(),a("a",{key:0,class:"small text-red",title:i.$t("deleteFile"),onClick:T(v=>L(t.id),["prevent"])},De,8,ge)):$("",!0)])]))),128)),e("div",Ne,[x(ae,{size:16,url:s.note.creator.userpic},null,8,["url"]),e("div",Fe,[e("span",{class:"small tw-truncate",title:s.note.creator.name},r(s.note.creator.name),9,Be),e("span",Ie,r(h(P)(s.note.create_datetime).format(h(P)(s.note.create_datetime).isToday()?"LT":"L")),1)]),s.note.id!==0?(n(),a("div",Ee,[x(le,{right:!0,"enable-correct-top":!0},{body:m(({hide:t})=>[x(ie,null,{default:m(()=>[x(R,null,{default:m(()=>[e("a",{onClick:T(()=>{var v;(v=w.value)==null||v.focus(),p.value=!0,t()},["prevent"])},[Ve,e("span",null,r(i.$t("edit")),1)],8,Me)]),_:2},1024),x(R,null,{default:m(()=>[e("a",{onClick:T(()=>{A(),t()},["prevent"])},[Le,e("span",null,r(i.$t("delete")),1)],8,Ae)]),_:2},1024)]),_:2},1024)]),default:m(()=>[He]),_:1})])):$("",!0)])]),_:1})])):$("",!0)}}}),ze={class:"tw-flex tw-space-x-2"},Ke={class:"tw-flex-auto"},Re={class:"tw-relative"},je=e("i",{class:"fas fa-paperclip gray"},null,-1),Pe=[je],Ze=["placeholder"],Ue={key:0,style:{background:"var(--background-color-input)"},class:"tw-py-2 tw-px-3 bordered-top tw-rounded-b"},Oe={class:"tw-text-sm"},qe=["onClick"],Ge=e("i",{class:"fas fa-times-circle"},null,-1),Je=[Ge],Qe={class:"tw-text-sm"},We=["onClick"],Xe=["disabled"],Ye={key:0},et=e("i",{class:"fas fa-arrow-down"},null,-1),tt=[et],st={key:1,class:"spinner"},nt={key:0},ot={key:1,class:"tw-max-w-3xl tw-mx-auto tw-mt-0 tw-p-4"},at={key:0},lt=e("div",{class:"icon size-80"},[e("i",{class:"fas fa-file"})],-1),yt=U({__name:"NotesTab",props:{entityType:{},entityId:{},focusInput:{type:Boolean}},setup(C){const d=C,s=`${d.entityType}_id`,u=y([]),w=y(""),l=y([]),F=y([]),p=y(!1),D=y(null),b=I(`crm.note.list?${s}=${d.entityId}`).get().json(),E=O(()=>p.value||!w.value),{open:A,reset:L,onChange:i}=Y();ee(()=>{var o;d.focusInput&&((o=D.value)==null||o.focus())}),z(()=>{Array.isArray(b.data.value)&&(u.value=b.data.value.map(o=>({...o,hash:se(o)})))}),z(()=>{w.value||D.value&&(D.value.innerText="")}),z(()=>{l.value.length||L()}),i(o=>{o&&l.value.push(...Array.from(o))});async function _(){E.value||(F.value=[],p.value=!0,await k()&&(w.value="",b.execute()),p.value=!1,v())}async function k(){var c;const o=await t(),{data:f}=await I("crm.note.add").post({content:w.value,attachments:Array.from(o).filter(g=>!!g),[s]:d.entityId}).json();return(c=f.value)==null?void 0:c.id}async function t(){return l.value?await Promise.all(Array.from(l.value).map(async o=>{const f=await ce(o);return f?{file:f,file_name:o.name}:null})):[]}function v(){l.value=[]}return(o,f)=>(n(),a(N,null,[e("div",{class:M(["tw-sticky tw-bg-waBlank tw-z-20 tw-max-w-3xl tw-mx-auto tw-p-4",{"notes-tab__panel":d.entityType==="contact"}])},[x(V,{space:"2"},{default:m(()=>[e("div",ze,[e("div",Ke,[e("div",Re,[e("div",{class:"icon tw-absolute tw-bottom-2 tw-left-3 tw-cursor-pointer",onClick:f[0]||(f[0]=()=>{p.value||h(A)()})},Pe),q(e("div",{ref_key:"contenteditableRef",ref:D,class:M(["wa-contenteditable tw-w-full tw-overflow-x-hidden tw-overflow-y-auto break-word",{"!tw-rounded-b-none":l.value.length}]),contenteditable:"",placeholder:o.$t("newNote"),style:{"padding-left":"2.25em","max-height":"190px"},onInput:f[1]||(f[1]=c=>{w.value=c.target.innerText.trim()}),onKeydown:f[2]||(f[2]=G(c=>{c.shiftKey||(c.preventDefault(),_())},["enter"]))},null,42,Ze),[[h(J)]])]),l.value.length&&!p.value?(n(),a("div",Ue,[e("div",Oe,[te(r(o.$t("selected"))+": ",1),e("b",null,r(o.$t("files",l.value.length)),1)]),(n(!0),a(N,null,H(l.value,c=>(n(),a("div",{key:c.name,class:"hint tw-flex tw-items-center tw-space-x-1"},[e("span",null,r(c.name),1),e("a",{onClick:T(g=>l.value=l.value.filter(S=>S.name!==c.name),["prevent"])},Je,8,qe)]))),128)),e("div",Qe,[e("a",{onClick:T(v,["prevent"])},r(o.$t("clear")),9,We)])])):$("",!0)]),e("button",{class:"tw-flex-none circle",disabled:E.value,onClick:_},[p.value?(n(),a("div",st)):(n(),a("span",Ye,tt))],8,Xe)]),F.value.length?(n(),a("div",nt,[(n(!0),a(N,null,H(F.value,(c,g)=>(n(),a("div",{key:g},r(c),1))),128))])):$("",!0)]),_:1})],2),!u.value.length&&h(b).isFetching.value?(n(),B(ne,{key:0,class:"tw-max-w-3xl tw-mx-auto tw-px-4"})):(n(),a("div",ot,[h(b).error.value?(n(),a("div",at,r(h(b).error.value),1)):(n(),a(N,{key:1},[u.value.length?(n(),B(V,{key:0,space:"4"},{default:m(()=>[(n(!0),a(N,null,H(u.value,(c,g)=>(n(),B(Se,{key:c.hash,note:c,onUpdate:S=>{u.value[g]=S},onDelete:()=>u.value.splice(g,1)},null,8,["note","onUpdate","onDelete"]))),128))]),_:1})):(n(),B(oe,{key:1,message:o.$t("notFoundNotes")},{default:m(()=>[lt]),_:1},8,["message"]))],64))]))],64))}});export{yt as default};
