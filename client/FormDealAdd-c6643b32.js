import{d as W,at as de,H as se,U as x,a as $,P as oe,g as B,o as v,c as w,e as o,w as i,m as A,k as u,i as e,F as G,l as H,f as S,a3 as O,b as I,N as ue,A as K,p as j,aB as ce,q as ne,s as ie,_ as Q,ar as ve,aF as me,D as pe,Q as fe,I as _e,B as z,j as he,h as be,v as ye,n as ge,W as $e,a1 as Ce,aG as we,aH as ke}from"./main-07d84941.js";import{C as Ie,f as Se}from"./fields-198fafc2.js";import{_ as Ve,s as X}from"./FormContactUpdateInfo.vue_vue_type_script_setup_true_lang-990cc429.js";import{I as Fe,_ as Z,D as P,a as De,b as Ae,u as Ne}from"./InputWithPerformers.vue_vue_type_script_setup_true_lang-cca5371f.js";import{F as T}from"./FieldString-83da0a5f.js";import{d as Ue}from"./dayjs-ec756e3b.js";import{b as Ee}from"./index-00e882cb.js";import{W as Be}from"./WaSpinner-40f3d131.js";import{U as q}from"./UserPic-6b99ec27.js";import{T as ee}from"./TextAreaAutoresize-4cf6468e.js";import{M as ae,_ as le}from"./MenuList-1948b71a.js";import{D as te}from"./DropDown-d3d1a4c6.js";import{C as Te}from"./CustomColumn-36c752a1.js";import{B as qe}from"./ButtonSubmit-7647b2fd.js";import"./FieldSelect-efa962b1.js";import"./FieldCheckbox-eb6fe774.js";import"./SortableList.vue_vue_type_script_setup_true_lang-e995921a.js";import"./useSortable-85e98846.js";import"./InputWithContacts.vue_vue_type_script_setup_true_lang-4ab9d7cb.js";import"./InputWithDropDown.vue_vue_type_script_setup_true_lang-71ea280f.js";import"./recentContacts-f5cbf16b.js";import"./index-c6ad4004.js";const je={key:0,class:"deal-add-custom-fields"},Me={class:"fields"},Re={class:"name"},Le={class:"value"},ze=W({__name:"FormDealAddSectionFields",props:{modelValue:{}},setup(g){const c=de(g,"modelValue"),{t:k}=se(),m=x("crm.field.list?scope=deal").get().json(),p=$([]);return oe(m.data,a=>{Array.isArray(a)&&(p.value=a.map(s=>(c.value.push({value:{field:s.id,value:""},error:"",...s.is_required?{validate:O.object({value:O.string().min(1,{message:k("validation.required")})}).array()}:{}}),s)))}),(a,s)=>B(c).length?(v(),w("section",je,[o(Ie,null,{name:i(()=>[A(u(a.$t("addtnlInfo")),1)]),default:i(()=>[e("div",Me,[(v(!0),w(G,null,H(p.value,(r,_)=>(v(),w("div",{key:r.id,class:"field"},[e("div",Re,u(r.name),1),e("div",Le,[(v(),I(ue(B(Se)[r.type]),{modelValue:B(c)[_].value.value,"onUpdate:modelValue":h=>B(c)[_].value.value=h,vertical:r.type==="radio",options:(r.type==="select"||r.type==="radio")&&r.option_values,required:r.is_required,"error-message":B(c)[_].error},null,8,["modelValue","onUpdate:modelValue","vertical","options","required","error-message"]))])]))),128))])]),_:1})])):S("",!0)}}),Oe=g=>(ne("data-v-c8c4e332"),g=g(),ie(),g),We={class:"deal-add-customer"},Ye={class:"fields tw-mt-5 tw-mb-5"},xe={class:"field"},Ge={class:"name"},He={class:"value"},Ke={key:0,class:"tw-flex tw-gap-x-1 tw-mt-2"},Pe=["disabled","onClick"],Qe=Oe(()=>e("span",{class:"tw-mr-1"},[e("i",{class:"fas fa-plus-circle"})],-1)),Je={key:0,class:"form-group"},Xe={class:"tw-font-bold"},Ze={key:1,class:"fields"},ea={class:"field"},aa={class:"name"},la={class:"value"},ta={class:"field"},sa={class:"name"},oa={class:"value"},na={class:"field"},ia={class:"name"},ra={class:"value"},da={class:"field"},ua={class:"name"},ca={class:"value"},va={class:"field"},ma={class:"name"},pa={class:"value"},fa=W({__name:"FormDealAddSectionCustomer",props:{initContactId:{}},emits:["updateContactId","updateContactLabel"],setup(g,{expose:F,emit:c}){const k=g,m=$(),p=$(null),a=$(!1),s=$(null),r=$(""),_=$(!1);F({createContactOrGetExistsId:Y,isFetchingContacts:K(()=>{var t;return(t=m==null?void 0:m.value)==null?void 0:t.isFetchingContacts})});function h(t){var b,C;if(_.value=!1,r.value="",!t)return s.value=null,null;a.value=!1,s.value={id:t.id,name:t.name,jobtitle:t.jobtitle||"",company:t.company||"",email:((b=t.fields.find(y=>y.id==="email"))==null?void 0:b.value[0])??"",phone:((C=t.fields.find(y=>y.id==="phone"))==null?void 0:C.value[0])??""},c("updateContactId",(t==null?void 0:t.id)||null)}function N(){var t;a.value||(a.value=!0,s.value=null,(t=m.value)==null||t.clearValue(),r.value="",c("updateContactId",null))}async function Y(){var y,d,l;if(_.value=!a.value&&!((y=s.value)!=null&&y.id),_.value)return null;if((d=s.value)!=null&&d.id)return s.value.id;const t=await((l=p.value)==null?void 0:l.submit());if(!t)return null;const{data:b,error:C}=t;return C.value?new Error(C.value):Number(b.value)}return(t,b)=>(v(),w("section",We,[e("div",Ye,[e("div",xe,[e("div",Ge,u(t.$t("customer")),1),e("div",He,[o(Fe,{ref_key:"inputWithCustomersRef",ref:m,width:"320px",placeholder:t.$t("searchByNameEmailPhone"),"with-fields":["email","phone","company","jobtitle"],"init-contact-id":k.initContactId,disabled:!!k.initContactId,"error-message":_.value?t.$t("validation.required"):"",onUpdate:h,onClear:b[0]||(b[0]=C=>h(null))},null,8,["placeholder","init-contact-id","disabled","error-message"]),k.initContactId?S("",!0):(v(),w("div",Ke,[e("span",null,u(t.$t("or")),1),e("a",{class:"tw-font-semibold",disabled:a.value,onClick:j(N,["prevent"])},[Qe,e("span",null,u(t.$t("addNew")),1)],8,Pe)]))])])]),o(ce,{name:"fade",mode:"out-in"},{default:i(()=>{var C;return[a.value?(v(),w("div",Je,[e("p",Xe,u(t.$t("createCustomer")),1),o(Ve,{ref_key:"formContactUpdateInfoRef",ref:p},{firstFieldTitle:i(()=>[A(u(t.$t("roleInDeal")),1)]),firstFieldValue:i(()=>[o(Z,{modelValue:r.value,"onUpdate:modelValue":[b[1]||(b[1]=y=>r.value=y),b[2]||(b[2]=y=>c("updateContactLabel",y))],scope:"CLIENT",right:!1,width:"238px"},null,8,["modelValue"])]),_:1},512)])):(C=s.value)!=null&&C.id?(v(),w("div",Ze,[e("div",ea,[e("div",aa,u(t.$t("company")),1),e("div",la,[o(T,{"model-value":s.value.company,type:"text",readonly:""},null,8,["model-value"])])]),e("div",ta,[e("div",sa,u(t.$t("jobTitle")),1),e("div",oa,[o(T,{"model-value":s.value.jobtitle,type:"text",readonly:""},null,8,["model-value"])])]),e("div",na,[e("div",ia,u(t.$t("roleInDeal")),1),e("div",ra,[o(Z,{modelValue:r.value,"onUpdate:modelValue":[b[3]||(b[3]=y=>r.value=y),b[4]||(b[4]=y=>c("updateContactLabel",y))],scope:"CLIENT",right:!1,width:"320px"},null,8,["modelValue"])])]),e("div",da,[e("div",ua,u(t.$t("phone")),1),e("div",ca,[o(T,{"model-value":s.value.phone,type:"text",readonly:""},null,8,["model-value"])])]),e("div",va,[e("div",ma,u(t.$t("email")),1),e("div",pa,[o(T,{"model-value":s.value.email,type:"email",readonly:""},null,8,["model-value"])])])])):S("",!0)]}),_:1})]))}});const _a=Q(fa,[["__scopeId","data-v-c8c4e332"]]),ha={class:"select-funnel-and-stage"},ba=["onClick"],ya={class:"icon small"},ga=["onClick"],$a={class:"icon small"},Ca=W({__name:"SelectFunnelAndStage",props:{funnelId:{},forceFetch:{type:Boolean}},emits:["updateStageId"],setup(g,{emit:F}){const c=g,k=ve(),m=me(k,"funnels");c.forceFetch&&!m.value.length&&k.refetch();const p=$(),a=$();return pe(()=>m.value.length,()=>{const s=m.value[0];p.value=m.value.find(r=>r.id===c.funnelId)||s,a.value=p.value.stages[0],a.value&&F("updateStageId",a.value.id)},{immediate:!0}),oe(a,s=>{s&&F("updateStageId",s.id)}),(s,r)=>(v(),w("div",ha,[!m.value.length||m.value.length>1?(v(),I(te,{key:0,class:"select-dropdown"},{body:i(({hide:_})=>[m.value.length?(v(),I(ae,{key:0},{default:i(()=>[(v(!0),w(G,null,H(m.value,h=>(v(),I(le,{key:h.id},{default:i(()=>[e("a",{onClick:j(N=>{p.value=h,a.value=h.stages[0],_()},["prevent"])},[e("div",ya,[o(q,{size:10,"disable-rounded":"","bg-color":h.color},null,8,["bg-color"])]),e("span",null,u(h.name),1)],8,ba)]),_:2},1024))),128))]),_:2},1024)):S("",!0)]),default:i(()=>[o(P,{"color-class":"blank","mobile-w-full":"","is-skeleton":!m.value.length},{icon:i(()=>[p.value?(v(),I(q,{key:p.value.id,size:10,"disable-rounded":"","bg-color":p.value.color},null,8,["bg-color"])):S("",!0)]),title:i(()=>[A(u(p.value?p.value.name:s.$t("allStages")),1)]),_:1},8,["is-skeleton"])]),_:1})):S("",!0),o(te,{class:"select-dropdown",disabled:!a.value},{body:i(({hide:_})=>[p.value?(v(),I(ae,{key:0},{default:i(()=>[(v(!0),w(G,null,H(p.value.stages,h=>(v(),I(le,{key:h.id},{default:i(()=>[e("a",{onClick:j(N=>{a.value=h,_()},["prevent"])},[e("div",$a,[o(q,{size:10,"disable-rounded":"","bg-color":h.color},null,8,["bg-color"])]),e("span",null,u(h.name),1)],8,ga)]),_:2},1024))),128))]),_:2},1024)):S("",!0)]),default:i(()=>[o(P,{"color-class":"blank","mobile-w-full":"","is-skeleton":!m.value.length},{icon:i(()=>[a.value?(v(),I(q,{key:a.value.id,size:10,"disable-rounded":"","bg-color":a.value.color},null,8,["bg-color"])):S("",!0)]),title:i(()=>[A(u(a.value?a.value.name:s.$t("allStages")),1)]),_:1},8,["is-skeleton"])]),_:1},8,["disabled"])]))}});const wa=Q(Ca,[["__scopeId","data-v-7a630f80"]]),ka=g=>(ne("data-v-cf5ff0b2"),g=g(),ie(),g),Ia={class:"deal-add-main"},Sa={class:"fields"},Va={class:"field"},Fa={class:"name"},Da={class:"value"},Aa={class:"field"},Na={class:"name"},Ua={class:"value"},Ea={class:"field"},Ba={class:"name"},Ta={class:"value"},qa={class:"field"},ja={class:"name"},Ma={class:"value"},Ra={class:"field-amount-wrapper"},La={key:0,class:"hint break-word"},za=["href"],Oa=ka(()=>e("i",{class:"fas fa-external-link-alt fa-sm"},null,-1)),Wa={class:"field"},Ya={class:"name"},xa={class:"value"},Ga={class:"field"},Ha={class:"state-error-hint"},Ka=W({__name:"FormDealAdd",props:{funnelId:{},contactId:{},conversationId:{},disableNavigateToDeal:{type:Boolean},onAdded:{type:Function}},emits:["close"],setup(g,{emit:F}){const c=g,{t:k}=se(),m=fe(),p=_e(Ee),a=$({stage_id:{value:null,is_required:!0},name:{value:"",is_required:!0,validate:O.string().trim().min(1,{message:k("validation.required")})},description:{value:""},expected_date:{value:Ue().add(2,"w").format("YYYY-MM-DD")},amount:{value:""},currency_id:{value:""},contact_id:{value:Number(c.contactId)||null},contact_label:{value:""},user_contact_id:{value:z.user.id},fields:[]}),s=$(!1),r=$(""),_=$(null),h=K(()=>p.value||we()),N=K(()=>Ne().isEmptyCurrencies);function Y(){let d=!1;return Object.entries(a.value).forEach(([,l])=>{if(l.error="",l.is_required&&l.validate)try{l.validate.parse(l.value)}catch(U){U instanceof O.ZodError&&(l.error=U.issues[0].message,d=!0)}}),d?(X(),!1):!0}async function t(){var n,L;if(s.value=!1,r.value="",!Y())return null;s.value=!0;const d=await((n=_.value)==null?void 0:n.createContactOrGetExistsId());if(typeof d=="number")a.value.contact_id.value=d;else return d instanceof Error&&(r.value=d.message),s.value=!1,null;const l=new Map;Object.keys(a.value).forEach(D=>{const V=D,E=a.value[V];if(Array.isArray(E))l.set(V,E.filter(f=>f.value.value).map(f=>({field:f.value.field,value:f.value.value})));else if(E!=null&&E.value){let{value:f}=E;V==="description"&&typeof f=="string"&&(f=ke(f),f=f.replace(/\n/g,"<br>")),l.set(V,f)}});const{data:U,response:M,error:R}=await x("crm.deal.add",{onFetchError(D){var V;return typeof D.data=="string"&&((V=JSON.parse(D.data).error_fields)==null||V.forEach(f=>{if(f.code==="fields"){const J=a.value.fields.find(re=>re.value.field===f.field);J&&(J.error=f.description)}else f.field in a.value&&(a.value[f.field].error=f.description)}),X()),D}}).post(Object.fromEntries(l));if(s.value=!1,r.value=R.value,!r.value&&((L=M.value)!=null&&L.ok)&&U.value){const D=Number(U.value);if(!isNaN(Number(c.conversationId))){const{error:V}=await b(D,Number(c.conversationId));if(r.value=V.value,r.value)return null}return F("close"),D}return null}async function b(d,l){return await x("crm.conversation.deal").post({deal_id:d,conversation_id:l})}function C(){Ce.emit("spa:navigateBack"),F("close")}async function y(d){const l=await t();l&&(typeof c.onAdded=="function"&&c.onAdded(),!d.shiftKey&&!c.disableNavigateToDeal&&m.push({name:"deal",params:{id:l},replace:!!z.webView}))}return(d,l)=>{const U=he("i18n-t");return v(),I($e,{"vertical-stretch":!0,"use-cancel-as-button-label":!0,"hide-close-icon":"",onClose:C},{header:i(()=>[A(u(d.$t("newDeal")),1)]),default:i(()=>{var M,R;return[be(o(Te,{space:"4",class:"tw-relative tw-h-full"},{default:i(()=>[e("section",Ia,[e("div",Sa,[e("div",Va,[e("div",Fa,u(d.$t("title")),1),e("div",Da,[o(ee,{modelValue:a.value.name.value,"onUpdate:modelValue":l[0]||(l[0]=n=>a.value.name.value=n),class:"field-title-textarea tw-font-bold","aria-required":"true","max-rows":10,"error-message":a.value.name.error,onKeydown:l[1]||(l[1]=n=>a.value.name.error="")},null,8,["modelValue","error-message"])])]),e("div",Aa,[e("div",Na,u(d.$t("currentStage")),1),e("div",Ua,[o(wa,{"funnel-id":c.funnelId,"force-fetch":d.$route.meta.menuItemType==="frame",onUpdateStageId:l[2]||(l[2]=n=>a.value.stage_id.value=n)},null,8,["funnel-id","force-fetch"])])]),e("div",Ea,[e("div",Ba,u(d.$t("responsible")),1),e("div",Ta,[o(De,{contact:B(z).user,width:"320px",class:"width-100 tw-h-[30px]","hide-clear":"",onUpdate:l[3]||(l[3]=n=>a.value.user_contact_id.value=n.id)},{preview:i(({model:n,showInput:L})=>[o(P,{class:"tw-pl-1","color-class":"blank","mobile-w-full":"",onClick:j(L,["prevent"])},{icon:i(()=>[o(q,{size:20,url:n.userpic},null,8,["url"])]),title:i(()=>[A(u(n.name),1)]),_:2},1032,["onClick"])]),_:1},8,["contact"])])]),e("div",qa,[e("div",ja,u(d.$t("estimatedAmount")),1),e("div",Ma,[e("div",Ra,[o(T,{modelValue:a.value.amount.value,"onUpdate:modelValue":l[4]||(l[4]=n=>a.value.amount.value=n),"fallback-type-number":h.value,"error-message":a.value.amount.error,disabled:N.value,class:"!tw-text-left",type:"number",min:"0"},null,8,["modelValue","fallback-type-number","error-message","disabled"]),o(Ae,{"model-value":a.value.currency_id.value,"error-message":a.value.currency_id.error,disabled:N.value,"onUpdate:modelValue":l[5]||(l[5]=n=>a.value.currency_id.value=n)},null,8,["model-value","error-message","disabled"])]),N.value?(v(),w("div",La,[o(U,{keypath:"currenciesNotSetUp"},{default:i(()=>[e("a",{class:ge(d.$constant.parentAppDisableRouterClass),href:`${B(z).baseUrl}settings/currencies/`,target:"_blank"},[A(u(d.$t("settingsCurrencies"))+" ",1),Oa],10,za)]),_:1})])):S("",!0)])]),e("div",Wa,[e("div",Ya,u(d.$t("expectedCloseDate")),1),e("div",xa,[o(T,{modelValue:a.value.expected_date.value,"onUpdate:modelValue":l[6]||(l[6]=n=>a.value.expected_date.value=n),type:"date",class:"!tw-w-auto","error-message":a.value.expected_date.error},null,8,["modelValue","error-message"])])]),e("div",Ga,[o(ee,{modelValue:a.value.description.value,"onUpdate:modelValue":l[7]||(l[7]=n=>a.value.description.value=n),class:"field-description-textarea",rows:"2",placeholder:d.$t("dealDescr"),"error-message":a.value.description.error,onKeydown:l[8]||(l[8]=n=>a.value.description.error="")},null,8,["modelValue","placeholder","error-message"])])])]),o(_a,{ref_key:"formDealAddSectionCustomerRef",ref:_,"init-contact-id":Number(c.contactId),class:"tw-pb-1",onUpdateContactId:l[9]||(l[9]=n=>a.value.contact_id.value=n),onUpdateContactLabel:l[10]||(l[10]=n=>a.value.contact_label.value=n)},null,8,["init-contact-id"]),o(ze,{modelValue:a.value.fields,"onUpdate:modelValue":l[11]||(l[11]=n=>a.value.fields=n),class:"tw-pb-7"},null,8,["modelValue"])]),_:1},512),[[ye,!((M=_.value)!=null&&M.isFetchingContacts)]]),(R=_.value)!=null&&R.isFetchingContacts?(v(),I(Be,{key:0})):S("",!0)]}),submit:i(()=>[o(qe,{"is-fetching":s.value,class:"custom-mr-4",onClick:j(y,["prevent"])},{default:i(()=>[A(u(d.$t("create")),1)]),_:1},8,["is-fetching","onClick"])]),error:i(()=>[e("span",Ha,u(r.value),1)]),_:1})}}});const hl=Q(Ka,[["__scopeId","data-v-cf5ff0b2"]]);export{hl as default};
