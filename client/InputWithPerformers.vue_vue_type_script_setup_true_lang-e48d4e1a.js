import{$ as O,a as w,t as H,D as q,be as ae,a8 as ee,X as N,d as z,av as ne,A as D,ac as G,ak as ve,aP as ie,o as y,c as C,e as A,w as k,b as B,F as j,l as le,f as M,h as Q,aw as me,g as _,i as g,al as oe,n as E,af as R,p as W,k as K,R as Y,U as re,r as V,ae as he,v as se,aJ as ue,ax as ce,am as te,x as we,_ as ye,N as _e,aM as ge,B as $e,ab as Ce,V as Ie}from"./main-14ee4927.js";import{M as Z,D as de,_ as pe}from"./DropDown-3d660bad.js";import{u as be}from"./recentContacts-56405508.js";import{F as ke}from"./FieldSelect-b035d25b.js";import{v as Fe}from"./index-927b8924.js";import{U as xe}from"./UserPic-88a434b2.js";import{C as De}from"./CustomColumn-9af7d856.js";const Se=O("inputWithCustomers",()=>{const h=w(!0),i=w([]),l=w(null),e=be(),{recent:m,pinned:u,error:p,isFinished:r}=H(e);e.refetch();function s(d,o,t){l.value!==d?(l.value&&e.refetch(),q(()=>r.value,()=>{n(o,t)},{immediate:!0})):(i.value.length||m.value.length||u.value.length)&&a(t),l.value=d}async function n(d,o){const t=[...u.value,...m.value].map(S=>S.id),f=c(o);f&&t.unshift(f);const F=ae(t).join(",");F&&(i.value=await Ve(`id/${F}`,d),a(o)),h.value=!1}function a(d){if(!d)return;const o=i.value.findIndex(t=>t.id===c(d));if(o!==-1){const t=i.value[o];return i.value.splice(o,1),i.value.unshift(t),!0}else typeof d=="object"&&d.id&&i.value.unshift(d)}function c(d){return typeof d=="number"?d:typeof(d==null?void 0:d.id)=="number"?d.id:null}return{isFetching:h,error:p,$contacts:i,fetchData:s}});async function Ve(h,i){const l=ee.stringify({hash:h,fields:i}),{data:e}=await N(`crm.contact.list?${l}`).get().json();if(e.value){const{data:m}=e.value;return m}return[]}const Le=["placeholder"],We=["onClick"],dt=z({__name:"InputWithRole",props:{scope:{},modelValue:{},inputClass:{default:""},placeholder:{default:""},right:{type:Boolean},width:{default:"200px"}},setup(h){const i=h,l=ne(i,"modelValue"),e=w([]),m=w(),u=w(!1),p=D(()=>e.value.filter(n=>{var a;return(a=l.value)!=null&&a.trim()?n.toLocaleLowerCase().includes(l.value.toLocaleLowerCase()):!0})),r=G(p);ve(async()=>{const{data:n}=await N(`crm.deal.role.list?scope=${i.scope}`).get().json();Array.isArray(n.value)&&(e.value=n.value)}),ie(m,()=>{u.value=!1});function s(n){n&&(l.value=n,u.value=!1)}return(n,a)=>(y(),C("div",{ref_key:"wrapperRef",ref:m},[A(de,{open:u.value,"disable-click-outside":!0,right:i.right,width:i.width,disabled:!0,"max-height":"195px"},{body:k(()=>[p.value.length?(y(),B(Z,{key:0},{default:k(()=>[(y(!0),C(j,null,le(p.value,(c,d)=>(y(),B(pe,{key:d},{default:k(()=>[g("a",{class:E({"tw-bg-waBackground":_(r).index.value===d}),onClick:W(o=>s(c),["prevent"])},K(c),11,We)]),_:2},1024))),128))]),_:1})):M("",!0)]),default:k(()=>[Q(g("input",{"onUpdate:modelValue":a[0]||(a[0]=c=>oe(l)?l.value=c:null),type:"text",class:E(["tw-w-full",i.inputClass]),placeholder:i.placeholder,onKeyup:a[1]||(a[1]=R(c=>{s(_(r).state.value),c.target.blur()},["enter"])),onKeydown:[a[2]||(a[2]=R(W(c=>_(r).prev(),["prevent"]),["up"])),a[3]||(a[3]=R(W(c=>_(r).next(),["prevent"]),["down"]))],onFocusin:a[4]||(a[4]=c=>u.value=!0)},null,42,Le),[[me,_(l)]])]),_:1},8,["open","right","width"])],512))}}),Be={key:0,class:"icon size-20 !tw-left-2"},Me={key:1,class:"icon text-gray"},Re=g("i",{class:"fas fa-search"},null,-1),Pe=[Re],Ue=g("i",{class:"fas fa-times-circle"},null,-1),Ae=[Ue],je=["placeholder","disabled"],Ke={key:2,class:"smaller text-red tw-mt-1"},Ne=["data-index","onClick"],ze=["src"],Te={class:"name"},qe={class:"email"},Ee={key:2,class:"tw-text-center tw-py-3 gray"},He={class:"tw-h-[5px]"},Je={class:"tw-text-center tw-py-3"},Xe=g("i",{class:"spinner custom-p-12"},null,-1),Ge=[Xe],Qe=g("hr",{class:"tw-m-0"},null,-1),Ye={class:"!tw-my-1"},fe=z({__name:"InputWithDropDown",props:{items:{},item:{},initItemId:{},placeholder:{},isFetching:{type:Boolean},hideClear:{type:Boolean},hideIcon:{type:Boolean},inputClass:{},width:{},right:{type:Boolean},disabled:{type:Boolean},errorMessage:{}},emits:["input","update","clear","interseption-observer","focus","close-dropdown"],setup(h,{expose:i,emit:l}){const e=h,m=w(),u=w(),p=w(!1),r=w(e.item);let s=G(e.items);Y(()=>e.items,t=>{s=G(t),Y(s.index,f=>{var F,S;(S=(F=m.value)==null?void 0:F.querySelector(`[data-index="${f}"]`))==null||S.scrollIntoView({behavior:"smooth",block:"nearest"})})}),q(()=>e.initItemId&&e.items.length,()=>{const t=e.items.find(f=>f.id===e.initItemId);t&&a(t)},{immediate:!0}),q(()=>!p.value,()=>{l("close-dropdown")}),ie(m,()=>{p.value=!1});function n(t){l("focus"),l("input",t.target.value),p.value=!0,he(()=>{var f;(f=u.value)==null||f.focus()})}function a(t){t&&(r.value={...t},l("update",r.value),p.value=!1)}function c(){r.value={id:0,name:""},l("clear")}const d=D(()=>{var t;return p.value&&((t=r.value)==null?void 0:t.name)||e.placeholder}),o=D(()=>p.value?"default-value":"value");return i({clearValue:c}),(t,f)=>(y(),B(De,{space:"4"},{default:k(()=>{var F,S,L,P;return[g("div",{ref_key:"wrapperRef",ref:m,class:"tw-w-full"},[!t.$slots.preview||p.value?(y(),C("div",{key:0,class:E(["state-with-inner-icon width-100",{left:!e.hideIcon}])},[e.hideIcon?M("",!0):(y(),C(j,{key:0},[(F=r.value)!=null&&F.userpic?(y(),C("div",Be,[A(xe,{url:(S=r.value)==null?void 0:S.userpic,size:20},null,8,["url"])])):(y(),C("div",Me,Pe))],64)),!e.disabled&&!e.hideClear&&((L=r.value)!=null&&L.name)?(y(),C("a",{key:1,class:"icon !tw-left-auto tw-right-3 text-red hover:!tw-text-red-600 tw-rounded-full tw-bg-waBlank",onClick:f[0]||(f[0]=W(I=>c(),["prevent"]))},Ae)):M("",!0),g("input",re({ref_key:"inputRef",ref:u,type:"search",class:["tw-w-full",e.inputClass,{"state-error":e.errorMessage}],[o.value||""]:((P=r.value)==null?void 0:P.name)||"",placeholder:d.value,disabled:e.disabled,onInput:f[1]||(f[1]=I=>l("input",I.target.value)),onKeyup:f[2]||(f[2]=R(I=>{a(_(s).state.value),I.target.blur()},["enter"])),onKeydown:[f[3]||(f[3]=R(W(I=>_(s).prev(),["prevent"]),["up"])),f[4]||(f[4]=R(W(I=>_(s).next(),["prevent"]),["down"]))],onFocus:n}),null,16,je)],2)):V(t.$slots,"preview",{key:1,model:r.value,showInput:n}),e.errorMessage?(y(),C("div",Ke,K(e.errorMessage),1)):M("",!0),V(t.$slots,"items",{items:e.items,onSelectItem:a,isFocus:p.value},()=>[A(de,{"max-height":"255px",open:p.value,"disable-click-outside":!0,width:e.width||"250px",right:e.right,"disable-floating":!0},{body:k(()=>[A(Z,{class:"thin-scrollbar"},{default:k(()=>{var I;return[(I=e.items)!=null&&I.length?(y(!0),C(j,{key:0},le(e.items,(x,U)=>(y(),B(pe,{key:x.id},{default:k(()=>[g("a",{class:E(["item",{"tw-bg-waBackground":_(s).index.value===U}]),"data-index":U,onClick:W(J=>a(x),["prevent"])},[t.$slots.item?V(t.$slots,"item",{key:0,item:x}):(y(),C(j,{key:1},[g("img",{class:"userpic userpic32",src:x.userpic},null,8,ze),g("div",null,[g("div",Te,K(x.name),1),g("div",qe,K(x.email),1)])],64))],10,Ne)]),_:2},1024))),128)):!e.isFetching&&t.$slots.empty?V(t.$slots,"empty",{key:1}):e.isFetching?M("",!0):(y(),C("div",Ee,K(t.$t("notFound")),1)),Q(g("div",He,null,512),[[se,!t.isFetching],[_(Fe),([{isIntersecting:x}])=>{x&&l("interseption-observer")}]]),Q(g("div",Je,Ge,512),[[se,t.isFetching]])]}),_:3}),t.$slots.bottomItems?(y(),C(j,{key:0},[Qe,g("div",Ye,[A(Z,null,{default:k(()=>[V(t.$slots,"bottomItems",{hideDropDown:()=>p.value=!1})]),_:3})])],64)):M("",!0)]),_:3},8,["open","width","right"])])],512)]}),_:3}))}});const Ze=z({__name:"InputWithCustomers",props:{dealId:{default:0},initContactId:{default:void 0},contact:{default:()=>({id:0,name:"",userpic:"",jobtitle:"",company:"",company_contact_id:null})},withFields:{default:()=>["email"]},excludeIds:{default:()=>[]},disabled:{type:Boolean}},emits:["update"],setup(h,{expose:i,emit:l}){var U,J;const e=h,m=w(),u=w({id:e.contact.id,name:e.contact.name,userpic:e.contact.userpic,company:e.contact.company||"",email:(J=(U=e.contact)==null?void 0:U.email)!=null&&J.length?e.contact.email[0].value:""}),p=Se();p.fetchData(e.dealId,e.withFields,e.initContactId||{id:u.value.id,name:u.value.name,userpic:u.value.userpic,company:u.value.company,fields:[{id:"email",value:u.value.email?[u.value.email]:[]}]});const{$contacts:r,isFetching:s}=H(p),n=w([]),a=w(!1),c=w(""),d=w(0),o=w(0),t=w(10);L(),ue(r,()=>{L()}),i({isFetchingContacts:s,clearValue:()=>{var v;return(v=m.value)==null?void 0:v.clearValue()}});const f=ce(async v=>{var $;if(d.value=0,o.value=0,!v||(($=u.value)==null?void 0:$.name)===v)L();else{let b="name.name";v.includes("@")?b="email":/^[+\-0-9() ]+$/.test(v)&&(b="phone");const T=`crmSearch/contact_info.${b}*=${we(v)}`;c.value!==T&&(n.value=[],n.value=await P(T))}},300),F=e.excludeIds.filter(v=>v!==e.contact.id).reduce((v,$)=>({...v,[$]:!0}),{}),S=D(()=>n.value.filter(v=>!F[v.id]).map(v=>{const $=v.fields.find(b=>b.id==="email");return{id:v.id,name:v.name,userpic:v.userpic,email:$==null?void 0:$.value[0],company:v.company}}));function L(){d.value=0,o.value=0,c.value="",n.value=[...r.value]}async function P(v){a.value=!0;const $=ee.stringify({hash:v,fields:e.withFields,limit:t.value,offset:d.value}),{data:b}=await N(`crm.contact.list?${$}`).get().json();if(a.value=!1,b.value){const{data:T,params:X}=b.value;return d.value+=X.limit||0,o.value=X.total_count||0,c.value=X.hash||"",T}return[]}async function I(){d.value<o.value&&(n.value=[...n.value,...await P(c.value)])}function x(v){u.value=v;const $=n.value.find(b=>b.id===v.id);$&&(l("update",$),r.value.unshift($),n.value=r.value=ae(r.value))}return(v,$)=>(y(),B(fe,{ref_key:"inputWithDropDownRef",ref:m,items:S.value,item:u.value,"init-item-id":e.initContactId,placeholder:v.$t("name"),"is-fetching":_(s)||a.value,disabled:e.disabled,onInput:_(f),onUpdate:x,onInterseptionObserver:I,onCloseDropdown:L},{items:k(b=>[V(v.$slots,"items",te({isFetching:_(s)||a.value,interseptionObserver:I},b),void 0,!0)]),_:3},8,["items","item","init-item-id","placeholder","is-fetching","disabled","onInput"]))}});const pt=ye(Ze,[["__scopeId","data-v-25fc7d43"]]),Oe=O("currencies",()=>{const h=w([]),{data:i,isFetching:l,error:e,execute:m,isFinished:u}=N("crm.currency.list").get().json(),p=D(()=>h.value.find(a=>a.is_primary)),r=D(()=>a=>h.value.find(c=>c.id===a)),s=D(()=>u.value&&!h.value.length);_e(()=>{Array.isArray(i.value)&&(h.value=i.value)});function n(){u.value&&m()}return{currencies:h,primaryCurrency:p,isFetching:l,error:e,isFinished:u,isEmptyCurrencies:s,getCurrencyById:r,refetch:n}}),et={key:1,class:"skeleton tw-w-full"},tt=g("button",{class:"button light-gray !tw-w-full tw-h-full"},null,-1),st=[tt],ft=z({__name:"SelectWithCurrencies",props:{modelValue:{}},emits:["update:modelValue"],setup(h,{emit:i}){const e=ne(h,"modelValue",i),{currencies:m,primaryCurrency:u,isFinished:p}=H(Oe()),r=D(()=>m.value.map(s=>({id:s.id,value:s.name})));return q(()=>{var s;return(s=u.value)==null?void 0:s.id},s=>{e.value||(e.value=s)},{immediate:!0}),(s,n)=>_(p)?(y(),B(ke,te({key:0,modelValue:_(e),"onUpdate:modelValue":n[0]||(n[0]=a=>oe(e)?e.value=a:null)},s.$attrs,{options:r.value,required:"",class:"tw-w-full"}),null,16,["modelValue","options"])):(y(),C("div",et,st))}}),at=O("inputWithPreformers",()=>{const h=w(!0),i=w([]),l=ge({}),e=D(()=>`crm.user.list?${ee.stringify({...l.dealId?{can_own_deal:l.dealId}:{}})}`),{error:m,data:u}=N(e,{immediate:!1,refetch:!0}).get().json();Y(u,s=>{if(Array.isArray(s)){const{id:n}=$e.user,a=s.find(c=>c.id===n);i.value=[...a?[a]:[],...s.filter(c=>c.id!==n)]}r(l.currrentUser),h.value=!1});function p(s,n){l.dealId=s,l.currrentUser=n,i.value.length&&r(l.currrentUser)}function r(s){if(s!=null&&s.id){const n=i.value.findIndex(a=>a.id===s.id);if(n!==-1){const a=i.value[n];i.value.splice(n,1),i.value.unshift(a)}else s.id&&i.value.unshift(s)}}return{setupProps:p,isFetching:h,error:m,$contacts:i}}),vt=z({__name:"InputWithPerformers",props:{dealId:{default:0},excludeIds:{default:()=>[]},contact:{}},emits:["update"],setup(h,{emit:i}){const l=h,e=w(l.contact),m=w([]),u=at();u.setupProps(l.dealId,{...e.value});const{isFetching:p,$contacts:r}=H(u);c(),ue(r,()=>c());const s=ce(async o=>{var t;!o||((t=e.value)==null?void 0:t.name)===o?c():m.value=[...r.value].filter(f=>f.name.toLocaleLowerCase().includes(o.toLocaleLowerCase()))},300),n=l.excludeIds.filter(o=>o!==l.contact.id).reduce((o,t)=>({...o,[t]:!0}),{}),a=D(()=>m.value.filter(o=>!n[o.id]));function c(){m.value=[...r.value]}function d(o){e.value=o,i("update",{id:o.id,name:o.name,userpic:o.userpic})}return(o,t)=>(y(),B(fe,{items:a.value,item:e.value,placeholder:o.$t("name"),"is-fetching":_(p),onInput:_(s),onUpdate:d,onCloseDropdown:c},Ce({items:k(f=>[V(o.$slots,"items",te({isFetching:_(p),interseptionObserver:()=>null},f))]),_:2},[o.$slots.preview?{name:"preview",fn:k(f=>[V(o.$slots,"preview",re(Ie(f)))]),key:"0"}:void 0]),1032,["items","item","placeholder","is-fetching","onInput"]))}});export{pt as I,dt as _,vt as a,ft as b,Oe as u};
