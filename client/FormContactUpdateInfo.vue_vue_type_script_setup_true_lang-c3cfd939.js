import{aQ as I,h as A,Q as C,d as Q,aR as J,o as r,c as y,b as O,a5 as se,M as z,aS as le,ai as W,aT as X,l as H,i as x,w as P,F as q,q as ee,Y as T,u as E,H as re,a6 as ne,aa as R,a as w,n as j,p as M,j as $,r as Z,A as G,e as D}from"./main-46836c41.js";import{_ as ue}from"./SortableList.vue_vue_type_script_setup_true_lang-f84f3915.js";import{_ as ie}from"./InputWithContacts.vue_vue_type_script_setup_true_lang-5a82d5a8.js";import{C as te}from"./CustomColumn-c8c73188.js";import{F as oe}from"./FieldCheckbox-618a9e12.js";import{F as B}from"./FieldSelect-19a80dbd.js";import{f as N}from"./fields-e10d6cd3.js";function ce(m){let f=JSON.stringify(I(m));const a=A(!1);C(m,()=>{a.value=f!==JSON.stringify(I(m))},{deep:!0});function V(){setTimeout(()=>{f=JSON.stringify(I(m)),a.value=!1})}return{modified:a,reset:V}}const de={class:"tw-flex tw-space-x-2"},me=Q({__name:"FieldBirthday",props:{modelValue:{},optionsForDaySelect:{},optionsForMonthSelect:{},errors:{}},emits:["update:modelValue"],setup(m,{emit:f}){const a=m,V=J({day:"",month:"",year:"",...Object.fromEntries(a.modelValue.map(v=>[v.field,v.value??""]))});C(V,v=>{f("update:modelValue",Object.entries(v).filter(c=>c[1]).map(c=>({field:c[0],value:c[1]})))});function g(v){if(a.errors)return a.errors.find(c=>c.field.split(".")[1]===v)}return(v,c)=>{var b,U,h;return r(),y("div",de,[O(B,{modelValue:V.day,"onUpdate:modelValue":c[0]||(c[0]=F=>V.day=F),options:a.optionsForDaySelect,"error-message":(b=g("day"))==null?void 0:b.description,class:"tw-w-18 md:tw-w-20"},null,8,["modelValue","options","error-message"]),O(B,{modelValue:V.month,"onUpdate:modelValue":c[1]||(c[1]=F=>V.month=F),options:a.optionsForMonthSelect,"error-message":(U=g("month"))==null?void 0:U.description,class:"tw-w-auto md:tw-w-36"},null,8,["modelValue","options","error-message"]),O(oe,{modelValue:V.year,"onUpdate:modelValue":c[2]||(c[2]=F=>V.year=F),"error-message":(h=g("year"))==null?void 0:h.description,type:"number",class:"tw-w-20"},null,8,["modelValue","error-message"])])}}}),pe=se("regions",()=>{const m=A({});function f(a){return a in m.value||(m.value[a]=z(`crm.region.list?country=${a}`).get().json()),m.value[a]}return{regions:m,getRegionByCode:f}}),ve=Q({__name:"FieldAddress",props:{modelValue:{},fields:{},errors:{}},emits:["update:modelValue"],setup(m,{emit:f}){const a=m,{getRegionByCode:V}=pe(),g=A(U()),v=A([]),{pause:c,resume:b}=le(g,()=>f("update:modelValue",g.value.filter(l=>l.value).map(l=>({field:l.id,value:l.value}))),{deep:!0,immediate:!0});C(()=>a.modelValue,async()=>{c(),g.value=U(),await W(),b()}),C(()=>{var l;return(l=g.value.find(n=>n.id==="country"))==null?void 0:l.value},async l=>{if(v.value=[],l){const{data:n}=await V(l);n.value&&(v.value=n.value.sort((o,d)=>+d.is_favorite-+o.is_favorite))}},{immediate:!0}),C(()=>{var l;return(l=g.value.find(n=>n.id==="country"))==null?void 0:l.value},()=>{const l=g.value.find(n=>n.id==="region");l&&(l.value="")});function U(){return a.fields.map(l=>{var n;return{...l,value:((n=a.modelValue.find(o=>o.field===l.id))==null?void 0:n.value)??""}})}async function h(l){var n;if(await W(),l.el){const o=document.createElement("option");o.innerText="──────────",o.setAttribute("disabled","disabled"),(n=l.el.querySelector("select").querySelectorAll("option")[v.value.filter(d=>d.is_favorite).length||-1])==null||n.after(o)}}const F=X((l,n)=>n&&n.find(o=>{if(o.description&&typeof o.description=="object"){for(const d of Object.keys(o.description))if(d===l)return!0}return o.field.split(".")[1]===l})),S=H(()=>l=>{const n=F(l,a.errors);return n?n.description&&typeof n.description=="object"?n.description[l]:n.description:""});return(l,n)=>(r(),x(te,{space:"2"},{default:P(()=>[(r(!0),y(q,null,ee(g.value,o=>(r(),y(q,{key:o.id},[o.id==="country"?(r(),x(B,{key:0,modelValue:o.value,"onUpdate:modelValue":d=>o.value=d,options:o.type==="select"?o.option_values:[],placeholder:o.name,"error-message":S.value(o.id)},null,8,["modelValue","onUpdate:modelValue","options","placeholder","error-message"])):o.id==="region"?(r(),y(q,{key:1},[v.value.length?(r(),x(B,{key:v.value.length,modelValue:o.value,"onUpdate:modelValue":d=>o.value=d,options:v.value.map(d=>({id:d.code,value:d.name})),placeholder:o.name,"error-message":S.value(o.id),onVnodeMounted:n[0]||(n[0]=d=>h(d))},null,8,["modelValue","onUpdate:modelValue","options","placeholder","error-message"])):(r(),x(oe,{key:1,modelValue:o.value,"onUpdate:modelValue":d=>o.value=d,type:"text",placeholder:o.name,"error-message":S.value(o.id)},null,8,["modelValue","onUpdate:modelValue","placeholder","error-message"]))],64)):o.type==="select"||o.type==="radio"?(r(),x(T(E(N)[o.type]),{key:2,modelValue:o.value,"onUpdate:modelValue":d=>o.value=d,options:o.option_values,vertical:!0,placeholder:o.name,"error-message":S.value(o.id)},null,8,["modelValue","onUpdate:modelValue","options","placeholder","error-message"])):(r(),x(T(E(N)[o.type]),{key:3,modelValue:o.value,"onUpdate:modelValue":d=>o.value=d,placeholder:o.name,"error-message":S.value(o.id)},null,8,["modelValue","onUpdate:modelValue","placeholder","error-message"]))],64))),128))]),_:1}))}});async function K(){var a;await W();const m=document.querySelector(".dialog-content"),f=m==null?void 0:m.querySelector(".state-error");m&&f&&(m.scrollTop=(f.offsetTop||((a=f.offsetParent)==null?void 0:a.offsetTop)||0)-200)}const ye={key:0},we={class:"toggle rounded small"},_e={key:1,class:"tw-text-center"},he=w("div",{class:"spinner custom-p-16 tw-mt-6"},null,-1),fe=[he],ge={key:2},Ve={key:0,class:"tw-flex tw-flex-col md:tw-flex-row tw-space-y-1 md:tw-space-y-0 md:tw-space-x-2"},xe={class:"md:tw-flex-none md:tw-w-32 small gray tw-break-words md:tw-pt-1.5"},ke={class:"tw-flex-auto"},Fe={class:"tw-w-full md:tw-w-60 tw-flex-none tw-flex tw-space-x-2"},Ue={class:"tw-flex-auto"},Se={key:0,class:"text-yellow"},$e={class:"tw-flex-auto"},be={key:0,class:"handle tw-pt-1.5"},Ae=w("i",{class:"fas fa-grip-vertical gray"},null,-1),Ce=[Ae],qe={class:"tw-flex tw-flex-wrap tw-flex-auto tw-flex-col md:tw-flex-row tw-gap-2 tw-items-start"},Me={class:"tw-w-full md:tw-w-60 tw-flex-none tw-flex tw-space-x-2"},Te={class:"tw-flex-auto"},Ee=["onClick"],Ne=w("i",{class:"fas fa-trash-alt"},null,-1),je=[Ne],Oe={class:"tw-w-full md:tw-w-auto tw-flex tw-space-x-2 empty:tw-hidden"},Be={key:0,class:"tw-w-1/2 md:tw-w-28 tw-flex-none"},Ie={key:1,class:"tw-w-1/2 md:tw-w-28 tw-flex-none"},Re=["onClick"],De=w("i",{class:"fas fa-trash-alt"},null,-1),Je=[De],ze=["onClick"],We=w("i",{class:"fas fa-plus"},null,-1),Ke=Q({__name:"FormContactUpdateInfo",props:{contact:{},toCompany:{}},setup(m,{expose:f}){var L;const a=m,{t:V}=re(),g=ne(),v=!!a.contact,c=A(((L=a.contact)==null?void 0:L.details.is_company)??!1),b=A(!1),U=A(null),h=A([]),F=J({company_contact_id:v&&a.contact.main.company_contact_id?a.contact.main.company_contact_id:"",is_company:H(()=>+c.value)}),S=J({person:null,company:null}),l={person:null,company:null};f({modified:H(()=>{var i;return(i=S[c.value?"company":"person"])==null?void 0:i.modified}),submit:d});const n=X(async i=>{const{data:s,error:e}=await z(`crm.field.list?scope=${i}`).get().json();return{fields:s.value,error:e.value}});C(c,async i=>{var t;b.value=!0;const{fields:s,error:e}=await n(i?"company":"person");if(b.value=!1,Array.isArray(s)){l[i?"person":"company"]=h.value.length?h.value:null;const _=l[i?"company":"person"];_?h.value=_:(o(a.toCompany?s.filter(p=>p.id!=="company"):s),S[i?"company":"person"]=ce(h),(t=S[i?"company":"person"])==null||t.reset())}else U.value=e,n.clear()},{immediate:!0});function o(i){if(h.value=i.map(s=>{var _;const e=(_=a.contact)==null?void 0:_.data.filter(p=>p.field===s.id);let t;if(s.type==="composite"){const p={value:[],...s.ext?{ext:s.id==="address"?"":s.ext[0].id}:{}};t={...s,error:[],dummy:{...p},value:Array.isArray(e)&&e.length?e.map(k=>({value:Array.isArray(k.value)?k.value:[],...s.ext?{ext:k.ext}:{}})):[{...p}]}}else{const p={value:"",...s.ext?{ext:s.ext[0].id}:{}};t={...s,error:[],dummy:{...p},value:Array.isArray(e)&&e.length?e.map(k=>({value:Array.isArray(k.value)?"":k.value,...s.ext?{ext:k.ext}:{}})):[{...p}]}}return{...t,...s.is_required?{validate:R.object({value:R.string().min(1,{message:V("validation.required")})}).array()}:{}}}),g.query.phone){const s=h.value.find(e=>e.id==="phone");s&&(s.value[0].value=g.query.phone.toString())}}function d(){let i;if(h.value.forEach(e=>{if(["name","company","firstname","middlename","lastname"].includes(e.id)&&(e.value[0].value=String(e.value[0].value).trim()),e.validate)try{e.validate.parse(e.value)}catch(t){if(t instanceof R.ZodError){if(e.is_required&&t.errors[0]){const _=Array.isArray(e.value[0].value)?e.value[0].value[0].value:e.value[0].value;e.error=[{code:t.errors[0].code,description:t.errors[0].message,field:e.id,value:_}]}i=!0}}}),i)return setTimeout(()=>K()),null;const s=h.value.filter(e=>e.value.filter(t=>t.value&&(Array.isArray(t.value)?t.value.filter(_=>_).length:!0)).length).reduce((e,t)=>{const{value:_}=t;return e.push(..._.map(p=>({field:t.id,value:p.value,ext:p.ext}))),e},[]);return a.toCompany?s.push({field:"company_contact_id",value:a.toCompany.id},{field:"company",value:a.toCompany.name},{field:"is_company",value:0}):s.push(...Object.entries(F).filter(e=>e[1]!=="").map(e=>({field:e[0],value:e[1]}))),z(`crm.contact.${v?`update?id=${a.contact.id}`:"add"}`,{onFetchError(e){try{const t=JSON.parse(e.data);"error_fields"in t&&ae(t.error_fields)}catch{}return e}})[v?"put":"post"](JSON.stringify(s))}function ae(i){var s;for(const e of i)for(const t of e.field.split(", ")){const _=t.includes(".")?t.split(".")[0]:t,p=h.value.find(k=>k.id===_);p&&(p.type==="composite"?p.error=i:(s=p.error)==null||s.push(e))}K()}return(i,s)=>(r(),x(te,{space:"4"},{default:P(()=>[!v&&!a.toCompany?(r(),y("div",ye,[w("div",we,[w("span",{class:j({selected:!c.value}),onClick:s[0]||(s[0]=e=>c.value=!1)},M(i.$t("person")),3),w("span",{class:j({selected:c.value}),onClick:s[1]||(s[1]=e=>c.value=!0)},M(i.$t("company")),3)])])):$("",!0),b.value?(r(),y("div",_e,fe)):U.value?(r(),y("div",ge,M(U.value),1)):(r(),y(q,{key:3},[i.$slots.firstFieldValue?(r(),y("div",Ve,[w("div",xe,[Z(i.$slots,"firstFieldTitle")]),w("div",ke,[w("div",Fe,[w("div",Ue,[Z(i.$slots,"firstFieldValue")])])])])):$("",!0),(r(!0),y(q,null,ee(h.value,e=>(r(),y("div",{key:e.id,class:"tw-flex tw-flex-col md:tw-flex-row tw-space-y-1 md:tw-space-y-0 md:tw-space-x-2"},[w("div",{class:j(["md:tw-flex-none md:tw-w-32 small gray tw-break-words",{"md:tw-pt-1.5":!["radio","checkbox"].includes(e.type)}])},[G(M(e.name),1),e.is_required?(r(),y("span",Se,"*")):$("",!0)],2),w("div",$e,[O(ue,{list:e.value,"use-sort":!0,"min-length":2,onUpdate:t=>{e.value=t}},{default:P(({index:t})=>{var _,p,k,Y;return[w("div",{class:j(["tw-flex tw-space-x-2",t>0&&"bordered-top tw-pt-2"])},[e.value.length>1?(r(),y("div",be,Ce)):$("",!0),w("div",qe,[e.id==="birthday"&&e.type==="composite"?(r(),x(me,{key:0,modelValue:e.value[t].value,"onUpdate:modelValue":u=>e.value[t].value=u,"options-for-day-select":((_=e.fields.find(u=>u.id==="day"&&u.type==="select"))==null?void 0:_.option_values)||[],"options-for-month-select":((p=e.fields.find(u=>u.id==="month"&&u.type==="select"))==null?void 0:p.option_values)||[],errors:e.error},null,8,["modelValue","onUpdate:modelValue","options-for-day-select","options-for-month-select","errors"])):(r(),y(q,{key:1},[w("div",Me,[w("div",Te,[e.id==="company"&&!c.value?(r(),x(ie,{key:0,"is-multiple":!1,"text-value":e.value[t].value,"is-company":!0,"on-item-select":u=>{F.company_contact_id=u.id,e.value[t].value=u.name},onInput:u=>{F.company_contact_id="",e.value[t].value=u}},null,8,["text-value","on-item-select","onInput"])):e.id==="address"&&e.type==="composite"?(r(),x(ve,{key:1,modelValue:e.value[t].value,"onUpdate:modelValue":u=>e.value[t].value=u,fields:e.fields,errors:e.error},null,8,["modelValue","onUpdate:modelValue","fields","errors"])):(r(),x(T(E(N)[e.type]),{key:2,modelValue:e.value[t].value,"onUpdate:modelValue":u=>e.value[t].value=u,"error-message":(Y=(k=e.error)==null?void 0:k.find(u=>u.value===e.value[t].value))==null?void 0:Y.description,options:e.type==="select"||e.type==="radio"?e.option_values:void 0,fields:e.type==="composite"?e.fields:void 0,required:e.is_required,placeholder:t>0?`${e.name} ${t+1}`:void 0,vertical:e.type==="radio"?!0:void 0},null,8,["modelValue","onUpdate:modelValue","error-message","options","fields","required","placeholder","vertical"]))]),t>0?(r(),y("a",{key:0,class:"md:tw-hidden !tw-mt-1.5",onClick:D(u=>e.value.splice(t,1),["prevent"])},je,8,Ee)):$("",!0)]),w("div",Oe,[e.ext?(r(),y("div",Be,[(r(),x(T(E(N).select),{modelValue:e.value[t].ext,"onUpdate:modelValue":u=>e.value[t].ext=u,required:!0,options:[...e.ext,{id:e.ext.filter(u=>u.id===e.value[t].ext).length?"":e.value[t].ext??"",value:i.$t("other")}]},null,8,["modelValue","onUpdate:modelValue","options"]))])):$("",!0),Array.isArray(e.ext)&&!e.ext.find(u=>u.id===e.value[t].ext)?(r(),y("div",Ie,[(r(),x(T(E(N).string),{modelValue:e.value[t].ext,"onUpdate:modelValue":u=>e.value[t].ext=u},null,8,["modelValue","onUpdate:modelValue"]))])):$("",!0)])],64)),t>0?(r(),y("a",{key:2,class:"tw-hidden md:tw-block !tw-mt-1.5",onClick:D(()=>{e.value.splice(t,1)},["prevent"])},Je,8,Re)):$("",!0)])],2)]}),_:2},1032,["list","onUpdate"]),e.is_multi?(r(),y("a",{key:0,class:"button rounded outlined light-gray smaller !tw-mt-2",onClick:D(t=>e.value.push({...e.dummy}),["prevent"])},[We,G(" "+M(i.$t("addMore")),1)],8,ze)):$("",!0)])]))),128))],64))]),_:3}))}});export{Ke as _,K as s,ce as u};
