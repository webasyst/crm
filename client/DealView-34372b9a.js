import{d as F,h as I,a$ as et,l as L,ao as it,o as f,c as $,n as P,k as z,v as U,b as T,r as H,a as b,i as S,F as R,_ as V,O as yt,ax as M,u as v,e as D,t as q,w as E,p as B,j as w,S as xt,R as Z,a9 as at,b0 as $t,ak as Ct,A as W,H as wt,N as Tt,s as ct,x as dt,m as ut,E as Et,b1 as St,aD as Bt,b2 as It,b3 as Nt,I as At,a0 as Lt,b4 as Dt,Z as ot,Y as Q,b5 as Ft,B as O}from"./main-d7f03521.js";import{c as Pt}from"./index-884c82be.js";import{a as Ot,T as Ht,_ as Rt,b as X}from"./TabList-8d2eb9e4.js";import Y from"./IframeView-f8660ec0.js";import{_ as J,a as Mt}from"./DealNavigateBack.vue_vue_type_script_setup_true_lang-fe2b6086.js";import{_ as jt}from"./ErrorDummy.vue_vue_type_script_setup_true_lang-2e2d0418.js";import{b as mt,c as zt,d as rt,D as ft,a as gt,_ as bt}from"./DealHeaderButtonReopen.vue_vue_type_script_setup_true_lang-f826e550.js";import{_ as Ut}from"./ButtonFavorites.vue_vue_type_script_setup_true_lang-2d595162.js";import{M as Wt,_ as G}from"./DropDown-7a0f8902.js";import{D as qt}from"./DropdownModal-9b06143e.js";import{i as Vt}from"./currency-format-a8df1195.js";import{d as lt}from"./date-fb01f223.js";import{U as Kt}from"./UserPic-c11efadd.js";import{B as pt}from"./ButtonSubmit-bbd5ca4e.js";import"./index-dc17eb5d.js";import"./useSortable-eb883c7d.js";import"./iframeObserver-7b20ae08.js";import"./EmptyList-ca1e10b8.js";import"./CustomColumn-83646d88.js";import"./emit-b4342586.js";import"./dealStageChanger-104e490b.js";import"./alert-e3df1b86.js";import"./FieldSelect-ae6f0f9b.js";import"./DropDownButton-b07233c5.js";import"./DropdownAddTags.vue_vue_type_script_setup_true_lang-fb37638e.js";import"./ChipsList-ee14164a.js";import"./FieldCheckbox-2a93227f.js";import"./TagsCloud.vue_vue_type_script_setup_true_lang-11109664.js";import"./fields-39e1f9f0.js";import"./IconButton-69702b8c.js";import"./vTooltip-95186f83.js";import"./CustomField-aefbde99.js";import"./InputWithPerformers.vue_vue_type_script_setup_true_lang-47aeec90.js";import"./recentContacts-8eea64ba.js";import"./dayjs-8b9f8f59.js";import"./dealFields-1f50ecbd.js";import"./TabContentIframe.vue_vue_type_script_setup_true_lang-335e6318.js";import"./SkeletonList-27785815.js";import"./validation-c851d981.js";import"./object_hash-44c1703e.js";const Xt={key:1,class:"bordered-bottom"},Yt=F({__name:"DealTabs",props:{tabs:{},isFetching:{type:Boolean},stickyTabs:{type:Boolean},includesIndent:{},errorCode:{},errorMessage:{}},setup(u){const l=u,h=I(null),g=I(null),_=et(h),x=et(g),k=L(()=>l.stickyTabs&&!_.value&&!x.value);return it(()=>{g.value=document.querySelector(".deal-header")}),(c,C)=>(f(),$(R,null,[l.errorMessage?(f(),$("div",Xt)):(f(),$("div",{key:0,class:P(["tabs-wrapper bordered-bottom",{"tabs--sticky slide-up":k.value}])},[z(T(J,null,null,512),[[U,k.value]]),H(c.$slots,"beforeTabs",{},void 0,!0),T(Ot,{"entity-type":"deal","is-fetching":l.isFetching,value:l.tabs,"fade-color":"var(--deal-sidebar-background-color)"},null,8,["is-fetching","value"])],2)),b("div",{ref_key:"observeDummyRef",ref:h},null,512),b("div",{class:P(["tab-content",{"tw-p-4 mobile:tw-px-3":(l.includesIndent||[]).includes(c.$route.name)}])},[l.errorMessage?(f(),S(jt,{key:0,code:l.errorCode,message:l.errorMessage},null,8,["code","message"])):H(c.$slots,"default",{key:1},void 0,!0)],2)],64))}});const Gt=V(Yt,[["__scopeId","data-v-7e97e940"]]),tt=I(!1);function vt(){async function u(l,h){var _;tt.value=!0;const{response:g}=await yt(`crm.deal.${h?"unpin":"pin"}`).post({id:l});tt.value=!1,(_=g.value)!=null&&_.ok&&M().updateDeal({is_pinned:!h})}return{isFetching:tt,togglePin:u}}const Zt={key:1,class:"skeleton"},Jt=b("div",{class:"skeleton-custom-circle size-32 !tw-m-0"},null,-1),Qt=[Jt],_t=F({__name:"DealInfoFavorites",props:{dealId:{},isPinned:{type:Boolean}},setup(u){const l=u,{isFetching:h,togglePin:g}=vt();return(_,x)=>l.dealId?H(_.$slots,"default",{key:0,isFavorite:l.isPinned,isLoading:v(h),togglePin:()=>v(g)(l.dealId,l.isPinned)},()=>[T(Ut,{type:"circle","is-favorite":l.isPinned,"is-loading":v(h),onClick:x[0]||(x[0]=D(k=>v(g)(l.dealId,l.isPinned),["prevent"]))},null,8,["is-favorite","is-loading"])]):(f(),$("div",Zt,Qt))}}),te=["onClick"],ee=b("span",{class:"icon"},[b("i",{class:"fas fa-pen"})],-1),ie={class:"label"},se=["onClick"],ne={key:0,class:"icon"},ae=b("i",{class:"fas fa-star text-orange"},null,-1),oe=[ae],re={key:1,class:"icon"},le=b("i",{class:"fas fa-star"},null,-1),pe=[le],he={class:"label"},ce=["onClick"],de={class:"label"},ue=["onClick"],me=b("span",{class:"icon"},[b("i",{class:"fas fa-trash-alt"})],-1),fe={class:"label"},st=F({__name:"DropdownOptionsEdit",props:{useOptions:{}},setup(u){const l=u,h=M(),{deal:g,eventEditing:_}=q(h),x=L(()=>l.useOptions.reduce((C,t)=>({...C,[t]:!0}),{})),k=L(()=>{var C;return(C=g.value)==null?void 0:C.description_plain.trim()});function c(){g.value&&xt(Mt,{ids:[g.value.id],dealName:g.value.name,callbackSuccess:()=>h.$reset()}).show()}return(C,t)=>(f(),S(qt,null,{body:E(({hide:e})=>[v(g)?(f(),S(Wt,{key:0},{default:E(()=>[v(g).rights.can_edit?(f(),$(R,{key:0},[x.value.name?(f(),S(G,{key:0},{default:E(()=>[b("a",{class:"actionItem",onClick:D(i=>{e(),v(_).name=!0},["prevent"])},[ee,b("span",ie,B(C.$t("editTitle")),1)],8,te)]),_:2},1024)):w("",!0),x.value.favorite?(f(),S(G,{key:1},{default:E(()=>{var i;return[T(_t,{"deal-id":v(g).id,"is-pinned":(i=v(g))==null?void 0:i.is_pinned},{default:E(({isFavorite:s,togglePin:n})=>[b("a",{class:"actionItem",onClick:D(a=>{e(),n()},["prevent"])},[s?(f(),$("span",ne,oe)):(f(),$("span",re,pe)),b("span",he,B(s?C.$t("removeFromFavorites"):C.$t("addToFavorites")),1)],8,se)]),_:2},1032,["deal-id","is-pinned"])]}),_:2},1024)):w("",!0),x.value.description?(f(),S(G,{key:2},{default:E(()=>[b("a",{class:"actionItem",onClick:D(i=>{e(),v(_).description=!0},["prevent"])},[(f(),$("span",{key:k.value,class:"icon"},[b("i",{class:P(k.value?"fas fa-pen":"fas fa-plus-circle")},null,2)])),b("span",de,B(k.value?C.$t("editDescr"):C.$t("addDescr")),1)],8,ce)]),_:2},1024)):w("",!0)],64)):w("",!0),v(g).rights.can_delete?(f(),$(R,{key:1},[x.value.delete?(f(),S(G,{key:0},{default:E(()=>[b("a",{class:"actionItem",onClick:D(i=>{e(),c()},["prevent"])},[me,b("span",fe,B(C.$t("delete")),1)],8,ue)]),_:2},1024)):w("",!0)],64)):w("",!0)]),_:2},1024)):w("",!0)]),default:E(()=>[H(C.$slots,"default")]),_:3}))}}),ge={class:"inline-expander-wrapper break-words"},be=["onClick"],ve=["onClick"],_e={key:1,class:"description-full"},ke=["innerHTML"],ye={class:"description-full-bottombar"},xe=["onClick"],$e=F({__name:"InlineWithExpander",props:{edit:{type:Boolean},hideCollapseIfNotOverflow:{type:Boolean},maxHeightPreview:{default:"3rem"},backgroundBtnMore:{default:"var(--background-color-blank)"},fullHtml:{default:void 0}},emits:["collapse"],setup(u,{emit:l}){const h=u,g=I(),_=I(!1),x=I(!1);Z(()=>h.edit,t=>{x.value=!!t});const k=()=>{g.value instanceof HTMLElement&&(_.value=$t(g.value))};it(()=>{k()});function c(){!_.value&&h.hideCollapseIfNotOverflow||(x.value=!0)}async function C(){x.value=!1,l("collapse"),await Ct(),k()}return(t,e)=>(f(),$("div",ge,[x.value?(f(),$("div",_e,[h.fullHtml?(f(),$("div",{key:0,innerHTML:h.fullHtml},null,8,ke)):H(t.$slots,"full",{key:1},void 0,!0),b("div",ye,[H(t.$slots,"submit",{},void 0,!0),_.value||!h.hideCollapseIfNotOverflow?(f(),$("a",{key:0,class:"description-full__button-collapse !tw-ml-auto",onClick:D(C,["prevent"])},B(t.$t("collapse")),9,xe)):w("",!0)])])):(f(),$("div",{key:0,class:P(["description-preview inline-expander",{"inline-expander--editable":_.value||!h.hideCollapseIfNotOverflow}])},[b("div",{ref_key:"previewRef",ref:g,class:P(["inline-expander__text",{"inline-expander__text--overflowed":_.value}]),style:at({maxHeight:h.maxHeightPreview}),onClick:D(c,["prevent"])},[H(t.$slots,"preview",{},void 0,!0)],14,be),_.value?(f(),$("a",{key:0,class:"inline-expander__button-more",style:at({background:h.backgroundBtnMore}),onClick:D(c,["prevent"])},B(t.$t("more"))+"... ",13,ve)):w("",!0)],2))]))}});const kt=V($e,[["__scopeId","data-v-32d19e62"]]),Ce=["onClick"],we=b("span",{class:"tw-mr-1"},[b("i",{class:"fas fa-list-ul"})],-1),Te=F({__name:"DealInfoPaneMobile",setup(u){return(l,h)=>(f(),S(zt,{title:l.$t("aboutDeal"),"full-height":!0},{toggler:E(({show:g})=>[b("button",{ref:"moreBtnRef",class:"button light-gray width-100 !tw-text-waAccent",onClick:D(g,["prevent"])},[we,W(" "+B(l.$t("moreAboutDeal")),1)],8,Ce)]),default:E(()=>[T(mt,null,{description:E(({deal:g})=>[T(kt,{"max-height-preview":"2.4rem","full-html":g.description_sanitized,"hide-collapse-if-not-overflow":!0},{preview:E(()=>[W(B(g.description_plain),1)]),_:2},1032,["full-html"])]),_:1})]),_:1},8,["title"]))}}),j=u=>(ct("data-v-39c36507"),u=u(),dt(),u),Ee={class:"tw-flex tw-gap-x-1 tw-items-center"},Se={class:"deal-toolbar__amount"},Be={key:0,class:"icon size-12"},Ie=j(()=>b("i",{class:"fas fa-spinner wa-animation-spin"},null,-1)),Ne=[Ie],Ae=j(()=>b("i",{class:"fas fa-star"},null,-1)),Le=[Ae],De={key:2,class:"gray small tw-ml-1"},Fe={class:"deal-toolbar__date-term"},Pe={key:1,class:"skeleton tw-flex tw-flex-col tw-gap-y-1 tw-mt-1"},Oe=j(()=>b("div",{class:"skeleton-line !tw-w-2/3 !tw-h-[16px]"},null,-1)),He=j(()=>b("div",{class:"skeleton-line !tw-w-10/12 !tw-h-[16px]"},null,-1)),Re=[Oe,He],Me={class:"tw-flex"},je={key:0},ze=j(()=>b("i",{class:"fas fa-list-ul"},null,-1)),Ue=[ze],We={class:"tw-flex-auto tw-ml-0.5"},qe=j(()=>b("button",{class:"button circle light-gray !tw-bg-transparent"},[b("i",{class:"fas fa-ellipsis-v"})],-1)),Ve=F({__name:"DealHeaderToolbarMobile",props:{deal:{},showMoreBtn:{type:Boolean},isError:{type:Boolean}},emits:["clickMoreBtn"],setup(u,{emit:l}){const h=u,{t:g}=wt(),_=I(),{isFetching:x}=vt();return Z(()=>{var k,c,C;return[(k=h.deal)==null?void 0:k.currency_id,(c=h.deal)==null?void 0:c.amount,(C=h.deal)==null?void 0:C.expected_date]},()=>{h.deal&&(_.value={amount:h.deal.currency_id?Vt(h.deal.currency_id,h.deal.amount||0):"0",dateTerm:`${lt(h.deal.create_datetime)} — ${h.deal.expected_date?lt(h.deal.expected_date):g("noDeadline")}`})},{immediate:!0}),(k,c)=>(f(),S(Ht,{"disable-animation":k.$route.meta.isWidgetMode},Tt({default:E(()=>{var C;return[k.isError?w("",!0):(f(),$("div",{key:0,class:P(["tw-flex tw-flex-col",{"tw-ml-4":k.$route.meta.isWidgetMode}])},[_.value?(f(),$(R,{key:0},[b("div",Ee,[b("div",Se,B(_.value.amount),1),v(x)?(f(),$("span",Be,Ne)):(f(),$("span",{key:1,class:P(["icon size-12",(C=k.deal)!=null&&C.is_pinned?"text-orange":""])},Le,2)),k.deal?(f(),$("div",De," id: "+B(k.deal.id),1)):w("",!0)]),b("div",Fe,B(_.value.dateTerm),1)],64)):(f(),$("div",Pe,Re))],2))]}),_:2},[k.$route.meta.isWidgetMode?void 0:{name:"back",fn:E(()=>[T(J)]),key:"0"},k.isError?void 0:{name:"buttons",fn:E(()=>[b("div",Me,[h.showMoreBtn?(f(),$("div",je,[b("button",{class:"button nobutton circle text-gray",onClick:c[0]||(c[0]=D(C=>l("clickMoreBtn"),["prevent"]))},Ue)])):w("",!0),b("div",We,[k.$route.meta.isWidgetMode?w("",!0):(f(),S(st,{key:0,"use-options":["name","favorite","delete"],class:"tw-text-right",right:!0},{default:E(()=>[qe]),_:1}))])])]),key:"1"}]),1032,["disable-animation"]))}});const Ke=V(Ve,[["__scopeId","data-v-39c36507"]]),Xe={class:"contactItem"},Ye={class:"contactView"},Ge={class:"tw-flex tw-gap-x-1"},Ze={class:"contactNameWrapper"},Je=["onClick"],Qe={key:0,class:"tw-flex tw-flex-wrap tw-gap-1"},ti={key:1,class:"contactCompany"},ei=F({__name:"DealHeaderParticipantViewMobile",props:{contact:{},isResponsible:{type:Boolean}},setup(u){const l=u;return(h,g)=>{var x,k;const _=ut("RouterLink");return f(),$("div",Xe,[b("div",Ye,[b("div",Ge,[T(Kt,{size:20,url:l.contact.contact.userpic},null,8,["url"]),b("div",Ze,[T(_,{to:{name:"contact",params:{id:l.contact.contact.id}},custom:""},{default:E(({navigate:c})=>[b("a",{class:P(["contactName break-words",h.$constant.parentAppDisableRouterClass]),onClick:c},B(l.contact.contact.name),11,Je)]),_:1},8,["to"]),l.isResponsible||(x=l.contact.label)!=null&&x.trim()?(f(),$("div",Qe,[l.isResponsible?(f(),S(rt,{key:0,label:h.$t("responsible"),color:"orange",class:"tw-mr-1"},null,8,["label"])):w("",!0),(k=l.contact.label)!=null&&k.trim()?(f(),S(rt,{key:1,label:l.contact.label},null,8,["label"])):w("",!0)])):w("",!0),"company"in l.contact.contact?(f(),$("div",ti,B(l.contact.contact.company),1)):w("",!0)])])])])}}});const ht=V(ei,[["__scopeId","data-v-7bece3c2"]]),nt=u=>(ct("data-v-a9625caa"),u=u(),dt(),u),ii={key:0,class:"deal-header deal-header--mobile"},si={class:"deal-header__main"},ni={class:"deal-header__title"},ai={class:"deal-header__stage"},oi={class:"tw-flex tw-gap-2"},ri=nt(()=>b("button",{class:"button circle light-gray !tw-bg-transparent"},[b("i",{class:"fas fa-ellipsis-v"})],-1)),li={key:0,class:"tw-text-right"},pi={key:1,class:"deal-header__lost-text"},hi={key:0,class:"deal-header__participants"},ci={key:1,class:"skeleton tw-flex tw-flex-col tw-gap-y-2"},di=nt(()=>b("div",{class:"skeleton-line !tw-h-9 !tw-w-9/12"},null,-1)),ui=nt(()=>b("div",{class:"skeleton-line !tw-h-8 !tw-w-9/12"},null,-1)),mi=[di,ui],fi=F({__name:"DealHeaderMobile",setup(u){const l=M(),{deal:h,eventEditing:g,statusCode:_}=q(l),x=I(null),k=et(x),c=I(!1),C=L(()=>!!h.value&&h.value.rights.can_edit),t=L(()=>!!h.value&&h.value.status_id!=="OPEN"),e=L(()=>h.value&&h.value.contacts.find(s=>{var n;return s.contact.id===((n=h.value)==null?void 0:n.contact_id)})),i=L(()=>h.value&&h.value.users.find(s=>{var n;return s.contact.id===((n=h.value)==null?void 0:n.user_contact_id)}));return(s,n)=>{var a,o,r,p;return f(),$(R,null,[T(Ke,{deal:v(h),"is-error":[403,404].includes(Number(v(_))),"show-more-btn":!v(k),onClickMoreBtn:n[0]||(n[0]=d=>c.value=!0)},null,8,["deal","is-error","show-more-btn"]),[403,404].includes(Number(v(_)))?w("",!0):(f(),$("div",ii,[b("div",si,[b("div",ni,[s.$route.meta.isWidgetMode?(f(),S(J,{key:0})):w("",!0),T(ft,{editing:v(g).name,"deal-id":(a=v(h))==null?void 0:a.id,"deal-name":(o=v(h))==null?void 0:o.name,"can-edit":C.value,"is-closed":t.value,onEditing:n[1]||(n[1]=d=>v(g).name=d)},null,8,["editing","deal-id","deal-name","can-edit","is-closed"])]),b("div",ai,[b("div",oi,[T(gt),s.$route.meta.isWidgetMode?(f(),S(st,{key:0,"use-options":["name","favorite","delete"],class:"tw-text-right",right:!0},{default:E(()=>[ri]),_:1})):w("",!0)]),t.value?(f(),$("div",li,[T(bt)])):w("",!0),((r=v(h))==null?void 0:r.status_id)==="LOST"&&((p=v(h))!=null&&p.lost_text)?(f(),$("div",pi,B(v(h).lost_text),1)):w("",!0)])]),v(h)?(f(),$("div",hi,[e.value?(f(),S(ht,{key:e.value.contact.id,contact:e.value},null,8,["contact"])):w("",!0),i.value?(f(),S(ht,{key:i.value.contact.id,contact:i.value,"is-responsible":!0},null,8,["contact"])):w("",!0)])):(f(),$("div",ci,mi)),b("div",{ref_key:"footerRef",ref:x,class:"deal-header__footer"},[T(Te,{show:c.value,onClose:n[2]||(n[2]=d=>c.value=!1)},null,8,["show"])],512)]))],64)}}});const gi=V(fi,[["__scopeId","data-v-a9625caa"]]);var bi;(function(){function u(t,e){return this.parse(t,e)}function l(t,e){return i=e,c.dom(t).each(function(n){(s=n.dataget(c.namespace))||(s=new C(n,i,k),n.dataset(c.namespace,s),c.instances[k]=s,k++)}),s;var i,s}var h={settings:{},post:function(t){return new g("post",t)},get:function(t){return new g("get",t)},request:function(t,e){return new g(t,e)}},g=function(t,e){this.p=this.extend({method:t,url:"",before:function(){},success:function(){},error:function(){},data:!1,async:!0,headers:{}},e),this.p=this.extend(this.p,h.settings),this.p.method=this.p.method.toUpperCase(),this.prepareData(),this.xhr=new XMLHttpRequest,this.xhr.open(this.p.method,this.p.url,this.p.async),this.setHeaders(),(typeof this.p.before!="function"||this.p.before(this.xhr))!==!1&&this.send()},_=(g.prototype={extend:function(t,e){return e&&Object.keys(e).forEach(function(i){t[i]=e[i]}),t},prepareData:function(){var t;["POST","PUT"].indexOf(this.p.method)===-1||this.isFormData()||(this.p.headers["Content-Type"]="application/x-www-form-urlencoded"),typeof this.p.data!="object"||this.isFormData()||(this.p.data=this.toParams(this.p.data)),this.p.method==="GET"&&(t=this.p.url.search(/\?/)!==-1?"&":"?",this.p.url=this.p.data?this.p.url+t+this.p.data:this.p.url)},setHeaders:function(){this.xhr.setRequestHeader("X-Requested-With",this.p.headers["X-Requested-With"]||"XMLHttpRequest"),Object.keys(this.p.headers).forEach((function(t){this.xhr.setRequestHeader(t,this.p.headers[t])}).bind(this))},isFormData:function(){return window.FormData!==void 0&&this.p.data instanceof window.FormData},isComplete:function(){return!(this.xhr.status<200||300<=this.xhr.status&&this.xhr.status!==304)},send:function(){this.p.async?(this.xhr.onload=this.loaded.bind(this),this.xhr.send(this.p.data)):(this.xhr.send(this.p.data),this.loaded.call(this))},loaded:function(){var t;this.isComplete()?(t=this.parseResponse(),typeof this.p.success=="function"&&this.p.success(t,this.xhr)):(t=this.parseResponse(),typeof this.p.error=="function"&&this.p.error(t,this.xhr,this.xhr.status))},parseResponse:function(){var t=this.xhr.response,e=this.parseJson(t);return e||t},parseJson:function(t){try{var e=JSON.parse(t);if(e&&typeof e=="object")return e}catch{}return!1},toParams:function(t){return Object.keys(t).map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(t[e])}).join("&")}},[0]),x="data"+new Date().getTime(),k=(u.ready=function(t){document.addEventListener("DOMContentLoaded",t)},u.prototype={get length(){return this.nodes.length},parse:function(t,e){var i;if(t){if(t instanceof u)return this.nodes=t.nodes,t;i=/^\s*<(\w+|!)[^>]*>/.test(t)?this.create(t):typeof t!="string"?t.nodeType&&t.nodeType===11?t.childNodes:t.nodeType||this._isWindowNode(t)?[t]:t:this._query(t,e)}else i=[];this.nodes=this._slice(i)},create:function(t){if(/^<(\w+)\s*\/?>(?:<\/\1>|)$/.test(t))return[document.createElement(RegExp.$1)];var e=[],i=document.createElement("div");i.innerHTML=t;for(var s=0,n=i.childNodes.length;s<n;s++)e.push(i.childNodes[s]);return e},dataset:function(t,e){return this.each(function(i){_[this.dataindex(i.get())][t]=e})},dataget:function(t){return _[this.dataindex(this.get())][t]},dataindex:function(t){var e=t[x],i=_.length;return e||(e=i,t&&(t[x]=i),_[e]={}),e},add:function(t){return this.nodes=this.nodes.concat(this._array(t)),this},get:function(t){return this.nodes[t||0]||!1},getAll:function(){return this.nodes},eq:function(t){return new u(this.nodes[t])},first:function(){return new u(this.nodes[0])},last:function(){return new u(this.nodes[this.nodes.length-1])},contents:function(){return this.get().childNodes},each:function(t){for(var e=this.nodes.length,i=0;i<e;i++)t.call(this,new u(this.nodes[i]),i);return this},is:function(t){return 0<this.filter(t).length},filter:function(t){return t===void 0?this:new u(this.nodes.filter.call(this.nodes,typeof t=="function"?function(e){return t(new u(e))}:function(e){return t&&t.nodeType||t instanceof Node?t===e:(e.matches=e.matches||e.msMatchesSelector||e.webkitMatchesSelector,e.nodeType===1&&e.matches(t||"*"))}))},not:function(t){return this.filter(function(e){return!new u(e).is(t||!0)})},find:function(t){var e=[];return this.each(function(i){for(var i=i.get(),s=this._query(t,i),n=0;n<s.length;n++)e.push(s[n])}),new u(e)},children:function(t){var e=[];return this.each(function(i){if(i=i.get(),i.children)for(var s=i.children,n=0;n<s.length;n++)e.push(s[n])}),new u(e).filter(t)},parent:function(t){var e=this.get(),e=e.parentNode||!1;return e?new u(e).filter(t):new u},parents:function(t,e){e=this._context(e);var i=[];return this.each(function(s){for(var n=s.get().parentNode;n&&n!==e;)t&&!new u(n).is(t)||i.push(n),n=n.parentNode}),new u(i)},closest:function(t,e){e=this._context(e);var i=[],s=t&&t.nodeType;return this.each(function(n){var a=n.get();do if(a&&(s&&a===t||new u(a).is(t)))return i.push(a);while((a=a.parentNode)&&a!==e)}),new u(i)},next:function(t){return this._sibling(t,"nextSibling")},nextElement:function(t){return this._sibling(t,"nextElementSibling")},prev:function(t){return this._sibling(t,"previousSibling")},prevElement:function(t){return this._sibling(t,"previousElementSibling")},css:function(t,e){var i;return e===void 0&&typeof t!="object"?(i=this.get(),t==="width"||t==="height"?i.style?this._getHeightOrWidth(t)+"px":void 0:i.style?getComputedStyle(i,null)[t]:void 0):this.each(function(s){var n,a=s.get(),o={};for(n in typeof t=="object"?o=t:o[t]=e,o)a.style&&(a.style[n]=o[n])})},attr:function(t,e,i){var s;return i=i?"data-":"",e===void 0&&typeof t!="object"?(s=this.get())&&s.nodeType!==3?t==="checked"?s.checked:this._boolean(s.getAttribute(i+t)):void 0:this.each(function(n){var a,o=n.get(),r={};for(a in typeof t=="object"?r=t:r[t]=e,r)o.nodeType!==3&&(a==="checked"?o.checked=r[a]:o.setAttribute(i+a,r[a]))})},data:function(t,e){if(t!==void 0&&t!==!0)return this.attr(t,e,!0);function i(d){return d[1].toUpperCase()}var s,n,a,o=/^data-(.+)$/,r=this.get().attributes,p={};for(s in r)r[s]&&o.test(r[s].nodeName)&&(n=r[s].nodeName.match(o)[1],a=r[s].value,t!==!0&&(n=n.replace(/-([a-z])/g,i)),a=a.search(/^{/)!==-1?this._object(a):this._number(a)?parseFloat(a):this._boolean(a),p[n]=a);return p},val:function(t){var e;return t===void 0?(e=this.get()).type&&e.type==="checkbox"?e.checked:e.value:this.each(function(i){i=i.get(),i.type&&i.type==="checkbox"?i.checked=t:i.value=t})},removeAttr:function(t){return this.each(function(e){var i=e.get();t.split(" ").forEach(function(s){i.nodeType!==3&&i.removeAttribute(s)})})},addClass:function(t){return this._eachClass(t,"add")},removeClass:function(t){return this._eachClass(t,"remove")},toggleClass:function(t){return this._eachClass(t,"toggle")},hasClass:function(t){var e=this.get();return!!e.classList&&e.classList.contains(t)},empty:function(){return this.each(function(t){t.get().innerHTML=""})},html:function(t){return t===void 0?this.get().innerHTML||"":this.empty().append(t)},text:function(t){return t===void 0?this.get().textContent||"":this.each(function(e){e.get().textContent=t})},after:function(t){return this._inject(t,function(e,i){if(typeof e=="string")i.insertAdjacentHTML("afterend",e);else if(i.parentNode!==null)for(var s=e instanceof Node?[e]:this._array(e).reverse(),n=0;n<s.length;n++)i.parentNode.insertBefore(s[n],i.nextSibling);return i})},before:function(t){return this._inject(t,function(e,i){if(typeof e=="string")i.insertAdjacentHTML("beforebegin",e);else for(var s=e instanceof Node?[e]:this._array(e),n=0;n<s.length;n++)i.parentNode.insertBefore(s[n],i);return i})},append:function(t){return this._inject(t,function(e,i){if(typeof e=="string"||typeof e=="number")i.insertAdjacentHTML("beforeend",e);else for(var s=e instanceof Node?[e]:this._array(e),n=0;n<s.length;n++)i.appendChild(s[n]);return i})},prepend:function(t){return this._inject(t,function(e,i){if(typeof e=="string"||typeof e=="number")i.insertAdjacentHTML("afterbegin",e);else for(var s=e instanceof Node?[e]:this._array(e).reverse(),n=0;n<s.length;n++)i.insertBefore(s[n],i.firstChild);return i})},wrap:function(t){return this._inject(t,function(e,i){return e=typeof e=="string"||typeof e=="number"?this.create(e)[0]:e instanceof Node?e:this._array(e)[0],i.parentNode&&i.parentNode.insertBefore(e,i),e.appendChild(i),e})},unwrap:function(){return this.each(function(t){for(var e=t.get(),i=document.createDocumentFragment();e.firstChild;){var s=e.removeChild(e.firstChild);i.appendChild(s)}e.parentNode.replaceChild(i,e)})},replaceWith:function(t){return this._inject(t,function(e,i){for(var s=document.createDocumentFragment(),n=typeof e=="string"||typeof e=="number"?this.create(e):e instanceof Node?[e]:this._array(e),a=0;a<n.length;a++)s.appendChild(n[a]);return e=s.childNodes[0],i.parentNode&&i.parentNode.replaceChild(s,i),e})},remove:function(){return this.each(function(t){t=t.get(),t.parentNode&&t.parentNode.removeChild(t)})},clone:function(t){var e=[];return this.each(function(s){var s=s.get(),n=this._clone(s);t&&(n=this._cloneEvents(s,n)),e.push(n)}),new u(e)},show:function(){return this.each((function(i){var e,i=i.get();i.style&&this._hasDisplayNone(i)&&(e=i.getAttribute("domTargetShow"),i.style.display=e||"block",i.removeAttribute("domTargetShow"))}).bind(this))},hide:function(){return this.each(function(i){var e,i=i.get();i.style&&!this._hasDisplayNone(i)&&((e=i.style.display)!=="block"&&i.setAttribute("domTargetShow",e),i.style.display="none")})},scrollTop:function(t){var e=this.get(),i=this._isWindowNode(e),s=e.nodeType===9?e.scrollingElement||e.body.parentNode||e.body||e.documentElement:e;if(t===void 0)return i?e.pageYOffset:s.scrollTop;t=parseInt(t),i?e.scrollTo(0,t):s.scrollTop=t},offset:function(){return this._getPos("offset")},position:function(){return this._getPos("position")},width:function(t){return t!==void 0?this.css("width",parseInt(t)+"px"):this._getSize("width","Width")},height:function(t){return t!==void 0?this.css("height",parseInt(t)+"px"):this._getSize("height","Height")},outerWidth:function(){return this._getSize("width","Width","outer")},outerHeight:function(){return this._getSize("height","Height","outer")},innerWidth:function(){return this._getSize("width","Width","inner")},innerHeight:function(){return this._getSize("height","Height","inner")},click:function(){return this._trigger("click")},focus:function(){return this._trigger("focus")},blur:function(){return this._trigger("blur")},on:function(t,e,i){return this.each(function(s){for(var n=s.get(),a=t.split(" "),o=0;o<a.length;o++){var r=this._getEventName(a[o]),p=this._getEventNamespace(a[o]);e=i?this._getOneHandler(e,t):e,n.addEventListener(r,e),n._e=n._e||{},n._e[p]=n._e[p]||{},n._e[p][r]=n._e[p][r]||[],n._e[p][r].push(e)}})},one:function(t,e){return this.on(t,e,!0)},off:function(t,e){function i(o,r,p){return o===p}function s(o,r,p,d){return r===d}function n(o,r,p,d){return o===p&&r===d}function a(){return!0}return t===void 0?this.each(function(o){this._offEvent(o.get(),!1,!1,e,a)}):this.each(function(o){for(var r=o.get(),p=t.split(" "),d=0;d<p.length;d++){var m=this._getEventName(p[d]),y=this._getEventNamespace(p[d]);y==="_events"?this._offEvent(r,m,y,e,i):m||y==="_events"?this._offEvent(r,m,y,e,n):this._offEvent(r,m,y,e,s)}})},serialize:function(t){for(var e={},i=this.get().elements,s=0;s<i.length;s++){var n=i[s];if((!/(checkbox|radio)/.test(n.type)||n.checked)&&n.name&&!n.disabled&&n.type!=="file"){if(n.type==="select-multiple")for(var a=0;a<n.options.length;a++){var o=n.options[a];o.selected&&(e[n.name]=o.value)}e[n.name]=this._number(n.value)?parseFloat(n.value):this._boolean(n.value)}}return t?e:this._params(e)},scroll:function(){this.get().scrollIntoView({behavior:"smooth"})},fadeIn:function(t,e){var i=this._anim(t,e,500);return this.each(function(s){s.css({display:"block",opacity:0,animation:"fadeIn "+i.speed+"s ease-in-out"}).removeClass("hidden"),s.one("animationend",function(){s.css({opacity:"",animation:""}),i.fn&&i.fn(s)})})},fadeOut:function(t,e){var i=this._anim(t,e,300);return this.each(function(s){s.css({opacity:1,animation:"fadeOut "+i.speed+"s ease-in-out"}),s.one("animationend",function(){s.css({display:"none",opacity:"",animation:""}),i.fn&&i.fn(s)})})},slideUp:function(t,e){var i=this._anim(t,e,300);return this.each(function(s){s.height(s.height()),s.css({overflow:"hidden",animation:"slideUp "+i.speed+"s ease-out"}),s.one("animationend",function(){s.css({display:"none",height:"",animation:""}),i.fn&&i.fn(s)})})},slideDown:function(t,e){var i=this._anim(t,e,400);return this.each(function(s){s.height(s.height()),s.css({display:"block",overflow:"hidden",animation:"slideDown "+i.speed+"s ease-in-out"}).removeClass("hidden"),s.one("animationend",function(){s.css({overflow:"",height:"",animation:""}),i.fn&&i.fn(s)})})},_queryContext:function(t,e){return(e=this._context(e)).nodeType!==3&&typeof e.querySelectorAll=="function"?e.querySelectorAll(t):[]},_query:function(t,e){var i=document;return e?this._queryContext(t,e):/^[.#]?[\w-]*$/.test(t)?t[0]==="#"?(e=i.getElementById(t.slice(1)))?[e]:[]:t[0]==="."?i.getElementsByClassName(t.slice(1)):i.getElementsByTagName(t):i.querySelectorAll(t)},_context:function(t){return t?typeof t=="string"?document.querySelector(t):t:document},_sibling:function(t,e){var i,s=t&&t.nodeType;return this.each(function(n){var a=n.get();do if((a=a[e])&&(s&&a===t||new u(a).is(t)))return void(i=a);while(a)}),new u(i)},_slice:function(t){return t&&t.length!==0?t.length?[].slice.call(t.nodes||t):[t]:[]},_array:function(t){if(t===void 0)return[];if(t instanceof NodeList){for(var e=[],i=0;i<t.length;i++)e[i]=t[i];return e}return t instanceof u?t.nodes:t},_object:function(t){return t=t.replace(/(\w+:)|(\w+ :)/g,function(e){return'"'+e.substring(0,e.length-1)+'":'}),JSON.parse(t)},_params:function(t){var e="";return Object.keys(t).forEach((function(i){e+="&"+this._encodeUri(i)+"="+this._encodeUri(t[i])}).bind(this)),e.replace(/^&/,"")},_boolean:function(t){return t==="true"||t!=="false"&&t},_number:function(t){return!isNaN(t)&&!isNaN(parseFloat(t))},_inject:function(t,e){for(var i=this.nodes.length,s=[];i--;){var n=typeof t=="function"?t.call(this,this.nodes[i]):t,n=i===0?n:this._clone(n),n=e.call(this,n,this.nodes[i]);n&&(n.dom?s.push(n.get()):s.push(n))}return new u(s)},_clone:function(t){if(t!==void 0)return typeof t=="string"?t:t instanceof Node||t.nodeType?t.cloneNode(!0):"length"in t?[].map.call(this._array(t),function(e){return e.cloneNode(!0)}):void 0},_cloneEvents:function(t,e){var i=t._e;if(i){for(var s in(e._e=i)._events)if(i._events.hasOwnProperty(s))for(var n=0;n<i._events[s].length;n++)e.addEventListener(s,i._events[s][n])}return e},_trigger:function(t){var e=this.get();return e&&e.nodeType!==3&&e[t](),this},_encodeUri:function(t){return encodeURIComponent(t).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A").replace(/%20/g,"+")},_getSize:function(t,e){var i=this.get(),s=0,s=i.nodeType===3?0:i.nodeType===9?this._getDocSize(i,e):this._isWindowNode(i)?window["inner"+e]:this._getHeightOrWidth(t);return Math.round(s)},_getDocSize:function(s,e){var i=s.body,s=s.documentElement;return Math.max(i["scroll"+e],i["offset"+e],s["client"+e],s["scroll"+e],s["offset"+e])},_getPos:function(t){var e,i=this.get(),s={top:0,left:0};return i.nodeType===3||this._isWindowNode(i)||i.nodeType===9?s:t==="position"?{top:i.offsetTop,left:i.offsetLeft}:t==="offset"?(t=i.getBoundingClientRect(),e=(i=i.ownerDocument).documentElement,i=i.defaultView,{top:t.top+i.pageYOffset-e.clientTop,left:t.left+i.pageXOffset-e.clientLeft}):s},_getHeightOrWidth:function(n,a){var i,s,n=n.charAt(0).toUpperCase()+n.slice(1),a=a||"offset",o=0,r=this.get(),p=getComputedStyle(r,null),d=this.parents().filter(function(m){return m=m.get(),m.nodeType===1&&getComputedStyle(m,null).display==="none"&&m});return p.display==="none"&&d.add(r),d.length!==0?(i="visibility: hidden !important; display: block !important;",s=[],d.each(function(m){var y=m.attr("style");y!==null&&s.push(y),m.attr("style",y!==null?y+";"+i:i)}),o=r[a+n],d.each(function(m,y){s[y]===void 0?m.removeAttr("style"):m.attr("style",s[y])})):o=r[a+n],o},_eachClass:function(t,e){return this.each(function(i){var s;t&&(s=i.get(),t.split(" ").forEach(function(n){s.classList&&s.classList[e](n)}))})},_getOneHandler:function(t,e){var i=this;return function(){t.apply(this,arguments),i.off(e)}},_getEventNamespace:function(e){var e=e.split("."),i=e[1]||"_events";return e[2]?i+e[2]:i},_getEventName:function(t){return t.split(".")[0]},_offEvent:function(t,e,i,s,n){for(var a in t._e)if(t._e.hasOwnProperty(a)){for(var o in t._e[a])if(n(o,a,e,i))for(var r=t._e[a][o],p=0;p<r.length;p++)s!==void 0&&r[p].toString()!==s.toString()||(t.removeEventListener(o,r[p]),t._e[a][o].splice(p,1),t._e[a][o].length===0&&delete t._e[a][o],Object.keys(t._e[a]).length===0&&delete t._e[a])}},_hasDisplayNone:function(t){return t.style.display==="none"||(t.currentStyle||getComputedStyle(t,null)).display==="none"},_anim:function(t,e,i){return t=typeof t=="function"?(e=t,i):t||i,{fn:e,speed:t/1e3}},_isWindowNode:function(t){return t===window||t.parent&&t.parent===window}},0),c=l,C=(c.dom=function(t,e){return new u(t,e)},c.ajax=h,c.instances=[],c.namespace="redactorx",c.prefix="rx",c.version="1.4.2",c.settings={},c.lang={},c._mixins={},c._repository={},c._subscribe={},c.keycodes={BACKSPACE:8,DELETE:46,UP:38,DOWN:40,ENTER:13,SPACE:32,ESC:27,TAB:9,CTRL:17,META:91,SHIFT:16,ALT:18,RIGHT:39,LEFT:37},c.add=function(t,e,i){var s;if(i.translations&&(c.lang=c.extend(!0,c.lang,i.translations)),i.defaults&&((s={})[e]=i.defaults,c.opts=c.extend(!0,c.opts,s)),t==="mixin")c._mixins[e]=i;else{let d=function(){};if(i.subscribe){for(var n in i.subscribe)if(i.subscribe.hasOwnProperty(n))for(var a=n.split(","),o=0;o<a.length;o++){var r=a[o].trim();c._subscribe[r]===void 0&&(c._subscribe[r]=[]),c._subscribe[r].push({module:e,func:i.subscribe[n]})}}if((d.prototype=i).mixins)for(var p=0;p<i.mixins.length;p++)c.inherit(d,c._mixins[i.mixins[p]]);c._repository[e]={type:t,proto:d,obj:i}}},c.extend=function(){var t={},e=!1,i=0,s=arguments.length;for(Object.prototype.toString.call(arguments[0])==="[object Boolean]"&&(e=arguments[0],i++);i<s;i++){n=void 0;var n,a=arguments[i];for(n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e&&Object.prototype.toString.call(a[n])==="[object Object]"?t[n]=c.extend(!0,t[n],a[n]):t[n]=a[n])}return t},c.error=function(t){throw t},c.inherit=function(t,e){function i(){}i.prototype=e;var s,n=new i;for(s in t.prototype)t.prototype.__lookupGetter__(s)?n.__defineGetter__(s,t.prototype.__lookupGetter__(s)):n[s]=t.prototype[s];return t.prototype=n,t.prototype.super=e,t},c.addLang=function(t,e){c.lang[t]===void 0&&(c.lang[t]={}),c.lang[t]=c.extend(!0,c.lang[t],e)},l.opts={plugins:[],content:!1,placeholder:!1,classes:!1,draggable:!1,editor:{classname:"content",focus:!1,sync:!0,drop:!0,lang:"en",add:"top",https:!1,enterKey:!0,scrollTarget:window,direction:"ltr",spellcheck:!0,grammarly:!1,notranslate:!1,reloadmarker:!0,minHeight:"40px",maxHeight:!1},codemirrorSrc:!1,codemirror:!1,source:!0,autosave:{url:!1,name:!1,data:!1,method:"post"},state:{limit:100},clean:{comments:!1,enter:!0,enterinline:!1},tab:{key:!0,spaces:!1},link:{size:30,nofollow:!1,target:!1},tooltip:{context:!0},topbar:!0,context:!1,control:!1,reorder:!1,buttons:{addbar:["paragraph","image","embed","table","quote","pre","line"],context:["bold","italic","deleted","code","link"],topbar:["shortcut"],editor:["add","html","format"],toolbar:!1,tags:{b:["bold"],strong:["bold"],i:["italic"],em:["italic"],del:["deleted"],u:["underline"],a:["link"]},types:!1,icons:!1,hidden:{}},addbar:{add:{},hide:[]},toolbar:{hide:[],sticky:!0,stickyMinHeight:200,stickyTopOffset:0},paste:{clean:!0,autoparse:!0,paragraphize:!0,plaintext:!1,linkTarget:!1,images:!0,links:!0,keepClass:[],keepStyle:[],keepAttrs:["td","th"],formTags:["form","input","button","select","textarea","legend","fieldset"],blockTags:["pre","h1","h2","h3","h4","h5","h6","table","tbody","thead","tfoot","th","tr","td","ul","ol","li","blockquote","p","hr","figure","iframe","figcaption","address"],inlineTags:["a","svg","img","br","strong","ins","code","del","span","samp","kbd","sup","sub","mark","var","cite","small","b","u","em","i","abbr"]},image:{states:!0,upload:!1,url:!0,select:!1,name:"file",data:!1,drop:!0,multiple:!0,clipboard:!0,types:["image/*"],tag:"figure",newtab:!1,link:!0,width:!1},noneditable:{classname:"noneditable"},embed:{responsive:"embed-responsive",script:!0,checkbox:!0},pre:{template:"<pre></pre>",spaces:4},line:!0,table:{template:"<table><tr><td></td><td></td></tr><tr><td></td><td></td></tr></table>",nowrap:"nowrap"},quote:{template:"<blockquote><p>Quote...</p><p><cite>Author Attribution</cite></p></blockquote>"},format:["p","h1","h2","h3","ul","ol"],formatAdd:!1,shortcutsRemove:!1,shortcutsBase:{"meta+z":"## shortcuts.meta-z ##","meta+shift+z":"## shortcuts.meta-shift-z ##","meta+a":"## shortcuts.meta-a ##"},shortcuts:{"ctrl+shift+o, meta+shift+o":{title:"## shortcuts.meta-shift-o ##",name:"meta+shift+o",command:"addbar.popup"},"ctrl+shift+d, meta+shift+d":{title:"## shortcuts.meta-shift-d ##",name:"meta+shift+d",command:"block.duplicate"},"ctrl+shift+up, meta+shift+up":{title:"## shortcuts.meta-shift-up ##",name:"meta+shift+&uarr;",command:"block.moveUp"},"ctrl+shift+down, meta+shift+down":{title:"## shortcuts.meta-shift-down ##",name:"meta+shift+&darr;",command:"block.moveDown"},"ctrl+shift+m, meta+shift+m":{title:"## shortcuts.meta-shift-m ##",name:"meta+shift+m",command:"inline.removeFormat"},"ctrl+b, meta+b":{title:"## shortcuts.meta-b ##",name:"meta+b",command:"inline.set",params:{tag:"b"}},"ctrl+i, meta+i":{title:"## shortcuts.meta-i ##",name:"meta+i",command:"inline.set",params:{tag:"i"}},"ctrl+u, meta+u":{title:"## shortcuts.meta-u ##",name:"meta+u",command:"inline.set",params:{tag:"u"}},"ctrl+h, meta+h":{title:"## shortcuts.meta-h ##",name:"meta+h",command:"inline.set",params:{tag:"sup"}},"ctrl+l, meta+l":{title:"## shortcuts.meta-l ##",name:"meta+l",command:"inline.set",params:{tag:"sub"}},"ctrl+alt+0, meta+alt+0":{title:"## shortcuts.meta-alt-0 ##",name:"meta+alt+0",command:"block.format",params:{tag:"p"}},"ctrl+alt+1, meta+alt+1":{title:"## shortcuts.meta-alt-1 ##",name:"meta+alt+1",command:"block.format",params:{tag:"h1"}},"ctrl+alt+2, meta+alt+2":{title:"## shortcuts.meta-alt-2 ##",name:"meta+alt+2",command:"block.format",params:{tag:"h2"}},"ctrl+alt+3, meta+alt+3":{title:"## shortcuts.meta-alt-3 ##",name:"meta+alt+3",command:"block.format",params:{tag:"h3"}},"ctrl+alt+4, meta+alt+4":{title:"## shortcuts.meta-alt-4 ##",name:"meta+alt+4",command:"block.format",params:{tag:"h4"}},"ctrl+alt+5, meta+alt+5":{title:"## shortcuts.meta-alt-5 ##",name:"meta+alt+5",command:"block.format",params:{tag:"h5"}},"ctrl+alt+6, meta+alt+6":{title:"## shortcuts.meta-alt-6 ##",name:"meta+alt+6",command:"block.format",params:{tag:"h6"}},"ctrl+shift+7, meta+shift+7":{title:"## shortcuts.meta-shift-7 ##",name:"meta+shift+7",command:"block.format",params:{tag:"ol"}},"ctrl+shift+8, meta+shift+8":{title:"## shortcuts.meta-shift-8 ##",name:"meta+shift+8",command:"block.format",params:{tag:"ul"}},"ctrl+], meta+]":{title:"## shortcuts.meta-indent ##",name:"meta+]",command:"list.indent"},"ctrl+[, meta+[":{title:"## shortcuts.meta-outdent ##",name:"meta+[",command:"list.outdent"},"ctrl+k, meta+k":{title:"## shortcuts.meta-k ##",name:"meta+k",command:"link.format"}},paddingControl:"24px 26px",paddingNormal:"20px",buttonsObj:{add:{title:"## buttons.add ##",command:"addbar.popup"},html:{title:"## buttons.html ##",command:"source.toggle"},format:{title:"## buttons.format ##",command:"format.popup"},duplicate:{title:"## buttons.duplicate ##",command:"block.duplicate"},trash:{title:"## buttons.delete ##",command:"block.remove"},undo:{title:"## buttons.undo ##",command:"state.undo"},redo:{title:"## buttons.redo ##",command:"state.redo"},shortcut:{title:"## buttons.shortcuts ##",command:"shortcut.popup"},bold:{title:"## buttons.bold ##",command:"inline.set",params:{tag:"b"}},italic:{title:"## buttons.italic ##",command:"inline.set",params:{tag:"i"}},deleted:{title:"## buttons.deleted ##",command:"inline.set",params:{tag:"del"}},code:{title:"## buttons.code ##",command:"inline.set",params:{tag:"code"}},link:{title:"## buttons.link ##",command:"link.popup"},mark:{title:"## buttons.mark ##",command:"inline.set",params:{tag:"mark"}},sub:{title:"## buttons.subscript ##",command:"inline.set",params:{tag:"sub"}},sup:{title:"## buttons.superscript ##",command:"inline.set",params:{tag:"sup"}},kbd:{title:"## buttons.shortcut ##",command:"inline.set",params:{tag:"kbd"}},paragraph:{title:"## blocks.paragraph ##",command:"block.add",params:{name:"paragraph"}},image:{title:"## blocks.image ##",command:"image.popup",observer:"image.observe"},embed:{title:"## blocks.embed ##",command:"embed.popup",observer:"embed.observe"},"table-tune":{title:"## buttons.column-settings ##",command:"table.cellSetting",icon:"tune"},indent:{title:"## buttons.indent ##",command:"list.indent"},outdent:{title:"## buttons.outdent ##",command:"list.outdent"},line:{title:"## blocks.line ##",command:"block.add",observer:"block.observe",params:{name:"line"}},table:{title:"## blocks.table ##",command:"table.add",observer:"table.observe",params:{name:"table"}},quote:{title:"## blocks.quote ##",command:"block.add",observer:"block.observe",params:{name:"quote"}},pre:{title:"## blocks.pre ##",command:"block.add",observer:"block.observe",params:{name:"pre"}}},formatObj:{p:{title:"## format.p ##",type:"paragraph",shortcut:"Ctrl+Alt+0"},h1:{title:'<span style="font-size: 20px; font-weight: bold;">## format.h1 ##</span>',type:"heading",shortcut:"Ctrl+Alt+1"},h2:{title:'<span style="font-size: 16px; font-weight: bold;">## format.h2 ##</span>',type:"heading",shortcut:"Ctrl+Alt+2"},h3:{title:'<span style="font-weight: bold;">## format.h3 ##</span>',type:"heading",shortcut:"Ctrl+Alt+3"},h4:{title:'<span style="font-weight: bold;">## format.h4 ##</span>',type:"heading",shortcut:"Ctrl+Alt+4"},h5:{title:'<span style="font-weight: bold;">## format.h5 ##</span>',type:"heading",shortcut:"Ctrl+Alt+5"},h6:{title:'<span style="font-weight: bold;">## format.h6 ##</span>',type:"heading",shortcut:"Ctrl+Alt+6"},ol:{title:"1. ## format.ol ##",type:"list",shortcut:"Ctrl+Shift+7"},ul:{title:"&bull; ## format.ul ##",type:"list",shortcut:"Ctrl+Shift+8"},address:{title:"<em>## format.address ##</em>",type:"address"},dl:{title:"## format.dl ##",type:"dlist"}},markerChar:"\uFEFF",containers:{main:["toolbar","editor","source","statusbar"]},tags:{denied:["font","html","head","link","title","body","meta","applet","marquee"],incode:["!DOCTYPE","!doctype","html","head","link","title","body","meta","textarea","style"],form:["form","input","button","select","textarea","legend","fieldset"],inline:["a","svg","span","strong","strike","b","u","em","i","code","del","ins","samp","kbd","sup","sub","mark","var","cite","small","abbr"],block:["pre","hr","ul","ol","li","p","h1","h2","h3","h4","h5","h6","dl","dt","dd","div","table","tbody","thead","tfoot","tr","th","td","blockquote","output","figcaption","figure","address","main","section","header","footer","aside","article","iframe"],parser:["pre","hr","ul","ol","p","h1","h2","h3","h4","h5","h6","table","address","blockquote","figure","iframe","form","dl","div","section","header","footer","article","main","aside"]},bsmodal:!1,regex:{youtube:/^https?\:\/\/(?:www\.youtube(?:\-nocookie)?\.com\/|m\.youtube\.com\/|youtube\.com\/)?(?:ytscreeningroom\?vi?=|youtu\.be\/|vi?\/|user\/.+\/u\/\w{1,2}\/|embed\/|watch\?(?:.*\&)?vi?=|\&vi?=|\?(?:.*\&)?vi?=)([^#\&\?\n\/<>"']*)/gi,vimeo:/(http|https)?:\/\/(?:www.|player.)?vimeo.com\/(?:channels\/(?:\w+\/)?|groups\/(?:[^/]*)\/videos\/|album\/(?:\d+)\/video\/|video\/|)(\d+)(?:\/[a-zA-Z0-9_-]+)?/gi,imageurl:/((https?|www)[^\s]+\.)(jpe?g|png|gif)(\?[^\s-]+)?/gi,url:/https?:\/\/(www\.)?[-a-zA-Z0-9@:%._+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z\u00F0-\u02AF0-9()!@:%_+.~#?&//=]*)/gi,aurl1:/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,aurl2:/(^|[^\/])(www\.[\S]+(\b|$))/gim}},l.lang.en={accessibility:{"help-label":"Rich text editor"},placeholders:{figcaption:"Type caption (optional)"},popup:{back:"Back",link:"Link",add:"Add",image:"Image","add-image":"Add Image"},shortcuts:{"meta-a":"Select all","meta-z":"Undo","meta-shift-z":"Redo","meta-shift-m":"Remove inline format","meta-b":"Bold","meta-i":"Italic","meta-u":"Underline","meta-h":"Superscript","meta-l":"Subscript","meta-k":"Link","meta-alt-0":"Normal text","meta-alt-1":"Heading 1","meta-alt-2":"Heading 2","meta-alt-3":"Heading 3","meta-alt-4":"Heading 4","meta-alt-5":"Heading 5","meta-alt-6":"Heading 6","meta-shift-7":"Ordered List","meta-shift-8":"Unordered List","meta-indent":"Indent","meta-outdent":"Outdent","meta-shift-backspace":"Delete","meta-shift-o":"Add","meta-shift-d":"Duplicate","meta-shift-up":"Move up","meta-shift-down":"Move down"},buttons:{add:"Add",html:"HTML",format:"Format",bold:"Bold",italic:"Italic",deleted:"Deleted",link:"Link",list:"List",image:"Image",indent:"Indent",outdent:"Outdent",embed:"Embed",table:"Table",insert:"Insert",save:"Save",cancel:"Cancel",delete:"Delete",duplicate:"Duplicate",shortcut:"Shortcuts",underline:"Underline",undo:"Undo",redo:"Redo",code:"Code",mark:"Mark",subscript:"Subscript",superscript:"Superscript",kbd:"Shortcut","column-settings":"Column settings"},blocks:{text:"Text",paragraph:"Paragraph",image:"Image",embed:"Embed",line:"Line",table:"Table",quote:"Quote",pre:"Code",address:"Address"},format:{p:"Normal Text",h1:"Heading 1",h2:"Heading 2",h3:"Heading 3",h4:"Heading 4",h5:"Heading 5",h6:"Heading 6",address:"Address",ul:"Unordered List",ol:"Ordered List",dl:"Definition List"},embed:{embed:"Embed",caption:"Caption",description:"Paste any embed/html code or enter the url (vimeo or youtube video only)","responsive-video":"Responsive video"},image:{or:"or","alt-text":"Alt Text",link:"Link",width:"Width",caption:"Caption","link-in-new-tab":"Open link in new tab","url-placeholder":"Paste url of image...","upload-new-placeholder":"Drag to upload a new image<br>or click to select"},link:{link:"Link","edit-link":"Edit Link",unlink:"Unlink","link-in-new-tab":"Open link in new tab",text:"Text",url:"URL"},table:{width:"Width",nowrap:"Nowrap",column:"Column","add-head":"Add head","remove-head":"Remove head","add-row-below":"Add row below","add-row-above":"Add row above","remove-row":"Remove row","add-column-after":"Add column after","add-column-before":"Add column before","remove-column":"Remove column","delete-table":"Delete table"}},function(t,e,i){for(var s=["keycodes","prefix","dom","ajax","_repository","_subscribe"],n=0;n<s.length;n++)this[s[n]]=c[s[n]];this.uuid=i,this.$win=this.dom(window),this.$doc=this.dom(document),this.$body=this.dom("body"),this.$element=t,(this.app=this).initialSettings=e,this._initer=["setting","lang"],this._priority=["container","editor","state","accessibility"],this._plugins=[],this.started=!1,this.start()});C.prototype={start:function(t){!this.isTextarea()||this.isStarted()||(t&&(this.initialSettings=t),this._initCore(),this._plugins=this.setting.get("plugins"),this.broadcast("app.before.start"),this._initModules(),this._initPlugins(),this._startPriority(),this._startModules(),this._startPlugins(),this.started=!0,this.broadcast("app.start"),this._loadModulesAndPlugins())},isStarted:function(){return this.started},isTextarea:function(){return this.$element.get().tagName==="TEXTAREA"},stop:function(){this.isStopped()||(this.broadcast("app.before.stop"),this._stopPlugins(),this._stopPriority(),this._stopModules(),this.started=!1,this.broadcast("app.stop"))},isStopped:function(){return!this.started},destroy:function(){clearTimeout(this.app.sync.typingTimer),this.stop(),this.broadcast("app.destroy"),this.$element.dataset(c.namespace,!1);var t=c.instances.indexOf(this.uuid);-1<t&&c.instances.splice(t,1)},broadcast:function(t,e){var i=e instanceof C.Event?e:new C.Event(t,e);if(this._subscribe[t]!==void 0)for(var s=this._subscribe[t],n=0;n<s.length;n++){var a=this[s[n].module];a&&s[n].func.call(a,i)}return e=this.setting.has("subscribe")?this.setting.get("subscribe"):{},typeof e[t]=="function"&&e[t].call(this,i),i},broadcastParams:function(t,e){return this.broadcast(t,e).getAll()},broadcastHtml:function(t,e){return this.broadcast(t,{html:e}).get("html")},create:function(t){this._repository[t]===void 0&&c.error('The class "'+t+'" does not exist.');for(var e,i=[].slice.call(arguments,1),s=new this._repository[t].proto,n=(s._name=t,s.app=this,["uuid","prefix","dom","ajax"]),a=0;a<n.length;a++)s[n[a]]=this[n[a]];return this.lang&&(s.lang=this.lang),this.opts&&(s.opts=this.opts),(e=s.init?s.init.apply(s,i):e)||s},api:function(t){for(var e=[].slice.call(arguments,1),i=t.split("."),s=i.pop(),n=this,a=0;a<i.length;a++)n=n[i[a]];if(n&&typeof n[s]=="function")return n[s].apply(n,e)},_initCore:function(){for(var t=0;t<this._initer.length;t++)this[this._initer[t]]=this.create(this._initer[t]);this.setting&&(this.opts=this.setting.dump())},_initModules:function(){for(var t in this._repository)this._repository[t].type==="module"&&this._initer.indexOf(t)===-1&&(this[t]=this.create(t))},_initPlugins:function(){var t,e=this.setting.get("plugins");for(t in this._repository)this._repository[t].type==="plugin"&&e.indexOf(t)!==-1&&(this[t]=this.create(t))},_startPriority:function(){for(var t=0;t<this._priority.length;t++)this._call(this[this._priority[t]],"start")},_startModules:function(){this._iterate("module","start")},_startPlugins:function(){this._iterate("plugin","start")},_stopPriority:function(){for(var t=this._priority.slice().reverse(),e=0;e<t.length;e++)this._call(this[t[e]],"stop")},_stopModules:function(){this._iterate("module","stop")},_stopPlugins:function(){this._iterate("plugin","stop")},_loadModulesAndPlugins:function(){this._iterate("module","load"),this._iterate("plugin","load")},_iterate:function(t,e){for(var i in this._repository){var s;this._repository.hasOwnProperty(i)&&(s=t==="module"?e==="load"||this._priority.indexOf(i)===-1:this._plugins.indexOf(i)!==-1,this._repository[i].type===t)&&s&&this._call(this[i],e)}},_call:function(t,e){typeof t[e]=="function"&&t[e].apply(t)}},C.Event=function(t,e){this.name=t,this.params=e===void 0?{}:e,this.stopped=!1},C.Event.prototype={is:function(t){if(!Array.isArray(t))return this.get(t);for(var e=0;e<t.length;e++)if(this.params[t[e]])return!0},has:function(t){return this.params[t]!==void 0},getAll:function(){return this.params},get:function(t){return this.params[t]},set:function(t,e){this.params[t]=e},stop:function(){this.stopped=!0},isStopped:function(){return this.stopped}},l.add("mixin","block",{defaults:{id:{getter:"getId",setter:"setId"},html:{getter:"getHtml",setter:"setHtml"}},init:function(t,e){this.$block=t?this.dom(t):this.create(e),this._build(e),this._buildData(),this._render()},isType:function(t){return(Array.isArray(t)?t:[t]).indexOf(this.type)!==-1},isBlock:function(){return!0},isEditable:function(){return this.editable!==void 0&&this.editable===!0},isFigcaption:function(){return this.type==="figcaption"},isSecondLevel:function(){return["quoteitem","row","cell"].indexOf(this.type)!==-1},isNested:function(){return["quote","table"].indexOf(this.type)!==-1},isFirstLevel:function(){return this.$block.attr("data-"+this.prefix+"-first-level")},isAllSelected:function(){return!this.isEditable()||this.app.selection.isAll(this.$block)},isEmpty:function(t){var e=this.$block.text(),e=this._cleanEmpty(e);return(e=t?e.trim():e)===""},isCaretStart:function(){var t;return this.getType()==="pre"?this.app.caret.is(this.$block,"start",!1,!1):this.getType()==="list"?(t=this.app.selection.getCurrent(),this.dom(t).closest("li").prev().length===0&&this.app.caret.is(this.$block,"start")):!this.isEditable()||this.app.caret.is(this.$block,"start")},isCaretEnd:function(){return this.getType()==="pre"?this.app.caret.is(this.$block,"end",!1,!1):this.getType()==="address"?this.app.caret.is(this.$block,"end",!1,!0,!1):!this.isEditable()||this.app.caret.is(this.$block,"end")},isAllowedButton:function(t,e){var i=this.getType();if(this.opts.buttons.hidden[i]!==void 0){var s=this.opts.buttons.hidden[i];if(Array.isArray(s)&&s.indexOf(t)!==-1)return!1}return e.blocks===void 0?!0:(s=e.blocks,s.except&&s.except.indexOf(i)!==-1?!1:s.all&&(s.all===!0||s.all==="all"||s.all==="editable"&&["heading","paragraph","list","address","quote","table"].indexOf(i)!==-1||s.all==="first-level"&&this.isFirstLevel()||s.all==="noneditable"&&["image","embed","layer","line"].indexOf(i)!==-1)?!0:!(!Array.isArray(s.types)||s.types.indexOf(i)===-1))},getData:function(t){var e={};return Object.keys(this.data).forEach((function(i){e[i]=this[this.data[i].getter].apply(this)}).bind(this)),t?e[t]:e},getOffset:function(){return this.$block.offset()},getType:function(){return this.type},getTag:function(){return!!this.$block&&this.$block.get().tagName.toLowerCase()},getBlock:function(){return this.$block},getHtml:function(){return this.$block.html()},getPlainText:function(){var t=this.$block.html();return this.app.content.getTextFromHtml(t,{nl:!0})},getOuterHtml:function(){return this.$block.get().outerHTML},getFirstLevel:function(){var t=this.$block.closest("[data-"+this.prefix+"-first-level]");return t.length!==0&&t.dataget("instance")},getParent:function(t){return t=t?"="+t:"",t=this.$block.parent().closest("[data-"+this.prefix+"-type"+t+"]"),t.length!==0&&t.dataget("instance")},getNext:function(t){t=t?"="+t:"";var e=this.$block.nextElement();return!(e.length===0||!e.is("[data-"+this.prefix+"-type"+t+"]"))&&e.dataget("instance")},getPrev:function(t){t=t?"="+t:"";var e=this.$block.prevElement();return!(e.length===0||!e.is("[data-"+this.prefix+"-type"+t+"]"))&&e.dataget("instance")},getChildFirst:function(t){return t=this.$block.find("[data-"+this.prefix+"-type"+(t=t?"="+t:"")+"]").first(),t.length!==0&&t.dataget("instance")},getChildLast:function(t){return t=this.$block.find("[data-"+this.prefix+"-type"+(t=t?"="+t:"")+"]").last(),t.length!==0&&t.dataget("instance")},getId:function(){return this.$block.attr("id")},getCaption:function(){var t=this.$block.find("figcaption");return t.length!==0?t.html().trim():""},setData:function(t){for(var e in t)this.data[e]&&this[this.data[e].setter].call(this,t[e])},setEmpty:function(){this.$block.html("")},setSelectAll:function(){this.isEditable()&&this.app.selection.select(this.$block)},setHtml:function(t){this.$block.html(t)},setId:function(t){t===""?this.$block.removeAttr("id"):this.$block.attr("id",t)},setCaption:function(t){var e;t===""?this.$block.find("figcaption").remove():((e=this.$block.find("figcaption")).length===0&&((e=this.dom("<figcaption>")).attr("data-placeholder",this.lang.get("placeholders.figcaption")),this.$block.append(e),this.app.create("block.figcaption",e)),e.html(t))},setClassFromObj:function(t,e){this._removeObjClasses(t),t=t[e],t==="none"&&t===!1||this.$block.addClass(t)},setCaret:function(t){this.app.caret.set(this.$block,t)},moveUp:function(){var t=this.getPrev();t&&this._move(t,"before")},moveDown:function(){var t=this.getNext();t&&this._move(t,"after")},remove:function(t){var e=this.getType();this.$block.remove(),t&&this.app.broadcast("block.remove",{type:e})},appendNext:function(){var t,e,i,s,n,a=this.getNext();a.isEmpty()?a.remove():this.isEmpty()?(this.remove(),this.app.block.set(a,"start")):(t=a.getHtml(),n=this.getType(),i=a.getType(),s=e=!0,n==="pre"&&i!=="pre"&&(t=a.getPlainText()),i==="list"&&(s=n==="list"?(i=a.getBlock().children(),this.$block.append(i),!(e=!1)):(t=this._appendListHtml(a.getBlock(),t),a.isEmpty())),e&&((n=this.app.selection.getTopInline())&&this.app.caret.set(n,"after"),this.app.insertion.insertHtml(t,"start")),s&&a.remove())},appendToPrev:function(){var t,e,i,s,n,a=this.getPrev();this.isEmpty()?(this.remove(),this.app.block.set(a,"end")):a.isEmpty()?a.remove():(n=a.getType(),t=this.getHtml(),s=e=!0,(i=this.getType())!=="pre"&&n==="pre"&&(t=this.getPlainText()),i==="list"&&(s=n==="list"?(i=this.getBlock().children(),this.app.block.set(a,"end"),a.getBlock().append(i),!(e=!1)):(t=this._appendListHtml(this.getBlock(),t),this.isEmpty())),e&&(this.app.block.set(a,"end"),(n=this.app.selection.getTopInline())&&this.app.caret.set(n,"after"),this.app.insertion.insertHtml(t,"start")),s&&this.remove())},insertEmpty:function(t){return(t=t||{}).instance=this.app.block.create(),this.insert(t)},insert:function(e){var e=c.extend({},{instance:!1,position:"after",caret:!1,remove:!0,type:"input"},e),i=e.instance.getBlock();return e.instance.getType()==="list"&&this.getType()==="list"?this.app.insertion.insertListToList(i,this.$block,e.caret):(e.position==="split"?this.app.element.split(this.$block).before(i):this.$block[e.position](i),e.remove&&this.isEditable()&&this.isEmpty()&&this.remove()),this.app.editor.build(),e.caret&&this.app.block.set(e.instance,e.caret),this.app.toolbar.observe(),this.app.context.observe(),this.app.broadcast("block.add",{instance:e.instance,type:e.type}),e.instance},change:function(t,e){var i=t.getBlock();this.$block.after(i),this.$block.remove(),this.app.editor.build(),this.app.block.set(t),e!==!1&&this.app.broadcast("block.change",{instance:t})},duplicate:function(t){var e=this.getType(),i=this.$block.clone();return i.removeClass(this.prefix+"-block-focus"),t&&i.html(""),this.app.create("block."+e,i)},duplicateEmpty:function(){return this.duplicate(!0)},_build:function(t){this.build&&this.build(t)},_buildData:function(){this.data||(this.data={}),this.data=c.extend({},!0,this.defaults,this.data)},_buildItems:function(t,e){t=this.$block.find(t),t.length!==0&&t.each((function(i){this.app.create("block."+e,i)}).bind(this))},_buildCaption:function(){this.getTag()==="figure"&&this.$block.find("figcaption").attr("data-placeholder",this.lang.get("placeholders.figcaption"))},_render:function(){this._renderEdit()},_renderEdit:function(){this.$block.dataset("instance",this),this.$block.attr("data-"+this.prefix+"-type",this.getType()),this.editable!==void 0&&this.editable===!1?this.$block.attr("contenteditable",!1):this.type==="figcaption"&&this.$block.attr("contenteditable",!0)},_cleanEmpty:function(t){return t=(t=(t=this.app.utils.removeInvisibleChars(t)).search(/^<br\s?\/?>$/)!==-1?"":t).replace(/\n/g,"")},_appendListHtml:function(t,e){return t=t.find("li").first(),e=(e=(e=t.html().trim()).replace(/<\/li>/gi,"</li><br>")).replace(/<(ul|ol)/gi,"<br><$1"),e=(e=(e=this.app.content.removeTags(e,["ul","ol","li"])).trim()).replace(/<br\s?\/?>$/gi,""),t.remove(),e},_move:function(t,e){var i=this;i.isNested()&&(i=i.getFirst()),(this.isEditable()||this.isNested())&&this.app.selection.save(i.getBlock()),t.getBlock()[e](this.$block),this.app.block.set(i,!1,!0),(this.isEditable()||this.isNested())&&this.app.selection.restore(!1)},_removeObjClasses:function(t){t=this._buildObjClasses(t),this.$block.removeClass(t.join(" ")),this.app.element.removeEmptyAttrs(this.$block,["class"])},_buildObjClasses:function(t){var e,i=[];for(e in t)t[e]&&i.push(t[e]);return i}}),l.add("mixin","tool",{init:function(t,e,i,s){this.name=t,this.setter=i.get("setter"),this.popup=i,this.data=s,this.obj=this._observe(e),this.obj&&this._build()},getElement:function(){return this.$tool},getInput:function(){return this.$input},getValue:function(){return this.$input.val().trim()},setValue:function(t){this.$input.val(t)},setFocus:function(){this.$input.focus()},trigger:function(t){this.setValue(t),this.setter&&this.app.api(this.setter,this.popup)},_build:function(){this._buildTool(),this._buildLabel(),this._buildInputElement(),this._buildInput(),this._buildEvent(),this._has("placeholder")&&this.$input.attr("placeholder",this.lang.parse(this.obj.placeholder)),this._has("width")&&this.$input.css("width",this.obj.width),this._has("classname")&&this.$input.addClass(this.obj.classname)},_buildInputElement:function(){this.$input=this.dom("<"+this._getInputParam("tag")+">").addClass(this.prefix+this._getInputParam("classname")),this.$input.attr({name:this.name,type:this._getInputParam("type"),"data-type":this.type}),this.$input.dataset("instance",this)},_buildInput:function(){},_buildEvent:function(){var t;["segment"].indexOf(this.type)===-1&&this.setter&&(t=this.type==="checkbox"||this.type==="select"?"change":"keydown blur",t=this.type==="number"?t+" change":t,this.$input.on(t,this._catchSetter.bind(this)))},_buildTool:function(){this.$tool=this.dom("<div>").addClass(this.prefix+"-form-item").dataset("instance",this)},_buildLabel:function(){this.type!=="checkbox"&&this._has("label")&&(this.$label=this.dom("<label>").addClass(this.prefix+"-form-label").html(this.lang.parse(this.obj.label)),this.$tool.append(this.$label))},_getInputParam:function(t){return this.input&&this.input[t]!==void 0?this.input[t]:""},_get:function(t){return this.obj[t]},_has:function(t){return Object.prototype.hasOwnProperty.call(this.obj,t)},_observe:function(t){return t=Object.prototype.hasOwnProperty.call(t,"observer")?this.app.api(t.observer,t,this.name):t},_catchSetter:function(t){t.type==="keydown"&&t.which!==13||(t.type==="keydown"&&t.preventDefault(),this.app.api(this.setter,this.popup))}}),l.add("module","accessibility",{start:function(){this._buildRole(),this._buildLabel()},_buildRole:function(){this.app.editor.getEditor().attr({"aria-labelledby":this.prefix+"-voice",role:"presentation"})},_buildLabel:function(){var t=this.lang.get("accessibility.help-label"),t=this._createLabel(t);this.app.container.get("main").prepend(t)},_createLabel:function(t){var e=this.dom("<span />").addClass(this.prefix+"-voice-label");return e.attr({id:this.prefix+"-voice-"+this.uuid,"aria-hidden":!1}),e.html(t),e}}),l.add("module","lang",{init:function(){this.langKey=this.app.setting.get("editor.lang"),this.vars=this._build()},get:function(t){var e=this._get(t,this.vars);return(e=e===void 0&&this.langKey!=="en"?this._get(t,c.lang.en):e)===void 0?"":e},parse:function(t){if(typeof t=="string"){var e=t.match(/## (.*?) ##/g);if(e)for(var i=0;i<e.length;i++){var s=e[i].replace(/^##\s/g,"").replace(/\s##$/g,"");t=t.replace(e[i],this.get(s))}}return t},_get:function(s,e){var i=s.split("."),s=i.length===1?e[s]:e[i[0]]!==void 0?e[i[0]][i[1]]:void 0;return s},_build:function(){var t=c.lang.en;return t=this.langKey!=="en"&&c.lang[this.langKey]!=="undefined"?c.lang[this.langKey]:t}}),l.add("module","setting",{init:function(){this.opts=this._build()},dump:function(){return this.opts},has:function(i){var e=i.split("."),i=e.length===1?this.opts[i]!==void 0:this.opts[e[0]]!==void 0&&this.opts[e[1]]!==void 0;return i},set:function(t,e,i){this.opts[t]===void 0&&(this.opts[t]={}),i===void 0?this.opts[t]=e:this.opts[t][e]=i},get:function(i){var e=i.split("."),i=e.length===1?this.opts[i]:this.opts[e[0]]!==void 0?this.opts[e[0]][e[1]]:void 0;return i},_build:function(){var t=c.extend(!0,{},c.opts,this.app.initialSettings);return c.extend(!0,t,c.settings)}}),l.add("module","element",{is:function(n,e,i){var s=!1,n=e==="text"?n:this._getNode(n);return e==="inline"?s=this._isElement(n)&&this._isInlineTag(n.tagName,i):e==="blocks"?s=this._isElement(n)&&n.hasAttribute("data-"+this.prefix+"-type"):e==="blocks-first"?s=this._isElement(n)&&n.hasAttribute("data-"+this.prefix+"-first-level"):e==="block"?s=this._isElement(n)&&this._isBlockTag(n.tagName,i):e==="element"?s=this._isElement(n):e==="text"?s=typeof n=="string"&&!/^\s*<(\w+|!)[^>]*>/.test(n)||this.isTextNode(n):e==="list"?s=this._isElement(n)&&["ul","ol"].indexOf(n.tagName.toLowerCase())!==-1:e==="heading"&&(s=this._isElement(n)&&["h1","h2","h3","h4","h5","h6"].indexOf(n.tagName.toLowerCase())!==-1),s},isEmptyOrImageInline:function(n){var e,i,s,n=this.dom(n).get();return!!(n&&n.nodeType!==3&&(e=n.tagName.toLowerCase(),i=n.getAttribute("contenteditable")==="false",(s=this.is(n,"inline"))&&this.isEmpty(n)||s&&i||["svg","img"].indexOf(e)!==-1))},isEmpty:function(t){return t=this._getNode(t),!!t&&(t.nodeType===3?t.textContent.trim().replace(/\n/,"")==="":t.innerHTML==="")},isTag:function(t,e){return this._getNode(t).tagName.toLowerCase()===e},isTextNode:function(t){return t=this._getNode(t),t&&t.nodeType&&t.nodeType===3},isVisible:function(t){return t=this._getNode(t),!!(t.offsetWidth||t.offsetHeight||t.getClientRects().length)},isScrollVisible:function(e){var i=this.app.scroll.getTarget(),e=this.dom(e),i=i.scrollTop()+i.height();return e.offset().top<=i},getFirstLevel:function(t){return this.dom(t).closest("[data-"+this.prefix+"-first-level]")},getDataBlock:function(t){return this.dom(t).closest("[data-"+this.prefix+"-type]")},getType:function(t){return this.dom(t).attr("data-"+this.prefix+"-type")},getAllInlines:function(t){for(var e=[],i=t;i;)this.is(i,"inline")&&e.push(i),i=i.parentNode;return e},getClosest:function(t,e){return this.dom(t).closest(this.getTypesSelector(e))},getParents:function(t,e){return this.dom(t).parents(this.getTypesSelector(e))},getChildren:function(t,e){return this.dom(t).find(this.getTypesSelector(e))},getTypesSelector:function(t){return"[data-"+this.prefix+"-type="+t.join("],[data-"+this.prefix+"-type=")+"]"},hasClass:function(t,e){e=typeof e=="string"?[e]:e;for(var i=this.dom(t),s=e.length,n=0,a=0;a<s;a++)i.hasClass(e[a])&&n++;return s===n},scrollTo:function(t,e){var i,s;this.isScrollVisible(t)||(e=e||60,t=t.offset(),i=this.app.scroll.getTarget(),s=t.top-e,i.scrollTop(s),setTimeout(function(){i.scrollTop(s)},1))},replaceToTag:function(t,e,i){return this.dom(t).replaceWith((function(s){var n=this.dom("<"+e+">");if(i||n.append(s.innerHTML),s.attributes)for(var a=s.attributes,o=0;o<a.length;o++)n.attr(a[o].nodeName,a[o].value);if(i)for(;0<s.childNodes.length;)n.append(this.dom(s.firstChild));return n}).bind(this))},split:function(s){var e=this.dom(s),i=(s=e.get()).tagName.toLowerCase(),n=this.app.content.extractHtmlFromCaret(s),i=(n.nodeType&&n.nodeType===11&&(n=this.dom(n.childNodes)),this.dom("<"+i+" />")),s=((i=this.cloneAttrs(s,i)).append(n),e.after(i),e.children().last()),n=(this.is(s,"inline")&&(n=s.html(),(n=this.app.utils.removeInvisibleChars(n))==="")&&s.remove(),this.getType(i));return n&&this.app.create("block."+n,i,!0),e.html()===""&&e.remove(),i},cloneEmpty:function(t){return t=this.dom(t).get().tagName.toLowerCase(),this.dom("<"+t+">")},cloneAttrs:function(t,e){for(var i=this.dom(e),s=this._getNode(t).attributes,n=s.length;n--;){var a=s[n];i.attr(a.name,a.value)}return i},getAttrs:function(t){var e=this._getNode(t),i={};if(e.attributes!=null&&e.attributes.length)for(var s=0;s<e.attributes.length;s++){var n=e.attributes[s].nodeValue,n=this._isNumber(n)?parseFloat(n):this._getBooleanFromStr(n);i[e.attributes[s].nodeName]=n}return i},removeEmptyAttrs:function(i,s){var i=this.dom(i),s=s.join(" "),n=!1;return i.attr(s)===void 0||i.attr(s)===null?n=!0:i.attr(s)===""&&(i.removeAttr(s),n=!0),n},getBlocks:function(t,e,i){var s=this._getNode(t).childNodes,n=[],a=e||this.opts.tags.parser;i&&(a=this.app.utils.extendArray(a,i));for(var o=0;o<s.length;o++)s[o].nodeType===1&&a.indexOf(s[o].tagName.toLowerCase())!==-1&&n.push(s[o]);return n},hasBlocks:function(t){return this.getBlocks(t).length!==0},hasTextSiblings:function(i){var i=this._getNode(i),e=i.previousSibling&&i.previousSibling.nodeType===3&&!this.isEmpty(i.previousSibling),i=i.nextSibling&&i.nextSibling.nodeType===3&&!this.isEmpty(i.nextSibling);return e||i},_getNode:function(t){return this.dom(t).get()},_getBooleanFromStr:function(t){return t==="true"||t!=="false"&&t},_isBlockTag:function(t,e){return this.app.utils.extendArray(this.opts.tags.block,e).indexOf(t.toLowerCase())!==-1},_isInlineTag:function(t,e){return this.app.utils.extendArray(this.opts.tags.inline,e).indexOf(t.toLowerCase())!==-1},_isElement:function(t){return t&&t.nodeType&&t.nodeType===1},_isTag:function(t){return t!==void 0&&t},_isNumber:function(t){return!isNaN(t)&&!isNaN(parseFloat(t))}}),l.add("module","paragraphizer",{init:function(){this.remStart="#####replace",this.remEnd="#####",this.tags=this.opts.tags.parser.concat(["form","audio","figcaption","object","style","script","iframe","select","input","textarea","button","option","map","area","math","fieldset","legend","hgroup","nav","details","menu","summary"])},paragraphize:function(t){for(var e=[],i=[],s=(t=this._storeTags(t,e),t=(t=this.app.content.storeComments(t,i)).trim(),""),n=(t=(t=(t=(t=(t=(t=this._trimLinks(t)).replace(/xparagraphmarkerz(?:\r\n|\r|\n)$/g,"")).replace(/xparagraphmarkerz$/g,"")).replace(/xparagraphmarkerz(?:\r\n|\r|\n)/g,`
`)).replace(/xparagraphmarkerz/g,`
`)).replace(/[\n]+/g,`
`)).split(`
`),a=0;a<n.length;a++)s+="<p>"+n[a].trim()+`</p>
`;return t=(t=(t=(t=s.replace(/\n$/,"")).replace(new RegExp("<p>\\s+#####","gi"),"#####")).replace(new RegExp("<p>#####","gi"),"#####")).replace(new RegExp("#####</p>","gi"),"#####"),t=this._restoreTags(t,e),t=(t=(t=(t=(t=(t=this.app.content.restoreComments(t,i)).replace(/<(p|h1|h2|h3|h4|h5|h6|li|td|th)(.*?)>[\s\n]*<\/\1>/gi,"<$1$2></$1>")).replace(/<p(.*?)><\/?br\s?\/?><\/p>/gi,"<p$1></p>")).replace(/<div(.*?)><\/?br\s?\/?><\/div>/gi,"<div$1></div>")).replace(/<\/?br\s?\/?><\/div>/gi,"</div>")).replace(/<\/?br\s?\/?><\/li>/gi,"</li>")},_storeTags:function(t,e){return this.app.utils.wrap(t,(function(i){i.find(this.tags.join(", ")).each((function(s,n){this._replaceTag(s,n,e)}).bind(this))}).bind(this))},_restoreTags:function(t,e){for(var i=0;i<e.length;i++){var s=e[i].replace(/\$/gi,"&#36;");t=t.replace(this.remStart+i+this.remEnd,s)}return t},_replaceTag:function(t,e,i){t=t.get(),e=document.createTextNode(this.remStart+e+this.remEnd+"xparagraphmarkerz"),i.push(t.outerHTML),t.parentNode.replaceChild(e,t)},_trimLinks:function(t){return this.app.utils.wrap(t,(function(e){e.find("a").each(this._trimLink.bind(this))}).bind(this))},_trimLink:function(t){t.html(t.html().trim())}}),l.add("module","utils",{isMobile:function(){return"ontouchstart"in document.documentElement},createInvisibleChar:function(){return document.createTextNode(this.opts.markerChar)},searchInvisibleChars:function(t){return t.search(/^\uFEFF$/g)},removeInvisibleChars:function(t){return t.replace(/\uFEFF/g,"")},wrap:function(t,e){var i=this.dom("<div>").html(t);return e(i),t=i.html(),i.remove(),t},extendArray:function(t,e){if(t=t.concat(t),e)for(var i=0;i<e.length;i++)t.push(e[i]);return t},removeFromArrayByValue:function(t,e){var i;e=Array.isArray(e)?e:[e];for(var s=0;s<e.length;s++)-1<(i=t.indexOf(e[s]))&&t.splice(i,1);return t},sumOfArray:function(t){return t.reduce(function(e,i){return parseInt(e)+parseInt(i)},0)},getObjectIndex:function(t,e){return Object.keys(t).indexOf(e)},insertToObject:function(t,e,i,s){return Object.keys(i).reduce(function(n,a,o){return o===s&&(n[t]=e),n[a]=i[a],n},{})},getRandomId:function(){for(var t="",e="abcdefghijklmnopqrstuvwxyz0123456789",i=0;i<12;i++)t+=e.charAt(Math.floor(Math.random()*e.length));return t},escapeRegExp:function(t){return t.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&")},capitalize:function(t){return(t=t.toLowerCase()).charAt(0).toUpperCase()+t.slice(1)},extendData:function(t,e){for(var i in e)t=i==="elements"?this._extendDataElements(t,e[i]):this._setData(t,i,e[i]);return t},_extendDataElements:function(t,e){return this.dom(e).each((function(i){var s,n;i.get().tagName==="FORM"?(s=i.serialize(!0),Object.keys(s).forEach((function(a){t=this._setData(t,a,s[a])}).bind(this))):(n=i.attr("name")?i.attr("name"):i.attr("id"),t=this._setData(t,n,i.val()))}).bind(this)),t},_setData:function(t,e,i){return t instanceof FormData?t.append(e,i):t[e]=i,t}}),l.add("module","scroll",{init:function(){this.scrolltop=!1},save:function(){this.scrolltop=this.getTarget().scrollTop()},restore:function(){this.scrolltop!==!1&&(this.getTarget().scrollTop(this.scrolltop),this.scrolltop=!1)},isTarget:function(){return this.opts.editor.scrollTarget!==window},getTarget:function(){return this.dom(this.opts.editor.scrollTarget)}}),l.add("module","autosave",{send:function(){this.opts.autosave.url&&this._sending()},_getName:function(){var t=this.opts.autosave.name||(t=this.app.$element.attr("name"))||"content"+this.uuid;return t},_sending:function(){var t=this._getName(),e={};e[t]=this.app.$element.val(),e=this.app.utils.extendData(e,this.opts.autosave.data),this.ajax.request(this.opts.autosave.method,{url:this.opts.autosave.url,data:e,before:(function(i){if(this.app.broadcast("autosave.before.send",{xhr:i,name:t,data:e}).isStopped())return!1}).bind(this),success:(function(i){this._complete(i,t,e)}).bind(this)})},_complete:function(t,e,i){var s=t&&t.error?"autosave.error":"autosave.send";this.app.broadcast(s,{name:e,data:i,response:t})}}),l.add("module","progress",{stop:function(){this.hide()},show:function(){this.hide(),this.$progress=this.dom("<div>").addClass(this.prefix+"-editor-progress"),this.$progress.attr("id",this.prefix+"-progress"),this.$progressBar=this.dom("<span>"),this.$progress.append(this.$progressBar),this.app.$body.append(this.$progress)},hide:function(){this.app.$body.find("#"+this.prefix+"-progress").remove()}}),l.add("module","clipboard",{getContent:function(i){var e=this.isPlainText(i)?"text/plain":"text/html",i=i.getData(e);return e=="text/plain"?this.app.content.escapeHtml(i):i},setContent:function(t,e,i){t=t.clipboardData,e=this.app.parser.unparse(e),e='<meta type="'+this.prefix+'-editor"/>'+e,i=i||this.app.content.getTextFromHtml(e,{nl:!0}),t.setData("text/html",e),t.setData("text/plain",i)},isPlainText:function(i){var e=i.getData("text/plain"),i=i.getData("text/html");return(!i||i.trim()==="")&&e!==null}}),l.add("module","fragment",{build:function(t){return this.is(t)?t:this.create(t)},insert:function(t){var e,i=this.app.selection.get();i.range&&(i.collapsed?(e=i.range.startContainer).nodeType!==3&&e.tagName==="BR"&&e.parentNode.removeChild(e):i.range.deleteContents(),t.frag?i.range.insertNode(t.frag):i.range.insertNode(t))},createContainer:function(t){var e=this.dom("<div>");return typeof t=="string"?e.html(t):e.append(this.dom(t).clone(!0)),e.get()},create:function(t){for(var e,i,s=typeof t=="string"?this.createContainer(t):t,n=document.createDocumentFragment(),a=[],o=0;r=s.firstChild;){o++;var r=n.appendChild(r);o===1&&(e=r),a.push(r),i=r}return{frag:n,first:e,last:i,nodes:a}},is:function(t){return typeof t=="object"&&t.frag}}),l.add("module","button",{init:function(t,e,i,s){typeof t=="object"?(this.name=t.name,this.obj=e,this._buildFromElement(t.element)):t&&(this.type=s||!1,this.name=t,s=this._observe(e),this.obj=s===void 0?e:s,this.obj)&&this._build(t,i)},setColor:function(t,e){t=t.getName(),t!=="background"&&t!=="text-color"||this.setBackground(e[t==="background"?"background-color":"color"])},isButton:function(){return!0},isAddbar:function(){return this._has("addbar")},isControl:function(){return this._has("control")},getName:function(){return this.name},getTitle:function(){return this.title},getParams:function(){return!!this._has("params")&&this.obj.params},getOffset:function(){return this.$button.offset()},getDimension:function(){return{width:this.$button.width(),height:this.$button.height()}},getElement:function(){return this.$button},setBackground:function(t){this._background("add",t)},resetBackground:function(){this._background("remove","")},_has:function(t){return Object.prototype.hasOwnProperty.call(this.obj,t)},_observe:function(t){return t=Object.prototype.hasOwnProperty.call(t,"observer")?this.app.api(t.observer,t,this.name):t},_background:function(t,e){this.$icon[t==="remove"?"removeClass":"addClass"](this.prefix+"-button-icon-color").css({"background-color":e,color:e!==""?this.app.color.invert(e):""})},_buildFromElement:function(t){this.$button=this.dom(t),this.$button.addClass(this.prefix+"-button-target"),this._buildData()},_build:function(t,e){this._buildTitle(),this._buildElement(),this._buildIcon(),this._buildData(e)},_buildData:function(t){this.$button.attr({tabindex:"-1","data-name":this.name,"data-command":this.obj.command||!1}),this.$button.dataset("instance",this);var e=this._has("command")?"_catch":"_stop";this.$button.on("click."+this.prefix+"-button",this[e].bind(this)),this.$button.on("dragstart."+this.prefix+"-button",function(i){i.preventDefault()}),t&&(this._buildTooltip(),this._buildBackground(),this._buildPosition(t))},_buildTitle:function(){this.title=this.obj.title!==void 0?this.lang.parse(this.obj.title):""},_buildElement:function(){this.$button=this.dom('<a href="#"></a>'),this.$button.addClass(this.prefix+"-button "+this.prefix+"-button-target"),this.type&&this.$button.addClass(this.prefix+"-button-"+this.type),this._has("classname")&&this.$button.addClass(this.obj.classname)},_buildIcon:function(){var t=this._has("icon"),e='<span class="'+this.prefix+"-icon-"+this.name+'"></span>';this.$icon=this._buildIconElement(),t&&this.obj.icon!==!0&&(e=this.obj.icon.search(/</)!==-1?this.obj.icon:'<span class="'+this.prefix+"-icon-"+this.obj.icon+'"></span>'),this.opts.buttons.icons&&this.opts.buttons.icons[this.name]!==void 0&&(e=this.opts.buttons.icons[this.name]),this.$icon.append(e),this.$button.append(this.$icon)},_buildIconElement:function(){return this.dom("<span>").addClass(this.prefix+"-button-icon")},_buildTooltip:function(){(this.type==="toolbar"||this.type==="context"&&this.opts.tooltip.context)&&this.app.tooltip.build(this.$button,this.title)},_buildBackground:function(){this._has("background")&&this.setBackground(this.obj.background)},_buildPosition:function(t){var e,i;this._has("position")?(e=this.obj.position)==="first"?t.prepend(this.$button):typeof e=="object"&&(i=e[e=Object.prototype.hasOwnProperty.call(e,"after")?"after":"before"],(i=this._findPositionElement(i,t))?i[e](this.$button):t.append(this.$button)):t.append(this.$button)},_findPositionElement:function(t,e){var i;if(Array.isArray(t))for(var s=0;s<t.length&&(i=e.find("[data-name="+t[s]+"]")).length===0;s++);else i=e.find("[data-name="+t+"]");return i.length!==0?i:0},_stop:function(t){t.preventDefault(),t.stopPropagation()},_catch:function(t){t.preventDefault(),t.stopPropagation();var e,i,s=this.dom(t.target).closest("."+this.prefix+"-button-target");s.hasClass("disable")||(this.app.editor.setFocus(),e=s.attr("data-command"),i=s.attr("data-name"),s=s.dataget("instance"),this.app.api(e,this.getParams(),s,i,t),this.app.tooltip.close())}}),l.add("module","tooltip",{init:function(){this.classname=this.prefix+"-tooltip",this.eventname=this.prefix+"-button-"+this.uuid},stop:function(){this.close()},build:function(t,e){(e=this._cleanTitle(e))&&(t.attr("data-tooltip",e),t.on("mouseover."+this.eventname,this.open.bind(this)),t.on("mouseout."+this.eventname,this.close.bind(this)))},open:function(t){t=this._getButton(t),this.app.popup.isOpen()||t.hasClass("disable")||(this.$tooltip=this._create(t),this._setPosition(t),this._fixBSModal(),this.app.$body.append(this.$tooltip))},close:function(){this.app.$body.find("."+this.classname).remove()},_create:function(t){return this.dom("<span>").addClass(this.classname).html(t.attr("data-tooltip"))},_cleanTitle:function(t){return!!t&&t.replace(/(<([^>]+)>)/gi,"")},_setPosition:function(i){var e=i.offset(),i=i.height();this.$tooltip.css({top:e.top+i+"px",left:e.left+"px"})},_fixBSModal:function(){this.opts.bsmodal&&this.$tooltip.css("z-index",1060)},_getButton:function(t){return this.dom(t.target).closest("."+this.prefix+"-button-target")}}),l.add("module","codemirror",{init:function(){this.cm=!1},create:function(t){var e,i;if(this.is())return e=typeof this.opts.codemirror=="object"?this.opts.codemirror:{},i=this.opts.codemirrorSrc||bi,this.cm=i.fromTextArea(this.dom(t.el).get(),e),t.height&&this.cm.setSize(null,t.height),t.focus&&this.cm.focus(),this.cm},destroy:function(){this.cm&&(this.cm.toTextArea(),this.cm=!1)},is:function(){return this.opts.codemirror},val:function(t){return t=this.is()&&this.cm?this.cm.getValue():t}}),l.add("class","upload",{defaults:{type:"image",box:!1,url:!1,cover:!0,name:"file",data:!1,multiple:!0,placeholder:!1,hidden:!0,target:!1,success:!1,error:!1,remove:!1,trigger:!1,input:!1},init:function(t,e,i){this.eventname=this.prefix+"-upload",t&&this._build(t,e,i)},send:function(t,e,i,s){this.p=this._buildParams(i,s),this._send(t,e)},complete:function(t,e){this._complete(t,e)},setImage:function(t){this.p.input||(this.$image&&this.$image.remove(),this.$remove&&this.$remove.remove(),t===""?this.$placeholder.show():(this.$placeholder.hide(),this._buildImage(t),this.p.remove&&this._buildRemove()))},_build:function(t,e,i){this.p=this._buildParams(e,i),this.$element=this.dom(t),this.$element.get().tagName==="INPUT"?this._buildByInput():this._buildByBox()},_buildImage:function(t){this.$image=this.dom("<img>"),this.$image.attr("src",t),this.$box.append(this.$image),this.p.input===!1&&(this.$box.off("click."+this.eventname),this.$image.on("click."+this.eventname,this._click.bind(this)))},_buildRemove:function(){this.$remove=this.dom("<span>"),this.$remove.addClass(this.prefix+"-upload-remove"),this.$remove.on("click",this._removeImage.bind(this)),this.$box.append(this.$remove)},_buildParams:function(t,e){return t=c.extend(!0,this.defaults,t),e&&(t.trigger=e),t},_buildByInput:function(){this.$input=this.$element,this.p.box?(this._buildBox(),this._buildPlaceholder()):this.p.input=!0,this._buildAccept(),this._buildMultiple(),this._buildEvents()},_buildByBox:function(){this._buildInput(),this._buildAccept(),this._buildMultiple(),this._buildBox(),this._buildPlaceholder(),this._buildEvents()},_buildBox:function(){this.$box=this.dom("<div>").addClass(this.prefix+"-form-upload-box"),this.$element.before(this.$box),this.p.cover===!1&&this.$box.addClass(this.prefix+"-form-upload-cover-off"),this.p.hidden&&this.$element.hide()},_buildPlaceholder:function(){this.p.placeholder&&(this.$placeholder=this.dom("<span>").addClass(this.prefix+"-form-upload-placeholder"),this.$placeholder.html(this.p.placeholder),this.$box.append(this.$placeholder))},_buildInput:function(){this.$input=this.dom("<input>"),this.$input.attr("type","file"),this.$input.attr("name",this._getUploadParam()),this.$input.hide(),this.$element.before(this.$input)},_buildAccept:function(){var t;this.p.type==="image"&&(t=this.opts.image.types.join(","),this.$input.attr("accept",t))},_buildMultiple:function(){this.p.type==="image"&&(this.p.multiple?this.$input.attr("multiple","multiple"):this.$input.removeAttr("multiple"))},_buildEvents:function(){this.$input.on("change."+this.eventname+"-"+this.uuid,this._change.bind(this)),this.p.input===!1&&(this.$box.on("click."+this.eventname,this._click.bind(this)),this.$box.on("drop."+this.eventname,this._drop.bind(this)),this.$box.on("dragover."+this.eventname,this._dragover.bind(this)),this.$box.on("dragleave."+this.eventname,this._dragleave.bind(this)))},_buildData:function(t,e,i){if(this.p.multiple==="single")i.append(t,e[0]);else if(this.p.multiple)for(var s=0;s<e.length;s++)i.append(t+"[]",e[s]);else i.append(t+"[]",e[0]);return i},_removeImage:function(t){t&&(t.preventDefault(),t.stopPropagation()),this.$image&&this.$image.remove(),this.$remove&&this.$remove.remove(),this.$placeholder.show(),this.p.input===!1&&this.$box.on("click."+this.eventname,this._click.bind(this)),t&&this.app.api(this.p.remove,t)},_getUploadParam:function(){return this.p.name},_click:function(t){t.preventDefault(),this.$input.click()},_change:function(t){this._send(t,this.$input.get().files)},_drop:function(t){t.preventDefault(),this._send(t)},_dragover:function(t){return t.preventDefault(),this._setStatus("hover"),!1},_dragleave:function(t){return t.preventDefault(),this._removeStatus(),!1},_setStatus:function(t){!this.p.input&&this.p.box&&(this._removeStatus(),this.$box.addClass(this.prefix+"-form-upload-"+t))},_removeStatus:function(){if(!this.p.input&&this.p.box)for(var t=["hover","error"],e=0;e<t.length;e++)this.$box.removeClass(this.prefix+"-form-upload-"+t[e])},_send:function(t,e){e=e||t.dataTransfer.files;var s=new FormData,i=this._getUploadParam(),s=this._buildData(i,e,s);s=this.app.utils.extendData(s,this.p.data),this._sendData(t,e,s)},_sendData:function(t,e,i){typeof this.p.url=="function"?this.p.url.call(this.app,this,{data:i,files:e,e:t}):(this.app.progress.show(),this.ajax.post({url:this.p.url,data:i,before:(function(s){if(this.app.broadcast("upload.before.send",{xhr:s,data:i,files:e,e:t}).isStopped())return this.app.progress.hide(),!1}).bind(this),success:(function(s){this._complete(s,t)}).bind(this),error:(function(s){this._complete(s,t)}).bind(this)}))},_complete:function(t,e){t&&t.error?(this._setStatus("error"),this.p.error&&(this.app.broadcast("upload.error",{response:t}),this.app.api(this.p.error,t,e))):(this._removeStatus(),this._trigger(t),this.p.success&&(this.app.broadcast("upload.complete",{response:t}),this.app.api(this.p.success,t,e))),setTimeout((function(){this.app.progress.hide()}).bind(this),500)},_trigger:function(t){var e;this.p.trigger&&t&&t.url&&(e=this.p.trigger.instance)[this.p.trigger.method].call(e,t.url)}}),l.add("module","statusbar",{init:function(){this.classname=this.prefix+"-statusbar"},start:function(){this._build()},add:function(t,e){return this.update(t,e)},update:function(t,e){var i=this.get(t);return(i=i.length===0?this._buildItem(t):i).html(e)},get:function(t){return this.$statusbar.find(t?"[data-name="+t+"]":"[data-name]")},remove:function(t){this.get(t).remove()},clear:function(){this.$statusbar.html("")},_build:function(){this.$statusbar=this.dom("<div>").attr("dir",this.opts.editor.direction),this.$statusbar.addClass(this.classname+" "+this.classname+"-"+this.uuid),this.app.container.get("statusbar").append(this.$statusbar)},_buildItem:function(t){var e=this.dom("<span>").addClass(this.classname+"-item");return e.attr("data-name",t),this.$statusbar.append(e),e}}),l.add("module","container",{init:function(){this.blurclass=this.prefix+"-in-blur",this.focusclass=this.prefix+"-in-focus"},start:function(){this._buildMain(),this._buildContainers(this.$main,this.opts.containers.main),this._buildBSModal()},stop:function(){this.$main.remove()},get:function(t){return this["$"+t]},setFocus:function(){this.$main.removeClass(this.blurclass).addClass(this.focusclass)},setBlur:function(){this.$main.removeClass(this.focusclass).addClass(this.blurclass)},isFocus:function(){return this.$main.hasClass(this.focusclass)},_buildMain:function(){this.$main=this.dom("<div>").attr(this.prefix+"-uuid",this.uuid),this.$main.addClass(this.prefix+"-container "+this.prefix+"-container-"+this.uuid),this.app.$element.after(this.$main)},_buildContainers:function(t,e){for(var i=0;i<e.length;i++){var s=e[i],n="$"+s;this[n]=this._createContainer(s),this.opts.containers[s]!==void 0&&this._buildContainers(this[n],this.opts.containers[s]),t.append(this[n])}},_buildBSModal:function(){this.opts.bsmodal=this.$main.closest(".modal-dialog").length!==0},_createContainer:function(t){return this.dom("<div>").addClass(this.prefix+"-"+t+"-container")}}),l.add("module","shortcut",{init:function(){if(this.opts.shortcutsRemove)for(var t=this.opts.shortcutsRemove,e=0;e<t.length;e++)this.remove(t[e]);this.shortcuts=this.opts.shortcuts,this.hotkeys={8:"backspace",9:"tab",10:"return",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",61:"=",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},this.hotkeysShiftNums={"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":": ","'":'"',",":"<",".":">","/":"?","\\":"|"}},add:function(t,e){this.shortcuts[t]=e},remove:function(t){this.opts.shortcutsBase=this._remove(t,this.opts.shortcutsBase),this.opts.shortcuts=this._remove(t,this.opts.shortcuts)},popup:function(t,e){var i=/(Mac|iPhone|iPod|iPad)/i.test(navigator.platform)?"<b>&#8984;</b>":"ctrl",s={},n=this._buildPopupItems(s,0,this.opts.shortcutsBase,i,"base");this._buildPopupItems(s,n,this.opts.shortcuts,i),this.app.popup.create("shortcuts",{width:"360px",items:s}),this.app.popup.open({button:e})},handle:function(t){if((this.triggered=!1)===this.shortcuts)return!t.ctrlKey&&!t.metaKey||t.which!==66&&t.which!==73||t.preventDefault(),!0;if(t.ctrlKey||t.metaKey||t.shoftKey||t.altKey)for(var e in this.shortcuts)this.shortcuts.hasOwnProperty(e)&&this._build(t,e,this.shortcuts[e]);return this.triggered},_buildPopupItems:function(t,e,i,s,n){for(var a in i)if(i.hasOwnProperty(a)){for(var o=this.dom("<div>").addClass(this.prefix+"-popup-shortcut-item"),r=n==="base"?i[a]:i[a].title,r=this.dom("<span>").addClass(this.prefix+"-popup-shortcut-title").html(this.lang.parse(r)),p=this.dom("<span>").addClass(this.prefix+"-popup-shortcut-kbd"),d=(n==="base"?a:i[a].name).replace("meta",s).split("+"),m=0;m<d.length;m++)d[m]="<span>"+d[m]+"</span>";p.html(d.join("+")),o.append(r),o.append(p),t[e]={html:o},e++}return e},_build:function(t,e,i){for(var s=e.split(","),n=s.length,a=0;a<n;a++)typeof s[a]!="string"||Object.prototype.hasOwnProperty.call(i,"trigger")||this._handler(t,s[a].trim(),i)},_handler:function(t,e,i){e=e.toLowerCase().split(" ");for(var s=this.hotkeys[t.keyCode],n=t.which!==91&&String.fromCharCode(t.which).toLowerCase(),a="",o={},r=["meta","ctrl","alt","shift"],p=0;p<r.length;p++){var d=r[p];t[d+"Key"]&&s!==d&&(a+=d+"+")}t.keyCode===93&&(a+="meta+"),s&&(o[a+s]=!0),n&&(o[a+n]=!0,o[a+this.hotkeysShiftNums[n]]=!0,a==="shift+")&&(o[this.hotkeysShiftNums[n]]=!0);for(var m=e.length,y=0;y<m;y++)if(o[e[y]])return t.preventDefault(),this.triggered=!0,void this.app.api(i.command,i.params,t)},_remove:function(t,e){return Object.keys(e).reduce(function(i,s){return s!==t&&(i[s]=e[s]),i},{})}}),l.add("module","offset",{get:function(t){t=this._getEl(t);var e,i=this.app.editor.getWinNode().getSelection(),s=!1;return i&&0<i.rangeCount&&(e=i.getRangeAt(0),t.contains(i.anchorNode))&&((i=e.cloneRange()).selectNodeContents(t),i.setEnd(e.startContainer,e.startOffset),s={start:t=i.toString().length,end:t+e.toString().length}),s},set:function(t,e){e===!1&&(e={start:0,end:0}),t=this._getEl(t);var i,s=0,n=this.app.editor.getDocNode().createRange(),a=[t],o=!1,r=!1;for(n.setStart(t,0),n.collapse(!0);!r&&(i=a.pop());)if(i.nodeType===3){var p=s+i.length;!o&&e.start>=s&&e.start<=p&&(n.setStart(i,e.start-s),o=!0),o&&e.end>=s&&e.end<=p&&(n.setEnd(i,e.end-s),r=!0),s=p}else for(var d=i.childNodes.length;d--;)a.push(i.childNodes[d]);this.app.selection.setRange(n)},_getEl:function(t){return(t?this.dom(t):this.app.editor.getLayout()).get()}}),l.add("module","marker",{build:function(t){return t=this.dom("<span>").attr("id","selection-marker-"+t),t.addClass(this.prefix+"-selection-marker"),t.html(this.opts.markerChar),t.get()},insert:function(){this.remove();var t,e,i,s=this.app.selection.get(),n=!s.collapsed;s.range&&(t=this.build("start"),e=this.build("end"),i=s.range.cloneRange(),n&&(i.collapse(!1),i.insertNode(e)),i.setStart(s.range.startContainer,s.range.startOffset),i.collapse(!0),i.insertNode(t),s.range.setStartAfter(t),n&&s.range.setEndBefore(e),this.app.selection.setRange(s.range))},restore:function(){var t,e,i=this.find("start"),s=this.find("end"),n=this.app.selection.get(),n=n.range||this.app.editor.getDocNode().createRange();i&&(t=!!s&&s.previousSibling,e=(!(e=i.nextSibling)||e.nodeType!==3||e.textContent.replace(/[\n\t]/g,"")!=="")&&e,s?e&&e.id==="selection-marker-end"?this._restoreInject(n,i):t&&e?(n.selectNodeContents(t),n.collapse(!1),n.setStart(e,0)):t&&!e?(n.selectNodeContents(t),n.collapse(!1),n.setStartAfter(i)):(n.setStartAfter(i),n.setEndBefore(s)):e?(n.selectNodeContents(e),n.collapse(!0)):this._restoreInject(n,i),this.app.selection.setRange(n),t=i&&s?2:1,e={start:(e=this.app.offset.get()).start-t,end:e.end-t},i&&i.parentNode.removeChild(i),s&&s.parentNode.removeChild(s),this.app.editor.setWinFocus(),this.app.offset.set(!1,e))},find:function(t){return t=this.app.editor.getLayout().find("#selection-marker-"+t),t.length!==0&&t.get()},remove:function(){var t=this.find("start"),e=this.find("end");t&&t.parentNode.removeChild(t),e&&e.parentNode.removeChild(e)},_restoreInject:function(t,e){var i=this.app.utils.createInvisibleChar();this.dom(e).after(i),t.selectNodeContents(i),t.collapse(!1)}}),l.add("module","state",{init:function(){this.started=!1,this.storage=!1,this.state=!1,this.passed=!0,this.undoStorage=[],this.redoStorage=[]},load:function(){this.clear(),this.trigger(!0)},stop:function(){this.clear()},clear:function(){this.storage=!1,this.state=!1,this.passed=!0,this.undoStorage=[],this.redoStorage=[]},get:function(){return this.undoStorage},add:function(t){t&&(t.ctrlKey||t.metaKey||this._isUndo(t)||this._isRedo(t))||!this.app.observer.trigger||(this.state=this._createState(),this.started===!1&&(this._setState(this.state,0),this.started=!0))},trigger:function(t){var e;this.passed&&(e=this._createState(),this.state?e=this.state:this.state||t||(e=this.storage,this.started=!0),this._addState(e),this.storage=this._createState(),this.state=!1)},listen:function(t){return this._isUndo(t)?(t.preventDefault(),this.undo(),!0):this._isRedo(t)?(t.preventDefault(),this.redo(),!0):void(this.passed=!0)},undo:function(){var t,e;this._hasUndo()&&(this.passed=!1,t=this._getUndo(),this._setRedo(),e=this.app.parser.parse(t[0]),this.app.editor.getLayout().html(e.children()),this._rebuild(t,"undo"),e=!(!(e=this.app.block.get())||!e.isEditable())&&e.getBlock(),this.app.offset.set(e,t[1]))},redo:function(){var t,e;this._hasRedo()&&(this.passed=!1,t=this.redoStorage.pop(),this._addState({html:t[0],offset:t[1]}),e=this.app.parser.parse(t[0]),this.app.editor.getLayout().html(e.children()),this._rebuild(t,"redo"),e=!(!(e=this.app.block.get())||!e.isEditable())&&e.getBlock(),this.app.offset.set(e,t[1]))},_rebuild:function(t,e){this.app.editor.build(),this.app.editor.getLayout().find("."+this.prefix+"-block-state").each((function(i){this.app.block.set(i)}).bind(this)),this.app.broadcast("state."+e,{html:t[0],offset:t[1]})},_isUndo:function(t){var e=t.which;return(t.ctrlKey||t.metaKey)&&e===90&&!t.shiftKey&&!t.altKey},_isRedo:function(t){var e=t.which;return(t.ctrlKey||t.metaKey)&&(e===90&&t.shiftKey||e===89&&!t.shiftKey)&&!t.altKey},_hasUndo:function(){return this.undoStorage.length!==0},_hasRedo:function(){return this.redoStorage.length!==0},_getUndo:function(){return this.undoStorage.length===1?this.undoStorage[0]:this.undoStorage.pop()},_createState:function(){var t=this.app.editor.getLayout().html(),t=this.app.utils.wrap(t,(function(i){i.find("."+this.prefix+"-block-focus").addClass(this.prefix+"-block-state")}).bind(this)),e=this.app.block.get(),e=!(!e||!e.isEditable())&&e.getBlock();return{html:this.app.parser.unparse(t,!0),offset:this.app.offset.get(e)}},_setState:function(t,e){this.undoStorage[e]=[t.html,t.offset]},_addState:function(t){var e=this.undoStorage[this.undoStorage.length-1];e===void 0||e[0]!==t.html?(this.undoStorage.push([t.html,t.offset]),this._removeOverStorage()):e[1]=t.offset},_setRedo:function(){var t=this._createState();this.redoStorage.push([t.html,t.offset]),this.redoStorage=this.redoStorage.slice(0,this.opts.state.limit)},_removeOverStorage:function(){this.undoStorage.length>this.opts.state.limit&&(this.undoStorage=this.undoStorage.slice(0,this.undoStorage.length-this.opts.state.limit))}}),l.add("module","sync",{build:function(){this.syncedHtml=this.app.$element.val()},trigger:function(){this.opts.editor.sync&&(this.typingTimer&&clearTimeout(this.typingTimer),this.typingTimer=setTimeout((function(){var t=this._getHtml();this.is(t)&&this._sync(t)}).bind(this),300))},invoke:function(){var t=this._getHtml();this.syncedHtml=t,this._sync(t)},is:function(t){var e=!1;return this.syncedHtml!==t&&(this.syncedHtml=t,e=!0),e},_getHtml:function(){var t=this.app.editor.getLayout().html();return this.app.parser.unparse(t)},_sync:function(t){t=this.app.broadcast("editor.before.change",{html:t}),t.isStopped()||(this.app.$element.val(t.get("html")),this.app.autosave.send(),this.app.state.trigger(),this.app.broadcast("editor.change",t))}}),l.add("module","placeholder",{start:function(){this.placeholder=!1,this.$layout=this.app.editor.getLayout(),this._build()},handleClick:function(t){this.dom(t.target).hasClass(this.prefix+"-placeholder")&&(t.preventDefault(),t.stopPropagation(),this.app.editor.setFocus("start"))},trigger:function(){this.placeholder&&this.app.editor.isEmpty(!0)?this.show():this.hide()},toggle:function(){this.observerTimer&&clearTimeout(this.observerTimer),this.observerTimer=setTimeout(this.trigger.bind(this),10)},show:function(){this.$layout.addClass(this.prefix+"-placeholder")},hide:function(){this.$layout.removeClass(this.prefix+"-placeholder")},change:function(t){this.opts.placeholder=t,this._rebuild(),this.app.editor.isEmpty(!0)&&this.app.editor.setEmpty()},_build:function(){this._rebuild(),this.toggle()},_rebuild:function(){var t=this.opts.placeholder,e=this.app.$element.attr("placeholder");t===!1&&!e||(this.$layout.attr("placeholder",t!==!1?t:e),this.placeholder=!0)}}),l.add("module","list",{indent:function(){var n=this.app.selection.get(),t=this.app.selection.getBlock(),e=this.dom(t),i=e.prevElement(),s=i.get(),n=n.collapsed&&t&&s&&s.tagName==="LI";return this.app.selection.save(t),n&&(t=(i=this.dom(s)).children("ul, ol"),s=e.closest("ul, ol"),t.length!==0?t.append(e):(t=s.get().tagName.toLowerCase(),(s=this.dom("<"+t+">")).append(e),i.append(s))),this.app.selection.restore(),n},outdent:function(){var t=this.app.selection.get(),e=this.app.selection.getBlock(),i=this.dom(e),s=!1;if(t.collapsed&&e){var t=i.parent(),n=t.closest("li"),r=i.prevElement(),a=i.nextElement(),r=r.get(),a=a.get(),o=r===!1,r=r!==!1&&a!==!1;if(this.app.selection.save(e),n.length!==0){if(r){for(var p=this._getAllNext(i.get()),d=this.dom("<"+t.get().tagName.toLowerCase()+">"),m=0;m<p.length;m++)d.append(p[m]);n.after(i),i.append(d)}else n.after(i),t.children().length===0?t.remove():o&&i.append(t);s=!0}this.app.selection.restore()}return s},_getAllNext:function(t){for(var e=[];t;){if(!(t=this.dom(t).nextElement().get()))return e;e.push(t)}return e}}),l.add("module","cleaner",{cleanHtml:function(t){t=this.app.broadcastHtml("editor.before.clean",t);var e,i,s={},r=this.opts.paste.blockTags.concat(this.opts.paste.inlineTags).concat(this.opts.paste.formTags),n=this._isPages(t),a=this._isHtmlMsWord(t),o=this._isEditor(t),r=(t=this.app.content.store(t,"embed",s,0),t=this.app.content.removeDoctype(t),t=(t=this.app.content.removeTags(t,this.opts.tags.denied)).trim(),t=this.app.content.removeComments(t),t=this.app.content.removeTagsWithContent(t,["script","style"]),t=n?this._cleanPages(t):t,t=a?t:this._cleanGDocs(t),t=this._encodePhp(t),t=this.app.content.removeTagsExcept(t,r),t=a?this._cleanMsWord(t):t,!1);return!o&&this.app.event.pasteEvent&&(t=this.app.content.restore(t,"embed",s),r=!0),o||(e=this.opts.paste.keepClass.length!==0?this.opts.paste.keepClass.join(","):"",i=this.opts.paste.keepAttrs.length!==0?this.opts.paste.keepAttrs.join(","):"",t=this.app.utils.wrap(t,function(p){p=p.find("*"),p.not(e).removeAttr("class"),p.not(i).each(function(d){for(var m=d.get(),y=m.attributes,N=y.length-1;0<=N;N--){var A=y[N].name;A!=="class"&&A!=="dir"&&A.search(/^data-/)===-1&&(m.tagName!=="IMG"||A!=="src"&&A!=="alt")&&(m.tagName!=="A"||A!=="href"&&A!=="target")&&m.removeAttribute(A)}})})),r||(t=this.app.content.restore(t,"embed",s)),t=o?this.app.content.cacheStyle(t):this.app.content.removeStyleAttr(t),t=(t=(t=(t=(t=(t=this.app.content.removeEmptyInlines(t)).replace(/<figure[^>]*><\/figure>/gi,"")).replace(/<p>&nbsp;<\/p>/gi,"<p></p>")).replace(/<p><br\s?\/?><\/p>/gi,"<p></p>")).replace(/^<li/gi,"<ul><li")).replace(/<\/li>$/gi,"</li></ul>"),(a||n)&&(t=(t=t.replace(/<p><\/p>/gi,"")).replace(/<p>\s<\/p>/gi,"")),t=this.app.utils.wrap(t,(function(p){p.find(".Apple-converted-space").unwrap(),p.find("ul, ol").each(this._placeListToItem.bind(this)),p.find("li p").unwrap()}).bind(this)),this.app.broadcastHtml("editor.clean",t)},_encodePhp:function(t){return t=(t=(t=t.replace("<?php","&lt;?php")).replace("<?","&lt;?")).replace("?>","?&gt;")},_isEditor:function(t){return t.match(new RegExp('meta\\stype="'+this.prefix+'-editor"',"i"))},_isHtmlMsWord:function(t){return t.match(/class="?Mso|style="[^"]*\bmso-|style='[^'']*\bmso-|w:WordDocument/i)},_isPages:function(t){return t.match(/name="Generator"\scontent="Cocoa\sHTML\sWriter"/i)},_placeListToItem:function(e){var e=e.get(),i=e.previousSibling;i&&i.tagName==="LI"&&((i=this.dom(i)).find("p").unwrap(),i.append(e))},_cleanPages:function(t){return t=(t=t.replace(/\sclass="s[0-9]"/gi,"")).replace(/\sclass="p[0-9]"/gi,"")},_cleanGDocs:function(t){return t=(t=(t=(t=(t=(t=t.search(/docs-internal-guid/i)!==-1?(t=this.app.utils.wrap(t,function(e){e.find("h1, h2, h3, h4, h5, h6").each(function(i){i.find("span").unwrap()})})).replace(/ dir="[^>]*"/gi,""):t).replace(/<b\sid="internal-source-marker(.*?)">([\w\W]*?)<\/b>/gi,"$2")).replace(/<b(.*?)id="docs-internal-guid(.*?)">([\w\W]*?)<\/b>/gi,"$3")).replace(/<span[^>]*(font-style:\s?italic;\s?font-weight:\s?(bold|600|700)|font-weight:\s?(bold|600|700);\s?font-style:\s?italic)[^>]*>([\w\W]*?)<\/span>/gi,"<b><i>$4</i></b>")).replace(/<span[^>]*font-style:\s?italic[^>]*>([\w\W]*?)<\/span>/gi,"<i>$1</i>")).replace(/<span[^>]*font-weight:\s?(bold|600|700)[^>]*>([\w\W]*?)<\/span>/gi,"<b>$2</b>")},_cleanMsWord:function(t){t=(t=(t=(t=(t=(t=t.replace(/<!--[\s\S]+?-->/gi,"")).trim()).replace(/<(!|script[^>]*>.*?<\/script(?=[>\s])|\/?(\?xml(:\w+)?|meta|link|style|\w:\w+)(?=[\s/>]))[^>]*>/gi,"")).replace(/<(\/?)s>/gi,"<$1strike>")).replace(/&nbsp;/gi," ")).replace(/<span\s+style\s*=\s*"\s*mso-spacerun\s*:\s*yes\s*;?\s*"\s*>([\s\u00a0]*)<\/span>/gi,function(a,o){return 0<o.length?o.replace(/./," ").slice(Math.floor(o.length/2)).split("").join(" "):""});for(var e="",i=(t=(t=(t=(t=(t=(t=this.app.utils.wrap(t,(function(a){a.find("p").each(function(o){var r=/mso-list:\w+ \w+([0-9]+)/.exec(o.attr("style"));r&&o.attr("data-listLevel",parseInt(r[1],10))}),this._parseWordLists(a),a.find("[align]").removeAttr("align"),a.find("[name]").removeAttr("name"),a.find("span").each(function(o){var r=o.attr("style");/mso-list:Ignore/.exec(r)?o.remove():o.unwrap()}),a.find("[style]").removeAttr("style"),a.find("[class^='Mso']").removeAttr("class"),a.find("a").filter(function(o){return!o.attr("href")}).unwrap()}).bind(this))).replace(/<p><img(.*?)>/gi,"<p><img$1></p><p>")).replace(/<p[^>]*><\/p>/gi,"")).replace(/<li>·/gi,"<li>")).trim()).replace(/\/(p|ul|ol|h1|h2|h3|h4|h5|h6|blockquote)>\s+<(p|ul|ol|h1|h2|h3|h4|h5|h6|blockquote)/gi,`/$1>
<$2`)).split(/\n/),s=0;s<i.length;s++){var n=i[s]!==""&&i[s].search(/>$/)===-1?" ":`
`;e+=i[s]+n}return e=e.trim()},_parseWordLists:function(t){var e,i=0,s=null,n=null;t.find("p").each((function(a){var o=a.attr("data-listLevel");if((o=o===null&&a.hasClass("MsoListParagraphCxSpMiddle")?1:o)!==null){var r=a.text(),r=/^\s*\w+\./.test(r)?"<ol></ol>":"<ul></ul>";if(a.hasClass("MsoListParagraphCxSpFirst")||a.hasClass("MsoNormal")?(n=this.dom(r),a.before(n)):i<o&&i!==0&&(e=this.dom(r),s.append(e),n=e),o<i)for(var p=i-o+1,d=0;d<p;d++)n=n.parent();a.find("span").first().unwrap(),s=this.dom("<li>"+a.html().trim()+"</li>"),n===null&&(a.before(r),n=a.prev()),n.append(s),a.remove(),i=o}else n=null,i=0}).bind(this))}}),l.add("module","tidy",{init:function(){},parse:function(t){t=this.app.content.encodeAttrSings(t);var e,i=["li"],s=["li"],n=(this.lineBefore=new RegExp("^<(/?"+i.join("|/?")+"|"+s.join("|")+")[ >]"),this.lineAfter=new RegExp("^<(/?"+i.join("|/?")+"|/"+s.join("|/")+")[ >]"),this.newLevel=new RegExp("^</?("+["p","ul","ol","li","div","h1","h2","h3","h4","h5","h6","blockquote","figure","figcaption","table","thead","tbody","tfoot","tr","td","th","dl","dt","dd"].join("|")+")[ >]"),0),a=t.length,o=0,r="",p="",d="";for(this.cleanlevel=0;n<a;n++){if(o=n,t.substr(n).indexOf("<")===-1)return p+=t.substr(n),this.finish(p);for(;o<a&&t.charAt(o)!=="<";)o++;for(n===o||(d=t.substr(n,o-n)).match(/^\s{2,}$/g)||(p.charAt(p.length-1)===`
`?p+=this.getTabs():d.charAt(0)===`
`&&(p+=`
`+this.getTabs(),d=d.replace(/^\s+/,"")),p+=d),e=o;o<a&&t.charAt(o)!==">";)o++;var m,n=o;if((r=t.substr(e,o-e)).substr(1,3)==="!--"){if(!r.match(/--$/)){for(;t.substr(o,3)!=="-->";)o++;o+=2,r=t.substr(e,o-e),n=o}p.charAt(p.length-1)!==`
`&&(p+=`
`),p=p+this.getTabs()+(r+`>
`)}else r[1]==="!"?p=this.placeTag(r+">",p):r[1]==="?"?p+=r+`>
`:m===r.match(/^<(script|style|pre)/i)?(m[1]=m[1].toLowerCase(),r=this.cleanTag(r),p=this.placeTag(r,p),(e=String(t.substr(n+1)).toLowerCase().indexOf("</"+m[1]))&&(d=t.substr(n+1,e),n+=e,p+=d)):(r=this.cleanTag(r),p=this.placeTag(r,p))}return this.finish(p)},getTabs:function(){for(var t="",e=0;e<this.cleanlevel;e++)t+="    ";return t},finish:function(t){return t=(t=(t=(t=(t=(t=(t=t.replace(/\n\s*\n/g,`
`)).replace(/^[\s\n]*/,"")).replace(/[\s\n]*$/,"")).replace(/<li(.*?)>[\s\n]*/gi,"<li$1>")).replace(/<(p|h1|h2|h3|h4|h5|h6|li|td|th)(.*?)>[\s\n]*<\/\1>/gi,"<$1$2></$1>")).replace(/[\s\n]*<\/li>/gi,"</li>")).replace(/<script(.*?)>\n<\/script>/gi,"<script$1><\/script>"),t=this.app.content.decodeAttrSings(t),this.cleanlevel=0,t},cleanTag:function(t){var e,i="",s="";for((t=(t=(t=t.replace(/\n/g," ")).replace(/\s{2,}/g," ")).replace(/^\s+|\s+$/g," ")).match(/\/$/)&&(s="/",t=t.replace(/\/+$/,""));e=/\s*([^= ]+)(?:=((['"']).*?\3|[^ ]+))?/.exec(t);)e[2]?i+=e[1].toLowerCase()+"="+e[2]:e[1]&&(i+=e[1].toLowerCase()),i+=" ",t=t.substr(e[0].length);return i.replace(/\s*$/,"")+s+">"},placeTag:function(t,e){var i=t.match(this.newLevel);return(t.match(this.lineBefore)||i)&&(e=e.replace(/\s*$/,""),e+=`
`),i&&t.charAt(1)==="/"&&this.cleanlevel--,e.charAt(e.length-1)===`
`&&(e+=this.getTabs()),i&&t.charAt(1)!=="/"&&this.cleanlevel++,e+=t,(t.match(this.lineAfter)||t.match(this.newLevel))&&(e=e.replace(/ *$/,""),e+=`
`),e}}),l.add("module","source",{start:function(){this.eventname=this.prefix+"-source-events",this._build()},toggle:function(){this.is()?this.close():this.open()},is:function(){return this.app.container.get("source").css("display")!=="none"},open:function(){this.app.broadcast("source.before.open");var e=this.app.editor.getContent(),e=this.app.tidy.parse(e),t=this.app.container.get("editor").height(),e=(this.$source.height(t),this.$source.val(e),this.$source.on("focus."+this.eventname,this._handleFocus.bind(this)),this.$source.on("input."+this.eventname,this._handleChanges.bind(this)),this.$source.on("keydown."+this.eventname,this.app.input.handleTextareaTab.bind(this)),this.app.editor.unselectAll(),this.app.container.get("editor").hide(),this.app.container.get("source").show(),this.app.codemirror.create({el:this.$source,height:t,focus:!0}));e&&(e.on("change",this._handleChanges.bind(this)),e.on("focus",this._handleFocus.bind(this))),this.app.editor.disableUI(),this.app.toolbar.setToggled("html"),this.app.broadcast("source.open")},close:function(){this.app.broadcast("source.before.close");var t=this.getContent();this.app.codemirror.destroy(),this.$source.off("."+this.eventname),this.app.container.get("source").hide(),this.app.container.get("editor").show(),this.app.editor.setContent({html:t,caret:"start"}),this.app.editor.enableUI(),this.app.toolbar.unsetToggled("html"),this.app.broadcast("source.close")},update:function(t){var e=this.app.editor.isTextarea()?"val":"html";this.app.$element[e](t)},getContent:function(){var t=this.$source.val();return this.app.codemirror.val(t)},_build:function(){this.opts.source&&(this.$source=this.dom("<textarea>").addClass(this.prefix+"-source"),this.$source.attr("data-gramm_editor",!1),this.app.container.get("source").append(this.$source))},_handleFocus:function(){this.app.editor.setFocus()},_handleChanges:function(t){var e=this.getContent();this.update(e),this.app.broadcast("source.change",{e:t})}}),l.add("module","content",{init:function(){this._selectors={code:["pre","code"],embed:["figure"],noneditable:["."+this.opts.noneditable.classname],images:["img"],links:["a"]}},paragraphize:function(t){return this.app.paragraphizer.paragraphize(t)},encodeEntities:function(t){return this.decodeEntities(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},encodeCode:function(t){return t=(t=(t=(t=(t=(t=(t=(t=this.encodeAttrSings(t)).replace(/<\s/gi,"&lt; ")).replace(/<([^>]+)</gi,"&lt;$1<")).replace(/<(.*?)>/gi,"xtagstartz$1xtagendz")).replace(/xtagstartzpre(.*?)xtagendz/g,"<pre$1>")).replace(/xtagstartzcode(.*?)xtagendz/g,"<code$1>")).replace(/xtagstartz\/codextagendz/g,"</code>")).replace(/xtagstartz\/prextagendz/g,"</pre>"),t=(t=(t=this._encodeCode(t)).replace(/xtagstartz([\w\W]*?)xtagendz/g,"<$1>")).replace(/xtagstartz\/(.*?)xtagendz/g,"</$1>"),t=this.decodeAttrSings(t)},encodeAttrSings:function(t){var e=t.match(/="(.*?)"/g);if(e!==null)for(var i,s=0;s<e.length;s++)e[s].search(/^"</)===-1&&e[s].search(/>"$/)===-1&&(i=(i=e[s].replace(">","xmoresignz")).replace("<","xlesssignz"),t=t.replace(e[s],i));return t},decodeAttrSings:function(t){return t=(t=t.replace(/xmoresignz/gi,">")).replace(/xlesssignz/gi,"<")},decodeEntities:function(t){return String(t).replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&amp;/g,"&")},decodeHref:function(t){var e=t.match(new RegExp('(href=".*?)(&amp;)(.*?">)',"g"));if(e!==null)for(var i=0;i<e.length;i++)t=t.replace(e[i],e[i].replace(/&amp;/g,"&"));return t},sanitize:function(t){return t=this.app.utils.wrap(t,(function(e){e.find("[src]").each(this._sanitizeSrc),e.find("a").each(this._sanitizeHref),e.find("a,b,i,strong,em,svg,img,details,audio").each(this._sanitizeEvents)}).bind(this))},escapeHtml:function(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")},store:function(t,e,i,s){for(var n=this._selectors[e],a=0;a<n.length;a++){var o=this._getElementsFromHtml(t,n[a]);t=this._store(t,e,o,i,s)}return t},restore:function(t,e,i){if(i[e]!==void 0)for(var s=0;s<i[e].length;s++)t=t.replace("####_"+e+s+"_####",i[e][s]);return t},storeComments:function(t,e){var i=t.match(new RegExp("<!--([\\w\\W]*?)-->","gi"));if(i!==null)for(var s=0;s<i.length;s++)t=t.replace(i[s],"#####xstarthtmlcommentzz"+s+"xendhtmlcommentzz#####"),e.push(i[s]);return t},restoreComments:function(t,e){for(var i=0;i<e.length;i++){var s=e[i].replace(/\$/gi,"&#36;");t=t.replace("#####xstarthtmlcommentzz"+i+"xendhtmlcommentzz#####",s)}return t},cacheStyle:function(t){var e=this.opts.tags.block.join(",")+",img,"+this.opts.tags.inline.join(",");return this.app.utils.wrap(t,(function(i){i.find(e).each(this._cacheStyle.bind(this))}).bind(this))},recacheStyle:function(t){return this.app.utils.wrap(t,(function(e){e.find("[data-"+this.prefix+"-style-cache]").each(this._recacheStyle.bind(this))}).bind(this))},fixListMargin:function(t){var e,i=parseInt(t.css("margin-left"));i!==0&&(e=parseInt(t.css("padding-left")),t.css({"margin-left":0,"padding-left":e+i+"px"}),t.attr(this.prefix+"-list-left",i))},unfixListMargin:function(t){t.attr(this.prefix+"-list-left")&&(t.css({"padding-left":"","margin-left":""}),t.removeAttr(this.prefix+"-list-left"))},addNofollow:function(t){return this.opts.link.nofollow?this.app.utils.wrap(t,function(e){e.find("a").attr("rel","nofollow")}):t},addHttps:function(t){return t=this.opts.editor.https?(t=(t=t.replace('href="http://','href="https://')).replace('src="http://','src="https://')).replace('srcset="http://','srcset="https://'):t},addSpaceToBlocks:function(t){return t.replace(/<\/(div|li|dt|dd|td|p|H[1-6])>\n?/gi,"</$1> ")},addBrToBlocks:function(t){return t.replace(/<\/(div|li|dt|dd|td|p|H[1-6])>\n?/gi,"</$1><br>")},addPredefinedTagClass:function(t){var e=t.get().tagName.toLowerCase(),i=this.opts.classes.tags!==void 0?this.opts.classes.tags:this.opts.classes;i[e]!==void 0&&t.addClass(i[e])},addPredefinedBlockClass:function(t){var e=t.attr("data-"+this.prefix+"-type"),i=this.opts.classes.blocks;i[e]!==void 0&&t.addClass(i[e])},getPredefinedBlocks:function(){var t=[];return Object.keys(this.opts.classes.blocks).forEach(function(e){t.push(e)}),t},getPredefinedTags:function(){var t=[],e=this.opts.classes.tags!==void 0?this.opts.classes.tags:this.opts.classes;return Object.keys(e).forEach(function(i){t.push(i)}),t},getText:function(t){var e="";if(t.nodeType===3)e=t.nodeValue;else{for(var i=0;i<t.childNodes.length;i++)e+=this.getText(t.childNodes[i]);var s=t.nodeType===1?getComputedStyle(t).getPropertyValue("display"):"";(s.match(/^block/)||s.match(/list/)||t.tagName==="BR"||t.tagName==="HR")&&(e+=`
`)}return e},getTextFromHtml:function(t,e){var i={},s=(e=c.extend({},{br:!1,nl:!1,trimlines:!0,images:!1,links:!1},e),t=this.store(t,"code",i,0),t=e.links?this.store(t,"links",i,0):t,t=(t=(t=(t=(t=(t=(t=(t=(t=e.images?this.store(t,"images",i,0):t).replace(/<(ul|ol)>\s+<li>/gi,"<$1><li>")).replace(/<li[^>]*>\n/gi,"<li$1>")).replace(/<p[^>]*>(\s+|)<\/p>/gi,"xemptyz")).replace(/<!--[\s\S]*?-->/gi,"")).replace(/<style[\s\S]*?style>/gi,"")).replace(/<script[\s\S]*?script>/gi,"")).replace(/<\/(div|li|dt|dd|td|p|H[1-6])>\n?/gi,`</$1>
`)).replace(/&(lt|gt);/gi,"x$1z"),this.dom("<div>").html(t));if(t=this.getText(s.get()),e.trimlines){for(var n="",a=t.split(`
`),o=0;o<a.length;o++)n+=a[o].trim()+`
`;t=n}return t=(t=(t=t.replace(/[\n]+/g,`
`)).replace("xemptyz",`
`)).replace(/x(lt|gt)z/gi,"&$1;"),t=e.br?(t=t.replace(/\n/g,`<br>
`)).replace(/<br\s?\/?>\n?$/gi,""):e.nl?t:t.replace(/\n/gi," "),t=this.restore(t,"code",i),t=e.links?this.restore(t,"links",i):t,t=(t=(t=(t=(t=e.images?this.restore(t,"images",i):t).replace(/<pre[^>]*>/g,"")).replace(/<code[^>]*>/g,"")).replace(/<\/pre>\n?/g,"")).replace(/<\/code>/g,""),(t=e.images?t:(t=t.replace(/<img[\s\S]*?>/gi,"")).replace(/<a[^>]*>(\s+|)<\/a>/gi,"")).trim()},extractHtmlFromCaret:function(i){var e,i=this.dom(i).get(),s=this.app.selection.getRange();if(s)return(e=s.cloneRange()).selectNodeContents(i),e.setStart(s.endContainer,s.endOffset),e.extractContents()},isEmptyHtml:function(t,e){return t=t.trim(),t=(t=(t=(t=(t=(t=(t=(t=(t=this.app.utils.removeInvisibleChars(t)).replace(/^&nbsp;$/gi,"1")).replace(/&nbsp;/gi,"")).replace(/<\/?br\s?\/?>/g,"")).replace(/\s/g,"")).replace(/^<p>\s\S<\/p>$/i,"")).replace(/<hr(.*?[^>])>$/i,"hr")).replace(/<iframe(.*?[^>])>$/i,"iframe")).replace(/<source(.*?[^>])>$/i,"source"),t=this.removeComments(t),(t=(t=(t=(t=e?t.replace(/<p[^>]*><\/p>/gi,""):t).replace(/<[^/>]><\/[^>]+>/gi,"")).replace(/<[^/>]><\/[^>]+>/gi,"")).trim())===""},isLine:function(t){var e=document.createElement("div");return e.innerHTML=t,this.dom(e).find(this.opts.tags.block.join(",")+",img").length===0},removeDoctype:function(t){return t.replace(new RegExp("<!doctype[^>]*>","gi"),"")},removeComments:function(t){return t.replace(/<!--[\s\S]*?-->\n?/g,"")},removeTags:function(t,e){return t.replace(e?/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi:/(<([^>]+)>)/gi,e?function(i,s){return e.indexOf(s.toLowerCase())===-1?i:""}:"")},removeTagsExcept:function(t,e){return e===void 0?t.replace(/(<([^>]+)>)/gi,""):t.replace(/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,function(i,s){return e.indexOf(s.toLowerCase())===-1?"":i})},removeTagsWithContent:function(t,e){return this.app.utils.wrap(t,function(i){i.find(e.join(",")).remove()})},removeMarkers:function(t){return this.app.utils.wrap(t,(function(e){e.find("."+this.prefix+"-plus-button").remove(),e.find("."+this.prefix+"pastemarker").removeClass(this.prefix+"pastemarker"),e.find("."+this.prefix+"pasteitems").removeClass(this.prefix+"pasteitems"),e.find("."+this.prefix+"-selection-marker").remove()}).bind(this))},removeEmptySpans:function(t){return this.app.utils.wrap(t,(function(e){e.find("span").each(this._removeEmptySpan.bind(this))}).bind(this))},removeEmptyInlines:function(t){return this.app.utils.wrap(t,(function(e){e.find(this.opts.tags.inline.join(",")).each(this._removeEmptyTag.bind(this))}).bind(this))},removeEmptyAttrs:function(t,e){return this.app.utils.wrap(t,function(i){for(var s=0;s<e.length;s++)i.find("["+e[s]+'=""]').removeAttr(e[s])})},removeBlockTags:function(t,e,i){var s=this.opts.tags.block.concat();return i&&(s=this.app.utils.removeFromArrayByValue(s,i)),e=e&&(e?this.app.utils.extendArray(s,e):s),this.removeTags(t,e)},removeBlockTagsInside:function(t,e){return this.blockListTags=this.app.utils.removeFromArrayByValue(this.opts.tags.block.concat(),["ul","ol","li"]),this.app.utils.wrap(t,(function(i){i.find(e.join(",")).each(this._removeBlockTagsInside.bind(this))}).bind(this))},removeInlineStyles:function(t){var e=this.app.utils.removeFromArrayByValue(this.opts.tags.inline,"a");return this.app.utils.wrap(t,function(i){i.find(e.join(",")).removeAttr("style")})},removeStyleAttr:function(t,e){return e=e||"",this.app.utils.wrap(t,(function(i){i.find("*").not("[data-"+this.prefix+"-style-cache]"+e).removeAttr("style")}).bind(this))},_cacheStyle:function(t){var e="data-"+this.prefix+"-style-cache",i=t.attr("style");i?(i=i.replace(/"/g,""),t.attr(e,i)):t.removeAttr(e)},_recacheStyle:function(t){var e="data-"+this.prefix+"-style-cache",i=t.attr(e);t.attr("style",i).removeAttr(e)},_cleanEmpty:function(t){return t=t.trim(),t=(t=(t=this.app.utils.removeInvisibleChars(t)).replace(/<\/?br\s?\/?>/g,"")).replace(/\s/g,"")},_removeEmptySpan:function(t){t.get().attributes.length===0&&t.unwrap()},_removeEmptyTag:function(t){var e=t.html().trim();t.get().attributes.length===0&&e===""&&t.unwrap()},_removeBlockTagsInside:function(t){var e=t.get().tagName==="LI"?this.blockListTags:this.opts.tags.block;t.find(e.join(",")).append("<br>").unwrap()},_store:function(t,e,i,s,n){if(i){s[e]===void 0&&(s[e]=[]);for(var a=0;a<i.length;a++)s[e][n]=i[a],t=t.replace(i[a],"####_"+e+n+"_####"),n++}return t},_getElementsFromHtml:function(t,e){var i=[];return this.dom("<div>").html(t).find(e).each(function(s){i.push(s.get().outerHTML)}),i},_sanitizeSrc:function(e){var e=e.get(),i=e.getAttribute("src");(i.search(/^javascript:/i)!==-1||e.tagName!=="IMG"&&i.search(/^data:/i)!==-1)&&e.setAttribute("src","")},_sanitizeHref:function(e){var e=e.get(),i=e.getAttribute("href");i&&i.search(/^javascript:/i)!==-1&&e.setAttribute("href","")},_sanitizeEvents:function(t){t.removeAttr("onload onerror ontoggle onwheel onmouseover oncopy")},_encodeCode:function(t){return this.app.utils.wrap(t,(function(e){e.find("pre code, pre, code").each(this._encodeNode.bind(this))}).bind(this))},_encodeNode:function(e){var e=e.get(),i=e.firstChild,s=e.innerHTML;e.tagName==="PRE"&&i&&i.tagName==="CODE"||(s=(s=s.replace(/xtagstartz/g,"<")).replace(/xtagendz/g,">"),i=this.decodeEntities(s),e.textContent=this._encodeNodeHtml(i))},_encodeNodeHtml:function(t){return t=t.replace(/&nbsp;/g," ").replace(/<br\s?\/?>/g,`
`),t=this.opts.code.spaces?t.replace(/\t/g,new Array(this.opts.code.spaces+1).join(" ")):t}}),l.add("module","autoparse",{parse:function(t){if(this.opts.paste.autoparse){var e=this.app.block.get(),i=[],s=(t=this.app.content.storeComments(t,i),t=this.app.content.removeDoctype(t),["figure","html","form","pre","div","span","video","object","iframe","code","a","img","link","script"]),n=["div","img","html","span"],a=[],o=0;for(y=0;y<s.length;y++){var r=n.indexOf(s[y])!==-1?"<"+s[y]+"[^>]*>":"<"+s[y]+"[^>]*>([\\w\\W]*?)</"+s[y]+">",p=t.match(new RegExp(r,"gi"));if(p!==null)for(var d=0;d<p.length;d++)t=t.replace(p[d],"#####replaceparse"+o+"#####"),a.push(p[d]),o++}if((t=!(t=t.replace("&amp;","&")).match(this.opts.regex.aurl1)&&!t.match(this.opts.regex.aurl2)||t.match(this.opts.regex.imageurl)?t:this._formatLinks(t)).match(this.opts.regex.imageurl))for(var m=t.match(this.opts.regex.imageurl),y=0;y<m.length;y++)t=t.replace(m[y],this._splitBlock(e,'<img src="'+m[y]+'">'));t=this._restoreReplaced(a,t),t=this.app.content.restoreComments(t,i),t=this._restoreReplaced(a,t)}return t},_splitBlock:function(t,e){return t?`
`+e+`
`:e},_formatLinks:function(t){var e=this.opts.paste.linkTarget!==!1?' target="'+this.opts.paste.linkTarget+'"':"",i=this.opts.editor.https?"https":"http",s=this;return t=(t=t.replace(this.opts.regex.aurl1,function(n){return'<a href="'+n+'"'+e+">"+s._subLinkText(n)+"</a>"})).replace(this.opts.regex.aurl2,function(n,a,o){return a+'<a href="'+i+"://"+o+'"'+e+">"+s._subLinkText(o)+"</a>"})},_subLinkText:function(t){return t=(t=t.length>this.opts.link.size?t.substring(0,this.opts.link.size)+"...":t).search("%")===-1?decodeURIComponent(t):t},_restoreReplaced:function(t,e){for(var i=0;i<t.length;i++)e=e.replace("#####replaceparse"+i+"#####",t[i]);return e}}),l.add("module","caret",{set:function(i,e){var i=this.dom(i).get(),s=this.app.editor.getDocNode().createRange();i&&this._isInPage(i)&&(this.app.editor.setWinFocus(),this._isInline(i)&&this._isNon(i)&&(e==="start"?e="before":e==="end"&&(e="after")),this[{start:"_setStart",end:"_setEnd",before:"_setBefore",after:"_setAfter"}[e]](s,i),this.app.selection.setRange(s))},is:function(a,e,i,s,n){var a=this.dom(a).get(),o=this.app.editor.getWinNode().getSelection(),r=!1;return a&&o.isCollapsed&&(o=this._getPosition(a,s,n),n=this._getSize(a,i,s),e==="end"?r=o===n:e==="start"&&(r=o===0)),r},_setStart:function(t,e){t.setStart(e,0),t.collapse(!0);var i=this._getInlineInside(e);i&&(t=this._setStartInline(t,i)),this._isInline(e)&&this._insertInvisibleNode(t)},_setStartInline:function(t,e){e=this.app.element.getAllInlines(e)[0],t.selectNodeContents(e),t.collapse(!0)},_setEnd:function(t,e){var i=e.nodeType===1&&e.lastChild,s=i&&this._isInline(i);t.selectNodeContents(e=s?i:e),t.collapse(!1)},_setBefore:function(t,e){t.setStartBefore(e),t.collapse(!0),this._isInline(e)&&this._insertInvisibleNode(t,e)},_setAfter:function(t,e){t.setStartAfter(e),t.collapse(!0);var i=e.nodeType!==3&&e.tagName.toLowerCase();!this._isInline(e)&&i!=="br"&&i!=="svg"||this._insertInvisibleNode(t)},_insertInvisibleNode:function(t,e){var i=this.app.utils.createInvisibleChar();return e?e.parentNode.insertBefore(i,e):t.insertNode(i),t.selectNodeContents(i),t.collapse(!1),i},_getInlineInside:function(t){if(t=t.firstChild,this._isInline(t)){for(var e=t.firstChild;e;){if(this._isInline(e))return e;e=e.firstChild}return t}},_getSize:function(t,e,i){var s,n=t.nodeType===3,a=e&&e.length!==0?((s=this.dom(t).clone()).find(e.join(",")).remove(),s.html().trim()):(a=n?t.textContent:t.innerHTML,n||i===!1?a:a.trim());return this._trimmed(a,n,i).length},_getPosition:function(o,e,i){var r=this.app.editor.getWinNode().getSelection().getRangeAt(0),s=r.cloneRange(),n=document.createElement("div"),a=o.nodeType===3,o=(s.selectNodeContents(o),s.setEnd(r.endContainer,r.endOffset),n.appendChild(s.cloneContents()),a||e===!1?n.innerHTML:n.innerHTML.trim()),r=o.search(/<\/?br\s?\/?>$/g)!==-1?1:0;return i===!1&&(r=0),(o=this._trimmed(o,a,e)).length+r},_trimmed:function(t,e,i){return i===!1?t.replace(/\n$/g,""):(t=(t=(t=this.app.utils.removeInvisibleChars(t)).replace(/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,"")).replace(/\s+/g," "))===""||e?t:t.replace(/\s$/,"")},_isInline:function(t){return this.app.element.is(t,"inline")},_isInPage:function(t){var e=!1,i=this.app.editor.getDocNode();return e=t&&t.nodeType?t!==i.body&&i.body.contains(t):e},_isNon:function(t){return t.getAttribute("contenteditable")==="false"}}),l.add("module","selection",{init:function(){this.savedSelection=!1,this.savedMarker=!1,this.savedPosition=!1,this.savedRange=!1},get:function(){var t=this._getSelection(),e=this._getRange(t),i=this._getCurrent(t);return{selection:t,range:e,collapsed:this._getCollapsed(t,e),current:i,parent:this._getParent(i)}},getRange:function(){return this._getRange(this.get().selection)},getNodes:function(t){var e=this.get(),i=t&&(t.type&&t.type==="inline"||t.tags&&t.tags.indexOf("a")!==-1),s=i?"_getAllRangeNodes":"_getRangeNodes",n=[];return 0<(n=this.app.editor.isAllSelected()?this.app.editor.getLayout().children().getAll():e.selection&&e.range?this[s](e.range):n).length?this._filterNodes(n,e.range,i,t):n},getCurrent:function(){var t=this._getSelection();return this._getCurrent(t)},getParent:function(){var t=this.getCurrent();return this._getParent(t)},getElement:function(t){return this._getElement(t,"element")},getInline:function(t){return this._getElement(t,"inline")},getTopInline:function(t){for(var e=t?this.dom(t).get():this.getCurrent(),i=[];e&&this._getElement(e,"inline");)i.push(e),e=e.parentNode;return i[i.length-1]},getDataBlock:function(t){var e=this._getSelection(),i=t||this._getCurrent(e);if(i)for(i=this.dom(i).get();i;){if(i.nodeType===1&&i.getAttribute("data-"+this.prefix+"-type"))return this.dom(i);i=i.parentNode}return this.dom()},getBlock:function(t){return this._getElement(t,"block")},getText:function(t,e){var i,s,n=this.get(),a=!1;return!!n.selection&&(t&&n.range?(e=e===void 0?1:e,i=this.app.editor.getLayout().get(),s=n.range.cloneRange(),t==="before"?(s.collapse(!0),s.setStart(i,0),a=s.toString().slice(-e)):t==="after"&&(s.selectNodeContents(i),s.setStart(n.range.endContainer,n.range.endOffset),a=s.toString().slice(0,e))):a=n.selection?n.selection.toString():"",a)},getHtml:function(){var t,e="",i=this.get();return i.selection&&(i=i.range.cloneContents(),(t=document.createElement("div")).appendChild(i),e=(e=t.innerHTML).replace(/<p><\/p>$/i,"")),e},getPosition:function(){var t,e=this.getRange(),i={top:0,left:0,width:0,height:0};return this.app.editor.getWinNode().getSelection&&e.getBoundingClientRect&&(t=(e=e.cloneRange()).startOffset-1,e.setStart(e.startContainer,t<0?0:t),i={top:(t=e.getBoundingClientRect()).top,bottom:t.bottom,left:t.left,width:t.right-t.left,height:t.bottom-t.top}),i},set:function(t,e){t&&(t.removeAllRanges(),t.addRange(e))},setRange:function(t){this.set(this.app.editor.getWinNode().getSelection(),t)},is:function(t){if(t===void 0)return this.get().selection;for(var e=this.dom(t).get(),i=this.getNodes(),s=0;s<i.length;s++)if(i[s]===e)return!0;return!1},isCollapsed:function(){var t=this.get();return this._getCollapsed(t.selection,t.range)},isIn:function(e){var e=this.dom(e).get(),i=this.getCurrent();return!(!i||!e)&&e.contains(i)},isAll:function(e){var n=!e,e=(e?this.dom(e):this.app.editor.getLayout()).get(),i=this.app.editor.getWinNode().getSelection(),s=this._getRange(i),n=n||this.is(e);return!i.isCollapsed&&!!n&&e.textContent!==void 0&&e.textContent.trim().length===s.toString().trim().length},select:function(e){var e=(e?this.dom(e):this.app.editor.getLayout()).get(),i=this.app.editor.getDocNode().createRange();i.selectNodeContents(e),this.setRange(i)},removeAllRanges:function(){var t=this._getSelection();t&&t.removeAllRanges()},deleteContents:function(){var t=this.getRange();!this.isCollapsed()&&t&&t.deleteContents()},collapse:function(t){t=t||"start";var e=this.get();e.selection&&!e.collapsed&&(t==="start"?e.selection.collapseToStart():e.selection.collapseToEnd())},save:function(t){var e;t||(t=(e=this.app.block.get())?e.getBlock():this.app.editor.getLayout()),this.savedSelection={el:t,offset:this.app.offset.get(t)}},restore:function(t){var e;this.savedMarker||this.savedSelection&&(this.app.editor.setWinFocus(),e=this.savedSelection.el,this.dom(e).dataget("instance")&&t!==!1&&this.app.block.set(e),e&&(e.focus(),this.app.offset.set(e,this.savedSelection.offset)),this.savedSelection=!1)},saveMarker:function(){this.savedMarker=!0,this.app.marker.insert()},restoreMarker:function(){this.app.marker.restore(),this.savedMarker=!1,this.savedSelection=!1},_getSelection:function(){return this.app.editor.getSelection()},_getRange:function(t){return!!t&&0<t.rangeCount&&t.getRangeAt(0)},_getCurrent:function(t){return!!t&&t.anchorNode},_getParent:function(t){return!!t&&t.parentNode},_getElement:function(t,e){var i=this._getSelection();if(i)for(var s=t||this._getCurrent(i),s=this.dom(s).get();s;){if(this.app.element.is(s,e))return s;s=s.parentNode}return!1},_getCollapsed:function(t,e){var i=!1;return i=t&&t.isCollapsed||e&&e.toString().length===0?!0:i},_getNextNode:function(t){if(t.firstChild)return t.firstChild;for(;t;){if(t.nextSibling)return t.nextSibling;t=t.parentNode}},_getRangeNodes:function(t,e){var i,s=t.startContainer.childNodes[t.startOffset]||t.startContainer,n=t.endContainer.childNodes[t.endOffset]||t.endContainer,a=t.commonAncestorContainer,o=[];if(e){for(this.app.editor.isLayout(s)||o.push(s),i=s.parentNode;i&&!this.app.editor.isLayout(i)&&(o.push(i),i!==a);i=i.parentNode);for(o.reverse(),i=s;i&&(i.nodeType===3||this.dom(i.parentNode).closest(a).length!==0)&&(o.push(i),i!==n);i=this._getNextNode(i));}else for(s.nodeType===3&&o.push(this.getBlock(s)),i=s;i&&i!==a&&(i.nodeType===3||this.dom(i.parentNode).closest(a).length!==0)&&(o.push(i),i!==n);i=this._getNextNode(i));return o},_getAllRangeNodes:function(t){return this._getRangeNodes(t,!0)},_filterNodes:function(t,e,i,s){for(var n=(n=this.getText())?n.replace(/[-[\]/{}()*+?.\\^$|]/g,"\\$&"):"",a=[],o=0;o<t.length;o++){var r=!0;this.app.editor.isLayout(t[o])&&(r=!1),s&&(r=s.types?this._filterByTypes(r,s,t[o]):r,r=s.selected?this._filterBySelected(r,s,t[o],e,n):r,r=s.type?this._filterByType(r,s,t[o],i):r,r=s.tags?this._filterByTags(r,s,t[o]):r),r&&a.push(t[o])}var p=[];if(s&&(s.type==="blocks"||s.type==="blocks-first")){for(var d,m=0;m<a.length;m++)s.type==="blocks-first"?d=this.app.element.is(a[m],"blocks-first")?a[m]:this.app.element.getFirstLevel(a[m]).get():s.type==="blocks"&&(d=this.app.element.is(a[m],"blocks")?a[m]:this.app.element.getDataBlock(a[m]).get()),this._isInNodesArray(p,d)||p.push(d);a=p}return a},_filterByTypes:function(t,e,i){var s;return e.types===!0?(s=this.app.element.getType(i))||(t=!1):(s=this.app.element.getType(i),e.types.indexOf(s)===-1&&(t=!1)),t},_filterByType:function(t,e,i,s){var n=e.type;return n!=="blocks"&&n!=="blocks-first"||(n="block"),!s||e.links?this.app.element.is(i,n)||(t=!1):(i.nodeType!==1||i.tagName!=="A")&&this.app.element.is(i,n)||(t=!1),t},_filterByTags:function(t,e,i){var s=i.tagName!==void 0;return t=s&&e.tags.indexOf(i.tagName.toLowerCase())!==-1?t:!1},_filterBySelected:function(t,e,i,s,n){return e.selected!==!0||this._containsNodeText(s,i)?e.selected==="inside"&&(i.nodeType===1&&i.tagName==="A"?t=!0:this._isTextSelected(i,n)||(t=!1)):t=!1,t},_isTextSelected:function(t,e){return t=t.nodeType!==9?this.app.utils.removeInvisibleChars(t.textContent):"",e===t||t.search(e)!==-1||e.search(new RegExp("^"+this.app.utils.escapeRegExp(t)+"$"))!==-1},_isBackwards:function(){var t,e=!1,i=this.get();return i&&!i.collapsed&&((t=this.app.editor.getDocNode().createRange()).setStart(i.selection.anchorNode,i.selection.anchorOffset),t.setEnd(i.selection.focusNode,i.selection.focusOffset),e=t.collapsed,t.detach()),e},_containsNodeText:function(t,e){for(var i,s,n,a=this.app.editor.getDocNode().createTreeWalker(e,NodeFilter.SHOW_TEXT,{acceptNode:function(r){return NodeFilter.FILTER_ACCEPT}},!1);n=a.nextNode();)i=i||n,s=n;var o=t.cloneRange();return i?(o.setStart(i,0),o.setEnd(s,s.length)):o.selectNodeContents(e),t.compareBoundaryPoints(Range.START_TO_START,o)<1&&-1<t.compareBoundaryPoints(Range.END_TO_END,o)},_isInNodesArray:function(t,e){return t.indexOf(e)!==-1}}),l.add("module","inline",{removeFormat:function(){this.app.popup.close();for(var t=this.app.block.get().getBlock(),e=(this.app.selection.save(t),this.app.selection.getNodes({type:"inline"})),i=0;i<e.length;i++){var s=this.dom(e[i]);s.attr("data-"+this.prefix+"-type")||s.unwrap()}this.app.selection.restore(),this.app.editor.observeUI()},set:function(t){return this.app.popup.isOpen()&&this.app.popup.close(),this.params=t,t=[],t=this.app.selection.get().collapsed?this.formatCollapsed():this.formatUncollapsed(),this.app.editor.observeUI(),this.app.broadcast("inline.format",{nodes:t}),this.app.sync.trigger(),t},formatCollapsed:function(){var t,e,i,s,n=this.app.selection.getInline(),a=this.dom(n),o=this._getParamsTags(),o=this._isSameTag(n,o),r=!(!this.params||!this.params.caret)&&this.params.caret;return n?this.app.content.isEmptyHtml(n.innerHTML)?o?(this.app.caret.set(n,r||"after"),a.remove()):(e=this.app.element.replaceToTag(n,this.params.tag),this.app.caret.set(e,r||"start")):o?(this.app.caret.is(e=n,"end")?r="after":(o=this.app.content.extractHtmlFromCaret(n),i=this.dom("<"+this.params.tag+" />"),i=this.app.element.cloneAttrs(n,i),a.after(i.append(o)),e=i),this.app.caret.set(e,r||"before")):t=this._insertInline(this.params.tag,r):t=this._insertInline(this.params.tag,r),t&&this.params&&this.params.attr!==void 0&&(s=this.dom(t),Object.keys(this.params.attr).forEach((function(p){s.attr(p,this.params.attr[p])}).bind(this))),t||[]},formatUncollapsed:function(){for(var t=this.app.block.get(),e=this._getBlock(t),i=(this.app.selection.save(),this._convertTags("u",t),this._convertTags("del",t),this.app.selection.restore(),this.app.selection.getNodes({type:"inline"})),s=(this.app.selection.save(),this._convertToStrike(i),this.app.selection.restore(),this.app.selection.save(),this.app.editor.getDocNode().execCommand("strikethrough"),this._revertToInlines(t)),n=(this.app.selection.restore(),[]),a=this.app.selection.getText(),o=0;o<s.length;o++)this._isInSelection(s[o],a)&&n.push(s[o]);if(this._clearEmptyStyle(),this.params&&this.params.attr!==void 0)for(var r=0;r<n.length;r++)this._applyAttrs(n[r]);return e.length===1&&e.get().normalize(),this.app.selection.save(),this._revertTags("u",t),this._revertTags("del",t),this.app.selection.restore(),this.params&&this.params.caret&&this.app.caret.set(n[n.length-1],this.params.caret),n},_applyAttrs:function(t){Object.keys(this.params.attr).forEach((function(e){t.setAttribute(e,this.params.attr[e])}).bind(this))},_clearEmptyStyle:function(){for(var t=this.app.selection.getNodes({type:"inline"}),e=0;e<t.length;e++){this._clearEmptyStyleAttr(t[e]);var i=t[e].childNodes;if(i)for(var s=0;s<i.length;s++)this._clearEmptyStyleAttr(i[s])}},_clearEmptyStyleAttr:function(t){t.nodeType!==3&&t.getAttribute("style")===""&&t.removeAttribute("style")},_isSameTag:function(t,e){return t&&e.indexOf(t.tagName.toLowerCase())!==-1},_isInSelection:function(t,e){return t=this.app.utils.removeInvisibleChars(t.textContent),e=(e=e.replace(/\n/g,"")).replace(/\s/g,""),t=t.replace(/\s/g,""),e.search(new RegExp(this.app.utils.escapeRegExp(t)))!==-1},_insertInline:function(t,e){return this.app.insertion.insertNode(document.createElement(t),e||"start")},_convertTags:function(t,e){this.params.tag!==t&&this._getBlock(e).find(t).each((function(i){this.app.element.replaceToTag(i,"span").addClass(this.prefix+"-convertable-"+t)}).bind(this))},_revertTags:function(t,e){this._getBlock(e).find("span."+this.prefix+"-convertable-"+t).each((function(i){i=this.app.element.replaceToTag(i,t),i.removeClass(this.prefix+"-convertable-"+t),this.app.element.removeEmptyAttrs(i,["class"])&&i.removeAttr("class")}).bind(this))},_convertToStrike:function(t){for(var e=this._getParamsTags(),i=0;i<t.length;i++){var s=t[i],s=this.dom(s),n=t[i].tagName.toLowerCase();e.indexOf(n)!==-1&&this._replaceToStrike(s)}},_getParamsTags:function(){var t=[this.params.tag];return this.params.tag==="b"||this.params.tag==="strong"?t=["b","strong"]:this.params.tag!=="i"&&this.params.tag!=="em"||(t=["i","em"]),t},_replaceToStrike:function(t){t.replaceWith((function(){return this.dom("<strike>").append(t.html())}).bind(this))},_revertToInlines:function(i){var e=[],i=this._getBlock(i);return i.find("*").each((function(s){s.get().style.textDecorationLine&&(s.css("text-decoration-line",""),s.wrap("<u>"),s.attr("style")==="")&&s.removeAttr("style")}).bind(this)),i.find("strike").each((function(s){s=this.app.element.replaceToTag(s,this.params.tag),e.push(s.get())}).bind(this)),e},_getBlock:function(t){return this.app.editor.isBlocksSelection()?this.dom(this.app.blocks.getSelectedBlocks()):t.getBlock()}}),l.add("module","popup",{init:function(){this.stack=!1,this.stacks=[],this.name=!1,this.supername=!1,this.autoclose=!0,this.control=!1,this.saved=!1},start:function(){this._build(),this._buildDepth()},stop:function(){this._stopEvents(),this._stop()},stopStack:function(){this._stopEvents(),this.app.toolbar.unsetToggled(),this.$popup.removeAttr("data-"+this.prefix+"-popup-name"),this.$popup.removeClass("open")},isOpen:function(t){var e=this.$popup.hasClass("open");return(!t||this._getName()===t)&&e},create:function(t,e){return this.isOpen(t)||(this._reset(),this.name=t,this.supername=t,this.stack=this._createStack(t,e)),this.stack},add:function(t,e){return this._createStack(t,e,!0)},setStack:function(t){this.stack=t,this.name=t.getName()},setData:function(t){this.stack.setData(t)},setFocus:function(t){this.stack.setFocus(t)},setWidth:function(t){this.stack.setWidth(t)},getName:function(){return this.name},getElement:function(){return this.$popup},getButton:function(){return this.button},getStack:function(t){return t?this.stacks[t]:this.stack},getBody:function(){return this.stack.getBody()},getItems:function(){return this.stack.getItems()},getFooter:function(){return this.stack.getFooter()},getFooterPrimary:function(){return this.stack.getFooterPrimary()},getTool:function(t){return this.stack.getTool(t)},getInput:function(t){return this.stack.getInput(t)},getFormItem:function(t){return this.stack.getFormItem(t)},getData:function(t){return this.stack.getData(t)},open:function(t){this.isOpen()?this.isOpen(this.supername)?(this.saved=!0,this.close(!1)):(this.saved=!0,this.close(!1),this._open(t,!1)):(this.saved=!1,this._open(t))},openStack:function(e){var e=this.getStack(e),i={};this.stack&&this.stack.isCollapsed()&&(i={collapse:!0},this.removeStack(this.stack)),e.open(i)},close:function(t,e){this.autoclose===!1&&t!==!0&&!e||!this.isOpen()||t&&this._isPopupTarget(t)||(this._stopEvents(),this._resetToolbarToggledButton(),t!==!1&&this.saved===!1&&(this.app.scroll.save(),this.app.selection.restore(),this.app.scroll.restore()),this.$popup.hide(),this._closed())},closeStacks:function(){for(var t in this.stacks)typeof this.stacks[t]=="object"&&this.stacks[t].close()},removeStack:function(t){t=t.getName(),delete this.stacks[t],this.$popup.find("[data-"+this.prefix+"-stack-name="+t+"]").remove()},updatePosition:function(t){this._buildPosition(t),this._buildHeight()},resize:function(){var t=this.$popup.attr("data-width"),e=this.app.editor.getWidth();t!=="100%"&&parseInt(t)<e||this.$popup.css("width",e+"px")},_build:function(){this.$popup=this.dom("<div>").addClass(this.prefix+"-popup "+this.prefix+"-popup-"+this.uuid),this.$popup.hide(),this.$popup.attr("dir",this.opts.editor.direction),this.app.$body.append(this.$popup)},_buildDepth:function(){this.opts.bsmodal&&this.$popup.css("z-index",1061)},_buildButton:function(t){t&&(this.button=!!Object.prototype.hasOwnProperty.call(t,"button")&&t.button)},_buildControl:function(t){t&&(this.control=!!Object.prototype.hasOwnProperty.call(t,"control")&&t.control)},_buildName:function(){this.$popup.attr("data-"+this.prefix+"-popup-name",this.name),this.$popup.addClass(this.prefix+"-popup-"+this.name)},_buildHeader:function(){this.header=this.app.create("popup.header",this)},_buildHeight:function(){var t,e=this.app.scroll.getTarget(),i=this.$popup.offset(),i=this.app.scroll.isTarget()?(t=i.top-e.offset().top,e.height()-parseInt(e.css("border-bottom-width"))):(t=i.top-e.scrollTop(),e.height());this.$popup.css("max-height",i-t-10+"px")},_buildPosition:function(){var t=this._isButton()&&this.button.isControl()||this._isControl()?this._buildPositionControl():this._isButton()?this._buildPositionButton():this._buildPositionModal();this.$popup.css({top:t.top-1+"px",left:t.left+"px"})},_buildPositionButton:function(){var t=this.app.editor.getRect(),e=this.button.getOffset(),i=this.button.getDimension(),s=this.$popup.width(),n={};return this._isToolbarButton()||this._isTopbarButton()?(n={top:e.top+i.height,left:e.left}).left+s>t.right&&(n.left=e.left+i.width-s):(n={top:e.top+t.top+i.height,left:e.left+t.left+i.width/2-s/2}).left+s>t.right&&(n.left=t.left+t.width-s),(n.left<t.left||n.left<0)&&(n.left=t.left),n},_buildPositionControl:function(){var t=this.app.block.get(),t=(t=t.isSecondLevel()?t.getFirstLevel():t).getBlock().offset();return{top:t.top,left:t.left}},_buildPositionModal:function(){var t,e;return e=(t=this.opts.toolbar?(t=(e=this.app.container.get("toolbar")).height(),(e=e.offset()).top+t):(e=(t=(t=this.app.block.get()).isSecondLevel()?t.getFirstLevel():t).getBlock().offset()).top,e.left),{top:t,left:e}},_getName:function(){return this.$popup.attr("data-"+this.prefix+"-popup-name")},_setToolbarToggledButton:function(){var t;this.app.toolbar.unsetToggled(),this._isToolbarButton()&&(t=this.button.getName(),this.app.toolbar.setToggled(t))},_createStack:function(t,e,i){return Object.prototype.hasOwnProperty.call(e,"collapse")&&e.collapse===!1&&(i=!1),Object.prototype.hasOwnProperty.call(e,"autoclose")&&(this.autoclose=e.autoclose),e=this.app.create("popup.stack",t,e,i,this),this.stacks[t]=e},_open:function(t,e){this._buildButton(t),this._buildControl(t),this._buildName(),this._buildHeader(),this.app.broadcast("popup.before.open").isStopped()?this.stopStack():(this._setToolbarToggledButton(),this._startEvents(),e!==!1&&this.app.editor.isPopupSelection()&&this.app.selection.save(),this.stack=this._findActiveStack(),this.stack.open(t,!1,!1),this._buildPosition(),e===!1?(this.$popup.show(),this._opened()):this.$popup.fadeIn(100,this._opened.bind(this)))},_opened:function(){this._buildHeight(),this.$popup.addClass("open"),this.app.broadcast("popup.open"),this.stack.renderFocus()},_closed:function(){var t="data-"+this.prefix+"-popup-name",e=this.$popup.attr(t);this.$popup.removeAttr(t),this.$popup.removeClass("open "+this.prefix+"-popup-"+e),this.saved=!1,this.app.broadcast("popup.close")},_isPopupTarget:function(t){return this.dom(t.target).closest("."+this.prefix+"-popup").length!==0},_isButton:function(){return this.button},_isControl:function(){return this.control},_isToolbarButton:function(){return this.button&&(this.button.type==="toolbar"||this.button.type==="context")},_isTopbarButton:function(){return this.button&&this.button.type==="topbar"},_findActiveStack:function(){for(var t in this.stacks)typeof this.stacks[t]=="object"&&this.stacks[t].isActive()&&(this.stack=this.stacks[t]);return this.stack},_reset:function(){this.button=!1,this.control=!1,this.autoclose=!0,this.stack=!1,this.stacks=[],this.$popup.html(""),this.$popup.removeClass("has-footer has-items has-form")},_resetToolbarToggledButton:function(){var t;this.button&&(t=this.button.getName(),this.app.toolbar.unsetToggled(t))},_startEvents:function(){var t=this.prefix+"-popup";this.app.scroll.getTarget().on("resize."+t+" scroll."+t,this.updatePosition.bind(this))},_stopEvents:function(){this.app.scroll.getTarget().off("."+this.prefix+"-popup")},_stop:function(){this.$popup&&this.$popup.remove()}}),l.add("class","popup.item",{defaults:{container:!1,title:!1,html:!1,toggle:!0,active:!1,divider:!1,remover:!1,classname:!1,params:!1,instance:!1,observer:!1,command:!1},init:function(t,e,i){this.popup=t,this.name=e,this.params=this._buildParams(i),this._build(),this._buildContainer(),this._buildIcon(),this._buildTitle(),this._buildImage(),this._buildShortcut(),this._buildActive(),this._buildHidden(),this._buildDivider(),this._buildCommand(),this._buildRemover()},getPopup:function(){return this.popup},getName:function(){return this.name},getParams:function(){return this.params.params},getElement:function(){return this.$item},getInstance:function(){return this.params.instance},isControl:function(){return this.params.control},_build:function(){this.$item=this.params.html?this.dom(this.params.html):this.dom("<div>"),this.$item.addClass(this.prefix+"-popup-item "+this.prefix+"-popup-stack-item"),this.$item.attr({"data-name":this.name})},_buildContainer:function(){this.params.container&&this.$item.addClass(this.prefix+"-popup-item-container")},_buildTitle:function(){this.params.title&&(this.$title=this.dom("<span>").addClass(this.prefix+"-popup-item-title"),this.$title.html(this.lang.parse(this.params.title)),this.$item.append(this.$title))},_buildImage:function(){this.params.image&&(this.$image=this.dom("<span>").addClass(this.prefix+"-popup-item-image"),this.$image.html(this.params.image),this.$item.append(this.$image))},_buildIcon:function(){this.params.icon&&(this.$icon=this.dom("<span>").addClass(this.prefix+"-popup-item-icon"),this.opts.buttons.icons&&this.opts.buttons.icons[this.name]!==void 0?this.$icon.html(this.opts.buttons.icons[this.name]):this.params.icon===!0?this.$icon.addClass(this.prefix+"-icon-"+this.name):this.params.icon.search(/</)!==-1?this.$icon.html(this.params.icon):this.$icon.addClass(this.prefix+"-icon-"+this.params.icon),this.$item.append(this.$icon))},_buildShortcut:function(){var t;this.params.shortcut&&(t=/(Mac|iPhone|iPod|iPad)/i.test(navigator.platform)?"<b>&#8984;</b>":"ctrl",t=this.params.shortcut.replace("Ctrl",t),this.$shortcut=this.dom("<span>").addClass(this.prefix+"-popup-item-shortcut"),this.$shortcut.html(t),this.$item.append(this.$shortcut))},_buildParams:function(t){return c.extend({},!0,this.defaults,t)},_buildActive:function(){this.params.active&&this.$item.addClass("active")},_buildHidden:function(){this.params.hidden&&this.$item.addClass(this.prefix+"-popup-item-hidden")},_buildDivider:function(){this.params.divider&&this.$item.addClass(this.prefix+"-popup-item-divider-"+this.params.divider)},_buildCommand:function(){this.params.command&&(this.$item.on("click."+this.prefix+"-popup-item-"+this.uuid,this._catch.bind(this)),this.$item.attr("data-command",this.params.command))},_buildRemover:function(){var t;this.params.title&&this.params.remover&&((t=this.dom("<span>").addClass(this.prefix+"-popup-item-trash "+this.prefix+"-icon-trash")).attr("data-command",this.params.remover),t.on("click."+this.prefix+"-popup-item-"+this.uuid,this._catchRemover.bind(this)),this.$item.append(t))},_catchRemover:function(i){i.preventDefault(),i.stopPropagation();var e=this.dom(i.target).closest("."+this.prefix+"-popup-stack-item"),i=this.dom(i.target).closest("."+this.prefix+"-popup-item-trash").attr("data-command"),s=e.attr("data-name");this.app.api(i,this,s),e.fadeOut(200,function(n){n.remove()})},_catch:function(t){t.preventDefault(),t.stopPropagation();var e=this.dom(t.target).closest("."+this.prefix+"-popup-stack-item"),i=e.attr("data-name"),s=e.attr("data-command");this.popup.$items.find("."+this.prefix+"-popup-stack-item").removeClass("active"),this.params.toggle&&e.addClass("active"),this.app.api(s,this.getParams(),this,i,t)}}),l.add("class","popup.stack",{defaults:{active:!1,title:!1,type:!1,width:!1,setter:!1,getter:!1,builder:!1,observer:!1,instance:!1,collapse:!1,form:!1,items:!1,focus:!1,footer:!1},init:function(t,e,i,s){this.defaultWidth="240px",this.popup=s,this.name=t,this.tools={},this.data=!1,this.items=!1,this.formitems=!1,this.params=c.extend({},!0,this.defaults,e),i&&(this.params.collapse=!0),this._build(),this._observe()},set:function(t,e){this.params[t]=e},setData:function(t){this.data=t},setFocus:function(t){this.tools[t]!==void 0&&this.tools[t].setFocus()},setWidth:function(t){var e=this.app.popup.getElement();e.attr("data-width",t),t==="100%"&&(t=this.app.editor.getWidth()+"px"),e.css("width",t),this.app.$win.on("resize."+this.prefix+"-popup-"+this.uuid,this.popup.resize.bind(this.popup)),this.popup.resize()},setItemsData:function(t){this.items=t},get:function(t){return this.params[t]},getElement:function(){return this.$stack},getName:function(){return this.name},getBody:function(){return this.$body},getInstance:function(){return this.get("instance")},getItemsData:function(){return this.items},getItems:function(){return this.$items},getFooter:function(){return this.$footer},getFooterPrimary:function(){return this.$footer.find("."+this.prefix+"-form-button-primary")},getTool:function(t){return this.tools[t]!==void 0&&this.tools[t]},getInput:function(t){return t=this.getTool(t),t?t.getInput():this.dom()},getFormItem:function(t){return t=this.getTool(t),t?t.getInput().closest("."+this.prefix+"-form-item"):this.dom()},getData:function(t){var e;return t?this.tools[t]!==void 0&&(e=this.tools[t].getValue()):(e={},Object.keys(this.tools).forEach((function(i){e[i]=this.tools[i].getValue()}).bind(this))),e},hasForm:function(){return this.formitems},hasFooter:function(){return this.footerbuttons!==0},hasItems:function(){return this.items!==!1},isCollapsed:function(){return this.get("collapse")},isActive:function(){return this.get("active")},open:function(t,e,i){if(t&&t.focus&&this.set("focus",t.focus),this.popup.closeStacks(),this.app.popup.setStack(this),i!==!1&&this.app.broadcast("popup.before.open").isStopped())return void this.popup.stopStack();t&&t.collapse?(this._buildItems(),this._renderItems()):this.render(),this.popup.header.render(this.popup.stacks),this.popup.header.setActive(this),this.$stack.show(),this._renderWidth(),e!==!1&&this.renderFocus(),i!==!1&&this.app.broadcast("popup.open")},close:function(){this.$stack.hide()},collapse:function(){var t=this._getPrev();this.isCollapsed()&&this.popup.removeStack(this),t.open({collapse:!0})},render:function(){this._renderType(),this._renderItems(),this._renderForm(),this._renderFooter(),this._renderEnv()},renderFocus:function(){this.get("focus")&&this.setFocus(this.get("focus"))},_observe:function(){this.params.observer&&this.app.api(this.params.observer,this)},_getPrev:function(){var t,e;for(e in this.popup.stacks)if(this.popup.stacks.hasOwnProperty(e)){if(e===this.name)return t;t=this.popup.stacks[e]}},_build:function(){this._buildElement(),this._buildBody(),this._buildFooter(),this._buildParams()},_buildElement:function(){this.$stack=this.dom("<div>").addClass(this.prefix+"-popup-stack "+this.prefix+"-popup-stack-"+this.name),this.$stack.hide(),this.$stack.attr("data-"+this.prefix+"-stack-name",this.name),this.popup.getElement().append(this.$stack)},_buildBody:function(){this.$body=this.dom("<div>").addClass(this.prefix+"-popup-body"),this.$stack.append(this.$body)},_buildFooter:function(){this.$footer=this.dom("<div>").addClass(this.prefix+"-popup-footer"),this.$stack.append(this.$footer)},_buildParams:function(){this.params.width=this.params.width||this.defaultWidth,this.params.setter=this.params.setter||!1,this.params.getter=this.params.getter||!1,this.data=!!this.params.getter&&this.app.api(this.params.getter,this),this._buildItems()},_buildItems:function(){this.params.builder?this.items=this.app.api(this.params.builder,this):this.params.items&&(this.items=this.params.items)},_renderWidth:function(){this.setWidth(this.get("width"))},_renderType:function(){this.$stack.removeClass(this.prefix+"-popup-type-grid");var t=this.get("type");t&&this.$stack.addClass(this.prefix+"-popup-type-"+t)},_renderItems:function(){if(this.items)for(var t in this.$items?this.$items.html(""):(this.$items=this.dom("<div>").addClass(this.prefix+"-popup-items"),this.$body.append(this.$items)),this.items){var e;this.items.hasOwnProperty(t)&&(Object.prototype.hasOwnProperty.call(this.items[t],"observer")&&this.items[t].observer&&(e=this.app.api(this.items[t].observer,this.items[t],t,this))!==void 0&&(this.items[t]=e),this.items[t]!==!1)&&(e=this.app.create("popup.item",this,t,this.items[t]).getElement(),this._renderItemPosition(this.$items,e,this.items[t]))}},_renderItemPosition:function(t,e,i){var s;i.position?(i=i.position)==="first"?t.prepend(e):typeof i=="object"&&(s=i[i=Object.prototype.hasOwnProperty.call(i,"after")?"after":"before"],(s=this._findPositionElement(s,t))?s[i](e):t.append(e)):t.append(e)},_renderEnv:function(){var t=this.popup.getElement();t.removeClass("has-footer has-items has-form"),this.hasForm()&&t.addClass("has-form"),this.hasFooter()&&t.addClass("has-footer"),this.hasItems()&&t.addClass("has-items")},_renderForm:function(){this.formitems=this.get("form"),this.formitems&&(this.$form?this.$form.html(""):(this.$form=this.dom("<form>").addClass(this.prefix+"-popup-form"),this.$body.append(this.$form)),this._renderTools(),this._renderData(),this.$form.find("input[type=text],input[type=url],input[type=email]").on("keydown."+this.prefix+"-popup",(function(t){if(t.which===13)return t.preventDefault(),!1}).bind(this)))},_renderTools:function(){Object.keys(this.formitems).forEach((function(t){this._renderTool(t,this.formitems[t])}).bind(this))},_renderTool:function(t,i){var i=this.app.create("tool."+i.type,t,i,this,this.data),s=i.getElement();s&&(this.tools[t]=i,this.$form.append(s))},_renderData:function(){if(this.data)for(var t in this.data)this.tools[t]!==void 0&&this.tools[t].setValue(this.data[t])},_renderFooter:function(){this.footerbuttons=0;var t=this.get("footer");if(t)for(var e in this.$footer.html(""),t)t.hasOwnProperty(e)&&t[e]!==!1&&(e=this.app.create("popup.button",e,this,t[e]),this.$footer.append(e.getElement()),this.footerbuttons++)},_findPositionElement:function(t,e){var i;if(Array.isArray(t))for(var s=0;s<t.length&&(i=e.find("[data-name="+t[s]+"]")).length===0;s++);else i=e.find("[data-name="+t+"]");return i.length!==0?i:0}}),l.add("class","popup.button",{init:function(t,e,i){this.name=t,this.obj=i,this.popup=e,this.$button=this.dom("<button>").addClass(this.prefix+"-form-button"),this.$button.attr("data-name",this.name),this.$button.html(this.lang.parse(this.obj.title)),this.$button.dataset("instance",this),this._has("type")&&this.$button.addClass(this.prefix+"-form-button-"+this.obj.type),this._has("classname")&&this.$button.addClass(this.obj.classname),this._has("fullwidth")&&this.$button.addClass(this.prefix+"-form-button-fullwidth"),this._has("right")&&this.$button.addClass(this.prefix+"-form-button-push-right"),this.$button.on("click."+this.prefix+"-popup-button"+this.uuid,this._catch.bind(this))},getName:function(){return this.name},getElement:function(){return this.$button},invokeCommand:function(){this._invoke()},_has:function(t){return Object.prototype.hasOwnProperty.call(this.obj,t)},_catch:function(t){t.preventDefault(),t.stopPropagation(),this._has("command")?this._invoke(t):this._has("close")&&this.app.popup.close()},_invoke:function(t){this.app.api(this.obj.command,this.popup,this.name,t)}}),l.add("class","popup.header",{init:function(t){this.popup=t,this._build()},setActive:function(t){this.$headerbox.find("."+this.prefix+"-popup-header-item").removeClass("active"),this.$headerbox.find("[data-"+this.prefix+"-name="+t.getName()+"]").addClass("active")},render:function(t){this._reset(),0<this._buildItems(t)&&this._buildClose()},_build:function(){this.$header=this.dom("<div>").addClass(this.prefix+"-popup-header"),this.$headerbox=this.dom("<div>").addClass(this.prefix+"-popup-header-box"),this.$header.append(this.$headerbox),this.popup.getElement().prepend(this.$header)},_buildClose:function(){var t=this.dom("<span>").addClass(this.prefix+"-popup-close");t.one("click",this._catchClose.bind(this)),this.$header.append(t)},_buildItems:function(t){var e,i,s=Object.keys(t).length,n=0,a=0;for(e in t)t.hasOwnProperty(e)&&typeof t[e]=="object"&&(a++,(i=t[e].get("title"))?(n++,this._buildItem(t[e],i,s)):a===1&&1<s&&(n++,this._buildItem(t[e],"## popup.back ##",s)));return n},_buildItem:function(t,e,s){var s=1<s,n=s?this.dom("<a>").attr("href","#"):this.dom("<span>");s&&(n.dataset("stack",t),n.addClass(this.prefix+"-popup-header-item-link"),n.on("click",this._catchStack.bind(this))),n.attr("data-"+this.prefix+"-name",t.getName()),n.addClass(this.prefix+"-popup-header-item"),n.html(this.lang.parse(e)),this.$headerbox.append(n)},_reset:function(){this.$headerbox.html(""),this.$header.find("."+this.prefix+"-popup-close").remove()},_catchStack:function(e){e.preventDefault(),e.stopPropagation();var e=this.dom(e.target).dataget("stack"),i=this.app.popup.getStack();i.isCollapsed()&&this.app.popup.removeStack(i),e.open()},_catchClose:function(t){t.preventDefault(),t.stopPropagation(),this.popup.close()}}),l.add("module","editor",{start:function(){this._buildEditor(),this._buildBlurClass(),this._buildOptions(),this._buildContent()},stop:function(){this.app.$element.show()},load:function(){this._setFocusOnStart()},build:function(){this.app.blocks.build(),this.app.embed.build(),this.app.image.observeStates(),this.app.parser.buildPredefinedClasses(),this.app.broadcast("editor.build")},isEditor:function(t){return this.dom(t).get()===this.$editor.get()},isLayout:function(t){return this.isEditor(t)},isTextarea:function(){return this.opts.content===!1},isFocus:function(){return this.app.container.isFocus()},isAllSelected:function(){return this._classSelect("has")},isEmpty:function(t){return!(1<this.app.blocks.getFirstLevel().length)&&this.app.content.isEmptyHtml(this.$editor.html(),t)},isPopupSelection:function(){return!this.app.blocks.isMeta()},isBlocksSelection:function(){return this.app.blocks.isMeta()||this.app.blocks.is()||this.app.editor.isAllSelected()},addButton:function(t,e){this.opts.buttonsObj[t]=e,this.opts.buttons.editor.push(t)},selectAll:function(){var t,e;this.isAllSelected()||(this._classSelect("add"),this.app.block.unset(),this.app.blocks.unset(),this.app.toolbar.build(),this.app.control.close(),this.app.context.close(),t=this.app.blocks.getLast(),e=!1,t&&t.getType()==="layer"&&(e=t.getBlock()).attr("contenteditable",!0),this.app.selection.select(),this.app.broadcast("editor.select"),e&&setTimeout(function(){e.attr("contenteditable",!1)},0))},unselectAll:function(){this.isAllSelected()&&(this.unsetSelectAll(),this.app.block.unset(),this.app.blocks.unset(),this.app.broadcast("editor.unselect"))},unsetSelectAll:function(){this._classSelect("remove")},observeBlocks:function(s){this.blocks=[];var e,i,s=this.app.blocks.getSelectedBlock(s),n=(this.app.editor.setFocus(),this.app.blocks.getSelectedBlocks());n.length===1?this.app.block.set(s):this.app.selection.isAll()?(e=this.app.blocks.getBlocks(),i=this.app.selection.getNodes({type:"blocks-first"}),e.length===i.length?this.app.editor.selectAll():this.blocksSelection(n)):1<n.length?this.blocksSelection(n):this.app.block.set(s)},blocksSelection:function(t){this.app.block.unset(),this.app.blocks.set(t),this.app.toolbar.build()},insertContent:function(t){this.app.insertion.insertContent(t)},setContent:function(t){this.app.insertion.setContent(t)},setEmpty:function(){this.app.insertion.setContent({html:""})},setWinFocus:function(){},setFocus:function(t){if(t){var t=t===!0?"start":t,e=t==="start"?this.app.blocks.getFirst():this.app.blocks.getLast();this.app.block.set(e,t)}else if(!this.isFocus()){for(var i=0;i<c.instances.length;i++)c.instances[i]!==this.app&&c.instances[i].editor.setBlur();this.app.container.setFocus(),this.app.broadcast("editor.focus")}},setBlur:function(t){this.isFocus()&&this.$editor.get&&(this.app.broadcast("editor.before.blur",{e:t}).isStopped()?t&&t.preventDefault():(this.app.container.setBlur(),this.app.selection.removeAllRanges(),this.app.source.is()||(this.app.block.unset(),this.app.blocks.unset(),this.app.popup.close(!1),this.app.context.close(),this.app.control.close(),this.app.toolbar.build()),this.app.broadcast("editor.blur",{e:t})))},getContent:function(t){var e="",e=this.app.source.is()?this.app.source.getContent():(e=this._getContent(),t?this.app.tidy.parse(e):e);return e=this.app.content.decodeHref(e)},getSelection:function(){var t,e=this.getWinNode().getSelection();return 0<e.rangeCount&&(t=e.anchorNode,this.dom(t).closest("."+this.prefix+"-container-"+this.uuid).length!==0)&&e},getWinNode:function(){return this.app.$win.get()},getDocNode:function(){return this.app.$doc.get()},getEditor:function(){return this.$editor},getLayout:function(){return this.getEditor()},getWidth:function(){var t=this.getEditor(),e=parseInt(t.css("padding-left")),i=parseInt(t.css("padding-right"));return t.width()-e-i},getRect:function(){var s=this.$editor.offset(),t=this.$editor.width(),e=this.$editor.height(),i=Math.round(s.top),s=Math.round(s.left);return{top:i,left:s,bottom:i+e,right:s+t,width:t,height:e}},getButtonsFromArr:function(t){var e={};if(!Array.isArray(t)&&typeof t=="object")return t;if(t)for(var i=c.extend(!0,{},this.opts.buttonsObj),s=0;s<t.length;s++){var n=t[s];i[n]!==void 0&&(e[n]=i[n])}return e},observeUI:function(){this.app.toolbar.observe(),this.app.context.observe()},enableUI:function(){this.app.toolbar.enable(),this.app.toolbar.enableSticky()},disableUI:function(){this.app.popup.close(),this.app.control.close(),this.app.context.close(),this.app.toolbar.disable(),this.app.toolbar.disableSticky()},_buildEditor:function(){this.app.$element.hide(),this.$editor=this.dom("<div>"),this.$editor.addClass(this.prefix+"-editor "+this.prefix+"-reset "+this.prefix+"-"+this.opts.editor.classname),this.$editor.attr("contenteditable",!0);var t=this.opts.paddingNormal;(this.opts.control||this.opts.reorder)&&(t=this.opts.paddingControl),this.$editor.css("padding",t),this.app.container.get("editor").append(this.$editor)},_buildBlurClass:function(){this.app.container.setBlur()},_buildOptions:function(){var t=this.$editor,e=this.opts.editor;this.opts.code=this.opts.pre,t.attr("dir",e.direction),e.minHeight&&t.css("min-height",e.minHeight),e.maxHeight&&t.css({"max-height":e.maxHeight,overflow:"auto"}),e.notranslate&&t.addClass("notranslate"),e.spellcheck||t.attr("spellcheck",!1),e.grammarly||t.attr("data-gramm_editor",!1)},_buildContent:function(){var t=this._getContentValue(),t=this.app.broadcastHtml("editor.before.load",t),t=this.app.parser.parse(t,!0,!0),t=(this.$editor.html(t.get().childNodes),this.app.parser.unparse(this.$editor.html()));this.app.$element.val(t),this._load()},_buildDraggable:function(){this.app.$body.find("[data-"+this.prefix+"-drop-id]").each((function(t){t.attr("draggable",!0),t.on("dragstart",(function(e){var i=this.dom(e.target).attr("data-"+this.prefix+"-drop-id");e.dataTransfer.setData("item",i)}).bind(this))}).bind(this))},_load:function(){this.app.blocks.build(),this.app.event.build(),this.app.observer.build(),this.app.embed.build(),this.app.sync.build(),this.app.image.observeStates(),this._buildDraggable(),this.app.broadcast("editor.load")},_getContent:function(){var t=this.$editor.html();return this.app.parser.unparse(t)},_getContentValue:function(){return this.opts.content||this.app.$element.val()},_setFocusOnStart:function(){this.opts.editor.focus&&(this.setFocus(),this.setFocus(this.opts.editor.focus))},_classSelect:function(t){return this.$editor[t+"Class"](this.prefix+"-select-all")}}),l.add("module","parser",{build:function(t){return this.$layout=this.dom("<div>"),this.$layout.html(t),this.$layout.find("[data-"+this.prefix+"-type]").each(this._build.bind(this)),this.$layout},buildPredefinedClasses:function(t){var e,i,s;this.opts.classes&&(t=t||this.app.editor.getEditor(),e=this.app.content,i=!(s=!0),(s=this.opts.classes.blocks!==void 0&&(i=!0,this.opts.classes.tags===void 0)?!1:s)&&t.find(e.getPredefinedTags().join(",")).each(e.addPredefinedTagClass.bind(this)),i)&&(s=e.getPredefinedBlocks(),s="["+(i="data-"+this.prefix+"-type")+"="+s.join("],["+i+"=")+"]",t.find(s).each(e.addPredefinedBlockClass.bind(this)))},parse:function(t,e,i){return t=t.trim(),t=this.app.broadcastHtml("editor.before.parse",t),t=this.app.content.isEmptyHtml(t)?this.app.block.createHtml():(t=this._clean(t,i),this._parse(t)),t=this.app.broadcastHtml("editor.parse",t),e!==!1?this.build(t):t},parseLine:function(t,e){return t=t===" "?"&nbsp;":(t=(t=this.app.broadcastHtml("editor.before.parse",t)).replace(/\r?\n/g,"<br>"),t=this.app.content.encodeCode(t),t=this.app.content.sanitize(t),t=this.app.content.removeEmptySpans(t),t=this.app.content.addHttps(t),this.app.broadcastHtml("editor.parse",t)),e!==!1?this.build(t):t},unparse:function(t,e){var i={},s=this.app.content;return t=t.trim(),t=this.app.broadcastHtml("editor.before.unparse",t),s.isEmptyHtml(t)?"":(t=this._revertForms(t),t=this._revertFrames(t),t=s.store(t,"embed",i,0),t=s.addNofollow(t),t=s.removeMarkers(t),t=this.app.utils.removeInvisibleChars(t),t=s.recacheStyle(t),t=s.restore(t,"embed",i),t=s.removeEmptyAttrs(t,["style","class","rel","alt","title"]),t=this._unparseAllTags(t),t=this._unparseDataType(t,e),t=s.removeEmptyAttrs(t,["style","class","rel","alt","title"]),this.opts.classes&&(t=this.app.utils.wrap(t,this.buildPredefinedClasses.bind(this))),this.app.broadcastHtml("editor.unparse",t=t==="<p></p>"?"":t))},_build:function(t){var e=t.attr("data-"+this.prefix+"-type");this.app.create("block."+e,t)},_clean:function(t,e){var i={},s=[],n=this.app.content;return t=(t=n.storeComments(t,s)).replace(/¤t/gi,"&current"),e&&this.app.editor.isTextarea()&&(t=n.encodeCode(t)),t=n.sanitize(t),t=this._convertForms(t),t=this._convertFrames(t),t=n.store(t,"embed",i,0),t=n.removeTags(t,this.opts.tags.denied),t=n.removeDoctype(t),t=n.removeTagsWithContent(t,["script","style"]),t=n.removeEmptySpans(t),t=n.addHttps(t),t=n.removeBlockTagsInside(t,["th","td","li","dt","dd","address"]),t=n.cacheStyle(t),t=n.restore(t,"embed",i),t=n.restoreComments(t,s),this.opts.clean.comments&&(t=n.removeComments(t)),t=n.isEmptyHtml(t)?this.app.block.createHtml():n.paragraphize(t)},_parse:function(t){return this.app.utils.wrap(t,(function(e){for(var i=this.app.element.getBlocks(e),s=0;s<i.length;s++)this._parseHtml(i[s]);this.buildPredefinedClasses(e)}).bind(this))},_parseHtml:function(i){var e=i.tagName.toLowerCase(),i=this.dom(i),s=this._parseType(i,e);s&&(i.attr("data-"+this.prefix+"-type",s),s==="image"&&e!==this.opts.image.tag&&(i=this.app.element.replaceToTag(i,this.opts.image.tag,!0)),s==="layer")&&this._parseNested(i)},_parseNested:function(t){for(var e=this.app.element.getBlocks(t),i=0;i<e.length;i++)this._parseHtml(e[i])},_parseType:function(t,e){return t=t.attr("data-"+this.prefix+"-type")?t.attr("data-"+this.prefix+"-type"):this._parseTypeByTag(t,e),t},_parseTypeByTag:function(t,e){var i;switch(e){case"p":i="paragraph",this._isImageBlock(t,"p")&&(i="image");break;case"figure":i="embed",this._isImageBlock(t,"figure")?i="image":this._hasChild(t,"pre")?i="pre":this._hasChild(t,"blockquote")&&(i="quote");break;case"div":i="layer",this._isImageBlock(t,"div")&&(i="image");break;case"h1":case"h2":case"h3":case"h4":case"h5":case"h6":i="heading";break;case"blockquote":i="quote";break;case"table":i="table";break;case"pre":i="pre";break;case"hr":i="line";break;case"dl":i="dlist";break;case"address":i="address";break;case"ul":case"ol":i="list";break;default:i="layer"}return i},_isImageBlock:function(t,e){var i=t.find("img");if(i.length!==0&&(e!=="div"||i.closest("figure").length===0)){var s=i,i=i.parent(),n=i.length!==0&&i.get().tagName;if(!n||n!=="A"&&n!=="SPAN"){if(n&&i.get()!==t.get())return}else s=i;if(s.prevElement().length===0&&(e==="figure"||s.nextElement().length===0))return!0}},_hasChild:function(t,e){if(e==="pre"){if(t.find("pre").length!==0)return!0}else if(e==="blockquote"&&(e=t.find("blockquote"),t.find("script").length===0&&e.length!==0))return!0},_unparseAllTags:function(t){return this.app.utils.wrap(t,(function(e){e.find("*").removeAttr("contenteditable data-gramm_editor"),this.opts.image.states||e.find("img").removeAttr("data-image")}).bind(this))},_unparseDataType:function(t,e){return this.app.utils.wrap(t,(function(i){var s=i.find("[data-"+this.prefix+"-type]");e!==!0&&s.removeClass(this.prefix+"-block-state"),s.removeAttr("tabindex data-"+this.prefix+"-parsed data-"+this.prefix+"-first-level"),s.removeClass(this.prefix+"-block-focus "+this.prefix+"-block-multiple-focus "+this.prefix+"-block-multiple-hover "+this.prefix+"-editable-pause"),s.removeClass(this.prefix+"-nowrap"),s.each(this._unparseByType.bind(this)),s.removeAttr("data-"+this.prefix+"-type"),i.find("figcaption").removeAttr("data-"+this.prefix+"-type data-placeholder").each(this.app.content._removeEmptyTag.bind(this))}).bind(this))},_unparseByType:function(t){var e=t.attr("data-"+this.prefix+"-type");e==="embed"?this._unparseEmbed(t):e==="list"&&this._unparseList(t)},_unparseEmbed:function(t){var e,i=decodeURI(t.attr("data-embed-code")),s=t.find("."+this.opts.embed.responsive),n=t.find("figcaption");n.length!==0&&(e=n.clone(),n.remove()),(s.length===0?t:s).html(i),e&&t.append(e),t.removeAttr("data-embed-code")},_unparseList:function(t){this.app.content.unfixListMargin(t)},_convertFrames:function(t){return this.app.utils.wrap(t,(function(e){e.find("iframe").each(this._convertFrame.bind(this))}).bind(this))},_convertFrame:function(t){t.closest("figure").length===0&&(t.wrap("<figure>"),t.parent().addClass(this.prefix+"-figure-iframe"))},_convertForms:function(t){return this.app.utils.wrap(t,(function(e){e.find("form").each(this._convertForm.bind(this))}).bind(this))},_convertForm:function(t){this.app.element.replaceToTag(t,"div").addClass(this.prefix+"-div-form")},_revertFrames:function(t){return this.app.utils.wrap(t,(function(e){e.find("."+this.prefix+"-figure-iframe").each(this._revertFrame.bind(this))}).bind(this))},_revertFrame:function(t){t.find("figcaption").length!==0?t.removeClass(this.prefix+"-figure-iframe"):t.unwrap()},_revertForms:function(t){return this.app.utils.wrap(t,(function(e){e.find("."+this.prefix+"-div-form").each(this._revertForm.bind(this))}).bind(this))},_revertForm:function(t){this.app.element.replaceToTag(t,"form").removeClass(this.prefix+"-div-form")}}),l.add("module","blocks",{init:function(){this.selected=[],this.focusclass=this.prefix+"-block-meta-focus"},start:function(){this.$editor=this.app.editor.getEditor()},build:function(){this._buildFirstLevel()},is:function(){return 0<this.selected.length},isMeta:function(){return 0<this.getSelected().length},set:function(t){this.selected=t},setMeta:function(t){t=t.closest("[data-"+this.prefix+"-first-level]"),this.app.block.unset(),this._classFocus(t,"add"),this.app.toolbar.build(),setTimeout((function(){this.app.selection.removeAllRanges()}).bind(this),0)},unset:function(){this._classFocus(this.getFirstLevel(),"remove"),this.selected=[]},getBlocks:function(){return this.$editor.find("[data-"+this.prefix+"-type]")},getFirstLevel:function(){return this.$editor.find("[data-"+this.prefix+"-first-level]")},getFirst:function(){return this.getBlocks().first().dataget("instance")},getLast:function(){return this.getBlocks().last().dataget("instance")},getFirstSelected:function(){return this.getSelected().first().dataget("instance")},getLastSelected:function(){return this.getSelected().last().dataget("instance")},getSelected:function(){return this.$editor.find("."+this.focusclass)},getSelectedBlocks:function(t){var e=this.app.selection.getNodes({type:"blocks"});if(t==="editable"){for(var i=[],s=0;s<e.length;s++){var n=this.dom(e[s]).dataget("instance").getType();["paragraph","heading","list","address"].indexOf(n)!==-1&&i.push(e[s])}e=i}return e},getSelectedBlock:function(t){var e=this.app.selection.getDataBlock();return e=t&&e.length===0?this.app.element.getDataBlock(t.target):e},getFirstSelectedBlock:function(){return 0<this.selected.length&&this.selected[0]},getLastSelectedBlock:function(){return 0<this.selected.length&&this.selected[this.selected.length-1]},removeSelected:function(t){var e,i=this.getLastSelected();t!==!1&&i&&(e=i.getNext()),this.getSelected().each(this._removeSelectedBlock.bind(this)),e&&this.app.block.set(e,"start")},_buildFirstLevel:function(){var t="data-"+this.prefix+"-first-level",e=this.app.editor.getEditor();e.find("["+t+"]").removeAttr(t),e.children("[data-"+this.prefix+"-type]").attr(t,!0)},_removeSelectedBlock:function(t){t.dataget("instance").remove({traverse:!1})},_classFocus:function(t,e){return t[e+"Class"](this.focusclass)}}),l.add("module","event",{init:function(){this.trigger=!0,this.imageDrag=!1,this.dragoverEvent=!1,this.isPopupMouseUp=!1,this.isEditorMouseUp=!1,this.isBlockMouseUp=!1,this.pasteEvent=!1,this.events={editor:["click","touchstart","mouseover","mouseup","mousedown","keyup","drop","dragstart","dragover","dragleave"],doc:["keydown","mousedown","mouseup","click","paste","cut","copy"],win:["focus"]}},build:function(){this.$editor=this.app.editor.getEditor(),this._buildPreventLinks(),this._buildEvents()},run:function(){this._buildEvents()},pause:function(){this._pauseEvents()},stop:function(){this._pauseEvents()},onmouseover:function(t){this.app.broadcast("editor.mouseover",{e:t})},ontouchstart:function(t){this.app.state.add(t)},onclick:function(t){this.app.broadcast("editor.click",{e:t}),this._isEditorClick(t)&&!this.isBlockMouseUp&&this._setByClick(t),t.detail===3&&setTimeout((function(){this._setBlockFocus(t,!0)}).bind(this),0)},onmouseup:function(t){!this.trigger||!this.isEditorMouseUp&&this._isEditorClick(t)||setTimeout((function(){this._observeBlockFocus(t),this.isEditorMouseUp=!1,this.app.broadcast("editor.mouseup",{e:t})}).bind(this),0)},onmousedown:function(t){this.app.placeholder.handleClick(t),this._isEditorClick(t)?this.isBlockMouseUp=!1:(this.isBlockMouseUp=!0,this._setCaretInline(t),this.isEditorMouseUp=!0,this.app.state.add(t),this.app.broadcast("editor.mousedown",{e:t}))},onkeyup:function(t){if(this.app.broadcast("editor.keyup",this._buildEventKeysObj(t)).isStopped())return t.preventDefault();var e,i=t.which;i!==this.app.keycodes.DOWN&&i!==this.app.keycodes.UP||(e=this.app.selection.getDataBlock()).length===0||this.app.block.is(e)||this.app.block.set(e),i===this.app.keycodes.BACKSPACE&&this.app.editor.isEmpty()&&this.app.editor.setEmpty(),i!==this.app.keycodes.TAB||this.app.block.is()||this._setBlock(t)},ondrop:function(t){var e,i,s;return!this.opts.editor.drop||this.app.broadcast("editor.drop",{e:t}).isStopped()?t.preventDefault():((s=(e=t.dataTransfer).getData("item"))!==""?(t.preventDefault(),(i=this.opts.draggable&&this.opts.draggable[s]!==void 0?this.opts.draggable[s]:(i=this.dom("[data-"+this.prefix+"-drop-item="+s+"]").html()).trim())&&this._drop(t,i,"after",!1)):this.opts.image&&this.opts.image.upload&&e.files!==null&&0<e.files.length?(t.preventDefault(),this.app.image.drop(t,e)):(i=(i=e.getData("text/html")).trim()===""?e.getData("Text"):i,s=this._drop(t,i),this.imageDrag&&s.instances.length!==0&&s.instances[0].change(this.imageDrag,!1)),this._removeDragPlaceholder(),this.imageDrag=!1,void(this.app.observer.trigger=!0))},ondragstart:function(t){var e=this._getBlock(t.target);e.length!==0&&this.app.element.getType(e)==="image"&&(this.imageDrag=e.dataget("instance")),this.app.broadcast("editor.dragstart",{e:t})},ondragover:function(t){var e,i;t.preventDefault(),this.dragoverEvent=!0,this.app.observer.trigger=!1,this._removeDragPlaceholder(),t.dataTransfer.types.indexOf("item")!==-1&&(e=this._getBlockFirst(t.target)).length!==0&&(i=this.dom("<div>").addClass(this.prefix+"-draggable-placeholder"),e.after(i)),this.app.broadcast("editor.dragover",{e:t})},ondragleave:function(t){t.preventDefault(),this.dragoverEvent=!0,this.app.observer.trigger=!0,this._removeDragPlaceholder(),this.app.broadcast("editor.dragleave",{e:t})},onwinfocus:function(){var t=this.app.block.get();t&&!t.isEditable()&&setTimeout((function(){this.app.selection.removeAllRanges()}).bind(this),0)},ondocpaste:function(t){this._isFocusEditor()&&this._paste(t)},ondoccopy:function(t){this._isFocusEditor()&&this._copy(t)},ondoccut:function(t){this._isFocusEditor()&&this._cut(t)},ondockeydown:function(t){if(this.app.popup.isOpen()){if(this._isEnter(t)){var e=this.app.popup.getStack();if(e.hasForm()!==!1&&t.target.tagName!=="TEXTAREA")return t.preventDefault(),void e.getFooterPrimary().dataget("instance").invokeCommand()}this._isEsc(t)&&this.app.popup.close(!1)}if(!this._isOutsideEditor(t)&&this.app.editor.isFocus()&&!this.app.popup.isOpen()&&!this.app.source.is()){if(e=this.app.broadcast("editor.keydown",this._buildEventKeysObj(t)),e.isStopped())return t.preventDefault();this.opts.editor.enterKey===!1&&t.which===13?t.preventDefault():this.app.state.listen(t)||(this._isEsc(t)&&(this.app.block.unset(),this.app.selection.removeAllRanges()),this.app.shortcut.handle(t))||this.app.input.handle(e)}},ondocmousedown:function(t){this.isPopupMouseUp=this.dom(t.target).closest("."+this.prefix+"-popup-"+this.uuid).length!==0,this.app.broadcast("editor.docmousedown",{e:t})},ondocmouseup:function(t){this.app.selection.is()&&!this.app.editor.isFocus()&&this._observeBlockFocus(t),this.app.broadcast("editor.docmouseup",{e:t})},ondocclick:function(t){if(!this.app.popup.isOpen()||!this._isEditorContainer(t))return!this._isOutsideEditor(t)||this.trigger===!1||void(this.isEditorMouseUp?this.isEditorMouseUp=!1:(this.app.popup.isOpen()?this.isPopupMouseUp===!1&&this.app.popup.close(!1):this.app.editor.setBlur(t),this.app.broadcast("editor.docclick",{e:t})));this.app.popup.close(!1)},_buildPreventLinks:function(){var t=this.prefix+"-prevent-events";this.$editor.on("click."+t+" dblclick."+t,this._preventLinks.bind(this))},_buildEventKeysObj:function(t){var e=t.which,i=[this.app.keycodes.UP,this.app.keycodes.DOWN,this.app.keycodes.LEFT,this.app.keycodes.RIGHT],s=!t.ctrlKey&&!t.metaKey&&(48<=e&&e<=57||65<=e&&e<=90),n=this.app.keycodes;return{e:t,key:e,ctrl:t.ctrlKey||t.metaKey,shift:t.shiftKey,alt:t.altKey,select:(t.ctrlKey||t.metaKey)&&!t.altKey&&e===65,enter:e===n.ENTER,space:e===n.SPACE,esc:e===n.ESC,tab:!(e!==n.TAB||t.shiftKey||t.altKey||t.ctrlKey||t.metaKey),delete:e===n.DELETE,backspace:e===n.BACKSPACE,alpha:s,arrow:i.indexOf(e)!==-1,left:e===n.LEFT,right:e===n.RIGHT,up:e===n.UP,down:e===n.DOWN,"left-right":e===n.LEFT||e===n.RIGHT,"up-left":e===n.UP||e===n.LEFT,"down-right":e===n.DOWN||e===n.RIGHT}},_buildEvents:function(){var t=this.prefix+"-events";this._buildTargetEvents(this.$editor,this.events.editor,t,""),this._buildTargetEvents(this.app.$doc,this.events.doc,t,"doc"),this._buildTargetEvents(this.app.$win,this.events.win,t,"win")},_buildTargetEvents:function(t,e,i,s){for(var n=0;n<e.length;n++)t.on(e[n]+"."+i,this["on"+s+e[n]].bind(this))},_pauseEvents:function(){var t=this.prefix+"-events";this.$editor.off("."+t),this.app.$doc.off("."+t),this.app.$win.off("."+t)},_preventLinks:function(t){this.dom(t.target).closest("a").length!==0&&t.preventDefault()},_isEditorClick:function(t){if(this.app.editor.isEditor(t.target))return t.preventDefault(),!0},_isEsc:function(t){return t.which===this.app.keycodes.ESC},_isEnter:function(t){return t.which===this.app.keycodes.ENTER},_isEditorContainer:function(t){return this.dom(t.target).closest("."+this.prefix+"-container-"+this.uuid).length!==0},_isOutsideEditor:function(t){return this.dom(t.target).closest("."+this.prefix+["-container-","-popup-","-toolbar-","-control-"].join(this.uuid+",."+this.prefix)+this.uuid).length===0},_isFocusEditor:function(){return!this.app.popup.isOpen()&&!this.app.source.is()&&(this.app.block.is()||this.app.blocks.is()||this.app.blocks.isMeta()||this.app.editor.isAllSelected())},_removeDragPlaceholder:function(){this.app.editor.getEditor().find("."+this.prefix+"-draggable-placeholder").remove()},_getBlock:function(t){return this.dom(t).closest("[data-"+this.prefix+"-type]")},_getBlockFirst:function(t){return this.dom(t).closest("[data-"+this.prefix+"-first-level]")},_observeBlockFocus:function(t){this.app.selection.isCollapsed()?this._setBlockFocus(t):this.app.editor.observeBlocks(t),this.app.toolbar.observe(),this.app.state.add(t)},_setByClick:function(t){var a=this.app.blocks.getFirstLevel(),e=[],i=(a.each(function(o){o=o.get().getBoundingClientRect(),e.push([o.x,o.y,o.y+o.height])}),[]),s=!1,n=(e.forEach(function(o,r){var p=parseInt(t.clientY),d=parseInt(t.clientX);o[1]<p&&p<o[2]?s=r:(r=Math.hypot(o[0]-d,o[1]-p),i.push(parseInt(r)))}),s!==!1?s:i.indexOf(Math.min.apply(Math,i))),a=a.eq(n);this.app.block.set(a.dataget("instance"),"start"),this.app.editor.setFocus()},_setBlock:function(e){this.app.editor.setFocus();var e=e?this._getBlock(e.target):this.app.selection.getDataBlock(),i=!1;e.length===0&&(e=this.app.blocks.getFirst(),i="start"),this.app.block.set(e,i)},_setBlockFocus:function(t,e){t=this._getBlock(t.target),t.length!==0&&(this.app.editor.setFocus(),e&&this.app.selection.select(t),this.app.block.set(t))},_setCaretInline:function(t){var e=this.app.block.get(),i=!1;e&&e.isEditable()&&(this.app.element.isEmptyOrImageInline(t.target)?this.app.caret.set(t.target,"after"):this.app.selection.isCollapsed()&&t.target.tagName==="CODE"&&(i=!0,setTimeout((function(){var s=this.app.selection.getElement();s&&i&&s.tagName!=="CODE"&&(this.app.caret.set(t.target,"start"),i=!1)}).bind(this),1)))},_drop:function(a,e,i,s){var n=(n=this.app.element[i==="after"?"getFirstLevel":"getDataBlock"](a.target)).length===0?this.app.blocks.getFirst():n,n=(this.app.block.set(n),i||this.app.insertion.insertPoint(a),!0),a=!0,o=this.app.block.get(),r=this.app.editor.isAllSelected();if(o&&o.getType()==="pre"&&!r&&(e=this.app.content.getTextFromHtml(e,{nl:!(a=n=!1),trimlines:!1})),s===!1&&(n=!1,e=this.app.autoparse.parse(e)),e!=="")return e=n?this.app.autoparse.parse(e):e,this.app.insertion.insertContent({html:e,clean:n,parse:a,position:i})},_paste:function(t){t.preventDefault();var e,i,s,n,a=t.clipboardData;this.opts.image&&this.opts.image.upload&&this.app.image.insertFromClipboard(a)||(e=a.getData("URL"),n=this.app.clipboard.getContent(a),this.pasteEvent=!0,(t=this.app.broadcast("editor.before.paste",{e:t,html:n})).isStopped()||(n=t.get("html"),n=e&&e!==""?e:n,t=this.app.block.get(),i=e=!0,s=this.app.editor.isAllSelected(),this.opts.paste.plaintext?n=this.app.content.getTextFromHtml(n,{br:!(i=e=!1)}):t&&t.getType()==="pre"&&!s?n=this.app.content.getTextFromHtml(n,{nl:!(i=e=!1),trimlines:!1}):this.opts.paste.clean||(e=!1),n=this.opts.paste.links?n:this.app.content.removeTags(n,["a"]),(n=this.opts.paste.images?n:this.app.content.removeTags(n,["img"]))!==""&&((t=a.getData("text/rtf"))&&(s=this._findLocalImages(n),n=this._replaceLocalImages(n,s,this._extractImagesFromRtf(t))),n=e?this.app.autoparse.parse(n):n,a=this.app.insertion.insertContent({html:n,clean:e,parse:i}),this.opts.image.upload&&this.app.image.parseInserted(a),this.app.placeholder.toggle(),this.app.broadcast("editor.paste",a))),this.pasteEvent=!1)},_copy:function(t){this._action(t,"copy")},_cut:function(t){this._action(t,"cut")},_action:function(t,e){var i={},s=this.app.block.get();s&&s.isEditable()&&this.app.selection.isCollapsed()||(this.app.blocks.isMeta()&&(s=this.app.blocks.getLastSelected()),t.preventDefault(),this.app.editor.isAllSelected()?i={html:this.app.editor.getLayout().html(),remove:"all"}:this.app.blocks.is()?i={html:this.app.selection.getHtml(),remove:"content"}:s&&s.isEditable()?i=this._copyFromEditable(e,s):s&&(i=this._copyFromNonEditable(e,s)),(s=this.app.broadcast("editor.before."+e,{e:t,html:i.html})).isStopped())||(e==="cut"&&this._cutDeleteContent(i),i=s.get("html"),i=this.app.clipboard.setContent(t,i),this.app.broadcastHtml("editor."+e,i))},_cutDeleteContent:function(t){t.remove==="instance"?(t.instance.remove(!0),this.app.control.close()):t.remove==="all"?this.app.editor.setEmpty():t.remove!==!1&&this.app.selection.deleteContents()},_copyFromEditable:function(t,e){var i=e.getType(),s=this.app.selection.getHtml(),n="content";return i==="figcaption"||i==="cell"||i==="paragraph"?n="content":e.isAllSelected()?(s=e.getOuterHtml(),n="instance"):i==="list"&&(i=e.getTag(),(s=this.app.selection.getHtml()).search(/<li/gi)!==-1)&&(s="<"+i+">"+(s=s.search(/^<li/g)===-1?"<li>"+s+"</li>":s)+"</"+i+">"),{html:s,remove:n,instance:e}},_copyFromNonEditable:function(t,e){var i=!1;return{html:e.getOuterHtml(),remove:i=t!=="cut"||e.isSecondLevel()?i:"instance",instance:e}},_findLocalImages:function(t){var e=[];return this.app.utils.wrap(t,function(i){i.find("img").each(function(s){s.attr("src").search(/^file:\/\//)!==-1&&e.push(s.attr("src"))})}),e},_extractImagesFromRtf:function(t){if(!t)return[];var e=/{\\pict[\s\S]+?\\bliptag-?\d+(\\blipupi-?\d+)?({\\\*\\blipuid\s?[\da-fA-F]+)?[\s}]*?/,i=new RegExp("(?:("+e.source+"))([\\da-fA-F\\s]+)\\}","g"),s=t.match(i);if(!s)return[];for(var n=[],a=0;a<s.length;a++){var o=!1;s[a].indexOf("\\pngblip")!==-1?o="image/png":s[a].indexOf("\\jpegblip")!==-1&&(o="image/jpeg"),o&&n.push({hex:s[a].replace(e,"").replace(/[^\da-fA-F]/g,""),type:o})}return n},_convertHexToBase64:function(t){return btoa(t.match(/\w{2}/g).map(function(e){return String.fromCharCode(parseInt(e,16))}).join(""))},_replaceLocalImages:function(t,e,i){if(e.length===i.length)for(var s=0;s<e.length;s++){var n="data:"+i[s].type+";base64,"+this._convertHexToBase64(i[s].hex);t=t.replace(new RegExp('src="'+e[s]+'"',"g"),'src="'+n+'"')}return t}}),l.add("module","block",{init:function(){this.instance=!1,this.$block=!1},create:function(t){var e=this.app.create("block.paragraph");return t&&e.getBlock().html(t),e},createHtml:function(t){return this.create(t).getOuterHtml()},is:function(t){return t?this._isBlockActive(t):this.get()},isType:function(t){if(this.is())return this.get().isType(t)},get:function(){return this.instance},set:function(t,e,i){t&&(t.isBlock&&(t=(t.isNested()?e&&e==="end"?t.getLast():t.getFirst():t).getBlock()),this.app.blocks.unset(),this.app.editor.unsetSelectAll(),i!==!0&&this._isBlockActive(t)||(this.unset(),this.instance=this._getInstance(t),this.$block=this.instance.getBlock(),this.$block.addClass(this.prefix+"-block-focus"),this._setCaret(e),this.app.toolbar.build(),this.app.control.build(),this.app.broadcast("block.set")))},unset:function(){this.instance&&(this.$block.removeClass(this.prefix+"-block-focus"),this.instance=!1,this.$block=!1,this.app.popup.close(),this.app.control.close(),this.app.context.close(),this.app.broadcast("block.unset"))},observe:function(t,e){if(["line","quote","pre"].indexOf(e)!==-1&&!this.opts[e])return!1},format:function(t){this.app.format.set(t)},add:function(t){this.app.popup.close();var e,i,s,n=this.get(),a=(this.app.blocks.isMeta()&&(n=this.app.blocks.getLastSelected()),t.type&&t.type==="image"&&n&&n.getType()==="cell"&&(n=n.getParent("table")),"after");if(!t||!t.template)return e=t.instance||this.app.create("block."+t.name,t.source),n?(n=n.isSecondLevel()?n.getFirstLevel():n).isEditable()&&(a=t&&t.position?t.position:this.app.insertion.detectPosition(n.getBlock(),!1)):a=this.opts.editor.add==="top"?(n=this.app.blocks.getFirst(),"before"):(n=this.app.blocks.getLast(),"after"),i=!0,n&&(s=n.getType(),t.name==="paragraph")&&["paragraph","heading"].indexOf(s)!==-1&&(i=!1),n.insert({instance:e,caret:t.caret||"end",position:a,remove:i,type:"add"}),e;n||(a=this.opts.editor.add),this.app.insertion.insertContent({html:t.template,position:a})},change:function(t){var e=this._getCurrentInstance();e&&e.change(t)},duplicate:function(){var t,e;if(this.app.popup.close(),this.is())return t=(e=(e=this.get()).isSecondLevel()?e.getFirstLevel():e).duplicate(),e=e.insert({instance:t,caret:"start",type:"duplicate"}),this.app.broadcast("block.duplicate",{instance:e}),e},remove:function(t){this.app.popup.close();var e,i,s,n,a=this.get();a&&((i=(a=a.isSecondLevel()?a.getFirstLevel():a).getType())==="image"&&(e={url:a.getSrc(),id:a.getId()}),!t||t.tarverse===void 0||t.tarverse!==!1?(t=a.getNext(),s=a.getPrev(),n=a.getParent("layer"),a.remove(),n&&n.isEmpty(!0)&&(t=n.getNext(),s=n.getPrev(),n.remove()),t?this.app.block.set(t,"start"):s?this.app.block.set(s,"end"):this.unset()):(this.unset(),a.remove()),i==="image"&&this.app.broadcast("image.remove",e),this.app.broadcast("block.remove",{type:i}),this.app.editor.isEmpty())&&this.app.editor.setEmpty()},moveUp:function(){var t=this._getCurrentInstance();t&&(t=t.isSecondLevel()?t.getFirstLevel():t).moveUp()},moveDown:function(){var t=this._getCurrentInstance();t&&(t=t.isSecondLevel()?t.getFirstLevel():t).moveDown()},getData:function(){if(this.is())return this.get().getData()},setData:function(t){this.is()&&(t=t.getData(),this.get().setData(t))},_isBlockActive:function(t){return this.instance&&this.dom(t).get()===this.$block.get()},_getCurrentInstance:function(){var t;return this.app.blocks.isMeta()?t=this.app.blocks.getLastSelected():this.is()&&(t=this.get()),t},_getInstance:function(t){return this.dom(t).dataget("instance")},_setCaret:function(t){var e=this.instance.getType(),i=this.get();["embed","image","line","layer"].indexOf(e)!==-1?(this.app.scroll.save(),this.$block.attr("tabindex","-1"),this.$block.focus(),setTimeout((function(){this.app.selection.removeAllRanges()}).bind(this),1),this.app.scroll.restore()):i.isEditable()&&t&&this.instance.setCaret(t)}}),l.add("module","observer",{init:function(){this.observer=!1,this.trigger=!0},build:function(){var t;window.MutationObserver&&(t=this.app.editor.getEditor().get(),this.observer=this._build(t),this.observer.observe(t,{attributes:!0,subtree:!0,childList:!0,characterData:!0,characterDataOldValue:!0}))},stop:function(){this.observer&&this.observer.disconnect(),this.trigger=!0},isButtons:function(){return!(this.app.blocks.isMeta()||this.app.editor.isAllSelected()||!this.opts.buttons.tags&&!this.opts.buttons.types)},buildButtons:function(t,e){for(var i,n=this.app.block.get(),s=!!n&&n.getType(),n=!!n&&n.getTag(),a=this.app.selection.getNodes({type:"inline",selected:"inside",links:!0}),o=this._getObservedTags(n,a),r=[],p=0;p<o.length;p++)(i=t[o[p]])&&(r=r.concat(i));return r=s&&(i=e[s])?r.concat(i):r},buildActiveButtons:function(t){var e,i,s={};for(e in s.tags=this.opts.buttons.tags||{},s.types=this.opts.buttons.types||{},t)t.hasOwnProperty(e)&&(i=t[e].active)&&(this._buildActiveButton(e,i.tags,s.tags),this._buildActiveButton(e,i.types,s.types));return s},_build:function(t){var e=this;return new MutationObserver(function(i){e._observe(i[i.length-1],t)})},_observe:function(t,e){t.type==="attributes"&&t.target===e||this.trigger&&(this.app.broadcast("observer.change"),this.app.placeholder.toggle(),this.app.sync.trigger())},_buildActiveButton:function(t,e,i){if(e){for(var s=0;s<e.length;s++){var n=e[s];i[n]?i[n].push(t):i[n]=[t]}return i}},_getObservedTags:function(t,e){var i=[];if(t&&i.push(t),0<e.length)for(var s=0;s<e.length;s++)i.push(e[s].tagName.toLowerCase());return i}}),l.add("module","input",{handle:function(t){var e=t.get("e"),i=t.get("key");this._doSelectAll(e,t)||(t.is("enter")&&t.is("shift")?this.handleShiftEnter(e,i,t):t.is("enter")?this.handleEnter(e,i,t):t.is("space")&&t.is("shift")?this.handleShiftSpace(e,i,t):t.is("space")?this.handleSpace(e,i,t):t.is("tab")&&this.opts.tab.key?this.handleTab(e,i,t):t.is("arrow")?t.is("ctrl")&&t.is("up")?this.handleArrowCtrl(e,i,t):t.is(["shift","alt","ctrl"])||this.handleArrow(e,i,t):t.is(["delete","backspace"])&&this.handleDelete(e,i,t))},handleDelete:function(t,e,i){var s,n,a=this.app.block.get(),o=i.is("backspace"),r=i.is("delete");this.app.editor.isEmpty(!0)?t.preventDefault():this.app.blocks.isMeta()?(t.preventDefault(),this.app.blocks.removeSelected()):this.app.blocks.is()?(t.preventDefault(),n=this.app.blocks.getFirstSelectedBlock(),n=this.dom(n),this.app.selection.deleteContents(),this.app.block.set(n,"end"),this.app.block.get().appendNext()):this._deleteInsideSelection(t)||(a?a&&a.isEditable()&&this._trimInvisibleChar(t,i.is("backspace")?"left":"right",r)||((n=this.app.selection.getInline())&&n.innerHTML.length===1?(t.preventDefault(),n.innerHTML=""):a.handleDelete&&a.handleDelete(t,e,i)||(n=a.getNext(),e=a.getPrev(),a.isEditable()?a.isEditable()&&(a.isAllSelected()?(t.preventDefault(),a.setEmpty(),this.app.caret.set(a.getBlock(),"start"),this.app.toolbar.observe()):a.isSecondLevel()||a.isFigcaption()||(r&&n&&a.isCaretEnd()?(t.preventDefault(),n.isEditable()?n.getType()==="pre"?(this.app.blocks.setMeta(n.getBlock()),a.isEmpty()&&a.remove(!0)):a.appendNext():(n.isNested()?this.app.blocks.setMeta(n.getBlock()):this.app.block.set(n),a.isEmpty()&&a.remove(!0))):o&&e&&a.isCaretStart()?(t.preventDefault(),e.isEditable()?e.getType()==="pre"?(this.app.blocks.setMeta(e.getBlock()),a.isEmpty()&&a.remove(!0)):(a.appendToPrev(),this.app.control.updatePosition()):(e.isNested()?this.app.blocks.setMeta(e.getBlock()):this.app.block.set(e),a.isEmpty()&&a.remove(!0))):this.app.selection.isCollapsed()||(t.preventDefault(),this.app.selection.deleteContents()))):(t.preventDefault(),a.getType()==="image"&&(s={url:a.getSrc(),id:a.getId()}),a.remove(!0),a.getType()==="image"&&this.app.broadcast("image.remove",s),n?this.app.block.set(n,"start"):e?this.app.block.set(e,"end"):this.app.editor.isEmpty()?this.app.editor.setEmpty():this.app.block.unset()))):(t.preventDefault(),this.app.selection.deleteContents()))},handleArrowCtrl:function(t,e,i){this.app.editor.unselectAll(),this.app.selection.removeAllRanges(),this.app.editor.setFocus("start")},handleArrow:function(t,e,i){var s=this.app.block.get();if(this.app.editor.isAllSelected())t.preventDefault(),n=i.is("down-right")?this.app.blocks.getLast():this.app.blocks.getFirst(),a=i.is("down-right")?"end":"start",this.app.editor.unselectAll(),this.app.selection.removeAllRanges(),this.app.block.set(n,a);else if(!this.app.blocks.is())if(this.app.blocks.isMeta())s=this.app.blocks.getLastSelected(),this._doArrow(t,i,s);else{if(s.isEditable()){var n=this.app.selection.getTopInline();if(i.is("right")&&n&&n.tagName==="CODE"){var a=this.app.caret.is(n,"end"),o=this.app.caret.is(s.getBlock(),"end");if(a&&o)return t.preventDefault(),void this.app.caret.set(n,"after")}}s.isEditable()&&this._trimInvisibleChar(t,i.is("left")?"left":"right")||s.handleArrow&&s.handleArrow(t,e,i)||this._doArrow(t,i,s)}},handleTab:function(t,e,i){var s,n,a=this.app.block.get();this.app.blocks.isMeta()?(t.preventDefault(),(s=(a=this.app.blocks.getLastSelected()).getNext())&&this.app.block.set(s,"start")):(a=this.app.blocks.is()&&(n=this.app.blocks.getLastSelectedBlock(),(a=this.dom(n).dataget("instance")).isSecondLevel())?a.getFirstLevel():a).handleTab&&a.handleTab(t,e,i)||(this.opts.tab.spaces&&a.isEditable()?(t.preventDefault(),n=this.opts.tab.spaces,e=document.createTextNode(Array(n+1).join(" ")),this.app.insertion.insertNode(e,"end")):(t.preventDefault(),(s=a.getNext())&&this.app.block.set(s,"start")))},handleShiftSpace:function(t){var e,i=this.app.block.get();this.app.blocks.isMeta()?t.preventDefault():this.app.blocks.is()?(t.preventDefault(),e=this.app.blocks.getFirstSelectedBlock(),e=this.dom(e),this.app.selection.deleteContents(),this.app.caret.set(e,"end"),this.app.insertion.insertHtml("&nbsp;","end")):i.isEditable()&&(i.isAllSelected()?(t.preventDefault(),i.setEmpty()):i.getType()!=="pre"&&(t.preventDefault(),this.app.insertion.insertHtml("&nbsp;","end")))},handleSpace:function(t,e,i){var s,n=this.app.block.get();this.app.blocks.isMeta()?(t.preventDefault(),this.app.blocks.getLastSelected().insertEmpty({position:"after",caret:"start"}),this.app.blocks.removeSelected(!1)):this.app.blocks.is()?(s=this.app.blocks.getFirstSelectedBlock(),s=this.dom(s),this.app.selection.deleteContents(),this.app.caret.set(s,"end")):n.handleSpace&&n.handleSpace(t,e,i)||(n.isEditable()&&n.isAllSelected()?(t.preventDefault(),n.setEmpty()):n.isEditable()||(t.preventDefault(),n.insertEmpty({position:"after",caret:"start"}),n.remove(!0)))},handleShiftEnter:function(t){var e;this.app.blocks.isMeta()?t.preventDefault():this.app.blocks.is()?(t.preventDefault(),e=this.app.blocks.getFirstSelectedBlock(),e=this.dom(e),this.app.selection.deleteContents(),this.app.caret.set(e,"end"),this.app.insertion.insertBreakline()):this._deleteInsideSelection(t)||((e=this.app.block.get()).isEditable()?(t.preventDefault(),this.app.insertion.insertBreakline()):(t.preventDefault(),e.insertEmpty({position:"after",caret:"start"})))},handleEnter:function(t,e,i){if(this.app.blocks.isMeta())t.preventDefault(),this.app.blocks.getLastSelected().insertEmpty({position:"after",caret:"start"});else if(this.app.blocks.is())t.preventDefault(),this.app.selection.deleteContents();else if(!this._deleteInsideSelection(t)){var s=this.app.block.get();if(s.isEditable()){if(s.isAllSelected())return t.preventDefault(),void s.setEmpty();if(!this.app.selection.isCollapsed())return t.preventDefault(),void(s.getType()==="pre"?this.app.insertion.insertNewline():this.app.insertion.insertBreakline())}s.isEditable()||(t.preventDefault(),s.insertEmpty({position:"after",caret:"start"})),s.handleEnter&&s.handleEnter(t,e,i)}},handleTextareaTab:function(e){if(e.keyCode!==9)return!0;e.preventDefault();var e=e.target,i=e.value,s=e.selectionStart;e.value=i.substring(0,s)+"    "+i.substring(e.selectionEnd),e.selectionStart=e.selectionEnd=s+4},_deleteInsideSelection:function(t){if(!this.app.selection.isCollapsed()){var e=this.app.selection.getNodes({type:"blocks"});if(1<e.length)return t.preventDefault(),this.app.selection.deleteContents(),this.app.caret.set(e[0],"end"),!0}return!1},_doSelectAll:function(t,e){return this._isAllSelected(e)?(this._setEditorEmpty(t,e),!0):e.is("select")?(t.preventDefault(),this.app.editor.selectAll(),!0):void 0},_doArrow:function(t,e,i){var s,n,a=i.getParent("layer"),o=i.getType(),r=["pre","line","image","embed","layer"];if(e.is("right")&&o==="layer"){var p=i.getChildFirst();if(p.isEditable())return this.app.block.set(p),void setTimeout((function(){this.app.offset.set(p.getBlock(),{start:0})}).bind(this),0)}else if(e.is("up-left")&&i.isCaretStart()){if(n="end",s=(a||i).getPrev(),a&&!s)return void this.app.block.set(a);if(!s&&r.indexOf(o)!==-1)return void this.app.insertion.insertEmptyBlock({position:"before",caret:"start"})}else if(e.is("down-right")&&i.isCaretEnd()){if(n="start",s=(a||i).getNext(),a&&!s)return void this.app.block.set(a);if(!s&&r.indexOf(o)!==-1)return void this.app.insertion.insertEmptyBlock({position:"after",caret:"start"})}s&&(t.preventDefault(),this.app.block.set(s,n))},_isAllSelected:function(t){return this.app.editor.isAllSelected()&&t.is(["enter","delete","backspace","alpha","space"])},_setEditorEmpty:function(t,e){e.is(["alpha","space"])||t.preventDefault(),this.app.editor.setEmpty()},_trimInvisibleChar:function(t,e,i){var s,a=e==="left"?"before":"after",n=this.app.selection.get(),a=this._isInvisibleChar(a);if(a&&e==="left")s=n.current,this.dom(s).replaceWith(s.textContent.replace(/\uFEFF/g,""));else if(a&&i&&n.current&&n.current.nextSibling)s=n.current.nextSibling,this.dom(s).replaceWith(s.textContent.replace(/\uFEFF/g,""));else if(a&&e==="right")return t.preventDefault(),i=this.app.offset.get(),this.app.offset.set(!1,{start:i.start+1,end:i.end+1}),!0},_isInvisibleChar:function(i){var e=this.app.selection.get(),i=this.app.selection.getText(i);return e.current&&e.current.nodeType===3&&this.app.utils.searchInvisibleChars(i)===0}}),l.add("module","insertion",{init:function(){this._clear()},start:function(){this.win=this.app.$win.get(),this.doc=this.app.$doc.get()},getFirstInserted:function(){return this.inserted.instances[0]},getLastInserted:function(){var t=this.inserted.instances.length,t=this.inserted.instances[t-1];return t=t&&t.isFigcaption()?t.getFigure():t},getInserted:function(){return this.inserted},setContent:function(t){return this._insert(t,"set"),t=this.getInserted(),this.inserted=!1,t},insertContent:function(t){return this._insert(t,"insert"),t=this.getInserted(),this.inserted=!1,t},insertEmptyBlock:function(t){return(t=t||{}).html=this.app.block.createHtml(),this._insert(t,"insert"),t=this.getInserted(),this.inserted=!1,this.app.broadcast("block.add",{instance:t.instances[0],type:"input"}),t},insertNewline:function(t,e){return this._insertFragment({node:document.createTextNode(e?`

`:`
`)},t||"after")},insertPoint:function(a){var e,i,s=this.app.utils.createInvisibleChar(),n=a.clientX,a=a.clientY;this.doc.caretPositionFromPoint?(e=this.doc.caretPositionFromPoint(n,a),(i=this.doc.getSelection().getRangeAt(0)).setStart(e.offsetNode,e.offset),i.collapse(!0),i.insertNode(s)):this.doc.caretRangeFromPoint&&(i=this.doc.caretRangeFromPoint(n,a)).insertNode(s),this.app.caret.set(s,"after")},insertBreakline:function(t){var e=this.app.selection.getNodes({type:"inline"});return this.app.selection.isCollapsed()&&e.length!==0?this._splitInline(e,document.createElement("br")):this._insertFragment({node:document.createElement("br")},t||"after")},insertNode:function(t,e,i){return i&&(i=this.app.selection.getNodes({type:"inline"}),i.length!==0)?this._splitInline(i,t):this._insertFragment({node:this.dom(t).get()},e)},insertHtml:function(t,e){return this._insertFragment({html:t},e)},insertText:function(t,e){var i,s=this.app.block.get();if(!(s&&!s.isEditable()||this.app.blocks.isMeta()))return(s=this.win.getSelection()).getRangeAt&&s.rangeCount&&(t=this.app.content.getTextFromHtml(t,{nl:!0}),i=document.createTextNode(t),(s=s.getRangeAt(0)).deleteContents(),s.insertNode(i),this.app.caret.set(i,e=e||"end")),i;this.insertContent({html:t,caret:e})},insertListToList:function(a,y,i){var n=a.find("li"),s=n.last(),n=(n.addClass(this.prefix+"-pasteitems"),s.addClass(this.prefix+"-pastemarker"),a.children()),a=this.dom(this.app.selection.getBlock()),o=this.app.caret.is(y,"start"),m=this.app.caret.is(y,"end"),r=this.app.caret.is(a,"start"),p=this.app.caret.is(a,"end",["ul","ol"]),d=this.app.content.isEmptyHtml(a.html()),m=(o?(d&&a.remove(),y.prepend(n)):m?(d&&a.remove(),y.append(n)):d?(a.after(n),a.remove()):r?a.before(n):p?(o=a.find("ul, ol")).length!==0?o.prepend(n):a.after(n):this.app.element.split(a).before(n),this.prefix+"-pastemarker"),y=this.prefix+"-pasteitems";return i&&(s=this.app.editor.getEditor().find("."+m).removeClass(m),this.app.caret.set(s,"end")),this.app.editor.getEditor().find("."+y).removeClass(y)},detectPosition:function(t,e){var i;return e||(i=this.app.caret.is(t,"start"),e=this.app.caret.is(t,"end")?"after":i?"before":"split"),e},_insert:function(t,e){this.html=t.html,this.html=this.app.broadcastHtml("editor.before.insert",this.html),this.isParse=t.parse===void 0||t.parse,this.isClean=t.clean!==void 0&&t.clean,this.isCaret=t.caret===void 0||t.caret,this.isPosition=t.position!==void 0&&t.position,this.isCurrent=t.current!==void 0&&t.current,e==="set"||this.app.editor.isAllSelected()?this._setContent():this._insertContent(),this.app.broadcast("editor.insert",this.inserted)},_insertContent:function(){var t=this.isCurrent||this.app.block.get(),e=!1,i=!1;if(this._checkEmpty(),this._checkLine(),this.app.blocks.isMeta()||this.app.blocks.is()){if(this.isEmpty)return;if(this.isLine&&(this.html=this.app.block.createHtml(this.html)),this._clean(),this._parse(),this._parseBuild(),n=this._buildParsedNodes(),this.app.blocks.is()){if(!(a=this.app.blocks.getLastSelectedBlock()))return;t=(s=this.dom(a)).dataget("instance"),this.app.selection.deleteContents(),this._insertToEditable(t,s,n)}else(a=this.app.blocks.getLastSelected()).getBlock().after(n),this.app.blocks.removeSelected(!1)}else if(!t||this.isPosition){if(this.isEmpty)return;this.isLine&&(this.html=this.app.block.createHtml(this.html)),this._clean(),this._parse(),this._parseBuild();var s,n=this._buildParsedNodes(),e=this.isPosition==="top"||!this.isPosition&&this.opts.editor.add==="top"?(t=this.app.blocks.getFirst(),"before"):t&&["after","before","append"].indexOf(this.isPosition)!==-1?this.isPosition:(t=this.app.blocks.getLast(),"after");(s=t.getBlock())[e](n)}else if(this._isListToList(t)){this.app.selection.deleteContents(),this._clean(),this._parse(),this._parseBuild(),s=t.getBlock();var a=this.$parsed.children().first();this.$nodes=this.insertListToList(a,s,"end"),this.isCaret=!1}else{if(!t)return;if(t.isEditable()){if(this.isEmpty)return;this._clean(),this._cleanSpecial(t),this.isLine?this._parseLine():this._parse(),this._parseBuild(),t.isEmpty()?(i=!0,e="after"):this.app.selection.deleteContents(),n=this._buildParsedNodes(),s=t.getBlock(),this._insertToEditable(t,s,n,e,i)}else{if(e="after",this.isEmpty)return;this.isLine&&(this.html=this.app.block.createHtml(this.html)),this._clean(),this.isLine?this._parseLine():this._parse(),this._parseBuild(),n=this._buildParsedNodes(),(s=t.getBlock())[e](n)}}this._buildInserted(),this._buildEditor(),this._buildCaret()},_insertToEditable:function(t,e,i,s,n){this.isLine?(this.$nodes=this._insertFragment({fragment:this.$parsed.get()},"end"),this.isCaret=!1):(this.app.content.isEmptyHtml(e.html())?(s="after",n=!0):s=this.detectPosition(e,s),s==="split"?this.app.element.split(e).before(i):e[s](i),n&&t.remove())},_insertFragment:function(t,e){var i,s;return t.html||t.fragment?(i=this.app.fragment.build(t.html||t.fragment),this.app.fragment.insert(i)):this.app.fragment.insert(t.node),e&&(s=t.node||(e==="start"?i.first:i.last),this.app.caret.set(s,e)),t.node?this.dom(t.node):this.dom(i.nodes)},_setContent:function(){this._checkEmpty(),this._checkLine(),this.isEmpty?this.html=this.app.block.createHtml():this.isLine&&(this.html=this.app.block.createHtml(this.html)),this._clean(),this._parse(),this._parseBuild();var t=this._buildParsedNodes();this.app.editor.unsetSelectAll(),this.app.editor.getEditor().html("").append(t),this.isEmpty&&this.app.broadcast("editor.empty"),this._buildInserted(),this._buildEditor(),this._buildCaret(),this.app.broadcast("editor.set",this.inserted)},_splitInline:function(t,e){return t=this.app.element.split(t[0]),t.before(e),t.html()===""&&t.remove(),this.dom(e)},_buildEditor:function(){this.app.placeholder.trigger(),this.app.editor.build(),this.app.editor.setFocus(),this.app.toolbar.observe(),this.app.context.observe()},_buildCaret:function(){var t,e;this.isCaret&&(e="end",this.isCaret==="start"?(t=this.getFirstInserted(),e="start"):t=this.getLastInserted(),t)&&this.app.block.set(t,e)},_buildInserted:function(){this.inserted={$nodes:this.$nodes,instances:[]},this.inserted.$nodes.each(this._buildInstance.bind(this))},_buildInstance:function(t){t=t.dataget("instance"),t&&this.inserted.instances.push(t)},_buildParsedNodes:function(){return this.$parsed.get().childNodes},_clear:function(){this.html=!1,this.isLine=!1,this.isEmpty=!1,this.isSplit=!1,this.isClean=!1,this.isParse=!0,this.isCaret=!0,this.isCurrent=!1,this.isPosition=!1},_clean:function(){this.isClean&&(this.html=this.app.cleaner.cleanHtml(this.html))},_cleanSpecial:function(s){var e,i,s=s.getType();["cell","address","figcaption","quoteitem"].indexOf(s)!==-1?e=!0:s==="list"&&(e=!0,i=["ul","ol","li"]),e&&(this.isLine=!0,this.html=this.app.content.addBrToBlocks(this.html),this.html=this.app.content.removeBlockTags(this.html,void 0,i),this.html=this.html.replace(/<br\s?\/?>\n?$/gi,""))},_parse:function(){this.isParse&&(this.html=this.app.parser.parse(this.html,!1))},_parseLine:function(){this.isParse&&(this.html=this.app.parser.parseLine(this.html,!1))},_parseBuild:function(){this.$parsed=this.app.parser.build(this.html),this.$nodes=this.$parsed.children()},_checkEmpty:function(){this.isEmpty=this.app.content.isEmptyHtml(this.html)},_checkLine:function(){this.isLine=this.app.content.isLine(this.html)},_isListToList:function(e){var e=e.getBlock().attr("data-"+this.prefix+"-type"),i=this.dom("<div>").html(this.html);return i.find("meta").remove(),i.find("b").unwrap(),i=i.children().first(),e==="list"&&i.length!==0&&["ul","ol"].indexOf(i.get().tagName.toLowerCase())!==-1}}),l.add("module","toolbar",{init:function(){this.eventname=this.prefix+"-toolbar",this.activeClass="active",this.toggledClass="toggled",this.disableClass="disable",this.customButtons={},this.aTags={},this.aTypes={}},start:function(){this.$container=this.app.container.get("toolbar"),this.opts.toolbar&&(this._build(),this._buildSticky())},load:function(){this.opts.toolbar&&(this._buildActiveButtons(),this.app.block.get()||(this.$toolbar.html(""),this._buildButtons()))},stop:function(){this.opts.toolbar&&(this.$toolbar.remove(),this.customButtons={},this.editorButtons={})},build:function(){var t,e;this.opts.toolbar&&((t=this.app.block.get())&&t.isSecondLevel()&&(t=t.getFirstLevel()),e=this.app.editor.getButtonsFromArr(this.opts.buttons.editor),t&&t.toolbar&&(e=this.app.editor.getButtonsFromArr(t.toolbar)),this.$toolbar.html(""),e=this._createButtons(e,t),t||this._checkIntialToolbar(e))},observe:function(){var t;this.opts.toolbar&&(this.unsetActive(),this.app.observer.isButtons())&&(t=this.app.observer.buildButtons(this.aTags,this.aTypes),this._setActiveKeys(t))},getElement:function(){return this.$toolbar},get:function(t){return this._findButton(t)},add:function(t,e){this.customButtons[t]=e},setActive:function(t){this.opts.toolbar&&(this._findButtons().removeClass(this.activeClass),this._findButton(t).removeClass(this.disableClass).addClass(this.activeClass))},setToggled:function(t){this.opts.toolbar&&(this._findButtons().removeClass(this.toggledClass),this._findButton(t).removeClass(this.disableClass).addClass(this.toggledClass))},unsetActive:function(t){this.opts.toolbar&&(t?this._findButton(t):this._findButtons()).removeClass(this.activeClass)},unsetToggled:function(t){this.opts.toolbar&&(t?this._findButton(t):this._findButtons()).removeClass(this.toggledClass)},enable:function(){this.opts.toolbar&&this._findButtons().removeClass(this.disableClass)},disable:function(){this.opts.toolbar&&this._findButtons().removeClass(this.toggledClass).removeClass(this.activeClass).addClass(this.disableClass)},disableSticky:function(){var t=this.app.container.get("toolbar");t.removeClass(this.prefix+"-toolbar-sticky"),t.css("top","")},enableSticky:function(){var t;this.opts.toolbar.sticky&&((t=this.app.container.get("toolbar")).addClass(this.prefix+"-toolbar-sticky"),t.css("top",this.opts.toolbar.stickyTopOffset+"px"))},isSticky:function(){var e=this.app.container.get("toolbar"),t=this.app.container.get("main"),t=t.offset().top+parseInt(t.css("border-top-width")),e=e.offset().top;return t<e||e<t},_build:function(){this.$toolbar=this.dom("<div>").addClass(this.prefix+"-toolbar"),this.$container.append(this.$toolbar),this.$container.addClass("is-"+this.prefix+"-toolbar")},_buildSticky:function(){this.opts.toolbar.sticky&&(this._toggleSticky("add",this.opts.toolbar.stickyTopOffset+"px"),this._startEvent())},_buildButtons:function(){var t=this.app.editor.getButtonsFromArr(this.opts.buttons.editor),t=this._createButtons(t);this._checkIntialToolbar(t)},_buildActiveButtons:function(){var t=this.app.observer.buildActiveButtons(this.customButtons);this.aTags=t.tags,this.aTypes=t.types},_checkIntialToolbar:function(t){var e;t!==0||this.opts.topbar||(t=this.app.blocks.getFirst(),e=this.app.editor.getButtonsFromArr(t.toolbar),this.$toolbar.html(""),this._createButtons(e,t),this.disable())},_findButtons:function(){return this.$toolbar.find("."+this.prefix+"-button-toolbar")},_findButton:function(t){return this.$toolbar.find("[data-name="+t+"]")},_createButtons:function(t,e){var i,s=t,n=0;for(i in s=e?c.extend(!0,{},t,this.customButtons):s)!s.hasOwnProperty(i)||i==="add"&&!this.opts.addbar||i==="html"&&!this.opts.source||i==="format"&&!this.opts.format||e&&!e.isAllowedButton(i,s[i])||this._isHidden(i)||(this.app.create("button",i,s[i],this.$toolbar,"toolbar"),n++);return n},_isHidden:function(t){return this.opts.toolbar.hide.indexOf(t)!==-1},_setActiveKeys:function(t){for(var e=0;e<t.length;e++)this._findButton(t[e]).addClass(this.activeClass)},_getObservedTags:function(t,e){var i=[];if(t&&i.push(t),0<e.length)for(var s=0;s<e.length;s++)i.push(e[s].tagName.toLowerCase());return i},_toggleSticky:function(t,e){this.$container[t==="remove"?"removeClass":"addClass"](this.prefix+"-toolbar-sticky"),this.$container.css("top",e)},_startEvent:function(){this.app.scroll.getTarget().on("scroll."+this.eventname,this._observeSticky.bind(this))},_stopEvent:function(){this.app.scroll.getTarget().off("."+this.eventname)},_observeSticky:function(){var t;this.app.source.is()?this.$container.css("top",0):(t=this.app.scroll.getTarget(),t=this.app.scroll.isTarget()?parseInt(t.css("padding-top")):0,this.$container.css("top",0-t+this.opts.toolbar.stickyTopOffset+"px"),this.isSticky()?this.app.broadcast("toolbar.sticky"):this.app.broadcast("toolbar.static"))}}),l.add("module","addbar",{init:function(){this.custom={}},popup:function(t,e){this.opts.addbar&&(this.app.popup.create("addbar",{width:"380px",items:this.buildItems()}),e=e.isButton||e.isControl?{button:e}:{},this.app.popup.open(e))},add:function(t,e){this.custom[t]=e,this.custom[t].container=!0,this.custom[t].addbar=!0,this.custom[t].command=e.command||"block.add",e.template&&(this.custom[t].params={template:e.template})},buildItems:function(){for(var t,e={},i=this.opts.buttons.addbar,s=c.extend(!0,{},this.opts.buttonsObj),n=0;n<i.length;n++){var a=i[n];this._isHidden(a)||(e[a]=s[a],e[a].container=!0,e[a].addbar=!0,e[a].icon=!0)}for(t in this.opts.addbar.add)!this.opts.addbar.add.hasOwnProperty(t)||this._isHidden(t)||(e[t]=this.opts.addbar.add[t],e[t].container=!0,e[t].addbar=!0,e[t].command="block.add",e[t].params={template:this.opts.addbar.add[t].template});return e=c.extend(!0,{},e,this.custom)},_isHidden:function(t){return this.opts.addbar.hide.indexOf(t)!==-1}}),l.add("module","format",{popup:function(t,e){for(var i,n=this.app.block.get(),s=!!n&&n.getBlock(),n=!!n&&n.getTag(),a=this.opts.format,o={},r=0;r<a.length;r++){var p=a[r];o[p]={title:this.opts.formatObj[p].title,params:{tag:p},command:"block.format",shortcut:this.opts.formatObj[p].shortcut}}this.opts.formatAdd&&(i=this.opts.formatAdd,Object.keys(i).forEach(function(d){o[d]={title:i[d].title,params:i[d].params,command:"block.format"}})),s=this._isActiveFormat(s,n,o),s&&(o[s].active=!0),this.app.popup.create("format",{width:"300px",items:o}),this.app.popup.open({button:e})},set:function(t){var e,i,s;this.app.popup.close(),this.app.blocks.isMeta()||(e={type:this.opts.formatObj[t.tag].type,tag:t.tag,classname:t.classname||!1},i=this.app.blocks.getSelectedBlocks("editable"),(s=this.app.block.get())?this.setSingle(s,e,t):i.length!==0&&this.setMultiple(i,e,t))},setSingle:function(t,e){var i,s=t.isEmpty(),n=!!s&&"start";this.tag=t.getTag(),this.type=t.getType(),this.$block=t.getBlock(),s||this.app.selection.saveMarker(),(e=this._isSameTag(e)?this._checkSameFormat(this.$block,e):e)&&(this._isListToText(e,"list")?i=this._formatListToText(e):this._isListToText(e,"dlist")?i=this._formatListToText(e,!0):this._isTextToList(e,"list")?this._formatTextToList(e,!1,n):this._isTextToList(e,"dlist")?this._formatTextToList(e,!0,n):this._replaceTo(t,e,n)),s||this.app.selection.restoreMarker(),i&&this.app.block.unset(),t=this.app.block.get(),this.app.editor.build(),this.app.broadcast("block.format",{instance:t})},setMultiple:function(t,e){var i,s;this.app.selection.saveMarker(),this._isListTag(e.tag)&&this._isMultipleParagraphs()&&(s=(i=this.app.create("block."+e.type,!1,{tag:e.tag})).getBlock(),this.dom(t[0]).before(s));for(var n,a,o,r,p=0;p<t.length;p++)(r=t[p].tagName.toLowerCase())!==e.tag&&(s?(n=this.dom("<li>").html(t[p].innerHTML),s.append(n),this.dom(t[p]).remove(),this._setStyleAndClass(s,e)):!this._isListTag(r)&&this._isListTag(e.tag)?(o=(i=this.app.create("block."+e.type,!1,{tag:e.tag})).getBlock(),n=this.dom("<li>").html(t[p].innerHTML),o.append(n),(a=this.dom(t[p])).after(o),a.remove(),this._setStyleAndClass(o,e)):this._isListTag(r)&&!this._isListTag(e.tag)?((o=(a=this.dom(t[p])).find("li")).find("ul, ol").each(function(d){d.parent().after(d)}),o.find("ul, ol").unwrap(),o.each((function(d){var m=this.dom("<"+e.tag+">");m.html(d.html()),d.remove(),this.app.create("block."+e.type,m),a.before(m),this._setStyleAndClass(m,e)}).bind(this)),a.remove()):i=this._replaceToBlock(t[p],e));this.app.selection.restoreMarker(),s&&this.app.block.set(s),this.app.editor.build(),this.app.editor.unsetSelectAll(),this.app.broadcast("block.format",{instance:i})},_isListTag:function(t){return["ul","ol"].indexOf(t)!==-1},_isSameTag:function(t){return this.tag===t.tag&&this.type===t.type},_isMultipleParagraphs:function(){var t=this.app.blocks.getSelectedBlocks(),e=["P","ADDRESS","H1","H2","H3","H4","H5","H6"];if(1<t.length){for(var i=0,s=0;s<t.length;s++)e.indexOf(t[s].tagName)===-1&&i++;if(i===0)return!0}return!1},_checkSameFormat:function(t,e){return t=this.app.element.hasClass(t,e.classname),!e.classname||t?this._buildDefaultFormat():e},_buildDefaultFormat:function(){return{type:"paragraph",tag:"p",classname:!1}},_formatListToText:function(t,e){return e=e?this._getDlistItems():this._getListItems(),this._createItems(e,t),this.$block.remove(),e},_formatTextToList:function(t,e,i){var s,n=this.app.create("block."+t.type,"<"+t.tag+">").getBlock();e&&this.type==="list"?(s=0,this._getListItems().each((function(r){var o=s===0?"dt":"dd",r=this.dom("<"+o+">").html(r.html());s=o=="dt"?1:0,n.append(r)}).bind(this))):e||this.type!=="dlist"?(e=this.dom(e?"<dt>":"<li>").html(this.$block.html()),n.append(e)):this._getDlistItems().each((function(a){a=this.dom("<li>").html(a.html()),n.append(a)}).bind(this)),this.app.create("block."+t.type,n),this.$block.after(n),this.$block.remove(),this._setStyleAndClass(n,t),this.app.block.set(n,i)},_replaceTo:function(t,e,i){var s=t.getBlock(),s=(t=this._replaceToBlock(s,e)).getBlock();this.app.block.set(s,i)},_replaceToBlock:function(t,e){return t=this.app.element.replaceToTag(t,e.tag),this._setStyleAndClass(t,e),this.app.create("block."+e.type,t)},_createItems:function(t,e){t.each((function(i){var s=this.dom("<"+e.tag+">");s.html(i.html()),i.remove(),this.app.create("block."+e.type,s),this.$block.before(s),this._setStyleAndClass(s,e)}).bind(this))},_isListToText:function(t,e){return this.type===e&&["heading","address","paragraph"].indexOf(t.type)!==-1},_isTextToList:function(t,e){var i=e==="list"?"dlist":"list";return t.type===e&&["heading","address","paragraph",i].indexOf(this.type)!==-1},_isActiveFormat:function(t,e,i){if(t){var s,n,a;for(n in i)i.hasOwnProperty(n)&&(a=i[n].params.classname||!1,e!==i[n].params.tag||a&&!this.app.element.hasClass(t,a)||(s=n));return s}},_setStyleAndClass:function(t,e){t.removeAttr("style class data-"+this.prefix+"-style-cache"),e.classname&&t.addClass(e.classname)},_getListItems:function(){var t=this.$block.find("li");return t.find("ul, ol").each(function(e){e.parent().after(e)}),t.find("ul, ol").unwrap(),t},_getDlistItems:function(){return this.$block.find("dt, dd")}}),l.add("module","embed",{popups:{add:{title:"## embed.embed ##",width:"100%",form:{embed:{type:"textarea",label:"## embed.description ##",rows:6},caption:{type:"input",label:"## embed.caption ##"},responsive:{type:"checkbox",text:"## embed.responsive-video ##"}},footer:{insert:{title:"## buttons.insert ##",command:"embed.insert",type:"primary"},cancel:{title:"## buttons.cancel ##",command:"popup.close"}}},edit:{title:"## embed.embed ##",width:"100%",form:{embed:{type:"textarea",label:"## embed.description ##",rows:6},caption:{type:"input",label:"## embed.caption ##"},responsive:{type:"checkbox",text:"## embed.responsive-video ##"}},footer:{save:{title:"## buttons.save ##",command:"embed.save",type:"primary"},remove:{title:"## buttons.delete ##",command:"embed.remove",type:"danger",right:!0},cancel:{title:"## buttons.cancel ##",command:"popup.close"}}}},build:function(t){t?this._callScripts(t):this._findScripts()},observe:function(t,e,i){var s;return!!this.opts.embed&&(s=this.app.block.get(),i&&i.getName()==="addbar"?t.command="embed.popup":s&&s.getType()==="embed"&&(t.command="embed.edit"),t)},popup:function(){this.app.popup.create("embed",this.popups.add),this.app.popup.open({focus:"embed"}),this.opts.embed.checkbox&&this.app.popup.getInput("responsive").attr("checked",!0),this._buildCodemirror()},edit:function(t){var e=this.app.block.get(),e={embed:e.getEmbedCode(),caption:e.getCaption(),responsive:e.isResponsive()};this.app.popup.create("embed",this.popups.edit),this.app.popup.setData(e),this.app.popup.open({focus:"embed"}),this._buildCodemirror()},insert:function(){this.app.popup.close();var t=this.app.popup.getData(),e=this._getEmbedCode(t);e!==""&&(t=this._createInstance(t,e),this.app.block.add({instance:t}))},save:function(){this.app.popup.close();var t=this.app.block.get(),e=this.app.popup.getData(),i=this._getEmbedCode(e);i===""?this.app.block.remove():(i=this._createInstance(e,i,t),this._isNeedToChange(e,i,t)&&this.app.block.change(i))},remove:function(){this.app.popup.close(),this.app.block.remove()},_buildCodemirror:function(){var t=this.app.popup.getInput("embed");this.app.codemirror.create({el:t,height:"200px",focus:!0}),this.app.popup.updatePosition()},_findScripts:function(){var t=this.app.editor.getEditor().find("[data-"+this.prefix+"-type=embed]").find("script").getAll();this.build.call(this,t)},_callScripts:function(t){for(var e,i,s,n=0;n<t.length;n++)t[n].src!==""&&(e=t[n].src,this.app.$doc.find('head script[src="'+e+'"]').remove(),(i=this.dom("<script>").attr({src:e,async:!0,defer:"true"})).on("load",(function(){var a;e.search("instagram")!==-1&&(a=this.app.$win.get()).instgrm&&a.instgrm.Embeds.process(),this.build(t.slice(n+1))}).bind(this)),s=this.app.$doc.get().getElementsByTagName("head")[0])&&s.appendChild(i.get())},_getEmbedCode:function(t){return t=t.embed.trim(),t=this.app.codemirror.val(t),t=this._removeScript(t),t=this.app.content.sanitize(t),this._isHtmlString(t)||t===""?t:this._parseUrl(t)},_removeScript:function(t){return t=this.opts.embed.script?t:this.app.content.removeTagsWithContent(t,["script"])},_createInstance:function(t,e,n){n?(s=n.duplicate().getBlock()).html(e):s=this._isFigure(e)?e:"<figure>"+e+"</figure>";var s,n=this.app.create("block.embed",s);return n.setCaption(t.caption),t.responsive&&n.addResponsive(),n},_parseUrl:function(t){var e,i='<iframe width="560" height="315" src="',s='" frameborder="0" allowfullscreen></iframe>';return t.match(this.opts.regex.youtube)?(e="//www.youtube.com",t.search("youtube-nocookie.com")!==-1&&(e="//www.youtube-nocookie.com"),i+t.replace(this.opts.regex.youtube,e+"/embed/$1")+s):t.match(this.opts.regex.vimeo)?i+t.replace(this.opts.regex.vimeo,"//player.vimeo.com/video/$2")+s:t},_isNeedToChange:function(t,e,i){return i.getEmbedCode()!==e.getEmbedCode()||t.responsive!==i.isResponsive()||t.caption!==i.getCaption()||void 0},_isHtmlString:function(t){return/^\s*<(\w+|!)[^>]*>/.test(t)},_isFigure:function(t){return/^<figure/.test(t)}}),l.add("module","image",{popups:{add:{title:"## popup.add-image ##",width:"100%"},edit:{title:"## popup.image ##",width:"100%",getter:"block.getData",form:{width:{type:"input",width:"100px",label:"## image.width ##",observer:"image.observeImageWidth"},alt:{type:"input",label:"## image.alt-text ##"},caption:{type:"input",label:"## image.caption ##",observer:"image.observeImageCaption"},link:{type:"input",label:"## image.link ##",observer:"image.observeImageLink"},target:{type:"checkbox",text:"## image.link-in-new-tab ##",observer:"image.observeImageLink"}},footer:{save:{title:"## buttons.save ##",command:"image.save",type:"primary"},remove:{title:"## buttons.delete ##",command:"image.remove",type:"danger",right:!0},cancel:{title:"## buttons.cancel ##",command:"popup.close"}}}},init:function(){this.dataStates=[]},popup:function(){this.app.popup.create("image",this.popups.add);var t=this.app.popup.getBody();this._createImageByUrl(t),this._createOrSection(t),this._createUploadBox(t),this._createSelectBox(t),this.app.popup.open()},edit:function(t){this.app.popup.create("image-edit",this.popups.edit),this._buildEditUpload(),this.app.popup.open()},observe:function(t,e,i){var s;return!!this.isImagePopup()&&(s=this.app.block.get(),i&&i.getName()==="addbar"?t.command="image.popup":s&&s.getType()==="image"&&(t.command="image.edit"),t)},observeStates:function(){this._findImages().each(this._addImageState.bind(this))},observeImageLink:function(t){return!!this.opts.image.link&&t},observeImageCaption:function(t){var e=this.app.block.get();return!(!e||e.getTag()!=="figure")&&t},observeImageWidth:function(t){return!!this.opts.image.width&&t},isImagePopup:function(){return this.opts.image!==!1},paste:function(t,e){var i={url:this.opts.image.upload,name:this.opts.image.name,data:this.opts.image.data,multiple:this.opts.image.multiple,success:"image.insertFromBlob",error:"image.error"};this.app.create("upload").send(e,[t],i)},parseInserted:function(t){for(var e,i=[],s={url:this.opts.image.upload,name:this.opts.image.name,data:this.opts.image.data,multiple:!0,success:"image.insertFromInserted",error:"image.error"},n=(this.pasteInsertedImages=[],this.resolved=[],0),a=0;a<t.instances.length;a++){var o,r,p,d=t.instances[a];d.getType()==="image"&&((o=d.getSrc()).search(/^data:/i)!==-1?(r=this._dataURLtoFile(o,"image"+a),i.push(r),this.pasteInsertedImages.push(d)):o.search(/^blob:/i)!==-1&&(n++,this.pasteInsertedImages.push(d),p=this,function(m,y){var N=new XMLHttpRequest;N.open("GET",m,!0),N.responseType="blob",N.onload=function(A){var K;N.status==200&&(K=N.response,K=new File([K],"image"+y,{type:"image/png"}),p.resolved.push(K))},N.send()}(o,a)))}n!==0&&(e=setInterval((function(){this.resolved.length===n&&(clearInterval(e),this.app.create("upload").send(!1,this.resolved,s))}).bind(this),100)),i.length!==0&&this.app.create("upload").send(!1,i,s)},drop:function(t,e){for(var i=[],s=0;s<e.files.length;s++){var n=e.files[s]||e.items[s].getAsFile();n&&i.push(n)}var a,o={url:this.opts.image.upload,name:this.opts.image.name,data:this.opts.image.data,multiple:this.opts.image.multiple,success:"image.insertByDrop",error:"image.error"};0<i.length&&((a=this.dom(t.target).closest("[data-"+this.prefix+"-type]")).length!==0&&this.app.block.set(a),this.app.create("upload").send(t,i,o))},insertFromClipboard:function(t){var e=(e=t.getData("text/plain")||t.getData("text/html")).trim();if(e===""){for(var i=t.items,s=null,n=0;n<i.length;n++)i[n].type.indexOf("image")===0&&(s=i[n].getAsFile());return s!==null?(this.paste(s),!0):void 0}},insertFromBlob:function(t){this.insert(t)},insertByDrop:function(t,e){if(this.app.block.is()){var i=this.app.block.get(),s=e.target,n=i.getType();if(n==="card"&&s&&s.tagName==="IMG"&&i.hasImage()||n==="image")return void this.change(t);e&&n!=="card"&&i.isEditable()&&this.app.insertion.insertPoint(e)}this.insert(t)},insertByUpload:function(t){this.insert(t)},insertByUrl:function(e){e.preventDefault();var e=this.$urlinput.val();e.trim()!==""&&(e={file:{url:e,id:this.app.utils.getRandomId()}},this.insert(e))},insertFromSelect:function(t){t.preventDefault();for(var e=this.dom(t.target),i={url:e.attr("data-url")},s=["id","alt","caption","link","width","height"],n=0;n<s.length;n++){var a=e.attr("data-"+s[n]);a!==null&&(i[s[n]]=a)}this.insert({file:i},!0)},insertFromInserted:function(t){var e,i=0;for(e in t)t.hasOwnProperty(e)&&(this.pasteInsertedImages[i].setImage(t[e]),i++)},changeClone:function(t){for(var e in t)if(t.hasOwnProperty(e)){this.$imageclone.attr("src",t[e].url);break}this.change(t,!1)},change:function(t,e){e!==!1&&this.app.popup.close();var i,s=this.app.block.get();for(i in t)if(t.hasOwnProperty(i))return s.setImage(t[i]),this.app.broadcast("image.change",t[i]),void this.app.broadcast("image.upload",{instance:s,data:t[i]});this.app.parser.buildPredefinedClasses()},save:function(t){this.app.popup.close(),this.app.block.setData(t)},insert:function(t,e){this.app.popup.close(),this.imageslen=0,this.imagescount=0;var i,s,n,a=this.opts.image.tag;for(i in t)t.hasOwnProperty(i)&&(n=this.dom("<"+a+">"),s=this._createImageFromResponseItem(t[i]),n.append(s),s=this.app.create("block.image",n),this.app.block.add({instance:s,type:"image"}),Object.prototype.hasOwnProperty.call(t[i],"caption")&&(n=this.dom("<figcaption>").html(t[i].caption),s.$block.append(n),this.app.create("block.figcaption",n)),this.app.broadcast("image."+(e?"select":"upload"),{instance:s,data:t[i]}),this.$last=s.getBlock(),this.imageslen++)},remove:function(){this.app.popup.close(),this.app.block.remove()},error:function(t){this.app.broadcast("image.upload.error",{response:t})},getStates:function(){var t,e,i,s=this._findImages();for(t in this.dataStates)this.dataStates.hasOwnProperty(t)&&(e=this.dataStates[t],i=s.is('[data-image="'+e.id+'"]'),this._setImageState(e.id,i));return this.dataStates},createUploadBox:function(t,e){if(t)return t=this.dom("<div>"),e.append(t),t},createSelectBox:function(t,e,i){t&&(this.$selectbox=this._createImagesBox(e),typeof t=="object"?this._parseList(t,i):(e=this.opts.editor.reloadmarker?{d:new Date().getTime()}:{},this.ajax.get({url:t,data:e,success:(function(s){this._parseList(s,i)}).bind(this)})))},_findImages:function(){return this.app.editor.getEditor().find("[data-image]")},_addImageState:function(t){var e=t.attr("data-image");this.dataStates[e]={type:"image",status:!0,url:t.attr("src"),$img:t,id:e}},_setImageState:function(t,e){this.dataStates[t].status=e},_checkImageLoad:function(){this.imagescount++,this.imagescount===this.imageslen&&(this.app.block.unset(),this.app.block.set(this.$last))},_buildEditUpload:function(){var t,e,i;this.opts.image.upload&&(i=this.app.block.get(),t=this.app.popup.getBody(),(e=this._createFormItem()).addClass(this.prefix+"-form-item-edit-image-box"),this.$imageclone=i.getImage().clone(),this.$imageclone.removeAttr("width height style"),(i=this.dom("<div>").addClass(this.prefix+"-form-item-image")).append(this.$imageclone),e.append(i),this.$upload=this.dom("<div>"),e.append(this.$upload),t.prepend(e),this._buildUpload(this.$upload,"image.changeClone"))},_buildUpload:function(t,e){this.opts.image.upload&&(e={box:!0,placeholder:this.lang.get("image.upload-new-placeholder"),url:this.opts.image.upload,name:this.opts.image.name,data:this.opts.image.data,multiple:this.opts.image.multiple,success:e,error:"image.error"},this.app.create("upload",t,e))},_createSelectBox:function(t){this.createSelectBox(this.opts.image.select,t,"image.insertFromSelect")},_createUploadBox:function(t){this.$upload=this.createUploadBox(this.opts.image.upload,t),this._buildUpload(this.$upload,"image.insertByUpload")},_createImageFromResponseItem:function(t){for(var e,i=this.dom("<img>").attr("src",t.url).one("load",this._checkImageLoad.bind(this)),s=i,n=["id","alt","width","height"],a=0;a<n.length;a++)Object.prototype.hasOwnProperty.call(t,n[a])&&s.attr(n[a],t[n[a]]);return Object.prototype.hasOwnProperty.call(t,"id")&&s.attr("data-image",t.id),Object.prototype.hasOwnProperty.call(t,"2x")&&s.attr("srcset",t["2x"]+" 2x"),Object.prototype.hasOwnProperty.call(t,"link")&&((e=this.dom("<a>")).attr("href",t.link),i.wrap(e),s=e),s},_createImagesBox:function(t){var e=this.dom("<div>").addClass(this.prefix+"-popup-images-box");return t.append(e),e},_createOrSection:function(t){var e;this.opts.image.url&&(this.opts.image.upload||this.opts.image.select)&&((e=this.dom("<div>").addClass(this.prefix+"-popup-image-section-or")).html(this.lang.get("image.or")),t.append(e))},_createImageByUrl:function(t){var e;this.opts.image.url&&(e=this._createFormItem(),this.$urlinput=this._createUrlInput(),this.$urlbutton=this._createUrlButton(),e.append(this.$urlinput),e.append(this.$urlbutton),t.append(e),this.$urlinput.focus())},_createFormItem:function(){return this.dom("<div>").addClass(this.prefix+"-form-container-flex")},_createUrlInput:function(){var t=this.dom("<input>").addClass(this.prefix+"-form-input");return t.attr("placeholder",this.lang.get("image.url-placeholder")),t},_createUrlButton:function(){var t=this.dom("<button>").addClass(this.prefix+"-form-button "+this.prefix+"-form-button-primary");return t.html(this.lang.get("buttons.insert")),t.one("click",this.insertByUrl.bind(this)),t},_parseList:function(t,e){for(var i in t)if(t.hasOwnProperty(i)){var s=t[i];if(typeof s=="object"){for(var n=this.dom("<img>"),i=s.thumb||s.url,a=(n.addClass(this.prefix+"-popup-event"),n.attr("src",i),n.attr("data-url",s.url),n.attr("data-callback",e),["id","alt","caption","link","width","height"]),o=0;o<a.length;o++)Object.prototype.hasOwnProperty.call(s,a[o])&&n.attr("data-"+a[o],s[a[o]]);n.on("click."+this.prefix+"-popup-event-"+this.uuid,(function(r){var p=this.dom(r.target).attr("data-callback");this.app.api(p,r)}).bind(this)),this.$selectbox.append(n)}}},_dataURLtoFile:function(t,e){for(var t=t.split(","),i=t[0].match(/:(.*?);/)[1],s=atob(t[1]),n=s.length,a=new Uint8Array(n);n--;)a[n]=s.charCodeAt(n);return new File([a],e,{type:i})}}),l.add("module","link",{popups:{format:{items:{format:{title:"## link.link ##",command:"link.format",shortcut:"Ctrl+k"},unlink:{title:"## link.unlink ##",command:"link.unlink"}}},change:{items:{edit:{title:"## link.edit-link ##",command:"link.format",shortcut:"Ctrl+k"},unlink:{title:"## link.unlink ##",command:"link.unlink"}}},create:{title:"## popup.link ##",width:"600px",form:{text:{type:"input",label:"## link.text ##"},url:{type:"input",label:"## link.url ##"},target:{type:"checkbox",text:"## link.link-in-new-tab ##"}},footer:{insert:{title:"## buttons.insert ##",command:"link.insert",type:"primary"},cancel:{title:"## buttons.cancel ##",command:"popup.close"}}},edit:{title:"## popup.link ##",width:"600px",form:{text:{type:"input",label:"## link.text ##"},url:{type:"input",label:"## link.url ##"},target:{type:"checkbox",text:"## link.link-in-new-tab ##"}},footer:{save:{title:"## buttons.save ##",command:"link.save",type:"primary"},cancel:{title:"## buttons.cancel ##",command:"popup.close"}}}},popup:function(t,e){var i=this.getLink().length===0?"format":"change";this.app.popup.create("link-items",this.popups[i]),this.app.popup.open({button:e})},format:function(t){this.app.selection.restore();var e=this.getLink(),i=e.length!==0,s=this.app.selection.getText(),n=(this.app.selection.save(),i?"edit":"create"),n=(this.app.popup.create("link",this.popups[n]),{}),n=i?(n={text:e.text(),url:e.attr("href"),target:e.attr("target")||this.opts.link.target},this._encodeUrl(n)):{text:s,target:this.opts.link.target};this.app.popup.setData(n),this.app.popup.open(i?{focus:"url"}:{focus:s?"url":"text"})},insert:function(){this.app.popup.close();var t=this.app.inline.set({tag:"a",caret:"after"}),t=this.dom(t);this._save(t,"add")},save:function(){this.app.popup.close();var t=this.getLink();this._save(t,"change")},unlink:function(){this.app.popup.close();var t=this.app.selection.getNodes({tags:["a"]});if(t.length!==0){for(var e=0;e<t.length;e++){var i=this.dom(t[e]);this.app.broadcast("link.remove",{url:i.attr("href"),text:i.text()}),i.unwrap()}this.app.toolbar.observe(),this.app.context.observe()}},getLink:function(){var t=this.app.selection.getNodes({tags:["a"]});return t.length!==0?this.dom(t[0]):this.dom()},_save:function(t,e){var i=this.app.popup.getData(),i=this._cleanUrl(i);(i=this._encodeUrl(i)).url===""?t.unwrap():(i=this._setUrl(t,i),t.length===1&&(i=this._setText(t,i)),(i=this._setTarget(t,i)).element=t,this.app.broadcast("link."+e,i))},_cleanUrl:function(t){return t.url=this.app.content.escapeHtml(t.url),t.url=t.url.search(/^javascript:/i)!==-1?"":t.url,t},_encodeUrl:function(t){return t.url=t.url?t.url.replace(/&amp;/g,"&"):"",t},_setUrl:function(t,e){return t.attr("href",e.url),e},_setText:function(t,e){return e.text=e.text===""?e.url:e.text,t.text(e.text),e},_setTarget:function(t,e){return e.target?t.attr("target","_blank"):t.removeAttr("target"),e}}),l.add("module","table",{popups:{cell:{title:"## table.column ##",width:"300px",form:{width:{type:"input",label:"## table.width ##"},nowrap:{type:"checkbox",text:"## table.nowrap ##"}},footer:{insert:{title:"## buttons.save ##",command:"table.save",type:"primary"},cancel:{title:"## buttons.cancel ##",command:"popup.close"}}}},items:{addhead:{title:"## table.add-head ##",command:"table.addHead"},addcolumnafter:{title:"## table.add-column-after ##",command:"table.addColumnAfter"},addcolumnbefore:{title:"## table.add-column-before ##",command:"table.addColumnBefore"},addrowbelow:{title:"## table.add-row-below ##",command:"table.addRowBelow"},addrowabove:{title:"## table.add-row-above ##",command:"table.addRowAbove"},removehead:{title:"## table.remove-head ##",command:"table.removeHead",divider:"top"},removecolumn:{title:"## table.remove-column ##",command:"table.removeColumn"},removerow:{title:"## table.remove-row ##",command:"table.removeRow"},removetable:{title:"## table.delete-table ##",command:"table.removeTable",divider:"top"}},add:function(){var t=this.app.block.add({name:"table",source:this.opts.table.template,caret:"start"}).getFirstCell();t&&this.app.caret.set(t.getBlock(),"start")},observe:function(t,e,i){var s;return!!this.opts.table&&(s=this.app.block.get(),i&&i.getName()==="addbar"?t.command="table.add":s&&s.isType(["table","cell"])&&(t.command="table.popup"),t)},popup:function(t,e){this.app.popup.create("table",{items:this.items}),this.app.popup.open({button:e})},addHead:function(){var t=this.app.block.get().getTable().getBlock(),i=(this.removeHead(),t.find("tr").first().children("td, th").length),e=this.dom("<thead>"),i=this._buildRow(!1,i,"<th>");e.append(i),t.prepend(e),this.app.block.set(i.children("td, th").first(),"start")},addRowBelow:function(){this._addRow("below")},addRowAbove:function(){this._addRow("above")},addColumnBefore:function(){this._addColumn("before")},addColumnAfter:function(){this._addColumn("after")},removeTable:function(){this.app.popup.close(),this.app.block.remove()},removeHead:function(){this.app.popup.close();var t=this.app.block.get().getTable(),e=t.getBlock().find("thead");e.length!==0&&e.remove(),t.getFirst().setCaret("start")},removeRow:function(){this.app.popup.close(),this.app.control.close();var e=this.app.block.get(),t=e.getTable(),e=e.getRow(),i=e.getBlock().closest("thead");i.length!==0?(i.remove(),t.getFirst().setCaret("start")):e.remove()},removeColumn:function(){this.app.popup.close(),this.app.control.close();var t=this.app.block.get().getBlock(),e=t.closest("table"),i=t.closest("tr"),s=0;i.find("td, th").each(function(n,a){n.get()===t.get()&&(s=a)}),e.find("tr").each((function(n){n=n.find("td, th").get(s),this.dom(n).remove()}).bind(this))},cellSetting:function(t,e){var i=this.app.block.get();this.app.popup.create("cell",this.popups.cell).setData({width:i.getWidth(),nowrap:i.getNowrap()}),this.app.popup.open({button:e,focus:"width"})},save:function(e){this.app.popup.close();var e=e.getData(),i=this.app.block.get();e.width!==""&&i.setWidth(e.width),i.setNowrap(e.nowrap)},_addColumn:function(t){this.app.popup.close();var e,i=this.app.block.get().getBlock(),s=i.closest("table"),n=i.closest("tr"),a=0,o=(n.find("td, th").each(function(r,p){r.get()===i.get()&&(a=p)}),0);s.find("tr").each(function(r,p){r.get()===n.get()&&(o=p)}),s.find("tr").each((function(d,p){var d=d.find("td, th").get(a),d=this.dom(d),m=d.clone();m.html(""),this.app.create("block.cell",m),o===p&&(e=m),d[t](m)}).bind(this)),e&&this.app.block.set(e,"start")},_addRow:function(e){this.app.popup.close();var e=e==="below"?"after":"before",s=this.app.block.get().getBlock(),i=s.closest("tr"),s=s.closest("thead"),n=i.children("td, th").length,n=this._buildRow(i,n,"<td>");s.length!==0?s.after(n):i[e](n),this.app.block.set(n.find("td, th").first(),"start")},_buildRow:function(t,e,i){if(t===!1){t=this.dom("<tr>");for(var s=0;s<e;s++){var n=this.dom(i);this.app.create("block.cell",n),t.append(n)}}else(t=t.clone()).find("td, th").html("");return this.app.create("block.row",t),t.find("td, th").each((function(a){this.app.create("block.cell",a)}).bind(this)),t}}),l.add("module","context",{init:function(){this.customButtons={},this.activeClass="active",this.eventname="."+this.prefix+"-context",this.aTags={},this.aTypes={},this.clickOffset=!1},start:function(){this.opts.context&&this._build()},stop:function(){this.app.scroll.isTarget()&&this.app.scroll.getTarget().off(this.eventname),this.opts.context&&this.$context.remove()},isOpen:function(){this.$context.hasClass("open")},close:function(){this.opts.context&&this._close()},add:function(t,e){this.customButtons[t]=e},observe:function(){this.opts.context&&this._observe()},_doOpen:function(t){this.opts.context===!1||this.app.utils.isMobile()||setTimeout((function(){this._isSelection()?this._open(t):this._isInstance()&&this.clickOffset&&this.clickOffset.x===t.pageX&&this.clickOffset.y===t.pageY?(this.clickOffset=!1,this._open(t)):(this._close(),this.clickOffset={x:t.pageX,y:t.pageY})}).bind(this),0)},_open:function(t){this.$context.html(""),this._buildButtons(),this._buildCustomButtons(),this._buildActiveButtons(),this._buildPosition(t),this._buildEvents(),this._observe()},_close:function(){this.$context.removeClass("open"),this.$context.hide(),this.app.editor.getEditor().off(this.eventname),this.app.scroll.isTarget()&&this.app.scroll.getTarget().off(this.eventname)},_isSelection:function(){return!this.app.blocks.is()&&this._isInstance()&&this.app.selection.is()&&!this.app.selection.isCollapsed()},_isInstance:function(){var e=this.app.block.get(),t=e&&e.isEditable(),e=e&&e.getType()!=="pre";return t&&e},_scroll:function(){var t,e,i=this.app.selection.getPosition().bottom+this.app.$doc.scrollTop();this.$context.css("top",i+2+"px"),this.app.scroll.isTarget()&&(t=(e=this.app.scroll.getTarget()).offset().top+e.height(),e=e.offset().top,t<i+this.$context.height()||i<e?this.$context.hide():this.$context.show())},_build:function(){this.$context=this.dom("<div>").addClass(this.prefix+"-context "+this.prefix+"-context-"+this.uuid).hide(),this.app.$body.append(this.$context),this.app.editor.getEditor().on("mouseup."+this.prefix+"-context-up",this._doOpen.bind(this))},_buildButtons:function(){for(var t=this.opts.buttons.context,e=c.extend(!0,{},this.opts.buttonsObj),i=0;i<t.length;i++){var s=t[i],n=e[s];this.app.create("button",s,n,this.$context,"context")}},_buildCustomButtons:function(){var t,e=this.customButtons;for(t in e)e.hasOwnProperty(t)&&this.app.create("button",t,e[t],this.$context,"context")},_buildPosition:function(s){var e=this.$context.width(),i=this.app.editor.getRect(),n=this.app.selection.getPosition(),s=s.pageX-e/2,n=n.bottom+this.app.$doc.scrollTop();(s=s<i.left?i.left+4:s)+e>i.right&&(s=i.right-e-4),this.$context.css({left:s+"px",top:n+2+"px"}),this.$context.addClass("open"),this.$context.show()},_buildEvents:function(){var t=this.app.editor.getEditor();t.on("mousedown"+this.eventname,this._close.bind(this)),t.on("keydown"+this.eventname,this._close.bind(this)),this.app.scroll.isTarget()&&this.app.scroll.getTarget().on("scroll"+this.eventname,this._scroll.bind(this))},_buildActiveButtons:function(){var t=this.app.observer.buildActiveButtons(this.customButtons);this.aTags=t.tags,this.aTypes=t.types},_observe:function(){var t;this._unsetActive(),this.app.observer.isButtons()&&(t=this.app.observer.buildButtons(this.aTags,this.aTypes),this._setActiveKeys(t))},_setActiveKeys:function(t){for(var e=0;e<t.length;e++)this._findButton(t[e]).addClass(this.activeClass)},_unsetActive:function(){this._findButtons().removeClass(this.activeClass)},_findButtons:function(){return this.$context.find("."+this.prefix+"-button-context")},_findButton:function(t){return this.$context.find("[data-name="+t+"]")}}),l.add("module","topbar",{init:function(){this.activeClass="active",this.toggledClass="disable",this.disableClass="disable",this.customButtons={}},start:function(){this._isTopbar()&&this._build()},load:function(){this._buildButtons()},get:function(t){return this._findButton(t)},add:function(t,e){this.customButtons[t]=e},setToggled:function(t){this._isTopbar()&&(this._findButtons().removeClass(this.toggledClass),this._findButton(t).addClass(this.toggledClass))},unsetToggled:function(t){this._isTopbar()&&(t?this._findButton(t):this._findButtons()).removeClass(this.toggledClass)},enable:function(){this._isTopbar()&&this._findButtons().removeClass(this.disableClass)},disable:function(){this._isTopbar()&&this._findButtons().removeClass(this.toggledClass).removeClass(this.activeClass).addClass(this.disableClass)},_isTopbar:function(){return this.opts.topbar},_build:function(){this.$topbar=this.dom("<div>").addClass(this.prefix+"-topbar"),this.app.container.get("toolbar").append(this.$topbar)},_buildButtons:function(){var t,e=this.app.editor.getButtonsFromArr(this.opts.buttons.topbar),e=c.extend(!0,{},e,this.customButtons);for(t in e=this.opts.topbar.add?c.extend(!0,{},e,this.opts.topbar.add):e)!e.hasOwnProperty(t)||this.opts.topbar.hide&&this.opts.topbar.hide.indexOf(t)!==-1||this.app.create("button",t,e[t],this.$topbar,"topbar")},_findButtons:function(){return this.$topbar.find("."+this.prefix+"-button-topbar")},_findButton:function(t){return this.$topbar.find("[data-name="+t+"]")}}),l.add("module","control",{init:function(){this.instance=!1,this.customItems={},this.eventName=this.prefix+"-control"},start:function(){this._build()},stop:function(){this._isControl()&&this.$control.remove(),this.instance=!1},getElement:function(){return this.$control},add:function(t,e){this.customItems[t]=e},build:function(){var t;!this._isControl()||(t=this.app.block.get()).isFigcaption()||((t=t.isSecondLevel()?t.getFirstLevel():t)?this.open(t):this.close())},open:function(t){this._isControl()&&(this.instance=t,this.instance?(this.$control.show(),this.updatePosition(),(t=this.app.scroll.getTarget()).on("resize."+this.eventName,this.updatePosition.bind(this)),t.on("scroll."+this.eventName,this.updatePosition.bind(this)),this.$button.off("."+this.prefix+"-control-button"),this.app.$win.off("."+this.prefix+"-control-button"),this.opts.control&&this.$button.on("click."+this.prefix+"-control-button",this._click.bind(this)),this.opts.reorder&&this.$button.on("mousedown."+this.prefix+"-control-button touchstart."+this.prefix+"-control-button",this._press.bind(this))):this.close())},close:function(){var t;this._isControl()&&(this.$control.hide(),this.instance&&(t=this.instance.getBlock(),this.app.content.unfixListMargin(t)),this.app.scroll.getTarget().off("."+this.eventName),this.instance=!1)},updatePosition:function(){var t,e,i,s;this._isControl()&&(this.instance?(this.instance.getType()==="list"&&(t=this.instance.getBlock(),this.app.content.fixListMargin(t)),t=this.instance.isEditable(),e=this.instance.getOffset(),s=this.$control.width(),t=e.top-(t?-3:4),e=e.left-s-4,this.$control.show(),this.app.scroll.isTarget()&&(i=(s=this.app.scroll.getTarget()).offset().top+s.height(),s=s.offset().top,i<t+this.$control.height()||t<s)&&this.$control.hide(),this.$control.css({top:t+"px",left:e+"px"})):this.close())},_isControl:function(){return this.opts.control||this.opts.reorder},_click:function(t){t.preventDefault(),t.stopPropagation();var e,i={},s=this.app.editor.getButtonsFromArr(this.instance.control);for(e in s=c.extend(!0,{},s,this.customItems))this.instance.isAllowedButton(e,s[e])&&(i[e]=s[e],i[e].icon=s[e].icon||!0,i[e].control=!0);this.app.popup.create("control",{items:i}),this.app.context.close(),this.app.popup.open({control:this.$button})},_press:function(t){t.preventDefault(),t.stopPropagation(),setTimeout((function(){this.app.$win.on("mouseup."+this.prefix+"-control-button touchend."+this.prefix+"-control-button",this._release.bind(this)),this.app.$win.on("mousemove."+this.prefix+"-control-button touchmove."+this.prefix+"-control-button",this._move.bind(this))}).bind(this),0)},_release:function(t){this.$button.removeClass(this.prefix+"-handle"),this.app.$win.off("."+this.prefix+"-control-button"),this.app.observer.trigger=!0,this.app.event.trigger=!1,this.oldY=0,this.dragging=!1,this._trashDragItem(),this.updatePosition(),this.$control.show(),setTimeout((function(){this.app.block.set(this.instance,"start",!0),this.app.event.trigger=!0}).bind(this),2)},_move:function(t){t.preventDefault(),this.$button.hasClass(this.prefix+"-handle")||(s=this.instance.getBlock().get(),this.$button.addClass(this.prefix+"-handle"),this.dragging=!0,this.$dragItem=this._makeDragItem(s,t.target),this.$control.hide());for(var e,i,s=!1,n=this.oldY===0?0:this.oldY-t.pageY,n=(0<n?s="up":n<0&&(s="down"),this._moveItem(this.$dragItem,n),this.oldY=t.pageY,t.pageY),t=this.app.editor.getRect(),a=this.app.$doc.scrollTop(),o=a>t.top?a+40:t.top+40,r=this.app.$win.height()+a-40,p=t.top,d=t.top+this.app.editor.getEditor().height(),m=(this.app.scroll.isTarget()&&(p=(i=(e=this.app.scroll.getTarget()).offset()).top,o=a>t.top?i.top+40:o,r=(d=i.top+e.height())-40),s==="up"&&n<o&&p<n?this._scroll(-10):s==="down"&&r<n&&n<d&&this._scroll(10),this.app.editor.getEditor().children()),y=m.length,N=0;N<y;N++){var A=m.eq(N).get();A!==this.$clickItem.get()&&this._isOver(this.dom(A))&&this._swapItems(A)}},_build:function(){this.$control=this.dom("<div>").addClass(this.prefix+"-control "+this.prefix+"-control-"+this.uuid).hide(),this.$button=this.dom("<span>").addClass(this.prefix+"-icon-sort "+this.prefix+"-button "+this.prefix+"-button-control"),this.$control.append(this.$button),this.opts.bsmodal&&this.$control.css("z-index",1060),this.app.$body.append(this.$control)},_isOver:function(s){var e=this.$dragItem.offset().top,i=s.offset(),s=s.height();return e>i.top&&e<i.top+s},_scroll:function(t){var e=this.app.scroll.isTarget()?this.app.scroll.getTarget():this.app.$win,i=e.scrollTop();e.scrollTop(i+t)},_swapItems:function(s){var e=this.$dragItem.offset().top,i=this.$clickItem,s=this.dom(s),n=s.offset(),a=s.height()/2;s[a+n.top>e?"before":"after"](i)},_moveItem:function(t,e){var i=t.offset().top;t.css("top",(i-=e)+"px"),this.$control.css("top",i+"px")},_makeDragItem:function(e){this._trashDragItem();var e=this.dom(e),i=e.offset(),s=(this.$clickItem=e,this.$clickItem.addClass(this.prefix+"-drag-active"),e.clone()),n=(s.removeClass(this.prefix+"-drag-active "+this.prefix+"-element-active"),s.css({"font-family":e.css("font-family"),"font-size":e.css("font-size"),"line-height":e.css("line-height"),margin:0,padding:0}),this.dom("<div>").addClass(this.prefix+"-dragging"));return n.append(s),n.css({opacity:.95,position:"absolute","z-index":999,left:i.left+"px",top:i.top+"px",width:e.width()+"px"}),this.app.$body.append(n),n},_trashDragItem:function(){this.$dragItem&&this.$clickItem&&(this.$clickItem.removeClass(this.prefix+"-drag-active"),this.$clickItem=null,this.$dragItem.remove(),this.$dragItem=null)}}),l.add("class","tool.checkbox",{mixins:["tool"],type:"checkbox",input:{tag:"input",type:"checkbox",classname:"-form-checkbox"},getValue:function(){return this.$input.val()},_buildInput:function(){var t;this.$box=this.dom("<label>").addClass(this.prefix+"-form-checkbox-item"),this.$box.append(this.$input),this._has("text")&&(t=this.dom("<span>").html(this.lang.parse(this.obj.text)),this.$box.append(t)),this.$tool.append(this.$box)}}),l.add("class","tool.input",{mixins:["tool"],type:"input",input:{tag:"input",type:"text",classname:"-form-input"},_buildInput:function(){this.$tool.append(this.$input)}}),l.add("class","tool.number",{mixins:["tool"],type:"number",input:{tag:"input",type:"number",classname:"-form-input"},_buildInput:function(){this.$input.attr("min",0).css("max-width","65px"),this.$tool.append(this.$input)}}),l.add("class","tool.segment",{mixins:["tool"],type:"segment",input:{tag:"input",type:"hidden",classname:"-form-input"},setValue:function(t){this.$segment.find("."+this.prefix+"-form-segment-item").removeClass("active"),this.$segment.find("[data-segment="+t+"]").addClass("active"),this.$input.val(t)},_buildInput:function(){this.$segment=this.dom("<div>").addClass(this.prefix+"-form-segment");var t,e,i=this.obj.segments;for(t in i)i.hasOwnProperty(t)&&((e=this.dom("<span>").addClass(this.prefix+"-form-segment-item")).attr("data-segment",t).on("click",this._catchSegment.bind(this)),Object.prototype.hasOwnProperty.call(i[t],"icon")?e.html(i[t].icon):e.addClass(this.prefix+"-icon-"+i[t].prefix+"-"+t),this.$segment.append(e));this.$segment.append(this.$input),this.$tool.append(this.$segment)},_catchSegment:function(e){e.preventDefault(),e.stopPropagation();var e=this.dom(e.target).closest("."+this.prefix+"-form-segment-item"),i=e.attr("data-segment");this.$segment.find("."+this.prefix+"-form-segment-item").removeClass("active"),e.addClass("active"),this.$input.val(i),this.app.api(this.setter,this.popup)}}),l.add("class","tool.select",{mixins:["tool"],type:"select",input:{tag:"select",classname:"-form-select"},_buildInput:function(){for(var t in this.obj.options){var e;this.obj.options.hasOwnProperty(t)&&((e=this.dom("<option>")).val(t),e.html(this.lang.parse(this.obj.options[t])),this.$input.append(e))}this.$tool.append(this.$input)}}),l.add("class","tool.textarea",{mixins:["tool"],type:"textarea",input:{tag:"textarea",classname:"-form-textarea"},setFocus:function(){this.$input.focus(),this.$input.get().setSelectionRange(0,0),this.$input.scrollTop(0)},_buildInput:function(){this._has("rows")&&this.$input.attr("rows",this._get("rows")),this.$input.attr("data-gramm_editor",!1),this.$tool.append(this.$input)}}),l.add("class","tool.upload",{mixins:["tool"],type:"upload",input:{tag:"input",type:"hidden",classname:"-form-input"},setValue:function(t){t=t||"",this.upload&&this.upload.setImage(t),this.$input.val(t)},_buildInput:function(){this.$tool.append(this.$input),this._buildUpload()},_buildUpload:function(){this.$upload=this.dom("<input>").attr("type","file"),this.$tool.append(this.$upload);var t={};this._has("trigger")&&this._get("trigger")&&(t={instance:this,method:"trigger"}),this.upload=this.app.create("upload",this.$upload,this.obj.upload,t)}}),l.add("block","block.address",{mixins:["block"],type:"address",editable:!0,toolbar:{add:{title:"## buttons.add ##",command:"addbar.popup"},html:{title:"## buttons.html ##",command:"source.toggle"},format:{title:"## buttons.format ##",command:"format.popup"},bold:{title:"## buttons.bold ##",command:"inline.set",params:{tag:"b"}},italic:{title:"## buttons.italic ##",command:"inline.set",params:{tag:"i"}},deleted:{title:"## buttons.deleted ##",command:"inline.set",params:{tag:"del"}},link:{title:"## buttons.link ##",command:"link.popup"}},control:{add:{title:"## buttons.add ##",command:"addbar.popup"},format:{title:"## buttons.format ##",command:"format.popup"},duplicate:{title:"## buttons.duplicate ##",command:"block.duplicate"},trash:{title:"## buttons.delete ##",command:"block.remove"}},create:function(){return this.dom("<address>")},handleEnter:function(t){if(t.preventDefault(),this.isEmpty()||this.isCaretEnd()){var t=this.getBlock(),i=t.children(),s=i.length,e=i.eq(s-1),i=i.eq(s-2),s=t.html().trim();if((s=this.app.utils.removeInvisibleChars(s)).search(/<br\s?\/?>$/)!==-1)return i.remove(),e.remove(),void this.insertEmpty({position:"after",caret:"start"})}return this.app.insertion.insertBreakline(),!0}}),l.add("block","block.cell",{mixins:["block"],type:"cell",editable:!0,create:function(){return this.dom("<td>")},getTable:function(){return this.getParent("table")},getRow:function(){return this.getParent("row")},getNextCell:function(){var t,e=this.getNext();return e||(t=this.getParent("row"))&&(t=t.getNextRow())&&(e=t.getChildFirst("cell")),e},getPrevCell:function(){var t,e=this.getPrev();return e||(t=this.getParent("row"))&&(t=t.getPrevRow())&&(e=t.getChildLast("cell")),e},getWidth:function(){var t=this.$block.attr("width");return t||""},getNowrap:function(){return this.$block.hasClass(this.prefix+"-nowrap")},setWidth:function(t){this._eachCell(function(e){t===""?e.removeAttr("width"):(t=t.search("%")!==-1?t:t.replace("px",""),e.attr("width",t))})},setNowrap:function(t){this._eachCell((function(e){var i=this.opts.table.nowrap+" "+this.prefix+"-nowrap";t?e.addClass(i):e.removeClass(i)}).bind(this))},handleArrow:function(t,e,i){var s,n,a=this.getTable(),r=a.getBlock(),o=this.app.caret.is(r,"start"),r=this.app.caret.is(r,"end");return i.is("up-left")&&o?(t.preventDefault(),(s=a.getPrev())?this.app.block.set(s,"end"):this.app.insertion.insertEmptyBlock({current:a,position:"before",caret:"start"}),!0):i.is("down-right")&&r?(t.preventDefault(),(n=a.getNext())?this.app.block.set(n,"start"):this.app.insertion.insertEmptyBlock({current:a,position:"after",caret:"start"}),!0):i.is("up-left")&&this.isCaretStart()?(t.preventDefault(),(s=(s=this.getPrevCell())||this.getFirstLevel().getPrev())&&this.app.block.set(s,"end"),!0):i.is("down-right")&&this.isCaretEnd()?(t.preventDefault(),(n=(n=this.getNextCell())||this.getFirstLevel().getNext())&&this.app.block.set(n,"start"),!0):void 0},handleTab:function(t){return t.preventDefault(),t=this.getNextCell(),(t=t||this.getFirstLevel().getNext())&&this.app.block.set(t,"start"),!0},handleEnter:function(t){return t.preventDefault(),this.app.insertion.insertBreakline(),!0},_eachCell:function(t){var e=0,i=this.$block.closest("table");this.$block.closest("tr").find("td, th").each((function(s,n){s.get()===this.$block.get()&&(e=n)}).bind(this)),i.find("tr").each((function(s){s=s.find("td, th").get(e),s=this.dom(s),t(s)}).bind(this))}}),l.add("block","block.pre",{mixins:["block"],type:"pre",editable:!0,toolbar:{add:{title:"## buttons.add ##",command:"addbar.popup"},html:{title:"## buttons.html ##",command:"source.toggle"}},control:{add:{title:"## buttons.add ##",command:"addbar.popup"},duplicate:{title:"## buttons.duplicate ##",command:"block.duplicate"},trash:{title:"## buttons.delete ##",command:"block.remove"}},create:function(){return this.dom(this.opts.pre.template)},build:function(){this._buildCaption(),this._buildItems("figcaption","figcaption")},handleTab:function(t){return t.preventDefault(),t=this.opts.pre.spaces,t=document.createTextNode(Array(t+1).join(" ")),this.app.insertion.insertNode(t,"end"),!0},handleEnter:function(t){return t.preventDefault(),t=this.$block.html().search(/\n$/),this.isCaretEnd()&&t===-1?this.app.insertion.insertNewline("after",!0):this.app.insertion.insertNewline(),!0}}),l.add("block","block.embed",{mixins:["block"],type:"embed",editable:!1,toolbar:{add:{title:"## buttons.add ##",command:"addbar.popup"},html:{title:"## buttons.html ##",command:"source.toggle"},embed:{title:"## blocks.embed ##",command:"embed.popup",observer:"embed.observe"}},control:{add:{title:"## buttons.add ##",command:"addbar.popup"},duplicate:{title:"## buttons.duplicate ##",command:"block.duplicate"},trash:{title:"## buttons.delete ##",command:"block.remove"}},create:function(){return this.dom("<figure>")},build:function(){this._buildCaption(),this._buildItems("figcaption","figcaption"),this._buildEmbedCode()},addResponsive:function(){var t=this.dom("<div>").addClass(this.opts.embed.responsive),e=this.$block.find("figcaption"),i=e.clone(),s=this.getEmbedCode();e.remove(),t.html(s),this.$block.html("").append(t),i.length!==0&&(this.app.create("block.figcaption",i),this.$block.append(i)),this._buildEmbedCode()},removeResponsive:function(){this.$block.find(this._getEmbedClass()).unwrap()},getEmbedCode:function(){return decodeURI(this.$block.attr("data-embed-code"))},isResponsive:function(){return this.$block.find(this._getEmbedClass()).length!==0},_buildEmbedCode:function(){var t=this.$block.clone(),t=(t.find(this._getEmbedClass()).unwrap(),t.find("figcaption").remove(),t.html().trim());this.$block.attr("data-embed-code",encodeURI(t))},_getEmbedClass:function(){return"."+this.opts.embed.responsive.replace(/ +/g,".")}}),l.add("block","block.figcaption",{mixins:["block"],type:"figcaption",editable:!0,toolbar:{bold:{title:"## buttons.bold ##",command:"inline.set",params:{tag:"b"}},italic:{title:"## buttons.italic ##",command:"inline.set",params:{tag:"i"}},deleted:{title:"## buttons.deleted ##",command:"inline.set",params:{tag:"del"}},link:{title:"## buttons.link ##",command:"link.popup"}},create:function(){return this.dom("<figcaption>")},getFigure:function(){return this.$block.closest("figure").dataget("instance")},handleArrow:function(t,e,i){if(i.is("up-left")&&this.isCaretStart()||i.is("down-right")&&this.isCaretEnd())return t.preventDefault(),i=this.getFigure(),this.app.block.set(i),!0},handleTab:function(t){return t.preventDefault(),t=this.getFigure(),this.app.block.set(t),!0},handleEnter:function(t){return t.preventDefault(),this.isEmpty()||this.isCaretEnd()||this.isCaretStart()||this.app.insertion.insertBreakline(),!0}}),l.add("block","block.heading",{mixins:["block"],type:"heading",editable:!0,toolbar:{add:{title:"## buttons.add ##",command:"addbar.popup"},html:{title:"## buttons.html ##",command:"source.toggle"},format:{title:"## buttons.format ##",command:"format.popup"},bold:{title:"## buttons.bold ##",command:"inline.set",params:{tag:"b"}},italic:{title:"## buttons.italic ##",command:"inline.set",params:{tag:"i"}},deleted:{title:"## buttons.deleted ##",command:"inline.set",params:{tag:"del"}},link:{title:"## buttons.link ##",command:"link.popup"}},control:{add:{title:"## buttons.add ##",command:"addbar.popup"},format:{title:"## buttons.format ##",command:"format.popup"},duplicate:{title:"## buttons.duplicate ##",command:"block.duplicate"},trash:{title:"## buttons.delete ##",command:"block.remove"}},create:function(){return this.dom("<h2>")},getTitle:function(){var t=this.lang.get("headings"),e=this.getTag(),i=this.$block.attr("data-title");return t[e]!==void 0?t[e]:i},handleEnter:function(t){return t.preventDefault(),this.isEmpty()||this.isCaretEnd()?this.insertEmpty({position:"after",caret:"start",remove:!1}):this.isCaretStart()?this.insert({instance:this.duplicateEmpty(),position:"before"}):(t=this.getBlock(),t=this.app.element.split(t),this.app.block.set(t,"start")),!0}}),l.add("block","block.image",{mixins:["block"],type:"image",editable:!1,toolbar:{add:{title:"## buttons.add ##",command:"addbar.popup"},html:{title:"## buttons.html ##",command:"source.toggle"},image:{title:"## blocks.image ##",command:"image.popup",observer:"image.observe"}},control:{add:{title:"## buttons.add ##",command:"addbar.popup"},duplicate:{title:"## buttons.duplicate ##",command:"block.duplicate"},trash:{title:"## buttons.delete ##",command:"block.remove"}},create:function(){return this.dom("<"+this.opts.image.tag+">")},build:function(){this._buildCaption(),this._buildItems("figcaption","figcaption"),this.data={alt:{getter:"getAlt",setter:"setAlt"},width:{getter:"getWidth",setter:"setWidth"},link:{getter:"getLinkUrl",setter:"setLinkUrl"},target:{getter:"getTarget",setter:"setTarget"},caption:{getter:"getCaption",setter:"setCaption"}}},getImage:function(){return this.$block.find("img").eq(0)},getSrc:function(){return this.getImage().attr("src")},getId:function(){return this.getImage().attr("data-image")},getLink:function(){var t=this.getImage().parent();return t=t.get().tagName==="A"&&t},getWidth:function(){var e=this.getImage(),t=e.css("width"),e=e.attr("width");return t=e&&e.search(/%/)!==-1?e:t},getAlt:function(){var t=this.getImage().attr("alt");return t||""},getLinkUrl:function(){var t=this.getLink();return t?t.attr("href"):""},getTarget:function(){var t=this.getLink();return t?t.attr("target"):this.opts.image.newtab},setWidth:function(t){var e,i,s,n=this.getImage();(t=t.trim())===""?n.removeAttr("width"):(e=(s=t.search(/%/)!==-1)?t:parseInt(t),i=n.width()/n.height(),s?(n.removeAttr("height"),n.attr({width:e})):(s=Math.round(e/i),n.attr({width:e,height:s}))),n.css({width:t,"max-width":t}),this.app.broadcast("image.width",{image:n,width:t})},setAlt:function(t){var e=this.getImage();t=t.replace(/"/g,"'"),e.attr("alt",t)},setTarget:function(t){var e=this.getLink();e&&(t?e.attr("target","_blank"):e.removeAttr("target"))},setLinkUrl:function(t){if(i=this.getLink()){if(t==="")return this.removeLink(),void this.app.broadcast("image.unlink",{instance:this});i.attr("href",t)}else if(!i){if(t==="")return;var e=this.getImage(),i=this.dom("<a>");e.wrap(i),i.attr("href",t)}this.app.broadcast("image.link",{instance:this,link:i})},setImage:function(t){var e=this.getImage();e.attr("src",t.url),Object.prototype.hasOwnProperty.call(t,"id")&&e.attr("data-image",t.id),Object.prototype.hasOwnProperty.call(t,"2x")&&e.attr("srcset",t["2x"]+" 2x")},removeLink:function(){var t=this.getLink();t&&t.unwrap()}}),l.add("block","block.line",{mixins:["block"],type:"line",editable:!1,toolbar:{add:{title:"## buttons.add ##",command:"addbar.popup"},html:{title:"## buttons.html ##",command:"source.toggle"}},control:{add:{title:"## buttons.add ##",command:"addbar.popup"},format:{title:"## buttons.format ##",command:"format.popup"},duplicate:{title:"## buttons.duplicate ##",command:"block.duplicate"},trash:{title:"## buttons.delete ##",command:"block.remove"}},create:function(){return this.dom("<hr>")}}),l.add("block","block.list",{mixins:["block"],type:"list",editable:!0,toolbar:{add:{title:"## buttons.add ##",command:"addbar.popup"},html:{title:"## buttons.html ##",command:"source.toggle"},format:{title:"## buttons.format ##",command:"format.popup"},bold:{title:"## buttons.bold ##",command:"inline.set",params:{tag:"b"}},italic:{title:"## buttons.italic ##",command:"inline.set",params:{tag:"i"}},deleted:{title:"## buttons.deleted ##",command:"inline.set",params:{tag:"del"}},indent:{title:"## buttons.indent ##",command:"list.indent"},outdent:{title:"## buttons.outdent ##",command:"list.outdent"},link:{title:"## buttons.link ##",command:"link.popup"}},control:{add:{title:"## buttons.add ##",command:"addbar.popup"},format:{title:"## buttons.format ##",command:"format.popup"},duplicate:{title:"## buttons.duplicate ##",command:"block.duplicate"},trash:{title:"## buttons.delete ##",command:"block.remove"}},create:function(t){return t&&t.tag?this.dom("<"+t.tag+">"):this.dom("<ul>")},setCaret:function(t){var e=this.$block;t==="start"?e=this.$block.find("li").first():t==="end"&&(e=this.$block.find("li").last()),this.app.caret.set(e,t)},setEmpty:function(){this.$block.html("");var t=this.dom("<li>");this.$block.append(t),this.app.caret.set(t,"start")},isEmpty:function(){var t=this.$block.html(),t=this._cleanEmpty(t),e=this.$block.find("li");return e.length===0?(t=t.trim())==="":e.length===1&&(t=e.eq(0).html(),(t=this._cleanEmpty(t))==="")},handleTab:function(t){var i=this.app.selection.getBlock(),e=this.app.caret.is(i,"start"),i=this.app.element.isEmpty(i);if(i&&(t.preventDefault(),this.app.list.indent()))return!0;if(this.isCaretStart()||this.isCaretEnd()){if(i=this.getNext(),i)return t.preventDefault(),this.app.block.set(i,"start"),!0}else if(!this.opts.tab.spaces||e)return t.preventDefault(),this.app.list.indent(),!0},handleEnter:function(t){var e,i,s,n,a;if(t.preventDefault(),this.isEmpty()||this.isCaretEnd()){if(e=this.app.selection.getBlock(),i=this.dom(e),n=this.app.content.isEmptyHtml(e.innerHTML))return i.remove(),this.insertEmpty({position:"after",caret:"start"}),!0;a=this.dom("<li>"),this.app.element.cloneAttrs(e,a),this.dom(e).after(a),this.app.caret.set(a,"start"),this.app.broadcast("list.item",{element:a})}else this.isCaretStart()?(a=this.dom("<li>"),e=this.app.selection.getBlock(),this.app.element.cloneAttrs(e,a),this.dom(e).before(a)):(e=this.app.selection.getBlock(),i=this.dom(e),n=this.app.content.isEmptyHtml(e.innerHTML),t=this.app.caret.is(e,"start"),s=this.app.caret.is(e,"end",["ul","ol"]),a=this.dom("<li>"),this.app.element.cloneAttrs(e,a),n?(i.after(a),this.app.caret.set(a,"start")):t?i.before(a):s?((n=i.find("ul, ol").first()).length!==0&&(a.append(this.app.utils.createInvisibleChar()),a.append(n)),i.after(a),this.app.caret.set(a,"start")):(t=this.app.element.split(e),this.app.caret.set(a=t,"start")),this.app.broadcast("list.item",{element:a}));return!0}}),l.add("block","block.paragraph",{mixins:["block"],type:"paragraph",editable:!0,toolbar:{add:{title:"## buttons.add ##",command:"addbar.popup"},html:{title:"## buttons.html ##",command:"source.toggle"},format:{title:"## buttons.format ##",command:"format.popup"},bold:{title:"## buttons.bold ##",command:"inline.set",params:{tag:"b"}},italic:{title:"## buttons.italic ##",command:"inline.set",params:{tag:"i"}},deleted:{title:"## buttons.deleted ##",command:"inline.set",params:{tag:"del"}},link:{title:"## buttons.link ##",command:"link.popup"}},control:{add:{title:"## buttons.add ##",command:"addbar.popup"},format:{title:"## buttons.format ##",command:"format.popup"},duplicate:{title:"## buttons.duplicate ##",command:"block.duplicate"},trash:{title:"## buttons.delete ##",command:"block.remove"}},create:function(){return this.dom("<p>")},handleEnter:function(t){var e;if(t.preventDefault(),this.isEmpty()||this.isCaretEnd()){if(e=this.app.block.create(),this.opts.clean.enter||(e=this.duplicateEmpty()).getBlock().removeAttr("id"),!this.opts.clean.enterinline){var t=this.app.selection.getInline();if(t){for(var i,s,n=this.app.element.getAllInlines(t),a=0;a<n.length;a++)a===0?((i=n[a].cloneNode()).removeAttribute("id"),i.innerHTML=""):((s=n[a].cloneNode()).removeAttribute("id"),s.innerHTML="",i.appendChild(s));e=this.app.block.create(i.outerHTML)}}this.insert({instance:e,position:"after",caret:"start",remove:!1})}else this.isCaretStart()?((e=this.duplicate()).getBlock().html(""),this.insert({instance:e,position:"before"})):(t=this.getBlock(),e=this.app.element.split(t),this.app.block.set(e,"start"));return!0}}),l.add("block","block.quote",{mixins:["block"],type:"quote",toolbar:{add:{title:"## buttons.add ##",command:"addbar.popup"},html:{title:"## buttons.html ##",command:"source.toggle"},bold:{title:"## buttons.bold ##",command:"inline.set",params:{tag:"b"}},italic:{title:"## buttons.italic ##",command:"inline.set",params:{tag:"i"}},deleted:{title:"## buttons.deleted ##",command:"inline.set",params:{tag:"del"}},link:{title:"## buttons.link ##",command:"link.popup"}},control:{add:{title:"## buttons.add ##",command:"addbar.popup"},duplicate:{title:"## buttons.duplicate ##",command:"block.duplicate"},trash:{title:"## buttons.delete ##",command:"block.remove"}},create:function(){return this.dom(this.opts.quote.template)},build:function(){this._buildCaption(),this._buildItems("p","quoteitem"),this._buildItems("figcaption","figcaption")},getLast:function(){return this._getLast()},getFirst:function(){return this._getFirst()},getFirstElement:function(){return this._getFirst().getBlock()},_getFirst:function(){return this.$block.find("p").first().dataget("instance")},_getLast:function(){return this.$block.find("p").last().dataget("instance")}}),l.add("block","block.quoteitem",{mixins:["block"],type:"quoteitem",editable:!0,create:function(){return this.dom("<p>")},getBlockquote:function(){return this.$block.closest("blockquote").dataget("instance")},handleArrow:function(t,e,i){var s,n=this.getBlockquote(),a=n.getBlock();if(a.length!==0)return s=this.app.caret.is(a,"start"),a=this.app.caret.is(a,"end"),i.is("up-left")&&s?(t.preventDefault(),(s=this.getFirstLevel().getPrev())?this.app.block.set(s,"end"):this.app.insertion.insertEmptyBlock({current:n,position:"before",caret:"start"}),!0):i.is("down-right")&&a?(t.preventDefault(),(s=this.getFirstLevel().getNext())?this.app.block.set(s,"start"):this.app.insertion.insertEmptyBlock({current:n,position:"after",caret:"start"}),!0):void 0},handleTab:function(t){return t.preventDefault(),t=this.getNext(),(t=t||this.getFirstLevel().getNext())&&this.app.block.set(t,"start"),!0},handleEnter:function(e){e.preventDefault();var e=this.app.create("block.quoteitem");return this.isEmpty()||this.isCaretEnd()?this.insert({instance:e,position:"after",caret:"start"}):this.isCaretStart()?this.insert({instance:e,position:"before"}):(e=this.getBlock(),e=this.app.element.split(e),this.app.block.set(e,"start")),!0}}),l.add("block","block.row",{mixins:["block"],type:"row",create:function(){return this.dom("<tr>")},getNextRow:function(){var t=this.getNext(),e=this.$block.parent();return t=t||e.get().tagName==="TABLE"?t:e.nextElement().find("tr").first().dataget("instance")},getPrevRow:function(){var t=this.getPrev(),e=this.$block.parent();return t=t||e.get().tagName==="TABLE"?t:e.prevElement().find("tr").last().dataget("instance")}}),l.add("block","block.table",{mixins:["block"],type:"table",toolbar:{add:{title:"## buttons.add ##",command:"addbar.popup"},html:{title:"## buttons.html ##",command:"source.toggle"},table:{title:"## blocks.table ##",command:"table.add",observer:"table.observe",params:{name:"table"}},bold:{title:"## buttons.bold ##",command:"inline.set",params:{tag:"b"}},italic:{title:"## buttons.italic ##",command:"inline.set",params:{tag:"i"}},deleted:{title:"## buttons.deleted ##",command:"inline.set",params:{tag:"del"}},link:{title:"## buttons.link ##",command:"link.popup"},tune:{title:"## buttons.column-settings ##",command:"table.cellSetting"}},control:{add:{title:"## buttons.add ##",command:"addbar.popup"},table:{title:"## blocks.table ##",command:"table.add",observer:"table.observe",params:{name:"table"}},tune:{title:"## buttons.column-settings ##",command:"table.cellSetting",icon:"tune"},duplicate:{title:"## buttons.duplicate ##",command:"block.duplicate"},trash:{title:"## buttons.delete ##",command:"block.remove"}},create:function(){return this.dom(this.opts.table.template)},build:function(){this._buildItems("tr","row"),this._buildItems("td, th","cell"),this._buildNowrap()},getLast:function(){return this.getLastCell()},getFirst:function(){return this.getFirstCell()},getFirstElement:function(){return this.getFirstCell().getBlock()},getFirstCell:function(){var t=this.$block.find("th, td").first();if(t.length!==0)return t.dataget("instance")},getLastCell:function(){var t=this.$block.find("th, td").last();if(t.length!==0)return t.dataget("instance")},_buildNowrap:function(){this.$block.find("th, td").each((function(t){t.hasClass(this.opts.table.nowrap)&&t.addClass(this.prefix+"-nowrap")}).bind(this))}}),l.add("block","block.layer",{mixins:["block"],type:"layer",nested:!0,toolbar:{add:{title:"## buttons.add ##",command:"addbar.popup"},html:{title:"## buttons.html ##",command:"source.toggle"}},control:{add:{title:"## buttons.add ##",command:"addbar.popup"},duplicate:{title:"## buttons.duplicate ##",command:"block.duplicate"},trash:{title:"## buttons.delete ##",command:"block.remove"}}}),l.add("block","block.dlist",{mixins:["block"],type:"dlist",editable:!0,toolbar:{add:{title:"## buttons.add ##",command:"addbar.popup"},html:{title:"## buttons.html ##",command:"source.toggle"},format:{title:"## buttons.format ##",command:"format.popup"},bold:{title:"## buttons.bold ##",command:"inline.set",params:{tag:"b"}},italic:{title:"## buttons.italic ##",command:"inline.set",params:{tag:"i"}},deleted:{title:"## buttons.deleted ##",command:"inline.set",params:{tag:"del"}},link:{title:"## buttons.link ##",command:"link.popup"}},control:{add:{title:"## buttons.add ##",command:"addbar.popup"},format:{title:"## buttons.format ##",command:"format.popup"},duplicate:{title:"## buttons.duplicate ##",command:"block.duplicate"},trash:{title:"## buttons.delete ##",command:"block.remove"}},create:function(){return this.dom("<dl>")},getPlainText:function(t){var e="",i=this.$block.find("dt, dd"),s=i.length;return i.each(function(n,a){a=a!==s&&t?"<br>":"",e+=n.html()+a}),e},setEmpty:function(){this.$block.html("");var t=this.dom("<dt>");this.$block.append(t),this.app.caret.set(t,"start")},isEmpty:function(){var t=this.$block.html(),t=this._cleanEmpty(t),e=this.$block.find("dt, dd");return e.length===0?(t=t.trim())==="":e.length===1&&(t=e.eq(0).html(),(t=this._cleanEmpty(t))==="")},handleEnter:function(t,e,i){if(t.preventDefault(),this.isEmpty()||this.isCaretEnd()){var t=this.app.selection.getBlock(),s=this.dom(t),n=t.tagName.toLowerCase(),a=this.app.content.isEmptyHtml(t.innerHTML);if(n==="dt"&&a)return s.remove(),this.insertEmpty({position:"after",caret:"start"}),!0;a=n==="dt"?this.dom("<dd>"):this.dom("<dt>"),this.dom(t).after(a),this.app.caret.set(a,"start")}else{if(this.isCaretStart())return!0;this.app.insertion.insertBreakline()}return!0}}),window.RedactorX=l,window.addEventListener("load",function(){l("[data-redactorx]")}),typeof module=="object"&&module.exports&&(module.exports=l,module.exports.RedactorX=l)})();const vi=RedactorX;RedactorX.lang.ru={accessibility:{"help-label":"Визуальный текстовый редактор"},placeholders:{figcaption:"Введите подпись (необязательно)"},popup:{back:"Назад",link:"Ссылка",add:"Добавить",image:"Изображение","add-image":"Добавить изображение"},shortcuts:{"meta-a":"Выделить всё","meta-z":"Отменить","meta-shift-z":"Повторить","meta-shift-m":"Очистить форматирование","meta-b":"Жирный","meta-i":"Курсив","meta-u":"Подчёркивание","meta-h":"Верхний индекс","meta-l":"Нижний индекс","meta-k":"Ссылка","meta-alt-0":"Обычный текст","meta-alt-1":"Заголовок 1","meta-alt-2":"Заголовок 2","meta-alt-3":"Заголовок 3","meta-alt-4":"Заголовок 4","meta-alt-5":"Заголовок 5","meta-alt-6":"Заголовок 6","meta-shift-7":"Нумерованный список","meta-shift-8":"Маркированный список","meta-indent":"Увеличить отступ","meta-outdent":"Уменьшить отступ","meta-shift-backspace":"Удалить","meta-shift-o":"Добавить","meta-shift-d":"Дублировать абзац","meta-shift-up":"Передвинуть вверх","meta-shift-down":"Передвинуть вниз"},buttons:{add:"Добавить",html:"HTML",format:"Формат",bold:"Жирный",italic:"Курсив",deleted:"Зачёркнутый",link:"Ссылка",list:"Список",image:"Изображение",indent:"Увеличить отступ",outdent:"Уменьшить отступ",embed:"Объект",table:"Таблица",insert:"Вставить",save:"Сохранить",cancel:"Отмена",delete:"Удалить",duplicate:"Дублировать абзац",shortcut:"Сочетания клавиш",underline:"Подчёркивание",undo:"Отменить",redo:"Повторить",code:"Фрагмент кода",mark:"Отметка",subscript:"Нижний индекс",superscript:"Верхний индекс",kbd:"Сочетание клавиш","image-settings":"Настройки изображения","column-settings":"Настройки столбца"},blocks:{text:"Текст",paragraph:"Абзац",image:"Изображение",embed:"Объект",line:"Линия",table:"Таблица",quote:"Цитата",pre:"Фрагмент кода",address:"Адрес"},format:{p:"Обычный текст",h1:"Заголовок 1",h2:"Заголовок 2",h3:"Заголовок 3",h4:"Заголовок 4",h5:"Заголовок 5",h6:"Заголовок 6",address:"Адрес",ul:"Маркированный список",ol:"Нумерованный список",dl:"Список определений"},embed:{embed:"Объект",caption:"Надпись",description:"Вставьте любой HTML-код для встраивания или URL (только Vimeo или YouTube)","responsive-video":"Адаптивное видео"},image:{or:"или","alt-text":"Текст для атрибута alt",link:"Ссылка",width:"Ширина",caption:"Надпись","link-in-new-tab":"Открывать ссылку в новой вкладке","url-placeholder":"Вставьте URL изображения...","upload-new-placeholder":"Перетащите файл для загрузки изображения<br>или нажмите здесь"},link:{link:"Ссылка","edit-link":"Редактировать ссылку",unlink:"Удалить ссылку","link-in-new-tab":"Открывать ссылку в новой вкладке",text:"Текст",url:"URL"},table:{width:"Ширина",nowrap:"Не переносить текст по строкам",column:"Столбец","add-head":"Добавить заголовок","remove-head":"Удалить заголовок","add-row-below":"Добавить строку ниже","add-row-above":"Добавить строку выше","remove-row":"Удалить строку","add-column-after":"Добавить столбец справа","add-column-before":"Добавить столбец слева","remove-column":"Удалить столбец","delete-table":"Удалить таблицу"},alignment:{alignment:"Выравнивание"},blockcode:{save:"Сохранить",cancel:"Отмена","edit-code":"Редактировать код"},clips:{clips:"Clips"},counter:{words:"words",chars:"chars"},filelink:{file:"File",upload:"Upload",title:"Title",choose:"Choose",placeholder:"Drag to upload a file<br>or click to select"},icons:{icons:"Icons"},imageposition:{"image-position":"Выравнивание изображения"},imageresize:{"image-resize":"Image resize"},inlineformat:{"inline-format":"Стиль текста",underline:"Подчёркивание",superscript:"Верхний индекс",subscript:"Нижний индекс",mark:"Выделение",code:"Фрагмент кода",shortcut:"Сочетание клавиш","remove-format":"Очистить форматирование"},removeformat:{removeformat:"Очистить форматирование"},specialchars:{"special-chars":"Специальные символы"}};RedactorX.add("plugin","alignment",{translations:{en:{alignment:{alignment:"Alignment"}}},defaults:{align:{left:"align-left",center:"align-center",right:"align-right",justify:"align-justify"}},start:function(){this.app.toolbar.add("alignment",{title:"## alignment.alignment ##",command:"alignment.popup",position:{after:"format"},blocks:{all:"editable"}})},popup:function(u,l){var h,g={},_=this.opts.alignment.align;for(h in _)_[h]&&(g[h]={name:_[h],prefix:"align"});this.app.popup.create("alignment",{setter:"alignment.setAlign",getter:"alignment.getAlign",form:{align:{type:"segment",label:"## alignment.alignment ##",segments:g}}}),this.app.popup.open({button:l})},getAlign:function(){var u=this.opts.alignment.align;if(!u)return!1;var l,h=this.app.block.get().getBlock(),g="left";for(l in u)h.hasClass(u[l])&&(g=l);return{align:g}},setAlign:function(u){this.app.popup.close(),u=u.getData(),this.app.block.get().setClassFromObj(this.opts.alignment.align,u.align)}});RedactorX.add("plugin","blockcode",{translations:{en:{blockcode:{save:"Save",cancel:"Cancel","edit-code":"Edit Code"}}},defaults:{icon:'<svg height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="m10.6128994 3.20970461.0942074.08318861 4 4c.3604839.36048396.3882135.92771502.0831886 1.32000622l-.0831886.09420734-4 4.00000002c-.3905243.3905243-1.02368929.3905243-1.41421358 0-.36048396-.360484-.3882135-.927715-.08318861-1.3200062l.08318861-.0942074 3.29210678-3.2928932-3.29210678-3.29289322c-.36048396-.36048396-.3882135-.92771502-.08318861-1.32000622l.08318861-.09420734c.36048396-.36048396.92771498-.3882135 1.32000618-.08318861zm-3.90579262.08318861c.36048396.36048396.3882135.92771502.08318861 1.32000622l-.08318861.09420734-3.29210678 3.29289322 3.29210678 3.2928932c.36048396.360484.3882135.927715.08318861 1.3200062l-.08318861.0942074c-.36048396.3604839-.92771502.3882135-1.32000622.0831886l-.09420734-.0831886-4-4.00000002c-.36048396-.36048396-.3882135-.92771502-.08318861-1.32000622l.08318861-.09420734 4-4c.39052429-.39052429 1.02368927-.39052429 1.41421356 0z"/></svg>',popup:{width:"100%",title:"## blockcode.edit-code ##",form:{code:{type:"textarea",rows:"8"}},footer:{save:{title:"## blockcode.save ##",command:"blockcode.save",type:"primary"},cancel:{title:"## blockcode.cancel ##",close:!0}}}},init:function(){this.offset=!1},start:function(){this.app.control.add("blockcode",{icon:this.opts.blockcode.icon,command:"blockcode.edit",title:"## blockcode.edit-code ##",position:{before:"duplicate"}})},edit:function(){var u=this._getCurrent(),l=u.getOuterHtml(),l=this.app.parser.unparse(l);u.isEditable()&&(this.offset=this.app.offset.get(u.getBlock())),this.app.popup.create("code",this.opts.blockcode.popup),this.app.popup.setData({code:l}),this.app.popup.open({focus:"code"}),this._buildInputHandle(),this._buildCodemirror()},save:function(){this.app.popup.close();var u=this._getCurrent(),l=this._getCode();l!==""&&(l=this.app.parser.parse(l,!1),l=this.dom(l),l=this.app.create("block."+u.getType(),l),u.change(l),this.offset&&l.isEditable()&&this.app.offset.set(l.getBlock(),this.offset),this.offset=!1)},_getCurrent:function(){var u=this.app.block.get();return u=u.isSecondLevel()?u.getFirstLevel():u},_getCode:function(){var u=this.app.popup.getData().code.trim();return this.app.codemirror.val(u)},_buildInputHandle:function(){this.app.popup.getInput("code").on("keydown",this.app.input.handleTextareaTab.bind(this))},_buildCodemirror:function(){var u=this.app.popup.getInput("code");this.app.codemirror.create({el:u,height:"200px",focus:!0}),this.app.popup.updatePosition()}});RedactorX.add("plugin","imageposition",{translations:{en:{imageposition:{"image-position":"Image position"}}},defaults:{icon:'<svg height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="m15 13c.5522847 0 1 .4477153 1 1s-.4477153 1-1 1h-13c-.55228475 0-1-.4477153-1-1s.44771525-1 1-1zm-5-12c.5522847 0 1 .44771525 1 1v8c0 .5522847-.4477153 1-1 1h-8c-.55228475 0-1-.4477153-1-1v-8c0-.55228475.44771525-1 1-1zm5 8c.5522847 0 1 .44771525 1 1 0 .5522847-.4477153 1-1 1h-2c-.5522847 0-1-.4477153-1-1 0-.55228475.4477153-1 1-1zm-10-1-1 1h2zm4-5h-6v5l2-2 3 3h1zm6 2c.5522847 0 1 .44771525 1 1s-.4477153 1-1 1h-2c-.5522847 0-1-.44771525-1-1s.4477153-1 1-1zm-8-1c.55228475 0 1 .44771525 1 1s-.44771525 1-1 1-1-.44771525-1-1 .44771525-1 1-1zm8-3c.5522847 0 1 .44771525 1 1s-.4477153 1-1 1h-2c-.5522847 0-1-.44771525-1-1s.4477153-1 1-1z"/></svg>',items:{none:"none",left:"float-left",center:"align-center",right:"float-right"},icons:{none:'<svg height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="m12 3c.5522847 0 1 .44771525 1 1v8c0 .5522847-.4477153 1-1 1h-8c-.55228475 0-1-.4477153-1-1v-8c0-.55228475.44771525-1 1-1zm-5 7-1 1h2zm4-5h-6v5l2-2 3 3h1zm-2 1c.55228475 0 1 .44771525 1 1s-.44771525 1-1 1-1-.44771525-1-1 .44771525-1 1-1z"/></svg>',left:'<svg height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="m10 3c.5522847 0 1 .44771525 1 1v8c0 .5522847-.4477153 1-1 1h-8c-.55228475 0-1-.4477153-1-1v-8c0-.55228475.44771525-1 1-1zm5 8c.5522847 0 1 .4477153 1 1s-.4477153 1-1 1h-2c-.5522847 0-1-.4477153-1-1s.4477153-1 1-1zm-10-1-1 1h2zm4-5h-6v5l2-2 3 3h1zm6 2c.5522847 0 1 .44771525 1 1s-.4477153 1-1 1h-2c-.5522847 0-1-.44771525-1-1s.4477153-1 1-1zm-8-1c.55228475 0 1 .44771525 1 1s-.44771525 1-1 1-1-.44771525-1-1 .44771525-1 1-1zm8-3c.5522847 0 1 .44771525 1 1s-.4477153 1-1 1h-2c-.5522847 0-1-.44771525-1-1s.4477153-1 1-1z"/></svg>',center:'<svg height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="m12 3c.5522847 0 1 .44771525 1 1v8c0 .5522847-.4477153 1-1 1h-8c-.55228475 0-1-.4477153-1-1v-8c0-.55228475.44771525-1 1-1zm3 8c.5522847 0 1 .4477153 1 1s-.4477153 1-1 1-1-.4477153-1-1 .4477153-1 1-1zm-14 0c.55228475 0 1 .4477153 1 1s-.44771525 1-1 1-1-.4477153-1-1 .44771525-1 1-1zm6-1-1 1h2zm4-5h-6v5l2-2 3 3h1zm4 2c.5522847 0 1 .44771525 1 1s-.4477153 1-1 1-1-.44771525-1-1 .4477153-1 1-1zm-14 0c.55228475 0 1 .44771525 1 1s-.44771525 1-1 1-1-.44771525-1-1 .44771525-1 1-1zm8-1c.55228475 0 1 .44771525 1 1s-.44771525 1-1 1-1-.44771525-1-1 .44771525-1 1-1zm6-3c.5522847 0 1 .44771525 1 1s-.4477153 1-1 1-1-.44771525-1-1 .4477153-1 1-1zm-14 0c.55228475 0 1 .44771525 1 1s-.44771525 1-1 1-1-.44771525-1-1 .44771525-1 1-1z"/></svg>',right:'<svg height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="m14 3c.5522847 0 1 .44771525 1 1v8c0 .5522847-.4477153 1-1 1h-8c-.55228475 0-1-.4477153-1-1v-8c0-.55228475.44771525-1 1-1zm-11 8c.55228475 0 1 .4477153 1 1s-.44771525 1-1 1h-2c-.55228475 0-1-.4477153-1-1s.44771525-1 1-1zm6-1-1 1h2zm4-5h-6v5l2-2 3 3h1zm-10 2c.55228475 0 1 .44771525 1 1s-.44771525 1-1 1h-2c-.55228475 0-1-.44771525-1-1s.44771525-1 1-1zm8-1c.5522847 0 1 .44771525 1 1s-.4477153 1-1 1-1-.44771525-1-1 .4477153-1 1-1zm-8-3c.55228475 0 1 .44771525 1 1s-.44771525 1-1 1h-2c-.55228475 0-1-.44771525-1-1s.44771525-1 1-1z"/></svg>'}},start:function(){this.app.toolbar.add("imageposition",{title:"## imageposition.image-position ##",command:"imageposition.popup",icon:this.opts.imageposition.icon,position:{after:"image"},blocks:{types:["image"]}})},popup:function(u,l){var h,g={},_=this.opts.imageposition.items;for(h in _)_[h]&&(g[h]={name:_[h],icon:this.opts.imageposition.icons[h]});this.app.popup.create("imageposition",{setter:"imageposition.setFloat",getter:"imageposition.getFloat",form:{ifloat:{type:"segment",label:"## imageposition.image-position ##",segments:g}}}),this.app.popup.open({button:l})},getFloat:function(){var u=this.opts.imageposition.items;if(!u)return!1;var l,h=this.app.block.get().getBlock(),g="none";for(l in u)h.hasClass(u[l])&&(g=l);return{ifloat:g}},setFloat:function(l){this.app.popup.close();var l=l.getData(),h=this.app.block.get();h.setClassFromObj(this.opts.imageposition.items,l.ifloat),this.app.broadcast("image.position",{image:h.getImage(),position:l.ifloat})}});RedactorX.add("plugin","removeformat",{translations:{en:{removeformat:{removeformat:"Remove Format"}}},defaults:{icon:'<svg height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="m8 11c.51283584 0 .93550716.3860402.99327227.8833789l.00672773.1166211v1c0 .5522847-.44771525 1-1 1-.51283584 0-.93550716-.3860402-.99327227-.8833789l-.00672773-.1166211v-1c0-.5522847.44771525-1 1-1zm-4.60436072-5.91850958.10436072.05248418 9.5262794 5.5c.4782927.2761424.6421678.8877328.3660254 1.3660254-.2564179.4441289-.8020741.6171529-1.2616646.4185096l-.1043608-.0524842-9.5262794-5.5c-.47829262-.27614237-.64216778-.88773278-.3660254-1.3660254.25641792-.44412886.80207419-.61715287 1.26166468-.41850958zm9.60436072-3.08149042c.5522847 0 1 .44771525 1 1 0 .51283584-.3860402.93550716-.8833789.99327227l-.1166211.00672773h-4.00016698l.00016698 2c0 .55228475-.44771525 1-1 1-.51283584 0-.93550716-.38604019-.99327227-.88337887l-.00672773-.11662113-.00016698-2h-3.99983302c-.55228475 0-1-.44771525-1-1 0-.51283584.38604019-.93550716.88337887-.99327227l.11662113-.00672773z"/></svg>'},start:function(){var u={title:"## removeformat.removeformat ##",icon:this.opts.removeformat.icon,command:"inline.removeFormat",position:{after:["deleted","italic"]},blocks:{all:"editable"}};this.app.toolbar.add("removeformat",u),this.app.context.add("removeformat",u)}});RedactorX.add("plugin","inlineformat",{translations:{en:{inlineformat:{"inline-format":"Inline Format",underline:"Underline",superscript:"Superscript",subscript:"Subscript",mark:"Mark",code:"Code",shortcut:"Shortcut","remove-format":"Remove Format"}}},defaults:{icon:'<svg height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="m7.39849577 1.20113038c-3.5610278 2.68125517-5.39849577 5.14152807-5.39849577 7.49360646 0 3.50902886 2.59345039 6.30526316 6 6.30526316 3.4065496 0 6-2.7962343 6-6.30526316 0-2.35207839-1.837468-4.81235129-5.39849577-7.49360646-.35616697-.26817384-.84684149-.26817384-1.20300846 0zm.60150423 2.06186962.28200813.22720401c2.50634097 2.04313256 3.71799187 3.80538426 3.71799187 5.20453283 0 2.43669386-1.73306 4.30526316-4 4.30526316-2.26694005 0-4-1.8685693-4-4.30526316 0-1.39914857 1.21165095-3.16140027 3.71799187-5.20453283z"/></svg>',items:["u","sup","sub","mark","code","kbd"],itemsObj:{u:{title:'<span style="text-decoration: underline;">## inlineformat.underline ##</span>',params:{tag:"u"},shortcut:"Ctrl+u"},sup:{title:"## inlineformat.superscript ##<sup>x</sup>",params:{tag:"sup"},shortcut:"Ctrl+h"},sub:{title:"## inlineformat.subscript ##<sub>x</sub>",params:{tag:"sub"},shortcut:"Ctrl+l"},mark:{title:'<span style="background: yellow;">## inlineformat.mark ##</span>',params:{tag:"mark"}},code:{title:'<span style="font-family: monospace; background: #f0f1f2; padding: 4px;">## inlineformat.code ##</span>',params:{tag:"code"}},kbd:{title:"## inlineformat.shortcut ##",params:{tag:"kbd"}}}},start:function(){this.app.toolbar.add("inlineformat",{title:"## inlineformat.inline-format ##",icon:this.opts.inlineformat.icon,command:"inlineformat.popup",position:{after:"deleted"},blocks:{all:"editable"}})},popup:function(u,l){for(var h=this.opts.inlineformat.items,g=this.app.selection.getNodes({type:"inline"}),_={},x=0;x<h.length;x++){var k=h[x];_[k]=this.opts.inlineformat.itemsObj[k],_[k].command="inline.set"}g.length!==0&&(_.remove={title:"## inlineformat.remove-format ##",divider:"top",command:"inline.removeFormat"}),this.app.popup.create("inlineformat",{width:"300px",items:_}),this.app.popup.open({button:l})}});const _i=vi,ki=["data-custom-style"],yi=["value","name","placeholder"],xi=F({__name:"RedactorX",props:{modelValue:{},placeholder:{},name:{},config:{},customStyle:{},disabled:{type:Boolean}},emits:["update:modelValue"],setup(u,{emit:l}){const h=u,g={control:!0,context:!0,editor:{lang:St||"en",minHeight:"min-content"},replaceTags:!1,clean:{enter:!1,comments:!0},buttons:{topbar:["undo","redo","shortcut"]},topbar:!0,toolbar:{hide:["bold","italic","deleted","link"]},format:["p","h1","h2","h3","h4","h5","ul","ol"],plugins:["alignment","blockcode","imageposition","removeformat","inlineformat"]},_=I(),x=I({subscribe:{"editor.change"(e){const i=e.get("html");return t(i),i}}}),k=I();it(c),Et(C);function c(){h.config?x.value={...x.value,...h.config}:x.value={...x.value,...g},_.value=_i(k.value,x.value)}function C(){var e;(e=_.value)==null||e.destroy(),_.value=null}function t(e){l("update:modelValue",e)}return(e,i)=>(f(),$("div",{class:P(["custom-redactor-x",{disabled:h.disabled}]),"data-custom-style":h.customStyle||"none"},[b("textarea",{ref_key:"textareaRef",ref:k,value:h.modelValue,name:e.name,placeholder:e.placeholder},null,8,yi)],10,ki))}});const $i=F({__name:"DealHeaderDescription",props:{edit:{type:Boolean},descriptionSanitized:{},descriptionPlain:{},description:{},canEdit:{type:Boolean}},setup(u){const l=u,h=Bt(l,"edit"),g=I(l.descriptionSanitized),_=I(l.descriptionPlain);Z(()=>l.description,()=>{g.value=l.descriptionSanitized,_.value=l.descriptionPlain});const x=I(!1),k=It(0),c=L(()=>JSON.stringify(g.value)!==JSON.stringify(l.descriptionSanitized));async function C(){x.value=!0,await M().changeDescription(g.value),x.value=!1}function t(){g.value=l.descriptionSanitized,k.inc()}return(e,i)=>(f(),S(kt,{class:"deal-description","background-btn-more":"var(--deal-sidebar-background-color)",edit:v(h),onCollapse:i[1]||(i[1]=s=>h.value=!1)},{preview:E(()=>[W(B(_.value),1)]),full:E(()=>[(f(),S(xi,{key:v(k).count.value,modelValue:g.value,"onUpdate:modelValue":i[0]||(i[0]=s=>g.value=s),"custom-style":"dealHeader",disabled:!l.canEdit},null,8,["modelValue","disabled"]))]),submit:E(()=>[c.value||x.value?(f(),$(R,{key:0},[T(pt,{size:"smaller","is-fetching":x.value,"delay-loading":300,onClick:D(C,["prevent"])},{default:E(()=>[W(B(e.$t("save")),1)]),_:1},8,["is-fetching","onClick"]),T(pt,{size:"smaller",bg:"light-gray",onClick:D(t,["prevent"])},{default:E(()=>[W(B(e.$t("cancel")),1)]),_:1},8,["onClick"])],64)):w("",!0)]),_:1},8,["edit"]))}}),Ci={class:"deal-header"},wi={class:"deal-header__back"},Ti={key:0,class:"deal-header__inner"},Ei={class:"deal-header__top"},Si={class:"deal-header__title"},Bi={class:"deal-header__right"},Ii={class:"tw-flex tw-items-center tw-flex-wrap tw-gap-1.5 tw-justify-end tw-min-h-[32px]"},Ni={key:0,class:"deal-header__lost-text"},Ai={key:1,class:"tw-flex tw-gap-1.5"},Li=b("button",{class:"button circle blank smaller"},[b("i",{class:"fas fa-ellipsis-h"})],-1),Di={key:2,class:"skeleton"},Fi=b("div",{class:"skeleton-custom-circle tw-w-7 tw-h-7 !tw-m-0"},null,-1),Pi=[Fi],Oi={key:3,class:"gray small tw-ml-1"},Hi={key:0,class:"tw-text-right"},Ri={class:"deal-header__bottom"},Mi=F({__name:"DealHeader",setup(u){const l=M(),{deal:h,eventEditing:g,statusCode:_}=q(l),x=L(()=>!!h.value&&h.value.rights.can_edit),k=L(()=>!!h.value&&h.value.status_id!=="OPEN");return(c,C)=>{var t,e,i,s,n,a,o;return f(),$("div",Ci,[b("div",wi,[T(J)]),[403,404].includes(Number(v(_)))?w("",!0):(f(),$("div",Ti,[b("div",Ei,[b("div",Si,[T(ft,{editing:v(g).name,"deal-id":(t=v(h))==null?void 0:t.id,"deal-name":(e=v(h))==null?void 0:e.name,"can-edit":x.value,"is-closed":k.value,onEditing:C[0]||(C[0]=r=>v(g).name=r)},null,8,["editing","deal-id","deal-name","can-edit","is-closed"])]),b("div",Bi,[b("div",Ii,[((i=v(h))==null?void 0:i.status_id)==="LOST"&&((s=v(h))!=null&&s.lost_text)?(f(),$("div",Ni,B(v(h).lost_text),1)):w("",!0),T(gt),(n=v(h))!=null&&n.id?(f(),$("div",Ai,[k.value?w("",!0):(f(),S(st,{key:0,"use-options":["name","description","delete"]},{default:E(()=>[Li]),_:1})),T(_t,{"deal-id":(a=v(h))==null?void 0:a.id,"is-pinned":(o=v(h))==null?void 0:o.is_pinned},null,8,["deal-id","is-pinned"])])):(f(),$("div",Di,Pi)),v(h)?(f(),$("div",Oi," id: "+B(v(h).id),1)):w("",!0)]),k.value?(f(),$("div",Hi,[T(bt)])):w("",!0)])]),b("div",Ri,[v(h)?(f(),S($i,{key:0,edit:v(g).description,"onUpdate:edit":C[1]||(C[1]=r=>v(g).description=r),"description-plain":v(h).description_plain,"description-sanitized":v(h).description_sanitized,description:v(h).description,"can-edit":x.value},null,8,["edit","description-plain","description-sanitized","description","can-edit"])):w("",!0)])]))])}}});const ji={class:"deal-container"},zi={class:"deal"},Ui={class:"deal-content"},Wi={key:0},qi={key:0,class:"deal-info-sidebar sidebar right flexbox width-adaptive-widest bordered-left wide-mobile !tw-overflow-y-scroll"},As=F({__name:"DealView",props:{dealId:{},unique:{}},setup(u){const l=u,h=Nt(),{tabs:g}=q(h);h.setDealId(l.dealId),h.bindOnClick("dealMessagesTab",r),h.bindOnClick("dealRemindersTab",r);const _=M(),{deal:x,statusCode:k,error:c,isFetching:C}=q(_),t=L(()=>[403,404].includes(Number(k.value))&&c.value?c.value:null);Z([()=>l.dealId,()=>l.unique],()=>{_.fetchById(l.dealId)},{immediate:!0});const e=At(Pt),i=I(null),s=I(!0),n=I(!1),{y:a}=Lt(i,{throttle:200});Dt(a,(p,d)=>{n.value=p<d},{throttle:150});const o=L(()=>{var p;return!O.webView&&((p=x.value)!=null&&p.external_id)&&/shop:\d+/.test(x.value.external_id)?x.value.external_id.replace("shop:",""):null});function r(){setTimeout(()=>{e.value?window.scrollTo({top:document.body.scrollHeight,left:0,behavior:"smooth"}):i.value&&i.value.scrollTo({top:i.value.scrollHeight,left:0,behavior:"smooth"})},50)}return(p,d)=>{const m=ut("RouterView");return f(),$("div",ji,[b("div",zi,[b("div",{ref_key:"scrollableContainerRef",ref:i,class:P(["deal-main",{"deal-main--hide-scroll":!v(Ft)()&&s.value,"!tw-overflow-hidden":p.$route.name==="dealRemindersTab"}]),onMouseenter:d[0]||(d[0]=y=>s.value=!1),onMouseleave:d[1]||(d[1]=y=>s.value=!0)},[(f(),S(Q,null,[(f(),S(ot(v(e)?gi:Mi)))],1024)),b("div",Ui,[T(Gt,{tabs:v(g),"is-fetching":v(C),"sticky-tabs":!v(e)&&n.value,"includes-indent":["dealHistoryTab","dealNotesTab","dealFilesTab","dealInvoicesTab","dealCallsTab","dealRemindersTab"],"error-code":v(k),"error-message":t.value},{beforeTabs:E(()=>[v(O).webView?w("",!0):(f(),S(Rt,{key:0,"entity-type":"deal","entity-id":l.dealId},null,8,["entity-id"]))]),default:E(()=>[T(m,null,{default:E(({Component:y})=>[(f(),S(Q,null,[(f(),S(ot(y),{key:p.$route.fullPath}))],1024))]),_:1}),z(b("div",null,[T(X,null,{default:E(()=>[T(Y,{src:`${v(O).baseUrl}reminder/all/?iframe=1&deal=${p.$route.params.id}${p.$route.query.focus?"&focus=1":""}`,"disable-resize":!0,class:"mobile:tw-min-h-[calc(100vh-9.6rem)] supports-[height:1dvh]:mobile:tw-min-h-[calc(100dvh-9.6rem)]",onLoaded:r},null,8,["src"])]),_:1})],512),[[U,p.$route.name==="dealRemindersTab"]]),z(b("div",null,[T(X,null,{default:E(()=>[T(Y,{src:`${v(O).baseUrl}call/?iframe=1&deal=${p.$route.params.id}`,"force-resize":!0,"static-position":!0},null,8,["src"])]),_:1})],512),[[U,p.$route.name==="dealCallsTab"]]),z(b("div",null,[T(X,null,{default:E(()=>[(f(),S(Y,{key:String(p.$route.query.conversationId),src:p.$route.query.conversationId?`${v(O).baseUrl}message/conversation/${p.$route.query.conversationId}/?iframe=1&deal=${p.$route.params.id}`:`${v(O).baseUrl}message/?iframe=1&deal=${p.$route.params.id}`,"disable-resize":!0,class:"md:!tw-h-[calc(100vh-7.6rem)] mobile:!tw-h-[calc(100vh-7.6rem)] supports-[height:1dvh]:mobile:tw-max-h-[calc(100dvh-7.6rem)]",onLoaded:r},null,8,["src"]))]),_:1})],512),[[U,p.$route.name==="dealMessagesTab"]]),o.value?z((f(),$("div",Wi,[T(X,null,{default:E(()=>[T(Y,{src:`${v(O).baseUrl}?module=order&id=${o.value}`,"force-resize":!0,"static-position":!0},null,8,["src"])]),_:1})],512)),[[U,p.$route.name==="dealOrderTab"]]):w("",!0)]),_:1},8,["tabs","is-fetching","sticky-tabs","error-code","error-message"])])],34),(f(),S(Q,null,[v(e)?w("",!0):(f(),$("div",qi,[T(mt)]))],1024))])])}}});export{As as default};
