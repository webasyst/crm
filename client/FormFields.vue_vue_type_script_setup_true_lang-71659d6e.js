import{d as U,h as F,J as K,l as V,P as D,o as r,i as $,w as s,A as x,p as m,a as c,e as A,c as g,F as I,b as _,n as Q,j as N,q as P,a1 as j,aN as ee,u as B,az as te,y as se,t as ae,N as le,k as G,v as H}from"./main-2290994d.js";import{W as oe}from"./WaSpinner-299938a2.js";import{C as L}from"./CustomColumn-c63128eb.js";import{C as X,a as Y}from"./ChipsList-0fe31c28.js";import{a as R}from"./FieldCheckbox-4d368f68.js";import{_ as ne}from"./DropdownAddTags.vue_vue_type_script_setup_true_lang-02a4ee0d.js";import{u as re}from"./useSortable-a183a608.js";import{_ as ie}from"./WaDialogLoading.vue_vue_type_script_setup_true_lang-9395703c.js";const ue=["disabled","onClick"],ce=["disabled","onClick"],de={class:"flexbox middle space-4"},me={key:0,class:"hint"},ve=["onClick"],pe={class:"tw-flex-auto tw-truncate"},Ie=U({__name:"FormDeleteTag",props:{entityIds:{},entityType:{}},emits:["close"],setup(T,{emit:b}){const i=T,l=F([]),u=F(!0),p=F(""),y=K();o();const v=V(()=>!!l.value.length&&l.value.every(e=>e.selected)),f=V(()=>!!l.value.length&&l.value.some(e=>e.selected));async function o(){u.value=!0;const{data:e,error:h}=await D(V(()=>`crm.tag.list?${ee.stringify({[`${i.entityType}_id`]:i.entityIds})}`),{refetch:!0,immediate:!0}).get().json();u.value=!1,p.value=h.value,e.value&&(l.value=e.value.map(d=>({...d,selected:!1})))}function S(){const e=v.value;l.value.forEach(h=>h.selected=!e)}async function w(){p.value="";const e=l.value.filter(C=>C.selected).map(C=>C.name);if(!e.length)return;const{error:h,execute:d}=y.removeTags(i.entityType,i.entityIds,e);await d(),p.value=h.value,h.value||(y.refetch(),b("close"))}return(e,h)=>(r(),$(j,{"use-cancel-as-button-label":!0,onClose:h[0]||(h[0]=d=>b("close"))},{header:s(()=>[x(m(e.$t("removeTags")),1)]),submit:s(()=>[c("button",{disabled:u.value||!f.value,onClick:A(w,["prevent"])},m(e.$t("removeTags")),9,ue)]),error:s(()=>[x(m(p.value),1)]),default:s(()=>[u.value?(r(),$(oe,{key:0})):(r(),g(I,{key:1},[c("button",{type:"button",class:"button light-gray smaller",disabled:!l.value.length,onClick:A(S,["prevent"])},[c("div",de,[_(R,{"model-value":v.value?"1":""},null,8,["model-value"]),c("span",null,m(e.$t("selectAll")),1)])],8,ce),_(L,{space:"6",class:"custom-mt-16"},{default:s(()=>[c("div",{class:Q({"tw-pb-2":l.value.length})},[l.value.length?N("",!0):(r(),g("div",me,m(e.$t("emptyList")),1)),l.value.length?(r(),$(X,{key:1},{default:s(()=>[(r(!0),g(I,null,P(l.value,d=>(r(),$(Y,{key:d.id+String(d.color),color:d.color,"bg-color":d.bg_color,class:"smaller"},{default:s(()=>[c("a",{onClick:A(C=>d.selected=!d.selected,["prevent"])},[c("span",pe,m(d.name),1),_(R,{"model-value":d.selected?"1":"","fit-content":""},null,8,["model-value"])],8,ve)]),_:2},1032,["color","bg-color"]))),128))]),_:1})):N("",!0)],2)]),_:1})],64))]),_:1}))}}),fe=["disabled","onClick"],he={key:0,class:"hint"},ye=["onClick"],ge={class:"tw-flex-auto tw-truncate"},Ne=U({__name:"FormAddTag",props:{entityIds:{},entityType:{}},emits:["close"],setup(T,{emit:b}){const i=T,l=K(),u=F([]),p=F();async function y(){p.value=l.tagAssign(i.entityType,i.entityIds,u.value),await p.value.execute(),p.value.error||b("close")}return(v,f)=>(r(),$(j,{"use-cancel-as-button-label":!0,onClose:f[1]||(f[1]=o=>b("close"))},{header:s(()=>[x(m(v.$t("addTags")),1)]),submit:s(()=>{var o;return[c("button",{disabled:!u.value.length||!!((o=p.value)!=null&&o.isFetching),onClick:A(y,["prevent"])},m(v.$t("save")),9,fe)]}),error:s(()=>{var o;return[x(m((o=p.value)==null?void 0:o.error),1)]}),default:s(()=>[_(L,{space:"6"},{default:s(()=>[c("div",{class:Q(["tw-p-4 tw-rounded-md tw-bg-waBackground",{"tw-pb-2":u.value.length}])},[u.value.length?N("",!0):(r(),g("div",he,m(v.$t("tagsToAssign")),1)),u.value.length?(r(),$(X,{key:1},{default:s(()=>[(r(!0),g(I,null,P(u.value,o=>{var S,w;return r(),$(Y,{key:o,color:(S=B(l).tags.find(e=>e.name===o))==null?void 0:S.color,"bg-color":(w=B(l).tags.find(e=>e.name===o))==null?void 0:w.bg_color,class:"smaller"},{default:s(()=>[c("a",{onClick:A(()=>{u.value=u.value.filter(e=>e!==o)},["prevent"])},[c("span",ge,m(o),1)],8,ye)]),_:2},1032,["color","bg-color"])}),128))]),_:1})):N("",!0)],2),_(ne,{modelValue:u.value,"onUpdate:modelValue":f[0]||(f[0]=o=>u.value=o),"entity-ids":i.entityIds,"entity-type":i.entityType},null,8,["modelValue","entity-ids","entity-type"])]),_:1})]),_:1}))}}),_e=["data-id"],be=c("div",{class:"handle tw-flex tw-justify-center tw-w-4"},[c("i",{class:"fas fa-grip-vertical gray"})],-1),we={class:"small"},$e={class:"small"},Pe=U({__name:"FormFields",props:{scope:{},exceptFields:{},staticFields:{},prepareFetchParams:{type:Function},sortParamsIfFieldRemoved:{}},emits:["close"],setup(T,{emit:b}){const i=T,{data:l,isFetching:u,error:p}=D(`crm.field.list?scope=${i.scope}`).get().json(),y=i.scope==="deal"?te():se(),{fields:v}=ae(y),f=F([]),o=V(()=>{var a;return(a=f.value)==null?void 0:a.filter(n=>n.value).sort((n,t)=>n.sort<0?1:n.sort-t.sort)}),S=V(()=>{var a;return(a=f.value)==null?void 0:a.filter(n=>!n.value)}),w=F(null),e=[...v.value||[]];le(()=>{Array.isArray(l.value)&&(f.value=[...i.staticFields,...l.value.filter(a=>!i.exceptFields.includes(a.id))].reduce((a,n)=>{var E;const{id:t,name:k,hide:q}=n,z=((E=v.value)==null?void 0:E.indexOf(t))??-1;if(a.push({id:t,name:k,hide:q,value:z>-1?"1":"",sort:z}),"fields"in n){const Z=n.fields.map(M=>{var J;const W=`${n.id}:${M.id}`,O=((J=v.value)==null?void 0:J.indexOf(W))??-1;return{id:W,name:`${n.name} â€“ ${M.name}`,hide:q,value:O>-1?"1":"",sort:O}});a.push(...Z)}return a},[]))});function h(){re(w,o,{animation:150,handle:".handle"})}async function d(){var t;v.value=Array.from(((t=w.value)==null?void 0:t.querySelectorAll("[data-id]"))||[]).map(k=>k.getAttribute("data-id")??"");const a=i.prepareFetchParams(v.value),{error:n}=await D("crm.user.settings.save").patch(a);n.value||("updateFieldsInAppState"in y&&y.updateFieldsInAppState(a),y.updateFetchParams(C()),b("close"))}function C(){if(i.sortParamsIfFieldRemoved){const a=String(y.fetchParams.sort);return e.includes(a)&&!(v.value||[]).includes(a)?i.sortParamsIfFieldRemoved:{}}return{}}return(a,n)=>(r(),$(j,{onClose:n[0]||(n[0]=t=>b("close"))},{header:s(()=>[x(m(a.$t("selectFields")),1)]),submit:s(()=>[f.value?(r(),g("button",{key:0,class:"button",onClick:d},m(a.$t("save")),1)):N("",!0)]),default:s(()=>[_(ie,{"is-fetching":B(u),error:B(p)},{default:s(()=>[_(L,{space:"4",class:"fields-list"},{default:s(()=>[c("div",{ref_key:"sortableRef",ref:w,class:"tw-bg-waBlank tw-z-20 tw-pb-4 tw-border-0 tw-border-solid tw-border-b tw-border-b-waBorder",onVnodeMounted:h},[(r(!0),g(I,null,P(o.value,t=>G((r(),g("div",{key:t.id,"data-id":t.id,class:"tw-flex tw-items-center tw-space-x-2 tw-mb-1"},[be,_(R,{modelValue:t.value,"onUpdate:modelValue":k=>t.value=k},{default:s(()=>[c("span",we,m(t.name),1)]),_:2},1032,["modelValue","onUpdate:modelValue"])],8,_e)),[[H,!t.hide]])),128))],512),c("div",null,[(r(!0),g(I,null,P(S.value,t=>G((r(),g("div",{key:t.id,class:"tw-flex tw-items-center tw-space-x-2 tw-mb-1"},[_(R,{modelValue:t.value,"onUpdate:modelValue":k=>t.value=k},{default:s(()=>[c("span",$e,m(t.name),1)]),_:2},1032,["modelValue","onUpdate:modelValue"])])),[[H,!t.hide]])),128))])]),_:1})]),_:1},8,["is-fetching","error"])]),_:1}))}});export{Pe as _,Ne as a,Ie as b};
