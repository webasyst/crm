import{d as U,o as A,b as L,w as m,m as M,k as y,i as g,n as Q,G as R,aa as V,a as E,B as X,ag as Y,e as G,c as q,h as Z,ap as ee,f as j,p as P,N as te,z as F,g as ae,W as B,J as O}from"./main-ec0df6a4.js";import{b as K}from"./emit-727b9eb7.js";import{W as J}from"./WaDialog-c7c19903.js";import{g as se,u as ne}from"./helpers-a2ed4cd9.js";import{B as W}from"./ButtonSubmit-edad645b.js";import{F as oe}from"./FieldSelect-df2e3574.js";const re=U({__name:"AlertDialog",props:{message:{},isError:{type:Boolean}},setup(a){const l=a;return(r,u)=>(A(),L(J,{"use-cancel-as-button-label":!1,"hide-close-icon":!0},{header:m(()=>[M(y(r.$t(l.isError?"error":"info")),1)]),default:m(()=>[g("div",{class:Q({"state-error":l.isError})},y(l.message),3)]),_:1}))}});function le(a){a instanceof Error&&(a=a.toString()),ie(!0,a)}function ie(a,l){R(re,{isError:a,message:l}).show()}const ue={class:"gray"},ce={class:"smaller break-words"},de={class:"fields"},fe={class:"field"},ve={class:"name"},me={class:"value"},_e={key:0,class:"field"},he=g("div",{class:"name"},null,-1),pe={class:"value"},ge=["placeholder"],ye={key:0,class:"state-error-hint"},x="0",Se=U({__name:"FormConfirmLostReasonStage",props:{scopeActions:{},dealName:{}},setup(a){const l=a,r=V({reasonId:"",customText:""}),u=V({reasonId:!1,customText:!1}),_=E(!0),h=E([]),f=E(!1),p=E(""),{lostReasonList:I,changeCloseStage:D}=l.scopeActions,{t:S}=X();Y(async()=>{p.value="";const{error:c,data:d}=await I();d.value&&(_.value=d.value.required,d.value.lostreasons.forEach(e=>{var t;(t=h.value)==null||t.push({id:String(e.id),value:e.name})}),d.value.allow_custom&&h.value.push({id:x,value:S("otherReason")})),p.value=c.value||""});function $(){return Object.values(u).every(c=>c===!1)}function C(){for(const c in u)u[c]=!1}async function N(){var o;if(p.value="",u.reasonId=_.value&&!r.reasonId,u.customText=r.reasonId===x&&!r.customText,!$())return;const c=r.reasonId&&r.reasonId!==x,d=c?Number(r.reasonId):null,e=c?((o=h.value.find(s=>s.id===r.reasonId))==null?void 0:o.value)||"":r.reasonId===x?r.customText:"";f.value=!0;const{error:t}=await D({status_id:"LOST",lost_id:d,lost_text:e});f.value=!1,p.value=t.value||""}return(c,d)=>(A(),L(J,{"use-cancel-as-button-label":"","hide-close-icon":""},{header:m(()=>[g("div",ue,y(c.$t("closeDeal")),1),g("div",ce,y(l.dealName),1)]),default:m(()=>[g("div",de,[g("div",fe,[g("div",ve,y(c.$t("lostReason")),1),g("div",me,[G(oe,{modelValue:r.reasonId,"onUpdate:modelValue":[d[0]||(d[0]=e=>r.reasonId=e),C],error:u.reasonId,"error-message":c.$t("validation.required"),options:h.value},null,8,["modelValue","error","error-message","options"])])]),r.reasonId===x?(A(),q("div",_e,[he,g("div",pe,[Z(g("input",{"onUpdate:modelValue":d[1]||(d[1]=e=>r.customText=e),type:"text",class:Q(["width-100",{"state-error":u.customText}]),placeholder:c.$t("customReason"),onChange:C},null,42,ge),[[ee,r.customText]])])])):j("",!0)])]),submit:m(()=>[G(W,{bg:"red","is-fetching":f.value,onClick:P(N,["prevent"])},{default:m(()=>[M(y(c.$t("lost")),1)]),_:1},8,["is-fetching","onClick"])]),error:m(()=>[p.value?(A(),q("span",ye,y(p.value),1)):j("",!0)]),_:1}))}}),be=["innerHTML"],we={key:0,class:"state-error-hint"},Ee=U({__name:"FormConfirmChangeStage",props:{scopeActions:{},orderActionData:{}},setup(a){const l=a,r=E(),u=E(!1),_=E(""),h=document.createElement("div");h.innerHTML=l.orderActionData.dialog_html.trim();let f;h&&(f=h.querySelector(".crm-dialog-content"),((t,o)=>{if(f){const s=f.querySelector(t);s instanceof HTMLElement&&(s.style.display=o)}})(".js-form-footer-actions","none")),te(r,e=>{if(!e)return;const t=e.getElementsByTagName("script");if(t!=null&&t.length){const o=s=>{const v=window.eval;if(typeof v!="function"||s.src){s.remove();const n=document.createElement("script");s.type&&(n.type=s.type),s.src?n.src=s.src:n.innerHTML=s.innerHTML,e.append(n)}else v(s.innerHTML)};Array.from(t).forEach(o),e.querySelectorAll("input.hasDatepicker").forEach(s=>{s.setAttribute("type","date")}),e.querySelectorAll("input.ui-timepicker-input").forEach(s=>{s.setAttribute("type","time")})}});const{formChangeStageOrderAction:p,forceChangeStage:I,closeModal:D}=l.scopeActions,S=F(()=>h.querySelector(".crm-dialog-header").innerText.trim()),$=F(()=>f.innerHTML),C=F(()=>{var t;const e=(t=r.value)==null?void 0:t.getElementsByTagName("form");return e!=null&&e.length?e[0]:null}),N=F(()=>l.orderActionData.action_id!==null&&C.value);async function c(){if(u.value=!0,_.value="",C.value){const e=await p({action_id:String(l.orderActionData.action_id),order_id:l.orderActionData.order_id},C.value);u.value=!1,_.value=e.error.value||""}}async function d(){u.value=!0,_.value="";const e=await I();u.value=!1,e&&(_.value=e.error.value||"")}return(e,t)=>(A(),L(J,{"use-cancel-as-button-label":"","hide-close-icon":"",onClose:ae(D)},{header:m(()=>[M(y(S.value),1)]),default:m(()=>[g("div",{ref_key:"contentRef",ref:r,innerHTML:$.value},null,8,be)]),submit:m(()=>[N.value?(A(),L(W,{key:0,"is-fetching":u.value,onClick:P(c,["prevent"])},{default:m(()=>[M(y(e.$t("submit")),1)]),_:1},8,["is-fetching","onClick"])):(A(),L(W,{key:1,"is-fetching":u.value,onClick:P(d,["prevent"])},{default:m(()=>[M(y(e.$t("changeStage")),1)]),_:1},8,["is-fetching","onClick"]))]),error:m(()=>[_.value?(A(),q("span",we,y(_.value),1)):j("",!0)]),_:1},8,["onClose"]))}}),i=E(null),T=E();function Ie(a){const l=V({cbSuccess:null,cbError:null,cbCancel:null});function r(e,t=null,o){var s,v;switch((s=e.response.value)==null?void 0:s.status){case 409:if(!t)return;T.value=R(Ee,{scopeActions:{formChangeStageOrderAction:_,forceChangeStage:p,closeModal:$},orderActionData:t}),T.value.show();break;case 204:K(),a.value&&(i.value?("stage_id"in i.value?d(i.value.stage_id,a.value.stage_id):"status_id"in i.value&&d(null,a.value.stage_id),a.value={...a.value,...i.value},i.value=null):d(a.value.stage_id,null)),(v=T.value)==null||v.hide(),S("success");break;default:o&&e.error.value&&le(e.error.value),i.value=null,S("error");break}}async function u(e,t){var k;i.value=e;let o=null;const s=t?{...e,force:!0}:e,v=B.stringify({id:(k=a.value)==null?void 0:k.id}),n=await O(`crm.deal.move?${v}`,{onFetchError(b){if(typeof b.data=="string"){const w=JSON.parse(b.data);w&&"dialog_html"in w&&(o=w)}return b}}).post(s);return r(n,o,!t),n}async function _(e,t){var k,b,w,z;const o=se(t),s=B.stringify(e);i.value&&"lost_id"in i.value&&Object.assign(o,{crm_change_workflow_data:{id:(k=a.value)==null?void 0:k.id,action:i.value.status_id,lost_id:i.value.lost_id,lost_text:i.value.lost_text}});const v=B.stringify(o),n=await O(`crm.deal.shopaction?${s}`,{beforeFetch({options:H}){return H.headers=new Headers(H.headers),H.headers.set("Content-Type","application/x-www-form-urlencoded"),{options:H}}}).post(v).json();return(b=n.response.value)!=null&&b.ok&&n.data.value&&a.value?((w=n.data.value)==null?void 0:w.stage_id)===a.value.stage_id?S("cancel"):(K(),a.value={...a.value,stage_id:n.data.value.stage_id,funnel_id:n.data.value.funnel_id,...typeof n.data.value.shop_order=="object"?n.data.value.shop_order:{},status_id:n.data.value.status_id,lost_id:n.data.value.lost_id,lost_text:n.data.value.lost_text},S("success")):S("error"),i.value=null,(z=T.value)==null||z.hide(),n}async function h(e){var t;return e==="LOST"?(T.value=R(Se,{scopeActions:{lostReasonList:D,changeCloseStage:f},dealName:((t=a.value)==null?void 0:t.name)||""}),T.value.show(),!1):f({status_id:"WON"})}async function f(e,t){var k;i.value=e;let o=null;const s=t?{...e,force:!0}:e,v=B.stringify({id:(k=a.value)==null?void 0:k.id}),n=await O(`crm.deal.close?${v}`,{onFetchError(b){if(typeof b.data=="string"){const w=JSON.parse(b.data);w&&"dialog_html"in w&&(o=w)}return b}}).post(s);return r(n,o,!t&&(e==null?void 0:e.status_id)==="WON"),n}async function p(){return i.value?"status_id"in i.value?f(i.value,!0):u(i.value,!0):!1}async function I(){var t,o;const e=await O(`crm.deal.reopen?id=${(t=a.value)==null?void 0:t.id}`).post();return((o=e.response.value)==null?void 0:o.status)===204&&a.value&&(a.value={...a.value,status_id:"OPEN"}),r(e,null,!0),e}async function D(){var t;return await O(`crm.deal.lostreason.list?funnel_id=${(t=a.value)==null?void 0:t.funnel_id}`).json()}function S(e){var o;const t=`cb${e[0].toUpperCase()}${e.slice(1)}`;typeof l[t]=="function"&&((o=l[t])==null||o.call(null))}function $(){var e;(e=T.value)==null||e.hide(),S("cancel")}function C(e){l.cbSuccess=e}function N(e){l.cbError=e}function c(e){l.cbCancel=e}function d(e,t){ne().funnels.forEach(o=>{o.deal_count=o.stages.reduce((s,v)=>{const n=v;return n.id===e&&(n.deal_count+=1),n.id===t&&(n.deal_count-=1),s+n.deal_count},0)})}return{modal:T,changeOpenStage:u,formChangeStageOrderAction:_,closeDeal:h,changeCloseStage:f,lostReasonList:D,forceChangeStage:p,reopenDeal:I,closeModal:$,onSuccess:C,onError:N,onCancel:c}}export{Ie as u};
