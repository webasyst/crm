import{d as W,h as _,ag as G,Q as K,D as T,aU as ee,l as x,o as w,i as D,w as k,a as b,c as $,F as R,b as N,j as B,e as L,a1 as te,aj as M,n as q,r as V,p as U,ai as ce,u as g,q as se,k as E,v as O,aC as ae,ar as X,f as de,ad as Y,M as j,_ as pe,a5 as Z,t as z,bi as ne,aA as ie,am as fe,aB as ve,ao as oe,P as me,aR as he,B as ye,aO as we,L as _e,a2 as ge}from"./main-46836c41.js";import{D as le,M as J,_ as re}from"./DropDown-2ad3ed01.js";import{u as be}from"./recentContacts-3e5f8df1.js";import{F as Ce}from"./FieldSelect-19a80dbd.js";import{v as $e}from"./index-dbd22bf6.js";import{v as Ie}from"./vTooltip-9ea5107e.js";import{U as ke}from"./UserPic-951b6ea8.js";import{C as Fe}from"./CustomColumn-c8c73188.js";const Se={key:0,class:"icon size-20 !tw-left-2"},xe={key:1,class:"icon text-gray"},De=b("i",{class:"fas fa-search"},null,-1),Ve=[De],Be=b("i",{class:"fas fa-times-circle"},null,-1),Le=[Be],Re=["placeholder","disabled"],Me={key:2,class:"smaller text-red tw-mt-1"},We=["data-index","onClick"],Ae=["src"],Pe={class:"name"},Ue={class:"email"},je={key:1,class:"tw-text-center tw-py-3 gray"},He={class:"tw-h-[5px]"},Ne={class:"tw-text-center tw-py-3"},Ee=b("i",{class:"spinner custom-p-12"},null,-1),Ke=[Ee],Te=b("hr",{class:"tw-m-0"},null,-1),qe={class:"!tw-my-1"},ue=W({__name:"InputWithDropDownAndClear",props:{items:{},item:{},initItemId:{},placeholder:{},isFetching:{type:Boolean},hideClear:{type:Boolean},hideIcon:{type:Boolean},inputClass:{},width:{},right:{type:Boolean},disabled:{type:Boolean},errorMessage:{}},emits:["input","update","clear","interseption-observer","focus","close-dropdown"],setup(h,{expose:n,emit:i}){const e=h,m=_(),v=_(),r=_(!1),o=_(e.item);let t=G(e.items);K(()=>e.items,s=>{t=G(s),K(t.index,f=>{var F,S;(S=(F=m.value)==null?void 0:F.querySelector(`[data-index="${f}"]`))==null||S.scrollIntoView({behavior:"smooth",block:"nearest"})})}),T(()=>e.initItemId&&e.items.length,()=>{const s=e.items.find(f=>f.id===e.initItemId);s&&a(s)},{immediate:!0}),T(()=>!r.value,()=>{i("close-dropdown")}),ee(m,()=>{r.value=!1});function l(s){i("focus"),i("input",s.target.value),r.value=!0,ce(()=>{var f;(f=v.value)==null||f.focus()})}function a(s){if(s){if(s.is_editable===!1)return;o.value={...s},i("update",o.value),r.value=!1}}function p(){o.value={id:0,name:""},i("clear")}const u=x(()=>{var s;return r.value&&((s=o.value)==null?void 0:s.name)||e.placeholder}),c=x(()=>r.value?"default-value":"value");return n({clearValue:p}),(s,f)=>(w(),D(Fe,{space:"4"},{default:k(()=>{var F,S,H,A;return[b("div",{ref_key:"wrapperRef",ref:m,class:"tw-w-full"},[!s.$slots.preview||r.value?(w(),$("div",{key:0,class:q(["state-with-inner-icon width-100",{left:!e.hideIcon}])},[e.hideIcon?B("",!0):(w(),$(R,{key:0},[(F=o.value)!=null&&F.userpic?(w(),$("div",Se,[N(ke,{url:(S=o.value)==null?void 0:S.userpic,size:20},null,8,["url"])])):(w(),$("div",xe,Ve))],64)),!e.disabled&&!e.hideClear&&((H=o.value)!=null&&H.name)?(w(),$("a",{key:1,class:"icon !tw-left-auto tw-right-3 hover:!tw-text-red-600 tw-rounded-full tw-bg-waBlank",onClick:f[0]||(f[0]=L(I=>p(),["prevent"]))},Le)):B("",!0),b("input",te({ref_key:"inputRef",ref:v,type:"search",class:["tw-w-full",e.inputClass,{"state-error":e.errorMessage}],[c.value||""]:((A=o.value)==null?void 0:A.name)||"",placeholder:u.value,disabled:e.disabled,onInput:f[1]||(f[1]=I=>i("input",I.target.value)),onKeyup:f[2]||(f[2]=M(I=>{a(g(t).state.value),I.target.blur()},["enter"])),onKeydown:[f[3]||(f[3]=M(L(I=>g(t).prev(),["prevent"]),["up"])),f[4]||(f[4]=M(L(I=>g(t).next(),["prevent"]),["down"]))],onFocus:l}),null,16,Re)],2)):V(s.$slots,"preview",{key:1,model:o.value,showInput:l}),e.errorMessage?(w(),$("div",Me,U(e.errorMessage),1)):B("",!0),V(s.$slots,"items",{items:e.items,onSelectItem:a,isFocus:r.value},()=>[N(le,{"max-height":"255px",open:r.value,"disable-click-outside":!0,width:e.width||"250px",right:e.right,"disable-floating":!0},{body:k(()=>{var I;return[e.isFetching||o.value.name||(I=e.items)!=null&&I.length?(w(),D(J,{key:0,class:"thin-scrollbar"},{default:k(()=>{var d;return[(d=e.items)!=null&&d.length?(w(!0),$(R,{key:0},se(e.items,(y,C)=>(w(),D(re,{key:y.id},{default:k(()=>[E((w(),$("a",{class:q(["item",{"tw-bg-waBackground":g(t).index.value===C,"tw-opacity-50":y.is_editable===!1}]),"data-index":C,onClick:L(P=>a(y),["prevent"])},[s.$slots.item?V(s.$slots,"item",{key:0,item:y}):(w(),$(R,{key:1},[b("img",{class:"userpic userpic32",src:y.userpic},null,8,Ae),b("div",null,[b("div",Pe,U(y.name),1),b("div",Ue,U(y.email),1)])],64))],10,We)),[[g(Ie),y.is_editable===!1?{content:s.$t("contactEditAccessDenied"),trigger:"click",autoHideDelay:2500}:""]])]),_:2},1024))),128)):e.isFetching?B("",!0):(w(),$(R,{key:1},[s.$slots.empty?V(s.$slots,"empty",{key:0}):(w(),$("div",je,U(s.$t("notFound")),1))],64)),E(b("div",He,null,512),[[O,!s.isFetching],[g($e),([{isIntersecting:y}])=>{y&&i("interseption-observer")}]]),E(b("div",Ne,Ke,512),[[O,s.isFetching]])]}),_:3})):B("",!0),s.$slots.bottomItems?(w(),$(R,{key:1},[Te,b("div",qe,[N(J,null,{default:k(()=>[V(s.$slots,"bottomItems",{hideDropDown:()=>r.value=!1})]),_:3})])],64)):B("",!0)]}),_:3},8,["open","width","right"])])],512)]}),_:3}))}});const ze=W({__name:"InputSearchContacts",props:{contacts:{default:void 0},contact:{default:()=>({id:0,name:"",userpic:"",jobtitle:"",company:"",company_contact_id:null})},initContactId:{default:void 0},withFields:{default:()=>["email"]},excludeIds:{default:()=>[]},disabled:{type:Boolean},disableNotEditable:{type:Boolean},isFetching:{type:Boolean,default:void 0},additionalHash:{default:void 0}},emits:["update"],setup(h,{expose:n,emit:i}){var A,I;const e=h,m=_(),v=_({id:e.contact.id,name:e.contact.name,userpic:e.contact.userpic,company:e.contact.company||"",email:(I=(A=e.contact)==null?void 0:A.email)!=null&&I.length?e.contact.email[0].value:""}),r=_([]),o=_(!1),t=_(""),l=_(0),a=_(0),p=_(10);f(),K(()=>e.contacts,()=>{f()}),n({clearValue:()=>{var d;return(d=m.value)==null?void 0:d.clearValue()}});const u=ae(async d=>{var y;if(l.value=0,a.value=0,!d||((y=v.value)==null?void 0:y.name)===d)f();else{let C="name.name";d.includes("@")?C="email":/^[+\-0-9() ]+$/.test(d)&&(C="phone");const P=`crmSearch/${e.additionalHash?`${e.additionalHash}&`:""}contact_info.${C}*=${de(d)}`;t.value!==P&&(r.value=[],r.value=await F(P))}},300),c=e.excludeIds.filter(d=>d!==e.contact.id).reduce((d,y)=>({...d,[y]:!0}),{}),s=x(()=>r.value.filter(d=>!c[d.id]).map(d=>{const y=d.fields.find(C=>C.id==="email");return{id:d.id,name:d.name,userpic:d.userpic,email:y==null?void 0:y.value[0],company:d.company,is_editable:d.is_editable}}));function f(){l.value=0,a.value=0,t.value="",e.contacts&&(r.value=[...e.contacts])}async function F(d){o.value=!0;const y=Y.stringify({hash:d,fields:[...e.withFields,...e.disableNotEditable?["is_editable"]:[]],limit:p.value,offset:l.value}),{data:C}=await j(`crm.contact.list?${y}`).get().json();if(o.value=!1,C.value){const{data:P,params:Q}=C.value;return l.value+=Q.limit||0,a.value=Q.total_count||0,t.value=Q.hash||"",P}return[]}async function S(){l.value<a.value&&(r.value=[...r.value,...await F(t.value)])}function H(d){v.value=d;const y=r.value.find(C=>C.id===d.id);y&&i("update",y)}return(d,y)=>(w(),D(ue,{ref_key:"inputWithDropDownRef",ref:m,items:s.value,item:v.value,"init-item-id":e.initContactId,placeholder:d.$t("name"),"is-fetching":o.value||d.isFetching,disabled:e.disabled,onInput:g(u),onUpdate:H,onInterseptionObserver:S,onCloseDropdown:f},{items:k(C=>[V(d.$slots,"items",X({isFetching:o.value||d.isFetching,interseptionObserver:S},C),void 0,!0)]),_:3},8,["items","item","init-item-id","placeholder","is-fetching","disabled","onInput"]))}});const Qe=pe(ze,[["__scopeId","data-v-f0e353f2"]]),Ge=Z("inputWithCustomers",()=>{const h=_(!0),n=_([]),i=_(null),e=be(),{recent:m,pinned:v,error:r,isFinished:o}=z(e);e.refetch();function t(u,c,s){u===null||i.value!==u?(i.value&&e.refetch(),T(()=>o.value,()=>{l(c,s)},{immediate:!0})):(n.value.length||m.value.length||v.value.length)&&a(s),i.value=u}async function l(u,c){const s=[...v.value,...m.value].map(S=>S.id),f=p(c);f&&s.unshift(f);const F=ne(s).join(",");F&&(n.value=await Je(`id/${F}`,u),a(c)),h.value=!1}function a(u){if(!u)return;const c=n.value.findIndex(s=>s.id===p(u));if(c!==-1){const s=n.value[c];return n.value.splice(c,1),n.value.unshift(s),!0}else typeof u=="object"&&u.id&&n.value.unshift(u)}function p(u){return typeof u=="number"?u:typeof(u==null?void 0:u.id)=="number"?u.id:null}return{isFetching:h,error:r,$contacts:n,fetchData:t}});async function Je(h,n){const i=Y.stringify({hash:h,fields:n}),{data:e}=await j(`crm.contact.list?${i}`).get().json();if(e.value){const{data:m}=e.value;return m}return[]}const Xe=["placeholder"],Ye=["onClick"],dt=W({__name:"InputWithRole",props:{scope:{},modelValue:{},inputClass:{default:""},placeholder:{default:""},right:{type:Boolean},width:{default:"200px"}},setup(h){const n=h,i=ie(n,"modelValue"),e=_([]),m=_(),v=_(!1),r=x(()=>e.value.filter(l=>{var a;return(a=i.value)!=null&&a.trim()?l.toLocaleLowerCase().includes(i.value.toLocaleLowerCase()):!0})),o=G(r);fe(async()=>{const{data:l}=await j(`crm.deal.role.list?scope=${n.scope}`).get().json();Array.isArray(l.value)&&(e.value=l.value)}),ee(m,()=>{v.value=!1});function t(l){l&&(i.value=l,v.value=!1)}return(l,a)=>(w(),$("div",{ref_key:"wrapperRef",ref:m},[N(le,{open:v.value,"disable-click-outside":!0,right:n.right,width:n.width,disabled:!0,"max-height":"195px"},{body:k(()=>[r.value.length?(w(),D(J,{key:0},{default:k(()=>[(w(!0),$(R,null,se(r.value,(p,u)=>(w(),D(re,{key:u},{default:k(()=>[b("a",{class:q({"tw-bg-waBackground":g(o).index.value===u}),onClick:L(c=>t(p),["prevent"])},U(p),11,Ye)]),_:2},1024))),128))]),_:1})):B("",!0)]),default:k(()=>[E(b("input",{"onUpdate:modelValue":a[0]||(a[0]=p=>oe(i)?i.value=p:null),type:"text",class:q(["tw-w-full",n.inputClass]),placeholder:n.placeholder,onKeyup:a[1]||(a[1]=M(p=>{t(g(o).state.value),p.target.blur()},["enter"])),onKeydown:[a[2]||(a[2]=M(L(p=>g(o).prev(),["prevent"]),["up"])),a[3]||(a[3]=M(L(p=>g(o).next(),["prevent"]),["down"]))],onFocusin:a[4]||(a[4]=p=>v.value=!0)},null,42,Xe),[[ve,g(i)]])]),_:1},8,["open","right","width"])],512))}}),pt=W({__name:"InputWithCustomers",props:{dealId:{},initContactId:{},contact:{},withFields:{},excludeIds:{},disabled:{type:Boolean}},emits:["update"],setup(h,{expose:n,emit:i}){var a,p;const e=h,m=_(),v=Ge(),r=e.contact?{id:e.contact.id,name:e.contact.name,userpic:e.contact.userpic,company:e.contact.company?e.contact.company:"",fields:[{id:"email",value:(p=(a=e.contact)==null?void 0:a.email)!=null&&p.length?[e.contact.email[0].value]:[]}]}:e.initContactId;v.fetchData(e.dealId||null,e.withFields||[],r);const{$contacts:o,isFetching:t}=z(v);n({isFetchingContacts:t,clearValue:()=>{var u;return(u=m.value)==null?void 0:u.clearValue()}});function l(u){i("update",u),o.value.unshift(u),o.value=ne(o.value)}return(u,c)=>(w(),D(Qe,{ref_key:"inputSearchContactsRef",ref:m,contact:e.contact,"init-contact-id":e.initContactId,"with-fields":e.withFields,"exclude-ids":e.excludeIds,disabled:e.disabled,contacts:g(o),"is-fetching":g(t),onUpdate:l},null,8,["contact","init-contact-id","with-fields","exclude-ids","disabled","contacts","is-fetching"]))}}),Ze=Z("currencies",()=>{const h=_([]),{data:n,isFetching:i,error:e,execute:m,isFinished:v}=j("crm.currency.list").get().json(),r=x(()=>h.value.find(a=>a.is_primary)),o=x(()=>a=>h.value.find(p=>p.id===a)),t=x(()=>v.value&&!h.value.length);me(()=>{Array.isArray(n.value)&&(h.value=n.value)});function l(){v.value&&m()}return{currencies:h,primaryCurrency:r,isFetching:i,error:e,isFinished:v,isEmptyCurrencies:t,getCurrencyById:o,refetch:l}}),Oe={key:1,class:"skeleton tw-w-full"},et=b("button",{class:"button light-gray !tw-w-full tw-h-full"},null,-1),tt=[et],ft=W({__name:"SelectWithCurrencies",props:{modelValue:{}},emits:["update:modelValue"],setup(h,{emit:n}){const e=ie(h,"modelValue",n),{currencies:m,primaryCurrency:v,isFinished:r}=z(Ze()),o=x(()=>m.value.map(t=>({id:t.id,value:t.name})));return T(()=>{var t;return(t=v.value)==null?void 0:t.id},t=>{e.value||(e.value=t)},{immediate:!0}),(t,l)=>g(r)?(w(),D(Ce,X({key:0,modelValue:g(e),"onUpdate:modelValue":l[0]||(l[0]=a=>oe(e)?e.value=a:null)},t.$attrs,{options:o.value,required:"",class:"tw-w-full"}),null,16,["modelValue","options"])):(w(),$("div",Oe,tt))}}),st=Z("inputWithPreformers",()=>{const h=_(!0),n=_([]),i=he({}),e=x(()=>`crm.user.list?${Y.stringify({...i.dealId?{can_own_deal:i.dealId}:{}})}`),{error:m,data:v}=j(e,{immediate:!1,refetch:!0}).get().json();K(v,t=>{if(Array.isArray(t)){const{id:l}=ye.user,a=t.find(p=>p.id===l);n.value=[...a?[a]:[],...t.filter(p=>p.id!==l)]}o(i.currrentUser),h.value=!1});function r(t,l){i.dealId=t,i.currrentUser=l,n.value.length&&o(i.currrentUser)}function o(t){if(t!=null&&t.id){const l=n.value.findIndex(a=>a.id===t.id);if(l!==-1){const a=n.value[l];n.value.splice(l,1),n.value.unshift(a)}else t.id&&n.value.unshift(t)}}return{setupProps:r,isFetching:h,error:m,$contacts:n}}),vt=W({__name:"InputWithPerformers",props:{dealId:{default:0},excludeIds:{default:()=>[]},contact:{}},emits:["update"],setup(h,{emit:n}){const i=h,e=_(i.contact),m=_([]),v=st();v.setupProps(i.dealId,{...e.value});const{isFetching:r,$contacts:o}=z(v);p(),we(o,()=>p());const t=ae(async c=>{var s;!c||((s=e.value)==null?void 0:s.name)===c?p():m.value=[...o.value].filter(f=>f.name.toLocaleLowerCase().includes(c.toLocaleLowerCase()))},300),l=i.excludeIds.filter(c=>c!==i.contact.id).reduce((c,s)=>({...c,[s]:!0}),{}),a=x(()=>m.value.filter(c=>!l[c.id]));function p(){m.value=[...o.value]}function u(c){e.value=c,n("update",{id:c.id,name:c.name,userpic:c.userpic})}return(c,s)=>(w(),D(ue,{items:a.value,item:e.value,placeholder:c.$t("name"),"is-fetching":g(r),onInput:g(t),onUpdate:u,onCloseDropdown:p},_e({items:k(f=>[V(c.$slots,"items",X({isFetching:g(r),interseptionObserver:()=>null},f))]),_:2},[c.$slots.preview?{name:"preview",fn:k(f=>[V(c.$slots,"preview",te(ge(f)))]),key:"0"}:void 0]),1032,["items","item","placeholder","is-fetching","onInput"]))}});export{Qe as I,pt as _,dt as a,vt as b,ft as c,Ze as u};
