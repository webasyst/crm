import{d as L,a as m,X as S,A as g,B as n,a6 as T,R as D,g as o,o as t,b as c,c as a,k as C,w as d,F as f,l as q,e as b,m as A,p as j,f as $,h as z,i as v,a8 as H}from"./main-e63d6b61.js";import{v as M}from"./index-48d220da.js";import{S as O}from"./SkeletonList-7e0e4de7.js";import P from"./IframeView-49923c5a.js";import{I as R}from"./IconButton-c66a2c82.js";import{_ as U}from"./ErrorDummy.vue_vue_type_script_setup_true_lang-70077fcc.js";import{E as X}from"./EmptyList-8c2bab53.js";import{C as G}from"./CustomColumn-72664405.js";import{H as J}from"./HistoryTabLogInvoiceSummary-9c20b640.js";import"./iframeObserver-8117c859.js";import"./index-6448b8a4.js";import"./dayjs-e48e80eb.js";const K={key:1,class:"state-error-hint"},Q={key:2,class:"tw-max-w-3xl tw-mx-auto"},W=v("div",{class:"icon size-80"},[v("i",{class:"fa fa-file-invoice-dollar"})],-1),Y={key:0,class:"tw-flex tw-justify-center tw-mt-4"},Z={class:"tw-h-20"},ee={key:0,class:"tw-text-center tw-py-4"},te=v("div",{class:"spinner custom-p-16"},null,-1),ie=[te],p=30,ve=L({__name:"InvoicesTab",props:{entityType:{},entityId:{},isNew:{type:Boolean},invoiceId:{}},setup(B){var I;const s=B,u=m({[`${s.entityType}_id`]:s.entityId,sort:"create_datetime",asc:0,offset:0,limit:p}),y=m(0),r=m(null),{data:x,isFetching:_,statusCode:N,error:w,execute:h}=S(g(()=>`crm.invoice.list?${H.stringify(u.value)}`),{immediate:!1,refetch:!0}).get().json();((I=n.rights)!=null&&I.invoice||n.webView)&&!s.isNew&&!s.invoiceId&&(h(),T("InvoicesTab:refresh").on(()=>{r.value&&(r.value=null,h())}));const V=g(()=>`${n.baseUrl}invoice/`+(s.invoiceId?`${s.invoiceId}/?iframe=1`:`new/?iframe=1&${s.entityType==="deal"?"deal_id":"contact"}=${s.entityId}`));D(x,e=>{e&&("params"in e&&(y.value=e.params.total_count),"data"in e&&Array.isArray(e.data)&&(r.value=[...r.value||[],...e.data]))});function E(){u.value.offset+p>=y.value||(u.value.offset+=p)}function F(e){typeof(e==null?void 0:e.detail)=="string"&&T(`InvoicesTab:${e.detail}`).emit()}return(e,l)=>o(n).rights&&!o(n).rights.invoice||o(N)===403?(t(),c(U,{key:0,code:403})):s.isNew||s.invoiceId?(t(),c(P,{id:"iframe-invoice",key:Date.now(),src:V.value,"force-resize":!0,"static-position":!0,onClose:l[0]||(l[0]=i=>{var k;return e.$router.push({query:{...(k=i==null?void 0:i.detail)!=null&&k.id?{id:i.detail.id}:{}}}).then(()=>F(i))})},null,8,["src"])):(t(),a(f,{key:2},[r.value?o(w)?(t(),a("div",K,C(o(w)),1)):(t(),a("div",Q,[r.value.length?(t(),c(G,{key:0,space:"8"},{default:d(()=>[(t(!0),a(f,null,q(r.value,i=>(t(),c(J,{key:i.id,invoice:i,"route-location":{query:{id:i.id}},class:"invoice-wrapper"},null,8,["invoice","route-location"]))),128))]),_:1})):(t(),a(f,{key:1},[b(X,{message:e.$t(`noInvoicesBy${e.$filters.toTitleCase(s.entityType)}`)},{default:d(()=>[W]),_:1},8,["message"]),e.$route.meta.menuItemType!=="frame"?(t(),a("div",Y,[b(R,{icon:"plus",onClick:l[1]||(l[1]=j(i=>e.$router.push({query:{is_new:"1"}}),["prevent"]))},{default:d(()=>[A(C(e.$t("addInvoice")),1)]),_:1})])):$("",!0)],64)),z((t(),a("div",Z,[o(_)?(t(),a("div",ee,ie)):$("",!0)])),[[o(M),([{isIntersecting:i}])=>{i&&!o(_)&&E()}]])])):(t(),c(O,{key:0,class:"tw-max-w-3xl tw-mx-auto"}))],64))}});export{ve as default};
