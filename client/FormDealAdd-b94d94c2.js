import{d as W,aD as re,H as se,P,h as $,R as oe,u as T,o as v,c as w,b as o,w as i,A,p as u,a as e,F as O,q as K,j as I,ab as z,i as S,Z as ue,l as G,e as R,T as ce,s as ne,x as ie,_ as Q,ag as ve,aA as me,D as pe,a0 as fe,I as _e,B as L,m as he,k as ye,v as be,n as ge,a1 as $e,aa as we,aO as Ce,aP as ke}from"./main-2290994d.js";import{C as Ie,f as Se}from"./fields-7ab6f7f6.js";import{_ as Ve,s as J}from"./FormContactUpdateInfo.vue_vue_type_script_setup_true_lang-67ac0b87.js";import{_ as Fe,a as X,b as De,c as Ae,u as Ne}from"./InputWithPerformers.vue_vue_type_script_setup_true_lang-ca873d3d.js";import{F as q}from"./FieldCheckbox-4d368f68.js";import{d as Ee}from"./dayjs-910ec40d.js";import{c as Ue}from"./index-6e4a059f.js";import{a as Te}from"./emit-692c947e.js";import{W as qe}from"./WaSpinner-299938a2.js";import{U as B}from"./UserPic-f44f080b.js";import{T as ee}from"./TextAreaAutoresize-55461952.js";import{M as ae,D as te,_ as le}from"./DropDown-9065f982.js";import{D as H}from"./DropDownButton-495429ba.js";import{C as Be}from"./CustomColumn-c63128eb.js";import{B as Re}from"./ButtonSubmit-4410c58d.js";import"./FieldSelect-bea6b277.js";import"./SortableList.vue_vue_type_script_setup_true_lang-c14f94b7.js";import"./useSortable-a183a608.js";import"./InputWithContacts.vue_vue_type_script_setup_true_lang-3e53fea1.js";import"./recentContacts-a3525f5f.js";import"./index-0b6b9def.js";import"./vTooltip-95186f83.js";const je={key:0,class:"deal-add-custom-fields"},Me={class:"fields"},xe={class:"name"},Le={class:"value"},Oe=W({__name:"FormDealAddSectionFields",props:{modelValue:{}},setup(g){const c=re(g,"modelValue"),{t:C}=se(),p=P("crm.field.list?scope=deal").get().json(),f=$([]);return oe(p.data,a=>{Array.isArray(a)&&(f.value=a.map(s=>(c.value.push({value:{field:s.id,value:""},error:"",...s.is_required?{validate:z.object({value:z.string().min(1,{message:C("validation.required")})}).array()}:{}}),s)))}),(a,s)=>T(c).length?(v(),w("section",je,[o(Ie,null,{name:i(()=>[A(u(a.$t("addtnlInfo")),1)]),default:i(()=>[e("div",Me,[(v(!0),w(O,null,K(f.value,(d,h)=>(v(),w("div",{key:d.id,class:"field"},[e("div",xe,u(d.name),1),e("div",Le,[(v(),S(ue(T(Se)[d.type]),{modelValue:T(c)[h].value.value,"onUpdate:modelValue":m=>T(c)[h].value.value=m,vertical:d.type==="radio",options:(d.type==="select"||d.type==="radio")&&d.option_values,required:d.is_required,"error-message":T(c)[h].error},null,8,["modelValue","onUpdate:modelValue","vertical","options","required","error-message"]))])]))),128))])]),_:1})])):I("",!0)}}),ze=g=>(ne("data-v-a4759ecf"),g=g(),ie(),g),We={class:"deal-add-customer"},Ye={class:"fields tw-mt-5 tw-mb-5"},Pe={class:"field"},Ke={class:"name"},Ge={class:"value"},He={key:0,class:"tw-flex tw-gap-x-1 tw-mt-2"},Qe=["disabled","onClick"],Ze=ze(()=>e("span",{class:"tw-mr-1"},[e("i",{class:"fas fa-plus-circle"})],-1)),Je={key:0,class:"form-group"},Xe={class:"tw-font-bold"},ea={key:1,class:"fields"},aa={class:"field"},ta={class:"name semibold"},la={class:"value"},sa={class:"field"},oa={class:"name opacity-70"},na={class:"value"},ia={class:"field"},da={class:"name opacity-70"},ra={class:"value"},ua={class:"field"},ca={class:"name opacity-70"},va={class:"value"},ma={class:"field"},pa={class:"name opacity-70"},fa={class:"value"},_a=W({__name:"FormDealAddSectionCustomer",props:{initContactId:{}},emits:["updateContactId","updateContactLabel"],setup(g,{expose:F,emit:c}){const C=g,p=$(),f=$(null),a=$(!1),s=$(null),d=$(""),h=$(!1);F({createContactOrGetExistsId:Y,isFetchingContacts:G(()=>{var l;return(l=p==null?void 0:p.value)==null?void 0:l.isFetchingContacts})});function m(l){var y,k;if(h.value=!1,d.value="",!l)return s.value=null,null;a.value=!1,s.value={id:l.id,name:l.name,jobtitle:l.jobtitle||"",company:l.company||"",is_company:l.is_company,email:((y=l.fields.find(b=>b.id==="email"))==null?void 0:y.value[0])??"",phone:((k=l.fields.find(b=>b.id==="phone"))==null?void 0:k.value[0])??""},c("updateContactId",(l==null?void 0:l.id)||null)}function N(){var l;a.value||(a.value=!0,s.value=null,(l=p.value)==null||l.clearValue(),d.value="",c("updateContactId",null))}async function Y(){var b,r,t;if(h.value=!a.value&&!((b=s.value)!=null&&b.id),h.value)return null;if((r=s.value)!=null&&r.id)return s.value.id;const l=await((t=f.value)==null?void 0:t.submit());if(!l)return null;const{data:y,error:k}=l;return k.value?new Error(k.value):Number(y.value)}return(l,y)=>(v(),w("section",We,[e("div",Ye,[e("div",Pe,[e("div",Ke,u(l.$t("customer")),1),e("div",Ge,[o(Fe,{ref_key:"inputWithCustomersRef",ref:p,width:"320px",placeholder:l.$t("searchByNameEmailPhone"),"with-fields":["email","phone","company","jobtitle"],"init-contact-id":C.initContactId,disabled:!!C.initContactId,"error-message":h.value?l.$t("validation.required"):"",onUpdate:m,onClear:y[0]||(y[0]=k=>m(null))},null,8,["placeholder","init-contact-id","disabled","error-message"]),C.initContactId?I("",!0):(v(),w("div",He,[e("span",null,u(l.$t("or")),1),e("a",{class:"tw-font-semibold",disabled:a.value,onClick:R(N,["prevent"])},[Ze,e("span",null,u(l.$t("addNew")),1)],8,Qe)]))])])]),o(ce,{name:"fade",mode:"out-in"},{default:i(()=>{var k;return[a.value?(v(),w("div",Je,[e("p",Xe,u(l.$t("createCustomer")),1),o(Ve,{ref_key:"formContactUpdateInfoRef",ref:f},{firstFieldTitle:i(()=>[A(u(l.$t("roleInDeal")),1)]),firstFieldValue:i(()=>[o(X,{modelValue:d.value,"onUpdate:modelValue":[y[1]||(y[1]=b=>d.value=b),y[2]||(y[2]=b=>c("updateContactLabel",b))],scope:"CLIENT",right:!1,width:"238px"},null,8,["modelValue"])]),_:1},512)])):(k=s.value)!=null&&k.id?(v(),w("div",ea,[e("div",aa,[e("div",ta,u(l.$t("roleInDeal")),1),e("div",la,[o(X,{modelValue:d.value,"onUpdate:modelValue":[y[3]||(y[3]=b=>d.value=b),y[4]||(y[4]=b=>c("updateContactLabel",b))],scope:"CLIENT",right:!1,width:"320px"},null,8,["modelValue"])])]),s.value.is_company?I("",!0):(v(),w(O,{key:0},[e("div",sa,[e("div",oa,u(l.$t("company")),1),e("div",na,[o(q,{"model-value":s.value.company,type:"text",disabled:""},null,8,["model-value"])])]),e("div",ia,[e("div",da,u(l.$t("jobTitle")),1),e("div",ra,[o(q,{"model-value":s.value.jobtitle,type:"text",disabled:""},null,8,["model-value"])])])],64)),e("div",ua,[e("div",ca,u(l.$t("phone")),1),e("div",va,[o(q,{"model-value":s.value.phone,type:"text",disabled:""},null,8,["model-value"])])]),e("div",ma,[e("div",pa,u(l.$t("email")),1),e("div",fa,[o(q,{"model-value":s.value.email,type:"email",disabled:""},null,8,["model-value"])])])])):I("",!0)]}),_:1})]))}});const ha=Q(_a,[["__scopeId","data-v-a4759ecf"]]),ya={class:"select-funnel-and-stage"},ba=["onClick"],ga={class:"icon small"},$a=["onClick"],wa={class:"icon small"},Ca=W({__name:"SelectFunnelAndStage",props:{funnelId:{},forceFetch:{type:Boolean}},emits:["updateStageId"],setup(g,{emit:F}){const c=g,C=ve(),p=me(C,"funnels");c.forceFetch&&!p.value.length&&C.refetch();const f=$(),a=$();return pe(()=>p.value.length,()=>{const s=C.getFirstAvailableFunnel();s&&(f.value=p.value.find(d=>d.id===c.funnelId)||s,a.value=f.value.stages[0],a.value&&F("updateStageId",a.value.id))},{immediate:!0}),oe(a,s=>{s&&F("updateStageId",s.id)}),(s,d)=>(v(),w("div",ya,[!p.value.length||p.value.length>1?(v(),S(te,{key:0,class:"select-dropdown"},{body:i(({hide:h})=>[p.value.length?(v(),S(ae,{key:0},{default:i(()=>[(v(!0),w(O,null,K(p.value.filter(m=>!m.is_archived),m=>(v(),S(le,{key:m.id},{default:i(()=>[e("a",{onClick:R(N=>{f.value=m,a.value=m.stages[0],h()},["prevent"])},[e("div",ga,[o(B,{size:16,"icon-class":m.icon,"icon-color":m.color},null,8,["icon-class","icon-color"])]),e("span",null,u(m.name),1)],8,ba)]),_:2},1024))),128))]),_:2},1024)):I("",!0)]),default:i(()=>[o(H,{"mobile-w-full":"","is-skeleton":!p.value.length},{icon:i(()=>[f.value?(v(),S(B,{key:f.value.icon,size:16,"icon-class":f.value.icon,"icon-color":f.value.color},null,8,["icon-class","icon-color"])):I("",!0)]),default:i(()=>[A(" "+u(f.value?f.value.name:s.$t("allStages")),1)]),_:1},8,["is-skeleton"])]),_:1})):I("",!0),o(te,{class:"select-dropdown",disabled:!a.value},{body:i(({hide:h})=>[f.value?(v(),S(ae,{key:0},{default:i(()=>[(v(!0),w(O,null,K(f.value.stages,m=>(v(),S(le,{key:m.id},{default:i(()=>[e("a",{onClick:R(N=>{a.value=m,h()},["prevent"])},[e("div",wa,[o(B,{size:10,"disable-rounded":"","bg-color":m.color},null,8,["bg-color"])]),e("span",null,u(m.name),1)],8,$a)]),_:2},1024))),128))]),_:2},1024)):I("",!0)]),default:i(()=>[o(H,{"mobile-w-full":"","is-skeleton":!p.value.length},{icon:i(()=>[a.value?(v(),S(B,{key:a.value.id,size:10,"disable-rounded":"","bg-color":a.value.color},null,8,["bg-color"])):I("",!0)]),default:i(()=>[A(" "+u(a.value?a.value.name:s.$t("allStages")),1)]),_:1},8,["is-skeleton"])]),_:1},8,["disabled"])]))}});const ka=Q(Ca,[["__scopeId","data-v-4905c02d"]]),Ia=g=>(ne("data-v-6347077d"),g=g(),ie(),g),Sa={class:"deal-add-main"},Va={class:"fields"},Fa={class:"field"},Da={class:"name"},Aa={class:"value"},Na={class:"field"},Ea={class:"name"},Ua={class:"value"},Ta={class:"field"},qa={class:"name"},Ba={class:"value"},Ra={class:"field"},ja={class:"name"},Ma={class:"value"},xa={class:"field-amount-wrapper tw-max-w-[448px]"},La={key:0,class:"hint break-word"},Oa=["href"],za=Ia(()=>e("i",{class:"fas fa-external-link-alt fa-sm"},null,-1)),Wa={class:"field"},Ya={class:"name"},Pa={class:"value"},Ka={class:"field"},Ga={class:"state-error-hint"},Ha=W({__name:"FormDealAdd",props:{funnelId:{},contactId:{},conversationId:{},disableNavigateToDeal:{type:Boolean},onAdded:{type:Function}},emits:["close"],setup(g,{emit:F}){const c=g,{t:C}=se(),p=fe(),f=_e(Ue),a=$({stage_id:{value:null,is_required:!0},name:{value:"",is_required:!0,validate:z.string().trim().min(1,{message:C("validation.required")})},description:{value:""},expected_date:{value:Ee().add(2,"w").format("YYYY-MM-DD")},amount:{value:""},currency_id:{value:""},contact_id:{value:Number(c.contactId)||null},contact_label:{value:""},user_contact_id:{value:L.user.id},fields:[]}),s=$(!1),d=$(""),h=$(null),m=G(()=>f.value||Ce()),N=G(()=>Ne().isEmptyCurrencies);function Y(){let r=!1;return Object.entries(a.value).forEach(([,t])=>{if(t.error="",t.is_required&&t.validate)try{t.validate.parse(t.value)}catch(E){E instanceof z.ZodError&&(t.error=E.issues[0].message,r=!0)}}),r?(J(),!1):!0}async function l(){var n,x;if(s.value=!1,d.value="",!Y())return null;s.value=!0;const r=await((n=h.value)==null?void 0:n.createContactOrGetExistsId());if(typeof r=="number")a.value.contact_id.value=r;else return r instanceof Error&&(d.value=r.message),s.value=!1,null;const t=new Map;Object.keys(a.value).forEach(D=>{const V=D,U=a.value[V];if(Array.isArray(U))t.set(V,U.filter(_=>_.value.value).map(_=>({field:_.value.field,value:_.value.value})));else if(U!=null&&U.value){let{value:_}=U;V==="description"&&typeof _=="string"&&(_=ke(_),_=_.replace(/\n/g,"<br>")),t.set(V,_)}});const{data:E,response:j,error:M}=await P("crm.deal.add",{onFetchError(D){var V;return typeof D.data=="string"&&((V=JSON.parse(D.data).error_fields)==null||V.forEach(_=>{if(_.code==="fields"){const Z=a.value.fields.find(de=>de.value.field===_.field);Z&&(Z.error=_.description)}else _.field in a.value&&(a.value[_.field].error=_.description)}),J()),D}}).post(Object.fromEntries(t));if(s.value=!1,d.value=M.value,!d.value&&((x=j.value)!=null&&x.ok)&&E.value){const D=Number(E.value);if(!isNaN(Number(c.conversationId))){const{error:V}=await y(D,Number(c.conversationId));if(d.value=V.value,d.value)return null}return F("close"),D}return null}async function y(r,t){return await P("crm.conversation.deal").post({deal_id:r,conversation_id:t})}function k(){we.emit("spa:navigateBack"),F("close")}async function b(r){const t=await l();t&&(typeof c.onAdded=="function"&&c.onAdded(),!r.shiftKey&&!c.disableNavigateToDeal&&p.push({name:"deal",params:{id:t},replace:!!L.webView}),Te())}return(r,t)=>{const E=he("i18n-t");return v(),S($e,{"vertical-stretch":!0,"use-cancel-as-button-label":!0,"hide-close-icon":"",onClose:k},{header:i(()=>[A(u(r.$t("newDeal")),1)]),default:i(()=>{var j,M;return[ye(o(Be,{space:"4",class:"tw-relative tw-h-full"},{default:i(()=>[e("section",Sa,[e("div",Va,[e("div",Fa,[e("div",Da,u(r.$t("title")),1),e("div",Aa,[o(ee,{modelValue:a.value.name.value,"onUpdate:modelValue":t[0]||(t[0]=n=>a.value.name.value=n),class:"field-title-textarea tw-font-bold","aria-required":"true","max-rows":10,"error-message":a.value.name.error,onKeydown:t[1]||(t[1]=n=>a.value.name.error="")},null,8,["modelValue","error-message"])])]),e("div",Na,[e("div",Ea,u(r.$t("currentStage")),1),e("div",Ua,[o(ka,{"funnel-id":c.funnelId,"force-fetch":!!c.contactId||r.$route.meta.menuItemType==="frame",class:"tw-max-w-[448px]",onUpdateStageId:t[2]||(t[2]=n=>a.value.stage_id.value=n)},null,8,["funnel-id","force-fetch"])])]),e("div",Ta,[e("div",qa,u(r.$t("responsible")),1),e("div",Ba,[o(De,{contact:T(L).user,class:"tw-max-w-[448px]","hide-clear":"",onUpdate:t[3]||(t[3]=n=>a.value.user_contact_id.value=n.id)},{preview:i(({model:n,showInput:x})=>[o(H,{class:"tw-pl-1",width:"448px","mobile-w-full":"",onClick:R(x,["prevent"])},{icon:i(()=>[o(B,{size:16,url:n.userpic},null,8,["url"])]),default:i(()=>[A(" "+u(n.name),1)]),_:2},1032,["onClick"])]),_:1},8,["contact"])])]),e("div",Ra,[e("div",ja,u(r.$t("estimatedAmount")),1),e("div",Ma,[e("div",xa,[o(q,{modelValue:a.value.amount.value,"onUpdate:modelValue":t[4]||(t[4]=n=>a.value.amount.value=n),"fallback-type-number":m.value,"error-message":a.value.amount.error,disabled:N.value,class:"!tw-text-left",type:"number",min:"0"},null,8,["modelValue","fallback-type-number","error-message","disabled"]),o(Ae,{"model-value":a.value.currency_id.value,"error-message":a.value.currency_id.error,disabled:N.value,"onUpdate:modelValue":t[5]||(t[5]=n=>a.value.currency_id.value=n)},null,8,["model-value","error-message","disabled"])]),N.value?(v(),w("div",La,[o(E,{keypath:"currenciesNotSetUp"},{default:i(()=>[e("a",{class:ge(r.$constant.parentAppDisableRouterClass),href:`${T(L).baseUrl}settings/currencies/`,target:"_blank"},[A(u(r.$t("settingsCurrencies"))+" ",1),za],10,Oa)]),_:1})])):I("",!0)])]),e("div",Wa,[e("div",Ya,u(r.$t("expectedCloseDate")),1),e("div",Pa,[o(q,{modelValue:a.value.expected_date.value,"onUpdate:modelValue":t[6]||(t[6]=n=>a.value.expected_date.value=n),type:"date",class:"!tw-w-auto","error-message":a.value.expected_date.error},null,8,["modelValue","error-message"])])]),e("div",Ka,[o(ee,{modelValue:a.value.description.value,"onUpdate:modelValue":t[7]||(t[7]=n=>a.value.description.value=n),class:"field-description-textarea",rows:"2",placeholder:r.$t("dealDescr"),"error-message":a.value.description.error,onKeydown:t[8]||(t[8]=n=>a.value.description.error="")},null,8,["modelValue","placeholder","error-message"])])])]),o(ha,{ref_key:"formDealAddSectionCustomerRef",ref:h,"init-contact-id":Number(c.contactId),class:"tw-pb-1",onUpdateContactId:t[9]||(t[9]=n=>a.value.contact_id.value=n),onUpdateContactLabel:t[10]||(t[10]=n=>a.value.contact_label.value=n)},null,8,["init-contact-id"]),o(Oe,{modelValue:a.value.fields,"onUpdate:modelValue":t[11]||(t[11]=n=>a.value.fields=n),class:"tw-pb-7"},null,8,["modelValue"])]),_:1},512),[[be,!((j=h.value)!=null&&j.isFetchingContacts)]]),(M=h.value)!=null&&M.isFetchingContacts?(v(),S(qe,{key:0})):I("",!0)]}),submit:i(()=>[o(Re,{"is-fetching":s.value,class:"custom-mr-4",onClick:R(b,["prevent"])},{default:i(()=>[A(u(r.$t("create")),1)]),_:1},8,["is-fetching","onClick"])]),error:i(()=>[e("span",Ga,u(d.value),1)]),_:1})}}});const yt=Q(Ha,[["__scopeId","data-v-6347077d"]]);export{yt as default};
