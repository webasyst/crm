import{d as Y,aA as re,H as se,M as K,h as $,Q as oe,u as T,o as v,c as w,b as o,w as i,A,p as u,a as e,F as z,q as Q,j as k,aa as O,i as S,Y as ue,l as G,e as M,T as ce,s as ne,x as ie,_ as P,ay as ve,aL as me,D as pe,$ as fe,I as _e,B as x,m as he,k as ye,v as be,n as ge,a0 as $e,a8 as we,aM as Ce,aN as ke}from"./main-46836c41.js";import{C as Ie,f as Se}from"./fields-e10d6cd3.js";import{_ as Ve,s as X}from"./FormContactUpdateInfo.vue_vue_type_script_setup_true_lang-c3cfd939.js";import{_ as Fe,a as Z,b as De,c as Ae,u as Ne}from"./InputWithPerformers.vue_vue_type_script_setup_true_lang-07dbcaf8.js";import{F as q}from"./FieldCheckbox-618a9e12.js";import{d as Ee}from"./dayjs-a1477631.js";import{b as Ue}from"./index-0f68ab4c.js";import{W as Te}from"./WaSpinner-f3419042.js";import{U as B}from"./UserPic-951b6ea8.js";import{T as ee}from"./TextAreaAutoresize-21a4dcce.js";import{M as ae,D as te,_ as le}from"./DropDown-2ad3ed01.js";import{D as H}from"./DropDownButton-49606824.js";import{C as qe}from"./CustomColumn-c8c73188.js";import{B as Be}from"./ButtonSubmit-c3bae343.js";import"./FieldSelect-19a80dbd.js";import"./SortableList.vue_vue_type_script_setup_true_lang-f84f3915.js";import"./useSortable-69b2c6e6.js";import"./InputWithContacts.vue_vue_type_script_setup_true_lang-5a82d5a8.js";import"./recentContacts-3e5f8df1.js";import"./index-dbd22bf6.js";import"./vTooltip-9ea5107e.js";const Me={key:0,class:"deal-add-custom-fields"},je={class:"fields"},Le={class:"name"},Re={class:"value"},xe=Y({__name:"FormDealAddSectionFields",props:{modelValue:{}},setup(g){const c=re(g,"modelValue"),{t:I}=se(),m=K("crm.field.list?scope=deal").get().json(),p=$([]);return oe(m.data,a=>{Array.isArray(a)&&(p.value=a.map(s=>(c.value.push({value:{field:s.id,value:""},error:"",...s.is_required?{validate:O.object({value:O.string().min(1,{message:I("validation.required")})}).array()}:{}}),s)))}),(a,s)=>T(c).length?(v(),w("section",Me,[o(Ie,null,{name:i(()=>[A(u(a.$t("addtnlInfo")),1)]),default:i(()=>[e("div",je,[(v(!0),w(z,null,Q(p.value,(d,_)=>(v(),w("div",{key:d.id,class:"field"},[e("div",Le,u(d.name),1),e("div",Re,[(v(),S(ue(T(Se)[d.type]),{modelValue:T(c)[_].value.value,"onUpdate:modelValue":h=>T(c)[_].value.value=h,vertical:d.type==="radio",options:(d.type==="select"||d.type==="radio")&&d.option_values,required:d.is_required,"error-message":T(c)[_].error},null,8,["modelValue","onUpdate:modelValue","vertical","options","required","error-message"]))])]))),128))])]),_:1})])):k("",!0)}}),ze=g=>(ne("data-v-a4759ecf"),g=g(),ie(),g),Oe={class:"deal-add-customer"},Ye={class:"fields tw-mt-5 tw-mb-5"},We={class:"field"},Ke={class:"name"},Qe={class:"value"},Ge={key:0,class:"tw-flex tw-gap-x-1 tw-mt-2"},He=["disabled","onClick"],Pe=ze(()=>e("span",{class:"tw-mr-1"},[e("i",{class:"fas fa-plus-circle"})],-1)),Je={key:0,class:"form-group"},Xe={class:"tw-font-bold"},Ze={key:1,class:"fields"},ea={class:"field"},aa={class:"name semibold"},ta={class:"value"},la={class:"field"},sa={class:"name opacity-70"},oa={class:"value"},na={class:"field"},ia={class:"name opacity-70"},da={class:"value"},ra={class:"field"},ua={class:"name opacity-70"},ca={class:"value"},va={class:"field"},ma={class:"name opacity-70"},pa={class:"value"},fa=Y({__name:"FormDealAddSectionCustomer",props:{initContactId:{}},emits:["updateContactId","updateContactLabel"],setup(g,{expose:F,emit:c}){const I=g,m=$(),p=$(null),a=$(!1),s=$(null),d=$(""),_=$(!1);F({createContactOrGetExistsId:W,isFetchingContacts:G(()=>{var l;return(l=m==null?void 0:m.value)==null?void 0:l.isFetchingContacts})});function h(l){var y,C;if(_.value=!1,d.value="",!l)return s.value=null,null;a.value=!1,s.value={id:l.id,name:l.name,jobtitle:l.jobtitle||"",company:l.company||"",is_company:l.is_company,email:((y=l.fields.find(b=>b.id==="email"))==null?void 0:y.value[0])??"",phone:((C=l.fields.find(b=>b.id==="phone"))==null?void 0:C.value[0])??""},c("updateContactId",(l==null?void 0:l.id)||null)}function N(){var l;a.value||(a.value=!0,s.value=null,(l=m.value)==null||l.clearValue(),d.value="",c("updateContactId",null))}async function W(){var b,r,t;if(_.value=!a.value&&!((b=s.value)!=null&&b.id),_.value)return null;if((r=s.value)!=null&&r.id)return s.value.id;const l=await((t=p.value)==null?void 0:t.submit());if(!l)return null;const{data:y,error:C}=l;return C.value?new Error(C.value):Number(y.value)}return(l,y)=>(v(),w("section",Oe,[e("div",Ye,[e("div",We,[e("div",Ke,u(l.$t("customer")),1),e("div",Qe,[o(Fe,{ref_key:"inputWithCustomersRef",ref:m,width:"320px",placeholder:l.$t("searchByNameEmailPhone"),"with-fields":["email","phone","company","jobtitle"],"init-contact-id":I.initContactId,disabled:!!I.initContactId,"error-message":_.value?l.$t("validation.required"):"",onUpdate:h,onClear:y[0]||(y[0]=C=>h(null))},null,8,["placeholder","init-contact-id","disabled","error-message"]),I.initContactId?k("",!0):(v(),w("div",Ge,[e("span",null,u(l.$t("or")),1),e("a",{class:"tw-font-semibold",disabled:a.value,onClick:M(N,["prevent"])},[Pe,e("span",null,u(l.$t("addNew")),1)],8,He)]))])])]),o(ce,{name:"fade",mode:"out-in"},{default:i(()=>{var C;return[a.value?(v(),w("div",Je,[e("p",Xe,u(l.$t("createCustomer")),1),o(Ve,{ref_key:"formContactUpdateInfoRef",ref:p},{firstFieldTitle:i(()=>[A(u(l.$t("roleInDeal")),1)]),firstFieldValue:i(()=>[o(Z,{modelValue:d.value,"onUpdate:modelValue":[y[1]||(y[1]=b=>d.value=b),y[2]||(y[2]=b=>c("updateContactLabel",b))],scope:"CLIENT",right:!1,width:"238px"},null,8,["modelValue"])]),_:1},512)])):(C=s.value)!=null&&C.id?(v(),w("div",Ze,[e("div",ea,[e("div",aa,u(l.$t("roleInDeal")),1),e("div",ta,[o(Z,{modelValue:d.value,"onUpdate:modelValue":[y[3]||(y[3]=b=>d.value=b),y[4]||(y[4]=b=>c("updateContactLabel",b))],scope:"CLIENT",right:!1,width:"320px"},null,8,["modelValue"])])]),s.value.is_company?k("",!0):(v(),w(z,{key:0},[e("div",la,[e("div",sa,u(l.$t("company")),1),e("div",oa,[o(q,{"model-value":s.value.company,type:"text",disabled:""},null,8,["model-value"])])]),e("div",na,[e("div",ia,u(l.$t("jobTitle")),1),e("div",da,[o(q,{"model-value":s.value.jobtitle,type:"text",disabled:""},null,8,["model-value"])])])],64)),e("div",ra,[e("div",ua,u(l.$t("phone")),1),e("div",ca,[o(q,{"model-value":s.value.phone,type:"text",disabled:""},null,8,["model-value"])])]),e("div",va,[e("div",ma,u(l.$t("email")),1),e("div",pa,[o(q,{"model-value":s.value.email,type:"email",disabled:""},null,8,["model-value"])])])])):k("",!0)]}),_:1})]))}});const _a=P(fa,[["__scopeId","data-v-a4759ecf"]]),ha={class:"select-funnel-and-stage"},ya=["onClick"],ba={class:"icon small"},ga=["onClick"],$a={class:"icon small"},wa=Y({__name:"SelectFunnelAndStage",props:{funnelId:{},forceFetch:{type:Boolean}},emits:["updateStageId"],setup(g,{emit:F}){const c=g,I=ve(),m=me(I,"funnels");c.forceFetch&&!m.value.length&&I.refetch();const p=$(),a=$();return pe(()=>m.value.length,()=>{const s=m.value[0];p.value=m.value.find(d=>d.id===c.funnelId)||s,a.value=p.value.stages[0],a.value&&F("updateStageId",a.value.id)},{immediate:!0}),oe(a,s=>{s&&F("updateStageId",s.id)}),(s,d)=>(v(),w("div",ha,[!m.value.length||m.value.length>1?(v(),S(te,{key:0,class:"select-dropdown"},{body:i(({hide:_})=>[m.value.length?(v(),S(ae,{key:0},{default:i(()=>[(v(!0),w(z,null,Q(m.value,h=>(v(),S(le,{key:h.id},{default:i(()=>[e("a",{onClick:M(N=>{p.value=h,a.value=h.stages[0],_()},["prevent"])},[e("div",ba,[o(B,{size:10,"disable-rounded":"","bg-color":h.color},null,8,["bg-color"])]),e("span",null,u(h.name),1)],8,ya)]),_:2},1024))),128))]),_:2},1024)):k("",!0)]),default:i(()=>[o(H,{"mobile-w-full":"","is-skeleton":!m.value.length},{icon:i(()=>[p.value?(v(),S(B,{key:p.value.id,size:10,"disable-rounded":"","bg-color":p.value.color},null,8,["bg-color"])):k("",!0)]),title:i(()=>[A(u(p.value?p.value.name:s.$t("allStages")),1)]),_:1},8,["is-skeleton"])]),_:1})):k("",!0),o(te,{class:"select-dropdown",disabled:!a.value},{body:i(({hide:_})=>[p.value?(v(),S(ae,{key:0},{default:i(()=>[(v(!0),w(z,null,Q(p.value.stages,h=>(v(),S(le,{key:h.id},{default:i(()=>[e("a",{onClick:M(N=>{a.value=h,_()},["prevent"])},[e("div",$a,[o(B,{size:10,"disable-rounded":"","bg-color":h.color},null,8,["bg-color"])]),e("span",null,u(h.name),1)],8,ga)]),_:2},1024))),128))]),_:2},1024)):k("",!0)]),default:i(()=>[o(H,{"mobile-w-full":"","is-skeleton":!m.value.length},{icon:i(()=>[a.value?(v(),S(B,{key:a.value.id,size:10,"disable-rounded":"","bg-color":a.value.color},null,8,["bg-color"])):k("",!0)]),title:i(()=>[A(u(a.value?a.value.name:s.$t("allStages")),1)]),_:1},8,["is-skeleton"])]),_:1},8,["disabled"])]))}});const Ca=P(wa,[["__scopeId","data-v-32c2d041"]]),ka=g=>(ne("data-v-c21424d0"),g=g(),ie(),g),Ia={class:"deal-add-main"},Sa={class:"fields"},Va={class:"field"},Fa={class:"name"},Da={class:"value"},Aa={class:"field"},Na={class:"name"},Ea={class:"value"},Ua={class:"field"},Ta={class:"name"},qa={class:"value"},Ba={class:"field"},Ma={class:"name"},ja={class:"value"},La={class:"field-amount-wrapper tw-max-w-[448px]"},Ra={key:0,class:"hint break-word"},xa=["href"],za=ka(()=>e("i",{class:"fas fa-external-link-alt fa-sm"},null,-1)),Oa={class:"field"},Ya={class:"name"},Wa={class:"value"},Ka={class:"field"},Qa={class:"state-error-hint"},Ga=Y({__name:"FormDealAdd",props:{funnelId:{},contactId:{},conversationId:{},disableNavigateToDeal:{type:Boolean},onAdded:{type:Function}},emits:["close"],setup(g,{emit:F}){const c=g,{t:I}=se(),m=fe(),p=_e(Ue),a=$({stage_id:{value:null,is_required:!0},name:{value:"",is_required:!0,validate:O.string().trim().min(1,{message:I("validation.required")})},description:{value:""},expected_date:{value:Ee().add(2,"w").format("YYYY-MM-DD")},amount:{value:""},currency_id:{value:""},contact_id:{value:Number(c.contactId)||null},contact_label:{value:""},user_contact_id:{value:x.user.id},fields:[]}),s=$(!1),d=$(""),_=$(null),h=G(()=>p.value||Ce()),N=G(()=>Ne().isEmptyCurrencies);function W(){let r=!1;return Object.entries(a.value).forEach(([,t])=>{if(t.error="",t.is_required&&t.validate)try{t.validate.parse(t.value)}catch(E){E instanceof O.ZodError&&(t.error=E.issues[0].message,r=!0)}}),r?(X(),!1):!0}async function l(){var n,R;if(s.value=!1,d.value="",!W())return null;s.value=!0;const r=await((n=_.value)==null?void 0:n.createContactOrGetExistsId());if(typeof r=="number")a.value.contact_id.value=r;else return r instanceof Error&&(d.value=r.message),s.value=!1,null;const t=new Map;Object.keys(a.value).forEach(D=>{const V=D,U=a.value[V];if(Array.isArray(U))t.set(V,U.filter(f=>f.value.value).map(f=>({field:f.value.field,value:f.value.value})));else if(U!=null&&U.value){let{value:f}=U;V==="description"&&typeof f=="string"&&(f=ke(f),f=f.replace(/\n/g,"<br>")),t.set(V,f)}});const{data:E,response:j,error:L}=await K("crm.deal.add",{onFetchError(D){var V;return typeof D.data=="string"&&((V=JSON.parse(D.data).error_fields)==null||V.forEach(f=>{if(f.code==="fields"){const J=a.value.fields.find(de=>de.value.field===f.field);J&&(J.error=f.description)}else f.field in a.value&&(a.value[f.field].error=f.description)}),X()),D}}).post(Object.fromEntries(t));if(s.value=!1,d.value=L.value,!d.value&&((R=j.value)!=null&&R.ok)&&E.value){const D=Number(E.value);if(!isNaN(Number(c.conversationId))){const{error:V}=await y(D,Number(c.conversationId));if(d.value=V.value,d.value)return null}return F("close"),D}return null}async function y(r,t){return await K("crm.conversation.deal").post({deal_id:r,conversation_id:t})}function C(){we.emit("spa:navigateBack"),F("close")}async function b(r){const t=await l();t&&(typeof c.onAdded=="function"&&c.onAdded(),!r.shiftKey&&!c.disableNavigateToDeal&&m.push({name:"deal",params:{id:t},replace:!!x.webView}))}return(r,t)=>{const E=he("i18n-t");return v(),S($e,{"vertical-stretch":!0,"use-cancel-as-button-label":!0,"hide-close-icon":"",onClose:C},{header:i(()=>[A(u(r.$t("newDeal")),1)]),default:i(()=>{var j,L;return[ye(o(qe,{space:"4",class:"tw-relative tw-h-full"},{default:i(()=>[e("section",Ia,[e("div",Sa,[e("div",Va,[e("div",Fa,u(r.$t("title")),1),e("div",Da,[o(ee,{modelValue:a.value.name.value,"onUpdate:modelValue":t[0]||(t[0]=n=>a.value.name.value=n),class:"field-title-textarea tw-font-bold","aria-required":"true","max-rows":10,"error-message":a.value.name.error,onKeydown:t[1]||(t[1]=n=>a.value.name.error="")},null,8,["modelValue","error-message"])])]),e("div",Aa,[e("div",Na,u(r.$t("currentStage")),1),e("div",Ea,[o(Ca,{"funnel-id":c.funnelId,"force-fetch":!!c.contactId||r.$route.meta.menuItemType==="frame",class:"tw-max-w-[448px]",onUpdateStageId:t[2]||(t[2]=n=>a.value.stage_id.value=n)},null,8,["funnel-id","force-fetch"])])]),e("div",Ua,[e("div",Ta,u(r.$t("responsible")),1),e("div",qa,[o(De,{contact:T(x).user,class:"tw-max-w-[448px]","hide-clear":"",onUpdate:t[3]||(t[3]=n=>a.value.user_contact_id.value=n.id)},{preview:i(({model:n,showInput:R})=>[o(H,{class:"tw-pl-1",width:"448px","mobile-w-full":"",onClick:M(R,["prevent"])},{icon:i(()=>[o(B,{size:16,url:n.userpic},null,8,["url"])]),title:i(()=>[A(u(n.name),1)]),_:2},1032,["onClick"])]),_:1},8,["contact"])])]),e("div",Ba,[e("div",Ma,u(r.$t("estimatedAmount")),1),e("div",ja,[e("div",La,[o(q,{modelValue:a.value.amount.value,"onUpdate:modelValue":t[4]||(t[4]=n=>a.value.amount.value=n),"fallback-type-number":h.value,"error-message":a.value.amount.error,disabled:N.value,class:"!tw-text-left",type:"number",min:"0"},null,8,["modelValue","fallback-type-number","error-message","disabled"]),o(Ae,{"model-value":a.value.currency_id.value,"error-message":a.value.currency_id.error,disabled:N.value,"onUpdate:modelValue":t[5]||(t[5]=n=>a.value.currency_id.value=n)},null,8,["model-value","error-message","disabled"])]),N.value?(v(),w("div",Ra,[o(E,{keypath:"currenciesNotSetUp"},{default:i(()=>[e("a",{class:ge(r.$constant.parentAppDisableRouterClass),href:`${T(x).baseUrl}settings/currencies/`,target:"_blank"},[A(u(r.$t("settingsCurrencies"))+" ",1),za],10,xa)]),_:1})])):k("",!0)])]),e("div",Oa,[e("div",Ya,u(r.$t("expectedCloseDate")),1),e("div",Wa,[o(q,{modelValue:a.value.expected_date.value,"onUpdate:modelValue":t[6]||(t[6]=n=>a.value.expected_date.value=n),type:"date",class:"!tw-w-auto","error-message":a.value.expected_date.error},null,8,["modelValue","error-message"])])]),e("div",Ka,[o(ee,{modelValue:a.value.description.value,"onUpdate:modelValue":t[7]||(t[7]=n=>a.value.description.value=n),class:"field-description-textarea",rows:"2",placeholder:r.$t("dealDescr"),"error-message":a.value.description.error,onKeydown:t[8]||(t[8]=n=>a.value.description.error="")},null,8,["modelValue","placeholder","error-message"])])])]),o(_a,{ref_key:"formDealAddSectionCustomerRef",ref:_,"init-contact-id":Number(c.contactId),class:"tw-pb-1",onUpdateContactId:t[9]||(t[9]=n=>a.value.contact_id.value=n),onUpdateContactLabel:t[10]||(t[10]=n=>a.value.contact_label.value=n)},null,8,["init-contact-id"]),o(xe,{modelValue:a.value.fields,"onUpdate:modelValue":t[11]||(t[11]=n=>a.value.fields=n),class:"tw-pb-7"},null,8,["modelValue"])]),_:1},512),[[be,!((j=_.value)!=null&&j.isFetchingContacts)]]),(L=_.value)!=null&&L.isFetchingContacts?(v(),S(Te,{key:0})):k("",!0)]}),submit:i(()=>[o(Be,{"is-fetching":s.value,class:"custom-mr-4",onClick:M(b,["prevent"])},{default:i(()=>[A(u(r.$t("create")),1)]),_:1},8,["is-fetching","onClick"])]),error:i(()=>[e("span",Qa,u(d.value),1)]),_:1})}}});const _t=P(Ga,[["__scopeId","data-v-c21424d0"]]);export{_t as default};
