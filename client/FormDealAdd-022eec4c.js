import{d as O,av as de,H as se,X as Y,a as $,R as oe,g as T,o as v,c as C,e as o,w as i,m as A,k as u,i as e,F as G,l as H,f as S,a4 as z,b as k,P as ue,A as K,p as j,aC as ce,q as ne,s as ie,_ as Q,at as ve,aG as me,D as pe,S as fe,I as _e,B as x,j as he,h as ye,v as be,n as ge,W as $e,a2 as we,aH as Ce,aI as Ie}from"./main-14ee4927.js";import{C as ke,f as Se}from"./fields-2ab9835b.js";import{_ as Ve,s as J}from"./FormContactUpdateInfo.vue_vue_type_script_setup_true_lang-a1d0a572.js";import{I as De,_ as Z,a as Fe,b as Ae,u as Ne}from"./InputWithPerformers.vue_vue_type_script_setup_true_lang-e48d4e1a.js";import{a as q}from"./FieldCheckbox-7ee9d154.js";import{d as Ee}from"./dayjs-733f6bc6.js";import{b as Ue}from"./index-39be567b.js";import{W as Te}from"./WaSpinner-8d72557e.js";import{U as B}from"./UserPic-88a434b2.js";import{T as ee}from"./TextAreaAutoresize-0b20aa66.js";import{M as ae,D as te,_ as le}from"./DropDown-3d660bad.js";import{D as P}from"./DropDownButton-4f1c8b7b.js";import{C as qe}from"./CustomColumn-9af7d856.js";import{B as Be}from"./ButtonSubmit-4d96401d.js";import"./FieldSelect-b035d25b.js";import"./SortableList.vue_vue_type_script_setup_true_lang-b03ce62e.js";import"./useSortable-653c7c49.js";import"./InputWithContacts.vue_vue_type_script_setup_true_lang-4f517706.js";import"./recentContacts-56405508.js";import"./index-927b8924.js";const je={key:0,class:"deal-add-custom-fields"},Re={class:"fields"},Me={class:"name"},Le={class:"value"},xe=O({__name:"FormDealAddSectionFields",props:{modelValue:{}},setup(g){const c=de(g,"modelValue"),{t:I}=se(),m=Y("crm.field.list?scope=deal").get().json(),p=$([]);return oe(m.data,a=>{Array.isArray(a)&&(p.value=a.map(s=>(c.value.push({value:{field:s.id,value:""},error:"",...s.is_required?{validate:z.object({value:z.string().min(1,{message:I("validation.required")})}).array()}:{}}),s)))}),(a,s)=>T(c).length?(v(),C("section",je,[o(ke,null,{name:i(()=>[A(u(a.$t("addtnlInfo")),1)]),default:i(()=>[e("div",Re,[(v(!0),C(G,null,H(p.value,(r,_)=>(v(),C("div",{key:r.id,class:"field"},[e("div",Me,u(r.name),1),e("div",Le,[(v(),k(ue(T(Se)[r.type]),{modelValue:T(c)[_].value.value,"onUpdate:modelValue":h=>T(c)[_].value.value=h,vertical:r.type==="radio",options:(r.type==="select"||r.type==="radio")&&r.option_values,required:r.is_required,"error-message":T(c)[_].error},null,8,["modelValue","onUpdate:modelValue","vertical","options","required","error-message"]))])]))),128))])]),_:1})])):S("",!0)}}),ze=g=>(ne("data-v-c8c4e332"),g=g(),ie(),g),Oe={class:"deal-add-customer"},We={class:"fields tw-mt-5 tw-mb-5"},Ye={class:"field"},Ge={class:"name"},He={class:"value"},Ke={key:0,class:"tw-flex tw-gap-x-1 tw-mt-2"},Pe=["disabled","onClick"],Qe=ze(()=>e("span",{class:"tw-mr-1"},[e("i",{class:"fas fa-plus-circle"})],-1)),Xe={key:0,class:"form-group"},Je={class:"tw-font-bold"},Ze={key:1,class:"fields"},ea={class:"field"},aa={class:"name"},ta={class:"value"},la={class:"field"},sa={class:"name"},oa={class:"value"},na={class:"field"},ia={class:"name"},ra={class:"value"},da={class:"field"},ua={class:"name"},ca={class:"value"},va={class:"field"},ma={class:"name"},pa={class:"value"},fa=O({__name:"FormDealAddSectionCustomer",props:{initContactId:{}},emits:["updateContactId","updateContactLabel"],setup(g,{expose:D,emit:c}){const I=g,m=$(),p=$(null),a=$(!1),s=$(null),r=$(""),_=$(!1);D({createContactOrGetExistsId:W,isFetchingContacts:K(()=>{var l;return(l=m==null?void 0:m.value)==null?void 0:l.isFetchingContacts})});function h(l){var y,w;if(_.value=!1,r.value="",!l)return s.value=null,null;a.value=!1,s.value={id:l.id,name:l.name,jobtitle:l.jobtitle||"",company:l.company||"",email:((y=l.fields.find(b=>b.id==="email"))==null?void 0:y.value[0])??"",phone:((w=l.fields.find(b=>b.id==="phone"))==null?void 0:w.value[0])??""},c("updateContactId",(l==null?void 0:l.id)||null)}function N(){var l;a.value||(a.value=!0,s.value=null,(l=m.value)==null||l.clearValue(),r.value="",c("updateContactId",null))}async function W(){var b,d,t;if(_.value=!a.value&&!((b=s.value)!=null&&b.id),_.value)return null;if((d=s.value)!=null&&d.id)return s.value.id;const l=await((t=p.value)==null?void 0:t.submit());if(!l)return null;const{data:y,error:w}=l;return w.value?new Error(w.value):Number(y.value)}return(l,y)=>(v(),C("section",Oe,[e("div",We,[e("div",Ye,[e("div",Ge,u(l.$t("customer")),1),e("div",He,[o(De,{ref_key:"inputWithCustomersRef",ref:m,width:"320px",placeholder:l.$t("searchByNameEmailPhone"),"with-fields":["email","phone","company","jobtitle"],"init-contact-id":I.initContactId,disabled:!!I.initContactId,"error-message":_.value?l.$t("validation.required"):"",onUpdate:h,onClear:y[0]||(y[0]=w=>h(null))},null,8,["placeholder","init-contact-id","disabled","error-message"]),I.initContactId?S("",!0):(v(),C("div",Ke,[e("span",null,u(l.$t("or")),1),e("a",{class:"tw-font-semibold",disabled:a.value,onClick:j(N,["prevent"])},[Qe,e("span",null,u(l.$t("addNew")),1)],8,Pe)]))])])]),o(ce,{name:"fade",mode:"out-in"},{default:i(()=>{var w;return[a.value?(v(),C("div",Xe,[e("p",Je,u(l.$t("createCustomer")),1),o(Ve,{ref_key:"formContactUpdateInfoRef",ref:p},{firstFieldTitle:i(()=>[A(u(l.$t("roleInDeal")),1)]),firstFieldValue:i(()=>[o(Z,{modelValue:r.value,"onUpdate:modelValue":[y[1]||(y[1]=b=>r.value=b),y[2]||(y[2]=b=>c("updateContactLabel",b))],scope:"CLIENT",right:!1,width:"238px"},null,8,["modelValue"])]),_:1},512)])):(w=s.value)!=null&&w.id?(v(),C("div",Ze,[e("div",ea,[e("div",aa,u(l.$t("company")),1),e("div",ta,[o(q,{"model-value":s.value.company,type:"text",readonly:""},null,8,["model-value"])])]),e("div",la,[e("div",sa,u(l.$t("jobTitle")),1),e("div",oa,[o(q,{"model-value":s.value.jobtitle,type:"text",readonly:""},null,8,["model-value"])])]),e("div",na,[e("div",ia,u(l.$t("roleInDeal")),1),e("div",ra,[o(Z,{modelValue:r.value,"onUpdate:modelValue":[y[3]||(y[3]=b=>r.value=b),y[4]||(y[4]=b=>c("updateContactLabel",b))],scope:"CLIENT",right:!1,width:"320px"},null,8,["modelValue"])])]),e("div",da,[e("div",ua,u(l.$t("phone")),1),e("div",ca,[o(q,{"model-value":s.value.phone,type:"text",readonly:""},null,8,["model-value"])])]),e("div",va,[e("div",ma,u(l.$t("email")),1),e("div",pa,[o(q,{"model-value":s.value.email,type:"email",readonly:""},null,8,["model-value"])])])])):S("",!0)]}),_:1})]))}});const _a=Q(fa,[["__scopeId","data-v-c8c4e332"]]),ha={class:"select-funnel-and-stage"},ya=["onClick"],ba={class:"icon small"},ga=["onClick"],$a={class:"icon small"},wa=O({__name:"SelectFunnelAndStage",props:{funnelId:{},forceFetch:{type:Boolean}},emits:["updateStageId"],setup(g,{emit:D}){const c=g,I=ve(),m=me(I,"funnels");c.forceFetch&&!m.value.length&&I.refetch();const p=$(),a=$();return pe(()=>m.value.length,()=>{const s=m.value[0];p.value=m.value.find(r=>r.id===c.funnelId)||s,a.value=p.value.stages[0],a.value&&D("updateStageId",a.value.id)},{immediate:!0}),oe(a,s=>{s&&D("updateStageId",s.id)}),(s,r)=>(v(),C("div",ha,[!m.value.length||m.value.length>1?(v(),k(te,{key:0,class:"select-dropdown"},{body:i(({hide:_})=>[m.value.length?(v(),k(ae,{key:0},{default:i(()=>[(v(!0),C(G,null,H(m.value,h=>(v(),k(le,{key:h.id},{default:i(()=>[e("a",{onClick:j(N=>{p.value=h,a.value=h.stages[0],_()},["prevent"])},[e("div",ba,[o(B,{size:10,"disable-rounded":"","bg-color":h.color},null,8,["bg-color"])]),e("span",null,u(h.name),1)],8,ya)]),_:2},1024))),128))]),_:2},1024)):S("",!0)]),default:i(()=>[o(P,{"mobile-w-full":"","is-skeleton":!m.value.length},{icon:i(()=>[p.value?(v(),k(B,{key:p.value.id,size:10,"disable-rounded":"","bg-color":p.value.color},null,8,["bg-color"])):S("",!0)]),title:i(()=>[A(u(p.value?p.value.name:s.$t("allStages")),1)]),_:1},8,["is-skeleton"])]),_:1})):S("",!0),o(te,{class:"select-dropdown",disabled:!a.value},{body:i(({hide:_})=>[p.value?(v(),k(ae,{key:0},{default:i(()=>[(v(!0),C(G,null,H(p.value.stages,h=>(v(),k(le,{key:h.id},{default:i(()=>[e("a",{onClick:j(N=>{a.value=h,_()},["prevent"])},[e("div",$a,[o(B,{size:10,"disable-rounded":"","bg-color":h.color},null,8,["bg-color"])]),e("span",null,u(h.name),1)],8,ga)]),_:2},1024))),128))]),_:2},1024)):S("",!0)]),default:i(()=>[o(P,{"mobile-w-full":"","is-skeleton":!m.value.length},{icon:i(()=>[a.value?(v(),k(B,{key:a.value.id,size:10,"disable-rounded":"","bg-color":a.value.color},null,8,["bg-color"])):S("",!0)]),title:i(()=>[A(u(a.value?a.value.name:s.$t("allStages")),1)]),_:1},8,["is-skeleton"])]),_:1},8,["disabled"])]))}});const Ca=Q(wa,[["__scopeId","data-v-32c2d041"]]),Ia=g=>(ne("data-v-2da8e0a9"),g=g(),ie(),g),ka={class:"deal-add-main"},Sa={class:"fields"},Va={class:"field"},Da={class:"name"},Fa={class:"value"},Aa={class:"field"},Na={class:"name"},Ea={class:"value"},Ua={class:"field"},Ta={class:"name"},qa={class:"value"},Ba={class:"field"},ja={class:"name"},Ra={class:"value"},Ma={class:"field-amount-wrapper tw-max-w-[448px]"},La={key:0,class:"hint break-word"},xa=["href"],za=Ia(()=>e("i",{class:"fas fa-external-link-alt fa-sm"},null,-1)),Oa={class:"field"},Wa={class:"name"},Ya={class:"value"},Ga={class:"field"},Ha={class:"state-error-hint"},Ka=O({__name:"FormDealAdd",props:{funnelId:{},contactId:{},conversationId:{},disableNavigateToDeal:{type:Boolean},onAdded:{type:Function}},emits:["close"],setup(g,{emit:D}){const c=g,{t:I}=se(),m=fe(),p=_e(Ue),a=$({stage_id:{value:null,is_required:!0},name:{value:"",is_required:!0,validate:z.string().trim().min(1,{message:I("validation.required")})},description:{value:""},expected_date:{value:Ee().add(2,"w").format("YYYY-MM-DD")},amount:{value:""},currency_id:{value:""},contact_id:{value:Number(c.contactId)||null},contact_label:{value:""},user_contact_id:{value:x.user.id},fields:[]}),s=$(!1),r=$(""),_=$(null),h=K(()=>p.value||Ce()),N=K(()=>Ne().isEmptyCurrencies);function W(){let d=!1;return Object.entries(a.value).forEach(([,t])=>{if(t.error="",t.is_required&&t.validate)try{t.validate.parse(t.value)}catch(E){E instanceof z.ZodError&&(t.error=E.issues[0].message,d=!0)}}),d?(J(),!1):!0}async function l(){var n,L;if(s.value=!1,r.value="",!W())return null;s.value=!0;const d=await((n=_.value)==null?void 0:n.createContactOrGetExistsId());if(typeof d=="number")a.value.contact_id.value=d;else return d instanceof Error&&(r.value=d.message),s.value=!1,null;const t=new Map;Object.keys(a.value).forEach(F=>{const V=F,U=a.value[V];if(Array.isArray(U))t.set(V,U.filter(f=>f.value.value).map(f=>({field:f.value.field,value:f.value.value})));else if(U!=null&&U.value){let{value:f}=U;V==="description"&&typeof f=="string"&&(f=Ie(f),f=f.replace(/\n/g,"<br>")),t.set(V,f)}});const{data:E,response:R,error:M}=await Y("crm.deal.add",{onFetchError(F){var V;return typeof F.data=="string"&&((V=JSON.parse(F.data).error_fields)==null||V.forEach(f=>{if(f.code==="fields"){const X=a.value.fields.find(re=>re.value.field===f.field);X&&(X.error=f.description)}else f.field in a.value&&(a.value[f.field].error=f.description)}),J()),F}}).post(Object.fromEntries(t));if(s.value=!1,r.value=M.value,!r.value&&((L=R.value)!=null&&L.ok)&&E.value){const F=Number(E.value);if(!isNaN(Number(c.conversationId))){const{error:V}=await y(F,Number(c.conversationId));if(r.value=V.value,r.value)return null}return D("close"),F}return null}async function y(d,t){return await Y("crm.conversation.deal").post({deal_id:d,conversation_id:t})}function w(){we.emit("spa:navigateBack"),D("close")}async function b(d){const t=await l();t&&(typeof c.onAdded=="function"&&c.onAdded(),!d.shiftKey&&!c.disableNavigateToDeal&&m.push({name:"deal",params:{id:t},replace:!!x.webView}))}return(d,t)=>{const E=he("i18n-t");return v(),k($e,{"vertical-stretch":!0,"use-cancel-as-button-label":!0,"hide-close-icon":"",onClose:w},{header:i(()=>[A(u(d.$t("newDeal")),1)]),default:i(()=>{var R,M;return[ye(o(qe,{space:"4",class:"tw-relative tw-h-full"},{default:i(()=>[e("section",ka,[e("div",Sa,[e("div",Va,[e("div",Da,u(d.$t("title")),1),e("div",Fa,[o(ee,{modelValue:a.value.name.value,"onUpdate:modelValue":t[0]||(t[0]=n=>a.value.name.value=n),class:"field-title-textarea tw-font-bold","aria-required":"true","max-rows":10,"error-message":a.value.name.error,onKeydown:t[1]||(t[1]=n=>a.value.name.error="")},null,8,["modelValue","error-message"])])]),e("div",Aa,[e("div",Na,u(d.$t("currentStage")),1),e("div",Ea,[o(Ca,{"funnel-id":c.funnelId,"force-fetch":d.$route.meta.menuItemType==="frame",class:"tw-max-w-[448px]",onUpdateStageId:t[2]||(t[2]=n=>a.value.stage_id.value=n)},null,8,["funnel-id","force-fetch"])])]),e("div",Ua,[e("div",Ta,u(d.$t("responsible")),1),e("div",qa,[o(Fe,{contact:T(x).user,class:"tw-max-w-[448px]","hide-clear":"",onUpdate:t[3]||(t[3]=n=>a.value.user_contact_id.value=n.id)},{preview:i(({model:n,showInput:L})=>[o(P,{class:"tw-pl-1",width:"448px","mobile-w-full":"",onClick:j(L,["prevent"])},{icon:i(()=>[o(B,{size:16,url:n.userpic},null,8,["url"])]),title:i(()=>[A(u(n.name),1)]),_:2},1032,["onClick"])]),_:1},8,["contact"])])]),e("div",Ba,[e("div",ja,u(d.$t("estimatedAmount")),1),e("div",Ra,[e("div",Ma,[o(q,{modelValue:a.value.amount.value,"onUpdate:modelValue":t[4]||(t[4]=n=>a.value.amount.value=n),"fallback-type-number":h.value,"error-message":a.value.amount.error,disabled:N.value,class:"!tw-text-left",type:"number",min:"0"},null,8,["modelValue","fallback-type-number","error-message","disabled"]),o(Ae,{"model-value":a.value.currency_id.value,"error-message":a.value.currency_id.error,disabled:N.value,"onUpdate:modelValue":t[5]||(t[5]=n=>a.value.currency_id.value=n)},null,8,["model-value","error-message","disabled"])]),N.value?(v(),C("div",La,[o(E,{keypath:"currenciesNotSetUp"},{default:i(()=>[e("a",{class:ge(d.$constant.parentAppDisableRouterClass),href:`${T(x).baseUrl}settings/currencies/`,target:"_blank"},[A(u(d.$t("settingsCurrencies"))+" ",1),za],10,xa)]),_:1})])):S("",!0)])]),e("div",Oa,[e("div",Wa,u(d.$t("expectedCloseDate")),1),e("div",Ya,[o(q,{modelValue:a.value.expected_date.value,"onUpdate:modelValue":t[6]||(t[6]=n=>a.value.expected_date.value=n),type:"date",class:"!tw-w-auto","error-message":a.value.expected_date.error},null,8,["modelValue","error-message"])])]),e("div",Ga,[o(ee,{modelValue:a.value.description.value,"onUpdate:modelValue":t[7]||(t[7]=n=>a.value.description.value=n),class:"field-description-textarea",rows:"2",placeholder:d.$t("dealDescr"),"error-message":a.value.description.error,onKeydown:t[8]||(t[8]=n=>a.value.description.error="")},null,8,["modelValue","placeholder","error-message"])])])]),o(_a,{ref_key:"formDealAddSectionCustomerRef",ref:_,"init-contact-id":Number(c.contactId),class:"tw-pb-1",onUpdateContactId:t[9]||(t[9]=n=>a.value.contact_id.value=n),onUpdateContactLabel:t[10]||(t[10]=n=>a.value.contact_label.value=n)},null,8,["init-contact-id"]),o(xe,{modelValue:a.value.fields,"onUpdate:modelValue":t[11]||(t[11]=n=>a.value.fields=n),class:"tw-pb-7"},null,8,["modelValue"])]),_:1},512),[[be,!((R=_.value)!=null&&R.isFetchingContacts)]]),(M=_.value)!=null&&M.isFetchingContacts?(v(),k(Te,{key:0})):S("",!0)]}),submit:i(()=>[o(Be,{"is-fetching":s.value,class:"custom-mr-4",onClick:j(b,["prevent"])},{default:i(()=>[A(u(d.$t("create")),1)]),_:1},8,["is-fetching","onClick"])]),error:i(()=>[e("span",Ha,u(r.value),1)]),_:1})}}});const ft=Q(Ka,[["__scopeId","data-v-2da8e0a9"]]);export{ft as default};
