import{Q as se,a as U,M as P,N as re,d as W,t as ce,o as r,b,w as A,e as E,c as h,l as Y,g as N,F as R,i as o,k as F,p as T,ab as G,P as j,z as O,m as z,h as Z,v as K,ac as X,ad as de,a6 as te,ae as ne,G as I,B as me,R as pe,W as Q,n as D,f as q,H as ve,E as ye,A as ae,U as _e}from"./main-ad3d4b2a.js";import{W as fe}from"./WaDialog-48ef549a.js";import{U as oe}from"./UserPic-e76d468d.js";import{M as we,_ as he}from"./MenuList-d27c7173.js";import{D as Ve}from"./DropDown-6640089d.js";import{_ as ge}from"./InputWithUsers.vue_vue_type_script_setup_true_lang-fe28f2e3.js";import{C as H}from"./CustomColumn-d0d2dfb9.js";import{_ as ke}from"./SortableList.vue_vue_type_script_setup_true_lang-bcf551ed.js";import{_ as $e}from"./InputWithContacts.vue_vue_type_script_setup_true_lang-05c199be.js";import{F as ue}from"./FieldString-77b19497.js";import{F as L}from"./FieldSelect-fbb8732d.js";import{f as J}from"./fields-00e92370.js";import{s as le}from"./dialog-55612c15.js";const be=se("vaults",()=>{const _=U([]),{data:V,isFetching:l,error:f,isFinished:v,execute:n}=P("crm.vault.list").get().json();re(()=>{Array.isArray(V.value)&&(_.value=V.value)});function s(){v.value&&n()}return{vaults:_,isFetching:l,error:f,refetch:s}}),Ue=["disabled"],xe={key:0,class:"tw-flex tw-items-center tw-space-x-2"},Ce=["title"],Fe=o("div",null,[o("i",{class:"fas fa-caret-down"})],-1),Se={key:1},Ae=["onClick"],Me=["title"],Ee=W({__name:"SelectWithVaults",props:{modelValue:{}},emits:["update:modelValue"],setup(_,{emit:V}){const l=_,f=be(),{vaults:v,isFetching:n,error:s}=ce(f);return f.refetch(),l.modelValue||re(()=>{Array.isArray(v.value)&&V("update:modelValue",v.value[0])}),(x,$)=>(r(),b(Ve,{disabled:!!(N(n)||N(s))},{body:A(({hide:y})=>[E(we,null,{default:A(()=>[(r(!0),h(R,null,Y(N(v),w=>(r(),b(he,{key:w.id},{default:A(()=>[o("a",{onClick:T(()=>{V("update:modelValue",w),y()},["prevent"])},[E(oe,{size:20,"fa-icon":"circle","icon-color":w.color},null,8,["icon-color"]),o("span",{class:"tw-truncate",title:w.name},F(w.name),9,Me)],8,Ae)]),_:2},1024))),128))]),_:2},1024)]),default:A(()=>[o("button",{class:"button light-gray",disabled:N(n)},[l.modelValue?(r(),h("div",xe,[(r(),b(oe,{key:l.modelValue.color,size:20,"fa-icon":"circle","icon-color":l.modelValue.color},null,8,["icon-color"])),o("span",{class:"tw-truncate",title:l.modelValue.name},F(l.modelValue.name),9,Ce),Fe])):(r(),h("div",Se," error "))],8,Ue)]),_:1},8,["disabled"]))}});function ie(_){let V=JSON.stringify(G(_));const l=U(!1);j(_,()=>{l.value=V!==JSON.stringify(G(_))},{deep:!0});function f(){setTimeout(()=>{V=JSON.stringify(G(_)),l.value=!1})}return{modified:l,reset:f}}const qe={class:"wa-radio"},Ne=["checked"],Be=o("span",null,null,-1),Te={class:"wa-radio"},De=["checked"],Re=o("span",null,null,-1),je={class:"wa-radio"},ze=["checked"],Oe=o("span",null,null,-1),We={class:"tw-ml-6 tw-mt-4"},Ie=W({__name:"FormContactUpdateScope",props:{contact:{}},setup(_,{expose:V}){var y,w,g,i;const l=_,f=U((y=l.contact)==null?void 0:y.vault),v=U(((w=l.contact)==null?void 0:w.owners)||[]),n=U((g=l.contact)!=null&&g.vault?"vault":(i=l.contact)!=null&&i.owners?"owners":"all"),s=O(()=>{var c;return n.value==="owners"?{owner_id:v.value.map(t=>t.id)}:n.value==="vault"?{vault_id:(c=f.value)==null?void 0:c.id}:{vault_id:0}}),{modified:x}=ie(s);V({modified:x,submit:$});function $(c){return P(`crm.contact.access.update?id=${c}`).post(s.value)}return(c,t)=>(r(),b(H,{space:"4"},{default:A(()=>[o("div",null,F(c.$t("scopeMessage")),1),E(H,{space:"2"},{default:A(()=>[o("div",null,[o("label",{onClick:t[0]||(t[0]=m=>n.value="all")},[o("span",qe,[o("input",{type:"radio",checked:n.value==="all"},null,8,Ne),Be]),z(" "+F(c.$t("allUsers")),1)])]),o("div",null,[o("label",{class:"tw-flex tw-flex-col tw-space-y-2 md:tw-space-y-0 md:tw-flex-row md:tw-space-x-2 md:tw-items-center",onClick:t[2]||(t[2]=m=>n.value="vault")},[o("div",null,[o("span",Te,[o("input",{type:"radio",checked:n.value==="vault"},null,8,De),Re]),z(" "+F(c.$t("onlyUsersWithVault")),1)]),E(Ee,{modelValue:f.value,"onUpdate:modelValue":t[1]||(t[1]=m=>f.value=m)},null,8,["modelValue"])])]),o("div",null,[o("label",{onClick:t[3]||(t[3]=m=>n.value="owners")},[o("span",je,[o("input",{type:"radio",checked:n.value==="owners"},null,8,ze),Oe]),z(" "+F(c.$t("onlyUsers")),1)]),Z(o("div",We,[E(ge,{modelValue:v.value,"onUpdate:modelValue":t[4]||(t[4]=m=>v.value=m)},null,8,["modelValue"])],512),[[K,n.value==="owners"]])])]),_:1})]),_:1}))}}),Je={class:"tw-flex tw-space-x-2"},Pe=W({__name:"FieldBirthday",props:{modelValue:{},optionsForDaySelect:{},optionsForMonthSelect:{},errors:{}},emits:["update:modelValue"],setup(_,{emit:V}){const l=_,f=X({day:"",month:"",year:"",...Object.fromEntries(l.modelValue.map(n=>[n.field,n.value??""]))});j(f,n=>{V("update:modelValue",Object.entries(n).filter(s=>s[1]).map(s=>({field:s[0],value:s[1]})))});function v(n){if(l.errors)return l.errors.find(s=>s.field.split(".")[1]===n)}return(n,s)=>{var x,$,y;return r(),h("div",Je,[E(L,{modelValue:f.day,"onUpdate:modelValue":s[0]||(s[0]=w=>f.day=w),options:l.optionsForDaySelect,"error-message":(x=v("day"))==null?void 0:x.description,class:"tw-w-18 md:tw-w-20"},null,8,["modelValue","options","error-message"]),E(L,{modelValue:f.month,"onUpdate:modelValue":s[1]||(s[1]=w=>f.month=w),options:l.optionsForMonthSelect,"error-message":($=v("month"))==null?void 0:$.description,class:"tw-w-auto md:tw-w-36"},null,8,["modelValue","options","error-message"]),E(ue,{modelValue:f.year,"onUpdate:modelValue":s[2]||(s[2]=w=>f.year=w),"error-message":(y=v("year"))==null?void 0:y.description,type:"number",class:"tw-w-20"},null,8,["modelValue","error-message"])])}}}),He=se("regions",()=>{const _=U({});function V(l){return l in _.value||(_.value[l]=P(`crm.region.list?country=${l}`).get().json()),_.value[l]}return{regions:_,getRegionByCode:V}}),Le=W({__name:"FieldAddress",props:{modelValue:{},fields:{},errors:{}},emits:["update:modelValue"],setup(_,{emit:V}){const l=_,{getRegionByCode:f}=He(),v=U($()),n=U([]),{pause:s,resume:x}=de(v,()=>V("update:modelValue",v.value.filter(i=>i.value).map(i=>({field:i.id,value:i.value}))),{deep:!0,immediate:!0});j(()=>l.modelValue,async()=>{s(),v.value=$(),await te(),x()}),j(()=>{var i;return(i=v.value.find(c=>c.id==="country"))==null?void 0:i.value},async i=>{if(n.value=[],i){const{data:c}=await f(i);c.value&&(n.value=c.value.sort((t,m)=>+m.is_favorite-+t.is_favorite))}},{immediate:!0}),j(()=>{var i;return(i=v.value.find(c=>c.id==="country"))==null?void 0:i.value},()=>{const i=v.value.find(c=>c.id==="region");i&&(i.value="")});function $(){return l.fields.map(i=>{var c;return{...i,value:((c=l.modelValue.find(t=>t.field===i.id))==null?void 0:c.value)??""}})}async function y(i){var c;if(await te(),i.el){const t=document.createElement("option");t.innerText="──────────",t.setAttribute("disabled","disabled"),(c=i.el.querySelector("select").querySelectorAll("option")[n.value.filter(m=>m.is_favorite).length||-1])==null||c.after(t)}}const w=ne((i,c)=>c&&c.find(t=>t.field.split(".")[1]===i)),g=O(()=>i=>w(i,l.errors));return(i,c)=>(r(),b(H,{space:"2"},{default:A(()=>[(r(!0),h(R,null,Y(v.value,t=>{var m,S,B,d,u;return r(),h(R,{key:t.id},[t.id==="country"?(r(),b(L,{key:0,modelValue:t.value,"onUpdate:modelValue":e=>t.value=e,options:t.type==="select"?t.option_values:[],placeholder:t.name,"error-message":(m=g.value(t.id))==null?void 0:m.description},null,8,["modelValue","onUpdate:modelValue","options","placeholder","error-message"])):t.id==="region"?(r(),h(R,{key:1},[n.value.length?(r(),b(L,{key:n.value.length,modelValue:t.value,"onUpdate:modelValue":e=>t.value=e,options:n.value.map(e=>({id:e.code,value:e.name})),placeholder:t.name,"error-message":(S=g.value(t.id))==null?void 0:S.description,onVnodeMounted:c[0]||(c[0]=e=>y(e))},null,8,["modelValue","onUpdate:modelValue","options","placeholder","error-message"])):(r(),b(ue,{key:1,modelValue:t.value,"onUpdate:modelValue":e=>t.value=e,type:"text",placeholder:t.name,"error-message":(B=g.value(t.id))==null?void 0:B.description},null,8,["modelValue","onUpdate:modelValue","placeholder","error-message"]))],64)):t.type==="select"||t.type==="radio"?(r(),b(I(N(J)[t.type]),{key:2,modelValue:t.value,"onUpdate:modelValue":e=>t.value=e,options:t.option_values,vertical:!0,placeholder:t.name,"error-message":(d=g.value(t.id))==null?void 0:d.description},null,8,["modelValue","onUpdate:modelValue","options","placeholder","error-message"])):(r(),b(I(N(J)[t.type]),{key:3,modelValue:t.value,"onUpdate:modelValue":e=>t.value=e,placeholder:t.name,"error-message":(u=g.value(t.id))==null?void 0:u.description},null,8,["modelValue","onUpdate:modelValue","placeholder","error-message"]))],64)}),128))]),_:1}))}}),Ge={key:0},Qe={class:"toggle rounded small"},Ze={key:1,class:"tw-text-center"},Ke=o("div",{class:"spinner custom-p-16 tw-mt-6"},null,-1),Xe=[Ke],Ye={key:2},et={key:0,class:"text-yellow"},tt={class:"tw-flex-auto"},at={key:0,class:"handle tw-pt-1.5"},ot=o("i",{class:"fas fa-grip-vertical gray"},null,-1),lt=[ot],st={class:"tw-flex tw-flex-wrap tw-flex-auto tw-flex-col md:tw-flex-row tw-gap-2 tw-items-start"},rt={key:1,class:"tw-flex tw-space-x-2 tw-w-full md:tw-w-60 tw-flex-none"},nt=["onClick"],ut=o("i",{class:"fas fa-trash-alt"},null,-1),it=[ut],ct={class:"tw-w-full md:tw-w-60 tw-flex-none tw-flex tw-space-x-2"},dt={class:"tw-flex-auto"},mt=["onClick"],pt=o("i",{class:"fas fa-trash-alt"},null,-1),vt=[pt],yt={class:"tw-w-full md:tw-w-auto tw-flex tw-space-x-2 empty:tw-hidden"},_t={key:0,class:"tw-w-1/2 md:tw-w-28 tw-flex-none"},ft={key:1,class:"tw-w-1/2 md:tw-w-28"},wt=["onClick"],ht=o("i",{class:"fas fa-trash-alt"},null,-1),Vt=[ht],gt=["onClick"],kt=o("i",{class:"fas fa-plus"},null,-1),$t=W({__name:"FormContactUpdateInfo",props:{contact:{}},setup(_,{expose:V}){var B;const l=_,{t:f}=me(),v=pe(),n=!!l.contact,s=U(((B=l.contact)==null?void 0:B.details.is_company)??!1),x=U(!1),$=U(null),y=U([]),w=X({company_contact_id:n&&l.contact.main.company_contact_id?l.contact.main.company_contact_id:"",is_company:O(()=>+s.value)}),g=X({person:null,company:null}),i={person:null,company:null};V({modified:O(()=>{var d;return(d=g[s.value?"company":"person"])==null?void 0:d.modified}),submit:m});const c=ne(async d=>{const{data:u,error:e}=await P(`crm.field.list?scope=${d}`).get().json();return{fields:u.value,error:e.value}});j(s,async d=>{var a;x.value=!0;const{fields:u,error:e}=await c(d?"company":"person");if(x.value=!1,Array.isArray(u)){i[d?"person":"company"]=y.value.length?y.value:null;const C=i[d?"company":"person"];C?y.value=C:(t(u),g[d?"company":"person"]=ie(y),(a=g[d?"company":"person"])==null||a.reset())}else $.value=e,c.clear()},{immediate:!0});function t(d){if(y.value=d.map(u=>{var C;const e=(C=l.contact)==null?void 0:C.data.filter(k=>k.field===u.id);let a;if(u.type==="composite"){const k={value:[],...u.ext?{ext:u.ext[0].id}:{}};a={...u,error:[],dummy:{...k},value:Array.isArray(e)&&e.length?e.map(M=>({value:Array.isArray(M.value)?M.value:[],...u.ext?{ext:M.ext}:{}})):[{...k}]}}else{const k={value:"",...u.ext?{ext:u.ext[0].id}:{}};a={...u,error:[],dummy:{...k},value:Array.isArray(e)&&e.length?e.map(M=>({value:Array.isArray(M.value)?"":M.value,...u.ext?{ext:M.ext}:{}})):[{...k}]}}return{...a,...u.is_required?{validate:Q.object({value:Q.string().min(1,{message:f("validation.required")})}).array()}:{}}}),v.query.phone){const u=y.value.find(e=>e.id==="phone");u&&(u.value[0].value=v.query.phone.toString())}}function m(){let d;if(y.value.forEach(e=>{if(e.validate)try{e.validate.parse(e.value)}catch(a){if(a instanceof Q.ZodError){if(e.is_required&&a.errors[0]){const C=Array.isArray(e.value[0].value)?e.value[0].value[0].value:e.value[0].value;e.error=[{code:a.errors[0].code,description:a.errors[0].message,field:e.id,value:C}]}d=!0}}}),d)return setTimeout(()=>le()),null;const u=y.value.filter(e=>e.value.filter(a=>a.value&&(Array.isArray(a.value)?a.value.filter(C=>C).length:!0)).length).reduce((e,a)=>{const{value:C}=a;return e.push(...C.map(k=>({field:a.id,value:k.value,ext:k.ext}))),e},[]);return u.push(...Object.entries(w).filter(e=>e[1]!=="").map(e=>({field:e[0],value:e[1]}))),P(`crm.contact.${n?`update?id=${l.contact.id}`:"add"}`,{onFetchError(e){try{const a=JSON.parse(e.data);"error_fields"in a&&S(a.error_fields)}catch{}return e}})[n?"put":"post"](JSON.stringify(u))}function S(d){var u;for(const e of d)for(const a of e.field.split(", ")){const C=a.includes(".")?a.split(".")[0]:a,k=y.value.find(M=>M.id===C);k&&(k.type==="composite"?k.error=d:(u=k.error)==null||u.push(e))}le()}return(d,u)=>(r(),b(H,{space:"4"},{default:A(()=>[n?q("",!0):(r(),h("div",Ge,[o("div",Qe,[o("span",{class:D({selected:!s.value}),onClick:u[0]||(u[0]=e=>s.value=!1)},F(d.$t("person")),3),o("span",{class:D({selected:s.value}),onClick:u[1]||(u[1]=e=>s.value=!0)},F(d.$t("company")),3)])])),x.value?(r(),h("div",Ze,Xe)):$.value?(r(),h("div",Ye,F($.value),1)):(r(!0),h(R,{key:3},Y(y.value,e=>(r(),h("div",{key:e.id,class:"tw-flex tw-flex-col md:tw-flex-row tw-space-y-1 md:tw-space-y-0 md:tw-space-x-2"},[o("div",{class:D(["md:tw-flex-none md:tw-w-32 small gray tw-break-words",{"md:tw-pt-1.5":!["radio","checkbox"].includes(e.type)}])},[z(F(e.name),1),e.is_required?(r(),h("span",et,"*")):q("",!0)],2),o("div",tt,[E(ke,{list:e.value,"use-sort":!0,"min-length":2,onUpdate:a=>{e.value=a}},{default:A(({index:a})=>{var C,k,M,ee;return[o("div",{class:D(["tw-flex tw-space-x-2",a>0&&"bordered-top tw-pt-2"])},[e.value.length>1?(r(),h("div",at,lt)):q("",!0),o("div",st,[e.id==="birthday"&&e.type==="composite"?(r(),b(Pe,{key:0,modelValue:e.value[a].value,"onUpdate:modelValue":p=>e.value[a].value=p,"options-for-day-select":((C=e.fields.find(p=>p.id==="day"&&p.type==="select"))==null?void 0:C.option_values)||[],"options-for-month-select":((k=e.fields.find(p=>p.id==="month"&&p.type==="select"))==null?void 0:k.option_values)||[],errors:e.error},null,8,["modelValue","onUpdate:modelValue","options-for-day-select","options-for-month-select","errors"])):e.id==="address"&&e.type==="composite"?(r(),h("div",rt,[E(Le,{modelValue:e.value[a].value,"onUpdate:modelValue":p=>e.value[a].value=p,fields:e.fields,errors:e.error},null,8,["modelValue","onUpdate:modelValue","fields","errors"]),a>0?(r(),h("a",{key:0,class:"md:tw-hidden !tw-mt-1.5",onClick:T(p=>e.value.splice(a,1),["prevent"])},it,8,nt)):q("",!0)])):(r(),h(R,{key:2},[o("div",ct,[o("div",dt,[e.id==="company"&&!s.value?(r(),b($e,{key:0,"is-multiple":!1,"text-value":e.value[a].value,"is-company":!0,"on-item-select":p=>{w.company_contact_id=p.id,e.value[a].value=p.name},onInput:p=>{w.company_contact_id="",e.value[a].value=p}},null,8,["text-value","on-item-select","onInput"])):(r(),b(I(N(J)[e.type]),{key:1,modelValue:e.value[a].value,"onUpdate:modelValue":p=>e.value[a].value=p,"error-message":(ee=(M=e.error)==null?void 0:M.find(p=>p.value===e.value[a].value))==null?void 0:ee.description,options:e.type==="select"||e.type==="radio"?e.option_values:void 0,fields:e.type==="composite"?e.fields:void 0,required:e.is_required,placeholder:a>0?`${e.name} ${a+1}`:void 0,vertical:e.type==="radio"?!0:void 0},null,8,["modelValue","onUpdate:modelValue","error-message","options","fields","required","placeholder","vertical"]))]),a>0?(r(),h("a",{key:0,class:"md:tw-hidden !tw-mt-1.5",onClick:T(p=>e.value.splice(a,1),["prevent"])},vt,8,mt)):q("",!0)]),o("div",yt,[e.ext?(r(),h("div",_t,[(r(),b(I(N(J).select),{modelValue:e.value[a].ext,"onUpdate:modelValue":p=>e.value[a].ext=p,required:!0,options:[...e.ext,{id:e.ext.filter(p=>p.id===e.value[a].ext).length?"":e.value[a].ext??"",value:d.$t("other")}]},null,8,["modelValue","onUpdate:modelValue","options"]))])):q("",!0),e.ext&&!e.ext.find(p=>p.id===e.value[a].ext)?(r(),h("div",ft,[(r(),b(I(N(J).string),{modelValue:e.value[a].ext,"onUpdate:modelValue":p=>e.value[a].ext=p},null,8,["modelValue","onUpdate:modelValue"]))])):q("",!0)])],64)),a>0?(r(),h("a",{key:3,class:"tw-hidden md:tw-block !tw-mt-1.5",onClick:T(()=>{e.value.splice(a,1)},["prevent"])},Vt,8,wt)):q("",!0)])],2)]}),_:2},1032,["list","onUpdate"]),e.is_multi?(r(),h("a",{key:0,class:"button rounded outlined light-gray smaller !tw-mt-2",onClick:T(a=>e.value.push({...e.dummy}),["prevent"])},[kt,z(" "+F(d.$t("addMore")),1)],8,gt)):q("",!0)])]))),128))]),_:1}))}}),bt=["disabled","onClick"],Ut={class:"text-red"},xt={class:"tabs bordered-bottom tw-sticky tw-left-0 tw-top-0 tw-bg-waBlank tw-z-10 !tw-mb-4"},zt=W({__name:"FormContactUpdate",props:{contact:{default:void 0},initialTab:{default:"info"}},emits:["close"],setup(_,{emit:V}){const l=_,f=ve(),v=ye(),n=!!l.contact,s=U(l.initialTab),x=U(null),$=U(null),y=U(!1),w=O(()=>{var t,m;return y.value||!((t=x.value)!=null&&t.modified||n&&((m=$.value)!=null&&m.modified))}),g=U(""),i=O(()=>{var t;return typeof g.value=="object"?g.value.message.replace("Error: ",""):(t=g.value)==null?void 0:t.replace("Error: ","")});async function c(){var m,S,B,d,u,e;y.value=!0,g.value="";let t;if((m=x.value)!=null&&m.modified){const a=await((S=x.value)==null?void 0:S.submit());if((B=a==null?void 0:a.response.value)!=null&&B.ok)t=a.data.value;else{s.value="info",y.value=!1,g.value=a==null?void 0:a.error.value;return}}if((d=$.value)!=null&&d.modified&&!g.value){const a=await((e=$.value)==null?void 0:e.submit(t||((u=l.contact)==null?void 0:u.id)));if(a!=null&&a.error.value){y.value=!1,g.value=a.error.value;return}}g.value||(t?f.push({name:"contact",params:{id:t},...ae.webView?{replace:!0}:{}}):ae.webView?_e.emit("spa:navigateBack"):v.refetch()),V("close")}return(t,m)=>(r(),b(fe,{"vertical-stretch":!0,"use-cancel-as-button-label":!0,onClose:m[2]||(m[2]=S=>V("close"))},{header:A(()=>{var S;return[z(F(n?`${t.$t("editContact")} ${(S=l.contact)==null?void 0:S.main.name}`:t.$t("addContact")),1)]}),submit:A(()=>[o("button",{class:"button",disabled:w.value,onClick:T(c,["prevent"])},F(t.$t("save")),9,bt)]),error:A(()=>[o("span",Ut,F(i.value),1)]),default:A(()=>[o("div",null,[o("ul",xt,[o("li",{class:D({selected:s.value==="info"})},[o("a",{onClick:m[0]||(m[0]=T(S=>s.value="info",["prevent"]))},F(t.$t("information")),1)],2),o("li",{class:D({selected:s.value==="scope","tw-pointer-events-none tw-opacity-50":!n&&w.value})},[o("a",{onClick:m[1]||(m[1]=T(S=>s.value="scope",["prevent"]))},F(t.$t("scope")),1)],2)]),Z(o("div",null,[E($t,{ref_key:"formContactUpdateInfoRef",ref:x,contact:l.contact},null,8,["contact"])],512),[[K,s.value==="info"]]),Z(o("div",null,[E(Ie,{ref_key:"formContactUpdateScopeRef",ref:$,contact:l.contact},null,8,["contact"])],512),[[K,s.value==="scope"]])])]),_:1}))}});export{zt as _,be as u};
