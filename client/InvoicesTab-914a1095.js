import{d as L,h as m,M as S,l as g,B as n,U as T,Q as q,u as o,o as t,i as c,c as a,p as C,w as d,F as f,q as D,b,A as j,e as A,j as $,k as M,a as v,ad as z}from"./main-46836c41.js";import{v as H}from"./index-dbd22bf6.js";import{S as U}from"./SkeletonList-3dd02ff1.js";import O from"./IframeView-19d2dace.js";import{I as P}from"./IconButton-2ca5e7da.js";import{_ as Q}from"./ErrorDummy.vue_vue_type_script_setup_true_lang-98a593a7.js";import{E as G}from"./EmptyList-5f0d3ac0.js";import{C as J}from"./CustomColumn-c8c73188.js";import{H as K}from"./HistoryTabLogInvoiceSummary-d6ae2fc0.js";import"./iframeObserver-4dc3c410.js";import"./index-0f68ab4c.js";import"./dayjs-a1477631.js";const R={key:1,class:"state-error-hint"},W={key:2,class:"tw-max-w-3xl tw-mx-auto"},X=v("div",{class:"icon size-80"},[v("i",{class:"fa fa-file-invoice-dollar"})],-1),Y={key:0,class:"tw-flex tw-justify-center tw-mt-4"},Z={class:"tw-h-20"},ee={key:0,class:"tw-text-center tw-py-4"},te=v("div",{class:"spinner custom-p-16"},null,-1),ie=[te],p=30,ve=L({__name:"InvoicesTab",props:{entityType:{},entityId:{},isNew:{type:Boolean},invoiceId:{}},setup(B){var I;const s=B,u=m({[`${s.entityType}_id`]:s.entityId,sort:"create_datetime",asc:0,offset:0,limit:p}),y=m(0),r=m(null),{data:x,isFetching:_,statusCode:N,error:w,execute:h}=S(g(()=>`crm.invoice.list?${z.stringify(u.value)}`),{immediate:!1,refetch:!0}).get().json();((I=n.rights)!=null&&I.invoice||n.webView)&&!s.isNew&&!s.invoiceId&&(h(),T("InvoicesTab:refresh").on(()=>{r.value&&(r.value=null,h())}));const V=g(()=>`${n.baseUrl}invoice/`+(s.invoiceId?`${s.invoiceId}/?iframe=1`:`new/?iframe=1&${s.entityType==="deal"?"deal_id":"contact"}=${s.entityId}`));q(x,e=>{e&&("params"in e&&(y.value=e.params.total_count),"data"in e&&Array.isArray(e.data)&&(r.value=[...r.value||[],...e.data]))});function E(){u.value.offset+p>=y.value||(u.value.offset+=p)}function F(e){typeof(e==null?void 0:e.detail)=="string"&&T(`InvoicesTab:${e.detail}`).emit()}return(e,l)=>o(n).rights&&!o(n).rights.invoice||o(N)===403?(t(),c(Q,{key:0,code:403})):s.isNew||s.invoiceId?(t(),c(O,{id:"iframe-invoice",key:Date.now(),src:V.value,"force-resize":!0,"static-position":!0,onClose:l[0]||(l[0]=i=>{var k;return e.$router.push({query:{...(k=i==null?void 0:i.detail)!=null&&k.id?{id:i.detail.id}:{}}}).then(()=>F(i))})},null,8,["src"])):(t(),a(f,{key:2},[r.value?o(w)?(t(),a("div",R,C(o(w)),1)):(t(),a("div",W,[r.value.length?(t(),c(J,{key:0,space:"8"},{default:d(()=>[(t(!0),a(f,null,D(r.value,i=>(t(),c(K,{key:i.id,invoice:i,"route-location":{query:{id:i.id}},class:"invoice-wrapper"},null,8,["invoice","route-location"]))),128))]),_:1})):(t(),a(f,{key:1},[b(G,{message:e.$t(`noInvoicesBy${e.$filters.toTitleCase(s.entityType)}`)},{default:d(()=>[X]),_:1},8,["message"]),e.$route.meta.menuItemType!=="frame"?(t(),a("div",Y,[b(P,{icon:"plus",onClick:l[1]||(l[1]=A(i=>e.$router.push({query:{is_new:"1"}}),["prevent"]))},{default:d(()=>[j(C(e.$t("addInvoice")),1)]),_:1})])):$("",!0)],64)),M((t(),a("div",Z,[o(_)?(t(),a("div",ee,ie)):$("",!0)])),[[o(H),([{isIntersecting:i}])=>{i&&!o(_)&&E()}]])])):(t(),c(U,{key:0,class:"tw-max-w-3xl tw-mx-auto"}))],64))}});export{ve as default};
