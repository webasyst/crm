import{d as F,az as L,aA as Y,aB as X,l as D,I as ne,o as t,i as $,w as d,b as y,k as A,a as s,p as b,v as J,u,c as g,F as B,q as T,e as C,n as R,B as Q,ag as G,t as M,j as S,s as Z,x as ee,_ as se,J as ue,A as U,H as le,O as fe,aC as me,h as q,aD as he,D as ve,aE as ge,at as $e,aq as we,R as O,aF as ye,aG as be,a1 as ke,a0 as oe,S as K,r as de,aH as Fe,ao as Se,aI as Ce,V as Ie,m as Ve,T as De,Z as Be,aJ as xe,aK as re,aL as Re,aM as Me}from"./main-2290994d.js";import{Q as Ne,b as Pe,c as Le}from"./index-6e4a059f.js";import{U as N}from"./UserPic-f44f080b.js";import{M as j,_ as P,D as W}from"./DropDown-9065f982.js";import{D as H}from"./DropDownButton-495429ba.js";import{C as Ee,a as He}from"./ChipsList-0fe31c28.js";import{v as _e}from"./vTooltip-95186f83.js";import{_ as pe}from"./WaDialogOpener.vue_vue_type_script_setup_true_lang-41c5f744.js";import{_ as Te,a as Ue,b as Ae}from"./FormFields.vue_vue_type_script_setup_true_lang-71659d6e.js";import{D as ze}from"./DropdownModal-7cbbc57e.js";import{W as qe}from"./WaSpinner-299938a2.js";import{a as Oe,_ as Qe}from"./DealNavigateBack.vue_vue_type_script_setup_true_lang-f1507124.js";import{a as je}from"./FieldCheckbox-4d368f68.js";import{e as We}from"./emit-692c947e.js";import Ke from"./FormDealAdd-b94d94c2.js";import"./index-0b6b9def.js";import"./CustomColumn-c63128eb.js";import"./DropdownAddTags.vue_vue_type_script_setup_true_lang-02a4ee0d.js";import"./useSortable-a183a608.js";import"./WaDialogLoading.vue_vue_type_script_setup_true_lang-9395703c.js";import"./object_hash-b6864a68.js";import"./ButtonSubmit-4410c58d.js";import"./fields-7ab6f7f6.js";import"./FieldSelect-bea6b277.js";import"./FormContactUpdateInfo.vue_vue_type_script_setup_true_lang-67ac0b87.js";import"./SortableList.vue_vue_type_script_setup_true_lang-c14f94b7.js";import"./InputWithContacts.vue_vue_type_script_setup_true_lang-3e53fea1.js";import"./InputWithPerformers.vue_vue_type_script_setup_true_lang-ca873d3d.js";import"./recentContacts-a3525f5f.js";import"./dayjs-910ec40d.js";import"./TextAreaAutoresize-55461952.js";const z=(n,l)=>{if(n=String(n),l!=null&&l.includes(n))return n;const e=Number(n);return isNaN(e)?null:e},E=n=>typeof n=="string"?n:null;function Ye(n){const l=!!Object.keys(n).length;if(l)for(const e in n)n[e]=decodeURIComponent(n[e]);return{filters:(()=>{const e={};if(!l)return e;const o=E(n.funnel);o&&(e.funnel=z(o));const a=E(n.stage);a&&(e.stage=z(a,["won","lost"]));const p=E(n.tag);p&&(e.tag=z(p));const c=E(n.user_id);c&&(e.user_id=z(c));const h=E(n.pinned_only);h&&(e.pinned_only=z(h));const f=E(n.search);return f&&(e.search=f),e})(),sort:(()=>{const e={};if(!l)return e;const o=E(n.sort);o&&(e.sort=o);const a=E(n.asc);return a&&(e.asc=z(a)?1:0),e})()}}const Xe=["onClick"],Je=F({__name:"DropdownSort",setup(n){const l=["reminder_datetime","create_datetime","last_action","name","amount","user_name"],e=L(),o=Y(X(),"isKanban"),a=D(()=>[...o.value?[]:["stage_id"],...l]),p=D(()=>`sort-amount-${e.sort.asc?"up":"down"}`),c=D(()=>o.value&&!l.includes(e.sort.sort)?"reminder_datetime":e.sort.sort),h=r=>{o.value&&e.sort.sort==="stage_id"?e.updateSort({sort:r,asc:e.sort.asc?0:1}):e.toggleSort(r)},f=ne(Ne);return(r,_)=>(t(),$(W,{right:!0},{default:d(()=>[y(H,{class:"nobutton mobile:tw-px-1","mobile-w-full":!0,width:"auto",title:r.$t(`sort_${c.value}`)},{icon:d(()=>[y(N,{"fa-icon":p.value,size:14},null,8,["fa-icon"])]),default:d(()=>[A(s("span",null,b(r.$t(`sort_${c.value}`)),513),[[J,!u(f)]])]),_:1},8,["title"])]),body:d(({hide:v})=>[y(j,null,{default:d(()=>[(t(!0),g(B,null,T(a.value,m=>(t(),$(P,{key:m,selected:c.value===m},{default:d(()=>[s("a",{onClick:C(i=>{h(m),v()},["prevent"])},b(r.$t(`sort_${m}`)),9,Xe)]),_:2},1032,["selected"]))),128))]),_:2},1024)]),_:1}))}}),Ge=["onClick"],Ze=s("i",{class:"fas fa-star",style:{color:"inherit"}},null,-1),es=[Ze],ss=F({__name:"PinnedFunnelToggler",props:{modelValue:{type:Boolean},funnelId:{}},emits:["update:modelValue"],setup(n,{emit:l}){const e=n,o=async()=>{var c;const a=!e.modelValue,p={id:e.funnelId,state:a?"pin":"unpin"};(c=window.$)==null||c.post(`${Q.baseUrl}?module=funnel&action=pin`,p,h=>{h.status==="ok"&&(l("update:modelValue",a),window.document.documentElement.dispatchEvent(new Event("spa:reloadSidebar")))})};return(a,p)=>(t(),g("span",{class:R(["icon size-16",[e.modelValue?"tw-text-waAccent":"text-light-gray"]]),onClick:C(o,["stop","prevent"])},es,10,Ge))}}),ts={class:"tw-flex tw-items-center"},as={class:"tw-truncate tw-ml-0.5 tw-mr-1"},ns={key:0,class:"gray tw-ml-1 small"},ls=["onClick"],os=["onClick"],is={class:"icon"},rs={key:0,class:"gray tw-ml-1"},cs={class:"count"},us={class:"tw-mr-1"},ds=F({__name:"DropdownFunnels",props:{hideOptionAll:{type:Boolean},roundedButton:{type:Boolean}},setup(n){const l=n,e=G(),{funnels:o,selectedFunnel:a,isFetching:p}=M(e);e.fetch();const c=L(),{filterParams:h}=M(c);function f(r,_){var v;r==="all"?c.updateFilterParams({funnel:void 0,stage:void 0}):c.updateFilterParams({funnel:r,...((v=h.value)==null?void 0:v.funnel)!==r?{stage:void 0}:{}}),typeof _=="function"&&_()}return(r,_)=>(t(),$(W,null,{default:d(()=>[y(H,{rounded:l.roundedButton,"is-skeleton":u(p)&&!u(a),width:"auto","skeleton-min-width":"12rem",style:{color:"var(--text-color-stronger)"}},{icon:d(()=>[u(a)?(t(),$(N,{key:u(a).icon,size:16,"icon-class":u(a).icon,"icon-color":u(a).color},null,8,["icon-class","icon-color"])):S("",!0)]),default:d(()=>{var v;return[s("span",ts,[s("span",as,b(u(a)?u(a).name:r.$t("allFunnels")),1),(v=u(a))!=null&&v.is_archived?(t(),g("span",ns,b(r.$t("archived")),1)):S("",!0)])]}),_:1},8,["rounded","is-skeleton"])]),body:d(({hide:v})=>[y(j,null,{default:d(()=>[l.hideOptionAll?S("",!0):(t(),$(P,{key:"all"},{default:d(()=>[s("a",{onClick:C(m=>f("all",v),["prevent"])},[s("span",null,b(r.$t("allFunnels")),1)],8,ls)]),_:2},1024)),(t(!0),g(B,null,T(u(o),m=>(t(),$(P,{key:m.id},{default:d(()=>[s("a",{onClick:C(i=>f(m.id,v),["prevent"])},[s("div",is,[y(N,{size:10,"icon-class":m.icon,"icon-color":m.color},null,8,["icon-class","icon-color"])]),s("span",null,[s("span",null,b(m.name),1),m.is_archived?(t(),g("span",rs,b(r.$t("archived")),1)):S("",!0)]),s("span",cs,[s("span",us,b(m.deal_count),1),!u(Q).webView&&!m.is_archived?(t(),$(ss,{key:0,modelValue:m.is_pinned,"onUpdate:modelValue":i=>m.is_pinned=i,"funnel-id":m.id},null,8,["modelValue","onUpdate:modelValue","funnel-id"])):S("",!0)])],8,os)]),_:2},1024))),128))]),_:2},1024)]),_:1}))}}),ie=n=>(Z("data-v-295feeb8"),n=n(),ee(),n),_s={class:"filters-button"},ps={key:0},fs=ie(()=>s("i",{class:"fas fa-spinner wa-animation-spin"},null,-1)),ms=[fs],hs={key:1},vs=ie(()=>s("i",{class:"fas fa-filter"},null,-1)),gs=[vs],$s={key:0,class:"icon size-8 rounded filters-button__has"},ws=ie(()=>s("i",{class:"fas fa-circle text-red circle"},null,-1)),ys=[ws],bs=F({__name:"DealsHeaderFiltersButton",props:{modelValue:{type:Boolean},hasFilters:{type:Boolean},loading:{type:Boolean}},emits:["update:modelValue"],setup(n,{emit:l}){const e=n;return(o,a)=>(t(),g("span",_s,[s("button",{class:R(["button circle blank !tw-shadow-none",{"filters-button--active":e.modelValue}]),onClick:a[0]||(a[0]=C(p=>!e.loading&&l("update:modelValue",!e.modelValue),["prevent"]))},[e.loading?(t(),g("span",ps,ms)):(t(),g("span",hs,gs))],2),!e.loading&&e.hasFilters?(t(),g("span",$s,ys)):S("",!0)]))}});const ks=se(bs,[["__scopeId","data-v-295feeb8"]]),Fs=["onClick"],Ss={class:"tw-p-2"},Cs=["onClick"],Is={class:"tw-flex-auto tw-truncate"},Vs=F({__name:"DropdownTags",setup(n){const l=ue(),{tags:e}=M(l),o=L(),{filterParams:a,firstDeal:p}=M(o),c=D(()=>{var h,f;if(typeof a.value.tag=="number"){const r=e.value.find(_=>_.id===a.value.tag);return!r&&((f=(h=p.value)==null?void 0:h.tags)!=null&&f.length)?p.value.tags.find(_=>_.id===a.value.tag):r}});return(h,f)=>(t(),$(W,{width:"270px"},{default:d(()=>[y(H,{small:!0,highlight:!!c.value,width:"9rem"},{icon:d(()=>[y(N,{size:14,"fa-icon":"hashtag"})]),default:d(()=>[U(" "+b(c.value?c.value.name:h.$t("Tags")),1)]),_:1},8,["highlight"])]),body:d(({hide:r})=>[c.value?(t(),$(j,{key:0},{default:d(()=>[y(P,null,{default:d(()=>[s("a",{onClick:C(_=>{u(o).deleteFilterParam("tag"),r()},["prevent"])},[s("span",null,b(h.$t("showAll")),1)],8,Fs)]),_:2},1024)]),_:2},1024)):S("",!0),s("div",Ss,[y(Ee,null,{default:d(()=>[(t(!0),g(B,null,T(u(e),_=>{var v;return t(),$(He,{key:_.id+String(_.color),color:_.color,"bg-color":_.bg_color,class:R(["smaller",{selected:((v=c.value)==null?void 0:v.id)===_.id}])},{default:d(()=>[s("a",{onClick:C(m=>{u(o).updateFilterParams({tag:_.id}),r()},["prevent"])},[s("span",Is,b(_.name),1)],8,Cs)]),_:2},1032,["color","bg-color","class"])}),128))]),_:2},1024)])]),_:1}))}}),Ds=["onClick"],Bs=["onClick"],xs={class:"icon small"},Rs={class:"count"},Ms=s("hr",{class:"tw-m-0"},null,-1),Ns=["onClick"],Ps={class:"icon small"},Ls=F({__name:"DropdownStages",setup(n){const{t:l}=le(),{selectedFunnel:e}=M(G()),o=L(),{filterParams:a,firstDeal:p}=M(o),c=D(()=>{var _;return e.value&&((_=e.value.stages)!=null&&_.length)?e.value.stages:[]}),h=D(()=>c.value.length),f=D(()=>{var _,v;return[{id:"won",name:l("wons"),color:((_=e.value)==null?void 0:_.color)||"",icon:"flag-checkered"},{id:"lost",name:l("losts"),color:((v=e.value)==null?void 0:v.color)||"",icon:"ban"}]}),r=D(()=>{var _,v,m;switch(typeof((_=a.value)==null?void 0:_.stage)){case"number":if(h.value)return c.value.find(i=>i.id===a.value.stage);if((v=p.value)!=null&&v.stage)return{...(m=p.value)==null?void 0:m.stage,icon:null};break;case"string":return f.value.find(i=>i.id===a.value.stage)}});return(_,v)=>(t(),$(W,{disabled:!h.value},fe({default:d(()=>[y(H,{small:!0,disabled:!h.value,highlight:!!r.value},{icon:d(()=>[r.value?(t(),g(B,{key:0},[r.value.icon?(t(),$(N,{key:r.value.color,size:10,"fa-icon":r.value.icon,"icon-color":r.value.color},null,8,["fa-icon","icon-color"])):(t(),$(N,{key:r.value.id,size:10,"disable-rounded":"","bg-color":r.value.color},null,8,["bg-color"]))],64)):S("",!0)]),default:d(()=>[U(" "+b(r.value?r.value.name:_.$t("allStages")),1)]),_:1},8,["disabled","highlight"])]),_:2},[h.value?{name:"body",fn:d(({hide:m})=>[y(j,null,{default:d(()=>[(t(),$(P,{key:"all"},{default:d(()=>[s("a",{onClick:C(i=>{u(o).deleteFilterParam("stage"),m()},["prevent"])},[s("span",null,b(_.$t("allStages")),1)],8,Ds)]),_:2},1024)),(t(!0),g(B,null,T(c.value,i=>(t(),$(P,{key:i.id},{default:d(()=>[s("a",{onClick:C(w=>{u(o).updateFilterParams({stage:i.id}),m()},["prevent"])},[s("div",xs,[y(N,{size:10,"disable-rounded":"","bg-color":i.color},null,8,["bg-color"])]),s("span",null,b(i.name),1),s("span",Rs,b(i.deal_count),1)],8,Bs)]),_:2},1024))),128)),Ms,(t(!0),g(B,null,T(f.value,i=>(t(),$(P,{key:i.id},{default:d(()=>[s("a",{onClick:C(w=>{u(o).updateFilterParams({stage:i.id}),m()},["prevent"])},[s("div",Ps,[(t(),$(N,{key:i.color,size:10,"fa-icon":i.icon,"icon-color":i.color},null,8,["fa-icon","icon-color"]))]),s("span",null,b(i.name),1)],8,Ns)]),_:2},1024))),128))]),_:2},1024)]),key:"0"}:void 0]),1032,["disabled"]))}}),Es=s("i",{class:"fas fa-user-slash"},null,-1),Hs=s("i",{class:"fas fa-users"},null,-1),Ts=["onClick"],Us=s("div",{class:"icon"},[s("i",{class:"fas fa-users"})],-1),As=["onClick"],zs=s("div",{class:"icon"},[s("i",{class:"fas fa-user-slash"})],-1),qs=["onClick"],Os={class:"icon"},Qs={class:"count"},js=F({__name:"DropdownResponsibles",setup(n){const l=me(),{responsibles:e}=M(l),o=L(),{filterParams:a}=M(o),p=D(()=>{if(typeof a.value.user_id=="number")return l.getResponsibleById(a.value.user_id)}),c=D(()=>{var f;return((f=a.value)==null?void 0:f.user_id)===0});function h(f){f==="all"?o.deleteFilterParam("user_id"):o.updateFilterParams({user_id:f})}return(f,r)=>(t(),$(W,null,{default:d(()=>[p.value?(t(),$(H,{key:0,small:!0,highlight:!0},{icon:d(()=>[y(N,{size:16,url:p.value.responsible.userpic},null,8,["url"])]),default:d(()=>[U(" "+b(p.value.responsible.name),1)]),_:1})):c.value?(t(),$(H,{key:1,small:!0,highlight:!0},{icon:d(()=>[Es]),default:d(()=>[U(" "+b(f.$t("noResponsible")),1)]),_:1})):(t(),$(H,{key:2,small:!0},{icon:d(()=>[Hs]),default:d(()=>[U(" "+b(f.$t("allResponsibles")),1)]),_:1}))]),body:d(({hide:_})=>[y(j,null,{default:d(()=>[(t(),$(P,{key:"all"},{default:d(()=>[s("a",{onClick:C(v=>{h("all"),_()},["prevent"])},[Us,s("span",null,b(f.$t("allResponsibles")),1)],8,Ts)]),_:2},1024)),(t(),$(P,{key:0},{default:d(()=>[s("a",{onClick:C(v=>{h(0),_()},["prevent"])},[zs,s("span",null,b(f.$t("noResponsible")),1)],8,As)]),_:2},1024)),(t(!0),g(B,null,T(u(e),v=>(t(),$(P,{key:v.responsible.id},{default:d(()=>[s("a",{onClick:C(m=>{h(v.responsible.id),_()},["prevent"])},[s("div",Os,[y(N,{size:10,url:v.responsible.userpic},null,8,["url"])]),s("span",null,b(v.responsible.name),1),s("span",Qs,b(v.count),1)],8,qs)]),_:2},1024))),128))]),_:2},1024)]),_:1}))}}),te=n=>(Z("data-v-0d899fca"),n=n(),ee(),n),Ws={key:0,class:"state-with-inner-icon left"},Ks=["placeholder"],Ys={key:0,class:"icon icon-spinner"},Xs=te(()=>s("i",{class:"fas fa-spinner wa-animation-spin"},null,-1)),Js=[Xs],Gs={key:1,class:"icon icon-search"},Zs=te(()=>s("i",{class:"fas fa-search"},null,-1)),et=[Zs],st=te(()=>s("i",{class:"fas fa-times"},null,-1)),tt=[st],at=te(()=>s("span",{class:"icon"},[s("i",{class:"fas fa-search"})],-1)),nt=[at],lt=F({__name:"InputSearch",props:{modelValue:{},isFetching:{type:Boolean}},emits:["update:modelValue","close"],setup(n,{emit:l}){const e=n,o=q(),a=he(e,"modelValue");return ve(o,p=>{p.focus()}),(p,c)=>(t(),g("div",null,[u(a)!==void 0?(t(),g("div",Ws,[A(s("input",$e({ref_key:"inputEl",ref:o,"onUpdate:modelValue":c[0]||(c[0]=h=>we(a)?a.value=h:null),type:"search",class:"small",placeholder:p.$t("search")},p.$attrs),null,16,Ks),[[ge,u(a)]]),p.isFetching?(t(),g("span",Ys,Js)):(t(),g("span",Gs,et)),s("span",{class:"icon icon-close",onClick:c[1]||(c[1]=h=>{a.value=void 0,l("close")})},tt)])):(t(),g("button",{key:1,class:"button square light-gray",onClick:c[2]||(c[2]=C(h=>a.value="",["prevent"]))},nt))]))}});const ot=se(lt,[["__scopeId","data-v-0d899fca"]]),it=F({__name:"DealsHeaderSearch",setup(n){const l=L(),{onBeforeClearFilters:e,updateFilterParams:o,deleteFilterParam:a}=l,p=Y(l,"filterParams"),c=q(p.value.search);O(p,r=>{c.value=r.search});const h=ye(r=>{r=r.trim(),o({search:r})},550);e(f);function f(){c.value=void 0,a("search")}return(r,_)=>(t(),$(ot,{modelValue:c.value,"onUpdate:modelValue":_[0]||(_[0]=v=>c.value=v),onInput:_[1]||(_[1]=v=>u(h)(v.target.value)),onClose:f},null,8,["modelValue"]))}}),rt=["onClick"],ct=s("i",{class:"fas fa-star"},null,-1),ut=[ct],dt=F({__name:"DealsHeaderFavorites",setup(n){const l=L(),e=D(()=>!!l.filterParams.pinned_only);function o(){l.updateFilterParams({pinned_only:e.value?void 0:1})}return(a,p)=>(t(),g("div",null,[A((t(),g("button",{class:R(["button square",[e.value?"orange":"light-gray"]]),onClick:C(o,["prevent"])},[s("span",{class:R(["icon size-14",{"!tw-text-waBlank":e.value}])},ut,2)],10,rt)),[[u(_e),a.$t("showFavorites"),void 0,{bottom:!0}]])]))}}),_t=n=>(Z("data-v-53039755"),n=n(),ee(),n),pt={class:"deals-header__filters"},ft=_t(()=>s("i",{class:"fas fa-times-circle text-gray"},null,-1)),mt=[ft],ht={key:0,class:"skeleton deals-header__filters"},vt=F({__name:"DealsHeaderFilters",props:{hideStages:{type:Boolean},hasFilters:{type:Boolean},showSkeleton:{type:Boolean}},emits:["clear"],setup(n,{emit:l}){const e=n;return(o,a)=>(t(),g(B,null,[A(s("div",pt,[e.hideStages?S("",!0):(t(),$(Ls,{key:0})),y(js),y(Vs),y(dt),y(it),e.hasFilters?(t(),g("button",{key:1,class:"deals-header__filters-clear button small nobutton light-gray",onClick:a[0]||(a[0]=p=>l("clear"))},mt)):S("",!0)],512),[[J,!e.showSkeleton]]),e.showSkeleton?(t(),g("div",ht,[(t(),g(B,null,T(3,p=>s("span",{key:p,class:"skeleton-line deals-header__filters-skeleton"})),64))])):S("",!0)],64))}});const gt=se(vt,[["__scopeId","data-v-53039755"]]),$t=F({__name:"FormDealsListFields",setup(n){const{t:l}=le(),e=be(),{isKanban:o}=X(),a=[{id:"id",name:"ID",value:"",sort:0},{id:"amount",name:l("amount"),value:"",sort:0},{id:"user",name:l("responsible"),value:"",sort:0,hide:o},{id:"tags",name:l("tags"),value:"",sort:0},{id:"last_action",name:l("lastAction"),value:"",sort:0,hide:o}];return(p,c)=>(t(),$(Te,{scope:"deal","except-fields":[],"static-fields":a,"prepare-fetch-params":h=>({deal_funnel_columns:[{funnel_id:String(u(e).fetchParams.funnel),columns:h.map(f=>({field:f}))}]}),"sort-params-if-field-removed":{sort:"create_datetime",asc:0}},null,8,["prepare-fetch-params"]))}}),wt=n=>(Z("data-v-c404687f"),n=n(),ee(),n),yt=["title","onClick"],bt=wt(()=>s("div",{class:"icon"},[s("i",{class:"fas fa-table"})],-1)),kt={key:0,class:"tw-ml-1.5"},Ft=F({__name:"DealsHeaderFieldsButton",props:{label:{},hideLabel:{type:Boolean}},setup(n){const l=n;return(e,o)=>(t(),$(pe,{component:$t},{default:d(({open:a})=>[s("button",{class:"deals-form-fields-button button light-gray square",title:l.label,onClick:C(a,["prevent"])},[bt,l.hideLabel?S("",!0):(t(),g("span",kt,b(l.label),1))],8,yt)]),_:1}))}});const St=se(Ft,[["__scopeId","data-v-c404687f"]]),Ct=["disabled","onClick"],It={class:"tw-flex tw-items-center tw-gap-2"},Vt={class:"icon"},Dt=F({__name:"ActionButtonList",props:{items:{},space:{}},setup(n){const l=n;return(e,o)=>(t(),g("div",{class:R(`tw-flex tw-gap-${l.space||0}`)},[(t(!0),g(B,null,T(l.items,(a,p)=>(t(),g(B,{key:p},[a.hide?S("",!0):(t(),g("button",{key:0,disabled:a.disableClick,class:"light-gray",onClick:c=>!a.disableClick&&a.clickHandler()},[s("div",It,[s("span",Vt,[s("i",{class:R(["fas",a.classIcon])},null,2)]),s("span",null,b(a.label),1)])],8,Ct))],64))),128))],2))}}),Bt=["src"],xt=F({__name:"FormDealExportCSV",props:{ids:{}},setup(n){const l=n,e=q(!0),o={height:"400px",width:"100%"};return(a,p)=>(t(),$(ke,{"hide-buttons":!0},{default:d(()=>[e.value?(t(),$(qe,{key:0,style:o})):S("",!0),A(s("iframe",{src:`${u(Q).baseUrl}?module=deal&action=export&ids=${l.ids.join(",")}`,style:o,frameborder:"0",onLoad:p[0]||(p[0]=c=>e.value=!1)},null,40,Bt),[[J,!e.value]])]),_:1}))}}),Rt={class:"deals-header__edit small"},Mt={class:"deals-header__edit-selected-deals"},Nt={class:"tw-hidden xl:tw-inline-block tw-mr-2"},Pt={class:"badge user tw-bg-waAccent tw-min-w-[0.5rem] tw-justify-center"},Lt={class:"deals-header__edit-buttons"},Et=s("span",{class:"icon"},[s("i",{class:"fas fa-times-circle"})],-1),Ht={class:"tw-hidden xl:tw-inline-block tw-ml-2"},Tt=F({__name:"DealsHeaderBulkEdit",setup(n){var v;const l=oe(),{t:e}=le(),o=L(),{countChecked:a,isAllChecked:p,bulkSelectIds:c}=M(o),h=ne(Pe),f=q(p.value?"1":""),r=q([...(v=Q.rights)!=null&&v.export?[{label:e("export"),classIcon:"fas fa-download",clickHandler:()=>{K(xt,{ids:c.value}).show()}}]:[],{label:e("merge"),classIcon:"fas fa-users",hide:!0,clickHandler:()=>l.push({name:"dealMerge",query:{ids:c.value.join(",")}})},{label:e("changeResponsible"),classIcon:"fas fa-user-check",hide:!0,clickHandler:()=>({})},{label:e("changeFunnelOrStage"),classIcon:"fas fa-exchange-alt",hide:!0,clickHandler:()=>({})},{label:e("addTags"),classIcon:"fas fa-hashtag",clickHandler:()=>K(Ue,{entityType:"deal",entityIds:c.value}).show()},{label:e("removeTags"),classIcon:"fas fa-hashtag",clickHandler:()=>K(Ae,{entityType:"deal",entityIds:c.value}).show()},{label:e("close"),classIcon:"fas fa-flag-checkered",hide:!0,clickHandler:()=>({})},{label:e("delete"),classIcon:"fas fa-trash-alt text-red",clickHandler:()=>K(Oe,{ids:c.value,isBulkMode:!0}).show()}]);O(a,m=>{r.value[1].hide=m<2},{immediate:!0}),O(p,m=>{m?f.value="1":f.value="",(a.value===0||m)&&_(m)});function _(m){o.toggleChecked(m)}return(m,i)=>(t(),g("div",Rt,[s("div",Mt,[y(je,{modelValue:f.value,"onUpdate:modelValue":i[0]||(i[0]=w=>f.value=w),size:16,onChange:i[1]||(i[1]=w=>_(!!w))},{default:d(()=>[s("span",Nt,b(m.$t("selected")),1),s("span",Pt,b(u(a)),1)]),_:1},8,["modelValue"])]),s("div",Lt,[u(h)?(t(),$(ze,{key:0,items:r.value},{default:d(()=>[y(H,{width:"8rem"},{default:d(()=>[U(b(m.$t("actions")),1)]),_:1})]),_:1},8,["items"])):(t(),$(Dt,{key:1,class:"deals-header__edit-actions",items:r.value,space:"2"},null,8,["items"])),s("button",{type:"button",class:"button outlined gray small",onClick:i[2]||(i[2]=C(w=>_(!1),["prevent"]))},[Et,s("span",Ht,b(m.$t("cancel")),1)])])]))}});const ce=F({__name:"ToggleListItem",props:{modelValue:{},value:{}},emits:["update:modelValue"],setup(n,{emit:l}){return(e,o)=>(t(),g("span",{class:R({selected:e.modelValue===e.value}),onClick:o[0]||(o[0]=a=>l("update:modelValue",e.value))},[de(e.$slots,"default")],2))}}),Ut=F({__name:"ToggleList",props:{size:{},rounded:{type:Boolean}},setup(n){const l=n;return(e,o)=>(t(),g("div",{class:R(["toggle",l.size,l.rounded?"rounded":""])},[de(e.$slots,"default")],2))}}),At={class:"deals-header"},zt={class:"deals-header__inner"},qt={key:0,class:"deals-header__heading--native"},Ot={key:1,class:"deals-header__heading--web"},Qt={key:0,class:"skeleton h1 md:tw-w-64 !tw-my-2"},jt=s("span",{class:"skeleton-line !tw-h-7 mobile:!tw-h-6"},null,-1),Wt=[jt],Kt={class:"deals-header__left-buttons tw-space-x-4 tw-mr-4"},Yt=["title","onClick","onVnodeMounted"],Xt=s("i",{class:"fas fa-plus"},null,-1),Jt=[Xt],Gt=s("i",{class:"fas fa-columns"},null,-1),Zt=s("i",{class:"fas fa-list-ul"},null,-1),ea={class:"deals-header__all-filters tw-flex tw-items-center tw-flex-auto tw-min-w-0 tw-flex-wrap mobile:tw-w-full mobile:tw-contents"},sa={class:"tw-flex-auto tw-flex tw-flex-wrap tw-min-w-0"},ta={class:"tw-ml-auto mobile:tw-ml-1 tw-flex tw-items-center tw-flex-nowrap tw-gap-1"},aa=F({__name:"DealsHeader",setup(n){const l=ne(Le),e=L(),{hasFilters:o,countChecked:a,isSingleFunnelMode:p}=M(e),c=X(),{currentView:h,isKanban:f}=M(c),r=G();r.fetch();const _=oe(),v=q(!1),m=_.currentRoute.value.path==="/deal/new/",i=D(()=>{var k;return!!((k=r.selectedFunnel)!=null&&k.is_archived)});function w(k){c.switchViewMode(k),_.push({name:Fe[k],query:_.currentRoute.value.query}).then(()=>e.forceUpdate())}return(k,I)=>{var V;return t(),g("div",At,[u(a)?(t(),$(Tt,{key:0})):S("",!0),A(s("div",zt,[u(Q).webView?(t(),g("div",qt,[y(Qe)])):(t(),g("div",Ot,[u(p)?(t(),g(B,{key:0},[u(r).isFetching?(t(),g("div",Qt,Wt)):(V=u(r).selectedFunnel)!=null&&V.name?A((t(),g("h1",{key:u(r).selectedFunnel.name,class:"h1"},[U(b(u(r).selectedFunnel.name),1)])),[[u(_e),u(r).selectedFunnel.name,void 0,{top:!0}]]):S("",!0)],64)):(t(),$(ds,{key:1,"hide-option-all":u(f),"rounded-button":!0,class:"tw-mr-4"},null,8,["hide-option-all"])),s("div",Kt,[y(pe,{component:Ke,"component-props":{funnelId:u(e).filterParams.funnel,...m&&k.$route.query.contact?{contactId:k.$route.query.contact}:{},onAdded:u(We)}},{default:d(({open:x})=>[s("button",{title:i.value?k.$t("archivedFunnelIsNotAvailableForDealCreation"):k.$t("newDeal"),class:R(["circle",{"tw-opacity-40 tw-cursor-default":i.value}]),onClick:C(ae=>!i.value&&x(),["prevent"]),onVnodeMounted:ae=>!i.value&&m&&x()},Jt,10,Yt)]),_:1},8,["component-props"]),u(h)?(t(),$(Ut,{key:0,rounded:""},{default:d(()=>[y(ce,{"model-value":u(h),value:"kanban","onUpdate:modelValue":I[0]||(I[0]=x=>w(x))},{default:d(()=>[Gt]),_:1},8,["model-value"]),y(ce,{"model-value":u(h),value:"list","onUpdate:modelValue":I[1]||(I[1]=x=>w(x))},{default:d(()=>[Zt]),_:1},8,["model-value"])]),_:1})):S("",!0)])])),s("div",ea,[s("div",{class:R(["deals-header__filters-container",{"deals-header__filters-container--hide":!v.value}])},[y(gt,{"has-filters":u(o),"hide-stages":u(f),"show-skeleton":!u(e).filtersIsLoaded,onClear:u(e).clearFilters},null,8,["has-filters","hide-stages","show-skeleton","onClear"])],2),s("div",sa,[y(ks,{modelValue:v.value,"onUpdate:modelValue":I[2]||(I[2]=x=>v.value=x),class:"deals-header__filters-button tw-hidden","has-filters":u(o),loading:!u(e).filtersIsLoaded},null,8,["modelValue","has-filters","loading"]),s("div",ta,[u(r).selectedFunnel&&!u(l)?(t(),$(St,{key:0,label:k.$t(u(f)?"customizeFields":"customizeColumns"),"hide-label":u(f)},null,8,["label","hide-label"])):S("",!0),u(l)||u(f)?(t(),$(Je,{key:1})):S("",!0)])])])],512),[[J,!u(a)]])])}}});const na={class:"deals blank box contentbox"},La=F({__name:"DealsView",props:{routeName:{},routeQuery:{}},setup(n){const l=n,e=oe(),o=L(),a=X(),p=ue(),c=Y(o,"isSingleFunnelMode"),h=Y(G(),"funnels");let f=c.value;o.updateIsSingleFunnelMode(),console.log("first loading",l.routeName),e.currentRoute.value.path!=="/deal/new/"&&(e.replace({name:r(l.routeName),query:l.routeQuery}),_(l.routeQuery).then(i=>{const w={...l.routeQuery};i&&(w.funnel=String(i)),console.log("first loading:query",w),m(w)})),Se(()=>{p.refetchIfHasChanges()}),O([()=>o.filterParams,()=>o.sort],async([i,w])=>{console.log("watch:filterParams",w),await v({...xe(i),...w.sort===re.sort&&w.asc===re.asc?{}:w})},{deep:!0}),Ce((i,w,k)=>{if(console.log("onBeforeRouteUpdate",{to:i,from:w}),("all_funnels"in i.query||"funnel"in i.query)&&(f=c.value,o.updateIsSingleFunnelMode(i.query.all_funnels!=="1")),i.name==="deals"){if(w.query.all_funnels!=="1"&&i.query.funnel&&i.query.funnel===w.query.funnel||w.query.all_funnels==="1"&&i.query.all_funnels==="1"){o.reloadList();return}r(i.name),m(i.query);return}else i.name!==w.name&&r(i.name);k()}),Ie(Re).on(o.reloadList);function r(i){return c.value?a.switchViewModeWithLocalStorage(i):a.switchViewModeWithAppState(i)}async function _({funnel:i}){return new Promise(w=>{const k=I=>{var x;let V=null;i&&!isNaN(Number(i))&&(V=parseInt(i)),I.find(ae=>ae.id===V)||(V=((x=o.currentFiltersStorage.deal_list_filter)==null?void 0:x.funnel_id)||null),c.value&&!V&&I[0]&&(V=I[0].id),w(V)};if(h.value.length)k(h.value);else{const I=O(h,V=>{k(V),I()})}})}async function v(i){const w={};for(const[I,V]of Object.entries(i))Me.includes(I)&&V!=null&&(w[I]=encodeURIComponent(String(V)));c.value||(w.all_funnels="1");const k=a.currentViewName;return console.log("updateFiltersInURL:name",k),await e.replace({name:k,query:w})}function m(i){const{filters:w,sort:k}=Ye(i);console.log("isSingleFunnelMode",c.value),console.log("previousIsSingleFunnelMode",f),console.log("filters:",w),console.log("sort:",k),o.updateFilterParamsFromQuery(w,k)}return(i,w)=>{const k=Ve("router-view");return t(),g("div",na,[y(aa),y(k,null,{default:d(({Component:I})=>[y(De,{name:"fade",mode:"out-in"},{default:d(()=>[(t(),$(Be(I)))]),_:2},1024)]),_:1})])}}});export{La as default};
