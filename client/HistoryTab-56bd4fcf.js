import{d as w,a1 as X,a as P,j as J,o as a,c as u,e as $,w as r,i as o,n as h,r as B,m as j,k as n,p as T,f as g,g as m,F as E,l as F,h as O,v as U,_ as z,b as v,H as x,B as W,a2 as ae,a3 as K,X as oe,a4 as t,a5 as ie,A as Z,R as re,a6 as ce,a7 as de,P as ue,a8 as _e,a9 as q}from"./main-14ee4927.js";import{v as me}from"./index-927b8924.js";import{S as ge}from"./SkeletonList-eb58974a.js";import{E as pe}from"./EmptyList-32476ed0.js";import{C as I}from"./CustomColumn-9af7d856.js";import{U as V}from"./UserPic-88a434b2.js";import{d as S}from"./dayjs-733f6bc6.js";import{H as ye}from"./HistoryTabLogInvoiceSummary-fad9117b.js";import{d as fe}from"./downloadFile-07c60fdd.js";const he={class:"tw-flex-auto black bold"},$e=o("div",null,null,-1),ve={class:"tw-flex-auto tw-text-sm"},be={key:0},we=["href","onClick"],ke=o("span",{class:"icon size-12 baseline tw-mr-2"},[o("i",{class:"fas fa-flag"})],-1),Ce={class:"tw-whitespace-normal"},Te={key:1,class:"tw-flex tw-gap-1.5"},Le=["href","onClick"],Ie={class:"gray"},Ee={class:"tw-flex-auto"},Se={class:"tw-flex-auto tw-text-sm"},Re=w({__name:"HistoryTabLog",props:{icon:{},title:{},title2:{},date:{},children:{},deal:{},contact:{}},setup(y){const e=y,d=X("entityType"),l=P(!1);return(s,_)=>{const i=J("RouterLink");return a(),u("div",{class:h(s.$style.log)},[$(I,{space:"2"},{default:r(()=>[o("div",{class:h([s.$style.logRow,"tw-items-center"])},[o("div",null,[$(V,{url:s.icon.url,"bg-color":s.icon.color,"fa-icon":s.icon.fa||s.icon.fab,"fa-icon-style":s.icon.fab?"fab":"fas",size:32,"disable-rounded":!!s.icon.url},null,8,["url","bg-color","fa-icon","fa-icon-style","disable-rounded"])]),o("div",he,[B(s.$slots,"header",{},()=>[j(n(e.title),1)])])],2),o("div",{class:h(s.$style.logRow)},[$e,o("div",ve,[$(I,{space:"2"},{default:r(()=>[B(s.$slots,"summary"),e.deal?(a(),u("div",be,[$(i,{to:{name:"deal",params:{id:e.deal.id}},custom:""},{default:r(({href:c,navigate:p})=>[o("a",{href:c,class:h([s.$constant.parentAppDisableRouterClass,"tw-whitespace-nowrap"]),onClick:T(f=>s.$route.meta.menuItemType!=="frame"&&p(f),["stop"])},[ke,o("span",Ce,n(e.deal.name),1)],10,we)]),_:1},8,["to"])])):g("",!0),m(d)==="live"&&e.contact?(a(),u("div",Te,[$(V,{url:e.contact.userpic,size:20},null,8,["url"]),$(i,{to:{name:"contact",params:{id:e.contact.id}},custom:""},{default:r(({href:c,navigate:p})=>[o("a",{href:c,class:h([s.$constant.parentAppDisableRouterClass,"tw-line-clamp-2 tw-self-center"]),onClick:T(f=>s.$route.meta.menuItemType!=="frame"&&p(f),["stop"])},n(e.contact.name),11,Le)]),_:1},8,["to"])])):g("",!0),o("div",Ie,n(m(S)(e.date).format("HH:mm"))+" "+n(e.title2),1)]),_:3})])],2),l.value&&Array.isArray(e.children)?(a(!0),u(E,{key:0},F(e.children,c=>(a(),u("div",{key:c.id},[o("div",{class:h([s.$style.logRow,"tw-items-start"])},[o("div",null,[o("div",{class:h([s.$style.pointer,"tw-translate-y-2"])},null,2)]),o("div",Ee,[B(s.$slots,"children",{child:c})])],2)]))),128)):g("",!0),typeof e.children=="number"&&e.children>1||Array.isArray(e.children)&&e.children.length?(a(),u("div",{key:1,class:h(s.$style.logRow)},[o("div",null,[O(o("div",{class:h(s.$style.pointer)},null,2),[[U,!l.value]])]),o("div",Se,[B(s.$slots,"counter",{showChildren:l.value,click:()=>l.value=!l.value})])],2)):g("",!0)]),_:3})],2)}}}),De="_log_vip2u_1",He="_logRow_vip2u_13",je="_pointer_vip2u_24",Ae={log:De,logRow:He,pointer:je},Ne={$style:Ae},D=z(Re,[["__cssModules",Ne]]),Me={key:0,class:"tw-line-clamp-2"},Oe=o("i",{class:"fas fa-ellipsis-h gray"},null,-1),Pe=w({__name:"HistoryTabLogReminder",props:{log:{},children:{}},setup(y){const e=y;return(d,l)=>{var s;return a(),v(D,{title:d.$filters.toTitleCase(e.log.action_name),text:(s=d.log.reminder)==null?void 0:s.content,date:e.log.create_datetime,icon:e.log.icon,children:e.children,contact:e.log.contact,deal:e.log.deal},{summary:r(()=>[e.log.reminder?(a(),u("div",Me,n(e.log.reminder.content),1)):g("",!0)]),counter:r(()=>[]),menu:r(()=>[Oe]),_:1},8,["title","text","date","icon","children","contact","deal"])}}}),Fe={key:0},ze=["onClick"],xe={class:"gray tw-text-sm"},Be=o("i",{class:"fas fa-ellipsis-h gray"},null,-1),Ue=w({__name:"HistoryTabLogOrder",props:{log:{},children:{}},setup(y){const e=y;return(d,l)=>{var s;return a(),v(D,{title:d.$filters.toTitleCase(e.log.action_name),title2:(s=e.log.actor)==null?void 0:s.name,date:e.log.create_datetime,icon:e.log.icon,children:e.children,contact:e.log.contact,deal:e.log.deal},{summary:r(()=>[$(I,{space:"2"},{default:r(()=>[e.log.order?(a(),u("div",Fe,[j(n(d.$t("order"))+" "+n(e.log.order.number)+" ",1),o("strong",null,n(d.$filters.toCurrency(e.log.order.total,e.log.order.currency)),1)])):g("",!0),e.log.content?(a(),u("div",{key:1,class:h(d.$style.comment)},n(e.log.content),3)):g("",!0)]),_:1})]),counter:r(({click:_,showChildren:i})=>[o("a",{onClick:T(_,["prevent"])},n(i?d.$t("collapse"):`+${d.$t("events",e.children.length)}`),9,ze)]),children:r(({child:_})=>[$(I,{space:"2"},{default:r(()=>{var i;return[o("div",null,n(d.$filters.toTitleCase(_.action_name)),1),_.content?(a(),u("div",{key:0,class:h(d.$style.comment)},n(_.content),3)):g("",!0),o("div",xe,n(m(S)(_.create_datetime).format("HH:mm"))+" "+n((i=_.actor)==null?void 0:i.name),1)]}),_:2},1024)]),menu:r(()=>[Be]),_:1},8,["title","title2","date","icon","children","contact","deal"])}}}),Ve="_comment_1wsv4_1",Ge={comment:Ve},Ye={$style:Ge},qe=z(Ue,[["__cssModules",Ye]]),Ke=["onClick"],Xe={class:"gray tw-text-sm"},Je=o("i",{class:"fas fa-ellipsis-h gray"},null,-1),Qe=w({__name:"HistoryTabLogNote",props:{log:{},children:{}},setup(y){const e=y,{t:d}=x();return(l,s)=>{var _;return a(),v(D,{title:l.$filters.toTitleCase(e.log.action_name),title2:(_=e.log.actor)==null?void 0:_.name,date:e.log.create_datetime,icon:e.log.icon,children:e.children,contact:e.log.contact,deal:e.log.deal},{summary:r(()=>[e.log.content?(a(),u("div",{key:0,class:h(l.$style.note)},n(e.log.content),3)):g("",!0)]),counter:r(({click:i,showChildren:c})=>[o("a",{onClick:T(i,["prevent"])},n(c?m(d)("collapse"):`+${m(d)("events",e.children.length)}`),9,Ke)]),children:r(({child:i})=>[$(I,{space:"2"},{default:r(()=>{var c;return[o("div",null,n(l.$filters.toTitleCase(i.action_name)),1),o("div",Xe,n(m(S)(i.create_datetime).format("HH:mm"))+" "+n((c=i.actor)==null?void 0:c.name),1)]}),_:2},1024)]),menu:r(()=>[Je]),_:1},8,["title","title2","date","icon","children","contact","deal"])}}}),We="_note_15hyk_1",Ze={note:We},et={$style:Ze},tt=z(Qe,[["__cssModules",et]]),ot={key:0},st={key:0,class:"bold tw-mb-2"},nt={class:"tw-line-clamp-2"},lt={class:"tw-flex tw-items-center tw-space-x-2"},at=["href"],it=o("i",{class:"fas fa-ellipsis-h gray"},null,-1),rt=w({__name:"HistoryTabLogMessage",props:{log:{},children:{}},setup(y){const e=y,d=X("entityType");return(l,s)=>{var i,c;const _=J("RouterLink");return a(),v(D,{title:((i=e.log.actor)==null?void 0:i.name)||l.$t("noName"),date:e.log.create_datetime,icon:e.log.icon,children:(c=e.log.message)==null?void 0:c.conversation_count,contact:e.log.contact,deal:e.log.deal},{summary:r(()=>{var p,f;return[(p=e.log.message)!=null&&p.body_plain?(a(),u("div",ot,[o("div",{class:h(l.$style.baloon)},[e.log.message.subject?(a(),u("div",st,n(e.log.message.subject),1)):g("",!0),o("div",nt,n(e.log.message.body_plain),1)],2),(((f=e.log.message)==null?void 0:f.conversation_count)??0)>1?(a(),u(E,{key:0},[o("div",{class:h(l.$style.baloonShadow1)},null,2),o("div",{class:h(l.$style.baloonShadow2)},null,2)],64)):g("",!0)])):g("",!0)]}),counter:r(()=>{var p,f;return[o("div",lt,[o("div",{class:h(l.$style.userPics)},[(a(!0),u(E,null,F((p=e.log.message)==null?void 0:p.conversation_participants,R=>(a(),v(V,{key:R.id,size:32,url:R.userpic},null,8,["url"]))),128))],2),(f=e.log.message)!=null&&f.conversation_id?(a(),u(E,{key:0},[l.$route.meta.menuItemType==="frame"?(a(),u("a",{key:0,href:`${m(W).baseUrl}message/conversation/${e.log.message.conversation_id}/?view=chat`,class:h(l.$constant.parentAppDisableRouterClass)},n(`+${l.$t("messages",(e.log.message.conversation_count??1)-1)}`),11,at)):m(W).webView?(a(),u("a",{key:2,onClick:s[0]||(s[0]=T(R=>m(ae).emit("spa:navigateTo",{name:"conversation",id:e.log.message.conversation_id}),["prevent"]))},n(`+${l.$t("messages",(e.log.message.conversation_count??1)-1)}`),1)):(a(),v(_,{key:1,to:{name:`${m(d)}MessagesTab`,query:{conversationId:e.log.message.conversation_id}},class:h(l.$constant.parentAppDisableRouterClass)},{default:r(()=>[j(n(`+${l.$t("messages",(e.log.message.conversation_count??1)-1)}`),1)]),_:1},8,["to","class"]))],64)):g("",!0)])]}),children:r(({child:p})=>[j(n(p.action_name),1)]),menu:r(()=>[it]),_:1},8,["title","date","icon","children","contact","deal"])}}}),ct="_userPics_1h7lu_1",dt="_baloon_1h7lu_8",ut="_baloonShadow1_1h7lu_16",_t="_baloonShadow2_1h7lu_24",mt={userPics:ct,baloon:dt,baloonShadow1:ut,baloonShadow2:_t},gt={$style:mt},pt=z(rt,[["__cssModules",gt]]),yt=["onClick"],ft={class:"tw-text-sm gray"},ht=o("i",{class:"fas fa-ellipsis-h gray"},null,-1),$t=w({__name:"HistoryTabLogInvoice",props:{log:{},children:{}},setup(y){const e=y,{t:d}=x();return(l,s)=>{var _;return a(),v(D,{title:l.$filters.toTitleCase(e.log.action_name),title2:(_=e.log.actor)==null?void 0:_.name,date:e.log.create_datetime,icon:e.log.icon,children:e.children,contact:e.log.contact,deal:e.log.deal},{summary:r(()=>[$(ye,{invoice:e.log.invoice},null,8,["invoice"])]),counter:r(({click:i,showChildren:c})=>[o("a",{onClick:T(i,["prevent"])},n(c?m(d)("collapse"):`+${m(d)("events",e.children.length)}`),9,yt)]),children:r(({child:i})=>[$(I,{space:"2"},{default:r(()=>{var c;return[o("div",null,n(l.$filters.toTitleCase(i.action_name)),1),o("div",ft,n(m(S)(i.create_datetime).format("HH:mm"))+" "+n((c=i.actor)==null?void 0:c.name),1)]}),_:2},1024)]),menu:r(()=>[ht]),_:1},8,["title","title2","date","icon","children","contact","deal"])}}}),vt={key:0},bt=["href"],wt={class:"gray small"},kt=["onClick"],Ct={class:"gray tw-text-sm"},Tt=o("i",{class:"fas fa-ellipsis-h gray"},null,-1),Lt=w({__name:"HistoryTabLogFile",props:{log:{},children:{}},setup(y){const e=y,{t:d}=x();return(l,s)=>{var _;return a(),v(D,{title:l.$filters.toTitleCase(e.log.action_name),title2:(_=e.log.actor)==null?void 0:_.name,date:e.log.create_datetime,icon:e.log.icon,children:e.children,contact:e.log.contact,deal:e.log.deal},{summary:r(()=>[e.log.file?(a(),u("div",vt,[o("a",{href:e.log.file.url,class:h(l.$constant.parentAppDisableRouterClass),onClick:s[0]||(s[0]=T(i=>m(fe)(e.log.file.url,e.log.file.id,e.log.file.name),["prevent"]))},n(e.log.file.name),11,bt),j("  "),o("span",wt,n(e.log.file.size)+" KB",1)])):g("",!0)]),counter:r(({click:i,showChildren:c})=>[o("a",{onClick:T(i,["prevent"])},n(c?m(d)("collapse"):`+${m(d)("events",e.children.length)}`),9,kt)]),children:r(({child:i})=>[$(I,{space:"2"},{default:r(()=>{var c;return[o("div",null,n(l.$filters.toTitleCase(i.action_name)),1),o("div",Ct,n(m(S)(i.create_datetime).format("HH:mm"))+" "+n((c=i.actor)==null?void 0:c.name),1)]}),_:2},1024)]),menu:r(()=>[Tt]),_:1},8,["title","title2","date","icon","children","contact","deal"])}}}),It={key:0,class:"tw-flex tw-space-x-2 tw-items-center"},Et={key:0,class:"tw-line-through gray"},St={key:1,class:"gray"},Rt={key:2},Dt={key:1,class:"tw-flex tw-space-x-2 tw-items-center"},Ht={key:0,class:"log-deal-badge"},jt={class:"icon size-12 rounded"},At={class:"log-deal-badge__text"},Nt={key:1,class:"gray"},Mt={key:2,class:"log-deal-badge"},Ot={class:"icon size-12 rounded"},Pt={class:"log-deal-badge__text"},Ft=w({__name:"HistoryTabLogDealSummary",props:{log:{}},setup(y){const e=y;return(d,l)=>(a(),u(E,null,[e.log.before||e.log.after?(a(),u("div",It,[e.log.before?(a(),u("div",Et,n(e.log.before),1)):g("",!0),e.log.before&&e.log.after?(a(),u("span",St,"→")):g("",!0),e.log.after?(a(),u("div",Rt,n(e.log.after),1)):g("",!0)])):g("",!0),e.log.stage_before||e.log.stage_after?(a(),u("div",Dt,[e.log.stage_before?(a(),u("div",Ht,[o("span",jt,[o("i",{class:"fas fa-circle circle",style:K({color:e.log.stage_before.color})},null,4)]),o("span",At,n(e.log.stage_before.name),1)])):g("",!0),e.log.stage_before&&e.log.stage_after?(a(),u("span",Nt,"→")):g("",!0),e.log.stage_after?(a(),u("div",Mt,[o("span",Ot,[o("i",{class:"fas fa-circle circle",style:K({color:e.log.stage_after.color})},null,4)]),o("span",Pt,n(e.log.stage_after.name),1)])):g("",!0)])):g("",!0)],64))}});const ee=z(Ft,[["__scopeId","data-v-df4a6a10"]]),zt=["href","onClick"],xt=["onClick"],Bt={class:"tw-text-sm empty:tw-hidden"},Ut={class:"gray tw-text-sm"},Vt=o("i",{class:"fas fa-ellipsis-h gray"},null,-1),Gt=w({__name:"HistoryTabLogDeal",props:{log:{},children:{}},setup(y){const e=y,d=X("entityType");return(l,s)=>{var i;const _=J("RouterLink");return a(),v(D,{title:l.$filters.toTitleCase(e.log.action_name),title2:(i=e.log.actor)==null?void 0:i.name,date:e.log.create_datetime,icon:e.log.icon,children:e.children},{header:r(()=>[j(n(l.$filters.toTitleCase(e.log.action_name))+" ",1),["contact","live"].includes(m(d))?(a(),u(E,{key:0},[e.log.deal?(a(),v(_,{key:0,to:{name:"deal",params:{id:e.log.deal.id}},custom:""},{default:r(({href:c,navigate:p})=>[o("a",{href:c,class:h(l.$constant.parentAppDisableRouterClass),onClick:T(f=>l.$route.meta.menuItemType!=="frame"&&p(f),["stop"])},n(e.log.deal.name),11,zt)]),_:1},8,["to"])):g("",!0)],64)):g("",!0)]),summary:r(()=>[$(ee,{log:e.log},null,8,["log"])]),counter:r(({click:c,showChildren:p})=>[o("a",{onClick:T(c,["prevent"])},n(p?l.$t("collapse"):`+${l.$t("events",e.children.length)}`),9,xt)]),children:r(({child:c})=>[$(I,{space:"2"},{default:r(()=>{var p;return[o("div",null,n(l.$filters.toTitleCase(c.action_name)),1),o("div",Bt,[$(ee,{log:c},null,8,["log"])]),o("div",Ut,n(m(S)(c.create_datetime).format("HH:mm"))+" "+n((p=c.actor)==null?void 0:p.name),1)]}),_:2},1024)]),menu:r(()=>[Vt]),_:1},8,["title","title2","date","icon","children"])}}}),Yt={key:0},qt=["onClick"],Kt={class:"gray tw-text-sm"},Xt=o("i",{class:"fas fa-ellipsis-h gray"},null,-1),Jt=w({__name:"HistoryTabLogContact",props:{log:{},children:{}},setup(y){const e=y,{t:d}=x();return(l,s)=>{var _;return a(),v(D,{title:l.$filters.toTitleCase(e.log.action_name),title2:(_=e.log.actor)==null?void 0:_.name,date:e.log.create_datetime,icon:e.log.icon,children:e.children,contact:e.log.contact,deal:e.log.deal},{summary:r(()=>[e.log.content?(a(),u("div",Yt,n(e.log.content),1)):g("",!0)]),counter:r(({click:i,showChildren:c})=>[o("a",{onClick:T(i,["prevent"])},n(c?m(d)("collapse"):`+${m(d)("events",e.children.length)}`),9,qt)]),children:r(({child:i})=>[$(I,{space:"2"},{default:r(()=>{var c;return[o("div",null,n(l.$filters.toTitleCase(i.action_name)),1),o("div",Kt,n(m(S)(i.create_datetime).format("HH:mm"))+" "+n((c=i.actor)==null?void 0:c.name),1)]}),_:2},1024)]),menu:r(()=>[Xt]),_:1},8,["title","title2","date","icon","children","contact","deal"])}}}),Qt=o("i",{class:"fas fa-play-circle text-green"},null,-1),Wt=[Qt],Zt=o("i",{class:"fas fa-pause-circle text-green"},null,-1),eo=[Zt],to=o("i",{class:"fas fa-exclamation-circle text-yellow"},null,-1),oo=[to],so=w({__name:"TabLogCallRecord",props:{pluginRecordId:{},pluginCallId:{},pluginId:{}},setup(y){const e=y,d=P(!1),l=P(!1);let s;async function _(){if(!s){const{data:i}=await oe(`crm.call.recordUrl?call_id=${e.pluginCallId}&record_id=${e.pluginRecordId}&plugin=${e.pluginId}`).get().json();i&&(s=new Audio(i.value),s.onplaying=function(){d.value=!0},s.onpause=function(){d.value=!1},s.onerror=function(){l.value=!0,d.value=!1})}s&&(d.value?s.pause():s.play().catch(i=>i))}return(i,c)=>(a(),u("span",{class:"tw-cursor-pointer",onClick:_},[O(o("span",null,Wt,512),[[U,!d.value&&!l.value]]),O(o("span",null,eo,512),[[U,d.value]]),O(o("span",null,oo,512),[[U,l.value]])]))}}),no={key:0,class:"tw-flex tw-items-center tw-space-x-2 gray"},lo={key:0},ao={key:1},io=o("i",{class:"fas fa-spinner"},null,-1),ro=[io],co={class:"tw-flex tw-items-center tw-space-x-2"},uo={class:"tw-flex -tw-space-x-2"},_o=["onClick"],mo={key:0,class:"tw-text-sm gray"},go={class:"gray tw-text-sm"},po=o("i",{class:"fas fa-ellipsis-h gray"},null,-1),yo=w({__name:"HistoryTabLogCall",props:{log:{},children:{}},setup(y){const e=y,{t:d}=x();function l(s){var _,i,c,p;return s.direction==="IN"?`${((_=s.contact)==null?void 0:_.name)||s.client_phone_formatted} → ${((i=s.user)==null?void 0:i.name)||s.plugin_user_number}`:`${((c=s.user)==null?void 0:c.name)||s.plugin_user_number} → ${((p=s.contact)==null?void 0:p.name)||s.client_phone_formatted}`}return(s,_)=>(a(),v(D,{title:e.log.content||e.log.action_name,title2:l(e.log.call),date:e.log.create_datetime,icon:e.log.icon,children:e.children,contact:e.log.contact,deal:e.log.deal},{summary:r(()=>[e.log.call.status_id!=="DROPPED"?(a(),u("div",no,[e.log.call.duration?(a(),u("div",lo,[j(n(m(d)("duration"))+": "+n(s.$filters.secsToMinutes(e.log.call.duration))+" ",1),e.log.call.plugin_record_id?(a(),v(so,{key:0,"plugin-record-id":e.log.call.plugin_record_id,"plugin-call-id":e.log.call.plugin_call_id,"plugin-id":e.log.call.plugin_id},null,8,["plugin-record-id","plugin-call-id","plugin-id"])):g("",!0)])):g("",!0),["PENDING","CONNECTED"].includes(e.log.call.status_id)?(a(),u("div",ao,ro)):g("",!0)])):g("",!0)]),counter:r(({click:i,showChildren:c})=>[o("div",co,[o("div",uo,[(a(!0),u(E,null,F([e.log,...e.children].reduce((p,f)=>{var R;return(R=f.call.user)!=null&&R.userpic&&!p.includes(f.call.user.userpic)&&p.push(f.call.user.userpic),p},[]),(p,f)=>(a(),u("div",{key:f,class:"tw-outline-4 tw-outline tw-outline-waBlank tw-rounded-full",style:K(`z-index: ${f}`)},[$(V,{size:32,url:p},null,8,["url"])],4))),128))]),o("a",{onClick:T(i,["prevent"])},n(c?m(d)("collapse"):`+${m(d)("calls",e.children.length)}`),9,_o)])]),children:r(({child:i})=>[i.object_type==="CALL"?(a(),v(I,{key:0,space:"2"},{default:r(()=>[o("div",null,n(i.content),1),i.call.duration?(a(),u("div",mo,n(m(d)("duration"))+": "+n(s.$filters.secsToMinutes(i.call.duration)),1)):g("",!0),o("div",go,n(m(S)(i.create_datetime).format("HH:mm"))+" "+n(l(i.call)),1)]),_:2},1024)):g("",!0)]),menu:r(()=>[po]),_:1},8,["title","title2","date","icon","children","contact","deal"]))}}),G=t.object({id:t.number(),name:t.string(),userpic:t.string()}),H=t.object({id:t.number(),create_datetime:t.string().datetime(),action:t.string().nullable(),action_name:t.string(),object_id:t.number().nullable(),actor:G.nullable().optional(),before:t.string().optional().nullable(),after:t.string().optional().nullable(),content:t.string().optional().nullable(),icon:t.object({url:t.string(),color:t.string(),fa:t.string(),fab:t.string()}).partial(),deal:t.object({id:t.number(),name:t.string()}).optional().nullable()}),fo=H.extend({call:t.object({id:t.number(),client_contact_id:t.number(),client_phone_formatted:t.string(),comment:t.string().nullable(),direction:t.union([t.literal("IN"),t.literal("OUT")]),duration:t.number(),contact:G.optional(),user:G.optional().nullable(),plugin_id:t.string(),plugin_call_id:t.string(),plugin_record_id:t.string().nullable(),plugin_user_number:t.string(),status_id:t.union([t.literal("PENDING"),t.literal("CONNECTED"),t.literal("FINISHED"),t.literal("DROPPED"),t.literal("REDIRECTED"),t.literal("VOICEMAIL")])}),object_type:t.literal("CALL")}),ho=H.extend({message:t.object({id:t.number(),subject:t.string().optional().nullable(),body_plain:t.string(),conversation_id:t.number().nullable(),conversation_count:t.number().optional(),conversation_participants:t.array(G).optional()}).optional(),object_type:t.literal("MESSAGE")}),$o=H.extend({reminder:t.object({id:t.number(),content:t.string()}).nullable(),object_type:t.literal("REMINDER")}),vo=H.extend({object_type:t.literal("NOTE")}),bo=H.extend({invoice:t.object({amount:t.number(),currency_id:t.string(),id:t.number(),invoice_date:t.string(),number:t.string(),summary:t.string().nullable(),state_id:t.enum(["PENDING","PAID","REFUNDED","ARCHIVED","DRAFT","PROCESSING"]),state_name:t.string()}).optional(),object_type:t.literal("INVOICE")}),wo=H.extend({stage_before:t.object({id:t.number(),name:t.string(),color:t.string()}).optional(),stage_after:t.object({id:t.number(),name:t.string(),color:t.string()}).optional(),object_type:t.literal("DEAL")}),ko=H.extend({file:t.object({id:t.number(),comment:t.string().nullable(),create_datetime:t.string(),name:t.string(),size:t.number(),url:t.string()}).optional(),object_type:t.literal("FILE")}),Co=H.extend({object_type:t.literal("CONTACT")}),To=H.extend({order:t.object({id:t.number(),number:t.string(),currency:t.string(),total:t.number()}).optional(),object_type:t.literal("ORDER")}),Lo=t.discriminatedUnion("object_type",[fo,ho,$o,vo,bo,wo,ko,Co,To]);function te(y){return Array.isArray(y)?y.filter(e=>{const d=Lo.safeParse(e);return d.success||console.warn(e,e.object_type,d.error.issues),d.success}):[]}const Io={key:1},Eo={key:2,class:"tw-max-w-3xl tw-mx-auto"},So={class:"gray uppercase smaller"},Ro={class:"tw-h-1"},Do=o("div",{class:"spinner custom-p-16"},null,-1),Ho=[Do],jo=o("div",{class:"icon size-80"},[o("i",{class:"fas fa-bolt"})],-1),Ao=100,Vo=w({__name:"HistoryTab",props:{entityType:{},entityId:{},filter:{},userId:{}},setup(y){const e=y,d={CONTACT:Jt,REMINDER:Pe,CALL:yo,MESSAGE:pt,NOTE:tt,INVOICE:$t,DEAL:Gt,FILE:Lt,ORDER:qe},l=["notes","files","invoices","deals","contacts","messages","calls","reminders","orders"],s={note:l[0],file:l[1],invoice:l[2],deal:l[3],contact:l[4],message:l[5],call:l[6],reminder:l[7],order_log:l[8]};ie("entityType",e.entityType);const _=P([]),i=Z(()=>le(_.value)),c=P({filters:e.filter&&e.filter!=="all"?[s[e.filter]]:[...l],...e.entityType!=="live"&&e.entityId?{[`${e.entityType}_id`]:e.entityId}:{},...!isNaN(Number(e.userId))&&e.userId!=="0"?{user_id:Number(e.userId)}:{},limit:Ao}),{data:p,isFetching:f,error:R}=oe(Z(()=>`crm.history?${_e.stringify(c.value)}`),{refetch:!0}).get().json();re(p,L=>{L&&Array.isArray(L.log)&&(_.value="min_id"in c.value?[...te(L.log),..._.value]:[..._.value,...te(L.log)])}),ce(de).on(se);function se(){_.value[0]&&(c.value.min_id=_.value[0].id)}function ne(){if(!_.value.length)return;const L=_.value[_.value.length-1].id;L&&(c.value.max_id=L)}function le(L){const Y=L.reduce((k,C)=>{const b=S(C.create_datetime).format("MM/DD/YYYY");return b in k?k[b].push(C):k[b]=[C],k},{}),N=[],A={};for(const k in Y)A[k]=Y[k].reduce((C,b)=>{var Q;const M=`${b.object_type}_${b.object_type==="MESSAGE"?((Q=b.message)==null?void 0:Q.conversation_id)||q().toString():b.object_type==="CALL"?b.call.client_contact_id||q().toString():["NOTE","FILE"].includes(b.object_type)?"":b.object_id||q().toString()}`;return b.object_type==="MESSAGE"&&N.includes(M)||(N.push(M),M in C?C[M].push(b):C[M]=[b]),C},{}),Object.keys(A[k]).length||delete A[k];return A}return(L,Y)=>m(f)&&!_.value.length?(a(),v(ge,{key:0,class:"tw-max-w-3xl tw-mx-auto"})):m(R)?(a(),u("div",Io,[e.entityType==="live"?(a(),u(E,{key:0},[j(n(m(R)),1)],64)):g("",!0)])):_.value.length?(a(),u("div",Eo,[$(I,{space:"4"},{default:r(()=>[(a(!0),u(E,null,F(i.value,(N,A)=>(a(),u("div",{key:A},[o("div",So,n(m(S)(A).format("LL")),1),(a(!0),u(E,null,F(N,(k,C)=>(a(),v(ue(d[C.split("_")[0]]),{key:C,log:k[0],children:k.slice(1)},null,8,["log","children"]))),128))]))),128))]),_:1}),O(o("div",Ro,null,512),[[m(me),([{isIntersecting:N}])=>{N&&!m(f)&&ne()}]]),o("div",{class:h(["tw-text-center tw-py-4",m(f)?"tw-opacity-100":"tw-opacity-0"])},Ho,2)])):(a(),v(pe,{key:3,message:L.$t(e.entityType==="live"?"noTimelineByConditions":"emptyTimeline")},{default:r(()=>[jo]),_:1},8,["message"]))}});export{Vo as default};
