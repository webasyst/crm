import{d as w,a8 as J,h as P,m as Q,o as a,c as u,b as $,w as r,a as o,n as h,r as U,A as H,p as l,e as L,a9 as Y,j as g,u as m,F as S,q as F,k as O,v as G,_ as z,i as v,H as B,B as ee,aa as ae,P as ne,ab as t,ac as ie,l as te,R as re,V as ce,ad as de,Z as ue,ae as _e,af as Z}from"./main-2290994d.js";import{v as me}from"./index-0b6b9def.js";import{S as ge}from"./SkeletonList-1c6858f7.js";import{E as pe}from"./EmptyList-239f0622.js";import{C as E}from"./CustomColumn-c63128eb.js";import{U as x}from"./UserPic-f44f080b.js";import{d as R}from"./dayjs-910ec40d.js";import{H as ye}from"./HistoryTabLogInvoiceSummary-bbaea840.js";import{d as fe}from"./downloadFile-f2c6fc05.js";const he={class:"tw-flex-auto black bold"},$e=o("div",null,null,-1),ve={class:"tw-flex-auto tw-text-sm"},be={key:0},we=["href","onClick"],ke=["title"],Ce={class:"tw-whitespace-normal"},Te={key:1,class:"tw-flex tw-gap-1.5"},Le=["href","onClick"],Ie={class:"gray"},Ee={class:"tw-flex-auto"},Se={class:"tw-flex-auto tw-text-sm"},Re=w({__name:"HistoryTabLog",props:{icon:{},title:{},title2:{},date:{},children:{},deal:{},contact:{}},setup(y){const e=y,d=J("entityType"),n=P(!1);return(s,_)=>{const i=Q("RouterLink");return a(),u("div",{class:h(s.$style.log)},[$(E,{space:"2"},{default:r(()=>[o("div",{class:h([s.$style.logRow,"tw-items-center"])},[o("div",null,[$(x,{url:s.icon.url,"bg-color":s.icon.color,"fa-icon":s.icon.fa||s.icon.fab,"fa-icon-style":s.icon.fab?"fab":"fas",size:32,"disable-rounded":!!s.icon.url},null,8,["url","bg-color","fa-icon","fa-icon-style","disable-rounded"])]),o("div",he,[U(s.$slots,"header",{},()=>[H(l(e.title),1)])])],2),o("div",{class:h(s.$style.logRow)},[$e,o("div",ve,[$(E,{space:"2"},{default:r(()=>[U(s.$slots,"summary"),e.deal?(a(),u("div",be,[$(i,{to:{name:"deal",params:{id:e.deal.id}},custom:""},{default:r(({href:c,navigate:p})=>{var f,k,V;return[o("a",{href:c,class:h([s.$constant.parentAppDisableRouterClass,"tw-whitespace-nowrap"]),onClick:L(q=>(s.$route.meta.menuItemType!=="frame"||s.$route.meta.isWidgetMode)&&p(q),["stop"])},[o("span",{class:"icon size-16 tw-mr-1.5",title:(f=s.deal)==null?void 0:f.funnel.name},[o("i",{class:h(((k=s.deal)==null?void 0:k.funnel.icon)||"fas fa-briefcase"),style:Y({color:(V=s.deal)==null?void 0:V.funnel.color})},null,6)],8,ke),o("span",Ce,l(e.deal.name),1)],10,we)]}),_:1},8,["to"])])):g("",!0),m(d)==="live"&&e.contact?(a(),u("div",Te,[$(x,{url:e.contact.userpic,size:20},null,8,["url"]),$(i,{to:{name:"contact",params:{id:e.contact.id}},custom:""},{default:r(({href:c,navigate:p})=>[o("a",{href:c,class:h([s.$constant.parentAppDisableRouterClass,"tw-line-clamp-2 tw-self-center"]),onClick:L(f=>(s.$route.meta.menuItemType!=="frame"||s.$route.meta.isWidgetMode)&&p(f),["stop"])},l(e.contact.name),11,Le)]),_:1},8,["to"])])):g("",!0),o("div",Ie,l(m(R)(e.date).format("HH:mm"))+" "+l(e.title2),1)]),_:3})])],2),n.value&&Array.isArray(e.children)?(a(!0),u(S,{key:0},F(e.children,c=>(a(),u("div",{key:c.id},[o("div",{class:h([s.$style.logRow,"tw-items-start"])},[o("div",null,[o("div",{class:h([s.$style.pointer,"tw-translate-y-2"])},null,2)]),o("div",Ee,[U(s.$slots,"children",{child:c})])],2)]))),128)):g("",!0),typeof e.children=="number"&&e.children>1||Array.isArray(e.children)&&e.children.length?(a(),u("div",{key:1,class:h(s.$style.logRow)},[o("div",null,[O(o("div",{class:h(s.$style.pointer)},null,2),[[G,!n.value]])]),o("div",Se,[U(s.$slots,"counter",{showChildren:n.value,click:()=>n.value=!n.value})])],2)):g("",!0)]),_:3})],2)}}}),De="_log_vip2u_1",je="_logRow_vip2u_13",He="_pointer_vip2u_24",Ae={log:De,logRow:je,pointer:He},Ne={$style:Ae},D=z(Re,[["__cssModules",Ne]]),Me={key:0,class:"tw-line-clamp-2"},Oe=o("i",{class:"fas fa-ellipsis-h gray"},null,-1),Pe=w({__name:"HistoryTabLogReminder",props:{log:{},children:{}},setup(y){const e=y;return(d,n)=>{var s;return a(),v(D,{title:d.$filters.toTitleCase(e.log.action_name),text:(s=d.log.reminder)==null?void 0:s.content,date:e.log.create_datetime,icon:e.log.icon,children:e.children,contact:e.log.contact,deal:e.log.deal},{summary:r(()=>[e.log.reminder?(a(),u("div",Me,l(e.log.reminder.content),1)):g("",!0)]),counter:r(()=>[]),menu:r(()=>[Oe]),_:1},8,["title","text","date","icon","children","contact","deal"])}}}),Fe={key:0},ze=["onClick"],Be={class:"gray tw-text-sm"},Ve=o("i",{class:"fas fa-ellipsis-h gray"},null,-1),Ue=w({__name:"HistoryTabLogOrder",props:{log:{},children:{}},setup(y){const e=y;return(d,n)=>{var s;return a(),v(D,{title:d.$filters.toTitleCase(e.log.action_name),title2:(s=e.log.actor)==null?void 0:s.name,date:e.log.create_datetime,icon:e.log.icon,children:e.children,contact:e.log.contact,deal:e.log.deal},{summary:r(()=>[$(E,{space:"2"},{default:r(()=>[e.log.order?(a(),u("div",Fe,[H(l(d.$t("order"))+" "+l(e.log.order.number)+" ",1),o("strong",null,l(d.$filters.toCurrency(e.log.order.total,e.log.order.currency)),1)])):g("",!0),e.log.content?(a(),u("div",{key:1,class:h(d.$style.comment)},l(e.log.content),3)):g("",!0)]),_:1})]),counter:r(({click:_,showChildren:i})=>[o("a",{onClick:L(_,["prevent"])},l(i?d.$t("collapse"):`+${d.$t("events",e.children.length)}`),9,ze)]),children:r(({child:_})=>[$(E,{space:"2"},{default:r(()=>{var i;return[o("div",null,l(d.$filters.toTitleCase(_.action_name)),1),_.content?(a(),u("div",{key:0,class:h(d.$style.comment)},l(_.content),3)):g("",!0),o("div",Be,l(m(R)(_.create_datetime).format("HH:mm"))+" "+l((i=_.actor)==null?void 0:i.name),1)]}),_:2},1024)]),menu:r(()=>[Ve]),_:1},8,["title","title2","date","icon","children","contact","deal"])}}}),Ge="_comment_1wsv4_1",Ye={comment:Ge},xe={$style:Ye},We=z(Ue,[["__cssModules",xe]]),qe=["onClick"],Ke={class:"gray tw-text-sm"},Ze=o("i",{class:"fas fa-ellipsis-h gray"},null,-1),Je=w({__name:"HistoryTabLogNote",props:{log:{},children:{}},setup(y){const e=y,{t:d}=B();return(n,s)=>{var _;return a(),v(D,{title:n.$filters.toTitleCase(e.log.action_name),title2:(_=e.log.actor)==null?void 0:_.name,date:e.log.create_datetime,icon:e.log.icon,children:e.children,contact:e.log.contact,deal:e.log.deal},{summary:r(()=>[e.log.content?(a(),u("div",{key:0,class:h(n.$style.note)},l(e.log.content),3)):g("",!0)]),counter:r(({click:i,showChildren:c})=>[o("a",{onClick:L(i,["prevent"])},l(c?m(d)("collapse"):`+${m(d)("events",e.children.length)}`),9,qe)]),children:r(({child:i})=>[$(E,{space:"2"},{default:r(()=>{var c;return[o("div",null,l(n.$filters.toTitleCase(i.action_name)),1),o("div",Ke,l(m(R)(i.create_datetime).format("HH:mm"))+" "+l((c=i.actor)==null?void 0:c.name),1)]}),_:2},1024)]),menu:r(()=>[Ze]),_:1},8,["title","title2","date","icon","children","contact","deal"])}}}),Qe="_note_15hyk_1",Xe={note:Qe},et={$style:Xe},tt=z(Je,[["__cssModules",et]]),ot={key:0},st={key:0,class:"bold tw-mb-2"},nt={class:"tw-line-clamp-2"},lt={class:"tw-flex tw-items-center tw-space-x-2"},at=["href"],it=o("i",{class:"fas fa-ellipsis-h gray"},null,-1),rt=w({__name:"HistoryTabLogMessage",props:{log:{},children:{}},setup(y){const e=y,d=J("entityType");return(n,s)=>{var i,c;const _=Q("RouterLink");return a(),v(D,{title:((i=e.log.actor)==null?void 0:i.name)||n.$t("noName"),date:e.log.create_datetime,icon:e.log.icon,children:(c=e.log.message)==null?void 0:c.conversation_count,contact:e.log.contact,deal:e.log.deal},{summary:r(()=>{var p,f;return[(p=e.log.message)!=null&&p.body_plain?(a(),u("div",ot,[o("div",{class:h(n.$style.baloon)},[e.log.message.subject?(a(),u("div",st,l(e.log.message.subject),1)):g("",!0),o("div",nt,l(e.log.message.body_plain),1)],2),(((f=e.log.message)==null?void 0:f.conversation_count)??0)>1?(a(),u(S,{key:0},[o("div",{class:h(n.$style.baloonShadow1)},null,2),o("div",{class:h(n.$style.baloonShadow2)},null,2)],64)):g("",!0)])):g("",!0)]}),counter:r(()=>{var p,f;return[o("div",lt,[o("div",{class:h(n.$style.userPics)},[(a(!0),u(S,null,F((p=e.log.message)==null?void 0:p.conversation_participants,k=>(a(),v(x,{key:k.id,size:32,url:k.userpic},null,8,["url"]))),128))],2),(f=e.log.message)!=null&&f.conversation_id?(a(),u(S,{key:0},[n.$route.meta.menuItemType==="frame"?(a(),u("a",{key:0,href:`${m(ee).baseUrl}message/conversation/${e.log.message.conversation_id}/?view=chat`,class:h(n.$constant.parentAppDisableRouterClass)},l(`+${n.$t("messages",(e.log.message.conversation_count??1)-1)}`),11,at)):m(ee).webView?(a(),u("a",{key:2,onClick:s[0]||(s[0]=L(k=>m(ae).emit("spa:navigateTo",{name:"conversation",id:e.log.message.conversation_id}),["prevent"]))},l(`+${n.$t("messages",(e.log.message.conversation_count??1)-1)}`),1)):(a(),v(_,{key:1,to:{name:`${m(d)}MessagesTab`,query:{conversationId:e.log.message.conversation_id}},class:h(n.$constant.parentAppDisableRouterClass)},{default:r(()=>[H(l(`+${n.$t("messages",(e.log.message.conversation_count??1)-1)}`),1)]),_:1},8,["to","class"]))],64)):g("",!0)])]}),children:r(({child:p})=>[H(l(p.action_name),1)]),menu:r(()=>[it]),_:1},8,["title","date","icon","children","contact","deal"])}}}),ct="_userPics_1h7lu_1",dt="_baloon_1h7lu_8",ut="_baloonShadow1_1h7lu_16",_t="_baloonShadow2_1h7lu_24",mt={userPics:ct,baloon:dt,baloonShadow1:ut,baloonShadow2:_t},gt={$style:mt},pt=z(rt,[["__cssModules",gt]]),yt=["onClick"],ft={class:"tw-text-sm gray"},ht=o("i",{class:"fas fa-ellipsis-h gray"},null,-1),$t=w({__name:"HistoryTabLogInvoice",props:{log:{},children:{}},setup(y){const e=y,{t:d}=B();return(n,s)=>{var _;return a(),v(D,{title:n.$filters.toTitleCase(e.log.action_name),title2:(_=e.log.actor)==null?void 0:_.name,date:e.log.create_datetime,icon:e.log.icon,children:e.children,contact:e.log.contact,deal:e.log.deal},{summary:r(()=>[$(ye,{invoice:e.log.invoice},null,8,["invoice"])]),counter:r(({click:i,showChildren:c})=>[o("a",{onClick:L(i,["prevent"])},l(c?m(d)("collapse"):`+${m(d)("events",e.children.length)}`),9,yt)]),children:r(({child:i})=>[$(E,{space:"2"},{default:r(()=>{var c;return[o("div",null,l(n.$filters.toTitleCase(i.action_name)),1),o("div",ft,l(m(R)(i.create_datetime).format("HH:mm"))+" "+l((c=i.actor)==null?void 0:c.name),1)]}),_:2},1024)]),menu:r(()=>[ht]),_:1},8,["title","title2","date","icon","children","contact","deal"])}}}),vt={key:0},bt=["href"],wt={class:"gray small"},kt=["onClick"],Ct={class:"gray tw-text-sm"},Tt=o("i",{class:"fas fa-ellipsis-h gray"},null,-1),Lt=w({__name:"HistoryTabLogFile",props:{log:{},children:{}},setup(y){const e=y,{t:d}=B();return(n,s)=>{var _;return a(),v(D,{title:n.$filters.toTitleCase(e.log.action_name),title2:(_=e.log.actor)==null?void 0:_.name,date:e.log.create_datetime,icon:e.log.icon,children:e.children,contact:e.log.contact,deal:e.log.deal},{summary:r(()=>[e.log.file?(a(),u("div",vt,[o("a",{href:e.log.file.url,class:h(n.$constant.parentAppDisableRouterClass),onClick:s[0]||(s[0]=L(i=>m(fe)(e.log.file.url,e.log.file.id,e.log.file.name),["prevent"]))},l(e.log.file.name),11,bt),H("  "),o("span",wt,l(e.log.file.size)+" KB",1)])):g("",!0)]),counter:r(({click:i,showChildren:c})=>[o("a",{onClick:L(i,["prevent"])},l(c?m(d)("collapse"):`+${m(d)("events",e.children.length)}`),9,kt)]),children:r(({child:i})=>[$(E,{space:"2"},{default:r(()=>{var c;return[o("div",null,l(n.$filters.toTitleCase(i.action_name)),1),o("div",Ct,l(m(R)(i.create_datetime).format("HH:mm"))+" "+l((c=i.actor)==null?void 0:c.name),1)]}),_:2},1024)]),menu:r(()=>[Tt]),_:1},8,["title","title2","date","icon","children","contact","deal"])}}}),It={key:0,class:"tw-flex tw-space-x-2 tw-items-center"},Et={key:0,class:"tw-line-through gray"},St={key:1,class:"gray"},Rt={key:2},Dt={key:1,class:"tw-flex tw-space-x-2 tw-items-center"},jt={key:0,class:"log-deal-badge"},Ht={class:"icon size-12 rounded"},At={class:"log-deal-badge__text"},Nt={key:1,class:"gray"},Mt={key:2,class:"log-deal-badge"},Ot={class:"icon size-12 rounded"},Pt={class:"log-deal-badge__text"},Ft=w({__name:"HistoryTabLogDealSummary",props:{log:{}},setup(y){const e=y;return(d,n)=>(a(),u(S,null,[e.log.before||e.log.after?(a(),u("div",It,[e.log.before?(a(),u("div",Et,l(e.log.before),1)):g("",!0),e.log.before&&e.log.after?(a(),u("span",St,"→")):g("",!0),e.log.after?(a(),u("div",Rt,l(e.log.after),1)):g("",!0)])):g("",!0),e.log.stage_before||e.log.stage_after?(a(),u("div",Dt,[e.log.stage_before?(a(),u("div",jt,[o("span",Ht,[o("i",{class:"fas fa-circle circle",style:Y({color:e.log.stage_before.color})},null,4)]),o("span",At,l(e.log.stage_before.name),1)])):g("",!0),e.log.stage_before&&e.log.stage_after?(a(),u("span",Nt,"→")):g("",!0),e.log.stage_after?(a(),u("div",Mt,[o("span",Ot,[o("i",{class:"fas fa-circle circle",style:Y({color:e.log.stage_after.color})},null,4)]),o("span",Pt,l(e.log.stage_after.name),1)])):g("",!0)])):g("",!0)],64))}});const oe=z(Ft,[["__scopeId","data-v-df4a6a10"]]),zt=["href","onClick"],Bt=["onClick"],Vt={class:"tw-text-sm empty:tw-hidden"},Ut={class:"gray tw-text-sm"},Gt=o("i",{class:"fas fa-ellipsis-h gray"},null,-1),Yt=w({__name:"HistoryTabLogDeal",props:{log:{},children:{}},setup(y){const e=y,d=J("entityType");return(n,s)=>{var i;const _=Q("RouterLink");return a(),v(D,{title:n.$filters.toTitleCase(e.log.action_name),title2:(i=e.log.actor)==null?void 0:i.name,date:e.log.create_datetime,icon:e.log.icon,children:e.children},{header:r(()=>[H(l(n.$filters.toTitleCase(e.log.action_name))+" ",1),["contact","live"].includes(m(d))?(a(),u(S,{key:0},[e.log.deal?(a(),v(_,{key:0,to:{name:"deal",params:{id:e.log.deal.id}},custom:""},{default:r(({href:c,navigate:p})=>[o("a",{href:c,class:h(n.$constant.parentAppDisableRouterClass),onClick:L(f=>(n.$route.meta.menuItemType!=="frame"||n.$route.meta.isWidgetMode)&&p(f),["stop"])},l(e.log.deal.name),11,zt)]),_:1},8,["to"])):g("",!0)],64)):g("",!0)]),summary:r(()=>[$(oe,{log:e.log},null,8,["log"])]),counter:r(({click:c,showChildren:p})=>[o("a",{onClick:L(c,["prevent"])},l(p?n.$t("collapse"):`+${n.$t("events",e.children.length)}`),9,Bt)]),children:r(({child:c})=>[$(E,{space:"2"},{default:r(()=>{var p;return[o("div",null,l(n.$filters.toTitleCase(c.action_name)),1),o("div",Vt,[$(oe,{log:c},null,8,["log"])]),o("div",Ut,l(m(R)(c.create_datetime).format("HH:mm"))+" "+l((p=c.actor)==null?void 0:p.name),1)]}),_:2},1024)]),menu:r(()=>[Gt]),_:1},8,["title","title2","date","icon","children"])}}}),xt={key:0},Wt=["onClick"],qt={class:"gray tw-text-sm"},Kt=o("i",{class:"fas fa-ellipsis-h gray"},null,-1),Zt=w({__name:"HistoryTabLogContact",props:{log:{},children:{}},setup(y){const e=y,{t:d}=B();return(n,s)=>{var _;return a(),v(D,{title:n.$filters.toTitleCase(e.log.action_name),title2:(_=e.log.actor)==null?void 0:_.name,date:e.log.create_datetime,icon:e.log.icon,children:e.children,contact:e.log.contact,deal:e.log.deal},{summary:r(()=>[e.log.content?(a(),u("div",xt,l(e.log.content),1)):g("",!0)]),counter:r(({click:i,showChildren:c})=>[o("a",{onClick:L(i,["prevent"])},l(c?m(d)("collapse"):`+${m(d)("events",e.children.length)}`),9,Wt)]),children:r(({child:i})=>[$(E,{space:"2"},{default:r(()=>{var c;return[o("div",null,l(n.$filters.toTitleCase(i.action_name)),1),o("div",qt,l(m(R)(i.create_datetime).format("HH:mm"))+" "+l((c=i.actor)==null?void 0:c.name),1)]}),_:2},1024)]),menu:r(()=>[Kt]),_:1},8,["title","title2","date","icon","children","contact","deal"])}}}),Jt=o("i",{class:"fas fa-play-circle text-green"},null,-1),Qt=[Jt],Xt=o("i",{class:"fas fa-pause-circle text-green"},null,-1),eo=[Xt],to=o("i",{class:"fas fa-exclamation-circle text-yellow"},null,-1),oo=[to],so=w({__name:"TabLogCallRecord",props:{pluginRecordId:{},pluginCallId:{},pluginId:{}},setup(y){const e=y,d=P(!1),n=P(!1);let s;async function _(){if(!s){const{data:i}=await ne(`crm.call.recordUrl?call_id=${e.pluginCallId}&record_id=${e.pluginRecordId}&plugin=${e.pluginId}`).get().json();i&&(s=new Audio(i.value),s.onplaying=function(){d.value=!0},s.onpause=function(){d.value=!1},s.onerror=function(){n.value=!0,d.value=!1})}s&&(d.value?s.pause():s.play().catch(i=>i))}return(i,c)=>(a(),u("span",{class:"tw-cursor-pointer",onClick:_},[O(o("span",null,Qt,512),[[G,!d.value&&!n.value]]),O(o("span",null,eo,512),[[G,d.value]]),O(o("span",null,oo,512),[[G,n.value]])]))}}),no={key:0,class:"tw-flex tw-items-center tw-space-x-2 gray"},lo={key:0},ao={key:1},io=o("i",{class:"fas fa-spinner"},null,-1),ro=[io],co={class:"tw-flex tw-items-center tw-space-x-2"},uo={class:"tw-flex -tw-space-x-2"},_o=["onClick"],mo={key:0,class:"tw-text-sm gray"},go={class:"gray tw-text-sm"},po=o("i",{class:"fas fa-ellipsis-h gray"},null,-1),yo=w({__name:"HistoryTabLogCall",props:{log:{},children:{}},setup(y){const e=y,{t:d}=B();function n(s){var _,i,c,p;return s.direction==="IN"?`${((_=s.contact)==null?void 0:_.name)||s.client_phone_formatted} → ${((i=s.user)==null?void 0:i.name)||s.plugin_user_number}`:`${((c=s.user)==null?void 0:c.name)||s.plugin_user_number} → ${((p=s.contact)==null?void 0:p.name)||s.client_phone_formatted}`}return(s,_)=>(a(),v(D,{title:e.log.content||e.log.action_name,title2:n(e.log.call),date:e.log.create_datetime,icon:e.log.icon,children:e.children,contact:e.log.contact,deal:e.log.deal},{summary:r(()=>[e.log.call.status_id!=="DROPPED"?(a(),u("div",no,[e.log.call.duration?(a(),u("div",lo,[H(l(m(d)("duration"))+": "+l(s.$filters.secsToMinutes(e.log.call.duration))+" ",1),e.log.call.plugin_record_id?(a(),v(so,{key:0,"plugin-record-id":e.log.call.plugin_record_id,"plugin-call-id":e.log.call.plugin_call_id,"plugin-id":e.log.call.plugin_id},null,8,["plugin-record-id","plugin-call-id","plugin-id"])):g("",!0)])):g("",!0),["PENDING","CONNECTED"].includes(e.log.call.status_id)?(a(),u("div",ao,ro)):g("",!0)])):g("",!0)]),counter:r(({click:i,showChildren:c})=>[o("div",co,[o("div",uo,[(a(!0),u(S,null,F([e.log,...e.children].reduce((p,f)=>{var k;return(k=f.call.user)!=null&&k.userpic&&!p.includes(f.call.user.userpic)&&p.push(f.call.user.userpic),p},[]),(p,f)=>(a(),u("div",{key:f,class:"tw-outline-4 tw-outline tw-outline-waBlank tw-rounded-full",style:Y(`z-index: ${f}`)},[$(x,{size:32,url:p},null,8,["url"])],4))),128))]),o("a",{onClick:L(i,["prevent"])},l(c?m(d)("collapse"):`+${m(d)("calls",e.children.length)}`),9,_o)])]),children:r(({child:i})=>[i.object_type==="CALL"?(a(),v(E,{key:0,space:"2"},{default:r(()=>[o("div",null,l(i.content),1),i.call.duration?(a(),u("div",mo,l(m(d)("duration"))+": "+l(s.$filters.secsToMinutes(i.call.duration)),1)):g("",!0),o("div",go,l(m(R)(i.create_datetime).format("HH:mm"))+" "+l(n(i.call)),1)]),_:2},1024)):g("",!0)]),menu:r(()=>[po]),_:1},8,["title","title2","date","icon","children","contact","deal"]))}}),W=t.object({id:t.number(),name:t.string(),userpic:t.string()}),j=t.object({id:t.number(),create_datetime:t.string().datetime(),action:t.string().nullable(),action_name:t.string(),object_id:t.number().nullable(),actor:W.nullable().optional(),before:t.string().optional().nullable(),after:t.string().optional().nullable(),content:t.string().optional().nullable(),icon:t.object({url:t.string(),color:t.string(),fa:t.string(),fab:t.string()}).partial(),deal:t.object({id:t.number(),name:t.string(),funnel:t.object({id:t.number(),name:t.string(),icon:t.string(),color:t.string()})}).optional().nullable()}),fo=j.extend({call:t.object({id:t.number(),client_contact_id:t.number(),client_phone_formatted:t.string(),comment:t.string().nullable(),direction:t.union([t.literal("IN"),t.literal("OUT")]),duration:t.number(),contact:W.optional(),user:W.optional().nullable(),plugin_id:t.string(),plugin_call_id:t.string(),plugin_record_id:t.string().nullable(),plugin_user_number:t.string(),status_id:t.union([t.literal("PENDING"),t.literal("CONNECTED"),t.literal("FINISHED"),t.literal("DROPPED"),t.literal("REDIRECTED"),t.literal("VOICEMAIL")])}),object_type:t.literal("CALL")}),ho=j.extend({message:t.object({id:t.number(),subject:t.string().optional().nullable(),body_plain:t.string(),conversation_id:t.number().nullable(),conversation_count:t.number().optional(),conversation_participants:t.array(W).optional()}).optional(),object_type:t.literal("MESSAGE")}),$o=j.extend({reminder:t.object({id:t.number(),content:t.string()}).nullable(),object_type:t.literal("REMINDER")}),vo=j.extend({object_type:t.literal("NOTE")}),bo=j.extend({invoice:t.object({amount:t.number(),currency_id:t.string(),id:t.number(),invoice_date:t.string(),number:t.string(),summary:t.string().nullable(),state_id:t.enum(["PENDING","PAID","REFUNDED","ARCHIVED","DRAFT","PROCESSING"]),state_name:t.string()}).optional(),object_type:t.literal("INVOICE")}),wo=j.extend({stage_before:t.object({id:t.number(),name:t.string(),color:t.string()}).optional(),stage_after:t.object({id:t.number(),name:t.string(),color:t.string()}).optional(),object_type:t.literal("DEAL")}),ko=j.extend({file:t.object({id:t.number(),comment:t.string().nullable(),create_datetime:t.string(),name:t.string(),size:t.number(),url:t.string()}).optional(),object_type:t.literal("FILE")}),Co=j.extend({object_type:t.literal("CONTACT")}),To=j.extend({order:t.object({id:t.number(),number:t.string(),currency:t.string(),total:t.number()}).optional(),object_type:t.literal("ORDER")}),Lo=t.discriminatedUnion("object_type",[fo,ho,$o,vo,bo,wo,ko,Co,To]);function se(y){return Array.isArray(y)?y.filter(e=>{const d=Lo.safeParse(e);return d.success||console.warn(e,e.object_type,d.error.issues),d.success}):[]}const Io={key:1},Eo={key:2,class:"tw-max-w-3xl tw-mx-auto"},So={class:"gray uppercase smaller"},Ro={class:"tw-h-1"},Do=o("div",{class:"spinner custom-p-16"},null,-1),jo=[Do],Ho=o("div",{class:"icon size-80"},[o("i",{class:"fas fa-bolt"})],-1),Ao=100,Go=w({__name:"HistoryTab",props:{entityType:{},entityId:{},filter:{},userId:{}},setup(y){const e=y,d={CONTACT:Zt,REMINDER:Pe,CALL:yo,MESSAGE:pt,NOTE:tt,INVOICE:$t,DEAL:Yt,FILE:Lt,ORDER:We},n=["notes","files","invoices","deals","contacts","messages","calls","reminders","orders"],s={note:n[0],file:n[1],invoice:n[2],deal:n[3],contact:n[4],message:n[5],call:n[6],reminder:n[7],order_log:n[8]};ie("entityType",e.entityType);const _=P([]),i=te(()=>le(_.value)),c=P({filters:e.filter&&e.filter!=="all"?[s[e.filter]]:[...n],...e.entityType!=="live"&&e.entityId?{[`${e.entityType}_id`]:e.entityId}:{},...!isNaN(Number(e.userId))&&e.userId!=="0"?{user_id:Number(e.userId)}:{},limit:Ao}),{data:p,isFetching:f,error:k}=ne(te(()=>`crm.history?${_e.stringify(c.value)}`),{refetch:!0}).get().json();re(p,I=>{I&&Array.isArray(I.log)&&(_.value="min_id"in c.value?[...se(I.log),..._.value]:[..._.value,...se(I.log)])}),ce(de).on(V);function V(){_.value[0]&&(c.value.min_id=_.value[0].id)}function q(){if(!_.value.length)return;const I=_.value[_.value.length-1].id;I&&(c.value.max_id=I)}function le(I){const K=I.reduce((C,T)=>{const b=R(T.create_datetime).format("MM/DD/YYYY");return b in C?C[b].push(T):C[b]=[T],C},{}),N=[],A={};for(const C in K)A[C]=K[C].reduce((T,b)=>{var X;const M=`${b.object_type}_${b.object_type==="MESSAGE"?((X=b.message)==null?void 0:X.conversation_id)||Z().toString():b.object_type==="CALL"?b.call.client_contact_id||Z().toString():["NOTE","FILE"].includes(b.object_type)?"":b.object_id||Z().toString()}`;return b.object_type==="MESSAGE"&&N.includes(M)||(N.push(M),M in T?T[M].push(b):T[M]=[b]),T},{}),Object.keys(A[C]).length||delete A[C];return A}return(I,K)=>m(f)&&!_.value.length?(a(),v(ge,{key:0,class:"tw-max-w-3xl tw-mx-auto"})):m(k)?(a(),u("div",Io,[e.entityType==="live"?(a(),u(S,{key:0},[H(l(m(k)),1)],64)):g("",!0)])):_.value.length?(a(),u("div",Eo,[$(E,{space:"4"},{default:r(()=>[(a(!0),u(S,null,F(i.value,(N,A)=>(a(),u("div",{key:A},[o("div",So,l(m(R)(A).format("LL")),1),(a(!0),u(S,null,F(N,(C,T)=>(a(),v(ue(d[T.split("_")[0]]),{key:T,log:C[0],children:C.slice(1)},null,8,["log","children"]))),128))]))),128))]),_:1}),O(o("div",Ro,null,512),[[m(me),([{isIntersecting:N}])=>{N&&!m(f)&&q()}]]),o("div",{class:h(["tw-text-center tw-py-4",m(f)?"tw-opacity-100":"tw-opacity-0"])},jo,2)])):(a(),v(pe,{key:3,message:I.$t(e.entityType==="live"?"noTimelineByConditions":"emptyTimeline")},{default:r(()=>[Ho]),_:1},8,["message"]))}});export{Go as default};
