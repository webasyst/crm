import{d as z,am as oe,B as K,J as P,a as I,N as re,g as S,o as m,c as k,e as i,w as u,m as F,k as d,i as l,F as B,l as H,f as V,U as N,b as A,D as ve,z as ne,p as j,al as me,q as ie,s as de,_ as L,an as pe,ao as fe,h as ue,ap as _e,aq as he,ar as ge,as as ye,at as $e,E as be,Q as we,A as Y,j as Ce,v as Ve,n as X,S as ke}from"./main-ec0df6a4.js";import{W as Se}from"./WaDialog-c7c19903.js";import{C as Ie,I as Ae,_ as De,D as J,u as Fe,a as Ue,b as Ee}from"./InputWithPerformers.vue_vue_type_script_setup_true_lang-3cf71b4b.js";import{f as Ne}from"./fields-5ca407fb.js";import{s as G}from"./dialog-efb0af25.js";import{F as D}from"./FieldString-0827de0f.js";import{d as qe}from"./dayjs-44a66bd3.js";import{a as Oe}from"./index-4793d891.js";import{W as je}from"./WaSpinner-13137cd2.js";import{U as T}from"./UserPic-87c13a4a.js";import{M as ee,_ as ae}from"./MenuList-466c4134.js";import{D as le}from"./DropDown-5d25a522.js";import{u as Re}from"./helpers-a2ed4cd9.js";import{C as xe}from"./CustomColumn-959e6ffe.js";import{B as te}from"./ButtonSubmit-edad645b.js";import"./recentContacts-b91545dc.js";import"./FieldSelect-df2e3574.js";import"./index-8d873219.js";import"./FieldCheckbox-be3e2148.js";const Me={key:0,class:"deal-add-custom-fields"},Te={class:"fields"},Be={class:"name"},ze={class:"value"},Le=z({__name:"FormDealAddSectionFields",props:{modelValue:{}},setup(y){const c=oe(y,"modelValue"),{t:f}=K(),p=P("crm.field.list?scope=deal").get().json(),v=I([]);return re(p.data,e=>{Array.isArray(e)&&(v.value=e.map(a=>(c.value.push({value:{field:a.id,value:""},error:"",...a.is_required?{validate:N.object({value:N.string().min(1,{message:f("validation.required")})}).array()}:{}}),a)))}),(e,a)=>S(c).length?(m(),k("section",Me,[i(Ie,null,{name:u(()=>[F(d(e.$t("addtnlInfo")),1)]),default:u(()=>[l("div",Te,[(m(!0),k(B,null,H(v.value,(_,$)=>(m(),k("div",{key:_.id,class:"field"},[l("div",Be,d(_.name),1),l("div",ze,[(m(),A(ve(S(Ne)[_.type]),{modelValue:S(c)[$].value.value,"onUpdate:modelValue":h=>S(c)[$].value.value=h,vertical:_.type==="radio",options:(_.type==="select"||_.type==="radio")&&_.option_values,required:_.is_required,error:!!S(c)[$].error,"error-message":S(c)[$].error},null,8,["modelValue","onUpdate:modelValue","vertical","options","required","error","error-message"]))])]))),128))])]),_:1})])):V("",!0)}}),We=y=>(ie("data-v-0e95e4dd"),y=y(),de(),y),Ye={class:"deal-add-customer"},He={class:"fields tw-mt-5 tw-mb-5"},Je={class:"field"},Ge={class:"name"},Ke={class:"value"},Pe={key:0,class:"tw-flex tw-gap-x-1 tw-mt-2"},Qe=["disabled","onClick"],Ze=We(()=>l("span",{class:"tw-mr-1"},[l("i",{class:"fas fa-plus-circle"})],-1)),Xe={key:0,class:"fields"},ea={class:"field"},aa={class:"name"},la={class:"value"},ta={class:"field"},sa={class:"name"},oa={class:"value"},ra={class:"field"},na={class:"name"},ia={class:"value"},da={class:"field"},ua={class:"name"},ca={class:"value"},va={class:"field"},ma={class:"name"},pa={class:"value"},fa={class:"field"},_a={class:"name"},ha={class:"value"},ga={class:"field"},ya={class:"name"},$a={class:"value"},ba={class:"field"},wa={class:"name"},Ca={class:"value"},Va=z({__name:"FormDealAddSectionCustomer",props:{initContactId:{}},emits:["updateContactId","updateContactLabel"],setup(y,{expose:w,emit:c}){const f=y,{t:p}=K(),v=I(),e=I(!1),a=I(q()),_=I("");w({validate:R,createContactOrGetExistsId:W,isFetchingContacts:ne(()=>{var s;return(s=v==null?void 0:v.value)==null?void 0:s.isFetchingContacts})});function $(s){var r,t;s?(e.value=!1,a.value={id:{value:s.id},name:{value:s.name},jobtitle:{value:s.jobtitle||""},company:{value:s.company||""},email:{value:((r=s.fields.find(o=>o.id==="email"))==null?void 0:r.value[0])??""},phone:{value:((t=s.fields.find(o=>o.id==="phone"))==null?void 0:t.value[0])??""}}):a.value=q(),c("updateContactId",(s==null?void 0:s.id)||null)}function h(){var s;e.value||(e.value=!0,(s=v.value)==null||s.clearValue(),_.value="",c("updateContactId",null))}function q(){return{id:{value:null,is_required:!e.value,validate:N.coerce.number().min(1,{message:p("validation.required")})},name:{value:""},firstname:{value:"",is_required:!0,validate:N.string().trim().min(1,{message:p("validation.required")})},middlename:{value:""},lastname:{value:""},jobtitle:{value:""},company:{value:""},email:{value:""},phone:{value:""},is_company:{value:0}}}function R(){let s=!1;return Object.entries(a.value).forEach(([,r])=>{if(r.error="",r.is_required&&r.validate)try{r.validate.parse(r.value)}catch(t){t instanceof N.ZodError&&(r.error=t.issues[0].message,s=!0)}}),s?(G(),!1):!0}async function W(){var o;if((o=a.value.id)!=null&&o.value)return a.value.id.value;if(a.value.name.value||(a.value.name.value=`${a.value.firstname.value} ${a.value.middlename.value} ${a.value.lastname.value}`),!R())return null;const s=[];Object.entries(a.value).forEach(([g,C])=>{g!=="id"&&s.push({field:g,value:C.value})});const{data:r,error:t}=await P("crm.contact.add",{onFetchError(g){var C;return typeof g.data=="string"&&((C=JSON.parse(g.data).error_fields)==null||C.forEach(n=>{if(a.value){if(n.field==="name")a.value.firstname.error=n.description;else if(n.field){const O=n.field;a.value[O].error=n.description}}})),g}}).post(JSON.stringify(s));return t.value?null:Number(r.value)||null}return(s,r)=>(m(),k("section",Ye,[l("div",He,[l("div",Je,[l("div",Ge,d(s.$t("customers")),1),l("div",Ke,[i(Ae,{ref_key:"inputWithCustomersRef",ref:v,width:"320px",placeholder:s.$t("searchByNameEmailPhone"),"with-fields":["email","phone","company","jobtitle"],"init-contact-id":f.initContactId,disabled:!!f.initContactId,error:!!a.value.id.error,"error-message":a.value.id.error,onUpdate:$,onClear:r[0]||(r[0]=t=>$(null))},null,8,["placeholder","init-contact-id","disabled","error","error-message"]),f.initContactId?V("",!0):(m(),k("div",Pe,[l("span",null,d(s.$t("or")),1),l("a",{class:"tw-font-semibold",disabled:e.value,onClick:j(h,["prevent"])},[Ze,l("span",null,d(s.$t("addNew")),1)],8,Qe)]))])])]),i(me,{name:"fade",mode:"out-in"},{default:u(()=>[e.value||a.value.id.value?(m(),k("div",Xe,[e.value?(m(),k(B,{key:0},[l("h3",null,d(s.$t("addContact")),1),l("div",ea,[l("div",aa,d(s.$t("firstName")),1),l("div",la,[i(D,{modelValue:a.value.firstname.value,"onUpdate:modelValue":r[1]||(r[1]=t=>a.value.firstname.value=t),type:"text",readonly:!e.value,error:!!a.value.firstname.error,"error-message":a.value.firstname.error,onKeydown:r[2]||(r[2]=t=>a.value.firstname.error="")},null,8,["modelValue","readonly","error","error-message"])])]),l("div",ta,[l("div",sa,d(s.$t("middleName")),1),l("div",oa,[i(D,{modelValue:a.value.middlename.value,"onUpdate:modelValue":r[3]||(r[3]=t=>a.value.middlename.value=t),type:"text",readonly:!e.value,error:!!a.value.middlename.error,"error-message":a.value.middlename.error},null,8,["modelValue","readonly","error","error-message"])])]),l("div",ra,[l("div",na,d(s.$t("lastName")),1),l("div",ia,[i(D,{modelValue:a.value.lastname.value,"onUpdate:modelValue":r[4]||(r[4]=t=>a.value.lastname.value=t),type:"text",readonly:!e.value,error:!!a.value.lastname.error,"error-message":a.value.lastname.error},null,8,["modelValue","readonly","error","error-message"])])])],64)):V("",!0),l("div",da,[l("div",ua,d(s.$t("company")),1),l("div",ca,[i(D,{modelValue:a.value.company.value,"onUpdate:modelValue":r[5]||(r[5]=t=>a.value.company.value=t),type:"text",readonly:!e.value,error:!!a.value.company.error,"error-message":a.value.company.error},null,8,["modelValue","readonly","error","error-message"])])]),l("div",va,[l("div",ma,d(s.$t("jobTitle")),1),l("div",pa,[i(D,{modelValue:a.value.jobtitle.value,"onUpdate:modelValue":r[6]||(r[6]=t=>a.value.jobtitle.value=t),type:"text",readonly:!e.value,error:!!a.value.jobtitle.error,"error-message":a.value.jobtitle.error},null,8,["modelValue","readonly","error","error-message"])])]),l("div",fa,[l("div",_a,d(s.$t("roleInDeal")),1),l("div",ha,[i(De,{modelValue:_.value,"onUpdate:modelValue":[r[7]||(r[7]=t=>_.value=t),r[8]||(r[8]=t=>c("updateContactLabel",t))],scope:"CLIENT",right:!1,width:"320px"},null,8,["modelValue"])])]),l("div",ga,[l("div",ya,d(s.$t("phone")),1),l("div",$a,[i(D,{modelValue:a.value.phone.value,"onUpdate:modelValue":r[9]||(r[9]=t=>a.value.phone.value=t),type:"text",readonly:!e.value,error:!!a.value.phone.error,"error-message":a.value.phone.error},null,8,["modelValue","readonly","error","error-message"])])]),l("div",ba,[l("div",wa,d(s.$t("email")),1),l("div",Ca,[i(D,{modelValue:a.value.email.value,"onUpdate:modelValue":r[10]||(r[10]=t=>a.value.email.value=t),type:"email",readonly:!e.value,error:!!a.value.email.error,"error-message":a.value.email.error},null,8,["modelValue","readonly","error","error-message"])])])])):V("",!0)]),_:1})]))}});const ka=L(Va,[["__scopeId","data-v-0e95e4dd"]]),Sa={key:0,class:"state-error-hint tw-mt-1"},Ia=1e3,Aa=26,Da=z({__name:"TextAreaAutoresize",props:{modelValue:{},maxRows:{},error:{type:Boolean},errorMessage:{}},setup(y){const w=y,c=oe(w,"modelValue"),f=I();pe(f,p),fe(f,["change","cut","paste","drop","input"],p);function p(){if(f.value){if((w.maxRows||Ia)*Aa<f.value.scrollHeight)return;f.value.style.height="auto",f.value.style.height=f.value.scrollHeight+"px"}}return(v,e)=>(m(),k(B,null,[ue(l("textarea",he({ref_key:"textAreaRef",ref:f,"onUpdate:modelValue":e[0]||(e[0]=a=>ge(c)?c.value=a:null),rows:"1",class:{"state-error":w.error}},v.$attrs),null,16),[[_e,S(c)]]),w.error?(m(),k("div",Sa,d(w.errorMessage),1)):V("",!0)],64))}});const se=L(Da,[["__scopeId","data-v-03223436"]]),Fa={class:"select-funnel-and-stage"},Ua=["onClick"],Ea={class:"icon small"},Na=["onClick"],qa={class:"icon small"},Oa=z({__name:"SelectFunnelAndStage",props:{funnelId:{}},emits:["updateStageId"],setup(y,{emit:w}){const c=y,f=Re(),p=ye(f,"funnels");p.value.length||f.refetch();const v=I(),e=I();return $e(()=>p.value.length,()=>{const a=p.value[0];v.value=p.value.find(_=>_.id===c.funnelId)||a,e.value=v.value.stages[0],e.value&&w("updateStageId",e.value.id)},{immediate:!0}),re(e,a=>{a&&w("updateStageId",a.id)}),(a,_)=>(m(),k("div",Fa,[!p.value.length||p.value.length>1?(m(),A(le,{key:0,class:"select-dropdown"},{body:u(({hide:$})=>[p.value.length?(m(),A(ee,{key:0},{default:u(()=>[(m(!0),k(B,null,H(p.value,h=>(m(),A(ae,{key:h.id},{default:u(()=>[l("a",{onClick:j(q=>{v.value=h,e.value=h.stages[0],$()},["prevent"])},[l("div",Ea,[i(T,{size:10,"disable-rounded":"","bg-color":h.color},null,8,["bg-color"])]),l("span",null,d(h.name),1)],8,Ua)]),_:2},1024))),128))]),_:2},1024)):V("",!0)]),default:u(()=>[i(J,{"color-class":"blank","mobile-w-full":"","is-skeleton":!p.value.length},{icon:u(()=>[v.value?(m(),A(T,{key:v.value.id,size:10,"disable-rounded":"","bg-color":v.value.color},null,8,["bg-color"])):V("",!0)]),title:u(()=>[F(d(v.value?v.value.name:a.$t("allStages")),1)]),_:1},8,["is-skeleton"])]),_:1})):V("",!0),i(le,{class:"select-dropdown",disabled:!e.value},{body:u(({hide:$})=>[v.value?(m(),A(ee,{key:0},{default:u(()=>[(m(!0),k(B,null,H(v.value.stages,h=>(m(),A(ae,{key:h.id},{default:u(()=>[l("a",{onClick:j(q=>{e.value=h,$()},["prevent"])},[l("div",qa,[i(T,{size:10,"disable-rounded":"","bg-color":h.color},null,8,["bg-color"])]),l("span",null,d(h.name),1)],8,Na)]),_:2},1024))),128))]),_:2},1024)):V("",!0)]),default:u(()=>[i(J,{"color-class":"blank","mobile-w-full":"","is-skeleton":!p.value.length},{icon:u(()=>[e.value?(m(),A(T,{key:e.value.id,size:10,"disable-rounded":"","bg-color":e.value.color},null,8,["bg-color"])):V("",!0)]),title:u(()=>[F(d(e.value?e.value.name:a.$t("allStages")),1)]),_:1},8,["is-skeleton"])]),_:1},8,["disabled"])]))}});const ja=L(Oa,[["__scopeId","data-v-1e42d921"]]),Ra=y=>(ie("data-v-79a70198"),y=y(),de(),y),xa={class:"deal-add-main"},Ma={class:"fields"},Ta={class:"field"},Ba={class:"name"},za={class:"value"},La={class:"field"},Wa={class:"name"},Ya={class:"value"},Ha={class:"field"},Ja={class:"name"},Ga={class:"value"},Ka={class:"field"},Pa={class:"name"},Qa={class:"value"},Za={class:"field-amount-wrapper"},Xa={key:0,class:"hint break-word"},el=["href"],al=Ra(()=>l("i",{class:"fas fa-external-link-alt fa-sm"},null,-1)),ll={class:"field"},tl={class:"name"},sl={class:"value"},ol={class:"field"},rl={class:"tw-flex tw-gap-x-3 tw-mr-2"},nl={class:"state-error-hint"},il=z({__name:"FormDealAdd",props:{funnelId:{},contactId:{},disableNavigateToDeal:{type:Boolean},onAdded:{type:Function}},emits:["close"],setup(y,{emit:w}){const c=y,{t:f}=K(),p=be(),v=we(Oe),e=I({stage_id:{value:null,is_required:!0},name:{value:"",is_required:!0,validate:N.string().trim().min(1,{message:f("validation.required")})},description:{value:""},expected_date:{value:qe().add(2,"w").format("YYYY-MM-DD")},amount:{value:""},currency_id:{value:""},contact_id:{value:Number(c.contactId)||null},contact_label:{value:""},user_contact_id:{value:Y.user.id},fields:[]}),a=I(new Map),_=I(""),$=I(null),h=ne(()=>Fe().isEmptyCurrencies);function q(){var o;let t=!1;return Object.entries(e.value).forEach(([,g])=>{if(g.error="",g.is_required&&g.validate)try{g.validate.parse(g.value)}catch(C){C instanceof N.ZodError&&(g.error=C.issues[0].message,t=!0)}}),t||!((o=$.value)!=null&&o.validate())?(G(),!1):!0}async function R(t){var O,Q;if(a.value.clear(),_.value="",!q())return null;a.value.set(t,!0);const o=await((O=$.value)==null?void 0:O.createContactOrGetExistsId());if(!o)return a.value.clear(),null;e.value.contact_id.value=o;const g=new Map;Object.keys(e.value).forEach(M=>{const U=M,E=e.value[U];if(Array.isArray(E))g.set(U,E.filter(b=>b.value.value).map(b=>({field:b.value.field,value:b.value.value})));else if(E!=null&&E.value){let{value:b}=E;U==="description"&&(b=b.replace(/\n/g,"<br>")),g.set(U,b)}});const{data:C,response:x,error:n}=await P("crm.deal.add",{onFetchError(M){var U;return typeof M.data=="string"&&((U=JSON.parse(M.data).error_fields)==null||U.forEach(b=>{if(b.code==="fields"){const Z=e.value.fields.find(ce=>ce.value.field===b.field);Z&&(Z.error=b.description)}else b.field in e.value&&(e.value[b.field].error=b.description)}),G()),M}}).post(Object.fromEntries(g));return(Q=x.value)!=null&&Q.ok&&C.value?(a.value.clear(),w("close"),Number(C.value)):(_.value=n.value,a.value.clear(),null)}function W(){ke.emit("spa:navigateBack"),w("close")}async function s(){await R("create")&&typeof c.onAdded=="function"&&c.onAdded()}async function r(){const t=await R("createAndOpen");t&&(typeof c.onAdded=="function"&&c.onAdded(),c.disableNavigateToDeal||p.push({name:"deal",params:{id:t}}))}return(t,o)=>{const g=Ce("i18n-t");return m(),A(Se,{"vertical-stretch":!0,"use-cancel-as-button-label":!0,"hide-close-icon":"",onClose:W},{header:u(()=>[F(d(t.$t("newDeal")),1)]),default:u(()=>{var C,x;return[ue(i(xe,{space:"4",class:"tw-relative tw-h-full"},{default:u(()=>[l("section",xa,[l("div",Ma,[l("div",Ta,[l("div",Ba,d(t.$t("title")),1),l("div",za,[i(se,{modelValue:e.value.name.value,"onUpdate:modelValue":o[0]||(o[0]=n=>e.value.name.value=n),class:"field-title-textarea tw-font-bold","aria-required":"true","max-rows":10,error:!!e.value.name.error,"error-message":e.value.name.error,onKeydown:o[1]||(o[1]=n=>e.value.name.error="")},null,8,["modelValue","error","error-message"])])]),l("div",La,[l("div",Wa,d(t.$t("currentStage")),1),l("div",Ya,[i(ja,{"funnel-id":c.funnelId,onUpdateStageId:o[2]||(o[2]=n=>e.value.stage_id.value=n)},null,8,["funnel-id"])])]),l("div",Ha,[l("div",Ja,d(t.$t("responsible")),1),l("div",Ga,[i(Ue,{contact:S(Y).user,width:"320px",class:"width-100 tw-h-[30px]","hide-clear":"",onUpdate:o[3]||(o[3]=n=>e.value.user_contact_id.value=n.id)},{preview:u(({model:n,showInput:O})=>[i(J,{class:"tw-pl-1","color-class":"blank","mobile-w-full":"",onClick:j(O,["prevent"])},{icon:u(()=>[i(T,{size:20,url:n.userpic},null,8,["url"])]),title:u(()=>[F(d(n.name),1)]),_:2},1032,["onClick"])]),_:1},8,["contact"])])]),l("div",Ka,[l("div",Pa,d(t.$t("estimatedAmount")),1),l("div",Qa,[l("div",Za,[i(D,{modelValue:e.value.amount.value,"onUpdate:modelValue":o[4]||(o[4]=n=>e.value.amount.value=n),error:!!e.value.amount.error,"error-message":e.value.amount.error,disabled:h.value,class:"!tw-text-left",min:"0",type:"number"},null,8,["modelValue","error","error-message","disabled"]),i(Ee,{"model-value":e.value.currency_id.value,error:!!e.value.currency_id.error,"error-message":e.value.currency_id.error,disabled:h.value,required:!h.value,"onUpdate:modelValue":o[5]||(o[5]=n=>e.value.currency_id.value=n)},null,8,["model-value","error","error-message","disabled","required"])]),h.value?(m(),k("div",Xa,[i(g,{keypath:"currenciesNotSetUp"},{default:u(()=>[l("a",{class:X(t.$constant.parentAppDisableRouterClass),href:`${S(Y).baseUrl}settings/currencies/`,target:"_blank"},[F(d(t.$t("settingsCurrencies"))+" ",1),al],10,el)]),_:1})])):V("",!0)])]),l("div",ll,[l("div",tl,d(t.$t("expectedCloseDate")),1),l("div",sl,[i(D,{modelValue:e.value.expected_date.value,"onUpdate:modelValue":o[6]||(o[6]=n=>e.value.expected_date.value=n),type:"date",class:"!tw-w-auto",error:!!e.value.expected_date.error,"error-message":e.value.expected_date.error},null,8,["modelValue","error","error-message"])])]),l("div",ol,[i(se,{modelValue:e.value.description.value,"onUpdate:modelValue":o[7]||(o[7]=n=>e.value.description.value=n),class:"field-description-textarea",rows:"2",placeholder:t.$t("dealDescr"),error:!!e.value.description.error,"error-message":e.value.description.error,onKeydown:o[8]||(o[8]=n=>e.value.description.error="")},null,8,["modelValue","placeholder","error","error-message"])])])]),i(ka,{ref_key:"formDealAddSectionCustomerRef",ref:$,"init-contact-id":Number(c.contactId),class:"tw-pb-1",onUpdateContactId:o[9]||(o[9]=n=>e.value.contact_id.value=n),onUpdateContactLabel:o[10]||(o[10]=n=>e.value.contact_label.value=n)},null,8,["init-contact-id"]),i(Le,{modelValue:e.value.fields,"onUpdate:modelValue":o[11]||(o[11]=n=>e.value.fields=n),class:"tw-pb-7"},null,8,["modelValue"])]),_:1},512),[[Ve,!((C=$.value)!=null&&C.isFetchingContacts)]]),(x=$.value)!=null&&x.isFetchingContacts?(m(),A(je,{key:0})):V("",!0)]}),submit:u(()=>[l("div",rl,[i(te,{"is-fetching":a.value.get("createAndOpen"),class:X([S(v)?"blue":"gray"]),onClick:j(r,["prevent"])},{default:u(()=>[F(d(t.$t(S(v)?"create":"createAndOpen")),1)]),_:1},8,["is-fetching","class","onClick"]),S(v)?V("",!0):(m(),A(te,{key:0,"is-fetching":a.value.get("create"),onClick:j(s,["prevent"])},{default:u(()=>[F(d(t.$t("create")),1)]),_:1},8,["is-fetching","onClick"]))])]),error:u(()=>[l("span",nl,d(_.value),1)]),_:1})}}});const Al=L(il,[["__scopeId","data-v-79a70198"]]);export{Al as default};
