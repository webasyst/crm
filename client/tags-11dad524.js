import{u as se,O as K,a as m,z as b,L as X,aR as Z,A as O,W as ee,J as k,N as C,aa as te,t as le,ai as ue,aS as H,ah as ie,a8 as ce,x as re}from"./main-ec0df6a4.js";import{d as M,u as q,r as z}from"./helpers-a2ed4cd9.js";const ae="list",R={list:"dealsList",kanban:"dealsKanban"},B=se("crm/deals/view",ae),W=K("dealsTabs",()=>{const t=m(),a=b(()=>t.value==="list"),i=b(()=>t.value==="kanban"),l=b(()=>B.value?R[B.value]:R.list),_=b(()=>Object.keys(R).reduce((S,u)=>({...S,[R[u]]:u}),{}));X(()=>{!t.value||B.value===t.value||(B.value=t.value)});function f(S){let u=R[B.value]||R[ae];return S==="deals"?(t.value=_.value[u],u):(u=S,t.value=B.value=_.value[u],u)}return{currentView:t,isList:a,isKanban:i,lastRouteNameTab:l,changeRouteTab:f}}),Y=30,Q={sort:"create_datetime",asc:0},oe=K("dealsList",()=>{var $;const t=["funnel","stage","tag","user_id"],a=m([]),i=m(),l=m(0),_=m(0),f=U(),{bulkSelectMode:S,useSelectNone:u,bulkSelectIds:y,bulkSelectToggle:r}=Z(a);S.value=!0,u.value=!0;const s=m({sort:(($=O.deal_list_sort)==null?void 0:$.field)||Q.sort,asc:O.deal_list_sort?O.deal_list_sort.asc?1:0:Q.asc}),I=m(M(s.value)),L={fields:["last_action"],limit:Y,offset:0},v=m({...f.filterParams,...s.value,...L}),h=m(!1),P=b(()=>`crm.deal.list?${ee.stringify(v.value)}`),{data:D,isFetching:g,error:F,execute:p,canAbort:w,abort:e}=k(P,{immediate:!1,refetch:!1}).get().json();C(P,d),C(D,o=>{if(o!=null&&o.params){if(Array.isArray(o.data)){const V=o.data;i.value&&o.params.offset>_.value?(a.value=[...a.value,...V],_.value=o.params.offset):i.value&&o.params.offset<l.value?(a.value=[...V,...a.value],l.value=o.params.offset):(a.value=V,_.value=l.value=o.params.offset)}i.value=o.params}else o!=null&&o.error&&console.log(o.error);h.value=!1});const n=b(()=>g.value&&!h.value);function d(){w.value&&e(),p()}function A(){w.value||a.value.length||d()}function N(){a.value=[],v.value.offset=0}function c(o){v.value={...L,...s.value,...o}}function E(){h.value=!0,c({...v.value,offset:l.value-Y})}function T(){h.value=!0,c({...v.value,offset:_.value+Y})}async function j(o){s.value={...s.value,...o},JSON.stringify(s.value)!==JSON.stringify(I.value)&&(c(s.value),await f.saveUserSettings({deal_list_sort:{field:s.value.sort,asc:!!s.value.asc}}),I.value=M(s.value))}function x(o){s.value.sort===o?s.value.asc=s.value.asc===1?0:1:(s.value.sort=o,s.value.asc=0),j()}return{ALLOWED_FILTER_KEYS:t,deals:a,isFetching:g,isRefreshPage:n,error:F,fetchParams:v,previousFetchParams:i,prevOffset:l,nextOffset:_,sort:s,fetchPrevPage:E,fetchNextPage:T,init:A,reinit:d,$reset:N,updateFetchParams:c,toggleSort:x,updateSort:j,bulkSelectIds:y,bulkSelectToggle:r}}),ne=15,J=K("dealsKanban",()=>{const t=["tag","user_id"],a=te({}),i=b({get(){const e=[];return Object.keys(a).length&&Object.values(a).forEach(n=>{e.push(...n.deals)}),e},set(){Object.values(a).forEach(e=>{e.deals=[]})}}),l=U(),{bulkSelectMode:_,useSelectNone:f,bulkSelectIds:S,bulkSelectToggle:u}=Z(i);_.value=!0,f.value=!0;const y=m(),r={offset:0,limit:ne,sort:"reminder_datetime",asc:1},s=m({...l.filterParams,...r}),I=m(null),L=q(),{isFinished:v,funnels:h}=le(L),P=b(()=>I.value!==null&&I.value>0),D=b(()=>v.value);C(v,F),C(s,F);function g(){P.value||i.value.length||F()}function F(){if(!v.value)return;const e=s.value.funnel?L.getFunnelById(s.value.funnel):null;e||h.value.length&&l.updateFilterParams({funnel:h.value[0].id}),e!=null&&e.stages&&(y.value!==e.id&&z(a,"all"),y.value=e.id,I.value=0,i.value=[],e.stages.forEach(n=>{const d=a;d[n.id]=fe(n,{countFetch:I,deals:i,fetchParams:s.value})}))}function p(){i.value=[],s.value.offset=0}function w(e){const n={...e};z(n,["stage"]);const d={...r,...n};return JSON.stringify(s.value)===JSON.stringify(d)?!1:(s.value=d,!0)}return{ALLOWED_FILTER_KEYS:t,deals:i,columnsDeals:a,fetchParams:s,isFetching:P,isCachedFunnels:D,init:g,reinit:F,$reset:p,updateFetchParams:w,bulkSelectIds:S,bulkSelectToggle:u}});function fe(t,a){const i=m(0),l=m(0),_=m(!1),f=m([]),S=b(()=>f.value.reduce((e,n)=>({...e,[n.id]:!0}),{})),u=m({...a.fetchParams,stage:t.id}),y=m(),r=b(()=>`crm.deal.list?${ee.stringify(u.value)}`),s=b(()=>{var e,n;return l.value+(((e=y.value)==null?void 0:e.limit)??0)<(((n=y.value)==null?void 0:n.total_count)??0)}),{data:I,isFetching:L,error:v,execute:h,canAbort:P,abort:D}=k(r,{immediate:!1,refetch:!1}).get().json();g(),C(r,()=>{u.value.offset!==0&&g()}),C(I,e=>{if(a.countFetch.value--,e!=null&&e.params){if(Array.isArray(e.data)){const n=e.data;n.forEach((d,A)=>{S.value[d.id]&&n.splice(A,1)}),y.value&&e.params.offset>l.value?(f.value=[...f.value,...n],l.value=e.params.offset):y.value&&e.params.offset<i.value?(f.value=[...n,...f.value],i.value=e.params.offset):(f.value=n,l.value=i.value=e.params.offset)}y.value=e.params}else e!=null&&e.error&&console.log(e.error);_.value=!1});async function g(){P.value&&D(),a.countFetch.value++,await h()}async function F(){u.value.offset=0,await g()}function p(e){u.value={...u.value,...e}}function w(){_.value||(_.value=!0,p({offset:l.value+ne}))}return{stage:t,deals:f,isFetching:L,isLazyLoad:_,error:v,hasMoreDeals:s,reload:F,fetchNextPage:w}}const G=["funnel","stage","tag","user_id","asc","sort"],U=K("dealsNav",()=>{var n,d,A,N;const t=m({...(n=O.deal_list_filter)!=null&&n.funnel_id?{funnel:O.deal_list_filter.funnel_id}:{},...(d=O.deal_list_filter)!=null&&d.stage_id?{stage:O.deal_list_filter.stage_id}:{},...(A=O.deal_list_filter)!=null&&A.tag_id?{tag:O.deal_list_filter.tag_id}:{},...(N=O.deal_list_filter)!=null&&N.user_id?{funnel:O.deal_list_filter.user_id}:{}}),a=m(M(t.value)),i=m(),l=b(()=>ue().isFinished&&q().isFinished&&ge().isFinished),_=b(()=>{for(const c in t.value)if(r().ALLOWED_FILTER_KEYS.includes(c))return!0;return!1}),f=b(()=>{const c=r().deals;return i.value=c[0],c}),S=b(()=>r().bulkSelectIds),u=b(()=>S.value.length),y=b(()=>f.value.length===u.value);function r(){return W().isKanban?J():oe()}function s(){g(),r().updateFetchParams(t.value)}function I(c){f.value.forEach(E=>{r().bulkSelectIds=c?[...new Set([...r().bulkSelectIds,E.id])]:[]})}function L(c){t.value={...t.value,...c},D()}function v(c){const E=Object.keys(c);!E.length||!G.some(T=>E.includes(T))?P():(t.value={...c},D())}function h(c){delete t.value[c],D()}function P(){z(t.value,G),D()}async function D(){JSON.stringify(a.value)!==JSON.stringify(t.value)&&(r().updateFetchParams(t.value),await e({deal_list_filter:{funnel_id:t.value.funnel??null,stage_id:t.value.stage??null,tag_id:t.value.tag??null,user_id:t.value.user_id??null}}),a.value=M(t.value))}function g(){r().$reset()}function F(c){const{currentView:E}=W();if(!c||!E)return;const{deals:T}=r();de(c,T,{onStageChange(j){E==="kanban"&&(async()=>{const x=J().columnsDeals[T[j].stage_id],$=J().columnsDeals[c.stage_id],o=x.deals.findIndex(V=>V.id===c.id);$.deals.unshift(x.deals[o]),x.deals.splice(o,1)})()},onStatusChange(j){if(E==="kanban"){const x=J().columnsDeals[T[j].stage_id],$=x.deals.findIndex(o=>o.id===c.id);x.deals.splice($,1)}}})}function p(c){if(W().currentView){const E=r().deals;E.length&&(r().deals=E.filter(T=>!c.includes(T.id)))}}function w(){r().reinit()}async function e(c){return await k("crm.user.settings.save").patch(c)}return{firstDeal:H(i),filterParams:H(t),filtersIsLoaded:l,hasFilters:_,deals:f,countChecked:u,isAllChecked:y,bulkSelectIds:S,$resetDeals:g,changeTabView:s,clearFilters:P,toggleChecked:I,updateFilterParams:L,deleteFilterParam:h,updateOrClearFilterParams:v,updateDealInList:F,deleteDealsByIdsInList:p,reinitView:w,saveUserSettings:e}});function de(t,a,i){var _,f,S;if(!a.length)return;const l=a.findIndex(u=>u.id===t.id);if(l!==-1){if(a[l].stage_id!==t.stage_id){typeof(i==null?void 0:i.onStageChange)=="function"&&i.onStageChange.call(null,l);const u=q().getFunnelById(t.funnel_id);u&&(a[l]={...a[l],funnel:u,stage:{...a[l].stage,...(_=u.stages)==null?void 0:_.find(y=>y.id===t.stage_id)},funnel_id:t.funnel_id,stage_id:t.stage_id})}a[l].status_id!==t.status_id&&typeof(i==null?void 0:i.onStatusChange)=="function"&&i.onStatusChange.call(null,l),a[l].contact=((f=t.contacts.find(u=>u.contact.id===t.contact_id))==null?void 0:f.contact)||null,a[l].user=((S=t.users.find(u=>u.contact.id===t.user_contact_id))==null?void 0:S.contact)||null,a[l].original_amount!==t.amount&&(a[l].original_amount=t.amount),a[l].original_currency_id!==t.currency_id&&(a[l].original_currency_id=t.currency_id),a[l]={...a[l],name:t.name,expected_date:t.expected_date,status_id:t.status_id,tags:t.tags,lost_id:t.lost_id,lost_text:t.lost_text,update_datetime:new Date().toISOString()}}}const ve=K("deal",()=>{const t=m(null),a=m(null),i=te({name:!1,description:!1}),{data:l,isFetching:_,error:f,canAbort:S,abort:u,execute:y}=k(b(()=>`crm.deal.info?id=${a.value}`),{immediate:!1,refetch:!1}).get().json();C(l,e=>{e&&"id"in e&&("contacts"in e||Object.assign(e,{contacts:[]}),"users"in e||Object.assign(e,{users:[]}),t.value=e)}),ie(t,e=>{e&&U().updateDealInList(e)},{deep:!0,debounce:700});function r(){S.value&&u(),setTimeout(()=>{y()},0)}function s(){a.value=null,t.value=null}function I(e){s(),a.value=Number(e),r()}async function L(e){var N;const n={ok:!0,data:"no change"},{data:d,response:A}=await k(`crm.deal.patch?id=${a.value}`,{method:"PATCH",body:JSON.stringify(e)},{onFetchError(c){return n.ok=!1,n.data=c.data,c}}).json();return(N=A.value)!=null&&N.ok&&d.value&&(n.data=d.value),n}async function v(e){const n=await L(e);return n.ok&&Array.isArray(n.data)&&n.data.forEach(d=>{const A=t.value;let N=d.data;d.type==="number"&&(N=Number(d.data)),A[d.id]=N}),n}async function h(e){var d;const n=await L([{field:"description",value:e}]);return n.ok&&n.data!=="no change"&&(n.data.forEach(A=>{if(t.value){const N=A.id;t.value[N]=A.data||""}}),((d=t.value)==null?void 0:d.description)===""&&(t.value={...t.value,description_plain:"",description_sanitized:""})),n}function P(e){return v([{field:"name",value:e}])}function D(e){return v([{field:"amount",value:e.amount},{field:"currency_id",value:e.currency_id}])}function g(e){return v([{field:"expected_date",value:e}])}function F(e){t.value&&(t.value={...t.value,...e})}function p(e){const n={...e,deal_id:a.value};return k("crm.deal.participant.add",{immediate:!1,refetch:!1}).post(n).json()}function w(e,n=!1){const d=`deal_id=${a.value}&contact_id=${e.contact_id}&role_id=${e.role_id}`;return k(`crm.deal.participant.delete?${d}`,{immediate:!1,refetch:!1}).delete(n?{force:n}:null).json()}return{deal:t,fetchId:a,isFetching:_,error:f,eventEditing:i,refetch:r,fetchById:I,$reset:s,updateDeal:F,basePatchRequest:L,changeDescription:h,changeName:P,changeAmountAndCurrency:D,changeExpectedDate:g,upsertParticipant:p,deleteParticipant:w}}),ge=K("tags",()=>{const t=m([]),{data:a,isFetching:i,error:l,execute:_,isFinished:f}=k("crm.tag.list").get().json(),S=b(()=>r=>t.value.find(s=>s.id===+r));X(()=>{Array.isArray(a.value)&&(t.value=a.value)});function u(){f.value&&_()}function y(r,s,I,L){return k("crm.tag.assign",{immediate:!1,afterFetch(v){if(Array.isArray(v.data)){if(L&&u(),r==="contact"){const h=ce();h.contact&&s.includes(h.contact.id)&&(h.contact.tags=[...new Set([...h.contact.tags,...v.data])]);const P=re();for(const D of s){const g=P.contacts.find(F=>F.id===D);g&&g.tags&&(g.tags=[...new Set([...g.tags,...v.data])])}}if(r==="deal"){const h=ve();h.deal&&s.includes(h.deal.id)&&(h.deal.tags=[...new Set([...h.deal.tags,...v.data])]);const P=U();for(const D of s){const g=P.deals.find(F=>F.id===D);if(g){g.tags||(g.tags=[]);const F=g.tags.reduce((p,w)=>({...p,[w.id]:!0}),{});g.tags=[...g.tags,...v.data.filter(p=>!F[p.id]).map(p=>({id:p.id,name:p.name,count:p.count}))]}}}}return v}}).post({[`${r}_id`]:s,tag:I}).json()}return{tags:t,isFetching:i,error:l,isFinished:f,getTagById:S,refetch:u,tagAssign:y}});export{Q as L,G as Q,R as T,de as a,ve as b,U as c,W as d,oe as e,J as f,ge as u};
