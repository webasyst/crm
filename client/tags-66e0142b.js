import{u as le,Q as K,a as h,z as y,N as Z,aU as ee,A as N,$ as te,M as k,P as j,ac as ae,t as ue,ak as ie,aV as q,D as H,aj as ce,E as re,x as oe}from"./main-ad3d4b2a.js";import{u as Q}from"./funnels-5e77cb0b.js";import{f as M,r as z}from"./helpers-c0c14d27.js";const ne="list",R={list:"dealsList",kanban:"dealsKanban"},B=le("crm/deals/view",ne),W=K("dealsTabs",()=>{const e=h(),a=y(()=>e.value==="list"),r=y(()=>e.value==="kanban"),l=y(()=>B.value?R[B.value]:R.list),_=y(()=>Object.keys(R).reduce((b,c)=>({...b,[R[c]]:c}),{}));Z(()=>{!e.value||B.value===e.value||(B.value=e.value)});function f(b){let c=R[B.value]||R[ne];return b==="deals"?(e.value=_.value[c],c):(c=b,e.value=B.value=_.value[c],c)}return{currentView:e,isList:a,isKanban:r,lastRouteNameTab:l,changeRouteTab:f}}),Y=30,G={sort:"create_datetime",asc:0},fe=K("dealsList",()=>{var $;const e=["funnel","stage","tag","user_id"],a=h([]),r=h(),l=h(0),_=h(0),f=U(),{bulkSelectMode:b,useSelectNone:c,bulkSelectIds:F,bulkSelectToggle:o}=ee(a);b.value=!0,c.value=!0;const s=h({sort:(($=N.deal_list_sort)==null?void 0:$.field)||G.sort,asc:N.deal_list_sort?N.deal_list_sort.asc?1:0:G.asc}),D=h(M(s.value)),L={fields:["last_action"],limit:Y,offset:0},v=h({...f.filterParams,...s.value,...L}),g=h(!1),I=y(()=>`crm.deal.list?${te.stringify(v.value)}`),{data:A,isFetching:m,error:p,execute:P,canAbort:w,abort:n}=k(I,{immediate:!1,refetch:!1}).get().json();j(I,u),j(A,d=>{if(d!=null&&d.params){if(Array.isArray(d.data)){const V=d.data;r.value&&d.params.offset>_.value?(a.value=[...a.value,...V],_.value=d.params.offset):r.value&&d.params.offset<l.value?(a.value=[...V,...a.value],l.value=d.params.offset):(a.value=V,_.value=l.value=d.params.offset)}r.value=d.params}else d!=null&&d.error&&console.log(d.error);g.value=!1});const t=y(()=>m.value&&!g.value);function u(){w.value&&n(),P()}function S(){w.value||a.value.length||u()}function T(){a.value=[],v.value.offset=0}function i(d){v.value={...L,...s.value,...d}}function E(){g.value=!0,i({...v.value,offset:l.value-Y})}function O(){g.value=!0,i({...v.value,offset:_.value+Y})}async function x(d){s.value={...s.value,...d},JSON.stringify(s.value)!==JSON.stringify(D.value)&&(i(s.value),await f.saveUserSettings({deal_list_sort:{field:s.value.sort,asc:!!s.value.asc}}),D.value=M(s.value))}function C(d){s.value.sort===d?s.value.asc=s.value.asc===1?0:1:(s.value.sort=d,s.value.asc=0),x()}return{ALLOWED_FILTER_KEYS:e,deals:a,isFetching:m,isRefreshPage:t,error:p,fetchParams:v,previousFetchParams:r,prevOffset:l,nextOffset:_,sort:s,fetchPrevPage:E,fetchNextPage:O,init:S,reinit:u,$reset:T,updateFetchParams:i,toggleSort:C,updateSort:x,bulkSelectIds:F,bulkSelectToggle:o}}),se=15,J=K("dealsKanban",()=>{const e=["tag","user_id"],a=ae({}),r=y({get(){const n=[];return Object.keys(a).length&&Object.values(a).forEach(t=>{n.push(...t.deals)}),n},set(){Object.values(a).forEach(n=>{n.deals=[]})}}),l=U(),{bulkSelectMode:_,useSelectNone:f,bulkSelectIds:b,bulkSelectToggle:c}=ee(r);_.value=!0,f.value=!0;const F=h(),o={offset:0,limit:se,sort:"reminder_datetime",asc:1},s=h({...l.filterParams,...o}),D=h(null),L=Q(),{isFinished:v,funnels:g}=ue(L),I=y(()=>D.value!==null&&D.value>0),A=y(()=>v.value);j(v,p),j(s,p);function m(){I.value||r.value.length||p()}function p(){if(!v.value)return;const n=s.value.funnel?L.getFunnelById(s.value.funnel):null;n||g.value.length&&l.updateFilterParams({funnel:g.value[0].id}),n!=null&&n.stages&&(F.value!==n.id&&z(a,"all"),F.value=n.id,D.value=0,r.value=[],n.stages.forEach(t=>{const u=a;u[t.id]=de(t,{countFetch:D,deals:r,fetchParams:s.value})}))}function P(){r.value=[],s.value.offset=0}function w(n){const t={...n};z(t,["stage"]);const u={...o,...t};return JSON.stringify(s.value)===JSON.stringify(u)?!1:(s.value=u,!0)}return{ALLOWED_FILTER_KEYS:e,deals:r,columnsDeals:a,fetchParams:s,isFetching:I,isCachedFunnels:A,init:m,reinit:p,$reset:P,updateFetchParams:w,bulkSelectIds:b,bulkSelectToggle:c}});function de(e,a){const r=h(0),l=h(0),_=h(!1),f=h([]),b=y(()=>f.value.reduce((n,t)=>({...n,[t.id]:!0}),{})),c=h({...a.fetchParams,stage:e.id}),F=h(),o=y(()=>`crm.deal.list?${te.stringify(c.value)}`),s=y(()=>{var n,t;return l.value+(((n=F.value)==null?void 0:n.limit)??0)<(((t=F.value)==null?void 0:t.total_count)??0)}),{data:D,isFetching:L,error:v,execute:g,canAbort:I,abort:A}=k(o,{immediate:!1,refetch:!1}).get().json();m(),j(o,()=>{c.value.offset!==0&&m()}),j(D,n=>{if(a.countFetch.value--,n!=null&&n.params){if(Array.isArray(n.data)){const t=n.data;t.forEach((u,S)=>{b.value[u.id]&&t.splice(S,1)}),F.value&&n.params.offset>l.value?(f.value=[...f.value,...t],l.value=n.params.offset):F.value&&n.params.offset<r.value?(f.value=[...t,...f.value],r.value=n.params.offset):(f.value=t,l.value=r.value=n.params.offset)}F.value=n.params}else n!=null&&n.error&&console.log(n.error);_.value=!1});async function m(){I.value&&A(),a.countFetch.value++,await g()}async function p(){c.value.offset=0,await m()}function P(n){c.value={...c.value,...n}}function w(){_.value||(_.value=!0,P({offset:l.value+se}))}return{stage:e,deals:f,isFetching:L,isLazyLoad:_,error:v,hasMoreDeals:s,reload:p,fetchNextPage:w}}const X=["funnel","stage","tag","user_id","asc","sort"],U=K("dealsNav",()=>{var t,u,S,T;const e=h({...(t=N.deal_list_filter)!=null&&t.funnel_id?{funnel:N.deal_list_filter.funnel_id}:{},...(u=N.deal_list_filter)!=null&&u.stage_id?{stage:N.deal_list_filter.stage_id}:{},...(S=N.deal_list_filter)!=null&&S.tag_id?{tag:N.deal_list_filter.tag_id}:{},...(T=N.deal_list_filter)!=null&&T.user_id?{user_id:N.deal_list_filter.user_id}:{}}),a=h(M(e.value)),r=h(),l=y(()=>ie().isFinished&&Q().isFinished&&me().isFinished),_=y(()=>{for(const i in e.value)if(o().ALLOWED_FILTER_KEYS.includes(i))return!0;return!1}),f=y(()=>{const i=o().deals;return r.value=i[0],i}),b=y(()=>o().bulkSelectIds),c=y(()=>b.value.length),F=y(()=>f.value.length===c.value);function o(){return W().isKanban?J():fe()}function s(){m(),o().updateFetchParams(e.value)}function D(i){f.value.forEach(E=>{o().bulkSelectIds=i?[...new Set([...o().bulkSelectIds,E.id])]:[]})}function L(i){e.value={...e.value,...i},A()}function v(i){const E=Object.keys(i);!E.length||!X.some(O=>E.includes(O))?I():(e.value={...i},A())}function g(i){delete e.value[i],A()}function I(){z(e.value,X),A()}async function A(){JSON.stringify(a.value)!==JSON.stringify(e.value)&&(o().updateFetchParams(e.value),await n({deal_list_filter:{funnel_id:e.value.funnel??null,stage_id:e.value.stage??null,tag_id:e.value.tag??null,user_id:e.value.user_id??null}}),a.value=M(e.value))}function m(){o().$reset()}function p(i){const{currentView:E}=W();if(!i||!E)return;const{deals:O}=o();ve(i,O,{onStageChange(x){E==="kanban"&&(async()=>{const C=J().columnsDeals[O[x].stage_id],$=J().columnsDeals[i.stage_id],d=C.deals.findIndex(V=>V.id===i.id);$.deals.unshift(C.deals[d]),C.deals.splice(d,1)})()},onStatusChange(x){if(E==="kanban"){const C=J().columnsDeals[O[x].stage_id],$=C.deals.findIndex(d=>d.id===i.id);C.deals.splice($,1)}}})}function P(i){if(W().currentView){const E=o().deals;E.length&&(o().deals=E.filter(O=>!i.includes(O.id)))}}function w(){o().reinit()}async function n(i){return await k("crm.user.settings.save").patch(i)}return{firstDeal:q(r),filterParams:q(e),filtersIsLoaded:l,hasFilters:_,deals:f,countChecked:c,isAllChecked:F,bulkSelectIds:b,$resetDeals:m,changeTabView:s,clearFilters:I,toggleChecked:D,updateFilterParams:L,deleteFilterParam:g,updateOrClearFilterParams:v,updateDealInList:p,deleteDealsByIdsInList:P,reinitView:w,saveUserSettings:n}});function ve(e,a,r){var _,f,b;if(!a.length)return;const l=a.findIndex(c=>c.id===e.id);if(l!==-1){if(a[l].stage_id!==e.stage_id){typeof(r==null?void 0:r.onStageChange)=="function"&&r.onStageChange.call(null,l);const c=Q().getFunnelById(e.funnel_id);c&&(a[l]={...a[l],funnel:c,stage:{...a[l].stage,...(_=c.stages)==null?void 0:_.find(F=>F.id===e.stage_id)},funnel_id:e.funnel_id,stage_id:e.stage_id})}a[l].status_id!==e.status_id&&typeof(r==null?void 0:r.onStatusChange)=="function"&&r.onStatusChange.call(null,l),a[l].contact=((f=e.contacts.find(c=>c.contact.id===e.contact_id))==null?void 0:f.contact)||null,a[l].user=((b=e.users.find(c=>c.contact.id===e.user_contact_id))==null?void 0:b.contact)||null,a[l].original_amount!==e.amount&&(a[l].original_amount=e.amount),a[l].original_currency_id!==e.currency_id&&(a[l].original_currency_id=e.currency_id),a[l]={...a[l],name:e.name,expected_date:e.expected_date,status_id:e.status_id,tags:e.tags,lost_id:e.lost_id,lost_text:e.lost_text,update_datetime:new Date().toISOString()}}}const ge=K("deal",()=>{const e=h(null),a=h(null),r=ae({name:!1,description:!1}),{data:l,isFetching:_,statusCode:f,error:b,canAbort:c,abort:F,execute:o}=k(y(()=>`crm.deal.info?id=${a.value}`),{immediate:!1,refetch:!1}).get().json();j(l,t=>{var u;t&&"id"in t&&("contacts"in t||Object.assign(t,{contacts:[]}),"users"in t||Object.assign(t,{users:[]}),(u=H)==null||u.setTitle(t.name),e.value=t)}),ce(e,t=>{t&&U().updateDealInList(t)},{deep:!0,debounce:700});function s(){c.value&&F(),setTimeout(()=>{o()},0)}function D(){a.value=null,e.value=null,f.value=null}function L(t){D(),a.value=Number(t),s()}async function v(t){var i;const u={ok:!0,data:"no change"},{data:S,response:T}=await k(`crm.deal.patch?id=${a.value}`,{method:"PATCH",body:JSON.stringify(t)},{onFetchError(E){return u.ok=!1,u.data=E.data,E}}).json();return(i=T.value)!=null&&i.ok&&S.value&&(u.data=S.value),u}async function g(t){const u=await v(t);return u.ok&&Array.isArray(u.data)&&u.data.forEach(S=>{const T=e.value;let i=S.data;S.type==="number"&&(i=Number(S.data)),T[S.id]=i}),u}async function I(t){var S;const u=await v([{field:"description",value:t}]);return u.ok&&u.data!=="no change"&&(u.data.forEach(T=>{if(e.value){const i=T.id;e.value[i]=T.data||""}}),((S=e.value)==null?void 0:S.description)===""&&(e.value={...e.value,description_plain:"",description_sanitized:""})),u}async function A(t){var S;const u=await g([{field:"name",value:t}]);return e.value&&((S=H)==null||S.setTitle(e.value.name)),u}function m(t){return g([{field:"amount",value:t.amount},{field:"currency_id",value:t.currency_id}])}function p(t){return g([{field:"expected_date",value:t}])}function P(t){e.value&&(e.value={...e.value,...t})}function w(t){const u={...t,deal_id:a.value};return k("crm.deal.participant.add",{immediate:!1,refetch:!1}).post(u).json()}function n(t,u=!1){const S=`deal_id=${a.value}&contact_id=${t.contact_id}&role_id=${t.role_id}`;return k(`crm.deal.participant.delete?${S}`,{immediate:!1,refetch:!1}).delete(u?{force:u}:null).json()}return{deal:e,fetchId:a,isFetching:_,statusCode:f,error:b,eventEditing:r,refetch:s,fetchById:L,$reset:D,updateDeal:P,basePatchRequest:v,changeDescription:I,changeName:A,changeAmountAndCurrency:m,changeExpectedDate:p,upsertParticipant:w,deleteParticipant:n}}),me=K("tags",()=>{const e=h([]),{data:a,isFetching:r,error:l,execute:_,isFinished:f}=k("crm.tag.list").get().json(),b=y(()=>o=>e.value.find(s=>s.id===+o));Z(()=>{Array.isArray(a.value)&&(e.value=a.value)});function c(){f.value&&_()}function F(o,s,D,L){return k("crm.tag.assign",{immediate:!1,afterFetch(v){if(Array.isArray(v.data)){if(L&&c(),o==="contact"){const g=re();g.contact&&s.includes(g.contact.id)&&(g.contact.tags=[...new Set([...g.contact.tags,...v.data])]);const I=oe();for(const A of s){const m=I.contacts.find(p=>p.id===A);m&&m.tags&&(m.tags=[...new Set([...m.tags,...v.data])])}}if(o==="deal"){const g=ge();g.deal&&s.includes(g.deal.id)&&(g.deal.tags=[...new Set([...g.deal.tags,...v.data])]);const I=U();for(const A of s){const m=I.deals.find(p=>p.id===A);if(m){m.tags||(m.tags=[]);const p=m.tags.reduce((P,w)=>({...P,[w.id]:!0}),{});m.tags=[...m.tags,...v.data.filter(P=>!p[P.id]).map(P=>({id:P.id,name:P.name,count:P.count}))]}}}}return v}}).post({[`${o}_id`]:s,tag:D}).json()}return{tags:e,isFetching:r,error:l,isFinished:f,getTagById:b,refetch:c,tagAssign:F}});export{G as L,X as Q,R as T,ve as a,ge as b,U as c,W as d,fe as e,J as f,me as u};
