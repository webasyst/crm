import{d as V,h as l,a0 as D,P as E,l as k,B as c,V as g,R as F,u as o,o as i,i as n,c as r,p as q,w as T,F as $,q as j,k as z,j as A,a as v,ae as H}from"./main-2290994d.js";import{v as P}from"./index-0b6b9def.js";import{S as R}from"./SkeletonList-1c6858f7.js";import K from"./IframeView-4c556b87.js";import{_ as M}from"./ErrorDummy.vue_vue_type_script_setup_true_lang-6c27ef6c.js";import{E as O}from"./EmptyList-239f0622.js";import{C as U}from"./CustomColumn-c63128eb.js";import{H as G}from"./HistoryTabLogInvoiceSummary-bbaea840.js";import"./iframeObserver-d581afdd.js";import"./index-6e4a059f.js";import"./dayjs-910ec40d.js";const J={key:1,class:"state-error-hint"},Q={key:2,class:"tw-max-w-3xl tw-mx-auto"},W=v("div",{class:"icon size-80"},[v("i",{class:"fa fa-file-invoice-dollar"})],-1),X={class:"tw-h-20"},Y={key:0,class:"tw-text-center tw-py-4"},Z=v("div",{class:"spinner custom-p-16"},null,-1),ee=[Z],m=30,me=V({__name:"InvoicesTab",props:{entityType:{},entityId:{},isNew:{type:Boolean},invoiceId:{}},setup(x){var w;const t=x,u=l({[`${t.entityType}_id`]:t.entityId,sort:"create_datetime",asc:0,offset:0,limit:m}),f=l(0),a=l(null),p=l(Date.now()),C=D(),{data:b,isFetching:y,statusCode:B,error:_,execute:h}=E(k(()=>`crm.invoice.list?${H.stringify(u.value)}`),{immediate:!1,refetch:!0}).get().json();((w=c.rights)!=null&&w.invoice||c.webView)&&!t.isNew&&!t.invoiceId&&(h(),g("InvoicesTab:refresh").on(()=>{a.value&&(a.value=null,h())}));const L=k(()=>`${c.baseUrl}invoice/`+(t.invoiceId?`${t.invoiceId}/?iframe=1`:`new/?iframe=1&${t.entityType==="deal"?"deal_id":"contact"}=${t.entityId}`));F(b,e=>{e&&("params"in e&&(f.value=e.params.total_count),"data"in e&&Array.isArray(e.data)&&(a.value=[...a.value||[],...e.data]))});function N(){u.value.offset+m>=f.value||(u.value.offset+=m)}function S(e){var d;C.replace({query:{...(d=e.detail)!=null&&d.id?{id:e.detail.id}:{}}}).then(()=>{var s,I;t.invoiceId===((s=e.detail)==null?void 0:s.id)&&(p.value=Date.now()),typeof((I=e.detail)==null?void 0:I.action)=="string"&&g(`InvoicesTab:${e.detail.action}`).emit()})}return(e,d)=>o(c).rights&&!o(c).rights.invoice||o(B)===403?(i(),n(M,{key:0,code:403})):t.isNew||t.invoiceId?(i(),n(K,{id:"iframe-invoice",key:p.value,src:L.value,"force-resize":!0,"static-position":!0,onClose:S},null,8,["src"])):(i(),r($,{key:2},[a.value?o(_)?(i(),r("div",J,q(o(_)),1)):(i(),r("div",Q,[a.value.length?(i(),n(U,{key:0,space:"8"},{default:T(()=>[(i(!0),r($,null,j(a.value,s=>(i(),n(G,{key:s.id,invoice:s,"route-location":{query:{id:s.id}},class:"invoice-wrapper"},null,8,["invoice","route-location"]))),128))]),_:1})):(i(),n(O,{key:1,message:e.$t(`noInvoicesBy${e.$filters.toTitleCase(t.entityType)}`)},{default:T(()=>[W]),_:1},8,["message"])),z((i(),r("div",X,[o(y)?(i(),r("div",Y,ee)):A("",!0)])),[[o(P),([{isIntersecting:s}])=>{s&&!o(y)&&N()}]])])):(i(),n(R,{key:0,class:"tw-max-w-3xl tw-mx-auto"}))],64))}});export{me as default};
