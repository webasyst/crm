{$_title = "[`Messages`]"}
{$_is_admin = $wa->user()->isAdmin('crm')}
{if $page && $page != 1}{$_page_tail = "?pt=`$page`"}{else}{$_page_tail = ''}{/if}
{include file="./MessageListHelper.inc.html" inline}
{if empty($_active_c)}
    {$_active_c = waRequest::request('id', waRequest::get('id', null, waRequest::TYPE_INT), waRequest::TYPE_INT)}
{/if}
{if !isset($iframe)}
    {$iframe = waRequest::request('iframe', waRequest::get('iframe', null, waRequest::TYPE_INT), waRequest::TYPE_INT)}
{/if}
{function name="_renderListTime" _date='' }
    {$now = time()}
    {$your_date = strtotime($_date)}
    {$datediff = round(($now - $your_date)  / (60 * 60 * 24))}
    {$now_year = '.'|cat:waDateTime::date('y', $now)}
    {if $datediff < 2}
        {$chat_date = substr($_date|wa_datetime:'humandatetime', 0, -5)}
    {else}
        {$chat_date = waDateTime::date('j.m.y', $_date)}
    {/if}
    {$chat_date = str_replace($now_year, '', $chat_date)}
    {$week_day = date('N', $your_date)}
    {if $datediff > 1 && $datediff < 6}
        {$week_days = waDateTime::getWeekdayNames('ucfirst', false)}
        {$chat_date = $week_days[$week_day]}
    {/if}
    <div class="flexbox middle c-column-date">
        <span class="nowrap c-date">{$chat_date}</span>
    </div>
{/function}

{function name="_renderContact" _contact=[]}
<div class="flexbox middle space-8 c-user-wrapper">
        <div class="flexbox middle c-column-image">
            <img src="{$_contact.photo_url_32}" alt="{$_contact.name|escape}">
        </div>
        <div class="c-column middle c-user-name">
                {$_contact.name|escape}
        </div>
</div>
{/function}
{$no_active_filter = $active_filter_transport.id === 'all' && $active_filter_responsible.id === 'all'}
{$empty_conversations = empty($conversations) && $no_active_filter && ($iframe || empty($list_params.contact_id))}

<div class="c-messages-conversation-list shadowed js-messages-conversation-list" id="c-messages-conversation-list">
    <label id="js-crm-message-page"></label>
    {if !$iframe}
    <header class="c-messages-header sidebar-header">
        <div class="flexbox middle space-16 wrap full-width">

            <div class="c-column mobile-only js-page-name-header {if !empty($list_params.contact_id)}hidden{/if}">
                <div class="flexbox middle wrap c-nav-wrapper">
                    <div class="c-page-name"><h2>{$_title}</h2></div>
                </div>
            </div>
            <div class="flexbox middle c-search-wrapper js-search-wrapper">
                <div class="state-with-inner-icon left desktop-and-tablet-only {if !empty($list_params.contact_id)}hidden{/if}">
                    <input class="js-search-field" placeholder="[`Search`]" type="text" id="input-autocomplete-contact" value="">
                    <button class="icon"><i class="fas fa-search"></i></button>
                </div>
                <span class="icon js-search-contact-hide"><i class="fas fa-times-circle"></i></span>
                <div class="flexbox middle nowrap space-16 c-search-contact js-search-contact">
                    {if !empty($list_params.contact_id)}
                        {if isset($contacts[$list_params.contact_id])}
                            {_renderContact _contact=$contacts[$list_params.contact_id]}
                        {else}
                        <div class="flexbox middle space-8 c-user-wrapper">
                            <div class="c-column middle c-user-name">
                                [`User has no chats`]
                            </div>
                    </div>
                        {/if}
                        <span class="icon js-search-contact-cancel"><i class="fas fa-times-circle"></i></span>
                    {/if}
                </div>
                <span class="icon mobile-only js-search-mobile-show {if !empty($list_params.contact_id)}hidden{/if}"><i class="fas fa-search"></i></span>
            </div>
            <div class="flexbox middle space-16 c-icon-wrapper">
                <span class="icon size-16 cursor-pointer js-filter-open"><i class="fas fa-filter"></i></span>
                {*<span class="icon size-16 desktop-and-tablet-only"><i class="fas fa-sort"></i></span>*}
            </div>
            {if !empty($available_funnel)}
            <div class="c-add-wrapper">
                <button class="circle button c-write-message js-write-message" >
                    <span class="icon size-14" style="vertical-align: baseline;"><i class="fas fa-envelope"></i></span>
                </button>
            </div>
            {/if}
            
            <div class="c-message-filter-wrapper {if $no_active_filter}c-hidden{/if}">
                <div class="flexbox middle wrap space-8 c-message-filter">
                    {if !empty($list_params.contact_id)}
                        {$contact_var_link = $list_params.contact_id}
                    {else}
                        {$contact_var_link = null}
                    {/if}
                    {if $has_access_filter_responsibles && !empty($filter_responsibles)}
                        <div class="dropdown small c-message-filter-name" id="dropdown-filter_responsible">
                            <button class="dropdown-toggle button light-gray" type="button" style="display: flex; text-align: left; gap: 7px">
                                {if (isset($active_filter_responsible.photo_url_32))}
                                <span class="icon userpic size-16 rounded">
                                    <img src="{$active_filter_responsible.photo_url_32}" alt="{$active_filter_responsible.name|escape}" class="responsible-userpic" style="width: 16px;">
                                </span>
                                {/if}
                                <span class="dropdown-toggle--name">{sprintf_wp($active_filter_responsible.name)|escape}</span>
                            </button>
                            <div class="dropdown-body">
                                <ul class="menu nowrap">
                                    {foreach $filter_responsibles as $_responsible}
                                    <li class="{if $_responsible.id === $active_filter_responsible.id}selected{/if}">
                                        <a href="{crmHelper::getUrl(["responsible" => $_responsible.id, "page" => null, "contact" => $contact_var_link])}">
                                        {if (isset($_responsible.photo_url_32))}
                                        <span class="icon size-16 rounded">
                                            <img src="{$_responsible.photo_url_32}" alt="{$_responsible.name|escape}" class="responsible-userpic rounded">
                                        </span>
                                        {/if}
                                        <span class="dropdown-body--name">{$_responsible.name|escape}</span>
                                        </a>
                                    </li>
                                    {/foreach}
                                </ul>
                            </div>
                        </div>
                        <script>
                            ( function($) {
                                $("#dropdown-filter_responsible").waDropdown({
                                            //hover: false,
                                            items: ".menu > li > a",
                                            change: function(event, target, dropdown) {
                                            $('.c-messages-body .skeleton-wrapper').show();
                                            }
                                        });
                            })(jQuery);
                        </script>
                    {/if}
                    {if !empty($filter_transports)}
                        <div class="dropdown small c-message-filter-name" id="dropdown-filter_transports">
                            <button class="dropdown-toggle button light-gray" type="button">
                                <span>{sprintf_wp($active_filter_transport.name)|escape}</span>
                            </button>
                            <div class="dropdown-body" style="width: auto;">
                                <ul class="menu nowrap">
                                {foreach $filter_transports as $_filter_transport}
                                <li class="{if $_filter_transport.id === $active_filter_transport.id}selected{/if}">
                                    <a href="{crmHelper::getUrl(["transport" => $_filter_transport.id, "page" => null, "contact" => $contact_var_link])}">
                                    <span class="dropdown-body--name">{sprintf_wp($_filter_transport.name)|escape}</span>
                                    </a>
                                </li>
                                {/foreach}
                                </ul>
                            </div>
                        </div>
                        <script>
                            ( function($) {
                                $("#dropdown-filter_transports").waDropdown({
                                            //hover: false,
                                            items: ".menu > li > a",
                                            change: function(event, target, dropdown) {
                                            $('.c-messages-body .skeleton-wrapper').show();
                                            }
                                        });
                            })(jQuery);
                        </script>
                    {/if}
                </div>
            </div>
        </div>
    </header>
    {/if}
    <div class="c-messages-body blank">
        {function skeleton_sidebar}
        <div class="skeleton-wrapper">
            <div class="skeleton">
                <div class="body-skeleton">
                    <span class="skeleton-list"></span> 
                    <span class="skeleton-list"></span> 
                    <span class="skeleton-list"></span> 
                    <span class="skeleton-list"></span> 
                    <span class="skeleton-list"></span> 
                </div>
            </div>
        </div>
        {/function}

        {if !$iframe}
        {skeleton_sidebar}
        {/if}

        {if !$active_sources}
            <section class="c-cron-birthday-section ">
                <div class="c-is-cli-ok" style="text-align: center;">
                    <p class="bold">[`No message sources configured.`]</p>
                    <p>
                        [`To receive and handle messages from clients set up a message source`]
                        {if $_is_admin}
                            <br>
                            <a href="{$crm_app_url}settings/message-sources/email/">[`Email`]</a>
                            <a href="{$crm_app_url}settings/message-sources/im/">[`Messengers`]</a>
                        {/if}
                    </p>
                </div>
            </section>
        {/if}

        {if !empty($conversations)}

            <ul class="menu large custom-mt-0 c-messages-table-section js-messages-section">
                    {foreach $conversations as $_c}
                        {$_client = false}
                        {$_deal = false}

                        {if !empty($_c.contact_id) && !empty($contacts_all[$_c.contact_id])}
                            {$_client = $contacts_all[$_c.contact_id]}
                        {/if}

                        {if !empty($_c.deal_id) && !empty($deals[$_c.deal_id])}
                            {$_deal = $deals[$_c.deal_id]}
                        {/if}

                        {$_can_view = $_c.can_view|default:false}

                        {$_conversation_url = "{$wa_app_url}message/conversation/{$_c.id}/{$_page_tail}{if $iframe}{if $_page_tail == ''}?{else}&{/if}iframe=1{/if}"}
                        {if !$_can_view}
                            {$_conversation_url = "javascript:void(0);"}
                        {/if}
                        {$_message_classes = []}
                        {if !$_can_view}
                            {$_message_classes[] = "is-view-locked"}
                        {else}
                            {$_message_classes[] = "pointer is-view-ready"}
                            {if $_c.read != 1}
                                {$_message_classes[] = "unread"}
                            {/if}
                        {/if}
                        {$_is_active = ($_c.id == $_active_c)}
    
                        <li class="c-message-wrapper js-message-wrapper {$_message_classes|join:" "} {if $_is_active}selected{/if}"
                            data-id="{$_c.id}"
                            data-has-deal="{if !empty($_deal)}1{else}0{/if}"
                            data-active="{$_is_active}"
                            {if $_c.read != 1}
                                data-read="0"
                            {else}
                                data-read="1"
                            {/if}>
                            <a class="item profile flexbox middle space-12" href="{$_conversation_url}">
                                {* CLIENT PHOTO *}
                                
                                {if !empty($_client) && !empty($_c.contact_id)}
                                <div class="c-user-photo userpic userpic-48 rounded">
                                    <img src="{$_client.photo_url_50}" alt="{$_client.name|escape}">
                                    {if !empty($_client._online_status) && $_client._online_status == 'online'}
                                    <span class="userstatus"></span>
                                    {/if}
                                </div>
                                {elseif empty($_client) && !empty($_c.contact_id)}
                                
                                <div class="c-user-photo userpic userpic-48 ">
                                    <img class="" src="{$site_url}wa-content/img/userpic.svg" />
                                </div>
                                {/if}

                                <div class="detail">
                                    <div class="flexbox full-width nowrap space-8 custom-pb-4 c-top-detail ">
                                        <div class="flexbox middle c-name-wrapper">
                                            {if !empty($_client) && !empty($_c.contact_id)}
                                                <div class="c-name">{$_client.name|escape}</div>
                                            {elseif empty($_client) && !empty($_c.contact_id)}
                                                <div class="c-name" style="color: #999;">deleted contact_id={$_c.contact_id}</div>
                                            {/if}
                                        </div>

                                        {* DATE *}
                                        {_renderListTime _date=$_c.update_datetime}


                                    </div>

                                    <div class="flexbox middle space-4 c-bottom-detail">
                                        {* TYPE *}

                                        {* SUBJECT *}
                                        <div class="flexbox middle space-8 c-column-subject">
                                                <div class="c-subject-wrapper">
                                                    <span class="icon size-16 custom-ml-0 custom-mr-4">
                                                    {if !empty($_c.icon_fab)}
                                                        <i class="fab fa-{$_c.icon_fab}" title="{$_c.transport_name|escape}" style="color:{$_c.icon_color}"></i>
                                                    {elseif !empty($_c.icon_fa)}
                                                        <i class="fas fa-{$_c.icon_fa}" title="{$_c.transport_name|escape}" style="color:{$_c.icon_color}"></i>
                                                    {else}
                                                        <img src="{$_c.icon_url}" title="{$_c.transport_name|escape}" data-fa-i2svg>
                                                    {/if}
                                                    </span>
                                                    {$_c.summary|default:'[`no subject`]'|truncate:50:'...':true|escape}
                                                    {if $_c.count > 1}
                                                    <span class="hint custom-ml-4">({$_c.count})</span>
                                                    {/if}
                                                </div>
                                         
                                        </div>

                                        {* DEAL *}
                                        {*if !empty($_deal)}
                                        <div class="c-column-deal">
            
                                                {if $_deal.funnel_id && $_deal.stage_id && isset($funnels[$_deal.funnel_id]) && isset($funnels[$_deal.funnel_id].stages[$_deal.stage_id])}
                                                    {$_funnel = $funnels[$_deal.funnel_id]}
                                                    {$_stage = $_funnel.stages[$_deal.stage_id]}
                                                
                                                        <div class="c-deal-wrapper">
                                                            <i class="fas fa-circle funnel-state svg-icon" style="color: {$_stage.color|escape}" title="{$_funnel.name|escape} / {$_stage.name|escape}"></i>
                                                        
                                                            {strip_tags($_deal.name)|escape}
                                                        </div>
                                                
                                                {else}
                                                    <div class="c-deal-wrapper">
                                                        {strip_tags($_deal.name)|escape}
                                                        {if !$_deal.funnel_id}<span class="hint">[`Funnel deleted`]</span>{/if}
                                                        {if !$_deal.stage_id}<span class="hint">[`Stage deleted`]</span>{/if}
                                                    </div>
                                                {/if}
                                            {elseif !empty($available_funnel) && !empty($_client) && $_client.is_visible && empty($_deal)}
                                                <a href="javascript:void(0);" class="inline-link small js-associate-deal nowrap" data-dialog-url="{$wa_app_url}?module=message&action=conversationAssociateDealDialog&conversation_id={$_c.id}">
                                                    <i class="fas fa-plus add" style="vertical-align: baseline; margin: 0 4px 0 0;"></i>
                                                  [`Associate with a deal`]
                                                </a>
                                        
                                        </div> {/if*}  
                                    
                                        {* OWNER *}
                                        {*if $_is_admin}
                                            <div>
                                                    {if !empty($responsibles[$_c['user_contact_id']])}
                                                        {_renderContact _contact=$responsibles[$_c['user_contact_id']]}
                                                    {else}
                                                        <span class="hint">[`No owner`]</span>
                                                    {/if}
                                            </div>
                                        {/if*}
                                    </div>
                                </div>
                            </a>
                        </li>
                    {/foreach}
                        {if isset($pages_count) && $pages_count > $current_page}
                        <li class="custom-pt-16 custom-pb-8 js-lazy-load">
                            <div class="spinner custom-p-4"></div>
                        </li>
                        {/if}
            </ul>
            {*include file="./Message.list.operations.inc.html" delete_title='[`Delete conversations`]' inline*}

            <div class="dialog js-delete-conversation" style="display: none;">
                <div class="dialog-background"></div>
                <div class="dialog-body">
                    <header class="dialog-header"></header>
                    <div class="dialog-content" style="min-height: auto">
                        <div class="js-confirm-text"></div>
                        <div class="js-check-text" style="display: none">
                            <i class="fas fa-exclamation-triangle exclamation"></i> <span class="js-text"></span>
                        </div>
                    </div>
                    <footer class="dialog-footer">
                        <input class="button red crm-delete js-confirm-dialog" type="button" value="[`Delete`]">
                        <a class="button light-gray js-close-dialog" href="javascript:void(0);">[`Cancel`]</a>
                    </footer>
                </div>
            </div>

            <div class="dialog js-detach-conversation" style="display: none;">
                <div class="dialog-background"></div>
                <div class="dialog-body">
                    <header class="dialog-header"></header>
                    <div class="dialog-content" style="min-height: auto">
                        <div class="js-confirm-text"></div>
                        <div class="js-check-text" style="display: none">
                            <i class="fas fa-exclamation-triangle exclamation"></i> <span class="js-text"></span>
                        </div>
                    </div>
                    <footer class="dialog-footer">
                        <input class="button red crm-delete js-confirm-dialog" type="button" value="[`Detach`]">
                        <a class="button light-gray js-close-dialog" href="javascript:void(0);">[`Cancel`]</a>
                    </footer>
                </div>
            </div>

        {else}
        
            <div class="flexbox vertical middle no-messages">
                <span class="icon size-80 text-light-gray"><i class="fas fa-comments"></i></span>
                <span class="custom-my-16 gray">[`No messages`]</span>
                {if $active_sources && !empty($available_funnel) && $empty_conversations}
                <div class="custom-mt-4 c-add-wrapper">
                    <a href="javascript:void(0);" class="c-write-message js-write-message">[`Write message`]</a>
                </div>
                {/if}
            </div>
        {/if}
    </div>

    <script>

        ( function($) {
            $.crm.title.set({$_title|json_encode});
            
            new CRMMessagesSidebar({
                $wrapper: $("#c-messages-conversation-list"),
                $ui: '{$wa->whichUI()}',
                current_page: {$current_page},
                page_of_item: '{$page_of_item}',
                active_id: '{$_active_c}',
                //active_sources: '{if $active_sources}true{else}false{/if}',
                empty_conversations: '{if $empty_conversations}true{else}false{/if}',
                settings_contact_id: '{$list_params.contact_id|default:0}',
                settings_deal_id: '{$list_params.deal_id|default:0}',
                view: "conversation",
                locales: {
                    associate_with_deal: '[`Associate with a deal`]',
                    no_messages: '[`No messages`]',
                    detach_dialog_h2: '[`Are you sure you want to detach selected conversations from the deals?`]',
                    delete_dialog_h2: '[`Are you sure you want to delete all selected conversations?`]'
                },
                last_message_id: {$last_message_id|json_encode},
                iframe: {$iframe|default:0}
            });
        })(jQuery);
    </script>
</div>
