var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.createTemplateTagFirstArg=function(c){return c.raw=c};$jscomp.createTemplateTagFirstArgWithRaw=function(c,a){c.raw=a;return c};$jscomp.arrayIteratorImpl=function(c){var a=0;return function(){return a<c.length?{done:!1,value:c[a++]}:{done:!0}}};$jscomp.arrayIterator=function(c){return{next:$jscomp.arrayIteratorImpl(c)}};$jscomp.makeIterator=function(c){var a="undefined"!=typeof Symbol&&Symbol.iterator&&c[Symbol.iterator];return a?a.call(c):$jscomp.arrayIterator(c)};
$jscomp.findInternal=function(c,a,b){c instanceof String&&(c=String(c));for(var d=c.length,e=0;e<d;e++){var f=c[e];if(a.call(b,f,e,c))return{i:e,v:f}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(c,a,b){if(c==Array.prototype||c==Object.prototype)return c;c[a]=b.value;return c};$jscomp.getGlobal=function(c){c=["object"==typeof globalThis&&globalThis,c,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var a=0;a<c.length;++a){var b=c[a];if(b&&b.Math==Math)return b}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(c,a){var b=$jscomp.propertyToPolyfillSymbol[a];if(null==b)return c[a];b=c[b];return void 0!==b?b:c[a]};
$jscomp.polyfill=function(c,a,b,d){a&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(c,a,b,d):$jscomp.polyfillUnisolated(c,a,b,d))};$jscomp.polyfillUnisolated=function(c,a,b,d){b=$jscomp.global;c=c.split(".");for(d=0;d<c.length-1;d++){var e=c[d];if(!(e in b))return;b=b[e]}c=c[c.length-1];d=b[c];a=a(d);a!=d&&null!=a&&$jscomp.defineProperty(b,c,{configurable:!0,writable:!0,value:a})};
$jscomp.polyfillIsolated=function(c,a,b,d){var e=c.split(".");c=1===e.length;d=e[0];d=!c&&d in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var f=0;f<e.length-1;f++){var g=e[f];if(!(g in d))return;d=d[g]}e=e[e.length-1];b=$jscomp.IS_SYMBOL_NATIVE&&"es6"===b?d[e]:null;a=a(b);null!=a&&(c?$jscomp.defineProperty($jscomp.polyfills,e,{configurable:!0,writable:!0,value:a}):a!==b&&(void 0===$jscomp.propertyToPolyfillSymbol[e]&&(b=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[e]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(e):$jscomp.POLYFILL_PREFIX+b+"$"+e),$jscomp.defineProperty(d,$jscomp.propertyToPolyfillSymbol[e],{configurable:!0,writable:!0,value:a})))};$jscomp.polyfill("Array.prototype.find",function(c){return c?c:function(a,b){return $jscomp.findInternal(this,a,b).v}},"es6","es3");$jscomp.initSymbol=function(){};
$jscomp.polyfill("Symbol",function(c){if(c)return c;var a=function(f,g){this.$jscomp$symbol$id_=f;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:g})};a.prototype.toString=function(){return this.$jscomp$symbol$id_};var b="jscomp_symbol_"+(1E9*Math.random()>>>0)+"_",d=0,e=function(f){if(this instanceof e)throw new TypeError("Symbol is not a constructor");return new a(b+(f||"")+"_"+d++,f)};return e},"es6","es3");
$jscomp.polyfill("Symbol.iterator",function(c){if(c)return c;c=Symbol("Symbol.iterator");for(var a="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),b=0;b<a.length;b++){var d=$jscomp.global[a[b]];"function"===typeof d&&"function"!=typeof d.prototype[c]&&$jscomp.defineProperty(d.prototype,c,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}})}return c},"es6",
"es3");$jscomp.iteratorPrototype=function(c){c={next:c};c[Symbol.iterator]=function(){return this};return c};$jscomp.iteratorFromArray=function(c,a){c instanceof String&&(c+="");var b=0,d=!1,e={next:function(){if(!d&&b<c.length){var f=b++;return{value:a(f,c[f]),done:!1}}d=!0;return{done:!0,value:void 0}}};e[Symbol.iterator]=function(){return e};return e};$jscomp.polyfill("Array.prototype.keys",function(c){return c?c:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");
$jscomp.polyfill("Array.prototype.values",function(c){return c?c:function(){return $jscomp.iteratorFromArray(this,function(a,b){return b})}},"es8","es3");$jscomp.polyfill("Object.is",function(c){return c?c:function(a,b){return a===b?0!==a||1/a===1/b:a!==a&&b!==b}},"es6","es3");
$jscomp.polyfill("Array.prototype.includes",function(c){return c?c:function(a,b){var d=this;d instanceof String&&(d=String(d));var e=d.length;b=b||0;for(0>b&&(b=Math.max(b+e,0));b<e;b++){var f=d[b];if(f===a||Object.is(f,a))return!0}return!1}},"es7","es3");
$jscomp.checkStringArgs=function(c,a,b){if(null==c)throw new TypeError("The 'this' value for String.prototype."+b+" must not be null or undefined");if(a instanceof RegExp)throw new TypeError("First argument to String.prototype."+b+" must not be a regular expression");return c+""};$jscomp.polyfill("String.prototype.includes",function(c){return c?c:function(a,b){return-1!==$jscomp.checkStringArgs(this,a,"includes").indexOf(a,b||0)}},"es6","es3");
$jscomp.owns=function(c,a){return Object.prototype.hasOwnProperty.call(c,a)};$jscomp.polyfill("Object.values",function(c){return c?c:function(a){var b=[],d;for(d in a)$jscomp.owns(a,d)&&b.push(a[d]);return b}},"es8","es3");
(function(c){c.fn.shiftSelectable=function(){function a(n,m,p){var q=!1,r=n.get(0),u=m.get(0);b.find(l).each(function(){var v=this==r,t=this==u;v&&(q=!0);q&&(p.extra={is_first:v,is_last:t},k&&k(c(this),p));if(t)return q=!1})}var b=this,d=arguments;if(1<b.length)b.each(function(){c.fn.shiftSelectable.apply(c(this),d)});else{var e=b.data("shiftSelectable");if(c.isPlainObject(d[0])){if(c.isPlainObject(e))return;e=d[0]}var f=e.ns||(Math.random()+"").slice(2);if("destroy"===d[0])b.off("."+f),b.data("shiftSelectable");
else{var g,l=e.selector,k=e.onSelect,h=e.behavior_type;"vertical"!==h&&"horizontal"!==h&&"mixed"!==h&&(h="vertical");e=e.disable_text_selection;if(void 0!==e?e:1)b.attr("unselectable","on").css({"-moz-user-select":"-moz-none","-o-user-select":"none","-khtml-user-select":"none","-webkit-user-select":"none","-ms-user-select":"none","user-select":"none"}).on("selectstart",!1).on("mousedown",!1);b.on("click."+f,l,function(n){var m=c(this),p=n.shiftKey;if(g&&p){p=g.offset();var q=m.offset();p="vertical"===
h?q.top>p.top:"horizontal"===h?q.left>p.left:q.top>p.top||q.left>p.left;p?a(g,m,n):a(m,g,n)}g=m})}}}})(jQuery);var CRMDialog=function(c){function a(b){console&&console.log&&console.log(b)}CRMDialog=function(b){this.$wrapper=c(b.html);this.$block=this.$wrapper.find(".crm-dialog-block");this.position=b.position||!1;this.userPosition=b.setPosition||!1;this.options=b.options||!1;this.esc="undefined"===typeof b.esc?!0:!!b.esc;this.remain_after_load=b.remain_after_load||!1;this.$body=c(window.top.document).find("body");this.$window=c(window.top);this.is_closed=!1;this.is_visible=!0;this.onBgClick=b.onBgClick||!1;
this.onOpen=b.onOpen||function(){};this.onClose=b.onClose||function(){};this.onConfirm=b.onConfirm||function(){};this.onCancel=b.onCancel||function(){};this.onResize=b.onResize||!1;this.initClass()};CRMDialog.prototype.initClass=function(){var b=this;b.$wrapper.data("dialog",b);b.render();setTimeout(function(){b.bindEvents()},0)};CRMDialog.prototype.bindEvents=function(){function b(){f.is_closed||f.close();g.off("click",b);g.off("wa_before_load",b)}function d(){c.contains(document,f.$wrapper[0])?
f.resize():c(window).off("resize",d)}function e(){c.contains(document,f.$wrapper[0])?f.resize():c(document).off("refresh resizeDialog",e)}var f=this,g=c(document),l=f.$block?f.$block:f.$wrapper;f.$wrapper.on("close",b);if(!f.remain_after_load)g.on("wa_before_load",b);f.$wrapper.on("click",".crm-dialog-background",function(k){if(f.onBgClick)f.onBgClick(k);else k.stopPropagation()});if(f.esc)g.on("keyup",function(k){27===k.keyCode&&f.is_visible&&f.close()});l.on("click",".js-cancel-dialog",function(){if("function"==
typeof f.onCancel)f.onCancel(f);else a("Error: Cancel is not a function")});l.on("click",".js-confirm-dialog",function(k){k.stopPropagation();"function"==typeof f.onConfirm?!1!==f.onConfirm(f)&&f.close():a("Error: Confirm is not a function")});l.on("click",".js-close-dialog",b);c(window).on("resize",d);g.on("refresh resizeDialog",e)};CRMDialog.prototype.render=function(){try{this.$body.append(this.$wrapper)}catch(b){a("Error: "+b.message)}this.setPosition();this.onOpen(this.$wrapper,this)};CRMDialog.prototype.setPosition=
function(){function b(h){return{left:parseInt((e-h.width)/2),top:parseInt((f-h.height)/2)}}var d=this.$window,e=d.width(),f=d.height();d=this.$block?this.$block:this.$wrapper;var g=d.outerWidth(),l=d.outerHeight();var k=this.position?this.position:(this.userPosition?this.userPosition:b)({width:g,height:l});0<k.left&&k.left+g>e&&(k.left=e-g-20);0<k.top?k.top+l>f&&(k.top=f-l-20):(k.top=20,g=d.find(".crm-dialog-content"),g.hide(),l=d.outerHeight(),g.height(f-l-40).addClass("is-long-content").show());
d.css(k)};CRMDialog.prototype.close=function(){this.is_closed=!0;this.onClose(this.$wrapper,this);this.$wrapper.remove()};CRMDialog.prototype.resize=function(){this.$block.addClass("is-animated");this.setPosition();if(this.onResize)this.onResize(this.$wrapper,this)};CRMDialog.prototype.hide=function(){this.$wrapper.hide();this.is_visible=!1};CRMDialog.prototype.show=function(){this.$wrapper.show();this.is_visible=!0};return CRMDialog}(jQuery);var CRMElasticBlock=function(c){CRMElasticBlock=function(a){this.$window=c(window);this.$wrapper=a.$wrapper;this.$aside=a.$aside;this.$content=a.$content;this.top_fix_class="fixed-to-top";this.bottom_fix_class="fixed-to-bottom";this.debug=a.debug;this.initClass()};CRMElasticBlock.prototype.initClass=function(){function a(){if(c.contains(document,p[0])){var A=Math.floor(l.$content.outerHeight()),D=Math.floor(p.outerHeight()),E=Math.floor(m.height()),F=n.scrollTop(),G=Math.floor(p.offset().top),H=B>
F?1:-1,I=F-v;C=p.width();if(!(!t&&E>r&&760<=q)||A&&A<D)t?(E=Math.floor(m.height()),G=Math.floor(m.offset().top),G=E+G-r-F,H=D-r,t=!1,E>D&&F>v&&(H<G?e(0):f())):g();else{A=r>D+0;var K=F<=v,J=parseInt(G+D-F-r),L=0<J;J=0>=J;if(A)0<I+0?(w||x||!y)&&e(0):(w||y||x||z)&&g();else if(K){if(w||x||y)z?G<=v&&g():g()}else L?0<H?G>=0+F&&(w||!y||x)&&e():(!w||y||x)&&d(G-v):J?u.top+E<F+r?(!w||y||x)&&d(E-D):0<H?(!w||y||x)&&d(G-v):(w||y||!x)&&f():(!w||y||x)&&d(G-v)}B=F}else n.off("scroll",a)}function b(){c.contains(document,
p[0])?(q=Math.floor(n.width()),r=Math.floor(n.height()),g(),n.trigger("scroll")):n.off("scroll",b)}function d(A){l.log("Manual top scroll position");p.css("top",A).width(C).removeClass(k).removeClass(h);w=!0;y=x=z=!1}function e(A){l.log("Fixed to top scroll position");p.removeAttr("style").width(C).removeClass(h).addClass(k);A&&(z=!0,p.css("top",A));w=x=!1;y=!0}function f(){l.log("Fixed to bottom scroll position");p.removeAttr("style").width(C).removeClass(k).addClass(h);w=y=z=!1;x=!0}function g(){l.log("Default scroll position");
p.removeAttr("style").removeClass(h).removeClass(k);w=y=x=z=!1}var l=this,k=l.top_fix_class,h=l.bottom_fix_class,n=l.$window,m=l.$wrapper,p=l.$aside;p.addClass("crm-elastic-block");var q=Math.floor(n.width()),r=Math.floor(n.height()),u=m.offset(),v=p.offset().top,t=!0,w=!1,x=!1,y=!1,z=!1,B=0,C;n.on("scroll",a).on("resize",b)};CRMElasticBlock.prototype.log=function(a){this.debug&&console.log(a)};return CRMElasticBlock}(jQuery);(function(c){function a(d,e){var f=c(window);e=f.scrollTop();var g=f.scrollLeft()+f.width(),l=f.scrollTop()+f.height();f=f.scrollLeft();var k=d.element.offset();k.right=k.left+d.element.outerWidth();k.bottom=k.top+d.element.outerHeight();return e<k.top&&f<k.left&&g>k.right&&l>k.bottom}function b(d,e){return d.clone().addClass(e.fixed_class||"sticky-fixed").css(c.extend({position:"fixed",display:"none"},e.fixed_css||{})).removeAttr("id").insertAfter(d)}c.fn.sticky=function(d){function e(){f.closest("body").length?
c.each(l,function(k,h){g.isStaticVisible.call(h.element,h,g)?h.is_fixed&&(h.is_fixed=!1,h.fixed_clone.hide(),g.hideFixed&&g.hideFixed.call(h.fixed_clone,h,g)):(h.is_fixed||(h.is_fixed=!0,h.fixed_clone.show(),g.showFixed&&g.showFixed.call(h.fixed_clone,h,g)),g.updateFixed&&g.updateFixed.call(h.fixed_clone,h,g))}):c(window).off("resize scroll",e)}var f=this,g=c.extend({fixed_class:"sticky-fixed",isStaticVisible:a,getClone:b},d||{}),l=f.map(function(){var k=c(this);return{element:k,fixed_clone:g.getClone.call(k,
k,g),is_fixed:!1}}).get();c(window).on("resize scroll",e);e();return this}})(jQuery);(function(c){c.ajaxSetup({cache:!1});c(document).ajaxSend(function(a,b,d){d.crossDomain||"POST"!==(d.type||"").toUpperCase()||(a=(a=document.cookie.match(/(?:^|; )_csrf=([^;]*)/))?decodeURIComponent(a[1]):"",d.data||0===d.data||(d.data=""),"string"===typeof d.data?-1==d.data.indexOf("_csrf=")&&(d.data+=(0<d.data.length?"&":"")+"_csrf="+a,b.setRequestHeader("Content-type","application/x-www-form-urlencoded")):"object"===typeof d.data&&(window.FormData&&d.data instanceof window.FormData?"function"==
typeof d.data.set?d.data.set("_csrf",a):d.data.append("_csrf",a):d.data._csrf=a))});c(document).ajaxError(function(a,b,d,e){if(b.getResponseHeader("wa-session-expired"))return window.location.reload();502===b.status&&"abort"==e||d.url&&0<=d.url.indexOf("background_process")||d.data&&"string"===typeof d.data&&0<=d.data.indexOf("background_process")?console&&console.log&&console.log("Notice: XHR failed on load: "+d.url):200!==b.status&&b.responseText&&(a=b.responseText,c.crm&&c.crm.is_debug&&(a=c.crm.confirm.template.replace("%title%",
"XHR error "+b.status).replace("%text%",b.responseText).replace("%button%","Close")),c.waDialog({html:a,onOpen:function(f,g){f.find(".wa-exception-debug-dump #Trace pre").each(function(){var l=c(this),k=l.html().replace(/^(#(#|\d+)\s+(wa-system|index\.php|\{main\}).*)$/gm,'<span style="color:#999">$1</span>');l.html(k)})}}),-1===a.indexOf("dialog-background")&&(document.open("text/html"),document.write(b.responseText),document.close()))});c.crm=c.extend(c.crm||{},{lang:!1,app_url:!1,backend_url:!1,
is_debug:!1,is_page_loaded:!1,content:!1,sidebar:!1,storage:new c.store,locales:!1,confirm:{show:function(a){var b=a.title||"",d=a.text||"",e=a.button||"",f=a.onConfirm||function(){},g=a.onCancel||function(){};a=a.onClose||function(){};var l=c.crm.confirm.template;return(l=l.replace("%title%",b).replace("%text%",d).replace("%button%",e))?c.waDialog({html:l,onOpen:function(k,h){k.on("click",".js-confirm-dialog",function(n){n.preventDefault();h.options.onConfirm();h.close()});k.on("click",".js-cancel-dialog",
function(n){n.preventDefault();h.options.onCancel();h.close()})},options:{onConfirm:f,onCancel:g,onClose:a}}):c.waDialog.confirm({title:b,text:d,success_button_title:e,success_button_class:"danger",cancel_button_title:c.crm.locales.cancel,cancel_button_class:"light-gray",onSuccess:f,onCancel:g})},template:""},alert:{show:function(a){var b=a.text||"",d=a.button||c.crm.locales.close||"",e=a.button_class||"gray",f=c.crm.alert.template;f=f.replace("%title%",a.title||"").replace("%text%",b).replace("%button%",
d);if(!f)throw"Not found alert dialog";a=c.extend({},a,!0);a.html=f;f=c.waDialog(a);f.$wrapper.find(".js-close-dialog").addClass(e);return f},template:""},title:{pattern:"CRM \u2014 %s",set:function(a){if(a){var b=history.state;b&&(b.title=a);document.title=c.crm.title.pattern.replace("%s",a)}}},check:{email:function(a){var b=!1;0<a.length&&1<=(a.match(/.+?@.+/g)||[]).length&&(b=!0);return b}},encodeHTML:function(a){return a&&(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},
renderSVG:function(a){if("object"!==typeof d3)return!1;var b=function(d,e){b=function(f){this.$icon=f.$icon;this.svg=e.select(this.$icon[0]).append("svg");this.type=this.$icon.data("type");this.icon_w=this.$icon.outerWidth();this.icon_h=this.$icon.outerHeight();this.initClass()};b.prototype.initClass=function(){this.svg.attr("width",this.icon_w).attr("height",this.icon_h);this.$icon.hasClass("funnel-state")?this.renderFunnelState():this.$icon.hasClass("funnel")?this.renderFunnel():this.$icon.hasClass("funnel-1")&&
this.renderFunnel(1);this.$icon.data("icon",this)};b.prototype.renderFunnelState=function(){function f(n){return n/16*l.icon_w}function g(n){return n/16*l.icon_h}var l=this,k=l.$icon.data("color")||"#aaa",h=l.svg.append("g");h.append("polygon").attr("points",f(4)+","+g(16)+" "+f(0)+","+g(16)+" "+f(3.9)+","+g(7.9)+" "+f(0)+","+g(0)+" "+f(4)+","+g(0)+" "+f(8.7)+","+g(7.9)).style("opacity",.33).style("fill",k);h.append("polygon").attr("points",f(8)+","+g(16)+" "+f(4)+","+g(16)+" "+f(7.9)+","+g(7.9)+
" "+f(4)+","+g(0)+" "+f(8)+","+g(0)+" "+f(12.6)+","+g(7.9)).style("opacity",.66).style("fill",k);h.append("polygon").attr("points",f(11.9)+","+g(16)+" "+f(7.9)+","+g(16)+" "+f(11.8)+","+g(7.9)+" "+f(7.9)+","+g(0)+" "+f(11.9)+","+g(0)+" "+f(16)+","+g(7.9)).style("fill",k)};b.prototype.renderFunnel=function(f){function g(){var r=[],u=l.icon_w,v=l.icon_h;0<m&&(u-=m,v-=m);var t=u-6+",0";var w=u+","+v/2;u=u-6+","+v;var x="0,"+v;v="6,"+v/2;r.push("0,0");r.push(t);r.push(w);r.push(u);r.push(x);f&&1===f||
r.push(v);return r.join(" ")}var l=this,k=l.$icon.data("color")||"#aaa",h=d.crm.color(k),n=l.$icon.data("hover-color")||h.getTone(20),m=l.$icon.data("stroke-width")||0,p=l.$icon.data("hover")||!1,q=l.svg.append("g").append("polygon").attr("class","is-animated").attr("points",g()).attr("transform","translate("+m/2+","+m/2+")").style("fill",k);0<m&&(h=h.getTone(-20),q.style("stroke",h).style("stroke-width",m));p&&(p=q.node(),p=d(p).closest(".c-state-item "),p.on("mouseenter",function(){q.style("fill",
n)}),p.on("mouseleave",function(){q.style("fill",k)}));(function(){function r(){v||(v=!0,setTimeout(u,100))}function u(){d.contains(document,l.$icon[0])?(l.refresh(),q.attr("points",g())):d(window).off("resize refresh-icons",r);v=!1}var v=!1;d(window).on("resize refresh-icons",r)})()};b.prototype.refresh=function(){this.icon_w=this.$icon.outerWidth();this.icon_h=this.$icon.outerHeight();this.svg.attr("width",this.icon_w).attr("height",this.icon_h)};return b}(jQuery,d3);"string"===typeof a&&(a=c(a));
a.length&&a.find(".svg-icon").each(function(){var d=c(this),e=d.data("icon");e?e.refresh():b&&new b({$icon:d})})},tabSlider:function(a){var b=function(d){b=function(e){this.$wrapper=e.$wrapper;this.$slider=e.$slider;this.$activeSlide=e.$activeSlide||!1;this.type_class=!1;this.left=0;this.slider_w=this.wrapper_w=!1;this.initClass()};b.prototype.initClass=function(){function e(){d.contains(document,f.$wrapper[0])?f.wrapper_w!==f.$wrapper.outerWidth()&&f.reset():g.off("resize",e)}var f=this,g=d(window);
f.detectSliderWidth();f.initStartPosition();g.on("resize",e);f.$wrapper.on("click",".c-action",function(l){l.preventDefault();l=d(this);l.hasClass("left")&&f.moveSlider(!1);l.hasClass("right")&&f.moveSlider(!0)})};b.prototype.initStartPosition=function(){var e=0;if(this.$activeSlide.length){var f=this.$activeSlide.outerWidth(),g=Math.floor(Math.abs(this.$wrapper.offset().left-this.$activeSlide.offset().left));g+f>this.wrapper_w&&(e=g-40)}e?(this.start_left=e,this.moveSlider(!0,e)):(this.setLeft(0),
this.showArrows())};b.prototype.detectSliderWidth=function(){this.slider_w=this.$slider[0].scrollWidth;this.$slider.css("width",this.slider_w);this.wrapper_w=this.$wrapper.outerWidth()};b.prototype.showArrows=function(){function e(g){f.type_class&&f.$wrapper.removeClass(f.type_class);g&&(f.$wrapper.addClass(g),f.type_class=g)}var f=this;0<=f.left?f.wrapper_w<f.slider_w?e("type-1"):e():f.wrapper_w<f.slider_w-Math.abs(f.left)?e("type-2"):e("type-3")};b.prototype.setLeft=function(e){0<Math.abs(e)||(e=
0);this.$slider.css("left",e?e+"px":0);this.left=e};b.prototype.moveSlider=function(e,f){f=f?f:parseInt(this.wrapper_w/2);var g=this.slider_w-this.wrapper_w,l=0;0<g&&(l=Math.abs(this.left)+(e?f:-f),l>g?l=g:0>l&&(l=0));this.setLeft(-l);this.showArrows()};b.prototype.reset=function(){this.setLeft(0);this.detectSliderWidth();this.showArrows()};return b}(c);return new b(a)},color:function(a){var b=function(){function d(h,n,m){h=parseInt(h,16);n=parseInt(n,16);m=parseInt(m,16);return 0<=h&&0<=n&&0<=m?
[h,n,m]:null}function e(h){h[0]=parseInt(h[0].toFixed());h[1]=parseInt(h[1].toFixed());h[2]=parseInt(h[2].toFixed());var n=h[0].toString(16),m=h[1].toString(16);h=h[2].toString(16);return 0<=n.length&&0<=m.length&&0<=h.length?"#"+(1==n.length?"0"+n:n)+(1==m.length?"0"+m:m)+(1==h.length?"0"+h:h):null}function f(h){var n=(h[0]+16)/116,m=h[1]/500+n,p=n-h[2]/200;m=.95047*(.008856<m*m*m?m*m*m:(m-16/116)/7.787);n=.008856<n*n*n?n*n*n:(n-16/116)/7.787;p=1.08883*(.008856<p*p*p?p*p*p:(p-16/116)/7.787);h=3.2406*
m+-1.5372*n+-.4986*p;var q=-.9689*m+1.8758*n+.0415*p;n=.0557*m+-.204*n+1.057*p;h=.0031308<h?1.055*Math.pow(h,1/2.4)-.055:12.92*h;q=.0031308<q?1.055*Math.pow(q,1/2.4)-.055:12.92*q;n=.0031308<n?1.055*Math.pow(n,1/2.4)-.055:12.92*n;return[255*Math.max(0,Math.min(1,h)),255*Math.max(0,Math.min(1,q)),255*Math.max(0,Math.min(1,n))]}function g(h){var n=h[0]/255,m=h[1]/255,p=h[2]/255;n=.04045<n?Math.pow((n+.055)/1.055,2.4):n/12.92;m=.04045<m?Math.pow((m+.055)/1.055,2.4):m/12.92;p=.04045<p?Math.pow((p+.055)/
1.055,2.4):p/12.92;h=(.4124*n+.3576*m+.1805*p)/.95047;var q=.2126*n+.7152*m+.0722*p;n=(.0193*n+.1192*m+.9505*p)/1.08883;h=.008856<h?Math.pow(h,1/3):7.787*h+16/116;q=.008856<q?Math.pow(q,1/3):7.787*q+16/116;n=.008856<n?Math.pow(n,1/3):7.787*n+16/116;return[116*q-16,500*(h-q),200*(q-n)]}function l(h,n,m){var p=Math.floor(6*h),q=6*h-p;h=m*(1-n);var r=m*(1-q*n);n=m*(1-(1-q)*n);switch(p%6){case 0:var u=m;var v=n;var t=h;break;case 1:u=r;v=m;t=h;break;case 2:u=h;v=m;t=n;break;case 3:u=h;v=r;t=m;break;case 4:u=
n;v=h;t=m;break;case 5:u=m,v=h,t=r}return[255*u,255*v,255*t]}function k(h){var n=h[0]/255,m=h[1]/255,p=h[2]/255,q,r=Math.max(n,m,p);var u=r-Math.min(n,m,p);if(0==u)var v=q=0;else{q=u/r;h=(r-n)/6/u+.5;var t=(r-m)/6/u+.5;u=(r-p)/6/u+.5;n===r?v=u-t:m===r?v=1/3+h-u:p===r&&(v=2/3+t-h);0>v?v+=1:1<v&&--v}return{h:Math.round(360*v),s:Math.round(100*q),b:Math.round(100*r)}}b=function(h){h=this.hex=h;var n=!1;"string"===typeof h?(h=h.replace("#",""),3===h.length?n=d(h[0]+""+h[0],h[1]+""+h[1],h[2]+""+h[2]):
6===h.length&&(n=d(h[0]+""+h[1],h[2]+""+h[3],h[4]+""+h[5]))):"object"===typeof h&&3===h.length&&(n=h);this.rgb=n};b.prototype.getRange=function(){var h=this.rgb?g(this.rgb):!1;if(h){var n=f([90,h[1],h[2]]),m=f([40,h[1],h[2]]);h=e(n);var p=e(m);h=[h,p];h.getColor=function(q){if(0<=q&&100>=q){var r=n[0],u=n[1],v=n[2];return e([Math.floor(r+(m[0]-r)*q/100),Math.floor(u+(m[1]-u)*q/100),Math.floor(v+(m[2]-v)*q/100)])}return null};return h}return null};b.prototype.getTone=function(h){function n(p){100<
p?p=100:0>p&&(p=0);return p}var m=k(this.rgb);m.s=n(m.s*(1+h/100));m.b=n(m.b*(1+h/100));h=l(m.h/360,m.s/100,m.b/100);return e(h)};return b}();return new b(a)},initWYSIWYG:function(a,b){if(!a||!a.length||a.data("redactor"))return a;b=c.extend({minHeight:130,buttons:"inline bold italic underline deleted lists outdent indent image link horizontalrule fontcolor fontsize fontfamily".split(" "),plugins:["fontcolor","fontsize","fontfamily"],allowedTags:"a b i u pre blockquote p strong em del strike span ul ol li div span br".split(" "),
uploadImage:!1,lang:this.lang},b||{});a.redactor(b);c(document).one("wa_before_render",function(){c.contains(document,a[0])&&a.data("redactor")&&a.redactor("core.destroy")});return a},escape:function(a){return c("<div />").text(a).html()},runBackgroundWorker:function(a){var b=Math.floor(100*Math.random())/100,d=Math.floor(100*Math.random())/100,e=a.delay||1E4,f=e/2,g=a.id||(""+Math.random()).slice(2),l=null,k=null,h=a.url;h?(e+=f*b,200>=e?console.error("Delay value too low"):function(){try{var n=
function(){l&&clearTimeout(l);k&&k.abort();k=c.post(h,{process_id:g});k.always(function(){k=null;l=setTimeout(n,e)});k.fail(function(){return!1})};l=setTimeout(n,500+300*d)}catch(m){console.error(["source email worker fail",m])}}()):console.error("Empty url")}})})(jQuery);(function(c,a){c.fn.serializeObject=function(){var b={};c.each(this.serializeArray(),function(d,e){d=e.name;e=e.value;b[d]=b[d]===a?e:c.isArray(b[d])?b[d].concat(e):[b[d],e]});return b}})(jQuery);
(function(c){var a=null,b=!1;c(document).on("dragover",function(d){d.preventDefault();a?clearTimeout(a):b||(b=!0,c(document).trigger("myDragEnter"));a=setTimeout(function(){a=null;b=!1;c(document).trigger("myDragLeave")},100)});c(document).on("drop",function(d){d.preventDefault()})})(jQuery);
var ContentRouter=function(c){ContentRouter=function(a){this.$window=c(window);this.$content=a.$content;this.$spaContainer=a.$spaContainer;this.api_enabled=!(!window.history||!window.history.pushState);this.xhr=!1;this.is_enabled=!0;this.need_confirm=!1;this.initClass()};ContentRouter.prototype.initClass=function(){this.bindEvents()};ContentRouter.prototype.bindEvents=function(){var a=this,b=window.location.origin+c.crm.app_url;c(document).on("click","a",function(d){var e=c(this),f=e.attr("href"),
g=e.data("link"),l=this.href;0<=l.indexOf(c.crm.app_url+"contact/")||l.indexOf(c.crm.app_url+"deal/");f||(e.attr("href","javascript:void(0);"),f=e.attr("href"));var k=e.hasClass("js-disable-router"),h=this.href.substr(0,b.length)==b;f=!("#"===f||"javascript:"===f.substr(0,11));k=a.is_enabled&&!k&&h&&f;d.ctrlKey||d.shiftKey||d.metaKey||!k||(d.preventDefault(),a.need_confirm?c.crm.confirm.show({title:c.crm.locales.unsaved_dialog_title,text:c.crm.locales.unsaved_dialog_text,button:c.crm.locales.unsaved_dialog_button,
onConfirm:function(){c(document).trigger("unsavedChanges",!1);a.load(l,!1,e)}}):c.crm.iframe&&"top"===g?window.parent.$.crm.content.load(l,!1,e):a.load(l,!1,e))});c("#wa-app-crm").on("click","a",function(d){d.stopPropagation()});a.api_enabled&&(window.onpopstate=function(d){d.stopPropagation();a.onPopState(d)});c(document).on("unsavedChanges",function(d,e){a.need_confirm=!!e})};ContentRouter.prototype.load=function(a,b,d){var e=this;if(!(0<=a.indexOf(c.crm.app_url)))return alert("Determine the path error"),
!1;e.animate(!0);e.xhr&&e.xhr.abort();c(document).trigger("wa_before_load",{content_uri:a});d&&d.find("[data-fa-i2svg]").hide().after('<i class="fas fa-spinner fa-spin"></i>');e.xhr=c.ajax({method:"GET",url:a,dataType:"html",global:!1,cache:!1}).done(function(f){e.api_enabled&&!b&&history.pushState({reload:!0,content_uri:a},"",a);d&&(d.find("[data-fa-i2svg]:first").show(),d.find("[data-fa-i2svg]").slice(1).remove());e.setContent(f);e.animate(!1);e.xhr=!1;c(document).trigger("wa_loaded")}).fail(function(f){f.responseText&&
c.crm.alert.show({title:"Error",text:f.responseText,button:"Close"});d&&(d.find("[data-fa-i2svg]:first").show(),d.find("[data-fa-i2svg]").slice(1).remove())});return e.xhr};ContentRouter.prototype.reload=function(){var a=this.api_enabled&&history.state&&history.state.content_uri?history.state.content_uri:location.href;return a?this.load(a,!0):c.when()};ContentRouter.prototype.setContent=function(a){c(document).trigger("wa_before_render");c(a).filter("#app").length?(c.crm.iframe||this.$content.hide(),
this.$spaContainer.show(),this.$spaContainer.is(":empty")&&this.$spaContainer.html(a)):(this.$content.show().html(a),this.$spaContainer.hide())};ContentRouter.prototype.onPopState=function(a){if(a=a.state||!1){var b=a.current?0<=a.current.indexOf("/contact/")||0<=a.current.indexOf("/deal/"):!0;if(!a.content_uri&&!b)return alert("Determine the path error"),!1;c(document).trigger("wa_before_load",{content_uri:a.content_uri});a.reload?this.reload(a.content_uri):a.content&&this.setContent(a.content);
a.title&&c.crm.title.set(a.title);c(document).trigger("wa_loaded")}else location.reload()};ContentRouter.prototype.animate=function(a){};return ContentRouter}(jQuery),CrmEditable=function(c){var a=function(b){this.$wrapper=b.$wrapper;this.save=b.onSave||function(){};this.render=b.onRender||!1;this.placeholder=b.placeholder||"";this.text=(this.is_empty=this.$wrapper.hasClass("is-empty"))?"":c.trim(this.$wrapper.text());this.is_edit=this.$field=!1;this.initClass()};a.prototype.initClass=function(){this.$field=
this.renderField();this.bindEvents()};a.prototype.bindEvents=function(){var b=this;b.$wrapper.on("click",function(){b.toggle()});var d=!1,e=!1;b.$field.on("blur",function(){e||d||(d=!0,b.save(b),d=!1);e=!1});b.$field.on("keyup",function(f){var g=27===f.keyCode;13!==f.keyCode||d?g&&(b.$field.val(b.text),b.toggle("hide"),e=!0):(d=!0,b.save(b),e=!0,d=!1)})};a.prototype.renderField=function(){var b=this.text,d=c('<input class="bold" type="text" name="" />');this.placeholder&&d.attr("placeholder",this.placeholder);
this.is_empty||d.val(b);d.hide();this.$wrapper.after(d);this.render&&this.render(this,d);return d};a.prototype.toggle=function(b){if(b="hide"!==b){var d=this.$wrapper.parent().width(),e=this.$wrapper.width(),f=Math.floor(d/2);d-=10;this.$field.width(e>d?d:e<f?f:e);this.$wrapper.hide();this.$field.show().focus()}else this.$wrapper.show(),this.$field.hide();this.is_edit=b};a.prototype.loading=function(b){this.$field.siblings(".crm-editable-loading").remove();arguments.length&&!b?this.$field.prop("disabled",
!1):(this.$field.after('<span class="icon loading crm-editable-loading"><i class="fas fa-spinner fa-spin"></i></span>'),this.$field.prop("disabled",!0));return this};a.prototype.isLoading=function(b){return 0<this.$field.siblings(".crm-editable-loading").length};a.prototype.getText=function(){return this.$field.val()};a.prototype.setText=function(b,d){this.text=b;this.$field.val(b);this.$wrapper.text(void 0===d?b:d);return this};a.prototype.hide=function(){this.reset();this.loading(!1);this.toggle("hide");
return this};a.prototype.reset=function(){this.setText(this.text,this.$wrapper.text());return this};a.prototype.isChanged=function(){return this.getText()!==this.text};return a}($);(function(c){function a(e,f){var g=new RegExp(c.ui.autocomplete.escapeRegex(f),"i");return c.grep(e,function(l){return g.test(c("<div>").html(l.label||l.value||l).text())})}var b=c.ui.autocomplete.prototype,d=b._initSource;c.extend(b,{_initSource:function(){this.options.html&&c.isArray(this.options.source)?this.source=function(e,f){f(a(this.options.source,e.term))}:d.call(this)},_renderItem:function(e,f){var g=this.options.item_clz||"";this.options.html&&(g+=" ui-menu-item-html");return c("<li class='"+
g+"'></li>").data("item.autocomplete",f).append(c("<div></div>")[this.options.html?"html":"text"](f.label)).appendTo(e)}})})(jQuery);var CRMSidebar=function(c){CRMSidebar=function(a){this.$wrapper=a.$wrapper;this.$ui=a.$ui;this.$body=this.$wrapper.find(".sidebar-body");this.$footer=this.$wrapper.find(".sidebar-footer");this.$toggler=this.$wrapper.find(".sidebar-mobile-toggle");this.$sidebar_open=!1;this.selected_class="selected";this.$activeMenuItem=this.$wrapper.find("li."+this.selected_class+":first")||!1;this.xhr=!1;this.timer=0;this.initClass()};CRMSidebar.prototype.initClass=function(){function a(d){var e=d.indexOf("crm/");
e&&0<e&&(d=d.slice(e+4),e=d.indexOf("/"),d=d.slice(0,e),$item=b.$wrapper.find('a[href*="'+d+'"]')||!1,b.setItem($item.closest("li")),c.crm.title.set($item.data("wa-tooltip-content")))}var b=this;b.initUpdater();b.initMobileToggle();b.$activeMenuItem.length||b.selectLink();b.$wrapper.on("click","li > a",function(){var d=c(this);(it_reminder=d.attr("href").indexOf("reminder")+1)||d.find(".js-indicator").remove()});c(document).ready(function(){a(window.location.href)});c(document).on("wa_before_render",
function(){a(window.location.href)});window.matchMedia("(min-width: 761px) and (pointer: fine)").matches&&(b.$body.find("li > a").each(function(){c(this).waTooltip({placement:"right"})}),b.$footer.find("li > a").each(function(){c(this).waTooltip({placement:"right"})}))};CRMSidebar.prototype.setItem=function(a){if(this.$activeMenuItem.length&&this.$activeMenuItem[0]==a[0])return!1;this.$activeMenuItem.length&&this.$activeMenuItem.removeClass(this.selected_class);a.addClass(this.selected_class);this.$activeMenuItem=
a};CRMSidebar.prototype.initMobileToggle=function(){function a(d){b.is_mobile=b.$toggler.is(":visible");b.is_mobile&&("wa_before_render"!==d.type||b.$sidebar_open)&&(d&&d.preventDefault(),window.scrollTo({top:0,behavior:"smooth"}),b.$toggler.siblings().each(function(e,f){"SCRIPT"!==f.nodeName&&"STYLE"!==f.nodeName&&c(f).slideToggle(400,function(){var g=c(this);g.is(":hidden")?(g.css("display",""),b.$sidebar_open=!1):b.$sidebar_open=!0})}))}var b=this;b.$toggler.on("click.sidebar touchstart.sidebar",
a);c(document).on("wa_before_render",a)};CRMSidebar.prototype.selectLink=function(a){var b;a&&(b=this.$wrapper.find('a[href="'+a+'"]:first'));if(b&&b.length)this.setItem(b.closest("li"));else{a=this.$wrapper.find("a[href^='"+c.crm.app_url+"']");var d=location.pathname,e=0,f=0;a.each(function(g){var l=c(this).attr("href"),k=l.length;0<=d.indexOf(l)&&k>e&&(e=k,f=g)});if(f||0===f)b=a.eq(f),this.setItem(b.closest("li"))}};CRMSidebar.prototype.reload=function(a){var b=this,d=c.crm.app_url+"?module=sidebar&ui="+
b.$ui+"&reload=1";a&&(d+="&background_process=1");clearTimeout(b.timer);b.xhr&&b.xhr.abort();b.xhr=c.get(d,function(e){b.$toggler.off(".sidebar");b.xhr=!1;b.$body.html(e)})};CRMSidebar.prototype.initUpdater=function(){var a=this;a.timer=setTimeout(function(){c.contains(document,a.$wrapper[0])&&a.reload(!0)},3E5)};return CRMSidebar}(jQuery);var CRMDeal=function(c){var a=function(d){a=function(e){this.$window=d(window);this.$wrapper=e.$wrapper;this.$outer_wrapper=e.$outer_wrapper;this.debug=e.debug;this.indent={top:0};this.$clone=null;this.offset=this.getOffset();this.type=null;this.init()};a.prototype.init=function(){function e(){d.contains(document,g.$wrapper[0])?(g.reset(),g.onScroll()):d(document).off("refresh",e)}function f(){if(d.contains(g.$window[0].document,g.$wrapper[0]))g.onScroll();else g.$window.off("scroll",f)}var g=this;
g.$clone=function(k){var h=d("<div />");k.before(h);return h.hide()}(g.$wrapper);g.onScroll();var l=0;g.$window.on("resize",function(){clearTimeout(l);l=setTimeout(function(){g.reset();g.onScroll()},50)});d(document).on("refresh",e);g.$window.on("scroll",f)};a.prototype.onScroll=function(){var e=this.$window.scrollTop(),f=this.$window,g=f.width();f.height();f=this.offset;var l=this.$outer_wrapper.outerHeight();!(0<g)||l<=this.offset.height?this.fixTo("default"):e<=f.top-this.indent.top?this.fixTo("default"):
this.fixTo("fix_top")};a.prototype.fixTo=function(e,f){e=e?e:null;this.type!==e&&("fix_top"===e?(this.$wrapper.removeAttr("style"),this.$clone.css({height:this.$wrapper.outerHeight()}).show(),this.$wrapper.css({position:"fixed",top:this.indent.top,left:this.offset.left-10,width:this.offset.width+20}),this.$wrapper.addClass("is-fixed-top")):(this.$wrapper.removeClass("is-fixed-top").removeAttr("style"),this.$clone.hide().height(0),this.$wrapper[0].scrollTop=0),d(document).trigger("refresh-icons"),
this.type=e,this.log(e))};a.prototype.reset=function(){this.fixTo("default");this.offset=this.getOffset()};a.prototype.getOffset=function(){var e=this.$wrapper.offset();return{top:e.top,left:e.left,width:this.$wrapper.outerWidth(),height:this.$wrapper.outerHeight()}};a.prototype.log=function(e){this.debug&&console.log(e)};return a}(jQuery),b=function(d){function e(f){var g=0;f.indent&&(g="function"===typeof f.indent?f.indent():f.indent);return g}b=function(f){this.$window=d(window);this.$wrapper=
f.$wrapper;this.$outer_wrapper=f.$outer_wrapper;this.debug=f.debug;this.indent=f.indent;this.$clone=null;this.offset=this.getOffset();this.type=null;this.init()};b.prototype.init=function(){function f(){d.contains(document,l.$wrapper[0])?(l.reset(),l.onScroll()):d(document).off("refresh",f)}function g(){if(d.contains(l.$window[0].document,l.$wrapper[0]))l.onScroll();else l.$window.off("scroll",g)}var l=this;l.$clone=function(h){var n=d("<div />");h.before(n);return n.hide()}(l.$wrapper);l.onScroll();
var k=0;l.$window.on("resize",function(){clearTimeout(k);k=setTimeout(function(){l.reset();l.onScroll()},50)});d(document).on("refresh",f);l.$window.on("scroll",g)};b.prototype.onScroll=function(){var f=this.$window.scrollTop(),g=e(this),l=this.$window,k=l.width();l.height();l=this.offset;var h=this.$outer_wrapper.outerHeight();!(0<k)||h<=this.offset.height?this.fixTo("default"):f<=l.top-g?this.fixTo("default"):this.fixTo("fix_top")};b.prototype.fixTo=function(f,g){function l(){var n=h.getHeight();
h.$wrapper.css({position:"static",top:"auto",left:"auto",width:"auto",height:n});h.$clone.hide().height(0)}function k(){var n=h.getHeight();h.$wrapper.css({position:"fixed",top:e(h),left:h.offset.left,width:h.offset.width,height:n});h.$clone.css({height:n}).show()}var h=this;f=f?f:null;"fix_top"===f?(k(),h.type!==f&&h.$wrapper.addClass("is-fixed")):(l(),h.type!==f&&h.$wrapper.removeClass("is-fixed"));h.type=f;h.log(f)};b.prototype.reset=function(){this.fixTo("default");this.offset=this.getOffset()};
b.prototype.getOffset=function(){var f=this.$wrapper.offset();return{top:f.top,left:f.left,width:this.$wrapper.outerWidth(),height:this.$wrapper.outerHeight()}};b.prototype.log=function(f){this.debug&&console.log(f)};b.prototype.getHeight=function(){var f=this.$window.height(),g=e(this);this.offset.top-this.$window.scrollTop()>g&&(g=this.offset.top-this.$window.scrollTop());var l=this.$outer_wrapper.offset().top+this.$outer_wrapper.outerHeight(),k=this.$window.height()+this.$window.scrollTop();return f-
g-(0>l-k?Math.abs(l-k):0)};return b}(jQuery);CRMDeal=function(d){this.$wrapper=d.$wrapper;this.$aside=this.$wrapper.find(".c-deal-aside");this.$log_section=this.$wrapper.find(".js-deal-log-section");this.locales=d.locales;this.templates=d.templates;this.deal=d.deal||{};this.deal_id=this.deal.id||0;this.order_id=d.order_id||0;this.user_id=d.user_id;this.funnel_id=d.funnel_id;this.can_edit_deal=d.can_edit_deal||!1;this.shop_in_welcome_stage=d.shop_in_welcome_stage||!1;this.remove_is_locked=this.is_locked=
!1;this.init()};CRMDeal.prototype.init=function(){var d=this;c.crm.renderSVG(d.$wrapper);c.crm.sidebar.reload();d.can_edit_deal&&(d.initChangeState(),d.initCloseDeal(),d.initReopenDeal(),d.initAddContact(),d.initRemoveFiles(),d.initEditableName(),d.initChangeDate(),d.initChangePrice(),d.initChangeField(),d.initWYSIWYG(),d.initChangeDescription(),d.initChangeUser(),d.initChangeClient(),d.initDealDelete(),d.initAssignTags(),d.initCreateOrderLink(),d.initEditOrderLink());d.initCall();d.initMessages();
d.initOrderEditShippingDetailLink();d.initSticky();d.initOrderSection();d.initScroll();d.deal_id&&d.initLogSection();d.$wrapper.on("click",".js-remove-owner",function(e){e.preventDefault();d.remove_is_locked||d.removeOwner(c(this).closest(".c-contact"))});d.$wrapper.on("click",".js-remove-contact",function(e){e.preventDefault();d.remove_is_locked||d.removeContact(c(this).closest(".c-contact"))});d.$wrapper.on("click",".js-add-external-contact",function(e){e.preventDefault();d.addExternalContact(c(this))})};
CRMDeal.prototype.initLogSection=function(){var d=this.deal_id;this.$log_section.on("click",".js-open-conversation",function(e){e.preventDefault();e=c(this).attr("href");-1===e.indexOf("?")?window.location.href=e+"?deal_id="+d:window.location.href=e+"&deal_id="+d})};CRMDeal.prototype.initScroll=function(){function d(){c.contains(document,l.$wrapper[0])?f():k.off("scroll",d)}function e(){c.contains(document,l.$wrapper[0])?g():k.off("resize",e)}function f(){0<k.scrollTop()?n||(h.show(),n=!0):n&&(h.hide(),
n=!1)}function g(){var q=p.offset().left;h.css("right",k.width()-q)}var l=this,k=c(window),h=c('<div class="c-scroll-action"><div class="c-icon to-top"></div></div>'),n=!1,m=l.$wrapper.find(".c-deal-board"),p=l.$wrapper.find(".c-deal-aside-wrapper");m.append(h);f();g();h.on("click",function(){c("html, body").animate({scrollTop:0},500)});k.on("scroll",d);k.on("resize",e)};CRMDeal.prototype.initSticky=function(){function d(){0<f[0].scrollTop?f.addClass("is-scrolled"):f.removeClass("is-scrolled")}var e=
this.$wrapper.find(".js-page-header"),f=this.$wrapper.find("#js-deal-aside");new a({$wrapper:e,$outer_wrapper:this.$wrapper,debug:!1});new b({$wrapper:f,$outer_wrapper:f.closest(".c-deal-board"),indent:function(){return e.outerHeight()},debug:!1});d();f.on("scroll",d)};CRMDeal.prototype.initChangeState=function(){function d(f){function g(){c.crm.content.load(c.crm.app_url+"deal/"+e.deal_id+"/")}c.post("?module=deal&action=move",{deal_id:e.deal_id,stage_id:f},function(l){"ok"===l.status&&(l.data.dialog_html&&
l.data.dialog_html.html?new CRMDialog({html:l.data.dialog_html.html,options:{onShopSubmit:g},onConfirm:function(){c.post("?module=deal&action=move",{deal_id:e.deal_id,stage_id:f,force_execute:1},g)}}):g())},"json")}var e=this;e.$wrapper.find(".c-funnel-wrapper").on("click",".c-state-item.js-set-state",function(f){f.preventDefault();f=c(this);if(f.hasClass("selected"))return!1;f=f.data("id");d(f)})};CRMDeal.prototype.initCloseDeal=function(){var d=this,e=!1;d.$wrapper.on("click",".js-close-deal",function(f){f.preventDefault();
e||(e=!0,c.post("?module=deal&action=closeDialog",{id:d.deal_id},function(g){new CRMDialog({html:g})}).always(function(){e=!1}))})};CRMDeal.prototype.initReopenDeal=function(){var d=this,e=!1;d.$wrapper.on("click",".js-reopen-deal",function(f){f.preventDefault();e||(e=!0,c.post("?module=deal&action=reopen",{id:d.deal_id},function(g){"ok"==g.status?c.crm.content.reload():alert("Error: Deal Reopen")},"json").always(function(){e=!1}))})};CRMDeal.prototype.initAddContact=function(){function d(k,h){k=
k.closest(".c-add-contact");h?(l.hide(),k.addClass("is-shown")):(l.show(),k.removeClass("is-shown"))}function e(k,h){function n(m){m=m?m:[];c.each(m,function(p,q){p=q.text;var r=c('<div class="errormsg" />').html(p);l.one("click",function(){r.remove()});g.prepend(r)})}h=h?h:function(){};c.post("?module=deal&action=userAdd",{contact_id:k,deal_id:f.deal_id},function(m){"ok"===m.status?h(m.data.html):m.errors&&n(m.errors)},"json")}var f=this,g=f.$aside.find(".js-add-user-wrapper"),l=g.find(".js-add-contact");
l.on("click",function(k){k.preventDefault();d(c(this),!0)});g.on("click",".js-close-add-contact",function(k){k.preventDefault();d(c(this))});(function(){function k(n,m){var p=f.$aside.find('.c-contact[data-id="'+n+'"]');p.length&&h(p);e(n,function(q){q=c(q);m.before(q);h(q);c(document).trigger("refresh")})}function h(n){n.addClass("is-highlight");setTimeout(function(){c.each(n,function(m,p){c.contains(document,p)&&c(this).removeClass("is-highlight")})},3E3)}f.$aside.find(".js-contact-autocomplete").each(function(){var n=
c(this);n.autocomplete({appendTo:f.$aside,source:c.crm.app_url+"?module=autocomplete&type=user&funnel_id="+f.funnel_id,minLength:0,html:!0,focus:function(){return!1},select:function(m,p){k(p.item.id,n.closest(".c-add-contact"));n.val("");f.$aside.find(".js-close-add-contact").trigger("click");return!1}}).data("ui-autocomplete")._renderItem=function(m,p){var q=c("<li />");q.addClass("ui-menu-item-html").append("<div>"+p.value+"</div>").appendTo(m);p.rights||(q.addClass("is-locked"),q.on("click",function(r){r.preventDefault();
r.stopPropagation()}));return q};n.on("focus",function(){n.data("uiAutocomplete").search(n.val())})})})()};CRMDeal.prototype.initRemoveFiles=function(){function d(g,l){c.post("?module=file&action=delete",{id:g},function(k){"ok"==k.status?l.remove():console&&console.log&&console.log("File Remove Error")})}var e=this,f;e.$wrapper.find(".c-files-wrapper").on("click",".js-remove-file",function(g){g.preventDefault();var l=c(this).closest(".c-file");g=l.find(".c-name").text();var k=parseInt(l.data("id"));
f&&f.abort();g={title:e.locales.remove_file_title,text:e.locales.remove_file_text.replace(/%s/,g),ok_button:e.locales.remove_file_button};0<k?f=c.post("?module=dialogConfirm",g,function(h){new CRMDialog({html:h,onConfirm:function(){d(k,l)}})}).always(function(){f=!1}):console&&console.log&&console.log("File ID is empty")})};CRMDeal.prototype.initEditableName=function(){var d=this.$wrapper.find(".js-editable").first();if(!(0>=d.length)){var e=c.crm.app_url+"?module=deal&action=rename",f=this.deal_id,
g=null;new CrmEditable({$wrapper:d,onSave:function(l){var k=l.$field.val();if(k.length&&l.text!==k){g&&g.abort();k={id:f,name:k};l.$field.attr("disabled",!0);var h=c('<i class="icon16 loading"></i>').css("margin","0 0 0 4px").insertAfter(l.$field);g=c.post(e,k,function(n){l.$field.attr("disabled",!1);h.remove();l.toggle("hide");n&&n.data&&n.data.deal&&(l.text=n.data.deal.name,l.$wrapper.text(n.data.deal.name),c.crm.title.set(n.data.deal.name))})}else k.length||l.$field.val(l.text),l.toggle("hide")}})}};
CRMDeal.prototype.initChangeDate=function(){function d(m){m?(g.addClass("is-shown"),h.focus()):(g.removeClass("is-shown"),h.datepicker("hide"))}function e(m){h.val()||(m="");c.post("?module=deal&action=changeExpectedDate",{id:f.deal_id,expected_date:m?m:""},function(p){"ok"==p.status&&p.data&&p.data.deal&&((p=p.data.deal.expected_date)?(l.hide(),k.show().find(".js-name").text(p)):(k.hide().find(".js-name").text(""),l.show()),d())},"json")}var f=this,g=f.$wrapper.find(".js-date-toggle");if(!g.length)return!1;
var l=g.find(".js-link"),k=g.find(".js-span"),h=g.find(".js-datepicker"),n=g.find(".js-field");g.on("click",".js-set-date",function(m){m.preventDefault();d(!0)});h.on("keydown keypress keyup",function(m){27===m.keyCode&&d()});g.on("click",".js-close-edit-date",function(){d()});(function(){h.datepicker({altField:n,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,onSelect:function(){var m=h.val(),p=n.val(),q=c.datepicker._defaults.dateFormat,r=!1;try{c.datepicker.parseDate(q,m),r=!0}catch(u){}if(r)e(p);
else return!1}});h.val()||h.datepicker("setDate","+0d")})()};CRMDeal.prototype.initChangePrice=function(){function d(p){p?l.addClass("is-shown"):l.removeClass("is-shown")}function e(p,q){c.post("?module=deal&action=changeAmount",{id:g.deal_id,amount:p?p:"",currency_id:q?q:""},function(r){"ok"==r.status&&r.data&&r.data.deal&&((r=r.data.deal.amount)?(k.hide(),h.show().text(r)):(h.hide().text(""),k.show()),d())},"json")}function f(){var p=n.val(),q=m.val(),r=!1;p&&(r=p.replace(",","."));0<=r?e(p,q):
n.addClass("error")}var g=this,l=g.$wrapper.find(".js-price-toggle");if(!l.length)return!1;var k=l.find(".js-link"),h=l.find(".js-span"),n=l.find(".js-price-field"),m=l.find(".js-currency-field");l.on("click",".js-set-price",function(p){p.preventDefault();d(!0)});l.on("click",".js-save-price",function(p){p.preventDefault();f()});l.on("click",".js-cancel",function(p){p.preventDefault();d()});n.on("focus",function(){n.hasClass("error")&&n.removeClass("error")});n.on("keydown",function(p){13===p.keyCode&&
(p.preventDefault(),f())})};CRMDeal.prototype.initChangeField=function(){function d(h,n){var m=c(h).parents(".js-field-toggle");n?(m.find(".c-hidden").css({height:c(h).height()+8}),c(h).closest(".js-field-toggle").hasClass("js-textarea")?(m.addClass("is-shown").find(".c-hidden").css("width","100%"),m.find("textarea").slideDown().next().find(".icon16").removeClass("loading").addClass("disk"),m.css({width:"100%","margin-left":0}).prev().hide()):(m.addClass("is-shown"),m.find(".js-datepicker-field").focus())):
c(document).trigger("mousedown")}function e(h){var n=l.data("deal-id"),m="",p=c(h).data("field-id"),q=c(h).data("field-type"),r=!1;switch(q){case "checkbox":c(h).prop("required")&&!c(h).prop("checked")?(r=!0,c(h).addClass("error")):m=Number(c(h).prop("checked"));break;case "date":var u=c(h).siblings(".js-datepicker-field"),v=c.datepicker._defaults.dateFormat,t=!1;try{c.datepicker.parseDate(v,u.val()),t=!0}catch(x){}""!=u.val()&&""!=u.val().trim()&&t||!c(h).prop("required")?m=u.val():(r=!0,u.addClass("error"));
break;case "text":u=c(h).parents(".c-hidden").find(".js-field-value-text");u.next().find(".icon16").removeClass("disk").addClass("loading");""!=u.val()&&""!=u.val().trim()||!u.prop("required")?m=u.val():(r=!0,c(h).parents(".c-hidden").find(".js-field-value-text").addClass("error"));break;case "select":var w=c(h).val();t=!1;c(h).find("option").each(function(x,y){c(y).val()==w&&(t=!0)});!t||""==w&&c(h).prop("required")?(r=!0,c(h).addClass("error")):m=w;break;case "radio":m=c(h).find(":checked").val();
break;case "number":w=c(h).val().replace(",",".");(""==w||isNaN(Number(w)))&&c(h).prop("required")?(r=!0,c(h).addClass("error")):m=w;break;default:w=c(h).val(),""!=w&&""!=w.trim()||!c(h).prop("required")?m=w:(r=!0,c(h).addClass("error"))}r||f(h,{id:n,field_id:p,value:m,value_type:q})}function f(h,n){c.post("?module=deal&action=changeValue",n,function(m){if("ok"==m.status){if(m.data&&m.data.deal_params){m=m.data.deal_params.value;var p=c(h).parents(".js-field-toggle").find(".js-output-value");m?(p.text(m),
c(h).removeClass("error")):(p.text(p.data("empty-text")),c(h).siblings(".js-datepicker-field").datepicker("hide"));d(h,!1)}}else c(h).addClass("error")},"json")}var g=this.$wrapper.find(".js-field-toggle"),l=c(".c-deal-options-section");if(!g.length)return!1;var k=g.find(".js-field-value");g.on("click",".js-output-value",function(h){h.preventDefault();d(this,!0)});g.on("click",".js-save-field",function(h){h.preventDefault();e(this)});g.on("click",".js-cancel",function(h){h.preventDefault();c(document).trigger("mousedown")});
g.on("click",".js-field-value-checkbox",function(){e(this)});g.on("change",".js-field-value-select",function(h){h.preventDefault();e(this)});g.on("click",".js-field-value-radio-block input",function(){e(c(this).closest(".js-field-value-radio-block"))});g.on("click",".js-field-value-radio-block .js-clear-link",function(h){h.preventDefault();h=c(this).closest(".js-field-value-radio-block");h.find(":checked").attr("checked",!1);e(h)});k.on("focus",function(){k.hasClass("error")&&k.removeClass("error")});
c(document).on("mousedown",function(h){0!==g.has(h.target).length||g.is(h.target)||g.each(function(n,m){var p=c(m);n=p.find("textarea");p.hasClass("js-textarea")?n.slideUp(function(){p.removeClass("is-shown").removeAttr("style").prev().show()}):p.removeClass("is-shown")})});k.on("keydown",function(h){13===h.keyCode&&(h.preventDefault(),c(this).hasClass("js-datepicker-field")?e(c(this).siblings(".js-field-value")):e(this))});(function(){var h=l.find(".js-datepicker-field"),n=h.siblings(".js-field-value");
h.datepicker({altField:n,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,onSelect:function(){var m=c(this).siblings(".js-field-value");e(m)}})})()};CRMDeal.prototype.initWYSIWYG=function(){var d=this.$wrapper.find(".js-wysiwyg");if(!d.length)return!1;c.crm.initWYSIWYG(d,{keydownCallback:function(e){}})};CRMDeal.prototype.initChangeDescription=function(){function d(k){k?g.addClass("is-shown"):g.removeClass("is-shown")}function e(k){c.post("?module=deal&action=changeDescription",k,function(h){if("ok"==
h.status){if(h.data&&h.data.deal_description){h=h.data.deal_description.value;var n=g.find(".js-output-value");h?(n.find(".c-description").html(h).show(),n.find(".js-add-description").hide()):(n.find(".js-add-description").show(),n.find(".c-description").html("").hide());d(!1)}}else c(f).addClass("error")},"json")}var f=this,g=f.$wrapper.find(".c-description-section .js-description-toggle");if(!g.length)return!1;var l=g.find(".js-field-value");g.on("click",".js-add-description, .js-edit-description",
function(k){k.preventDefault();d(!0)});g.on("hover",".c-description-wrapper",function(){""!=g.find(".c-description").html()&&g.find(".js-edit-description").css("visibility","visible")});g.on("mouseleave",".c-description-wrapper",function(){g.find(".js-edit-description").css("visibility","hidden")});g.on("click",".js-save-description",function(k){k.preventDefault();k=g.find('input[name="data[deal_id]"]').val();var h=g.find(".js-description-value").val();e({id:k,value:h})});g.on("click",".js-cancel",
function(k){k.preventDefault();d(!1)});l.on("focus",function(){l.hasClass("error")&&l.removeClass("error")})};CRMDeal.prototype.initChangeUser=function(){function d(h){if(!h.length)return!1;var n=h.closest(".c-contact");h.autocomplete({appendTo:n,source:"?module=autocomplete&type=user&funnel_id="+l.funnel_id,minLength:0,html:!0,focus:function(){return!1},select:function(m,p){e(p.item.id,n);h.val("");return!1}}).data("ui-autocomplete")._renderItem=function(m,p){var q=c("<li />");q.addClass("ui-menu-item-html").append("<div>"+
p.value+"</div>").appendTo(m);p.rights||(q.addClass("is-locked"),q.on("click",function(r){r.preventDefault();r.stopPropagation()}));return q};h.on("focus",function(){h.data("uiAutocomplete").search(h.val())})}function e(h,n){k?g(n):f(h,function(){k=!0;c.post("?module=deal&action=changeUser",{id:l.deal_id,user_contact_id:h},function(m){if("ok"!==m.status)m.errors?console.error(m.errors):console.error(m),c.crm.alert.show({title:"Error",button:"Error"});else if(m.data=m.data||{},m.data.deal_access_denied)window.location.href=
c.crm.app_url+"deal/";else if(m.data.html){m=c(m.data.html);var p=l.$aside.find('.c-users-section .c-contact[data-id="'+h+'"]').not(n);p.length&&p.remove();n.replaceWith(m);d(m.find(".js-owner-autocomplete"))}},"json").always(function(){k=!1})})}function f(h,n){c.post("?module=deal&action=changeUserConfirm",{id:l.deal_id,user_contact_id:h},"json").done(function(m){m.data&&m.data.need_confirm?new CRMDialog({html:m.data.html||"",onOpen:function(p,q){p.find(".js-confirm-button").on("click",function(){n()})}}):
n()})}function g(h,n){n?h.addClass("is-edit"):h.removeClass("is-edit")}var l=this,k=!1;l.$aside.on("click",".js-show-combobox",function(h){h.preventDefault();h=c(this).closest(".c-contact");g(h,!0)});l.$aside.on("click",".js-hide-combobox",function(h){h.preventDefault();h=c(this).closest(".c-contact");g(h)});l.$aside.find(".js-owner-autocomplete").each(function(){d(c(this))});(function(){function h(q){m||f(q,function(){m=!0;c.post("?module=deal&action=changeUser",{id:l.deal_id,user_contact_id:q},
function(r){if("ok"===r.status)if(r.data.deal_access_denied)window.location.href=c.crm.app_url+"deal/";else{r=c(r.data.html);var u=l.$aside.find('.c-users-section .c-contact[data-id="'+l.user_id+'"]');u.length&&u.remove();l.$aside.find('.c-contact[data-id="'+r.data("id")+'"]').remove();p.after(r).css("display","none");l.$aside.find(".js-add-user-wrapper").show();d(r.find(".js-owner-autocomplete"))}},"json").always(function(){m=!1})})}function n(q){q?p.addClass("is-extended"):p.removeClass("is-extended")}
var m=!1,p=l.$aside.find(".js-empty-user-wrapper");p.on("click",".js-set-user-me",function(q){q.preventDefault();h(l.user_id)});p.on("click",".js-set-extended",function(q){q.preventDefault();n(!0)});p.on("click",".js-unset-extended",function(q){q.preventDefault();n(!1)});(function(){p.find(".js-empty-user-autocomplete").each(function(){var q=c(this);q.autocomplete({appendTo:p,source:"?module=autocomplete&type=user&funnel_id="+l.funnel_id,minLength:0,html:!0,focus:function(){return!1},select:function(r,
u){h(u.item.id);q.val("");return!1}}).data("ui-autocomplete")._renderItem=function(r,u){var v=c("<li />");v.addClass("ui-menu-item-html").append("<div>"+u.value+"</div>").appendTo(r);u.rights||(v.addClass("is-locked"),v.on("click",function(t){t.preventDefault();t.stopPropagation()}));return v};q.on("focus",function(){q.data("uiAutocomplete").search(q.val())})})})()})()};CRMDeal.prototype.initChangeClient=function(){function d(k,h,n){g||(g=!0,c.post("?module=deal&action=changeClient",{deal_id:e.deal_id,
client_type:n,contact_id:h},function(m){var p=new CRMDialog({html:m,options:{onChange:function(q){1===p.$block.find(".js-view-toggle > .is-active").data("id")?k.replaceWith(q):(k.replaceWith(q.html),(parseInt(e.deal.contact_id)||0)===h&&q.contact.id!==h&&(e.deal.contact_id=q.contact.id));k.find(".js-add-company-contact").show();c(document).trigger("refresh")}}})}).always(function(){g=!1}))}var e=this,f=e.$wrapper.find(".js-contacts-section"),g=!1;f.on("click",".js-edit-company-owner",function(k){k.preventDefault();
k=c(this).closest(".c-contact");var h=k.data("type"),n=k.data("id");d(k,n,h)});var l=f.find(".js-empty-contact-wrapper");if(l.length)l.on("click",".js-set-company-owner",function(k){k.preventDefault();d(l,"","contact_owner")})};CRMDeal.prototype.initDealDelete=function(){function d(){f||(f=!0,c.post(c.crm.app_url+"?module=deal&action=delete",{id:e.deal_id},function(g){"ok"===g.status&&c.crm.content.load(c.crm.app_url+"deal/")},"json").always(function(){f=!1}))}var e=this,f=!1;e.$wrapper.on("click",
".js-deal-delete",function(g){g.preventDefault();c.crm.confirm.show({title:e.locales.delete_deal_title,text:e.locales.delete_deal_text,button:e.locales.delete_deal_button,onConfirm:d})})};CRMDeal.prototype.initCall=function(){var d=this,e=!1;d.$wrapper.on("click",".js-show-call-dialog",function(f){f.preventDefault();var g=c(this);f=g.data("id");g=g.data("phone");!e&&f&&g&&(e=!0,c.post("?module=call&action=initContactDialog",{deal_id:d.deal_id,contact_id:f,phone:g},function(l){new CRMDialog({remain_after_load:!0,
html:l})}).always(function(){e=!1}))})};CRMDeal.prototype.initOrderSection=function(){var d=this.$wrapper.find(".c-order-section"),e=d.find(".c-order-details"),f=d.find(".c-products-wrapper");e.on("click",".js-details-toggle",function(g){g.preventDefault();g=c(this).find(".icon16");e.hasClass("is-extended")?(g.removeClass("darr").addClass("rarr"),e.removeClass("is-extended")):(g.removeClass("rarr").addClass("darr"),e.addClass("is-extended"));c(document).trigger("refresh")});f.on("click",".js-products-toggle",
function(g){g.preventDefault();g=c(this).find(".icon16");f.hasClass("is-extended")?(g.removeClass("darr").addClass("rarr"),f.removeClass("is-extended")):(g.removeClass("rarr").addClass("darr"),f.addClass("is-extended"));c(document).trigger("refresh")})};CRMDeal.prototype.initMessages=function(){this.initSendEmail();this.initSendSMS()};CRMDeal.prototype.initSendEmail=function(){var d=this,e=!1;d.$wrapper.on("click",".js-show-message-dialog",function(f){f.preventDefault();var g=c(this);f=g.data("id");
g=g.data("email");!e&&f&&(e=!0,c.post("?module=message&action=writeDealDialog",{deal_id:d.deal_id,contact_id:f,email:g},function(l){new CRMDialog({html:l})}).always(function(){e=!1}))})};CRMDeal.prototype.initSendSMS=function(){var d=this,e=!1;d.$wrapper.on("click",".js-show-send-sms-dialog",function(f){f.preventDefault();var g=c(this);f=g.data("id");g=g.data("phone");!e&&f&&(e=!0,c.get("?module=message&action=writeSMSDealDialog",{deal_id:d.deal_id,contact_id:f,phone:g},function(l){new CRMDialog({html:l})}).always(function(){e=
!1}))})};CRMDeal.prototype.addExternalContact=function(d){c.get(c.crm.app_url+"?module=deal&action=addParticipant",{id:this.deal_id},function(e){new CRMDialog({html:e,options:{onAdd:function(f){d.closest(".c-add-contact").before(f);c(document).trigger("refresh")}}})})};CRMDeal.prototype.removeOwner=function(d){function e(k,h){k={owner_id:k,deal_id:h};var n=c(".js-empty-user-wrapper");f.remove_is_locked=!0;c.post("?module=deal&action=ownerDelete",k,function(m){"ok"==m.status&&(d.remove(),n.fadeIn())},
"json").always(function(){f.remove_is_locked=!1})}var f=this,g=d.data("id"),l=c.trim(d.find(".c-name").html());c.crm.confirm.show({title:f.locales.remove_owner_title,text:f.locales.remove_owner_text.replace(/%s/,l),button:f.locales.remove_owner_button,onConfirm:function(){e(g,f.deal_id)}})};CRMDeal.prototype.removeContact=function(d){function e(k,h,n){k={contact_id:k,deal_id:h,role_id:n};f.remove_is_locked=!0;c.post("?module=deal&action=contactDelete",k,function(m){"ok"==m.status&&d.remove()},"json").always(function(){f.remove_is_locked=
!1})}var f=this,g=d.data("id"),l=c.trim(d.find(".c-name").html());c.crm.confirm.show({title:f.locales.remove_contact_title,text:f.locales.remove_contact_text.replace(/%s/,l),button:f.locales.remove_contact_button,onConfirm:function(){e(g,f.deal_id,d.data("role-id"))}})};CRMDeal.prototype.initAssignTags=function(){var d=this.$wrapper.find(".js-assign-tags"),e=c.crm.app_url+"?module=dealOperation&action=assignTags&is_assign=1",f=parseInt(this.deal_id)||0;d.click(function(g){g.preventDefault();c.get(e,
{deal_ids:[f]},function(l){new CRMDialog({html:l})})})};CRMDeal.prototype.initOrderEditShippingDetailLink=function(){var d=this;d.$wrapper.find(".js-order-edit-shipping-details-link").click(function(){var e=c(this).parent().find(".js-order-edit-shipping-details-loading");e.show();d.loadEditOrderShippingDetailsDialog(d.order_id,{onLoad:function(){e.hide()}})})};CRMDeal.prototype.initCreateOrderLink=function(){var d=this;d.$wrapper.on("click",".js-create-order-link",function(e){e.preventDefault();if(d.shop_in_welcome_stage)c.crm.alert.show({title:d.locales.shop_alert_title||
"",text:d.locales.shop_in_welcome_stage||""});else{var f=c(this);f.addClass("is-loading");d.loadEditOrderDialog(0,{onLoad:function(){f.removeClass("is-loading")}})}})};CRMDeal.prototype.initEditOrderLink=function(){var d=this;d.$wrapper.on("click",".js-edit-order-link",function(e){e.preventDefault();if(d.shop_in_welcome_stage)c.crm.alert.show({title:d.locales.shop_alert_title||"",text:d.locales.shop_in_welcome_stage||""});else{var f=c(this);f.addClass("is-loading");d.loadEditOrderDialog(d.order_id,
{onLoad:function(){f.removeClass("is-loading")}})}})};CRMDeal.prototype.loadEditOrderDialog=function(d,e){var f=this.deal||{},g=c(this.templates.create_order_dialog_html),l=e.onLoad||function(){};g.hide();new CRMDialog({html:g,onOpen:function(){var k=this,h=c.crm.backend_url+"shop/?module=order&action=embededit",n=g.find(".crm-dialog-content");0<f.contact_id&&(h+="&customer_id="+f.contact_id);0<d&&(h+="&id="+d);n.html('<iframe src="'+h+'" class="c-content-iframe">');var m=n.find("iframe");m.one("load",
function(){l();k.show();k.resize();var p=m.get(0);c(p.contentWindow.document).find("#order-edit-form").append('<input type="hidden" name="crm_deal[id]" value="'+f.id+'">');p.contentWindow.$.order_edit.container.on("order_edit_save_success",function(){k.close();c.crm.content.reload()})})}})};CRMDeal.prototype.loadEditOrderShippingDetailsDialog=function(d,e){if(0>=d)console.error("Invalid input parameter");else{var f=this.$wrapper.find(".js-deal-edit-order-shipping-details-dialog").clone(),g=e.onLoad||
function(){};f.hide();new CRMDialog({html:f,onOpen:function(){var l=this,k=c.crm.backend_url+"shop/?module=workflow&action=prepare",h=f.find(".crm-dialog-content");c.post(k,{action_id:"editshippingdetails",id:d},function(n){h.html(n);h.find(".js-form-footer-actions").hide();l.show();l.resize();n=h.find("#wf-ship-form").height();f.find(".crm-dialog-block").height(n+150);var m=f.find(".js-submit-dialog-loading"),p=h.find(".js-form-footer-actions .js-submit-button");f.find(".js-submit-dialog-button").on("click",
function(q){q.preventDefault();if(p.is(":disabled"))return!1;h.bind("formSend",function(){m.hide();l.close();c.crm.content.reload()});m.show();p.trigger("click")});g&&g()})}})}};return CRMDeal}(jQuery),CRMDealChangeWorkflowDialog=function(c){CRMDealChangeWorkflowDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form").first();this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMDealChangeWorkflowDialog.prototype.initClass=function(){var a=this;a.$wrapper.find(".js-form-footer-actions").hide();
a.$wrapper.on("click",".js-submit-dialog-button",function(){a.$form.find(".js-submit-button").trigger("click")});a.$form.on("formSend",function(){if(a.dialog.options&&a.dialog.options.onShopSubmit)a.dialog.options.onShopSubmit();a.dialog.close()})};return CRMDealChangeWorkflowDialog}(jQuery);var CRMDealCloseDialog=function(c){CRMDealCloseDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$reasonSelect=this.$wrapper.find(".js-reason-select");this.$reasonFieldW=this.$wrapper.find(".js-reason-text");this.dialog=this.$wrapper.data("dialog");this.deal_id=a.deal_id;this.reason_require=a.reason_require;this.is_locked=!1;this.initClass()};CRMDealCloseDialog.prototype.initClass=function(){var a=this;a.$wrapper.on("click",".js-set-won",function(b){b.preventDefault();
a.setWon()});a.$wrapper.on("click",".js-show-form",function(b){b.preventDefault();a.showLostForm()});a.$wrapper.on("click",".js-set-lost",function(b){b.preventDefault();a.$form.trigger("submit")});a.$form.on("submit",function(b){b.preventDefault();a.setLost()});a.$reasonSelect.on("change",function(){c(this).val()?a.$reasonFieldW.hide():a.$reasonFieldW.show()})};CRMDealCloseDialog.prototype.showLostForm=function(a){var b=this.$wrapper.find(".c-visible"),d=this.$wrapper.find(".c-hidden");a?(b.show(),
d.hide()):(b.hide(),d.show());this.dialog.resize()};CRMDealCloseDialog.prototype.setWon=function(){var a=this;if(!a.is_locked){a.is_locked=!0;var b={id:a.deal_id,action:"WON"};c.post("?module=deal&action=close",b,function(d){"ok"===d.status&&a.afterRequest("?module=deal&action=close",b,d)}).always(function(){a.is_locked=!1})}};CRMDealCloseDialog.prototype.setLost=function(){function a(){var e=b.$form.serializeArray();e.push({name:"id",value:b.deal_id});e.push({name:"action",value:"LOST"});if(b.reason_require&&
!b.$reasonSelect.val())if(b.$reasonFieldW.is(":visible")){var f=b.$reasonFieldW.find("input");f.val()||(f.addClass("error").one("focus",function(){c(this).removeClass("error")}),e=!1)}else b.$reasonSelect.addClass("error").one("change",function(){c(this).removeClass("error")}),e=!1;return e}var b=this;if(!b.is_locked){b.is_locked=!0;var d=a();d?c.post("?module=deal&action=close",d,function(e){"ok"===e.status&&b.afterRequest("?module=deal&action=close",d,e)}).always(function(){b.is_locked=!1}):b.is_locked=
!1}};CRMDealCloseDialog.prototype.afterRequest=function(a,b,d){function e(){f.dialog.close();c.crm.content.reload()}var f=this;d.data.dialog_html&&d.data.dialog_html.html?new CRMDialog({html:d.data.dialog_html.html,onOpen:function(g){var l=g.find("form");l.length&&!c.isEmptyObject(b)&&c.each(b,function(k,h){l.append('<input type="hidden" name="crm_change_workflow_data['+h.name+']" value="'+h.value+'">')})},options:{onShopSubmit:e},onConfirm:function(){b.push({name:"force_execute",value:1});c.post(a,
b,e)}}):e()};return CRMDealCloseDialog}(jQuery);var CRMDealEdit=function(c){CRMDealEdit=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("#js-deal-edit-form");this.$deal_name_input=this.$form.find('[name="deal[name]"]');this.deal_id=a.deal_id;this.locales=a.locales;this.urls=a.urls;this.can_edit_contact=a.can_edit_contact||!1;this.suggester_values={};this.contact_mode=a.contact_mode||"edit";this.initClass()};CRMDealEdit.prototype.initClass=function(){this.initChangeCompanyContact();this.initEstimatedDate();this.initSuggestName();
this.initChangeFunnel();this.initWYSIWYG();this.initFieldsBlock();this.initSave();this.initCombobox()};CRMDealEdit.prototype.initEstimatedDate=function(){function a(){var f=c.datepicker._defaults.dateFormat,g=!1;try{c.datepicker.parseDate(f,d.val()),g=!0}catch(l){}g?(d.data("last-correct-value",d.val()),e.data("last-correct-value",e.val())):(d.val(d.data("last-correct-value")||""),e.val(e.data("last-correct-value")||""))}var b=this.$wrapper.find(".c-estimated-close-date-field").find(".js-datepicker-wrapper"),
d=b.find(".js-datepicker"),e=b.find('[name="deal[expected_date]"]');d.datepicker({altField:e,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,onSelect:a});d.on("blur",a);d.on("keydown keypress keyup",function(f){13===f.which&&f.preventDefault()});d.on("click",".js-icon",function(){d.focus()})};CRMDealEdit.prototype.initSave=function(){function a(){for(var m={data:[],errors:[]},p=l.serializeArray(),q=0;q<p.length-1;q++)for(var r=q+1;r<p.length;r++)p[q].name==p[r].name&&(""==p[q].value?p.splice(q,
1):""==p[r].value&&p.splice(r,1));c.each(p,function(u,v){u=c('[name="'+v.name+'"]');var t=0<c('[name="'+v.name+'"][type="radio"]').length,w=""==v.value||""==v.value.trim();1==c(u).prop("required")&&w&&m.errors.push({name:v.name,value:g.locales.bad_amount,is_radio:t});"deal[amount]"===v.name&&(v.value.length&&(v.value=c.trim(v.value)),t=v.value,u=!1,t.length&&(t=t.replace(",","."),0<t||"0"===t)&&(u=!0),u||m.errors.push({name:v.name,value:g.locales.bad_amount}));m.data.push(v)});"edit"===g.contact_mode?
g.can_edit_contact&&e(m):f(m);return m}function b(m){m&&m[0]||(m=[]);c.each(m,function(p,q){p=q.name;var r=q.value;if(q=q.is_radio)var u=g.$wrapper.find('[name="'+p+"\"][type='hidden']"),v=g.$wrapper.find('[name="'+p+"\"][type='radio']");else u=g.$wrapper.find('[name="'+p+'"]');"contact[firstname]"!==p||u.is(":visible")||(u=g.$wrapper.find(".js-contact-autocomplete"));var t=c("<span class='c-error' />").addClass("errormsg").text(r);if(u.length&&!u.hasClass("error"))if(u.parent().append(t),u.addClass("error"),
q)v.one("focus click change",function(){u.removeClass("error");t.remove()});else u.one("focus click change",function(){u.removeClass("error");t.remove()});else k.append(t),l.one("submit",function(){t.remove()})})}function d(m){if(!n){n=!0;var p=c.crm.app_url+"?module=deal&action=save";h.attr("disabled","disabled").prop("disabled",!0);var q=g.$wrapper.find(".loading");q.show();c.post(p,m,function(r){"ok"===r.status?c.crm.content.load(c.crm.app_url+"deal/"+r.data.deal.id+"/"):r.errors&&b(r.errors)},
"json").always(function(){q.hide();n=!1;h.removeAttr("disabled").prop("disabled",!1)})}}function e(m){var p=g.$wrapper.find("#c-contact-edit-form").closest("form"),q=p.find(".js-phone-list"),r=p.find(".js-email-list");p=p.serializeArray();var u=["contact[firstname]","contact[middlename]","contact[lastname]","contact[name]"],v=!0;c.each(p,function(t,w){m.data.push({name:w.name,value:w.value});0<c.trim(w.value).length&&0<=u.indexOf(w.name)&&(v=!1)});v&&(m.errors.push({name:"contact[firstname]",value:g.locales.empty_name}),
m.errors.push({name:"contact[name]",value:g.locales.empty_name}));q.find("li").each(function(t){var w=c(this),x=w.find(".js-value");w=w.find(".js-ext");var y=x.val(),z=w.val();if(y){var B="contact[phone]["+t+"][value]";x.attr("name",B);m.data.push({name:B,value:y});t="contact[phone]["+t+"][ext]";w.attr("name",t);m.data.push({name:t,value:z})}});r.find("li").each(function(t){var w=c(this),x=w.find(".js-value");w=w.find(".js-ext");var y=x.val(),z=w.val();if(y){var B="contact[email]["+t+"][value]";x.attr("name",
B);m.data.push({name:B,value:y});t="contact[email]["+t+"][ext]";w.attr("name",t);m.data.push({name:t,value:z})}});return m}function f(m){var p=g.$wrapper.find("#c-contact-add-form").closest("form").serializeArray(),q=!1,r=!1;c.each(p,function(u,v){u=v.name;var t=v.value;"deal[contact_id]"===u&&t&&(q=!0);"contact[firstname]"===u&&t&&(r=!0);"contact[lastname]"===u&&t&&(r=!0);"contact[middlename]"===u&&t&&(r=!0);"contact[name]"===u&&t&&(r=!0);m.data.push(v)});q||r||(m.errors.push({name:"contact[name]",
value:g.locales.empty_name}),m.errors.push({name:"contact[firstname]",value:g.locales.empty_name}))}var g=this,l=g.$form,k=g.$form.find(".js-errors-place"),h=g.$wrapper.find(".js-submit-button"),n=!1;h.on("click",function(){l.trigger("submit")});l.on("submit",function(m){m.preventDefault();m=a();m.errors.length?b(m.errors):d(m.data)})};CRMDealEdit.prototype.initSuggestName=function(){var a=this,b=a.$form,d=a.$deal_name_input;if(!d.data("edited")){d.one("mark-edited.crm-deal-suggestion",function(){d.data("edited",
1);d.off(".crm-deal-suggestion");b.off(".crm-deal-suggestion",".js-crm-deal-name-suggester-input")});d.on("keyup.crm-deal-suggestion",function(){var l=c(this);0<c.trim(l.val()).length&&l.trigger("mark-edited")});var e=null,f=null,g=function(){e&&(e.abort(),e=null);d.data("edited")||(e=c.post(c.crm.app_url+"?module=deal&action=suggestName",a.suggester_values,function(l){"ok"!==l.status||d.data("edited")||d.val(c.trim(l.data&&l.data.name)||"")}))};b.on("keyup.crm-deal-suggestion change.crm-deal-suggestion",
".js-crm-deal-name-suggester-input",function(l){var k=c(this);f&&clearTimeout(f);f=setTimeout(function(){if(k.hasClass("crm-find-contact-input")){if("keyup"===l.type)return;k=b.find('[name="deal[id]"]')}var h=k.attr("name")||"",n=c.trim(k.val());if(h){a.suggester_values[h]=c.trim(a.suggester_values[h]);if(a.suggester_values[h]===n)return;a.suggester_values[h]=n}g()},250)})}};CRMDealEdit.prototype.initChangeCompanyContact=function(){var a=this,b=a.$wrapper.find(".js-contact-block"),d=b.find(".js-view-toggle"),
e=d.find(".is-active");d.on("click",".c-toggle",function(f){f.preventDefault();f=c(this);var g=f.data("id");if(f.hasClass("is-active"))return!1;a.contact_mode=g;e.length&&e.removeClass("is-active");f.addClass("is-active");e=f;b.find(".c-hidden.is-active").removeClass("is-active");b.find(".c-hidden-"+g).addClass("is-active")})};CRMDealEdit.prototype.initChangeFunnel=function(){var a=this;a.$form.on("change",".js-select-deal-funnel",function(){a.$form.find(".js-select-stage-wrapper").load("?module=deal&action=stagesByFunnel&id="+
c(this).val())})};CRMDealEdit.prototype.initWYSIWYG=function(){var a=this.$wrapper.find(".js-wysiwyg");if(!a.length)return!1;c.crm.initWYSIWYG(a,{keydownCallback:function(b){}})};CRMDealEdit.prototype.initFieldsBlock=function(){var a=this.$wrapper.find(".js-ext-fields-section");a.on("click",".js-ext-fields-toggle",function(){a.toggleClass("is-extended");c(".js-show-fields-button, .js-hide-fields-button").removeAttr("style")})};CRMDealEdit.prototype.initCombobox=function(){function a(f){f?d.addClass("is-shown"):
d.removeClass("is-shown")}var b=this,d=b.$form.find(".js-contact-owner-wrapper"),e=d.find(".js-field");d.on("click",".js-show-combobox",function(f){f.stopPropagation();a(!0)});d.on("click",".js-hide-combobox",function(f){f.stopPropagation();a(!1)});(function(){var f=d.find(".js-autocomplete");f.autocomplete({appendTo:d,position:{my:"right top",at:"right bottom"},source:b.urls.owner_autocomplete,minLength:0,html:!0,focus:function(){return!1},select:function(g,l){g=l.item;l=d.find(".js-user");g.photo_url&&
l.find(".userpic20").css("background-image","url("+g.photo_url+")");l.find(".c-name").text(g.name);e.val(g.id);a(!1);f.val("");return!1}}).data("ui-autocomplete")._renderItem=function(g,l){return c("<li />").addClass("ui-menu-item-html").append("<div>"+l.value+"</div>").appendTo(g)};f.on("focus",function(){f.data("uiAutocomplete").search(f.val())})})()};return CRMDealEdit}(jQuery);var CRMDealChangeClient=function(c){CRMDealChangeClient=function(a){this.$wrapper=a.$wrapper;this.dialog=this.$wrapper.data("dialog");this.deal_id=a.deal_id;this.contact_id=a.contact_id;this.type=a.type;this.can_edit_contact=a.can_edit_contact||!1;this.initClass()};CRMDealChangeClient.prototype.initClass=function(){this.initViewToggle();this.can_edit_contact&&this.initContactChangeData();this.initSwitchContact()};CRMDealChangeClient.prototype.initViewToggle=function(){var a=this,b=a.$wrapper.find(".js-view-toggle"),
d=b.find(".is-active");b.on("click",".c-toggle",function(e){e.preventDefault();e=c(this);var f=e.data("id");if(e.hasClass("is-active"))return!1;d.length&&d.removeClass("is-active");e.addClass("is-active");d=e;a.$wrapper.find(".c-hidden.is-active").removeClass("is-active");a.$wrapper.find(".c-hidden-"+f).addClass("is-active");a.dialog.resize()})};CRMDealChangeClient.prototype.initContactChangeData=function(){function a(){var n=g.serializeArray(),m={data:[],errors:[]},p=["contact[firstname]","contact[middlename]",
"contact[lastname]","contact[name]"],q=!0;c.each(n,function(r,u){m.data.push({name:u.name,value:u.value});0<c.trim(u.value).length&&0<=p.indexOf(u.name)&&(q=!1)});q&&(m.errors.push({name:"contact[firstname]",value:"Name is empty"}),m.errors.push({name:"contact[name]",value:"Name is empty"}));k.find("li").each(function(r){var u=c(this),v=u.find(".js-value");u=u.find(".js-ext");var t=v.val(),w=u.val();if(t){var x="contact[phone]["+r+"][value]";v.attr("name",x);m.data.push({name:x,value:t});r="contact[phone]["+
r+"][ext]";u.attr("name",r);m.data.push({name:r,value:w})}});h.find("li").each(function(r){var u=c(this),v=u.find(".js-value");u=u.find(".js-ext");var t=v.val(),w=u.val();if(t){var x="contact[email]["+r+"][value]";v.attr("name",x);m.data.push({name:x,value:t});r="contact[email]["+r+"][ext]";u.attr("name",r);m.data.push({name:r,value:w})}});m.data.push({name:"deal_id",value:e.deal_id});return m}function b(n){c.post(e.contact_id?"?module=deal&action=contactUpdate":"?module=contact&action=save",n,function(m){"ok"==
m.status?(e.dialog.options.onChange(m.data.html),e.dialog.close()):m.errors&&d(m.errors)},"json").always(function(){l=!1})}function d(n){n=n?n:[];c.each(n,function(m,p){m=p.name;p=p.value;"contact[name]"===m&&(m="contact[firstname]");var q=g.find('[name="'+m+'"]'),r=c("<span />").addClass("errormsg").text(p);q.length?q.hasClass("error")||(q.parent().append(r),q.addClass("error").one("focus click",function(){q.removeClass("error");r.remove()})):(f.append(r),g.one("submit",function(){r.remove()}))})}
var e=this,f=e.$wrapper.find(".js-errors-place"),g=e.$wrapper.find("#c-contact-edit-form").closest("form"),l=!1,k=g.find(".js-phone-list"),h=g.find(".js-email-list");e.$wrapper.on("click",".js-save-changed-data",function(n){n.preventDefault();g.trigger("submit")});g.on("submit",function(n){n.preventDefault();l||(l=!0,n=a(),n.errors.length?(d(n.errors),l=!1):b(n.data))})};CRMDealChangeClient.prototype.initSwitchContact=function(){function a(l){l=l?l:[];c.each(l,function(k,h){k=h.name;h=h.value;"contact[name]"===
k&&(k="contact[firstname]");var n=f.find('[name="'+k+'"]'),m=c("<span />").addClass("errormsg").text(h);n.length?n.hasClass("error")||(n.parent().append(m),n.addClass("error").one("focus click",function(){n.removeClass("error");m.remove()})):(e.append(m),d.$wrapper.one("click",".js-switch-contact",function(){m.remove()}))})}function b(l){g||(g=!0,l.push({name:"deal_id",value:d.deal_id}),c.post("?module=deal&action=personUpdate",l,function(k){"ok"===k.status?(d.dialog.options.onChange(k.data),d.dialog.close()):
k.errors&&a(k.errors)}).always(function(){g=!1}))}var d=this,e=d.$wrapper.find(".js-errors-place"),f=d.$wrapper.find("#c-contact-add-form").closest("form"),g=!1;d.$wrapper.on("click",".js-switch-contact",function(l){l.preventDefault();l=f.serializeArray();var k=[];k.length?a(k):b(l)})};return CRMDealChangeClient}(jQuery);var CRMDealsFunnel=function(c){CRMDealsFunnel=function(a){this.$wrapper=a.$wrapper;this.$header=this.$wrapper.find("#js-funnel-header");this.$actionsHeader=this.$wrapper.find("#js-actions-header");this.$tableContent=this.$wrapper.find(".js-table-content");this.funnel_id=a.funnel_id;this.locales=a.locales;this.selected_deals=[];this.initClass()};CRMDealsFunnel.prototype.initClass=function(){this.initFixedHeader();this.initDealsMove();this.initMassiveActionsHeader();this.initMassActions()};CRMDealsFunnel.prototype.initFixedHeader=
function(){function a(){if(c.contains(document,e[0])){var n=d.scrollTop();l.top<n?g||(g=!0,f=c("<div />"),f.height(h).insertAfter(e),e.width(k).addClass("is-fixed-to-top")):b()}else d.off("scroll",a)}function b(){f&&f.length&&f.remove();f=!1;e.removeAttr("style").removeClass("is-fixed-to-top");k=e.width();h=e.height();g=!1}var d=c(window),e=this.$header,f=!1,g=!1,l=e.offset(),k=e.width(),h=e.height();d.on("scroll",a);d.on("resize",function(){b();d.trigger("scroll")})};CRMDealsFunnel.prototype.initDealsMove=
function(){function a(g,l,k,h){function n(){c.crm.content.reload()}if(!b){b=!0;var m=k.closest(".js-drop-area");e.draggable("disable");k.addClass("is-loading").removeAttr("style").prependTo(h);c.post("?module=deal&action=move",{deal_id:g,stage_id:l},function(p){"ok"===p.status&&(p.data.dialog_html&&p.data.dialog_html.html?new CRMDialog({html:p.data.dialog_html.html,options:{onShopSubmit:n},onCancel:function(){k.removeClass("is-loading").prependTo(m)},onConfirm:function(){c.post("?module=deal&action=move",
{deal_id:g,stage_id:l,force_execute:1},n)}}):n())},"json").always(function(){e.draggable("enable");b=!1})}}var b=!1,d=!1,e=this.$wrapper.find(".c-deal-wrapper"),f=this.$wrapper.find(".js-drop-area");e.draggable({handle:".js-drag-toggle",revert:!0,start:function(){var g=c(this),l=g.closest(".js-drop-area");g.data("stage-index",l.index()).data("stage-id",l.data("id")).draggable("option","revert",!0);d=l.addClass("is-wrapper")}});f.droppable({tolerance:"pointer",drop:function(g,l){g=c(this);l=c(l.draggable);
var k=g.data("id"),h=l.data("stage-id"),n=l.data("id");h!==k&&(l.draggable("option","revert",!1),a(n,k,l,g));d.length&&(d.removeClass("is-wrapper"),d=!1)}})};CRMDealsFunnel.prototype.initMassiveActionsHeader=function(){function a(){if(c.contains(document,f[0]))if(d.selected_deals.length){f.hasClass("is-hidden")&&f.removeClass("is-hidden");var m=e.scrollTop();k.top+n>m+e.height()?l||(l=!0,g=c("<div />"),g.height(n).insertAfter(f),f.width(h).addClass("is-fixed-to-bottom")):b()}else b(),f.hasClass("is-hidden")||
f.addClass("is-hidden");else e.off("scroll",a)}function b(){g&&g.length&&g.remove();g=!1;f.removeAttr("style").removeClass("is-fixed-to-bottom");h=f.width();n=f.height();l=!1}var d=this,e=c(window),f=d.$actionsHeader,g=!1,l=!1,k=f.offset(),h=f.width(),n=f.height();e.on("scroll",a);e.on("resize",function(){b();e.trigger("scroll")})};CRMDealsFunnel.prototype.initMassActions=function(){function a(k){k.find(".js-check-deal").is(":checked")?(k.addClass("is-active"),l.push(k[0])):(k.removeClass("is-active"),
k=l.indexOf(k[0]),l.splice(k,1));b();c(window).trigger("scroll")}function b(){function k(){var p=d("open"),q=f.find(".js-deals-close").closest(".c-action"),r=q.find(".js-open-count");p.length?(r.text(p.length),q.show()):q.hide()}function h(){var p=f.find(".js-deals-merge").closest(".c-action");1<l.length?p.show():p.hide()}function n(){var p=!1;c(l).each(function(){if(c(this).data("can-delete"))return p=!0,!1});var q=f.find(".js-deals-delete").closest(".c-action");p?q.show():q.hide()}var m=l.length;
0<l.length&&(f.find(".js-count").text(m),k(),h(),n())}function d(k){var h=[];c.each(l,function(n,m){n=c(m);m=n.data("id");(!k||n.data(k))&&m&&h.push(m)});return h}var e=this,f=e.$actionsHeader,g=f.find(".js-checkbox-all"),l=e.selected_deals;e.$wrapper.on("click",".js-deal-wrapper",function(k){k=c(k.target);var h=!(!k.is("a")&&!k.closest("a").length);k=k.is(":checkbox");if(!h){h=c(this);var n=h.find(".js-check-deal");k||n.attr("checked",!n.is(":checked"));a(h)}});e.$tableContent.find(".js-state-column").shiftSelectable({selector:".js-deal-wrapper",
onSelect:function(k,h){var n=c(h.target);n=!(!n.is("a")&&!n.closest("a").length);var m=h.extra.is_first;h=h.extra.is_last;n||m||h||(k.find(".js-check-deal").attr("checked",!0),a(k))}});g.on("change",function(){var k=c(this).is(":checked");e.$wrapper.find(".js-deal-wrapper").each(function(){var h=c(this),n=h.find(".js-check-deal");n.is(":checked")!==k&&(n.attr("checked",k),a(h))})});f.on("click",".js-deals-merge",function(k){k.preventDefault();k=d();k=c.crm.app_url+"deal/merge/?ids="+k.join(",");c.crm.content.load(k)});
(function(){var k=!1;f.on("click",".js-deals-delete",function(h){h.preventDefault();c.crm.confirm.show({title:e.locales.delete_confirm_title.replace("%s",l.length),text:e.locales.delete_confirm_text,button:e.locales.delete_confirm_button,onConfirm:function(n){function m(){var u=[],v=d();c.each(v,function(t,w){u.push({name:"id[]",value:w})});return u}function p(){var u=l.map(function(v){return v});c.each(u,function(v,t){v=c(t);v.find(".js-check-deal").attr("checked",!1).trigger("change");v.remove()})}
if(!k){k=!0;var q=c.crm.app_url+"?module=deal&action=delete",r=m();c.post(q,r,function(u){"ok"===u.status&&(p(),n.close(),c.crm.content.reload(),c.crm.sidebar.reload())}).always(function(){k=!1})}return!1}})})})();(function(){var k=!1;f.on("click",".js-deals-change-responsible",function(h){h.preventDefault();k||(k=!0,h={ids:d().join(",")},c.post("?module=deal&action=changeResponsible",h,function(n){new CRMDialog({html:n})}).always(function(){k=!1}))})})();(function(){var k=!1;f.on("click",".js-deals-close",
function(h){h.preventDefault();k||(k=!0,h={ids:d("open").join(",")},c.post("?module=deal&action=massClose",h,function(n){new CRMDialog({html:n})}).always(function(){k=!1}))})})();(function(){var k=!1;f.on("click",".js-deals-change-funnel",function(h){h.preventDefault();k||(k=!0,h={deal_ids:d().join(",")},c.post("?module=deal&action=changeFunnel",h,function(n){new CRMDialog({html:n})}).always(function(){k=!1}))})})();(function(){var k=!1;f.on("click",".js-deals-export",function(h){h.preventDefault();
k||(k=!0,h=d(),c.post(c.crm.app_url+"?module=deal&action=export",{ids:h},function(n){new CRMDialog({html:n})}).always(function(){k=!1}))})})();(function(){var k=!1;f.on("click",".js-deals-set-tags",function(h){h.preventDefault();if(!k){k=!0;h=d();var n=c.crm.app_url+"?module=dealOperation&action=assignTags",m={deal_ids:h};1===h.length&&(m.is_assign=1);c.post(n,m,function(p){new CRMDialog({html:p})}).always(function(){k=!1})}})})()};return CRMDealsFunnel}(jQuery),CRMDealsList=function(c){CRMDealsList=
function(a){this.$wrapper=a.$wrapper;this.$tableWrapper=this.$wrapper.find(".js-deals-table-wrapper");this.$tableHeaderW=this.$wrapper.find(".js-table-header-wrapper");this.$tableHeader=this.$wrapper.find(".js-table-header");this.$tableActions=this.$wrapper.find(".js-table-actions");this.$tableBody=this.$wrapper.find("#c-table-body");this.funnel_id=a.funnel_id;this.stage_id=a.stage_id;this.contact_id=a.contact_id;this.offset=a.offset;this.locales=a.locales;this.limit=a.limit;this.initClass()};CRMDealsList.prototype.initClass=
function(){this.initLazy();this.initElasticHeader();this.initMassActions()};CRMDealsList.prototype.initLazy=function(){function a(){if(c.contains(document,g[0])){var k=c(window).scrollTop(),h=e.height(),n=g.offset().top;k+h>=n&&(l||b())}else e.off("scroll",a)}function b(){var k={offset:g.data("offset")};d.stage_id&&(k.stage=d.stage_id);d.contact_id&&(k.user=d.contact_id);l=!0;c.post("?module=deal&action=list",k,function(h){var n=c(h).find(".js-lazyload");n.length?(d.limit+=k.offset,n.insertAfter(g),
g.remove(),g=n):g.remove();c(h).find(".c-deal-wrapper").insertAfter(f.find("tr:last"))}).always(function(){l=!1})}var d=this,e=c(window),f=d.$tableBody,g=d.$wrapper.find(".js-lazyload"),l=!1;g.length&&(e.on("scroll",a),g.offset().top<e.height()&&e.trigger("scroll"))};CRMDealsList.prototype.initElasticHeader=function(){function a(){c.contains(document,e[0])?b.scrollTop()>f.top?e.css({left:f.left}).width(d.outerWidth()).addClass("is-fixed"):e.removeAttr("style").removeClass("is-fixed"):b.off("scroll",
a)}var b=c(window),d=this.$tableWrapper,e=this.$tableHeaderW,f=d.offset();b.on("scroll",a)};CRMDealsList.prototype.initMassActions=function(){function a(m){m.find(".js-check-deal").prop("checked",!0).trigger("change",[!0])}function b(m){m.find(".js-check-deal").prop("checked",!1).trigger("change",[!1])}function d(m){m.find(".js-check-deal").is(":checked")?(m.addClass("is-active"),l.push(m[0])):(m.removeClass("is-active"),m=l.indexOf(m[0]),l.splice(m,1));e()}function e(){function m(){var u=f("open"),
v=h.find(".js-deals-close").closest(".c-operation-li"),t=v.find(".js-open-count");u.length?(t.text(u.length),v.show()):v.hide()}function p(){var u=h.find(".js-deals-merge").closest(".c-operation-li");1<l.length?u.show():u.hide()}function q(){var u=!1;c(l).each(function(){if(c(this).data("can-delete"))return u=!0,!1});var v=h.find(".js-deals-delete").closest(".c-operation-li");u?v.show():v.hide()}var r=l.length;0<r?(k.hide(),h.show().find(".js-count").text(r),m(),p(),q(),r<g.limit?n.prop("indeterminate",
!0):n.prop("indeterminate",!1).prop("checked",!0)):(k.show(),h.hide(),n.prop("indeterminate",!1).prop("checked",!1))}function f(m){var p=[];c.each(l,function(q,r){q=c(r);r=q.data("id");(!m||q.data(m))&&r&&p.push(r)});return p}var g=this,l=[],k=g.$tableHeader,h=g.$tableActions,n=g.$tableHeaderW.find(".js-checkbox-all");g.$tableBody.on("click",".js-deal-wrapper",function(m){m=c(m.target);var p=c(this),q=p.find(".js-check-deal");q.closest("td");var r=!(!m.is("a")&&!m.closest("a").length),u=!(!m.is(".c-column-checkbox")&&
!m.closest(".c-column-checkbox").length);if(m.is(":checkbox"))return d(p),!0;if(r)return!0;u&&(q.attr("checked",!q.is(":checked")),d(p))});g.$tableBody.shiftSelectable({selector:".js-deal-wrapper",onSelect:function(m,p){var q=c(p.target);q=!(!q.is("a")&&!q.closest("a").length);var r=p.extra.is_first;p=p.extra.is_last;q||r||p||(m.find(".js-check-deal").attr("checked",!0),d(m))}});n.on("change",function(){var m=c(this).is(":checked"),p=g.$wrapper.find(".js-deal-wrapper"),q=p.find(".js-check-deal").filter(":checked").length;
0<q?q<g.limit||q===g.limit?b(p):a(p):m?a(p):b(p);p.each(function(){d(c(this))})});h.on("click",".js-deals-merge",function(m){m.preventDefault();m=f();m=c.crm.app_url+"deal/merge/?ids="+m.join(",");c.crm.content.load(m)});(function(){var m=!1;h.on("click",".js-deals-delete",function(p){p.preventDefault();c.crm.confirm.show({title:g.locales.delete_confirm_title.replace("%s",l.length),text:g.locales.delete_confirm_text,button:g.locales.delete_confirm_button,onConfirm:function(q){function r(){var w=[],
x=f();c.each(x,function(y,z){w.push({name:"id[]",value:z})});return w}function u(){var w=l.map(function(x){return x});c.each(w,function(x,y){x=c(y);x.find(".js-check-deal").attr("checked",!1).trigger("change");x.remove()})}if(!m){m=!0;var v=c.crm.app_url+"?module=deal&action=delete",t=r();c.post(v,t,function(w){"ok"===w.status&&(u(),q.close(),k.show(),h.hide(),n.prop("indeterminate",!1).prop("checked",!1),c.crm.content.reload(),c.crm.sidebar.reload())}).always(function(){m=!1})}return!1}})})})();
(function(){var m=!1;h.on("click",".js-deals-change-responsible",function(p){p.preventDefault();m||(m=!0,p={ids:f().join(",")},c.post("?module=deal&action=changeResponsible",p,function(q){new CRMDialog({html:q})}).always(function(){m=!1}))})})();(function(){var m=!1;h.on("click",".js-deals-close",function(p){p.preventDefault();m||(m=!0,p={ids:f("open").join(",")},c.post("?module=deal&action=massClose",p,function(q){new CRMDialog({html:q})}).always(function(){m=!1}))})})();(function(){var m=!1;h.on("click",
".js-deals-change-funnel",function(p){p.preventDefault();m||(m=!0,p={deal_ids:f().join(",")},c.post("?module=deal&action=changeFunnel",p,function(q){new CRMDialog({html:q})}).always(function(){m=!1}))})})();(function(){var m=!1;h.on("click",".js-deals-export",function(p){p.preventDefault();m||(m=!0,p=f(),c.post(c.crm.app_url+"?module=deal&action=export",{ids:p},function(q){new CRMDialog({html:q})}).always(function(){m=!1}))})})();(function(){var m=!1;h.on("click",".js-deals-set-tags",function(p){p.preventDefault();
if(!m){m=!0;p=f();var q=c.crm.app_url+"?module=dealOperation&action=assignTags",r={deal_ids:p};1===p.length&&(r.is_assign=1);c.post(q,r,function(u){new CRMDialog({html:u})}).always(function(){m=!1})}})})()};return CRMDealsList}(jQuery),CRMDealsMergePage=function(c){CRMDealsMergePage=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$submitButton=this.$wrapper.find(".js-submit-button");this.$activeDeal=this.is_deal_set=!1;this.initClass()};CRMDealsMergePage.prototype.initClass=
function(){this.initSubmit();this.initSelectDeal()};CRMDealsMergePage.prototype.initSubmit=function(){function a(){function e(g){var l="";c.each(g,function(k,h){if("master_id"===h.name)return l=h.value,!1});return l}if(!d){d=!0;var f=b.serializeArray();c.post("?module=deal&action=mergeRun",f,function(g){g=c.crm.app_url+"deal/"+e(f)+"/";var l=(new URLSearchParams(document.location.search)).get("iframe");window.parent&&l?window.parent.location=g:c.crm.content.load(g)},"json").always(function(){d=!1})}}
var b=this.$form,d=!1;b.on("submit",function(e){e.preventDefault();a()})};CRMDealsMergePage.prototype.initSelectDeal=function(){var a=this;a.$wrapper.on("change",".js-field",function(){var b=c(this);"checked"===b.attr("checked")&&(b=b.closest(".js-deal"),a.$activeDeal&&a.$activeDeal.removeClass("is-active"),a.$activeDeal=b.addClass("is-active"),a.is_deal_set||(a.$submitButton.attr("disabled",!1),a.is_deal_set=!0))});a.$wrapper.on("click",".js-deal",function(b){var d=c(this).find(".js-field"),e=d[0]==
b.target;b=!!c(b.target).attr("href");e||b||d.trigger("click")})};return CRMDealsMergePage}(jQuery),CRMDealsChangeResponsibleDialog=function(c){CRMDealsChangeResponsibleDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$submitButton=this.$wrapper.find(".js-submit-button");this.dialog=this.$wrapper.data("dialog");this.is_responsive_set=!1;this.initClass()};CRMDealsChangeResponsibleDialog.prototype.initClass=function(){this.initSubmit();this.initChangeResponsible()};
CRMDealsChangeResponsibleDialog.prototype.initChangeResponsible=function(){var a=this,b=a.$wrapper.find(".js-users-list"),d=b.find(".js-visible-link"),e=a.$wrapper.find(".js-user-field"),f=b.find(".menu-v");f.on("click","a",function(){var g=c(this),l=g.closest(".js-user");d.find(".js-text").html(g.html());f.find(".selected").removeClass("selected");l.addClass("selected");f.hide();setTimeout(function(){f.removeAttr("style")},200);g=l.data("id");e.val(g).trigger("change");a.is_responsive_set||(a.$submitButton.attr("disabled",
!1),a.is_responsive_set=!0)})};CRMDealsChangeResponsibleDialog.prototype.initSubmit=function(){function a(){if(!e){e=!0;var f=d.serializeArray();c.post("?module=deal&action=changeResponsibleRun",f,function(g){"ok"===g.status?(b.dialog.close(),c.crm.content.reload()):alert("errors")},"json").always(function(){e=!1})}}var b=this,d=b.$form,e=!1;d.on("submit",function(f){f.preventDefault();a()})};return CRMDealsChangeResponsibleDialog}(jQuery),CRMDealsCloseDialog=function(c){CRMDealsCloseDialog=function(a){this.$wrapper=
a.$wrapper;this.$form=this.$wrapper.find("form");this.$reasonSelect=this.$wrapper.find(".js-reason-select");this.$reasonFieldW=this.$wrapper.find(".js-reason-text");this.dialog=this.$wrapper.data("dialog");this.deal_ids=a.deal_ids;this.reason_require=a.reason_require;this.is_locked=!1;this.initClass()};CRMDealsCloseDialog.prototype.initClass=function(){var a=this;a.$wrapper.on("click",".js-set-won",function(b){b.preventDefault();a.setWon()});a.$wrapper.on("click",".js-show-form",function(b){b.preventDefault();
a.showLostForm()});a.$wrapper.on("click",".js-set-lost",function(b){b.preventDefault();a.$form.trigger("submit")});a.$form.on("submit",function(b){b.preventDefault();a.setLost()});a.$reasonSelect.on("change",function(){c(this).val()?a.$reasonFieldW.hide():a.$reasonFieldW.show()})};CRMDealsCloseDialog.prototype.showLostForm=function(a){var b=this.$wrapper.find(".c-visible"),d=this.$wrapper.find(".c-hidden");a?(b.show(),d.hide()):(b.hide(),d.show());this.dialog.resize()};CRMDealsCloseDialog.prototype.setWon=
function(){var a=this;if(!a.is_locked){a.is_locked=!0;var b={deal_ids:a.deal_ids.join(","),action:"WON"};c.post("?module=deal&action=massCloseRun",b,function(d){"ok"==d.status&&(a.dialog.close(),c.crm.content.reload())}).always(function(){a.is_locked=!1})}};CRMDealsCloseDialog.prototype.setLost=function(){function a(){var e=b.$form.serializeArray();e.push({name:"deal_ids",value:b.deal_ids.join(",")});e.push({name:"action",value:"LOST"});if(b.reason_require&&!b.$reasonSelect.val())if(b.$reasonFieldW.is(":visible")){var f=
b.$reasonFieldW.find("input");f.val()||(f.addClass("error").one("focus",function(){c(this).removeClass("error")}),e=!1)}else b.$reasonSelect.addClass("error").one("change",function(){c(this).removeClass("error")}),e=!1;return e}var b=this;if(!b.is_locked){b.is_locked=!0;var d=a();d?c.post("?module=deal&action=massCloseRun",d,function(e){"ok"==e.status&&(b.dialog.close(),c.crm.content.reload())}).always(function(){b.is_locked=!1}):b.is_locked=!1}};return CRMDealsCloseDialog}(jQuery),CRMDealsChangeFunnelDialog=
function(c){CRMDealsChangeFunnelDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.dialog=this.$wrapper.data("dialog");this.funnels=a.funnels;this.stage_template_html=a.stage_template_html;this.initClass()};CRMDealsChangeFunnelDialog.prototype.initClass=function(){this.initChangeFunnel();this.initChangeStage();this.initSubmit();c.crm.renderSVG(this.$wrapper)};CRMDealsChangeFunnelDialog.prototype.initChangeFunnel=function(){function a(l){(l=b.funnels[l]||!1)&&d.trigger("changeFunnel",
l)}var b=this,d=b.$wrapper.find(".js-funnels-list"),e=d.find(".js-visible-link"),f=d.find(".js-field"),g=d.find(".menu-v");g.on("click","a",function(){var l=c(this);e.find(".js-text").html(l.html());g.find(".selected").removeClass("selected");l.closest("li").addClass("selected");g.hide();setTimeout(function(){g.removeAttr("style")},200);l=l.data("id");f.val(l).trigger("change");a(l)})};CRMDealsChangeFunnelDialog.prototype.initChangeStage=function(){function a(k){l.html("");c.each(k,function(h,n){h=
b.stage_template_html;var m=c("<div />").text(n.name).html();h=h.replace("%id%",n.id).replace("%color%",n.color).replace("%name%",m);n=c(h);l.append(n)});c.crm.renderSVG(e);l.find("li:first-child a").trigger("click")}var b=this,d=b.$wrapper.find(".js-funnels-list"),e=b.$wrapper.find(".js-funnel-stages-list"),f=e.find(".js-visible-link"),g=e.find(".js-field"),l=e.find(".menu-v");l.on("click","a",function(){var k=c(this);f.find(".js-text").html(k.html());l.find(".selected").removeClass("selected");
k.closest("li").addClass("selected");l.hide();setTimeout(function(){l.removeAttr("style")},200);k=k.data("id");g.val(k)});d.on("changeFunnel",function(k,h){a(h.stages)})};CRMDealsChangeFunnelDialog.prototype.initSubmit=function(){var a=this,b=a.$form,d=!1;b.on("submit",function(e){e.preventDefault();d||(d=!0,e=b.serializeArray(),c.post("?module=deal&action=changeFunnelRun",e,function(f){"ok"===f.status&&(a.dialog.close(),c.crm.content.reload())},"json").always(function(){d=!1}))})};return CRMDealsChangeFunnelDialog}(jQuery),
CRMDealRemindersFilter=function(c){CRMDealRemindersFilter=function(a){this.$wrapper=a.$wrapper;this.$menu=this.$wrapper.find(".js-hidden-list");this.$buttons=this.$menu.find(".js-buttons");this.apply_url_pattern=a.redirect_uri;this.filters=a.filters;this.selected_filters=a.selected_filters;this.redirect_uri=this.apply_url_pattern;this.selected_ids_before=Object.keys(this.selected_filters);this.initClass()};CRMDealRemindersFilter.prototype.initClass=function(){var a=this;a.$menu.on("change",".js-checkbox",
function(){a.setItem(c(this))});a.$menu.on("click",".js-show-all",function(b){b.preventDefault();a.$menu.find(".js-checkbox").attr("checked",!1).trigger("change");a.update()});a.$menu.on("click",".js-revert",function(b){b.preventDefault();a.$menu.find(".js-checkbox").each(function(){var d=c(this),e=d.closest(".c-item").data("id");console.log(e,0<=a.selected_ids_before.indexOf(e));d.attr("checked",0<=a.selected_ids_before.indexOf(e)).trigger("change")})});a.$menu.on("click",".js-submit",function(b){b.preventDefault();
a.update()})};CRMDealRemindersFilter.prototype.setItem=function(a){var b=a.closest(".c-item"),d=b.data("id"),e=!!this.selected_filters[d];(a=a.is(":checked"))?b.addClass("selected"):b.removeClass("selected");a?e||(this.selected_filters[d]=this.filters[d]):e&&delete this.selected_filters[d];this.setApplyUrl();this.watcher()};CRMDealRemindersFilter.prototype.watcher=function(){(function(a,b){var d=!0;a.length===b.length&&(d=!1,c.each(b,function(e,f){if(0<=a.indexOf(f))d=!1;else return d=!0,!1}));return d})(Object.keys(this.selected_filters),
this.selected_ids_before)?this.$buttons.show():this.$buttons.hide()};CRMDealRemindersFilter.prototype.setApplyUrl=function(){var a=Object.keys(this.selected_filters);this.redirect_uri=this.apply_url_pattern.replace("reminder=none",a.length?"reminder="+a.join("-"):"reminder=none")};CRMDealRemindersFilter.prototype.update=function(){c.crm.content.load(this.redirect_uri)};return CRMDealRemindersFilter}(jQuery);var CRMDealsExport=function(c){CRMDealsExport=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".js-save");this.$cancel=this.$wrapper.find(".crm-js-cancel");this.$download_file_form=this.$wrapper.find(".crm-download-file-form");this.ids=a.ids||[];this.url=c.crm.app_url+"?module=dealExport&action=process";this.$dialog_parent=window.parent.$(".dialog");this.$dialog_parent_close=this.$dialog_parent.find(".dialog-close");this.initClass()};CRMDealsExport.prototype.initClass=function(){this.initStartExport()};
CRMDealsExport.prototype.initStartExport=function(){var a=this,b=a.$button,d=a.$cancel,e=null;b.click(function(f){f.preventDefault();b.attr("disabled",!0);e=a.process()});d.click(function(f){f.preventDefault();e&&e.cancel();a.$dialog_parent_close[0].click()})};CRMDealsExport.prototype.process=function(){var a=this,b=a.url,d=a.$wrapper,e=null,f=null,g=0,l={},k=a.$wrapper.find(".progressbar-inner");l.separator=d.find("[name=separator]").val();l.encoding=d.find("[name=encoding]").val();l.export_fields_name=
d.find("[name=export_fields_name]").is(":checked")?1:0;l.not_export_empty_columns=d.find("[name=not_export_empty_columns]").is(":checked")?1:0;l.ids=[].concat(a.ids);var h=function(){a.$wrapper.find(".dialog-footer--visible").addClass("hidden");f&&clearTimeout(f);f=setTimeout(h,3200);!e||2<=g||(l.processId=e,c.post(b,l,function(n){var m=n.progress||0;k.width(m+"%")&&k.find(".progressbar-text").text(m+"%");g--;if(e&&n.ready&&(n=e)){f&&clearTimeout(f);e=f=null;m=a.$download_file_form.find('input[name="_csrf"]').val();
var p=a.$download_file_form.find('input[name="file"]').val();c.post(a.url+"&processId="+n,{processId:a.pid,_csrf:m,file:p},function(q){q=JSON.parse(q);q=a.url+"?module=dealExport&action=download&file="+q.file;a.$wrapper.find(".js-download").attr("href",q)});a.$wrapper.find(".dialog-footer--hidden").removeClass("hidden")}},"json"),g++)};a.$wrapper.find(".crm-start-block").hide();a.$wrapper.find(".crm-process-block").show();c.post(b,l,function(n){n.processId||alert("Error processing request.");var m=
n.progress||0;k.width(m+"%")&&k.find(".progressbar-text").text(m+"%");e=n.processId;h()},"json");return{cancel:function(){f&&clearTimeout(f);c.post(b,{processId:e,ready:1})}}};return CRMDealsExport}(jQuery);var CRMDealOperationAssignTags=function(c){CRMDealOperationAssignTags=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".js-save");this.$input=this.$wrapper.find(".crm-tags-input");this.context=a.context||{};this.dialog=this.$wrapper.data("dialog");this.default_text=this.$input.attr("placeholder");this.is_assign=a.is_assign||!1;this.initClass()};CRMDealOperationAssignTags.prototype.initClass=function(){this.initTagsInput();this.initPopularTags();this.initSave()};CRMDealOperationAssignTags.prototype.initTagsInput=
function(){var a=c.crm.app_url+"?module=contact&action=tags";this.$input.tagsInput({defaultText:this.default_text,width:this.$wrapper.find(".crm-dialog-content").width()-16,autocomplete_url:"",autocomplete:{html:!0,source:function(b,d){c.getJSON(a,{term:b.term},function(e){"ok"===e.status?d(e.data.tags||[]):d([])})}}})};CRMDealOperationAssignTags.prototype.initPopularTags=function(){var a=this.$input;this.$wrapper.find(".crm-popular-tags").find(".crm-popular-tag-item-link").click(function(){var b=
c(this);b=c.trim(b.text());a.removeTag(b);a.addTag(b)})};CRMDealOperationAssignTags.prototype.initSave=function(){var a=this,b=a.$button,d=a.$input,e=c.crm.app_url+"?module=dealOperation&action=assignTagsProcess",f=c.extend({},a.context,!0),g=a.$wrapper.find(".crm-loading");b.click(function(l){l.preventDefault();g.show();b.attr("disabled",!0);l=c("#"+d.attr("id")+"_tag");(l=c.trim(l.val()))&&l!==a.default_text&&d.addTag(l);f.tags=c.trim(d.val());f.is_assign=a.is_assign?1:0;var k=function(h){h=c.extend({offset:h||
0},f);c.post(e,h).done(function(n){"ok"==n.status&&(n.data.done?(g.hide(),b.attr("disabled",!1),c.crm.content.reload()):k(n.data.offset||0))})};k()})};return CRMDealOperationAssignTags}(jQuery);var CRMInvoiceEdit=function(c){function a(d,e){d=d.toFixed(2);"ru"===e&&(d=d.replace(".",","));return d}function b(d){var e=0;d&&d.length&&(d=d.replace(/,/g,".").replace(/\s/g,""),e=parseFloat(d)!=d?!1:parseFloat(d));return e}CRMInvoiceEdit=function(d){this.$wrapper=d.$wrapper;this.$form=this.$wrapper.find("form");this.$table=this.$wrapper.find(".c-product-table");this.$tableBody=this.$table.find("tbody");this.$emptyTax=this.$table.find(".js-empty-tax");this.$emptyTaxLink=this.$table.find(".js-empty-tax-link");
this.$tax=this.$table.find(".js-tax-toggle");this.$taxPercent=this.$table.find(".js-tax-percent");this.$taxType=this.$table.find(".js-tax-type");this.$taxName=this.$table.find(".js-tax-name");this.$taxHeader=this.$table.find(".js-tax-header");this.$currencyField=this.$wrapper.find(".js-currency-field");this.$companyField=this.$wrapper.find(".js-company-select");this.locale=d.locale;this.locales=d.locales;this.companies=d.companies||{};this.invoice_id=d.invoice_id;this.row_template_html=d.row_template_html;
this.confirm_dialog_template=d.confirm_dialog_template;this.shop_supported=d.shop_supported;this.tax_set_class="is-changed";this.currencies=d.currencies;this.supported_currencies=d.supported_currencies;this.company_id=d.company_id;this.tax=d.tax&&d.tax.name?d.tax:!1;this.active_tax_array=[];this.tax_percent=c(this.$tax.find("option")[this.$tax[0].selectedIndex]).data("percent")||"0";this.tax_type=c(this.$tax.find("option")[this.$tax[0].selectedIndex]).data("type");this.initClass()};CRMInvoiceEdit.prototype.initClass=
function(){0==this.$wrapper.find('input[name="invoice[deal_id]"]').val()&&this.initSelectDeal();this.initDatePickers();this.initTableEvents();this.initWYSIWYG();this.initSubmit();this.initChangeContact();this.initDealActions();this.initChangeCurrency();this.shop_supported&&this.initProductName();this.initChangeTax();this.initChangeCompany();this.initToggleButton()};CRMInvoiceEdit.prototype.initTableEvents=function(){function d(f){if(c.contains(document,e.$table[0])){var g=!0,l=e.$table.find(".js-tax-dropdown.is-active");
f=c(f.target).closest(".js-tax-dropdown");f.length&&(g=f.hasClass("is-active"));l.removeClass("is-active");g||"NONE"===e.tax_type||f.addClass("is-active")}else c(document).off("click",d)}var e=this;e.$table.on("focus",".js-name-field",function(){var f=c(this).closest("tr"),g=e.$tableBody.find("tr").length;f.index()+1>=g&&e.addTableRow(g+1)});e.$table.on("keypress",".js-name-field",function(f){13===f.keyCode&&f.preventDefault()});e.$table.on("click",".js-remove-row",function(f){f.preventDefault();
1<e.$tableBody.find("tr").length&&e.removeTableRow(c(this).closest("tr"))});e.$table.on("change",".js-amount-field",function(){e.changeTableRow(c(this))});e.$table.on("change",".js-price-field",function(){var f=c(this).closest("tr").find(".js-amount-field");f.val()||f.val("1");e.changeTableRow(c(this))});e.$table.on("click",".js-set-product-tax",function(){var f=c(this),g=f.closest(".js-tax-dropdown"),l=g.find(".js-product-tax-percent"),k=g.find(".js-product-tax-type");f=parseInt(f.data("tax-index"));
if(f=e.active_tax_array[f])parseInt(e.tax_percent)===parseInt(f.tax_percent)&&e.tax_type===f.tax_type?g.removeClass(e.tax_set_class):g.addClass(e.tax_set_class),g=e.tax_type,"NONE"===f.tax_type&&(g="NONE"),k.val(g).trigger("change"),k=f.tax_percent+"%","NONE"===f.tax_type&&(k=e.companies[e.$companyField.val()],k=e.locales.no_tax.replace("%name",k.tax_name)),l.val(k).trigger("change"),e.refreshTable()});c(document).on("click",d)};CRMInvoiceEdit.prototype.addTableRow=function(d){var e=c(this.row_template_html);
e.find(".js-product-number").text(d);this.renderProductTaxOptions(e);this.$tableBody.append(e);this.renderProductTaxFields();this.shop_supported&&this.$wrapper.trigger("addProduct",e)};CRMInvoiceEdit.prototype.removeTableRow=function(d){d.remove();this.$tableBody.find("tr").each(function(e){c(this).find(".js-product-number").text(e+1)});this.refreshTable()};CRMInvoiceEdit.prototype.changeTableRow=function(d){var e=this.locale,f="price"===d.data("type"),g=d.val(),l=0;g&&g.length&&(g=g.replace(/,/g,
".").replace(/\s/g,""),0<parseFloat(g)&&(l=parseFloat(g)));d.val(f?a(l,e):l);this.refreshTable()};CRMInvoiceEdit.prototype.refreshTable=function(){var d=this,e=function(){var k=[];d.$tableBody.find("tr").each(function(){var h=c(this),n=h.find(".js-amount-field"),m=h.find(".js-price-field"),p=h.find(".js-product-total"),q=h.find(".js-product-tax-percent");n=b(n.val());m=b(m.val());var r=0;0<n&&0<m&&(r=m*n);p.text(a(r,d.locale));(p=parseInt(q.val()))&&(0<p||0===p)||(p=0);k.push({$tr:h,percent:p,amount:n,
price:m,total:r})});return k}(),f=d.tax_type&&"INCLUDE"===d.tax_type,g=0,l=0;c.each(e,function(k,h){g+=h.total;k=h.percent/100;l+=f?k/(1+k)*h.total:h.total*k});d.$table.find(".js-subtotal").text(a(g,d.locale));d.$table.find(".js-tax").text(a(l,d.locale));d.$table.find(".js-total").text(a(g+(f?0:l),d.locale))};CRMInvoiceEdit.prototype.renderProductTaxOptions=function(d){var e=this,f=!1,g;f=d&&d.length?d.find(".js-tax-dropdown"):e.$tableBody.find(".js-tax-dropdown");var l=f.find(".js-hidden-list").html(""),
k=e.companies[e.$companyField.val()],h=[];c.each(e.active_tax_array,function(n,m){g="NONE"===m.tax_type?e.locales.no_tax.replace("%name",k.tax_name):m.tax_percent+"%";0>h.indexOf(g)&&(h.push(g),l.append('<li class="ui-menu-item-html ui-menu-item"><div class="ui-menu-item-wrapper"><div class="js-set-product-tax" data-tax-index="'+n+'">'+g+"</div></div></li>"))})};CRMInvoiceEdit.prototype.renderProductTaxFields=function(d){var e=this,f=e.$tableBody.find(".js-tax-dropdown");d&&f.removeClass(e.tax_set_class);
f.each(function(){var g=c(this),l=g.find(".js-product-tax-percent"),k=g.find(".js-product-tax-type");g.hasClass(e.tax_set_class)&&"NONE"!==e.tax_type||(k.val(e.tax_type).trigger("change"),k=e.tax_percent+"%","NONE"===e.tax_type&&(k="\u2014",g.removeClass(e.tax_set_class)),l.val(k).trigger("change"))})};CRMInvoiceEdit.prototype.initSubmit=function(){function d(){var h={data:[],errors:[]},n=l.serializeArray();c.each(n,function(m,p){"invoice[contact]"!==p.name&&h.data.push(p);"invoice[contact_id]"===
p.name&&(0<p.value||h.errors.push({name:"invoice[contact_id]",value:g.locales.empty_contact}))});(function(m){g.$tableBody.find("tr").each(function(p){var q=c(this),r=q.find(".js-product-field"),u=q.find(".js-amount-field"),v=q.find(".js-price-field"),t=q.find(".js-product-tax-percent"),w=q.find(".js-product-tax-type");q=q.find(".js-name-field");u=b(u.val());v=b(v.val());t=parseInt(t.val());w=w.val();r=r.val();q=q.val();if(u||v||q)m.push({name:"items["+p+"][name]",value:q}),m.push({name:"items["+
p+"][price]",value:v}),m.push({name:"items["+p+"][quantity]",value:u}),m.push({name:"items["+p+"][tax_percent]",value:0<t||0===t?t:""}),m.push({name:"items["+p+"][tax_type]",value:w});r&&m.push({name:"items["+p+"][product_id]",value:r})})})(h.data);return h}function e(h,n){n=n?n:[];if(h){var m=Object.keys(h);c.each(m,function(p,q){n.push({name:q,value:h[q]})})}c.each(n,function(p,q){p=q.value;var r=g.$form.find('[name="'+q.name+'"]');if(r.length&&!r.hasClass("state-error")){var u=c("<span />").addClass("state-error-hint").text(p);
u.insertAfter(r);r.addClass("state-error").one("focus click change",function(){r.removeClass("state-error");u.remove()})}})}function f(h,n){if(!k){k=!0;var m=c.crm.app_url+"?module=invoice&action=save",p=spinnerView(n);p.show();c.post(m,h,function(q){if("ok"===q.status){if(q.data.id){c(document).trigger("unsavedChanges",!1);var r=c.crm.app_url+"invoice/"+q.data.id+"/",u=getIframeIfExists();u?(window.parent.iframe_invoice_is_saved=!0,u.dispatchEvent(new CustomEvent("close",{detail:{id:q.data.id}}))):
c.crm.content.load(r)}}else p.hide(),e(q.errors)},"json").always(function(){k=!1})}}var g=this,l=g.$form,k=!1;l.on("submit",function(h){h.preventDefault();h=d();h.errors.length?e(!1,h.errors):f(h.data,l.find(".js-submit-button"))})};CRMInvoiceEdit.prototype.initDatePickers=function(){var d=this,e=d.$wrapper.find(".js-invoice-datepicker"),f=d.$wrapper.find(".js-invoice-due-datepicker"),g=d.$wrapper.find(".js-due-days-field"),l=d.$wrapper.find(".js-clear-due-date");(function(){var k=e.parent().find("input[type='hidden']");
e.datepicker({altField:k,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0});d.invoice_id||e.datepicker("setDate","+0d")})();(function(){var k=f.parent().find("input[type='hidden']");f.datepicker({altField:k,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0});f.on("change",function(){var h=c(this).val();c.trim(h).length?l.show():(k.val(""),l.hide())})})();d.$wrapper.on("click",".js-focus-on-field",function(){c(this).parent().find(".js-invoice-due-datepicker").trigger("focus")});g.on("change",function(){var k=
g.val(),h=0;k&&k.length&&0<parseInt(k)&&(h=parseInt(k),g.val(h));0<h?l.show():l.hide();g.val(h);k=h;h=e.datepicker("getDate");k=new Date(h.getTime()+864E5*k);f.datepicker("setDate",k)});e.on("change",function(){var k=g.val();k&&k.length&&0<parseInt(k)&&g.trigger("change")});f.on("change",function(){g.val("")});l.on("click",function(){f.val("").trigger("change")})};CRMInvoiceEdit.prototype.initChangeContact=function(){var d=this.$wrapper.find(".js-contact-toggle"),e=d.find(".js-name"),f=d.find(".js-contact-id"),
g=!1;d.on("click",".js-change-contact",function(l){l.preventDefault();var k=c(this);c.get(c.crm.app_url+"?module=invoice&action=contactAdd",function(h){c.waDialog({html:h,options:{onAdd:function(n,m){f.val(n).trigger("change");e.text(m);g||(n=k.find(".js-label"),m=n.data("change-text"),n.html('<span class="c-dotted">'+m+"</span>"),g=!0)}}})})})};CRMInvoiceEdit.prototype.initDealActions=function(){function d(l,k){var h=null;l.on("click",".js-detach-deal",function(n){n.preventDefault();c.crm.confirm.show({title:e.locales.deal_detach_title,
text:e.locales.deal_detach_text.replace(/%s/,k),button:e.locales.deal_detach_confirm_button,onConfirm:function(){h&&h.abort();e.loadDealListByContact(function(m){h=c.post(c.crm.app_url+"?module=invoiceDeal&action=detach",{invoice_id:e.invoice_id}).done(function(p){p&&"ok"===p.status&&(c.crm.content.reload(),l.data("dialog").close())}).always(function(){h=null})})}})})}var e=this,f=e.$wrapper.find(".js-deal-toggle"),g=e.$wrapper.find(".js-deal-toggle [name='invoice[deal_id]']").val();f.on("click",
".js-attach-other-deal, .js-associate-deal",function(l){l.preventDefault();var k=f.find(".js-deal-name").text();e.loadDealListByContact(function(h){c.get(c.crm.app_url+"?module=invoiceDeal&action=attachDialog",{invoice_id:e.invoice_id,deal_id:g},function(n){var m=c(n);c.waDialog({html:m,onOpen:function(){var p=m.find(".js-invoice-deal"),q=e.initSelectDeal({$wrapper:p,data:h});m.find(".js-save-button").on("click",function(){q.submit()});d(m,k)}})})})});f.on("click",".js-detach-deal",function(l){l.preventDefault();
var k=null;l=f.find(".js-deal-name").text();c.crm.confirm.show({title:e.locales.deal_detach_title,text:e.locales.deal_detach_text.replace(/%s/,l),button:e.locales.deal_detach_confirm_button,onConfirm:function(){k&&k.abort();e.loadDealListByContact(function(h){k=c.post(c.crm.app_url+"?module=invoiceDeal&action=detach",{invoice_id:e.invoice_id}).done(function(n){n&&"ok"===n.status&&c.crm.content.reload()}).always(function(){k=null})})}})})};CRMInvoiceEdit.prototype.initSelectDeal=function(d){function e(){t.html(g.locales.deal_empty);
z.val("none");n.val("");h.addClass("c-deal-name-hidden");p.addClass("hidden").removeAttr("title");v.addClass("c-empty-deal-hidden");w.addClass("hidden");y.find("li").removeClass("selected");0<q.data("deals_count")?(q.removeClass("hidden"),r.addClass("hidden")):(q.addClass("hidden"),r.removeClass("hidden"))}function f(){var C=l.find(".js-created-deal"),A=x.find(".js-visible-link .js-text .funnel-state").clone(),D=c.trim(n.val()),E=k.serializeObject();E.invoice_id=g.invoice_id;E["deal[id]"]=z.val();
E["deal[name]"]=n.val();E["deal[funnel_id]"]=k.find(".js-select-deal-funnel").val();E["deal[stage_id]"]=k.find(".js-select-deal-stage").val();if("none"===z.val())return k.addClass("shake animated"),setTimeout(function(){k.removeClass("shake animated")},500),!1;if(0>=z.val()&&!D)return h.addClass("shake animated"),setTimeout(function(){h.removeClass("shake animated");n.focus()},500),!1;k.addClass("deal-form-hidden");C.removeClass("hidden");0>=z.val()?(C.html(A),C.append(c.crm.escape(D))):(D=q.find(".js-visible-link .js-text"),
A=D.find(".funnel-state").clone(),D=D.find(".deal-item--name").text(),C.html(A),C.append(c.crm.escape(D)));c.post(c.crm.app_url+"?module=invoice&action=associateDealSave",E,function(F){"ok"===F.status?(l.closest(".dialog").data("dialog").close(),c.crm.content.reload()):(C.html(""),C.addClass("hidden"),e(),k.removeClass("deal-form-hidden"))})}d=d||{};var g=this,l=d.$wrapper||g.$wrapper,k=l.find(".js-deal-selector-control-wrapper"),h=k.find(".js-deal-name"),n=k.find(".js-deal-name-input"),m=l.closest(".js-conversation-deal-attach-dialog").find(".js-save-button"),
p=k.find(".js-save-deal"),q=k.find(".js-deals-dropdown"),r=k.find(".js-create-new-deal-link"),u=k.find(".js-remove-deal"),v=q.find(".js-empty-deal"),t=k.find(".js-select-deal .js-visible-link .js-text"),w=k.find(".js-select-funnel-wrapper"),x=k.find(".js-select-stage-wrapper"),y=k.find(".js-deals-list"),z=k.find(".js-deal-id"),B=function(C){C=C||{};var A=C.funnels||{},D=0;c.each(C.deals||{},function(E,F){E=y;var G=E.prepend;var H=A[F.funnel_id];if(!F||0>=F.id)F="";else{var I=F.id,K=F.name||"",J="",
L="";H&&H.stages&&H.stages[F.stage_id]&&(J=H.stages[F.stage_id].color||"");c.isEmptyObject(H)&&(L='<span class="hint">'+g.locales.funnel_deleted+"</span>");F='<li><a href="javascript:void(0);" class="js-deal-item" data-deal-id="'+I+'"><span class="flexbox middle js-text"><i class="fas fa-circle funnel-state" style="color: '+J+'"></i><span class="deal-item--name" style="word-break: break-word;">'+K+"</span></span>"+L+"</a></li>"}G.call(E,F);D++});k.show();q.data("deals_count",D);0<D?(q.removeClass("hidden"),
r.addClass("hidden")):(r.removeClass("hidden"),q.addClass("hidden"))};z.val("none");"undefined"===typeof d.data?g.loadDealListByContact(B):B(d.data);k.on("click",".js-create-new-deal",function(){z.val("0");q.addClass("hidden");r.addClass("hidden");h.removeClass("c-deal-name-hidden");p.attr("title",g.locales.deal_create).removeClass("hidden");w.removeClass("hidden");v.removeClass("c-empty-deal-hidden");n.focus();m.addClass("yellow")});k.on("click",".js-deal-item",function(){var C=c(this).find(".js-text").html();
t.html(C);z.val(c(this).data("deal-id"));p.attr("title",g.locales.deal_add).removeClass("hidden");w.addClass("hidden");v.removeClass("c-empty-deal-hidden");y.find("li").removeClass("selected");c(this).parent().addClass("selected");m.addClass("yellow")});y.on("click",function(){y.hide();setTimeout(function(){y.removeAttr("style")},200)});v.on("click",function(){e()});u.on("click",function(){e()});p.on("click",function(C){C.preventDefault();k.trigger("submit")});k.on("submit",function(C){C.preventDefault();
f()});k.on("change",".js-select-deal-funnel",function(){k.find(".js-select-stage-wrapper").load("?module=deal&action=stagesByFunnel&id="+c(this).val())});return{submit:function(){k.trigger("submit")}}};CRMInvoiceEdit.prototype.loadDealListByContact=function(d){var e=this.$wrapper.find(".js-contact-toggle .js-contact-id").val(),f="?module=deal&action=byContact&id="+e;d=d||function(){};0>=e||this.iframe?d({}):c.get(f,"json").always(function(g){g&&"ok"===g.status?d(g.data||{}):d({})})};CRMInvoiceEdit.prototype.initChangeCompany=
function(){function d(l,k,h){l&&l.length&&(e.active_tax_array=l);g.find("option").remove();e.$taxHeader.text(k.length?k:"\u2014");l&&k?(e.$emptyTax.hide(),e.$tax.parent().show(),c.each(l,function(n,m){n=c('<option value="'+n+'"></option>');if("INCLUDE"===m.tax_type){n.data("type","INCLUDE");var p=e.locales.include_tax}else"APPEND"===m.tax_type?(n.data("type","APPEND"),p=e.locales.append_tax):"NONE"===m.tax_type&&(n.data("type","NONE"),m.tax_percent=0,p=e.locales.no_tax);0<m.tax_percent?(n.data("percent",
m.tax_percent),p=p.replace("%value",m.tax_percent+"%")):(n.data("percent",0),p=p.replace("%value",""));if(p=p.replace("%name",k)){if(e.tax){var q=k===e.tax.name,r=m.tax_type===e.tax.type;m=(+m.tax_percent).toFixed(2)===(+e.tax.percent).toFixed(2);q&&r&&m&&n.attr("selected",!0)}n.text(p);n.data("name",k);g.append(n)}})):(e.$tax.parent().hide(),e.$emptyTax.show(),l=e.$emptyTaxLink.data("href"),e.$emptyTaxLink.attr("href",l+e.$companyField.val().toString()+"/"));g.trigger("change",!h)}var e=this,f=e.$companyField,
g=e.$tax;f.on("change",function(l,k){l=c(this).val();var h=e.companies[l];e.active_tax_array=[];h&&(l=h.tax_name||e.locales.tax,h=JSON.parse(h.tax_options),d(h,l,k))});f.trigger("change",!0)};CRMInvoiceEdit.prototype.initChangeTax=function(){var d=this;d.$tax.on("change",function(e,f){e=c(this).find("option");d.tax_percent=0;d.tax_type="NONE";d.tax_name="";e.length&&(e=e[this.selectedIndex],d.tax_percent=c(e).data("percent")||0,d.tax_type=c(e).data("type"),d.tax_name=c(e).data("name"));d.$taxPercent.val(d.tax_percent);
d.$taxType.val(d.tax_type);d.$taxName.val(d.tax_name);d.renderProductTaxOptions();d.renderProductTaxFields(f);d.refreshTable()})};CRMInvoiceEdit.prototype.initWYSIWYG=function(){var d=this.$wrapper.find(".js-wysiwyg");c.crm.initWYSIWYG(d,{keydownCallback:function(e){}})};CRMInvoiceEdit.prototype.initProductName=function(){function d(g){function l(x){w&&w.abort();var y=c.crm.backend_url+"shop/?action=autocomplete&with_counts=1";x={term:x};h("loading");w=c.get(y,x,function(z){z.length?(r.html(""),c.each(z,
function(B,C){B=c("<div />");B.html(C.label).data("product",C).addClass("js-set-product");h(B)})):e.$wrapper.trigger("searchProduct")},"json").always(function(){w=!1})}function k(x){w&&w.abort();h("loading");var y=e.$currencyField.val();w=c.get(c.crm.backend_url+"shop/?module=orders&action=getProduct",{product_id:x.id,currency:y},function(z){"ok"===z.status?(r.html(""),c.each(z.data.sku_ids,function(B,C){B=c("<div />");C=z.data.product.skus[C];B.text(z.data.product.name+(C.name.length?" ("+C.name+
")":"")).data("product",z.data.product).data("sku",C).addClass("js-set-sku");h(B);1===z.data.sku_ids.length&&B.trigger("click")})):e.$wrapper.trigger("searchProduct")},"json").always(function(){w=!1})}function h(x){if("loading"===x)r.html("").append('<li class="ui-menu-item-html ui-menu-item"><div class="ui-menu-item-wrapper"><i class="fas fa-spinner wa-animation-spin"></i></div></li>');else{var y=c("<li />").addClass("ui-menu-item-html ui-menu-item");c("<div />").addClass("ui-menu-item-wrapper").append(x).appendTo(y);
y.appendTo(r)}}function n(){g.removeClass("is-active");r.html("");v=!1}function m(x){var y=r.find("li"),z=y.filter(".is-highlighted");if(!y.length)return!1;z.length&&1<y.length?(z.removeClass("is-highlighted"),x?(x=z.next(),x.length||(x=y.first())):(x=z.prev(),x.length||(x=y.last()))):x=y.first();x.addClass("is-highlighted")}function p(){var x=r.find("li.is-highlighted");x.length&&x.find(".ui-menu-item-wrapper > *").first().trigger("click")}var q=g.find(".js-name-field"),r=g.find(".js-hidden-list"),
u=g.find(".js-product-field"),v=!1,t=0,w=!1;q.on("keyup",function(x){x=x.keyCode;if(0<=[13,27,37,38,39,40].indexOf(x))switch(x){case 13:p();break;case 27:n();q.trigger("blur");break;case 38:m(!1);break;case 40:m(!0)}else{var y=c(this).val();1<y.length?(v||(e.$wrapper.trigger("searchProduct"),g.addClass("is-active"),v=!0),clearTimeout(t),t=setTimeout(function(){l(y)},500)):e.$wrapper.trigger("searchProduct")}});q.on("change",function(){u.val("").trigger("change")});e.$wrapper.on("searchProduct",n);
r.on("click",".js-set-product",function(){var x=c(this).data("product");x&&k(x)});r.on("click",".js-set-sku",function(){var x=c(this),y=x.data("product");x=x.data("sku")||!1;if(y){var z="shop:"+y.id+(x?":"+x.id:""),B=x.price;q.val(y.name+(x.name.length?" ("+x.name+")":"")).trigger("change");g.closest("tr").find(".js-price-field").val(B).trigger("change");u.val(z).trigger("change")}n();q.trigger("blur")})}var e=this,f=e.$wrapper.find(".js-name-autocomplete");f.length&&(f.each(function(){d(c(this))}),
e.refreshTable());e.$wrapper.on("addProduct",function(g,l){g=c(l).find(".js-name-autocomplete");g.length&&d(g)})};CRMInvoiceEdit.prototype.initChangeCurrency=function(){function d(g,l){e.$tableBody.find(".js-price-field").each(function(){var k=c(this),h=k.val(),n=0;h&&h.length&&(h=h.replace(/,/g,".").replace(/\s/g,""),0<parseFloat(h)&&(n=parseFloat(h)),k.val(n*e.currencies[l].rate/e.currencies[g].rate).trigger("change"))})}var e=this,f=e.$currencyField.val();e.$currencyField.on("change",function(){var g=
e.$currencyField.val(),l=!1;e.$tableBody.find(".js-price-field").each(function(){if(c(this).val().length)return l=!0,!1});l?(e.$currencyField.val(f),c.waDialog({html:e.confirm_dialog_template,options:{changeCurrencyWithPrice:function(){e.$currencyField.val(g);d(g,f);f=g},changeCurrency:function(){e.$currencyField.val(g);f=g}}})):f=g})};CRMInvoiceEdit.prototype.initToggleButton=function(){var d=this.$wrapper.find(".js-footer-actions"),e=d.find(".js-submit-button");this.$wrapper.on("change keydown",
"input, textarea, select",function(){e.removeClass("green").addClass("yellow");d.addClass("is-changed");c(document).trigger("unsavedChanges",!0)})};return CRMInvoiceEdit}(jQuery),CRMInvoiceContactAdd=function(c){CRMInvoiceContactAdd=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.dialog=this.$wrapper.data("dialog");this.locales=a.locales;this.initClass()};CRMInvoiceContactAdd.prototype.initClass=function(){function a(){var g=e.$form.serializeArray(),l={data:[],errors:[]},
k=!1,h=!1;c.each(g,function(n,m){n=m.name;var p=m.value;"deal[contact_id]"===n&&p&&(k=!0);"contact[firstname]"===n&&p&&(h=!0);"contact[lastname]"===n&&p&&(h=!0);"contact[middlename]"===n&&p&&(h=!0);"contact[name]"===n&&p&&(h=!0);l.data.push(m)});k||h||(l.errors.push({name:"contact[name]",value:e.locales.empty_name}),l.errors.push({name:"contact[firstname]",value:e.locales.empty_name}));return l}function b(g){c.post("?module=invoice&action=contactAddSave",g,function(l){"ok"===l.status?(e.dialog.options.onAdd(l.data.id,
l.data.name),e.dialog.close()):d(l.errors)},"json").always(function(){f=!1})}function d(g,l){l=l?l:[];if(g){var k=Object.keys(g);c.each(k,function(h,n){l.push({name:n,value:g[n]})})}c.each(l,function(h,n){h=n.name;n=n.value;"name"===h&&(h="contact[firstname]");var m=e.$form.find('[name="'+h+'"]');"contact[firstname]"!==h||m.is(":visible")||(m=e.$form.find(".js-contact-autocomplete"));if(m.length&&!m.hasClass("state-error")){var p=c("<div />").addClass("state-error-hint").text(n);p.insertAfter(m);
m.addClass("state-error").one("focus click",function(){m.removeClass("state-error");p.remove()});c(document).on("toggleChanged",function(){m.removeClass("state-error");p.remove()})}})}var e=this,f=!1;e.$form.on("submit",function(g){g.preventDefault();g=e.$wrapper.find(".js-contact-id-field").val();if(g){var l=e.$wrapper.find(".js-contact-autocomplete").val();e.dialog.options.onAdd(g,l);e.dialog.close()}else f||(f=!0,g=a(),g.errors.length?(d(!1,g.errors),f=!1):b(g.data))})};return CRMInvoiceContactAdd}(jQuery),
CRMInvoicePage=function(c){function a(b,d){if(!b)return!1;b=c('.js-invoices-list .c-invoice[data-id="'+b+'"]');b.length&&(d?b.replaceWith(d):b.remove())}CRMInvoicePage=function(b){this.$wrapper=b.$wrapper;this.invoice_id=b.invoice_id;this.locales=b.locales;this.initClass()};CRMInvoicePage.prototype.initClass=function(){var b=this;b.initChangeState();b.initDelete();b.initRefund();b.initRestore();setTimeout(function(){c(document).trigger("viewInvoice",b.invoice_id)},100);b.$wrapper.data("page",b);c(".js-action-link").one("click",
function(d){spinnerView(c(this)).show()})};CRMInvoicePage.prototype.initChangeState=function(){function b(g,l){if(!f){f=!0;var k={invoice_id:e,action:g},h=spinnerView(l);h.show();c.post("?module=invoice&action=handleTransaction",k,function(n){if("ok"===n.status){var m=getIframeIfExists();m?(window.parent.iframe_invoice_is_saved=!0,m.contentWindow.location.reload()):(a(d.invoice_id,"delete"===g?"":n.data.html),d.load(c.crm.app_url+"invoice/"+d.invoice_id+"/"))}else alert(n.errors)},"json").always(function(){h.hide();
f=!1})}}var d=this,e=d.invoice_id,f=!1;d.$wrapper.on("click",".js-change-state",function(g){g.preventDefault();(g=c(this).data("action"))&&b(g,c(this))})};CRMInvoicePage.prototype.initDelete=function(){function b(f){if(!e){e=!0;var g={invoice_id:d.invoice_id,action:"delete"},l=spinnerView(f.$body.find(".js-success-action"));l.show();c.post("?module=invoice&action=handleTransaction",g,function(k){if("ok"===k.status){k=c.crm.app_url+"invoice/";var h=getIframeIfExists();h?h.dispatchEvent(new CustomEvent("close",
{detail:"refresh"})):c.crm.content.load(k)}},"json").always(function(){l.hide();e=!1})}}var d=this,e=!1;d.$wrapper.on("click",".js-delete-invoice",function(f){f.preventDefault();c.waDialog.confirm({title:d.locales.delete_confirm_title,text:d.locales.delete_confirm_text,success_button_title:d.locales.delete_confirm_button,success_button_class:"danger",cancel_button_title:c.crm.locales.cancel,cancel_button_class:"light-gray",onSuccess:b})})};CRMInvoicePage.prototype.initRefund=function(){function b(f){if(!e){e=
!0;var g=c.crm.app_url+"?module=invoice&action=refundDialog",l={invoice_id:d.invoice_id},k=spinnerView(f,0);k.show();c.post(g,l,function(h){c.waDialog({html:h,options:{onRefund:function(n){var m=getIframeIfExists();m?(window.parent.iframe_invoice_is_saved=!0,m.contentWindow.location.reload()):(a(d.invoice_id,n.html),d.reload())}}})}).always(function(){k.hide();e=!1})}}var d=this,e=!1;d.$wrapper.on("click",".js-change-refund",function(f){f.preventDefault();b(c(this))})};CRMInvoicePage.prototype.initRestore=
function(){function b(f){if(!e){e=!0;var g={id:d.invoice_id},l=spinnerView(f);l.show();c.post("?module=invoiceRestore",g,function(k){if("ok"===k.status){var h=getIframeIfExists();h?(window.parent.iframe_invoice_is_saved=!0,h.contentWindow.location.reload()):(a(d.invoice_id,k.data.html),d.reload())}else l.hide(),alert(k.errors)},"json").always(function(){e=!1})}}var d=this,e=!1;d.$wrapper.on("click",".js-restore-invoice",function(f){f.preventDefault();b(c(this))})};CRMInvoicePage.prototype.load=function(b){b=
c("<a />").addClass("js-disable-router").attr("href",b).hide();this.$wrapper.append(b);b.trigger("click")};CRMInvoicePage.prototype.reload=function(){this.load(location.href)};return CRMInvoicePage}(jQuery),CRMInvoiceRefundDialog=function(c){CRMInvoiceRefundDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMInvoiceRefundDialog.prototype.initClass=function(){this.initSubmit()};CRMInvoiceRefundDialog.prototype.initSubmit=
function(){function a(){var g={data:[],errors:[]},l=e.serializeArray();c.each(l,function(k,h){g.data.push(h)});return g}function b(g,l){if(!f){f=!0;var k=c.crm.app_url+"?module=invoice&action=handleTransaction",h=spinnerView(l);h.show();c.post(k,g,function(n){"ok"===n.status?(d.dialog.options.onRefund(n.data),d.dialog.close()):console.log(n.errors)},"json").always(function(){h.hide();f=!1})}}var d=this,e=d.$form,f=!1;e.on("submit",function(g){g.preventDefault();g=a();g.errors.length?console.log(g.errors):
b(g.data,e.find(".js-submit-button"))})};return CRMInvoiceRefundDialog}(jQuery);function getIframeIfExists(){return(new URLSearchParams(document.location.search)).get("iframe")&&window.parent?window.parent.document.getElementById("iframe-invoice"):null}
function spinnerView(c,a){a=void 0===a?350:a;var b=$('<span class="icon size-16 custom-mr-8 js-loading"><i class="fas fa-spinner wa-animation-spin"></i></span>'),d=c.find(".icon:not(.js-loading)");return{show:function(){d&&d.hide();c.prepend(b);"BUTTON"===c.prop("tagName")&&c.prop("disabled",!0)},hide:function(){setTimeout(function(){c.removeAttr("disabled");c.find(".js-loading").remove();d&&d.show()},a)}}};var CRMInvoices=function(c){function a(){var b=!1,d=c("#c-invoice-page");d.length&&(d=d.data("id"))&&(b=d);return b}CRMInvoices=function(b){this.$wrapper=b.$wrapper;this.$content=this.$wrapper.find("#js-inner-content");this.$sidebar=this.$wrapper.find("#js-aside-block");this.$invoiceList=this.$sidebar.find(".js-invoices-list");this.initClass()};CRMInvoices.prototype.initClass=function(){this.showOnlyDesktopClass="desktop-and-tablet-only";this.patternsBeginContent=[".+\\d+\\/",".+new\\/"];this.initWaLoading();
this.filtersDropdown();this.initContentRouter();this.initLazy();this.initInvoiceList();this.initInvoiceSearch();this.initMobileEvents()};CRMInvoices.prototype.hideContentMobile=function(){this.$content.addClass(this.showOnlyDesktopClass);this.$sidebar.removeClass(this.showOnlyDesktopClass)};CRMInvoices.prototype.showContentMobile=function(){this.$sidebar.addClass(this.showOnlyDesktopClass);this.$content.removeClass(this.showOnlyDesktopClass)};CRMInvoices.prototype.initMobileEvents=function(){var b=
this;c(document).on("click",".js-invoice-hide-mobile",function(){b.hideContentMobile()});for(var d=window.location.pathname,e=$jscomp.makeIterator(this.patternsBeginContent),f=e.next();!f.done;f=e.next())if((new RegExp(f.value,"g")).test(d)){this.showContentMobile();break}};CRMInvoices.prototype.filtersDropdown=function(){c(".dropdown",this.$sidebar).waDropdown({hover:!1,items:".menu > li > a",change:function(b){if("touchend"!==b.type)return!1;b=c(b.target).closest("a");if(!b.length)return!1;if(b=
b.attr("href"))window.location=b}})};CRMInvoices.prototype.initWaLoading=function(){var b=c.waLoading(),d=c(document);d.on("wa_before_load.invoices",function(){b.show();b.animate(1E4,100,!1);d.addClass("is-locked")}).on("wa_loading.invoices",function(e,f){b.set(f.loaded/f.total*100)}).on("wa_abort.invoices",function(){b.abort();d.removeClass("is-locked")}).on("wa_loaded.invoices",function(){b.done();d.removeClass("is-locked")});c("#c-invoices-page").one("remove",function(){d.off(".invoices");b.$bar.remove();
b.$wrapper.remove();d.removeClass("is-locked")})};CRMInvoices.prototype.initContentRouter=function(){function b(k){l&&l.abort();c(document).trigger("wa_before_load");return l=c.ajax({method:"GET",url:k,data:{content_only:1},dataType:"html",global:!1,cache:!1,xhr:function(){var h=new window.XMLHttpRequest;h.addEventListener("progress",function(n){c(document).trigger("wa_loading",n)},!1);h.addEventListener("abort",function(n){c(document).trigger("wa_abort")},!1);return h}}).always(function(){d.xhr=
!1}).done(function(h){g&&history.pushState({reload:!0,content_uri:k},"",k);c(document).trigger("wa_before_render");e.html(h);c(document).trigger("wa_loaded")}).fail(function(h){c(document).trigger("wa_abort");h.responseText&&c.waDialog.alert({title:"Error",text:h.responseText,button_title:"Close"})})}var d=this,e=d.$content.find(".js-inner-content"),f=!1,g=!(!history||!history.pushState),l=!1;d.$wrapper.on("click","a",function(k){var h=c(this),n=h.hasClass("js-disable-router")?h.attr("href"):!1;if(!n)return!0;
k.preventDefault();f?c.waDialog.confirm({title:c.crm.locales.unsaved_dialog_title,text:c.crm.locales.unsaved_dialog_text,success_button_title:c.crm.locales.unsaved_dialog_button,success_button_class:"danger",cancel_button_title:c.crm.locales.cancel,cancel_button_class:"light-gray",onSuccess:function(){c(document).trigger("unsavedChanges",!1);b(n)}}):b(n).then(function(){d.$content.is(":hidden")&&d.showContentMobile()})});c(document).on("unsavedChanges",function(k,h){f=!!h})};CRMInvoices.prototype.initLazy=
function(){function b(){if(!g){var l={offset:f.data("offset")},k=a();k&&(l.invoice_id=k);g=!0;c.post("?module=invoice&action=sidebar",l,function(h){var n=c(h);h=n.find(".js-lazyload");n=n.find(".c-invoice");e.unobserve(f[0]);h.length?(h.insertAfter(f),f.remove(),f=h,e.observe(f[0])):f.remove();d.append(n)}).always(function(){g=!1})}}var d=this.$invoiceList,e=null,f=this.$wrapper.find(".js-lazyload"),g=!1;this.$invoiceList.on("touchstart",function(){c("body").css({overflow:"hidden"});c(this).closest(".sidebar-body").css({overflow:"overlay"});
setTimeout(function(){c("body").css({overflow:"auto"})})});f.length&&function(){e=new IntersectionObserver(function(l){0>=l[0].intersectionRatio||b()});e.observe(f[0])}()};CRMInvoices.prototype.initInvoiceList=function(){function b(f){d.$invoiceList.find(".c-invoice").each(function(){var g=c(this),l=g.data("id");f==l&&(g.addClass("selected"),e=g)})}var d=this,e=d.$invoiceList.find(".c-invoice.selected");c(document).on("viewInvoice",function(f,g){e.length&&e.removeClass("selected");g&&b(g)})};CRMInvoices.prototype.initInvoiceSearch=
function(){var b=this.$wrapper.find(".js-search-field");b.autocomplete({appendTo:this.$sidebar,classes:{"ui-autocomplete":"c-search-results-list"},source:c.crm.app_url+"?module=invoiceAutocomplete",minLength:1,html:!0,focus:function(){return!1},select:function(d,e){c.crm.content.load(c.crm.app_url+"invoice/"+e.item.id+"/");b.val("");return!1}}).data("ui-autocomplete")._renderItem=function(d,e){return c("<li />").addClass("ui-menu-item-html").append("<div>"+e.value+"</div>").appendTo(d)}};return CRMInvoices}(jQuery);var CRMReminderFormEdit=function(c){CRMReminderFormEdit=function(a){this.$wrapper=a.$wrapper;this.$main_wrapper=a.$main_wrapper;this.$form=this.$wrapper.find("form");this.$loader_spinner=c(".c-reminders-list-loader");this.reminder_id=a.reminder_id;this.locales=a.locales;this.app_url=a.app_url;this.initialFormValues=this.$form.serialize();this.initialFormData=a.reminder_data;this.tempFormData=jQuery.extend(!0,{},this.initialFormData);this.form_is_change=!1;this.is_first_click=!0;this.initClass()};
CRMReminderFormEdit.prototype.initClass=function(){this.initDatePicker();this.initTextArea();this.initTimeToggle();this.initTimePicker();this.initTypeToggle();this.initSubmit();this.initClickWatcher()};CRMReminderFormEdit.prototype.initCombobox=function(){function a(f){f?(d.addClass("is-shown"),d.find(".js-autocomplete").focus()):d.removeClass("is-shown")}var b=this,d=b.$form.find(".js-contact-wrapper"),e=d.find(".js-contact-field");d.on("click",".js-show-combobox",function(f){a(!0)});d.on("click",
".js-hide-combobox",function(f){f.stopPropagation();a(!1)});(function(){var f=d.find(".js-autocomplete");f.autocomplete({appendTo:d,source:b.app_url+"?module=autocomplete&type=user",minLength:0,html:!0,focus:function(){return!1},select:function(g,l){b.setContact(l.item);a(!1);f.val("");b.form_is_change=!0;return!1}}).data("ui-autocomplete")._renderItem=function(g,l){return c("<li />").addClass("ui-menu-item-html").append("<div>"+l.value+"</div>").appendTo(g)};f.on("focus",function(){f.data("uiAutocomplete").search(f.val())})})();
b.setContact=function(f){var g=d.find(".js-user");f.photo_url&&g.find(".icon.size-24").css("background-image","url("+f.photo_url+")").html("");g.find(".c-name").text(f.name);e.val(f.id)}};CRMReminderFormEdit.prototype.initSearchDeal=function(){var a=this,b=a.$form.find(".c-deal-wrapper"),d=a.$form.find('[name="data[deal_id]"]'),e=a.$form.find('[name="data[contact_id]"]'),f=b.find(".c-search-contact-wrapper"),g=b.find(".c-deal-item"),l=b.find(".js-autocomplete-deal");l.autocomplete({appendTo:f,position:{my:"right top",
at:"right bottom"},source:a.app_url+"?module=autocompleteSidebar",minLength:0,html:!0,focus:function(k,h){return!1},select:function(k,h){a.setDeal(h.item);l.val("");f.find(".ui-autocomplete").hide();a.form_is_change=!0;d.trigger("click");return!1}}).data("ui-autocomplete")._renderItem=function(k,h){return c("<li />").addClass("ui-menu-item-html").append("<div>"+h.value+"</div>").appendTo(k)};b.on("click",function(k){k.preventDefault();k=c(k.target);f.is(":visible")?k.closest(".js-reset-deal").length&&
a.clearDeal():k.closest(".js-open-search").length&&(f.addClass("is-shown"),l.focus())});a.clearDeal=function(){g.html("");f.removeClass("is-hidden is-shown");e.val("");d.val("");a.form_is_change=!0;d.trigger("click");a.tempFormData.contact.id="";a.tempFormData.contact.name="";a.tempFormData.contact.photo_url=""};l.on("focus",function(){l.data("uiAutocomplete").search(l.val())});a.setDeal=function(k,h){h=void 0===h?!1:h;var n=a.app_url+(k.photo_url?"contact/":"deal/")+k.id;n='<a class="flexbox middle c-user" href="'+
(h?n:"javascript:void(0);")+'">\n            '+(k.photo_url?'<span class="icon size-18 rounded js-open-search" style="background-image: url('+k.photo_url+');"></span>':"")+'\n            <span class="c-user-name">&nbsp;'+k.name+"</span>\n            </a>\n            "+(h?"":'<div class="hint custom-pl-12 js-open-search cursor-pointer">\n                <span class="icon size-14"><i class="fas fa-pen" title="[`edit`]"></i></span>\n            </div>');if(h)return n;f.addClass("is-hidden").removeClass("is-shown");
g.html(n);k.photo_url?(e.val(k.id),d.val(""),a.tempFormData.contact.photo_url=k.photo_url):(d.val(k.id),e.val(""),a.tempFormData.contact.photo_url="");a.tempFormData.contact.id=k.id;a.tempFormData.contact.name=k.name}};CRMReminderFormEdit.prototype.initTextArea=function(){var a=this,b=a.$wrapper.find(".js-textarea");a.$textField=a.$main_wrapper.find(".js-float-text");b.css("min-height",a.$textField.height()+"px");b.on("input",function(){b.css("height",b[0].scrollHeight+"px")});b.on("focusout",function(){a.form_is_change=
!0});b.on("keydown",function(d){13!==d.keyCode||d.shiftKey||(d.preventDefault(),d.stopPropagation(),a.$form.trigger("submit"))})};CRMReminderFormEdit.prototype.initDatePicker=function(){var a=this;a.$form.find(".js-datepicker").each(function(){var b=c(this);0<this.value.length&&(this.style.width=7*this.value.length+"px");b.datepicker({changeMonth:!0,changeYear:!0,showOtherMonths:!0,selectOtherMonths:!0,gotoCurrent:!0});var d=b.parent(),e=d.find(".calendar"),f=d.find(".js-reset-date");e.on("click",
function(){b.focus()});a.reminder_id||b.datepicker("setDate","+1d");b.on("change",function(){this.style.width=0<this.value.length?7*this.value.length+"px":8*(this.getAttribute("placeholder").length+1)+"px";""!==b.val()&&d.addClass("is-active");a.form_is_change=!0;d.trigger("click")});f.on("click",function(){b.val("");b.trigger("change");d.removeClass("is-active")})})};CRMReminderFormEdit.prototype.initTimeToggle=function(){function a(f){f?d.addClass("is-active"):d.removeClass("is-active")}var b=this,
d=b.$form.find(".js-time-toggle"),e=d.find(".js-timepicker");e.on("change",function(){a(!0);""==e.val()&&a();b.form_is_change=!0});d.on("click",".js-show-time",function(){e.focus()});d.on("click",".js-reset-time",function(){e.val("");a();b.form_is_change=!0})};CRMReminderFormEdit.prototype.initTimePicker=function(){this.$form.find(".js-timepicker").each(function(){c(this).timepicker()})};CRMReminderFormEdit.prototype.initClickWatcher=function(){var a=this,b=a.$main_wrapper,d=a.$wrapper,e=a.$wrapper.find(".js-textarea");
b.on("editOpen",function(){c(".c-reminder-wrapper.highlighted").removeClass("highlighted");a.is_first_click&&(a.initCombobox(),a.initSearchDeal(),a.is_first_click=!1,e.css("height",0),e.css("height",e[0].scrollHeight+"px"));c(document).on("click",a.editClickWatcher);b.on("escKeyPress",a.$clear)});a.close_edit=function(){b.trigger("reminderNotChanged");a.form_is_change=!1;c(document).off("click",a.editClickWatcher);b.off("escKeyPress",a.$clear)};a.editClickWatcher=function(f){if(c.contains(document,
d[0])){var g=c(f.target);if(d.is(":visible")){f=c.contains(b[0],f.target);var l=!!g.closest(".js-edit-reminder").length,k=!!g.closest(".ui-timepicker-wrapper").length,h=!!g.closest(".ui-datepicker").length||!!g.closest(".ui-corner-all").length,n=d.find(".js-contact-wrapper").hasClass("is-shown"),m=!!g.closest(".js-contact-wrapper").length,p=d.find(".c-search-contact-wrapper").hasClass("is-shown");g=!!g.closest(".c-deal-wrapper").length;f||k||h||(a.checkFormChange()?a.close_edit():l&&a.close_edit());
n&&!m&&d.find(".js-contact-wrapper").removeClass("is-shown");p&&!g&&d.find(".c-search-contact-wrapper").removeClass("is-shown")}}else c(document).off("click",a.editClickWatcher),b.off("escKeyPress",a.$clear)}};CRMReminderFormEdit.prototype.initTypeToggle=function(){var a=this,b=a.$wrapper.find(".js-reminder-type-toggle"),d=b.find(".js-type-field"),e=b.find(".menu");b.waDropdown();e.on("click","a",function(){var f=c(this);b.find(".js-text").html(f.html());e.find(".selected").removeClass("selected");
f.closest("li").addClass("selected");f=f.data("type-id");d.val(f).trigger("change");a.form_is_change=!0})};CRMReminderFormEdit.prototype.checkFormChange=function(a){var b=this.$form.serialize();if(a){a=this.initialFormData;var d=this.$form.serializeArray(),e={all:!0,date_time:!0};e.all=this.initialFormValues===b;b=d.filter(function(g){return"data[due_date]"===g.name})[0].value;var f=d.filter(function(g){return"data[due_time]"===g.name})[0].value;d=d.filter(function(g){return"data[user_contact_id]"===
g.name})[0].value;e.date_time=a.due_date===b&&a.due_time===f&&a.user_contact.id===d?!0:!1;return e}return this.initialFormValues===b};CRMReminderFormEdit.prototype.initSubmit=function(){function a(){var m={data:[],errors:[]},p=l.serializeArray(),q=!1;type_other=!1;c.each(p,function(r,u){u.value.length&&(m.data.push(u),"data[due_time]"===u.name&&(q=!0),"OTHER"===u.value&&(type_other=!0))});m.data.length<(q?5:type_other?4:3)&&m.errors.push({name:"content",value:f.locales.at_least});type_other&&(p=m.data.filter(function(r){return"data[content]"===
r.name}),p.length&&/\S/.test(p[0].value)||m.errors.push({name:"content",value:f.locales.empty}));return m}function b(m,p){p=p?p:[];if(m){var q=Object.keys(m);c.each(q,function(r,u){p.push({name:u,value:m[u]})})}c.each(p,function(r,u){r=u.value;var v=l.find('[name="data['+u.name+']"');if(!v.hasClass("error")){var t=c("<span />").addClass("errormsg").text(r);h.find(".flexbox.vertical.width-100").append(t);v.addClass("error").one("focus click change clear_error",function(){v.removeClass("error");t.remove()});
$has_errors=!0}})}function d(m,p){if(!g){g=!0;var q=f.app_url+"?module=reminder&action=save";$loader=c('<span class="icon"><i class="fas fa-spinner wa-animation-spin"></i></span>');h.find(".c-actions-button.js-save").append($loader);c.post(q,m,function(r){"ok"===r.status?(p?(k.trigger("reminderIsChanged"),c(document).off("click",f.editClickWatcher),k.off("escKeyPress",f.$clear)):e(m),f.initialFormValues=f.$form.serialize(),f.form_is_change=!1):b(r.errors)},"json").always(function(){$loader.remove();
g=!1})}}function e(m){var p=m.filter(function(r){return"data[content]"===r.name});m=m.filter(function(r){return"data[type]"===r.name})[0].value;f.tempFormData.content!==p&&(p.length?(f.tempFormData.content=p[0].value,f.$textField.html((p[0].value+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1<br />$2"))):(f.tempFormData.content="",f.$textField.html("")));if(f.tempFormData.type!==m){p=f.$wrapper.find(".js-reminder-type-toggle button");var q=f.$main_wrapper.find("button.no-hover");"OTHER"===m?q.remove():
q.length?q.html(p.html()):(p='<button class="button button-slim smallest rounded light-gray no-hover">'+p.html()+"</button>",f.$main_wrapper.find(".is-view .c-footer").prepend(p));f.tempFormData.type=m}f.tempFormData.contact.id!==f.initialFormData.contact.id&&f.tempFormData.contact.name!==f.initialFormData.contact.name&&(m=f.$main_wrapper.find(".is-view .c-deal-wrapper"),""!==f.tempFormData.contact.id?m.html(f.setDeal(f.tempFormData.contact,!0)):m.html(""));f.initialFormData=jQuery.extend(!0,{},f.tempFormData);
k.addClass("highlighted");k.trigger("reminderNotChanged");k.trigger("updatePadding")}var f=this,g=!1,l=f.$form,k=f.$main_wrapper,h=f.$wrapper,n=l.find(".js-save");$cancel_button=l.find(".js-cancel");$has_errors=!1;n.on("click",function(m){m.stopPropagation();f.$form.trigger("submit")});$cancel_button.on("click",function(m){m.stopPropagation();m.preventDefault();f.$clear()});f.$clear=function(){var m=l.find(".js-textarea"),p=l.find(".js-datepicker"),q=l.find(".js-timepicker"),r=l.find(".c-search-contact-wrapper").hasClass("is-hidden"),
u=l.find(".js-contact-field");if(!f.checkFormChange()){var v=f.initialFormData;m.val(v.content);h.find(".menu a[data-type-id='"+v.type+"']").trigger("click");p.val(v.due_date).trigger("change");q.val(v.due_time).trigger("change");v.contact.id?f.setDeal(v.contact):r&&f.clearDeal();u!==v.user_contact.id&&f.setContact(v.user_contact);$has_errors&&(l.find('[name="data[content]"').trigger("clear_error"),$has_errors=!1);m.css("height",0);m.css("height",m[0].scrollHeight+"px")}f.close_edit()};l.on("submit",
function(m){m.preventDefault();m=f.checkFormChange(!0);m.all?f.close_edit():m.date_time?f.$submit_reminder():f.$submit_reminder(!0)});f.$submit_reminder=function(m){$has_errors&&(l.find('[name="data[content]"').trigger("clear_error"),$has_errors=!1);var p=a();p.errors.length?b(!1,p.errors):d(p.data,m)}};return CRMReminderFormEdit}(jQuery);var CRMReminders=function(c){CRMReminders=function(a){this.$wrapper=a.$wrapper;this.$sidebar=a.$sidebar;this.$iframe=a.iframe;this.$completedSection=this.$wrapper.find(".c-completed-reminders-section");this.user_id=a.is_all_reminders?"all":a.user_id;this.setting_contact_id=a.setting_contact_id;this.setting_deal_id=a.setting_deal_id;this.current_page=a.current_page;this.assign_to_user=a.assign_to_user;this.locales=a.locales;this.click_reminder_event=!1;this.initClass()};CRMReminders.prototype.initClass=
function(){var a=this;a.initToggleSidebar();a.initAddReminder();a.initLazyLoading();a.initReopenReminder();a.user_id&&a.$completedSection.length&&a.initCompletedReminders();a.initTarget();a.$iframe||(c(window).on("beforeunload",function(b){localStorage.setItem("scrollpos",a.$sidebar.scrollTop())}),a.$sidebar.on("click",".c-user-wrapper",function(){c(document).off("is_completed_loaded_false");c(window).off("resize");a.$wrapper.find(".skeleton-wrapper").show();c("html, body").scrollTop(0);a.click_reminder_event=
!0;localStorage.setItem("scrollpos",a.$sidebar.scrollTop());c(this).find(".js-user-photo").html("").append('<span class="icon user-loader" style="font-size: 24px; color: var(--menu-glyph-color); width: 35px; height: 32px;"><i class="fas fa-spinner fa-spin"></i></span>')}))};CRMReminders.prototype.initToggleSidebar=function(){function a(e,f){0<=f.content_uri.indexOf("/reminder/")&&(b.hasClass("sidebar-opened")&&b.removeClass("sidebar-opened"),b.find(".skeleton-wrapper").show());c(document).off("wa_before_load",
a)}var b=this.$wrapper,d=b.find(".js-expand-sidebar");if(d.length)d.on("click",function(e){e.preventDefault();b.addClass("sidebar-opened")});c(document).on("wa_before_load",a)};CRMReminders.prototype.initAddReminder=function(){function a(){return v===q.serialize()}function b(t){t.stopPropagation();var w=c(t.target),x=c.contains(document,p[0]);t=c.contains(p[0],t.target);var y=!!w.closest(".ui-timepicker-wrapper").length,z=!!w.closest(".ui-datepicker").length||!!w.closest(".ui-corner-all").length,
B=$wrapperContact.hasClass("is-shown");w=!!w.closest(".js-contact-wrapper").length;x?(t||y||z||a()&&d(),B&&!w&&h()):c(document).off("click",b)}function d(){u.slideUp(300);r.blur();p.removeClass(extended_class);wrapper_is_open=!1;c(document).off("click",b)}function e(){a()||(r.val(""),p.find(".menu a[data-type-id='OTHER']").trigger("click"),m.$date_clear.trigger("click"),m.$time_clear.trigger("click"),m.clearDeal(),m.setContact(m.assign_to_user),has_errors&&(q.find('[name="data[content]"').trigger("clear_error"),
has_errors=!1),l());d()}function f(){var t={data:[],errors:[]},w=q.serializeArray(),x=!1;c.each(w,function(y,z){z.value.length&&(t.data.push(z),"OTHER"===z.value&&(x=!0))});x&&(w=t.data.filter(function(y){return"data[content]"===y.name}),w.length&&/\S/.test(w[0].value)||t.errors.push({name:"content",value:m.locales.empty}));return t}function g(t){t=t?t:[];c.each(t,function(w,x){w=x.value;var y=q.find('[name="data['+x.name+']"');if(!y.hasClass("error")){var z=c("<span />").addClass("errormsg").text(w);
p.find(".flexbox.vertical.width-100").append(z);y.addClass("error").one("focus click change clear_error",function(){y.removeClass("error");z.remove();has_errors=!1});has_errors=!0}})}function l(){r.css("min-height",0);r.css("min-height",r[0].scrollHeight+"px")}function k(t){var w=t.find(".js-contact-field"),x=t.find(".c-combobox");t.on("click",".js-show-combobox",function(y){y.stopPropagation();h(!0)});t.on("click",".js-hide-combobox",function(y){y.stopPropagation();h(!1)});(function(){var y=t.find(".js-autocomplete");
y.autocomplete({appendTo:x,source:c.crm.app_url+"?module=autocomplete&type=user",minLength:0,html:!0,focus:function(){return!1},select:function(z,B){m.setContact(B.item);h(!1);y.val("");return!1}}).data("ui-autocomplete")._renderItem=function(z,B){return c("<li />").addClass("ui-menu-item-html").append("<div>"+B.value+"</div>").appendTo(z)};y.on("focus",function(){y.data("uiAutocomplete").search(y.val())})})();m.setContact=function(y){var z=t.find(".js-user");y.photo_url&&z.find(".icon.size-24").css("background-image",
"url("+y.photo_url+")");z.find(".c-name").text(y.name);w.val(y.id)}}function h(t){t?($wrapperContact.addClass("is-shown"),$wrapperContact.find(".js-autocomplete").focus()):$wrapperContact.removeClass("is-shown")}function n(){var t=q.find(".c-deal-wrapper"),w=q.find('[name="data[deal_id]"]'),x=q.find('[name="data[contact_id]"]'),y=t.find(".c-search-contact-wrapper"),z=t.find(".c-deal-item"),B=t.find(".js-autocomplete-deal");B.autocomplete({appendTo:y,position:{my:"right top",at:"right bottom"},source:c.crm.app_url+
"?module=autocompleteSidebar",minLength:0,html:!0,focus:function(){return!1},select:function(C,A){C=A.item;A='<a class="flexbox middle c-user" href="javascript:void(0);">\n                '+(C.photo_url?'<span class="icon size-18 rounded js-open-search" style="background-image: url('+C.photo_url+');"></span>':"")+'\n                <span class="c-user-name">&nbsp;'+C.name+'</span>\n                </a>\n                <div class="hint custom-pl-12 js-open-search cursor-pointer">\n                    <span class="icon size-14"><i class="fas fa-pen" title="[`edit`]"></i></span>\n                </div>';
y.addClass("is-hidden").removeClass("is-shown");z.html(A);C.photo_url?(x.val(C.id),w.val("")):(w.val(C.id),x.val(""));B.val("");y.find(".ui-autocomplete").hide();return!1}}).data("ui-autocomplete")._renderItem=function(C,A){return c("<li />").addClass("ui-menu-item-html").append("<div>"+A.value+"</div>").appendTo(C)};t.on("click",function(C){C=c(C.target);y.is(":visible")?C.closest(".js-reset-deal").length&&m.clearDeal():C.closest(".js-open-search").length&&(y.addClass("is-shown"),B.focus())});m.clearDeal=
function(){z.html("");y.removeClass("is-hidden is-shown");x.val("");w.val("")}}var m=this,p=m.$wrapper.find("#c-add-reminder-form"),q=p.find("form"),r=p.find(".js-textarea"),u=p.find(".c-hidden-form");$plus_icon=p.find(".c-icon-column");$wrapperContact=p.find(".js-contact-wrapper");extended_class="is-extended";is_locked=wrapper_is_open=!1;has_errors=is_first_click=!0;var v=q.serialize();r.on("focus",function(){m.$wrapper.find(".c-completed-reminders-section").hasClass("is-shown")||(u.slideDown(300),
p.addClass(extended_class),wrapper_is_open=!0,is_first_click&&(k($wrapperContact),n(),is_first_click=!1),c(document).on("click",b))});r.on("input",l);r.on("keydown",function(t){var w=t.keyCode;wrapper_is_open&&13===w&&!t.shiftKey&&(t.preventDefault(),t.stopPropagation(),a()?d():q.trigger("submit"))});$plus_icon.on("click",function(){wrapper_is_open?a()?d():q.trigger("submit"):r.focus()});p.on("click",".js-save",function(t){t.preventDefault();a()?d():q.trigger("submit")});p.on("click",".js-cancel",
function(t){t.preventDefault();e()});c(document).on("keydown",function(t){t.stopPropagation();if(!m.$wrapper.find(".c-completed-reminders-section").hasClass("is-shown")){var w=c(t.target),x=t.keyCode,y=27===x;13!==x||wrapper_is_open||(w=w.hasClass("c-text-field"),c(".c-step.is-edit.is-shown").length||w||(t.preventDefault(),r.focus()));y&&(t.preventDefault(),t.stopPropagation(),e(),c(".c-reminder-wrapper").trigger("escKeyPress"))}});(function(t){var w=t.find(".js-reminder-type-toggle"),x=w.find(".js-type-field"),
y=w.find(".menu");w.waDropdown();y.on("click","a",function(){var z=c(this);w.find(".js-text").html(z.html());y.find(".selected").removeClass("selected");z.closest("li").addClass("selected");z=z.data("type-id");x.val(z)})})(p);(function(){p.find(".js-datepicker").each(function(){var t=c(this);t.datepicker({changeMonth:!0,changeYear:!0,showOtherMonths:!0,selectOtherMonths:!0,gotoCurrent:!0});var w=t.parent(),x=w.find(".calendar");m.$date_clear=w.find(".js-reset-date");x.on("click",function(){t.focus()});
t.on("change",function(){this.style.width=0<this.value.length?7*this.value.length+"px":8*(this.getAttribute("placeholder").length+1)+"px";""!==t.val()&&w.addClass("is-active")});m.$date_clear.on("click",function(){t.val("");t.trigger("change");w.removeClass("is-active")})})})();(function(){function t(y){y?w.addClass("is-active"):w.removeClass("is-active")}var w=p.find(".js-time-toggle"),x=w.find(".js-timepicker");m.$time_clear=w.find(".js-reset-time");x.on("change",function(){t(!0);""==x.val()&&t()});
w.on("click",".js-show-time",function(){x.focus()});m.$time_clear.on("click",function(){x.val("");t()})})();(function(){p.find(".js-timepicker").each(function(){c(this).timepicker()})})();q.on("submit",function(t,w){t.preventDefault();is_locked||(is_locked=!0,t=f(),data=t.data,a()||(t.errors.length?(g(t.errors),is_locked=!1):($plus_icon.addClass("loading"),$plus_icon.html('<span class="icon size-20"><i class="fas fa-spinner fa-spin"></i></span>'),q.find(".js-save").attr("disabled",!0),c.post("?module=reminder&action=add",
data,function(x){"ok"===x.status?w||(m.$iframe?null:c.crm.sidebar.reload(),c.crm.content.reload()):console.error(x.errors)},"json").always(function(){is_locked=!1}))))})};CRMReminders.prototype.initLazyLoading=function(){function a(){function e(){var h=c.contains(document,$loader[0]);h?f($loader):($loader=$list.find(".js-lazy-load"),(h=c.contains(document,$loader[0]))?f($loader):k.off("scroll",e))}function f(h){var n=c(window).scrollTop(),m=l.height(),p=h.offset().top;n+m>=p&&(d||g(h))}function g(h){var n=
c.crm.app_url+"?module=reminder&action=actual"+((0<b.setting_deal_id?"&deal="+b.setting_deal_id:"")+(0<b.setting_contact_id?"&contact="+b.setting_contact_id:"")+(b.$iframe?"&iframe=1":""));data={user_id:b.user_id,page:++b.current_page};d=!0;c.post(n,data,function(m){b.click_reminder_event||(h&&h.remove(),$list.append(m),a())}).always(function(){d=!1})}var l=c(window),k=l;$list=b.$wrapper.find("#c-main-reminders-list");$loader=$list.find(".js-lazy-load");if($loader.length)if(0<l.height())if(1==b.current_page&&
l.height()>$list.height())e();else k.on("scroll",e);else setTimeout(function(){return a()},100)}var b=this,d=!1;a()};CRMReminders.prototype.initCompletedReminders=function(){function a(){var t=n.width();l.width(t)}function b(){var t="?module=reminder&action=completed"+((0<g.setting_deal_id?"&deal="+g.setting_deal_id:"")+(0<g.setting_contact_id?"&contact="+g.setting_contact_id:"")),w={user_id:g.user_id};v=!0;m.append(q);p.hide();c.post(t,w,function(x){r=!0;k.html(x);f();m.children().last().remove();
p.show();c(window).trigger("scroll");d(!0)}).always(function(){v=!1})}function d(t,w){u?(setTimeout(function(){h.hide();n.css("overflow","unset");g.$iframe||n.css("max-height","unset")},300),c(document).off("click",e)):(n.css("overflow","hidden"),g.$iframe||n.css("max-height","calc(100vh - 4rem)"),h.show(),c(document).on("click",e));w?(l.toggleClass("is-shown"),u=!u,k.slideToggle(300)):t?(l.addClass("is-shown"),u=!0,k.slideDown(300)):(l.removeClass("is-shown"),u=!1,k.slideUp(300))}function e(t){t.preventDefault();
(is_target=c.contains(l[0],t.target))||d(!1)}function f(){function t(){if(c.contains(document,x[0])){if(u){var z=x,B=k.scrollTop(),C=k.height(),A=z.offset().top;list_top=k.offset().top;B+C>=A-list_top&&(y||w(z))}}else k.off("scroll",t)}function w(z){var B="?module=reminder&action=completed"+((0<g.setting_deal_id?"&deal="+g.setting_deal_id:"")+(0<g.setting_contact_id?"&contact="+g.setting_contact_id:"")),C={user_id:g.user_id,min_dt:k.find("> li[data-datetime]:last").data("datetime")};y=!0;c.post(B,
C,function(A){z.remove();k.append(A);f()}).always(function(){y=!1})}c(window);var x=k.find(".js-lazy-load"),y=!1;if(x.length)k.on("scroll",t)}var g=this,l=g.$completedSection,k=l.find(".c-reminders-list"),h=g.$wrapper.find(".drawer"),n=g.$wrapper.find(".article-body"),m=l.find(".c-actions"),p=m.find(".sort-down"),q=c("<span/>").addClass("icon size-16").append("<i/>").addClass("fas fa-spinner wa-animation-spin speed-1000 text-gray"),r=!1,u=!1,v=!1;g.$iframe||(a(),c(window).on("resize",function(){a()}));
c(document).on("is_completed_loaded_false",function(t,w){r=!1;w.new_text&&l.find(".js-completed-reminders-btn-text").text(w.new_text);l.hasClass("hidden")&&l.removeClass("hidden");t=w.state;var x=g.$sidebar.find("[data-id='"+w.user_id+"'] .details");w=g.$sidebar.find("[data-id='all'] .details");var y=x.find(".count.all"),z=w.find(".count.all");y.text(y.text()-1);z.text(z.text()-1);if("overdue"==t||"burn"==t)y=x.find(".count.overdue"),x=x.find(".count.burn"),y.length?(x=y.data("due-count"),z=+y.text(),
"overdue"==t?y.data("due-count",--x):null,y.text(--z),0>=x&&y.removeClass("overdue").addClass("burn"),0>=z&&y.remove()):x.length&&(y=+x.text(),x.text(--y),0>=y&&x.remove()),y=w.find(".count.overdue"),w=w.find(".count.burn"),y.length?(w=y.data("due-count"),x=+y.text(),"overdue"==t?y.data("due-count",--w):null,y.text(--x),0>=w&&y.removeClass("overdue").addClass("burn"),0>=x&&y.remove()):w.length&&(t=+w.text(),w.text(--t),0>=t&&w.remove())});l.on("click",".js-load-completed-reminders",function(t){t.preventDefault();
r?d(!1,!0):v||b()})};CRMReminders.prototype.initReopenReminder=function(){function a(e){if(!d){d=!0;var f={id:e};c.post("?module=reminder&action=markAsUndone",f,function(g){"ok"==g.status&&(f.id?c.crm.content.load(c.crm.app_url+"reminder/"+(b.user_id?b.user_id:"all")+"/?highlight_id="+f.id+(b.$iframe?"&iframe=1":"")+((0<b.setting_deal_id?"&deal="+b.setting_deal_id:"")+(0<b.setting_contact_id?"&contact="+b.setting_contact_id:"")),!1):c.crm.content.reload())}).always(function(){d=!1})}}var b=this,d=
!1;b.$wrapper.on("click",".js-reopen-reminder",function(e){e.preventDefault();e=c(this);var f=e.closest(".c-reminder-wrapper");e.addClass("is-loading");e.html('<span class="icon size-20"><i class="fas fa-spinner fa-spin"></i></span>');a(f.data("id"))})};CRMReminders.prototype.initTarget=function(){var a=this,b=c(window);if(!a.$iframe){var d=localStorage.getItem("scrollpos");d&&a.$sidebar.scrollTop(d)}c(document).ready(function(){a.$wrapper.find(".skeleton-wrapper").hide();setTimeout(function(){var e=
a.$wrapper.find(".c-reminder-wrapper.highlighted");if(e.length){var f=e.offset().top;target_h=e.height();viewportHeight=b.height();scrollIt=f-(viewportHeight-target_h)/2;c("html, body").animate({scrollTop:scrollIt+"px"},300)}},100);setTimeout(function(){var e=a.$wrapper.find(".c-reminder-wrapper.is-target");e.length&&(e=e.offset().top,b.scrollTop(e-50))},100)})};return CRMReminders}(jQuery),CRMReminder=function(c){CRMReminder=function(a){this.$wrapper=a.$wrapper;this.$marker=this.$wrapper.find(".c-marker");
this.marker_html=this.$marker.html();this.$steps=this.$wrapper.find(".c-step");this.$view=this.$steps.filter(".is-view");this.$edit=this.$steps.filter(".is-edit");this.$confirm=this.$steps.filter(".is-confirm");this.$textarea=this.$edit.find("textarea");this.$dots_button=this.$wrapper.find(".js-dots-wrapper");this.$dots_detail=this.$wrapper.find(".c-dots-detail");this.$main_wrapper=this.$wrapper.closest(".article-body");this.id=a.id;this.$iframe=a.iframe;this.current_page=a.current_page;this.user_id=
a.user_id;this.reminder_user_id=a.reminder_user_id;this.shown_class="is-shown";this.setting_contact_id=a.setting_contact_id;this.setting_deal_id=a.setting_deal_id;this.state=a.state;this.$activeContent=this.$view;this.xhr=!1;this.initClass();this.setPadding()};CRMReminder.prototype.initClass=function(){function a(d){d?b.$confirm.addClass("is-shown"):b.$confirm.removeClass("is-shown")}var b=this;b.$wrapper.on("click",function(d){d.preventDefault();b.$main_wrapper.find(".c-completed-reminders-section").hasClass("is-shown")||
(d=c(d.target),d.closest(".c-deal-wrapper a").length||(d.closest(".js-mark-done").length?b.setDone():d.closest(".js-confirm-delete").length?b.remove():d.closest(".js-remove").length?(a(!0),b.$dots_detail.hide()):(d.closest(".js-edit").length&&b.$dots_detail.hide(),d.closest(".js-confirm-cancel").length?a(!1):d.closest(".js-dots-wrapper").length?b.initDotsDetail():b.$edit.is(":visible")||(b.toggleContent(b.$edit),d.closest(".js-float-text").length&&b.$edit.find(".js-textarea").focus()))))});b.$wrapper.on("reminderIsChanged",
function(){b.toggleContent(b.$view);b.id?(c.crm.content.load(c.crm.app_url+"reminder/"+(b.user_id?b.user_id:"all")+"/?highlight_id="+b.id+(b.$iframe?"&iframe=1":"")+((0<b.setting_deal_id?"&deal="+b.setting_deal_id:"")+(0<b.setting_contact_id?"&contact="+b.setting_contact_id:"")),!0).done(function(){c(".c-reminders-list-loader").hide()}),c(document).off("is_completed_loaded_false"),c(window).off("resize")):c.crm.content.reload().done(function(){c(".c-reminders-list-loader").hide()})});b.$wrapper.on("reminderNotChanged",
function(){b.toggleContent(b.$view)});b.$wrapper.on("updatePadding",function(){b.setPadding(!0)})};CRMReminder.prototype.setPadding=function(a){var b=this.$wrapper;$quick_content=b.find(".js-quick-content-toggle-wrapper");0===$quick_content.height()||0===b.find(".c-footer").height()?$quick_content.css("padding-bottom","0"):a?$quick_content.css("padding-bottom","0.5rem"):null};CRMReminder.prototype.setDone=function(){var a=this,b=a.$wrapper,d=c(this);b.css("display","none");d.addClass("is-done");d=
a.id;href="?module=reminder&action=markAsDone"+((0<a.setting_deal_id?"&deal="+a.setting_deal_id:"")+(0<a.setting_contact_id?"&contact="+a.setting_contact_id:""));data={id:d,user_id:a.user_id?a.user_id:"all"};is_locked=!0;c.post(href,data,function(e){if("ok"===e.status){var f;e=null==e?void 0:null==(f=e.data)?void 0:f.completed_title;b.remove();a.$iframe||c.crm.sidebar.reload();c(document).trigger("is_completed_loaded_false",{user_id:a.reminder_user_id,state:a.state,new_text:e});c(window).trigger("scroll")}else b.css("display",
"")}).always(function(){is_locked=!1})};CRMReminder.prototype.initDotsDetail=function(){function a(e){var f=c(e.target);e=!!f.closest(".c-dots-detail").length;f=!!f.closest(".js-dots-wrapper").length;e||f||b.$dots_detail.hide()}var b=this;b.$dots_detail.toggle();var d=b.$dots_detail.height();(function(e){e=e.getBoundingClientRect();return window.innerHeight-e.bottom})(b.$dots_button[0])<d+30?b.$dots_detail.css("bottom","38px"):b.$dots_detail.css("bottom","-"+(d+8)+"px");if(b.$dots_detail.is(":visible"))c(document).on("click",
a);else c(document).off("click",a)};CRMReminder.prototype.remove=function(){var a=this,b={id:a.id};a.xhr&&a.xhr.abort();a.xhr=c.post("?module=reminder&action=delete",b,function(d){"ok"===d.status&&(a.$wrapper.remove(),c.crm.content.reload(),a.$iframe?null:c.crm.sidebar.reload())}).always(function(){a.xhr=!1})};CRMReminder.prototype.toggleContent=function(a){this.$activeContent.length&&this.$activeContent.removeClass(this.shown_class);a.addClass(this.shown_class);this.$activeContent=a;a.focus();this.$edit===
a?this.$wrapper.trigger("editOpen").addClass("editOpen"):this.$wrapper.removeClass("editOpen")};return CRMReminder}(jQuery),CRMCompletedReminder=function(c){CRMCompletedReminder=function(a){this.$wrapper=a.$wrapper;this.$marker=this.$wrapper.find(".c-marker");this.marker_html=this.$marker.html();this.reminder_id=a.reminder_id;this.initClass()};CRMCompletedReminder.prototype.initClass=function(){this.initQuickContentEdit()};CRMCompletedReminder.prototype.initQuickContentEdit=function(){function a(){if(!k){k=
!0;d.renderLoading(!0);var h=f.serializeArray();c.post("?module=reminder&action=save",h,function(n){"ok"===n.status&&(l=!1,g.removeClass("is-changed").blur())}).always(function(){k=!1;d.renderLoading(!1)})}}function b(){g.css("min-height",0);g.css("min-height",g[0].scrollHeight+"px")}var d=this,e=d.$wrapper.find(".js-top-content-toggle-wrapper");0===e.height()&&e.css("padding-bottom","0");if(!e.length)return!1;var f=e.find("form"),g=f.find(".js-textarea"),l=!1,k=!1;g.on("keyup",function(h){g.val().length?
l||(l=!0):l=!1});g.on("input",b);g.on("keydown",function(h){13!==h.keyCode||h.shiftKey||(h.preventDefault(),l&&a())});g.on("blur",function(){l&&a()});setTimeout(function(){g.length&&b()},300)};CRMCompletedReminder.prototype.renderLoading=function(a){var b=this.$marker;a?(b.addClass("is-load"),b.html('<i class="fas fa-spinner fa-spin"></i>')):(b.removeClass("is-load"),b.html(this.marker_html))};return CRMCompletedReminder}(jQuery),CRMReminderSettingsDialog=function(c){CRMReminderSettingsDialog=function(a){this.$wrapper=
a.$wrapper;this.$form=this.$wrapper.find("form");this.$button=this.$wrapper.find(".js-submit-button");this.$options=this.$wrapper.find(".js-options-list");this.$groups=this.$wrapper.find(".js-group-list");this.$select=this.$wrapper.find(".js-select-list");this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMReminderSettingsDialog.prototype.initClass=function(){var a=this;a.$form.on("change","input",function(){a.toggleButton(!0)});a.$options.on("change","input",function(){var b=c(this),d=
b.val();"checked"===b.attr("checked")&&("groups"===d?a.$groups.show():a.$groups.hide());a.dialog.resize()});a.$form.on("change",".daily-recap",function(){var b=c(this)["0"].checked,d=a.$select,e=c(".crm-reminders-recap-error");b?(d.attr("disabled",!1),e.length&&(c(e).fadeIn(),a.dialog.resize())):(d.attr("disabled",!0),e.length&&(c(e).fadeOut(),a.dialog.resize()))});a.$form.on("change",".js-pop-up-disabled",function(){var b=c(this),d=a.$wrapper.find(".js-pop-up-min");b.is(":checked")?(d.prop("readonly",
!1),d.focus()):d.prop("readonly",!0)});a.initSave()};CRMReminderSettingsDialog.prototype.initSave=function(){function a(){e||(e=!0,c(".js-submit-button").prop("disabled",!0),c.post("?module=reminder&action=settingsSave",d.serializeArray(),function(g){"ok"===g.status&&("my"==b.$options.find(":checked").val()?c.crm.content.load(c.crm.app_url+"reminder/"):setTimeout(function(){b.dialog.close();c.crm.content.reload()},1E3))},"json").always(function(){b.toggleButton(!1);e=!1}))}var b=this,d=b.$form,e=
!1,f=b.$wrapper.find(".js-pop-up-disabled");c(".js-submit-button").on("click",function(){f.is(":checked")?0<parseInt(c(".js-pop-up-min").val())?a():c(".enter-minutes").fadeIn().delay("2000").fadeOut():a()})};CRMReminderSettingsDialog.prototype.toggleButton=function(a){var b=this.$button;a?b.addClass("yellow"):b.removeClass("yellow")};return CRMReminderSettingsDialog}(jQuery),CRMReminderSettings=function(c){CRMReminderSettings=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".js-submit-button");
this.$options=this.$wrapper.find(".js-options-list");this.$groups=this.$wrapper.find(".js-group-list");this.$select=this.$wrapper.find(".js-select-list");this.$wrapper.data("instance",this);this.initClass()};CRMReminderSettings.prototype.initClass=function(){var a=this;a.$options.on("change","input",function(){var b=c(this),d=b.val();"checked"===b.attr("checked")&&("groups"===d?a.$groups.show():a.$groups.hide())});a.$wrapper.on("change",".daily-recap",function(){var b=c(this)["0"].checked,d=a.$select,
e=c(".crm-reminders-recap-error");b?(d.attr("disabled",!1),e.length&&c(e).fadeIn()):(d.attr("disabled",!0),e.length&&c(e).fadeOut())});a.$wrapper.on("change",".js-pop-up-disabled",function(){var b=c(this),d=a.$wrapper.find(".js-pop-up-min");b.is(":checked")?(d.prop("readonly",!1),d.focus()):d.prop("readonly",!0)})};CRMReminderSettings.prototype.validateBeforeSave=function(){return this.$wrapper.find(".js-pop-up-disabled").is(":checked")&&0>=parseInt(c(".js-pop-up-min").val())?(c(".enter-minutes").fadeIn().delay("2000").fadeOut(),
!1):!0};return CRMReminderSettings}(jQuery);var CRMLogLive=function(c){var a=function(d){a=function(e){this.list_name=e.names.list;this.items_name=e.names.items;this.pagind_name=e.names.paging;this.log=e.log;this.$wrapper=e.$wrapper||!1;this.$list=this.$wrapper.find(this.list_name);this.$window=d(window);this.onLoad=e.onLoad||function(){};this.$paging=this.$wrapper.find(this.pagind_name);this.is_locked=this.xhr=!1;this.addWatcher()};a.prototype.addWatcher=function(){function e(){var l=window&&d.contains(document,f.$paging[0]);l&&g&&window.frameElement&&
(l=d.contains(g.document,window.frameElement));if(l)f.onScroll();else f.$window.off("scroll",e),d(g).off("scroll",e)}var f=this,g=window.parent;f.$window.on("scroll",e);if(g&&window.frameElement)d(g).on("scroll",e)};a.prototype.onScroll=function(){var e=this.$window,f=e.scrollTop();e=e.height();var g=this.$paging.offset().top;if(window.parent&&window.frameElement){var l=d(window.parent);e=l.height();f+=l.scrollTop();g+=d(window.frameElement).offset().top}f+e>=g&&!this.is_locked&&(this.is_locked=!0,
this.loadNextPage())};a.prototype.loadNextPage=function(){var e=this,f=e.log.filtersData.slice(0);f.push({name:"max_id",value:e.$paging.data("max-id")});f.push({name:"timestamp",value:e.$list.find(e.items_name).last().data("timestamp")});e.xhr&&e.xhr.abort();e.xhr=d.get("?module=logLive",f,function(g){var l=d("<div id='c-temp-wrapper' />");e.log.$wrapper.after(l);l.html(g);g=l.find(e.list_name+" "+e.items_name);l=l.find(e.pagind_name);e.$list.append(g);e.$paging.after(l);e.$paging.remove();e.$paging=
l;e.is_locked=!1;e.onLoad()})};return a}(jQuery),b=function(d){function e(k,h){var n=k.offsetWidth;k=k.offsetHeight;return{outer_width:n,outer_height:k,inner_width:n-h.left-h.right,inner_height:k-h.top-h.bottom}}function f(k){function h(t){var w=t.split("-");t=parseInt(w[0]);var x=parseInt(w[1])-1;w=parseInt(w[2]);return new Date(t,x,w)}var n=[];k=function(t){function w(x,y){var z=x.split("-");x=parseInt(z[0]);var B=parseInt(z[1])-1;z=parseInt(z[2]);B=new Date((new Date(x,B,z)).getTime()+(y?864E5:
-864E5));y=parseInt(B.getFullYear());x=parseInt(B.getMonth())+1;B=parseInt(B.getDate());10>B&&(B="0"+B);10>x&&(x="0"+x);return[y,x,B].join("-")}1===t[0].data.length&&d.each(t,function(x){var y=t[x].data[0],z={value:0,date:w(y.date,!1)},B={value:0,date:w(y.date,!0)};t[x].data=[z,y,B]});return t}(k);for(var m=0;m<k.length;m++){for(var p=k[m].data,q=[],r=0;r<p.length;r++){var u=p[r],v=parseInt(u.value);q.push({date:h(u.date),value:v})}n.push(q)}return d3.layout.stack().offset("zero").values(function(t){return t}).x(function(t){return t.date}).y(function(t){return t.value})(n)}
function g(k,h,n){var m=null;n+=1;k&&n&&(m=(k-h*(n-1))/n,1>m&&(m=1));return m}function l(k,h){var n=h[0];h=h[1]||1;n=h-n+(1<h-n?0:1);h=n/(k-1);for(var m=[],p=0;p<k;p++){var q=10<n?Math.round(p*h):parseInt(p*h*10)/10;m.push(q)}return m}b=function(k){this.$wrapper=k.$wrapper;this.$hint=this.$wrapper.find(".js-hint-wrapper");this.node=this.$wrapper.find(".js-chart-wrapper")[0];this.d3node=d3.select(this.node);this.show_class="is-shown";this.charts=k.data;this.data=f(this.charts);this.group_by=k.group_by;
this.locales=k.locales;this.margin={top:14,right:10,bottom:28,left:34};this.area=e(this.node,this.margin);this.column_indent=200<this.data[0].length?2:4;this.column_width=g(this.area.inner_width,this.column_indent,this.data[0].length);this.yAxis=this.xAxis=this.yDomain=this.xDomain=this.y=this.x=this.defs=this.svg=!1;this.initGraph()};b.prototype.initGraph=function(){var k=this,h=k.area;k.initGraphCore();200<k.data[0].length&&k.$wrapper.addClass("is-large");k.svg=k.d3node.append("svg").attr("width",
h.outer_width).attr("height",h.outer_height);k.renderBackground();k.renderCharts();k.renderAxis();setTimeout(function(){function n(){d.contains(document,k.$wrapper[0])?k.update():d(window).off("resize",n)}d(window).on("resize",n)},4)};b.prototype.initGraphCore=function(){var k=this.data,h=this.area,n=this.x=d3.time.scale().range([0,h.inner_width]);h=this.y=d3.scale.linear().range([h.inner_height,0]);this.yDomain=function(){var m=d3.min(k,function(q){return d3.min(q,function(r){return r.value})});
0<m&&(m=0);var p=d3.max(k,function(q){return d3.max(q,function(r){return r.value+r.y0})});return[m,p]}();this.xDomain=function(){var m=k[0][0].date;var p=k[0][k[0].length-1].date;var q=parseInt((k[0][1].date.getTime()-m.getTime())/2);m=new Date(m.getTime()-q);p=new Date(p.getTime()+q);return[m,p]}();n.domain(this.xDomain);h.domain(this.yDomain)};b.prototype.renderAxis=function(){var k=this.x,h=this.y,n=this.svg;this.xAxis=d3.svg.axis().scale(k).orient("bottom").ticks(10);this.yAxis=d3.svg.axis().scale(h).innerTickSize(2).orient("right").tickValues(l(6,
this.yDomain)).tickFormat(function(m){return m+""});k=n.append("g").attr("class","axis");k.append("g").attr("transform","translate(10,"+this.margin.top+")").attr("class","y").call(this.yAxis);k.append("g").attr("class","x").attr("transform","translate("+this.margin.left+","+(this.area.outer_height-this.margin.bottom)+")").call(this.xAxis)};b.prototype.renderBackground=function(){var k=this.area.inner_width,h=this.area.inner_height,n,m=this.svg.append("g").attr("class","background").attr("transform",
"translate("+this.margin.left+","+this.margin.top+")");m.append("rect").attr("width",k).attr("height",h);for(n=0;5>=n;n++){var p=1+(h-2)/5*n;m.append("line").attr("x1",1).attr("x2",k).attr("y1",p).attr("y2",p)}};b.prototype.renderCharts=function(){var k=this,h=k.data;h=k.svg.selectAll(".c-graph-wrapper").data(h);h.enter().append("g").attr("class","c-graph-wrapper").attr("transform","translate("+k.margin.left+","+k.margin.top+")");var n=h.selectAll(".rect").data(function(m){return m});n.enter().append("rect").attr("class",
"rect").style("fill",function(m,p,q){return(m=k.charts[q].color)?m:!1}).on("mouseover",function(m,p,q){k.showHint(d3.event,this,m,k.charts[q])}).on("mousemove",function(){k.moveHint(this)}).on("mouseout",function(){k.hideHint()});n.transition().duration(1E3).attr("x",function(m,p){return k.x(m.date)-k.column_width/2}).attr("y",function(m){return k.y(m.y0)+k.y(m.value)-k.area.inner_height}).attr("height",function(m){return k.area.inner_height-k.y(m.value)}).attr("width",k.column_width);n.exit().remove();
h.exit().remove()};b.prototype.update=function(k){if(!k)return!1;this.data=f(k.chart);this.group_by=k.group_by||"days";this.area=e(this.node,this.margin);this.column_indent=200<this.data[0].length?2:4;this.column_width=g(this.area.inner_width,this.column_indent,this.data[0].length);this.svg.attr("width",this.area.outer_width).attr("height",this.area.outer_height);200<this.data[0].length?this.$wrapper.addClass("is-large"):this.$wrapper.removeClass("is-large");this.initGraphCore();this.yAxis.scale(this.y).tickValues(l(6,
this.yDomain));this.svg.selectAll(".axis .y").transition().duration(600).call(this.yAxis);this.xAxis.scale(this.x);this.svg.selectAll(".axis .x").transition().duration(600).call(this.xAxis);this.renderCharts()};b.prototype.showHint=function(k,h,n,m){var p=this;k=d(h);if(!(0<Math.ceil(k.attr("height"))))return!1;var q=n.date;h=p.$hint.find(".c-date");var r=p.$hint.find(".c-app"),u=p.$hint.find(".c-value");q=function(v,t){var w=parseInt(v.getMonth());"months"==t?(v=p.locales.months,v[w]||(v="\u042f\u043d\u0432\u0430\u0440\u044c \u0424\u0435\u0432\u0440\u0430\u043b\u044c \u041c\u0430\u0440\u0442 \u0410\u043f\u0440\u0435\u043b\u044c \u041c\u0430\u0439 \u0418\u044e\u043d\u044c \u0418\u044e\u043b\u044c \u0410\u0432\u0433\u0443\u0441\u0442 \u0421\u0435\u043d\u0442\u044f\u0431\u0440\u044c \u041e\u043a\u0442\u044f\u0431\u0440\u044c \u041d\u043e\u044f\u0431\u0440\u044c \u0414\u0435\u043a\u0430\u0431\u0440\u044c".split(" ")),
w=v[w]):(t=v.getDate(),w+=1,w=(10>t?"0"+t:t)+"."+(10>w?"0"+w:w)+"."+v.getFullYear());return w}(q,p.group_by);h.text(q);r.text(m.name);u.text(n.value);n=function(v){var t=d(window),w=t.width();t.height();t=p.$hint.outerWidth();var x=p.$hint.outerHeight(),y=Math.ceil(v.attr("width")),z=Math.ceil(v.attr("height")),B=p.$wrapper.offset();v=v.offset();x={left:v.left-B.left+y+10,top:v.top-B.top+(z<x?z-x-2:2)};w<v.left+10+t&&(x.left=v.left-B.left-y-t);return x}(k);p.$hint.css(n).addClass(p.show_class)};b.prototype.moveHint=
function(){};b.prototype.hideHint=function(){this.$hint.removeAttr("style").removeClass(this.show_class)};return b}(jQuery);CRMLogLive=function(d){this.$wrapper=d.$wrapper;this.$filtersForm=this.$wrapper.find("form.js-filters-form");this.chartData=d.chartData;this.chartParams=d.chartParams;this.locales=d.locales;this.chart=!1;this.filtersData=this.$filtersForm.serializeArray();this.initClass()};CRMLogLive.prototype.initClass=function(){this.initLogList();this.initDateFilter();this.initChart()};CRMLogLive.prototype.initLogList=
function(){function d(){e.find(".c-activity-item.is-first").each(function(){var f=c(this).prev().prev();f.hasClass("is-last")||f.addClass("is-last")})}var e=this.$wrapper.find("#c-activity-section");d();new a({$wrapper:e,names:{list:".c-activity-list",items:"> li",paging:".c-paging-wrapper"},log:this,onLoad:d})};CRMLogLive.prototype.initDateFilter=function(){function d(u){var v=u.data("timeframe"),t=u.data("group")||"days";m.html(u.find("a").html());r.length&&r.removeClass("selected");r=u.addClass("selected");
k.hide();setTimeout(function(){k.removeAttr("style")},200);n.val(v);h.val(t);"custom"!==v?(p.removeClass("is-shown"),e()):p.addClass("is-shown")}function e(){var u=l.serializeArray();u.push({name:"chart",value:1});c.post("?module=logLive",u,function(v){"ok"==v.status&&(v=v.data,v.group_by=h.val(),f.chart.update(v))},"json").always(function(){q=!1})}var f=this,g=f.$wrapper.find(".js-dates-filter"),l=g.find("form"),k=g.find(".js-list"),h=g.find(".js-group-field"),n=g.find(".js-timeframe-field"),m=g.find(".js-link-text"),
p=g.find(".js-hidden-part"),q=!1,r=k.find(".selected");k.on("click",".js-toggle",function(u){u.preventDefault();d(c(this))});l.on("submit",function(u){u.preventDefault();q||(q=!0,e())});(function(){g.find(".js-datepicker").each(function(){var u=c(this),v=g.find("."+u.data("selector"));u.datepicker({altField:v,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0})})})()};CRMLogLive.prototype.initChart=function(){var d=this.$wrapper.find(".js-chart-section");d.length&&this.chartData&&this.chartData.length&&
(this.chart=new b({$wrapper:d,data:this.chartData,group_by:this.chartParams.group_by,locales:this.locales}))};return CRMLogLive}(jQuery),CRMLogLiveItem=function(c){CRMLogLiveItem=function(a){this.$wrapper=a.$wrapper;this.initClass()};CRMLogLiveItem.prototype.initClass=function(){c.crm.renderSVG(this.$wrapper);this.$wrapper.data("logLiveItem",this)};return CRMLogLiveItem}(jQuery);var CRMCallPage=function(c){CRMCallPage=function(a){this.$wrapper=a.$wrapper;this.call_ts=a.call_ts;this.locales=a.locales;this.iframe=a.iframe;this.is_lazy_load=a.is_lazy_load;this.current_page=a.current_page;this.numbers_assigned=a.numbers_assigned;this.started_contact=a.contact;this.started_deal=a.deal;this.href_prop="";this.initClass()};CRMCallPage.prototype.initClass=function(){c.wa_push&&c.wa_push.init();this.initRedirectCall();this.initDeleteCall();this.numbers_assigned&&c.wa_push&&c.wa_push.init();
this.initAssociateDeal();this.initBackgroundReload();this.initFinishCallLinks();this.initLazyLoading();this.initCustomAudioPlayer();this.initDotsDetail();this.iframe||this.is_lazy_load||this.initFilterDrawer();this.initContactUpdateDialog();this.initContactCreateDialog()};CRMCallPage.prototype.initContactCreateDialog=function(){function a(d){c.waDialog({html:'<div class="dialog" id="call-create-contact-dialog">\n                <div class="dialog-background"></div>\n                <div class="dialog-body" style="width: 761px">\n                    \n                    <div class="dialog-content" style="padding: 0;">\n                        <iframe src="'+
(c.crm.app_url+"frame/contact-new/?phone="+d)+'" frameborder="0" style="height: 94vh; width: 100%;">\n                        </iframe>\n                    </div>\n                </div>\n                </div>',onOpen:function(e,f){e.find(".dialog-body").css("top","2.5%");e.find(".dialog-content").css("min-height","95vh")}})}var b=this;b.escapeHtml=function(d){return d.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")};b.$wrapper.on("click",
".js-show-create-dialog",function(d){d.preventDefault();d=b.escapeHtml(""+c(d.target).data("number"));a(d)})};CRMCallPage.prototype.initContactUpdateDialog=function(){function a(d){b||(b=!0,c.post(c.crm.app_url+"?module=contact&action=updateDialog",{call_id:d},function(e){c.waDialog({html:e})}).always(function(){b=!1}))}var b=!1;this.$wrapper.on("click",".js-show-update-dialog",function(d){d.preventDefault();d=c(d.target).data("id");a(d)})};CRMCallPage.prototype.initFilterDrawer=function(){function a(){p.show();
c("#wa-app").addClass("content-on-top");setTimeout(function(){p.removeClass("is-hide");B?null:c("body").addClass("is-locked").css("padding-right","17px")},50)}function b(){p.addClass("is-hide");setTimeout(function(){p.hide();c("body").removeClass("is-locked").css("padding-right","");c("#wa-app").removeClass("content-on-top")},300)}function d(A){A=void 0===A?!1:A;var D=q.serializeArray();D.forEach(function(G,H){if(""!==G.value&&"null"!==G.value){if(4===H&&"custom"===G.value){var I=p.find(".js-datepicker");
""===I.eq(0).val()&&(D[5].value="");""===I.eq(1).val()&&(D[6].value="")}h.href_prop=h.href_prop+(0==H?"":"&")+G.name+"="+G.value}});c.crm.content.load(c.crm.app_url+"call/?"+h.href_prop);var E=c("<span/>").addClass("icon size-20").append("<i/>").addClass("fas fa-spinner wa-animation-spin speed-1000 ");if(A)n.prop("disabled",!0).append(E);else{var F=p.find(".c-filter-buttom");F.append(E);F.children().each(function(){c(this).prop("disabled",!0)});c(document).one("wa_loaded",function(){E.remove();F.children().each(function(){c(this).prop("disabled",
!1)});b()})}}function e(A){var D=p.find("#dropdown-directions-filter [data-filter='"+A[0].value+"']"),E=p.find("#dropdown-states-filter [data-filter='"+A[1].value+"']"),F=p.find("#dropdown-responsible-filter [data-filter='"+A[7].value+"']"),G=p.find("#dropdown-date-filter [data-timeframe='"+A[4].value+"']"),H=q.serializeArray(),I=p.find(".js-datepicker"),K=p.find("#switch-deal-off");D.trigger("click");E.trigger("click");F.trigger("click");""===A[2].value?g():f(h.started_contact,A[2].value,w,r);""===
A[3].value||"0"===A[3].value?k():l(h.started_deal,A[3].value);A[3].value===H[3].value||"0"!==H[3].value&&"0"!==A[3].value||K.trigger("click");I.eq(0).datepicker("setDate",new Date(A[5].value));I.eq(1).datepicker("setDate",new Date(A[6].value));G.trigger("click")}function f(A,D,E,F){var G=A.name;A='<div class="c-user-wrapper">\n                    <div class="flexbox space-8">\n                        <div class="c-column c-column-image">\n                            <div class="flexbox middle">\n                                <img src="'+
A.userpic+'" alt="'+G+'">\n                            </div>\n                        </div>\n                    <div class="c-column nowrap">\n                            <div class="c-column--name">'+G+'</div>\n                            <div class="c-jobtitle hint">'+(F.val()&&A.email?A.email:"")+'</div>\n                            <div class="c-jobtitle hint">'+(F.val()&&A.phone?A.phone:"")+'</div>\n                    </div>\n                    </div>\n                </div>\n                <span class="icon cursor-pointer js-call-filter-contact-cancel"><i class="fas fa-times-circle"></i></span>';
p.find("#input-contact").val(D);F.val()?F.val(""):null;E.html(A);F.hide()}function g(){r.show();w.html("");p.find("#input-contact").val("")}function l(A,D){var E=h.escapeHtml(A.name);A='\n                <div class="c-deal-wrapper nowrap">\n                <div class="flexbox space-8 ">\n                    <i class="fas fa-circle" style="color: '+(A.stage?A.stage.color:"")+'"></i>\n                </div>\n                <div>\n                    <div class="c-deal-wrapper--name">'+E+'</div>\n                    <div>\n                        <span class="hint">'+
(A.create_datetime?A.create_datetime.split(" ")[0]:"")+"</span>\n                        "+(A.closed_datetime?"<span> - </span>":"")+'\n                        <span class="hint">'+(A.closed_datetime?A.closed_datetime.split(" ")[0]:"")+'</span>\n                    </div>\n                    <div class="hint">'+(A.amount?Math.ceil(+A.amount):"")+" "+A.currency_id+'</div>   \n                </div>\n            </div>\n                <span class="icon js-call-filter-deal-cancel"><i class="fas fa-times-circle"></i></span>';
p.find("#input-deal").val(D);v.val("");x.html(A);v.hide()}function k(){v.show();x.html("");p.find("#input-deal").val("")}var h=this,n=h.$wrapper.find(".js-filter-button"),m=h.$wrapper.find(".js-reload-filter-button"),p=h.$wrapper.find(".c-call-filter"),q=p.find(".c-call-filter-form"),r=p.find(".js-search-field-contact"),u=r.parent(),v=p.find(".js-search-field-deal"),t=v.parent(),w=p.find(".js-call-filter-contact"),x=p.find(".js-call-filter-deal"),y=q.serializeArray(),z=q.serialize(),B=h.$wrapper.height()<
c(".content.blank.c-shadowed-content").height(),C=[{name:"direction",value:"all"},{name:"status",value:"ALL"},{name:"contact",value:""},{name:"deal",value:""},{name:"timeframe",value:"null"},{name:"start",value:""},{name:"end",value:""},{name:"user",value:""}];n.on("click",function(A){A.preventDefault();a()});m.on("click",function(A){A.preventDefault();m.find("svg").removeClass("fa-times").addClass("fa-spinner fa-spin");c.crm.content.load(c.crm.app_url+"call/?direction=all&status=ALL")});p.on("click",
".js-close-drawer",function(A){A.preventDefault();b()});p.on("click",".js-apply-filter",function(A){A.preventDefault();d()});p.on("click",".js-reset-filter",function(A){A.preventDefault();"direction=all&status=ALL&timeframe=null&deal=&contact=&start=&end="!==q.serialize()&&e(C)});p.on("click",".js-restore-filter",function(A){A.preventDefault();z!==q.serialize()&&e(y);b()});p.on("click",".js-call-filter-contact-cancel",function(A){A.preventDefault();g()});p.on("click",".js-call-filter-deal-cancel",
function(A){A.preventDefault();k()});(function(){var A=h.$wrapper.find(".js-search-field-client"),D=A.parent();$search_contact_wrapper=h.$wrapper.find(".js-call-filter-search");$search_contact_cancel=h.$wrapper.find(".c-call-filter-contact .js-call-filter-contact-cancel");A.autocomplete({appendTo:D,source:c.crm.app_url+"?module=autocompleteContact&with_email=1&with_phone=1",minLength:0,html:!0,focus:function(){return!1},select:function(E,F){f(F.item,F.item.id,$search_contact_wrapper,D);d(!0);return!1}}).data("ui-autocomplete")._renderItem=
function(E,F){return c("<li />").addClass("ui-menu-item-html").append("<div><span class='icon userpic custom-mr-4'><i style='background-image: url("+F.userpic+");'></i></span>"+F.name+"</div>").appendTo(E)};$search_contact_cancel.on("click",function(E){E.preventDefault();D.show();$search_contact_wrapper.html("")})})();r.autocomplete({appendTo:u,source:c.crm.app_url+"?module=autocompleteContact&with_email=1&with_phone=1",minLength:0,html:!0,focus:function(){return!1},select:function(A,D){f(D.item,
D.item.id,w,r);return!1}}).data("ui-autocomplete")._renderItem=function(A,D){return c("<li />").addClass("ui-menu-item-html").append("<div class='flexbox'><span class='icon userpic custom-mr-4'><i style='background-image: url("+D.userpic+");'></i></span>"+D.name+"</div>").appendTo(A)};v.autocomplete({appendTo:t,source:c.crm.app_url+"?module=autocompleteDeal",minLength:0,html:!0,focus:function(){return!1},select:function(A,D){l(D.item,D.item.id);return!1}}).data("ui-autocomplete")._renderItem=function(A,
D){return c("<li />").addClass("ui-menu-item-html").append("<div>"+h.escapeHtml(D.name)+"</div>").appendTo(A)};(function(){p.find(".js-datepicker").each(function(){var A=c(this),D=p.find("."+A.data("selector"));A.datepicker({altField:D,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0})})})()};CRMCallPage.prototype.initDownloadLink=function(){$records_array=this.$wrapper.find(".c-call-wrapper .c-call-record-link");setTimeout(function(){$records_array.eq(0).trigger("click")},2E3)};CRMCallPage.prototype.initCustomAudioPlayer=
function(){var a=null;this.$wrapper.on("click",".c-call-record-link",function(b,d){var e=c(this);play=e.find(".play").length||null;loading=e.find(".loading").length||null;pause=e.find(".pause").length||null;$call_wrapper=e.closest(".c-call-wrapper");$call_id=$call_wrapper.data("id");$column_audio=$call_wrapper.find(".c-column-audio");$progressbar_new=$call_wrapper.find("#c-audio-slider");$progressbar_item=$progressbar_new[0];$duration=$call_wrapper.find(".c-audio-duration");$current_time=$call_wrapper.find(".c-audio-current-time");
var f=null,g=function(k){var h=Math.floor(k%60);return Math.floor(k/60)+":"+(10>h?"0"+h:""+h)};if(loading||pause){var l=function(k){clearTimeout(a);clearInterval(id);var h=k[0];$column_audio.slideDown(200);$duration.text(g(h.duration));$progressbar_item.max=Math.floor(h.duration);$progressbar_new.on("input",function(m){$current_time.text(g($progressbar_item.value));m=m.target;$column_audio[0].style.setProperty("--seek-before-width",m.value/m.max*100+"%");cancelAnimationFrame(f)});$progressbar_new.on("input",
function(){h.currentTime=$progressbar_item.value;requestAnimationFrame(n)});var n=function(){$progressbar_item.value=Math.floor(h.currentTime);$current_time.text(g($progressbar_item.value));$column_audio[0].style.setProperty("--seek-before-width",$progressbar_item.value/$progressbar_item.max*100+"%");f=requestAnimationFrame(n);h.currentTime==h.duration&&(cancelAnimationFrame(f),a=setTimeout(function(){return $column_audio.slideUp(200)},3E3))};k=function(){var m=Math.floor(h.buffered.end(h.buffered.length-
1));$column_audio[0].style.setProperty("--buffered-width",m/$progressbar_item.max*100+"%")};h.addEventListener("progress",k);k();requestAnimationFrame(n)};id=setInterval(function(){var k=e.find("audio");k.length&&0<k[0].readyState&&l(k)},50)}play&&(a=setTimeout(function(){return $column_audio.slideUp(200)},3E3),$progressbar_new.off("change"),$progressbar_new.off("input"),cancelAnimationFrame(f))})};CRMCallPage.prototype.initDotsDetail=function(){var a=this;a.$wrapper.on("click",".js-dots",function(b){$detail=
c(this).siblings(".c-dots-detail");$detail_wrapper=$detail.closest(".js-dots-wrapper");$detail.toggle();$detail_wrapper.toggleClass("open");var d=$detail.height();b=$detail.width();var e=$detail_wrapper[0].getBoundingClientRect();window.innerHeight-e.bottom<d+30?$detail.css("bottom","30px"):$detail.css("bottom","unset");d=$detail_wrapper[0].getBoundingClientRect();window.innerWidth-d.left>b+30?$detail.css("left","0"):$detail.css("right","0")});c(document).on("click",function(b){var d=c(b.target),
e=a.$wrapper.find(".js-dots-wrapper.open");d=!!d.closest(".c-dots-detail").length;e.length&&!d&&e.each(function(){c.contains(c(this)[0],b.target)||(c(this).removeClass("open"),c(this).find(".c-dots-detail").hide())})})};CRMCallPage.prototype.initFinishCallLinks=function(){this.$wrapper.on("click",".js-finish-call",function(a){var b=c(this);a=c.crm.app_url+"?module=call&action=finish";var d=b.closest(".c-call-wrapper"),e=d.data("id");0>=e||b.data("loading")||(b.data("loading",1),b.find(".loading").show(),
b.find(".yes-bw").hide(),c.post(a,{id:e},function(f){if("ok"===f.status){f=c("<div>").html(f.data.html);var g=f.find('.c-call-wrapper[data-id="'+e+'"]').find(".c-column-state");d.find(".c-column-state").replaceWith(g);f.remove()}else b.data("loading",0),b.find(".loading").hide(),b.find(".yes-bw").show()}).error(function(){b.data("loading",0);b.find(".loading").hide();b.find(".yes-bw").show()}))})};CRMCallPage.prototype.initRedirectCall=function(){this.$wrapper.on("click",".js-redirect-call",function(a){a=
c(this).parents(".c-call-wrapper").data("id");a=c.crm.app_url+"?module=call&action=redirectDialog&id="+a;var b=c(this);b.prop("disabled",!0).find(".svg-inline--fa").removeClass("fa-exchange-alt").addClass("fa-spinner fa-spin");c.get(a,function(d){c.waDialog({html:d,onOpen:function(){b.prop("disabled",!1).find(".svg-inline--fa").removeClass("fa-spinner fa-spin").addClass("fa-exchange-alt")}})})})};CRMCallPage.prototype.initDeleteCall=function(){function a(e){var f=e.find(".c-delete-call"),g=f.closest(".c-call-wrapper"),
l=g.data("id");e=f.data("title");c.waDialog.confirm({title:'<i class="fas fa-exclamation-triangle smaller state-error"></i> '+e+"?",text:b.locales.delete_confirm_text,success_button_title:b.locales.delete_confirm_button,success_button_class:"danger custom-mr-4",cancel_button_title:""+b.locales.delete_cancel_button,cancel_button_class:"light-gray",onSuccess:function(){if(!d){d=!0;var k={id:l},h=f.find(".delete");h.removeClass("delete").addClass("loading");c.post("?module=call&action=delete",k,function(n){"ok"===
n.status&&g.remove()}).always(function(){h.removeClass("loading").addClass("delete");d=!1})}}})}var b=this,d=!1;b.$wrapper.on("click",".js-delete-call",function(e){e.preventDefault();a(c(this))})};CRMCallPage.prototype.initAssociateDeal=function(){this.$wrapper.on("click",".js-associate-deal",function(a){a=c(this).data("dialog-url");var b=c(this);b.prop("disabled",!0);c.get(a,function(d){c.waDialog({html:d,onOpen:function(e,f){b.prop("disabled",!1)}})})})};CRMCallPage.prototype.initBackgroundReload=
function(){function a(){clearTimeout(f);f=setTimeout(b,1E4)}function b(){var g=!1,l=d.$wrapper.find("audio");c.each(l,function(k,h){c(h)[0].ended||(g=!0)});if(g)return a(),!1;e||(e=!0,c.post("?module=call&action=ts&background_process=1",{call_ts:d.call_ts},function(k){"ok"==k.status&&c.contains(document,d.$wrapper[0])&&(k.data!==d.call_ts?c.crm.content.reload():a())}).always(function(){e=!1}))}var d=this,e=!1,f=0;a()};CRMCallPage.prototype.initLazyLoading=function(){function a(){function e(){if(c.contains(document,
k[0])){var h=k,n=c(window).scrollTop(),m=g.height(),p=h.offset().top;n+m>=p&&(d||f(h))}else g.off("scroll",e)}function f(h){var n=window.location.href.split("/crm/call/")[1];n=c.crm.app_url+"?module=call"+(n?"&"+n.slice(1):"");data={lazy:1,page:++b.current_page};d=!0;console.log(n);c.post(n,data,function(m){m=c(m).find("#js-calls-table").html();l.append(m);c(document).trigger("wa_loaded");h&&h.remove();a()}).always(function(){d=!1})}var g=c(window),l=b.$wrapper.find("#js-calls-table"),k=b.$wrapper.find(".js-lazy-load");
if(k.length)g.on("scroll",e)}var b=this,d=!1;a()};return CRMCallPage}(jQuery);var CRMCallAssociateDealDialog=function(c){CRMCallAssociateDealDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$footer=this.$wrapper.find(".js-dialog-footer");this.$submit=this.$form.find(".js-submit");this.$deal_name=this.$form.find(".js-deal-name");this.$deal_funnel=this.$form.find(".js-select-deal-funnel");this.$deal_stage=this.$form.find(".js-select-deal-stage");this.$deal_id=this.$form.find(".js-deal-id");this.initClass()};CRMCallAssociateDealDialog.prototype.initClass=
function(){this.initSelectDeal();this.initSubmit()};CRMCallAssociateDealDialog.prototype.initSelectDeal=function(){var a=this,b=a.$form.find(".js-select-deal .js-visible-link"),d=a.$form.find(".js-select-funnel"),e=a.$form.find(".js-deals-list"),f=a.$form.find(".js-deal-name-field");a.$form.on("click",".js-create-new-deal",function(){a.$submit.addClass("yellow").removeAttr("disabled");var g=c(this).find(".js-text").html();a.deal_selected=!0;d.removeClass("hidden");f.removeClass("hidden");a.$deal_name.focus();
b.html(g);a.$deal_id.val("0")});a.$form.on("click",".js-deal-item",function(){a.$submit.addClass("yellow").removeAttr("disabled");var g=c(this).find(".js-text").html();a.deal_selected=!0;e.find("li").removeClass("selected");c(this).parent().addClass("selected");b.html(g);d.addClass("hidden");f.addClass("hidden");a.$deal_name.val("");a.$deal_id.val(c(this).data("deal-id"))});a.$form.on("change",".js-select-deal-funnel",function(){a.$form.find(".js-select-stage-wrapper").load("?module=deal&action=stagesByFunnel&id="+
c(this).val())})};CRMCallAssociateDealDialog.prototype.initSubmit=function(){function a(){var e=c('<span class="icon size-16 loading"><i class="fas fa-spinner fa-spin"></i></span>'),f=c.crm.app_url+"?module=call&action=associateDealSave",g=b.$form.serializeArray();b.$submit.prop("disabled",!0);b.$footer.append(e);c.post(f,g,function(l){"ok"===l.status?(c.crm.content.reload(),c(".dialog.c-call-associate-deal").data("dialog").close()):(b.$submit.prop("disabled",!1),e.remove())})}var b=this,d=b.$wrapper.find(".js-deal-value");
b.$form.on("submit",function(e){e.preventDefault();if(!b.$deal_id.val())return d.addClass("shake animated").focus(),setTimeout(function(){d.removeClass("shake animated").focus()},500),!1;if(0==b.$deal_id.val()&&!c.trim(b.$deal_name.val()))return b.$deal_name.addClass("shake animated").focus(),setTimeout(function(){b.$deal_name.removeClass("shake animated").focus()},500),!1;a()})};return CRMCallAssociateDealDialog}(jQuery);var CRMCallInitContactDialog=function(c){CRMCallInitContactDialog=function(a){this.$wrapper=a.$wrapper;this.$footer=this.$wrapper.find(".js-dialog-footer");this.$form=this.$wrapper.find("form");this.$call_button=this.$form.find(".js-init-call");this.$content=this.$form.find(".js-content");this.$numbers_list=this.$form.find(".js-numbers-list");this.$plugin_id=this.$form.find(".js-plugin-id");this.dialog=this.$wrapper.data("dialog");this.call_id=0;this.call_ready=a.call_ready;this.locales=a.locales;
this.iframe=a.iframe;this.initClass()};CRMCallInitContactDialog.prototype.initClass=function(){"ready"===this.call_ready?this.initCall():(this.selectExtensionNumber(),this.submit());if(this.iframe)this.$wrapper.on("click",".js-close-dialog",function(a){a.preventDefault();c(".dialog iframe",window.parent.document)[0].dispatchEvent(new Event("close"))})};CRMCallInitContactDialog.prototype.selectExtensionNumber=function(){var a=this;a.$form.on("click",".js-number-item",function(){var b=c(this).data("plugin-id");
a.$plugin_id.val(c.crm.escape(b));a.$call_button.prop("disabled",!1)})};CRMCallInitContactDialog.prototype.submit=function(){var a=this;a.$form.on("submit",function(b){b.preventDefault();if(!a.$plugin_id.val())return a.$numbers_list.addClass("shake animated"),setTimeout(function(){a.$numbers_list.removeClass("shake animated")},500),!1;a.initCall()})};CRMCallInitContactDialog.prototype.initCall=function(){var a=this,b=c('<span class="icon size-16 loading"><i class="fas fa-spinner fa-spin"></i></span>'),
d=c.crm.app_url+"?module=call&action=initNew",e=a.$form.serializeArray();a.$call_button.prop("disabled",!0);a.$footer.append(b);c.post(d,e).done(function(f){"ok"===f.status?(a.call_id=f.data.call_id,a.callChecker()):console.error(f)}).fail(function(){a.iframe?c(".dialog iframe",window.parent.document)[0].dispatchEvent(new Event("close")):a.dialog.close()}).always(function(){a.$call_button.prop("disabled",!1);b.remove()})};CRMCallInitContactDialog.prototype.callChecker=function(){function a(){c.post(c.crm.app_url+
"?module=call&action=checkStatus",{id:d},function(h){try{h.errors&&(clearInterval(k),b.$content.html(l),setTimeout(function(){b.iframe?c(".dialog iframe",window.parent.document)[0].dispatchEvent(new Event("close")):(b.dialog.close(),c.crm.content.reload())},3E3),console.log(h.errors.message)),"PENDING"===h.data.status_id?b.$content.html(f):"CONNECTED"===h.data.status_id?b.$content.html(g):(b.$content.html(l),clearInterval(k),setTimeout(function(){b.iframe?c(".dialog iframe",window.parent.document)[0].dispatchEvent(new Event("close")):
(b.dialog.close(),c.crm.content.reload())},3E3))}catch(n){clearInterval(k),console.log("Error while updating call status"),console.log(n)}})}var b=this,d=b.call_id,e='<input class="button js-close-dialog" type="submit" value="'+b.locales.Close+'">',f='<div class="c-call-pending">'+b.locales.call_pending+'<span class="icon size-16 loading custom-pl-8"><i class="fas fa-spinner fa-spin"></i></span></div>',g='<div style="color: #00ff00;">'+b.locales.call_connected+"</div>",l='<div style="color: #5159c3;">'+
b.locales.call_finished+"</div>";b.$content.html(f);b.$footer.html(e);a();var k=setInterval(a,2E3)};return CRMCallInitContactDialog}(jQuery);var CRMCallRedirectDialog=function(c){CRMCallRedirectDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$button=this.$form.find(".js-submit");this.$autocomplete=this.$form.find(".js-autocomplete");this.$other_radio=this.$form.find(".js-other-candidate");this.$number=this.$form.find(".js-number");this.initClass()};CRMCallRedirectDialog.prototype.initClass=function(){this.initAutocomplete();this.initSelectCandidate();this.initSubmit()};CRMCallRedirectDialog.prototype.initAutocomplete=
function(){var a=this,b=a.$form.find(".js-candidate"),d=b.find(".js-delete-candidate");a.$autocomplete.autocomplete({source:c.crm.app_url+"?module=autocomplete&type=user&phonecomplete=true",appendTo:a.$autocomplete.parent(),minLength:0,focus:function(){return!1},select:function(e,f){a.$number.val(f.item.phone);b.find(".js-label").html(f.item.label);a.$autocomplete.css("display","none");b.removeClass("hidden");return!1}}).data("ui-autocomplete")._renderItem=function(e,f){return c('<li class="ui-menu-item-html"><div>'+
f.value+"</div></li>").appendTo(e)};a.$autocomplete.on("focus",function(){c(this).data("uiAutocomplete").search(c(this).val())});d.on("click",function(){a.$number.val("");b.addClass("hidden");a.$autocomplete.val("").removeAttr("style").focus()})};CRMCallRedirectDialog.prototype.initSelectCandidate=function(){var a=this,b=a.$form.find(".js-other-lbl"),d=a.$form.find(".js-candidate"),e=a.$form.find(".js-number-type");a.$form.on("change",":radio[name='redirect[to]']",function(){a.$other_radio.prop("checked")?
(e.val("external"),a.$number.val(""),a.$autocomplete.removeAttr("style").focus(),b.css("display","none")):(e.val("interior"),a.$number.val(c(this).val()),a.$autocomplete.css("display","none"),d.addClass("hidden"),a.$autocomplete.val(""),b.removeAttr("style"));a.$button.prop("disabled",!1)})};CRMCallRedirectDialog.prototype.initSubmit=function(){var a=this,b=a.$form.find(".js-field-name");a.$form.on("submit",function(d){d.preventDefault();var e=a.$wrapper.find(".js-call-id").val(),f=a.$number.val();
c.trim(f)||(f=c.trim(a.$autocomplete.val()));if(!c.trim(f))return b.addClass("shake animated"),setTimeout(function(){b.removeClass("shake animated")},500),!1;(function(){var g=a.$form.find(".js-number-type").val(),l=a.$wrapper.find(".js-dialog-footer"),k=c('<span class="icon size-16 loading"><i class="fas fa-spinner fa-spin"></i></span>');a.$button.prop("disabled",!0);l.append(k);c.post(c.crm.app_url+"?module=call&action=redirect",{call_id:e,number_type:g,number:f},function(h){"ok"===h.status&&(l.find(".svg-inline--fa.fa-spinner").removeClass("fa-spinner fa-spin").addClass("fa-check text-green"),
a.$wrapper.hide(),setTimeout(function(){c.crm.content.reload()},2E3))})})()})};return CRMCallRedirectDialog}(jQuery);var CRMMessageDeleteLinkMixin=function(c){CRMMessageDeleteLinkMixin=function(){};CRMMessageDeleteLinkMixin.prototype.initMessageDeleteLink=function(){function a(){var d=c.crm.app_url+"?module=message&action=delete",e={id:b.message.id},f=c('<span class="icon loading"><i class="fas fa-spinner wa-animation-spin"></i></span>');f.appendTo(b.$button.parent());b.$button.attr("disabled",!0);c.post(d,e,function(g){if("ok"===g.status){c.crm.content.reload();var l,k;null==(l=c(".dialog.c-message-show-body-dialog"))||
null==(k=l.data("dialog"))||k.close()}else console.log("Error saving Responsible contact classification: "+arguments[2],arguments),l="Error saving Responsible contact classification: "+arguments[2],l=c('<div class="errormsg" />').text(l),b.$errorsPlace.append(l)},"json").always(function(){b.$button.attr("disabled",!1);f.remove()})}var b=this;b.$wrapper.find(".js-delete-message").on("click",function(){event.preventDefault();c.crm.confirm.show({title:b.locales.delete_message,text:b.locales.delete_message_text,
button:b.locales["delete"],onConfirm:a})})};CRMMessageDeleteLinkMixin.mixInFor=function(a){a.prototype=c.extend(a.prototype,CRMMessageDeleteLinkMixin.prototype);return a};return CRMMessageDeleteLinkMixin}(jQuery);(function(c){c.message=c.extend(c.message||{},{app_url:!1,is_page_loaded:!1,content:!1,sidebar:!1,locales:!1})})(jQuery);
var MessageContentRouter=function(c){MessageContentRouter=function(a){this.$content=a.$content;this.iframe=a.iframe;this.app_url=a.app_url||c&&c.crm&&c.crm.app_url;this.api_enabled=!(!window.history||!window.history.pushState);this.xhr=!1;this.initClass()};MessageContentRouter.prototype.initClass=function(){this.animate(!0)};MessageContentRouter.prototype.load=function(a,b,d,e,f){var g=this;if(!(0<=a.indexOf(c.crm.app_url)))return alert("Determine the path error"),!1;g.animate(!0);g.xhr&&g.xhr.abort();
c(document).trigger("wa_before_load",{content_uri:a});e&&c(document).trigger("change_active_id",{target_id:e});f&&f.find(".enable-animation [data-fa-i2svg]").hide().after('<i class="fas fa-spinner fa-spin"></i>');g.xhr=c.ajax({method:"GET",url:c.crm.app_url+"?module=messageConversationId&id="+d,dataType:"html",global:!1,cache:!1}).done(function(l){g.api_enabled&&!b&&history.pushState({reload:!0,content_uri:a},"",a);f&&(f.find(".enable-animation [data-fa-i2svg]:first").show(),f.find(".enable-animation [data-fa-i2svg]").slice(1).remove());
g.setContent(l);g.xhr=!1}).fail(function(l){l.responseText&&c.crm.alert.show({title:"Error",text:l.responseText,button:"Close"});f&&(f.find(".enable-animation [data-fa-i2svg]:first").show(),f.find(".enable-animation [data-fa-i2svg]").slice(1).remove())});return g.xhr};MessageContentRouter.prototype.reload=function(a){var b=this.api_enabled&&history.state&&history.state.content_uri?history.state.content_uri:location.href;return b?this.load(b,!0,a):c.when()};MessageContentRouter.prototype.setContent=
function(a){this.$content.html(a)};MessageContentRouter.prototype.animate=function(a){var b=this;b.$content_wrapper=b.$content.find("#js-message-conversation-page");b.$skeleton=b.$content.find(".skeleton-wrapper");var d=b.$skeleton;setTimeout(function(){a?d.show():d.is(":visible")||b.iframe?d.hide():null},10)};return MessageContentRouter}(jQuery),CRMDealMessagesDialog=function(c){CRMDealMessagesDialog=function(a){this.$wrapper=a.$wrapper;this.initClass()};CRMDealMessagesDialog.prototype.initClass=
function(){this.$wrapper.on("click",".c-message-wrapper a",function(a){a.preventDefault()});this.$wrapper.on("click",".c-message-wrapper",function(a){a.preventDefault();a=c(a.target);var b=c(this);a.attr("href")||(a=b.find(".js-message-show-body"),a.length&&a.trigger("click"))})};return CRMDealMessagesDialog}(jQuery),CRMMessageBodyDialog=function(c){CRMMessageBodyDialog=function(a){this.$wrapper=a.$wrapper;this.is_admin=a.is_admin;this.app_url=a.app_url;this.dialog=this.$wrapper.data("dialog")||!1;
this.$button=this.$wrapper.find(".js-close-dialog");this.contact_id=a.contact_id;this.message=a.message||{};this.locales=a.locales;this.initClass()};CRMMessageBodyDialog.prototype.initClass=function(){this.initMessageShowBodyLink();this.is_admin&&(this.initSelectDeal(),this.initMessageDeleteLink())};CRMMessageBodyDialog.prototype.initSelectDeal=function(){function a(){m.html(""+d.locales.deal_empty);u.val("none");g.val("");f.addClass("c-deal-name-hidden");l.addClass("hidden").removeAttr("title");
n.addClass("c-empty-deal-hidden");p.addClass("hidden");r.find("li").removeClass("selected");k.removeClass("hidden")}function b(){var t=d.$wrapper.find(".js-created-deal"),w=q.find(".js-visible-link .js-text .funnel-state").clone(),x=c.trim(g.val()),y=e.serializeObject();y.message_id=d.message.id;if("none"===u.val())return e.addClass("shake animated"),setTimeout(function(){e.removeClass("shake animated")},500),!1;if(0>=u.val()&&!x)return f.addClass("shake animated"),setTimeout(function(){f.removeClass("shake animated");
g.focus()},500),!1;e.addClass("deal-form-hidden");t.removeClass("hidden");0>=u.val()?(t.html(w),t.append(c.crm.escape(x))):(x=k.find(".js-visible-link .js-text"),w=x.find(".funnel-state").clone(),x=x.find("b i").text(),t.html(w),t.append(c.crm.escape(x)));c.post(c.crm.app_url+"?module=message&action=associateDealSave",y,function(z){if("ok"===z.status&&z.data.deal_url){var B=t.html();t.html('<a href="'+z.data.deal_url+'">'+B+"</a>")}else t.html(""),t.addClass("hidden"),a(),e.removeClass("deal-form-hidden")})}
var d=this,e=d.$wrapper.find(".deal-form"),f=e.find(".js-deal-name"),g=e.find(".js-deal-name-input"),l=e.find(".js-save-deal"),k=e.find(".js-deals-dropdown"),h=e.find(".js-remove-deal"),n=k.find(".js-empty-deal"),m=e.find(".js-select-deal .js-visible-link .js-text"),p=e.find(".js-select-funnel-wrapper"),q=e.find(".js-select-stage-wrapper"),r=e.find(".js-deals-list"),u=e.find(".js-deal-id"),v=d.contact_id;u.val("none");v&&c.get("?module=deal&action=byContact&id="+v,function(t){"ok"===t.status&&c.each(t.data.deals,
function(w,x){r.prepend('<li><a href="javascript:void(0);" class="js-deal-item" data-deal-id="'+x.id+'"><i class="fas fa-circle funnel-state" style="color: '+t.data.funnels[x.funnel_id].stages[x.stage_id].color+'"></i><span class="js-text">'+x.name+"</span></a></li>")})},"json");e.on("click",".js-create-new-deal",function(){u.val("0");k.addClass("hidden");f.removeClass("c-deal-name-hidden");l.attr("title",d.locales.deal_create).removeClass("hidden");p.removeClass("hidden");n.removeClass("c-empty-deal-hidden");
g.focus()});e.on("click",".js-deal-item",function(){var t=c(this).find(".js-text").html();m.html(t);u.val(c(this).data("deal-id"));l.attr("title",d.locales.deal_add).removeClass("hidden");p.addClass("hidden");n.removeClass("c-empty-deal-hidden");r.find("li").removeClass("selected");c(this).parent().addClass("selected")});r.on("click",function(){r.hide();setTimeout(function(){r.removeAttr("style")},200)});n.on("click",function(){a()});h.on("click",function(){a()});l.on("click",function(t){t.preventDefault();
e.trigger("submit")});e.on("submit",function(t){t.preventDefault();b()});e.on("change",".js-select-deal-funnel",function(){e.find(".js-select-stage-wrapper").load("?module=deal&action=stagesByFunnel&id="+c(this).val())})};CRMMessageBodyDialog.prototype.initMessageShowBodyLink=function(){var a=this.dialog,b=this.$wrapper;this.initMessageReplyBtn(b,a);this.initMessageForwardBtn(b,a);b.on("click","a",function(d){"javascript:void(0);"!==c(this).prop("href")&&a.close()})};CRMMessageBodyDialog.prototype.initMessageReplyBtn=
function(a,b){var d=this;a.on("click",".js-message-reply",function(){function e(l){var k=f.find(".icon");if(!k.length)return!1;l?k.removeClass("fa-undo").addClass("fa-spinner fa-spin"):k.removeClass("fa-spinner fa-spin").addClass("fa-undo")}var f=c(this),g=f.data("message-id");e(!0);c.post(d.app_url+"?module=message&action=writeReplyDialog",{id:g},function(l){c.waDialog({html:l,onClose:function(){}})}).always(function(){e(!1)})})};CRMMessageBodyDialog.prototype.initMessageForwardBtn=function(a,b){var d=
this;a.on("click",".js-message-forward",function(){function e(l){var k=f.find(".icon");if(!k.length)return!1;l?k.removeClass("fa-redo").addClass("fa-spinner fa-spin"):k.removeClass("fa-spinner fa-spin").addClass("fa-redo")}var f=c(this),g=f.data("message-id");e(!0);c.post(d.app_url+"?module=message&action=writeForwardDialog",{id:g},function(l){c.waDialog({html:l})}).always(function(){e(!1)})})};CRMMessageDeleteLinkMixin.mixInFor(CRMMessageBodyDialog);return CRMMessageBodyDialog}(jQuery),CRMMessagesSidebar=
function(c){CRMMessagesSidebar=function(a){this.$wrapper=a.$wrapper;this.$ui=a.$ui;this.no_messages="true"===a.empty_conversations;this.$sidebar=this.$wrapper.parent();this.$list=this.$wrapper.find(".c-messages-table-section");this.$skeleton=this.$sidebar.find(".skeleton-wrapper");this.page_of_item=a.page_of_item;this.current_page=a.current_page;this.active_id=a.active_id;this.last_message_id=a.last_message_id;this.$settings_contact_id=+a.settings_contact_id;this.$settings_deal_id=+a.settings_deal_id;
this.settings=a;this.iframe=a.iframe;this.initClass()};CRMMessagesSidebar.prototype.initClass=function(){var a=this;a.initLazyLoading();a.initSearchHandler();a.conversationListHandler();new CRMPageMessagesOperations(a.settings);a.no_messages&&a.$wrapper.closest("#c-messages-sidebar").addClass("no-messages-sidebar");a.$wrapper.on("click",".js-associate-deal",function(b){b.preventDefault();b=c(this).data("dialog-url");c.get(b,function(d){c.waDialog({html:d})})});a.$wrapper.on("click",".js-write-message",
function(b){b.preventDefault();b=c.crm.app_url+"?module=message&action=writeNewDialog";data={contact_id:a.$settings_contact_id?a.$settings_contact_id:null,deal_id:a.$settings_deal_id?a.$settings_deal_id:null};c.get(b,data,function(d){c.waDialog({html:d})})});a.$wrapper.on("click",".js-filter-open",function(){a.$wrapper.find(".c-message-filter-wrapper").toggle()});a.current_page&&a.initBackgroundUpdate()};CRMMessagesSidebar.prototype.initSearchHandler=function(){var a=this,b=a.$sidebar;a.$search_wrapper=
b.find(".js-search-wrapper");var d=a.$search_wrapper;$page_name=b.find(".js-page-name-header");$autocomplete=d.find(".js-search-field");$search_block=d.find(".state-with-inner-icon");a.iframe||($autocomplete.autocomplete({appendTo:d,source:c.crm.app_url+"?module=autocompleteContact",minLength:0,html:!0,focus:function(){return!1},select:function(e,f){c.crm.content.load(c.crm.app_url+"message/?contact="+f.item.id);a.$skeleton.show();$autocomplete.val("");return!1}}).data("ui-autocomplete")._renderItem=
function(e,f){return c("<li />").addClass("ui-menu-item-html").append("<div><span class='icon userpic custom-mr-4'><i style='background-image: url("+f.userpic+");'></i></span>"+f.name+"</div>").appendTo(e)});d.on("click",".js-search-contact-cancel",function(){a.$skeleton.show();c.crm.content.load(c.crm.app_url+"message/")});d.on("click",".js-search-mobile-show",function(e){d.find(".js-search-mobile-show").removeClass("mobile-only").hide();$page_name.removeClass("mobile-only").hide();$search_block.removeClass("desktop-and-tablet-only");
d.find(".js-search-contact-hide").show()});d.on("click",".js-search-contact-hide",function(e){d.find(".js-search-contact-hide").hide();d.find(".js-search-mobile-show").add("mobile-only").show();$page_name.addClass("mobile-only").show();$search_block.addClass("desktop-and-tablet-only")})};CRMMessagesSidebar.prototype.initBackgroundUpdate=function(){function a(){c(document).off("msg_sidebar_upd_needed");c(document).off("change_active_id")}function b(h){h=void 0===h?!1:h;clearTimeout(k);h?d():k=setTimeout(d,
12E4)}function d(){l||(l=!0,c.contains(document,f.$wrapper[0])&&c.post("?module=message&action=listByConversation",{check:1},function(h){"ok"===h.status&&(h=h.data!==g,c.contains(document,f.$wrapper[0])&&(h&&!c(".dialog-background:visible").length?e():b()))},"json").always(function(){l=!1}))}function e(){var h=c.crm.app_url+"message/"+(f.active_id?"conversation/"+f.active_id+"/":"")+"?reload=1"+(f.$settings_contact_id?"&contact="+f.$settings_contact_id:f.$settings_deal_id?"&deal="+f.$settings_deal_id:
"")+(f.iframe?"&iframe="+f.iframe:""),n={ui:f.$ui,id:+f.active_id};a();f.$wrapper.off("click");f.$search_wrapper.off("click");f.$list.off("click");clearTimeout(k);c.get(h,n,function(m){m=c(m).find("#c-messages-conversation-list").html();f.$wrapper.html(m)})}var f=this,g=f.last_message_id,l=!1,k=0;a();c(document).on("change_active_id",function(h,n){n.target_id&&(f.active_id=n.target_id)});c(document).on("msg_sidebar_upd_needed",function(){console.log("msg_sidebar_upd_needed");b(!0)});b()};CRMMessagesSidebar.prototype.conversationListHandler=
function(){function a(g){g.preventDefault();g.stopPropagation();g=c(this);var l=e.next(),k=g.prop("href"),h=g.parent().data("id"),n=b.$settings_contact_id?"&contact="+b.$settings_contact_id:b.$settings_deal_id?"&deal="+b.$settings_deal_id:"",m=b.iframe?"&view=chat":"?view=chat";target_props=h+(b.iframe?"&iframe=1&view=chat":"&view=chat")+n;c.message.content.load(k+(m+n),!1,target_props,h,g);d.find(".selected").removeClass("selected");g.parent().addClass("selected").removeClass("unread");l.is(":visible")||
(e.addClass("desktop-and-tablet-only"),l.removeClass("desktop-and-tablet-only"))}var b=this,d=b.$list,e=b.$sidebar,f=c(window);d.on("click","a",a);f.on("beforeunload",function(){d.off("click","a",a)});c(document).ready(function(){b.scrollToSelected();b.$skeleton.hide()})};CRMMessagesSidebar.prototype.scrollToSelected=function(){var a=this.$sidebar,b=this.$list.find(".js-message-wrapper.selected");if(b.length){var d=b.offset().top;target_h=b.height();viewportHeight=c(window).height();scrollIt=d-(viewportHeight-
target_h)/2;a.scrollTop(scrollIt)}};CRMMessagesSidebar.prototype.initLazyLoading=function(){function a(){function h(){if(c.contains(document,n[0])){var m=n,p=f.scrollTop(),q=f.height(),r=m.offset().top;p+q>=r&&(e||b(m))}else g.off("scroll touchmove",h)}var n=l.find(".js-lazy-load");e=!1;if(k&&k>d.current_page)b(n);else if(k&&k==d.current_page&&d.scrollToSelected(),n.length)g.on("scroll touchmove",h)}function b(h){var n=c.crm.app_url+"?module=messageListByConversation",m=d.$settings_contact_id?+d.$settings_contact_id:
void 0,p=d.$settings_deal_id?+d.$settings_deal_id:void 0;data={id:+d.active_id,page:++d.current_page,contact:m,deal:p,reload:1,iframe:d.iframe};e=!0;c.post(n,data,function(q){h&&h.remove();q=c(q).find(".c-messages-table-section").html();l.append(q);a()}).always(function(){})}var d=this,e=!1,f=c(window),g=d.$sidebar,l=d.$list,k=d.page_of_item;a()};return CRMMessagesSidebar}(jQuery);var CRMMessageConversationPage=function(c){CRMMessageConversationPage=function(a){this.$wrapper=a.$wrapper;this.locales=a.locales;this.conversation_id=a.conversation_id;this.contact_id=a.contact_id;this.filter_contact_id=a.filter_contact_id;this.filter_deal_id=a.filter_deal_id;this.funnel_id=a.funnel_id;this.last_message_id=a.last_message_id;this.check_interval=a.check_interval;this.$replySection=this.$wrapper.find(".js-reply-wrapper");this.iframe=a.iframe;this.old_message_id=a.old_message_id;this.$dropdown_name=
this.$wrapper.find("#dropdown-c-name");this.short_link=a.short_link;this.initClass()};CRMMessageConversationPage.prototype.initClass=function(){var a=this;a.$wrapper.find(".js-deal-link").length||a.initSelectDeal();a.short_link&&a.setLinkWithId();a.initDealActions();a.initChangeResponsible();a.initBackgroundActions();a.initDelete();c(document).ready(function(){function b(){0==f&&a.scroll2bottom(!1,!1)}var d=a.$wrapper[0].getElementsByTagName("img"),e=a.$wrapper[0].getElementsByTagName("video"),f=
d.length+e.length;b();for(var g=0;g<e.length;g++)3<=e[g].readyState?(f--,b()):(e[g].addEventListener("loadeddata",function(){f--;b()}),e[g].addEventListener("error",function(){f--;b()}));for(g=0;g<d.length;g++)d[g].complete?(f--,b()):(d[g].addEventListener("load",function(){f--;b()}),d[g].addEventListener("error",function(){f--;b()}))});a.initSingleMessage();a.initToggleSidebar();a.initLazyLoading();a.initBlockquotToggle();a.initScrollToBottom();c(document).on("new_message_blockquot",function(b){a.initBlockquotToggle()})};
CRMMessageConversationPage.prototype.setLinkWithId=function(){var a=window.location.href;a.slice(-8).includes("message")&&(a=a+"conversation/"+this.conversation_id+"/",history.replaceState({reload:!0,content_uri:a},"",a))};CRMMessageConversationPage.prototype.initBlockquotToggle=function(){var a=this.$wrapper.find(".c-message-body");c.each(a,function(b,d){c(d).find(".js-blockquote-toggle").length||(b=c(d).children("blockquote"),c.each(b,function(e,f){e=c('<span class="button light-gray custom-mb-4 size-14 js-blockquote-toggle"><i class="fas fa-ellipsis-h"></i></span>');
e.insertBefore(f);e.on("click",function(g){c(f).slideToggle(400)})}))})};CRMMessageConversationPage.prototype.initLazyLoading=function(){function a(){function n(){if(c.contains(document,m[0])){var p=m;0>=d.$wrapper.scrollTop()&&!e&&(d.$wrapper.off(".lazy"),b(p))}else d.$wrapper.off("scroll.lazy touchmove.lazy",n)}var m=f.find(".js-lazy-load");e=!1;2===d.current_page&&10>k?m.remove():m.length&&(d.$wrapper.on("scroll.lazy touchmove.lazy",n),d.$wrapper.one("bigWindowEvent.lazy",n))}function b(n){var m=
c.crm.app_url+"?module=messageConversationId&id="+d.conversation_id+"&old_message_id="+d.old_message_id;e=!0;c.ajax({url:m,type:"POST",dataType:"html",beforeSend:function(){l.show();h=d.$wrapper.prop("scrollHeight")},complete:function(){},data:{delay:1},success:function(p){var q=c(p).find(".js-messages-list");p=c(p).find(".js-message-wrapper");var r=p.length;if(r){var u=function(){n&&n.remove();f.prepend(g.html());g.html("");d.$wrapper.scrollTop(d.$wrapper.prop("scrollHeight")-h);h=d.$wrapper.prop("scrollHeight");
l.hide();a()};d.old_message_id=p.eq(0).data("id");10>r&&q.find(".js-lazy-load").remove();q=q.html();g.append(q);(function(){var v=g[0].getElementsByTagName("img"),t=v.length;if(0==t)u();else for(var w=0;w<v.length;w++)v[w].complete?t--:(v[w].addEventListener("load",function(){t--;0==t&&u()}),v[w].addEventListener("error",function(){t--;0==t&&u()})),0==t&&u()})()}else n&&n.remove();a()}})}var d=this,e=!1,f=d.$wrapper.find(".js-messages-list"),g=d.$wrapper.find(".c-conversation-body--blank"),l=f.find(".js-messages-list--transparent-layer"),
k=f.find(".js-message-wrapper").length,h=d.$wrapper.prop("scrollHeight");d.current_page=2;a()};CRMMessageConversationPage.prototype.initVisiblityWatcher=function(){function a(e){e?(d.addClass("is-extended").trigger("resize"),b.$wrapper.addClass("scroll-lock")):(d.removeClass("is-extended").trigger("resize"),b.$wrapper.removeClass("scroll-lock"))}var b=this,d=b.$replySection;d.on("click",".js-revert",function(){a(!1)});d.on("click",".js-message-resize",function(){a(!1)});d.on("click",".js-message-resize-open",
function(){a(!0)})};CRMMessageConversationPage.prototype.loadDealListByContact=function(a){a=a||function(){};var b=this.contact_id;0>=b||this.iframe?a({}):c.get("?module=deal&action=byContact&id="+b,"json").always(function(d){d&&"ok"===d.status?a(d.data||{}):a({})})};CRMMessageConversationPage.prototype.initSelectDeal=function(a){function b(){t.html(e.locales.deal_empty);z.val("none");n.val("");h.addClass("c-deal-name-hidden");p.addClass("hidden").removeAttr("title");v.addClass("c-empty-deal-hidden");
w.addClass("hidden");y.find("li").removeClass("selected");0<q.data("deals_count")?(q.removeClass("hidden"),r.addClass("hidden")):(q.addClass("hidden"),r.removeClass("hidden"))}function d(){var B=f.find(".js-created-deal"),C=x.find(".js-visible-link .js-text .funnel-state").clone(),A=c.trim(n.val()),D=k.serializeObject();D.conversation_id=e.conversation_id;if("none"===z.val())return k.addClass("shake animated"),setTimeout(function(){k.removeClass("shake animated")},500),!1;if(0>=z.val()&&!A)return h.addClass("shake animated"),
setTimeout(function(){h.removeClass("shake animated");n.focus()},500),!1;k.addClass("deal-form-hidden");B.removeClass("hidden");0>=z.val()?(B.html(C),B.append(c.crm.escape(A))):(A=q.find(".js-visible-link .js-text"),C=A.find(".funnel-state").clone(),A=A.find(".deal-item--name").text(),B.html(C),B.append(c.crm.escape(A)));c.post(c.crm.app_url+"?module=message&action=conversationAssociateDealSave",D,function(E){"ok"===E.status?(f.closest(".dialog").data("dialog").close(),c.crm.content.reload()):(B.html(""),
B.addClass("hidden"),b(),k.removeClass("deal-form-hidden"))})}var e=this;a=a||{};var f=a.$wrapper||e.$wrapper,g=function(B){B=B||{};var C=B.funnels||{},A=0;c.each(B.deals||{},function(D,E){D=y;var F=D.prepend;var G=C[E.funnel_id];if(!E||0>=E.id)E="";else{var H=E.id,I=E.name||"",K="",J="";G&&G.stages&&G.stages[E.stage_id]&&(K=G.stages[E.stage_id].color||"");c.isEmptyObject(G)&&(J='<span class="hint">'+e.locales.funnel_deleted+"</span>");E='<li><a href="javascript:void(0);" class="js-deal-item" data-deal-id="'+
H+'"><span class="flexbox js-text"><i class="fas fa-circle funnel-state custom-mr-4" style="color: '+K+'"></i><span class="deal-item--name" style="word-break: break-word;">'+I+"</span></span>"+J+"</a></li>"}F.call(D,E);A++});l.show();q.data("deals_count",A);0<A?(q.removeClass("hidden"),r.addClass("hidden")):(r.removeClass("hidden"),q.addClass("hidden"))},l=f.find(".js-deal-selector-control-wrapper"),k=l.find(".deal-form"),h=k.find(".js-deal-name"),n=k.find(".js-deal-name-input"),m=f.closest(".js-conversation-deal-attach-dialog").find(".js-save-button"),
p=k.find(".js-save-deal"),q=k.find(".js-deals-dropdown"),r=k.find(".js-create-new-deal-link"),u=k.find(".js-remove-deal"),v=q.find(".js-empty-deal"),t=k.find(".js-select-deal .js-visible-link .js-text"),w=k.find(".js-select-funnel-wrapper"),x=k.find(".js-select-stage-wrapper"),y=k.find(".js-deals-list"),z=k.find(".js-deal-id");z.val("none");"undefined"===typeof a.data?e.loadDealListByContact(g):g(a.data);k.on("click",".js-create-new-deal",function(){z.val("0");q.addClass("hidden");r.addClass("hidden");
h.removeClass("c-deal-name-hidden");p.attr("title",e.locales.deal_create).removeClass("hidden");w.removeClass("hidden");v.removeClass("c-empty-deal-hidden");n.focus();m.addClass("yellow")});k.on("click",".js-deal-item",function(){var B=c(this).find(".js-text").html();t.html(B);z.val(c(this).data("deal-id"));p.attr("title",e.locales.deal_add).removeClass("hidden");w.addClass("hidden");v.removeClass("c-empty-deal-hidden");y.find("li").removeClass("selected");c(this).parent().addClass("selected");m.addClass("yellow")});
y.on("click",function(){y.hide();setTimeout(function(){y.removeAttr("style")},200)});v.on("click",function(){b()});u.on("click",function(){b()});p.on("click",function(B){B.preventDefault();k.trigger("submit")});k.on("submit",function(B){B.preventDefault();d()});k.on("change",".js-select-deal-funnel",function(){k.find(".js-select-stage-wrapper").load("?module=deal&action=stagesByFunnel&id="+c(this).val())});return{submit:function(){k.trigger("submit")}}};CRMMessageConversationPage.prototype.initDealActions=
function(){function a(f,g){var l=null;f.on("click",".js-detach-deal",function(k){k.preventDefault();c.crm.confirm.show({title:b.locales.deal_detach_title,text:b.locales.deal_detach_text.replace(/%s/,g),button:b.locales.deal_detach_confirm_button,onConfirm:function(){l&&l.abort();b.loadDealListByContact(function(h){l=c.post(c.crm.app_url+"?module=messageConversationDeal&action=detach",{id:b.conversation_id}).done(function(n){n&&"ok"===n.status&&(c.crm.content.reload(),f.data("dialog").close())}).always(function(){l=
null})})}})})}var b=this,d=b.$wrapper,e=d.find(".js-conversation-deal");$deal_second=d.find("#dropdown-c-deal");e.on("click",".js-associate-deal",function(f){f.preventDefault();f=c(this).data("dialog-url");c.get(f,function(g){c.waDialog({html:g})})});e.on("click",".js-attach-other-deal",function(f){setTimeout(function(){$deal_second.find(".dropdown-toggle").trigger("click")},50)});$deal_second.on("click",".js-return-back",function(f){setTimeout(function(){b.$dropdown_name.find(".dropdown-toggle.c-name").trigger("click")},
50)});$deal_second.on("click",".js-attach-other-deal",function(f){f.preventDefault();var g=e.find(".js-deal-link").text();b.loadDealListByContact(function(l){c.get(c.crm.app_url+"?module=messageConversationDeal&action=attachDialog",{id:b.conversation_id},function(k){var h=c(k);c.waDialog({html:h,onOpen:function(){var n=h.find(".js-conversation-deal"),m=b.initSelectDeal({$wrapper:n,data:l});h.find(".js-save-button").on("click",function(){m.submit()});a(h,g)}})})})});$deal_second.on("click",".js-detach-deal",
function(f){f.preventDefault();var g=null;f=e.find(".js-deal-link--name").text();c.crm.confirm.show({title:b.locales.deal_detach_title,text:b.locales.deal_detach_text.replace(/%s/,f),button:b.locales.deal_detach_confirm_button,onConfirm:function(){g&&g.abort();b.loadDealListByContact(function(l){g=c.post(c.crm.app_url+"?module=messageConversationDeal&action=detach",{id:b.conversation_id}).done(function(k){k&&"ok"===k.status&&c.crm.content.reload()}).always(function(){g=null})})}})})};CRMMessageConversationPage.prototype.initChangeResponsible=
function(){function a(){e||(e=!0,c.post("?module=message&action=changeConversationUser",{action:"remove",id:d.conversation_id},function(h){"ok"===h.status&&(e=!1)},"json").always(function(){e=!1;c.crm.content.reload()}))}function b(h,n){function m(w){var x="?module=autocomplete&type=user";x=0<d.funnel_id?x+("&funnel_id="+d.funnel_id):x+("&contact_id="+d.contact_id);w.autocomplete({appendTo:w.parent(),source:x,minLength:0,html:!0,focus:function(){return!1},select:function(y,z){p(z.item.id);w.val("");
n.close();c.crm.content.reload();return!1}}).data("ui-autocomplete")._renderItem=function(y,z){var B=c("<li />");B.addClass("ui-menu-item-html").append("<div>"+z.value+"</div>").appendTo(y);z.rights||(B.addClass("is-locked"),B.on("click",function(C){C.preventDefault();C.stopPropagation()}));return B};w.on("focus",function(){w.data("uiAutocomplete").search(w.val())})}function p(w){e||(e=!0,c.post("?module=message&action=changeConversationUser",{action:"set",id:d.conversation_id,user_contact_id:w},
function(x){"ok"===x.status&&(x=c(x.data.html),r.html(x),v.addClass("hidden"),x=r.find(".js-owner-autocomplete"),x.length&&m(x))},"json").always(function(){e=!1}))}function q(){e||(e=!0,c.post("?module=message&action=changeConversationUser",{action:"remove",id:d.conversation_id},function(w){"ok"===w.status&&(r.html(""),v.removeClass("hidden"),e=!1)},"json").always(function(){e=!1;n.close();c.crm.content.reload()}))}h.on("click",".js-cancel",function(w){w.preventDefault();n.close()});var r=h.find(".js-responsible-wrapper"),
u=r.find(".js-owner-autocomplete"),v=h.find(".js-responsible-empty-wrapper"),t=v.find(".js-responsible-empty-autocomplete");t.length&&m(t);u.length&&m(u);v.on("click",".js-set-extended, .js-unset-extended",function(){v.toggleClass("is-extended");v.hasClass("is-extended")&&t.focus()});r.on("click",".js-show-combobox",function(){r.find(".c-conversation-member").addClass("is-edit");r.find(".js-owner-autocomplete").focus()});r.on("click",".c-conversation-member .profile",function(){n.close()});r.on("click",
".js-hide-combobox",function(){r.find(".c-conversation-member").removeClass("is-edit")});r.on("click",".js-remove-owner",function(w){w.preventDefault();w=c.trim(r.find(".c-name").html());c.crm.confirm.show({title:d.locales.remove_owner_title,text:d.locales.remove_owner_text.replace(/%s/,w),button:d.locales.remove_owner_button,onConfirm:function(){q()}})})}var d=this,e=!1,f=d.$wrapper.find(".js-conversation-contact"),g=d.$wrapper.find(".js-open-responsible-dialog"),l=d.$wrapper.find("#dropdown-c-contact");
$responsible_wrapper_dialog=d.$wrapper.find(".js-conversation-responsible-wrapper");html_content=$responsible_wrapper_dialog.html();f.on("click",".js-open-second-menu",function(h){setTimeout(function(){l.find(".dropdown-toggle").trigger("click")},50)});l.on("click",".js-return-back",function(h){setTimeout(function(){d.$dropdown_name.find(".dropdown-toggle.c-name").trigger("click")},50)});l.on("click",".js-remove-owner",function(h){h.preventDefault();h=c.trim($responsible_wrapper_dialog.find(".c-name").html());
c.crm.confirm.show({title:d.locales.remove_owner_title,text:d.locales.remove_owner_text.replace(/%s/,h),button:d.locales.remove_owner_button,onConfirm:function(){a()}})});var k='<div class="dialog dialog-conversation-responsible" id="my-dialog">\n        <div class="dialog-background"></div>\n        <div class="dialog-body">\n        <div class="dialog-header"><h3><i class="fas fa-cogs text-blue smaller"></i> '+d.locales.owner+'</h3></div>\n        <div class="dialog-content">\n        '+html_content+
'\n        </div>\n        <div class="dialog-footer">\n            <button class="button light-gray js-cancel" type="button">'+d.locales.close+"</button>\n        </div>\n        </div>";g.on("click",function(){c.waDialog({html:k,onOpen:b})})};CRMMessageConversationPage.prototype.initBackgroundActions=function(){function a(){clearTimeout(g);g=setTimeout(b,e.check_interval)}function b(){f||(f=!0,c.post("?module=message&action=conversationIdCheck",{id:e.conversation_id},function(l){"ok"===l.status&&
(+l.data!==e.last_message_id?d().then(function(k){k.length&&e.scroll2bottom(!0,!0);a()}):a())},"json").always(function(){f=!1}))}function d(){var l=c.Deferred();c.get(location.href,function(k){function h(q){function r(){q.removeClass("is-new");q.off("hover",r);u.off("unmark-new-messages",r)}var u=c(document);q.addClass("is-new");q.on("hover",r);u.on("unmark-new-messages",r);setTimeout(function(){c.contains(document,q[0])&&r()},1E4)}var n=e.last_message_id,m=e.$wrapper.find(".js-messages-list").first();
k=c(k).find(".js-messages-list .js-message-wrapper");var p=[];m.length&&(k.each(function(){var q=c(this),r=q.data("id");r>e.last_message_id&&(m.append(q),h(q),p.push({id:r,$message:q}),n=r)}),e.last_message_id=n);l.resolve(p)});return l.promise()}var e=this,f=!1,g=0;c(document).on("wa_before_load",function(){clearTimeout(g);c(document).off("wa_before_load")});a()};CRMMessageConversationPage.prototype.initDelete=function(){function a(){var e=b.filter_contact_id?"contact="+b.filter_contact_id:b.filter_deal_id?
"deal="+b.filter_deal_id:null,f=b.iframe?"?iframe=1":"";e=e?(b.iframe?"&":"?")+e:"";var g=c.crm.app_url+"message/"+f+e;c.post(c.crm.app_url+"?module=message&action=conversationIdDelete",{id:b.conversation_id},function(l){"ok"===l.status&&c.crm.content.load(g)}).always(function(){d=!1},"json")}var b=this,d=!1;b.$wrapper.on("click",".js-delete-conversation",function(e){e.preventDefault();d||c.crm.confirm.show({title:b.locales.delete_conversation_title,button:b.locales.delete_conversation_button,onConfirm:a})})};
CRMMessageConversationPage.prototype.initSendEmail=function(){var a=!1;this.$wrapper.on("click",".js-show-message-dialog",function(b){b.preventDefault();var d=c(this);b=d.data("id");d=d.data("email");!a&&b&&(a=!0,c.post("?module=message&action=writeNewDialog",{contact_id:b,email:d},function(e){c.waDialog({html:e})}).always(function(){a=!1}))})};CRMMessageConversationPage.prototype.initSingleMessage=function(){var a=!1;this.$wrapper.on("click",".js-open-detail-message",function(b){b.preventDefault();
a||(a=!0,b=c(this).data("dialog-url"),c.get(b,function(d){c.waDialog({html:d,onClose:function(){a=!1}})}))})};CRMMessageConversationPage.prototype.initScrollToBottom=function(){function a(){if(c.contains(document,e[0])){var f=d.height()-b.$wrapper.scrollTop()-b.$wrapper.height();0>=f&&e.is(":visible")?e.hide():0<f&&e.is(":hidden")&&e.show()}else b.$wrapper.off("scroll touchmove",a)}var b=this,d=b.$wrapper.find(".js-messages-list"),e=b.$wrapper.find(".js-messages-list--to-bottom-button");b.$wrapper.on("scroll touchmove",
a);e.on("click",function(){return b.scroll2bottom(!0,!0)});c(document).on("scroll_button_event",function(f,g){b.last_message_id=g;b.scroll2bottom(!0,!0)})};CRMMessageConversationPage.prototype.scroll2bottom=function(a,b){function d(){setTimeout(function(){c.contains(document,f.$wrapper[0])&&k&&e()},0)}function e(){var h=f.$wrapper.find("#js-message-conversation-page").height();0<h?(l-64<h?b?f.$wrapper.animate({scrollTop:h},500):f.$wrapper.scrollTop(h):f.$wrapper.trigger("bigWindowEvent.lazy"),c.message.content.animate(!1)):
setTimeout(function(){return e()},100)}var f=this,g=f.iframe?c(top.window):c(window),l=g.height(),k=!0;if(a)e();else if(c.crm.is_page_loaded||f.iframe)d();else g.one("scroll",function(){k=!1}).one("load",d)};CRMMessageConversationPage.prototype.initToggleSidebar=function(){var a=this.$wrapper.parent().parent(),b=this.$wrapper.find(".js-expand-sidebar");if(b.length)b.on("click",function(d){d.preventDefault();d=a.prev();if(a.is(":visible")){a.addClass("desktop-and-tablet-only");d.removeClass("desktop-and-tablet-only");
d=window.history.state;var e=d.content_uri.replace("?view=chat","");d.content_uri=e;window.history.replaceState(d,d.title,e)}})};return CRMMessageConversationPage}(jQuery),CRMMessagesProfileAdditional=function(c){CRMMessagesProfileAdditional=function(a){this.$main_wrapper=a.$wrapper;this.contact_id=a.contact_id;this.$wrapper=this.$main_wrapper.find("#c-messages-info-additional");this.initClass()};CRMMessagesProfileAdditional.prototype.initClass=function(){function a(){d.$main_wrapper.prepend('<iframe frameborder="0" src="'+
c.crm.app_url+"frame/contact/"+d.contact_id+'" style="width:100%; background-color: var(--background-color);"></iframe>');d.$main_wrapper.find("iframe").on("load",b)}function b(){var g=c(this),l=g.contents().find("#app");l.length?(new ResizeObserver(function(k){k=k[0].target.scrollHeight;g.css("height",k);300<k&&d.$wrapper.removeClass("hidden")})).observe(l[0]):setTimeout(function(){return b()},100);g.on("beforeShowModal",function(){g.addClass("height-full");d.$main_wrapper.addClass("freeze-sidebar")});
g.on("beforeCloseModal",function(){g.removeClass("height-full");d.$main_wrapper.removeClass("freeze-sidebar")})}var d=this,e=!1,f=c(window).width();if(1024<=f)a(),e=!0;else c(window).on("resize",function(){e||c(this).width()===f||(f=c(this).width(),1024<=f&&(a(),e=!0))});d.initTopInfoFields();d.initAdditionalContentLink()};CRMMessagesProfileAdditional.prototype.initTopInfoFields=function(){function a(){var g=c.crm.app_url+"?module=contact&action=tabs&id="+b.contact_id;f=!0;b.item_html={};c.get(g).done(function(l){c.each(l.data,
function(k,h){e.append('<li class="custom-mb-16 bold">\n                    <a href="javascript:void(0);" class="js-drawer-list-link js-drawer-list--'+h.app_id+' additional" data-dialog-url="'+(h.url||"")+'" data-class-name="custom" data-id="'+h.app_id+'">\n                    <span class="js-drawer-list-link--header" >'+h.title+"</span>"+(null!==h.count?'<span class="hint custom-ml-4">'+h.count+"</span>":"")+"</a></li>");b.item_html[h.app_id]=h.html});e.find(".skeleton").hide();b.$main_wrapper.animate({scrollTop:b.$main_wrapper[0].scrollHeight},
450)})}var b=this,d=b.$wrapper.find(".js-info-list"),e=b.$wrapper.find(".js-drawer-list"),f=!1;b.$wrapper.on("click",".js-info-toggle",function(g){g.preventDefault();g=c(this);f||a();g.toggleClass("is-active");d.slideToggle();g.hasClass("is-active")&&b.$main_wrapper.animate({scrollTop:b.$main_wrapper[0].scrollHeight},450)})};CRMMessagesProfileAdditional.prototype.initAdditionalContentLink=function(){function a(e,f,g){function l(){n.append("\n                    <script>\n                    (() => {\n                        setTimeout( function() {\n                            Array.from(document.getElementsByTagName('a')).forEach(l => {\n                                l.setAttribute('target', '_top');\n                            });\n                        }, 200);\n                    })();\n                    \x3c/script>")}
var k=e.contents(),h=k.find("head"),n=k.find("body");k.find("html").attr("data-theme",document.documentElement.getAttribute("data-theme")).addClass("blank");h.append('<meta charset="utf-8">\n                <link rel="icon" href="data:;base64,iVBORw0KGgo=">\n                <meta http-equiv="X-UA-Compatible" content="IE=edge">\n                <meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">\n                <link href="'+
wa_url+'wa-content/css/wa/wa-2.0.css" rel="stylesheet" type="text/css">\n                <script src="'+wa_url+'wa-content/js/jquery/jquery-3.6.0.min.js">\x3c/script>');n.addClass("blank custom-px-16");f?c.ajax({method:"GET",url:f,dataType:"html",global:!1,cache:!1}).done(function(m){n.html(m);l()}).fail(function(m){m.statusText&&n.html(m.statusText)}).always(function(){e.trigger("load")}):g?(f=b.item_html[g],n.html(f),l(),e.trigger("load"),console.log(f)):(n.html("<div>Not found</div>"),e.trigger("load"))}
var b=this,d=!1;b.$wrapper.on("click",".js-drawer-list-link",function(e){e.preventDefault();if(!d){d=!0;var f=c(this).data("dialog-url"),g=c(this).hasClass("additional"),l=c(this).data("id")||null;e=c(this).data("class-name")||"";var k=c(this).find(".js-drawer-list-link--header").text();drawer_html='<div class="drawer crm-help crm-message-additional '+e+'" id=""> <div class="drawer-background"></div> <div class="drawer-body"><header class="drawer-header"><h3>'+k+'</h3></header><a href="#" class="drawer-close js-close-drawer"><i class="fas fa-times"></i></a><div class="drawer-block"><div class="flexbox middle width-100 height-100 spinner-wrapper"><div class="spinner custom-p-16"></div></div></div></div></div>';
var h='<iframe frameborder="0" src="'+f+'" style="width:100%;  height: 100vh; background-color: var(--background-color);"></iframe>';g&&(h='<iframe frameborder="0" style="width:100%; height: 100vh; background-color: var(--background-color-blank);"></iframe>');b.drawer=c.waDrawer({html:drawer_html,direction:"right",onOpen:function(n,m){n.find(".drawer-block").append(h);var p=n.find("iframe");p.length?(p.on("load",function(){n.find(".spinner-wrapper").remove();console.log(c(p).contents());c(p).contents().on("click",
"a",function(){c(this).data("link")&&m.close()})}),p.on("beforeShowModal",function(){p.addClass("z-10")}),p.on("beforeCloseModal",function(){p.removeClass("z-10")}),g&&a(p,f,l)):n.find(".spinner-wrapper").remove()},onClose:function(){d=!1}})}})};return CRMMessagesProfileAdditional}(jQuery),CRMMessagesProfile=function(c){CRMMessagesProfile=function(a){this.$wrapper=a.$wrapper;this.photo_dialog_url=a.photo_dialog_url;this.locales=a.locales;this.icons_array={folder:'<i class="fas fa-folder"></i>',search:'<i class="fas fa-search"></i>',
user:'<i class="fas fa-user"></i>',blog:'<i class="fas fa-file-image"></i>',notebook:'<i class="fas fa-file"></i>',lock:'<i class="fas fa-lock"></i>',"lock-unlocked":'<i class="fas fa-lock-open"></i>',broom:'<i class="icon"><svg><use xlink:href="{$wa_url}wa-apps/blog/img/sprites/icons.svg?v={$wa->version()}#clean"></use></svg></i>',star:'<i class="fas fa-star"></i>',livejournal:'<i class="fas fa-pencil-alt"></i>',contact:'<i class="fas fa-users"></i>',lightning:'<i class="fas fa-bolt"></i>',"light-bulb":'<i class="fas fa-lightbulb"></i>',
pictures:'<i class="fas fa-images"></i>',reports:'<i class="fas fa-chart-bar"></i>',books:'<i class="fas fa-book"></i>',marker:'<i class="fas fa-map-marker-alt"></i>',lens:'<i class="icon"><svg><use xlink:href="{$wa_url}wa-apps/blog/img/sprites/icons.svg?v={$wa->version()}#lens"></use></svg></i>',"alarm-clock":'<i class="icon"><svg><use xlink:href="{$wa_url}wa-apps/blog/img/sprites/icons.svg?v={$wa->version()}#alarm"></use></svg></i>',"animal-monkey":'<i class="icon"><svg><use xlink:href="{$wa_url}wa-apps/blog/img/sprites/icons.svg?v={$wa->version()}#monkey"></use></svg></i>',
anchor:'<i class="fas fa-anchor"></i>',bean:'<i class="icon"><svg><use xlink:href="{$wa_url}wa-apps/blog/img/sprites/icons.svg?v={$wa->version()}#coffee-beans"></use></svg></i>',car:'<i class="fas fa-car"></i>',disk:'<i class="fas fa-save"></i>',cookie:'<i class="fas fa-cookie"></i>',burn:'<i class="fas fa-radiation-alt"></i>',clapperboard:'<i class="icon"><svg><use xlink:href="{$wa_url}wa-apps/blog/img/sprites/icons.svg?v={$wa->version()}#clapper"></use></svg></i>',bug:'<i class="fas fa-bug"></i>',
clock:'<i class="fas fa-clock"></i>',cup:'<i class="fas fa-coffee"></i>',home:'<i class="fas fa-home"></i>',fruit:'<i class="fas fa-apple-alt"></i>',luggage:'<i class="fas fa-briefcase"></i>',guitar:'<i class="fas fa-guitar"></i>',smiley:'<i class="fas fa-grin"></i>',"sport-soccer":'<i class="fas fa-futbol"></i>',target:'<i class="fas fa-bullseye"></i>',medal:'<i class="fas fa-award"></i>',phone:'<i class="fas fa-phone"></i>',store:'<i class="fas fa-store"></i>',basket:'<i class="fas fa-shopping-basket"></i>',
pencil:'<i class="fas fa-pen-alt"></i>',lifebuoy:'<i class="fas fa-life-ring "></i>',screen:'<i class="fas fa-tablet-alt"></i>',noname:'<i class="fas fa-user-friends"></i>'};this.contact_id=a.contact_id||!1;this.editable=a.editable||!1;this.initClass()};CRMMessagesProfile.prototype.initClass=function(){this.initResponsibleLink();this.initTopInfoFields();this.initMessage();this.initAssignTags();this.initSegments()};CRMMessagesProfile.prototype.initResponsibleLink=function(){this.$wrapper.find(".profile-responsible-link .responsible-link").on("click",
function(){c.get(c(this).data("dialog-url"),function(a){c.waDialog({remain_after_load:!0,html:a})})})};CRMMessagesProfile.prototype.initTopInfoFields=function(){var a=this.$wrapper.find(".js-info-list");this.$wrapper.on("click",".js-info-toggle",function(b){b.preventDefault();c(this).toggleClass("is-active");a.slideToggle()})};CRMMessagesProfile.prototype.initMessage=function(){this.initSendEmail();this.initSendSMS()};CRMMessagesProfile.prototype.initSendEmail=function(){var a=!1;this.$wrapper.on("click",
".js-show-message-dialog",function(b){b.preventDefault();var d=c(this);b=d.data("id");d=d.data("email");!a&&b&&(a=!0,c.post("?module=message&action=writeNewDialog",{contact_id:b,email:d},function(e){c.waDialog({html:e})}).always(function(){a=!1}))})};CRMMessagesProfile.prototype.initSendSMS=function(){var a=!1;this.$wrapper.on("click",".js-show-send-sms-dialog",function(b){b.preventDefault();var d=c(this);b=d.data("id");d=d.data("phone");!a&&b&&(a=!0,c.get("?module=message&action=writeSMSNewDialog",
{contact_id:b,phone:d},function(e){c.waDialog({html:e})}).always(function(){a=!1}))})};CRMMessagesProfile.prototype.initAssignTags=function(){var a=this.$wrapper.find(".crm-contact-assign-tags"),b=c.crm.app_url+"?module=contactOperation&action=assignTags&is_assign=1",d=parseInt(this.contact_id)||0;a.click(function(e){e.preventDefault();c.get(b,{contact_ids:[d]},function(f){c.waDialog({html:f})})})};CRMMessagesProfile.prototype.initSegments=function(){function a(l){var k=b.$wrapper.find(".js-segment-list"),
h=k.find("a").length;l.length||l.push({id:!1,name:b.locales.no_segments});c.each(l,function(n,m){n="javascript:void(0);";var p="",q='<span class="hint">'+m.name+"</span>";m.id&&(n=c.crm.app_url+"contact/segment/"+m.id+"/",p=b.icons_array[m.icon]?b.icons_array[m.icon]:b.icons_array.noname,q="<span>"+m.name+"</span>");m='<a href="'+n+'">'+p+q+"</a>";h&&(m=", "+m);k.append(m);h=!0})}var b=this,d=b.$wrapper.find(".crm-contact-assign-segments"),e=c.crm.app_url+"?module=contactOperation&action=addToSegments&is_assign=1",
f=parseInt(b.contact_id)||0;d.click(function(l){l.preventDefault();c.get(e,{contact_ids:[f]},function(k){c.waDialog({html:k,onOpen:function(h){new CRMContactsOperationAddToSegments({$wrapper:h,context:{contact_ids:[f]},is_assign:1})}})})});var g=!1;b.$wrapper.on("click",".js-show-dynamic-segments",function(l){l.preventDefault();var k=c(this);k.find(".icon").removeClass("fa-filter").addClass("fa-spinner fa-spin");g&&g.abort();g=c.post("?module=contact&action=segmentSearch",{id:b.contact_id},function(h){"ok"==
h.status&&(a(h.data.segments),k.remove())}).always(function(){g=!1})})};return CRMMessagesProfile}(jQuery),CRMEmailConversationEmailSender=function(c){CRMEmailConversationEmailSender=function(a){var b=this;b.$wrapper=a.$wrapper;b.$replySection=b.$wrapper.closest(".js-reply-wrapper");b.$resize_button=b.$replySection.find(".js-message-resize");b.$skeleton_wrapper=b.$wrapper.closest(".c-messages-conversation-wrapper").find(".skeleton-wrapper");b.$form=b.$wrapper.find("form");b.$textarea=b.$wrapper.find(".js-wysiwyg");
b.$textarea_small=b.$wrapper.find(".js-visible-textarea-small");b.$sender_email_select=b.$wrapper.find(".js-sender-email-select");b.$sender_email_select_val=b.$sender_email_select.val();b.$sender_email=b.$wrapper.find(".js-sender-email");b.$subject_input=b.$replySection.find('input[name="subject"]');b.subject_input_val=b.$subject_input.val();b.$copy_wrapper=b.$wrapper.find(".email-copy-wrapper");b.$copy_wrapper_collapsed=b.$wrapper.find(".email-copy-wrapper-collapsed");b.file_template_html=a.file_template_html;
b.max_upload_size=a.max_upload_size;b.locales=a.locales;b.hash=a.hash;b.send_action_url=a.send_action_url;b.body=a.body||"";b.deal_id=a.deal_id;b.is_changed=!1;b.is_locked=!1;b.body_old=b.body;if(!b.send_action_url)throw Error("send_action_url option required");b.initClass();b.filesController=b.getFilesController();b.disableResizer=function(d){d?(b.is_changed=!0,b.$resize_button.addClass("is-disabled")):(b.is_changed=!1,b.$resize_button.removeClass("is-disabled"))}};CRMEmailConversationEmailSender.prototype.initClass=
function(){this.senderEmailSelect();this.initWYSIWYG();this.initVisiblityWatcher();this.initSave();this.initPersonalSettingsDialog();this.initEmailCopy()};CRMEmailConversationEmailSender.prototype.initVisiblityWatcher=function(){function a(g){g?(e.addClass("is-extended").trigger("resize"),f.addClass("scroll-lock")):b.is_changed||(e.removeClass("is-extended").trigger("resize"),f.removeClass("scroll-lock"))}var b=this,d=b.$textarea,e=b.$replySection,f=c(".c-messages-page-content-wrapper");e.on("click",
".js-revert",function(){d.redactor("code.set",b.body);b.disableResizer(!1);a(!1);b.$body_redactor_p=b.$wrapper.find(".redactor-layer.redactor-styles.redactor-layer-img-edit section p").eq(0);b.$subject_input.val(b.subject_input_val);b.$sender_email_select.val(b.$sender_email_select_val).change();b.$copy_wrapper.find(".email-copy-user").each(function(){c(this).remove()});b.$copy_wrapper_collapsed.find(".email-copy-user").each(function(){c(this).remove()});b.$copy_wrapper.hasClass("email-copy-wrapper-block")&&
b.$wrapper.find(".js-email-copy-link").click();b.$copy_wrapper_collapsed.removeClass("email-copy-wrapper-collapsed-block")});e.on("click",".js-message-resize",function(){a(!1)});e.on("click",".js-message-resize-open",function(){var g=b.$wrapper.find(".redactor-layer.redactor-styles.redactor-layer-img-edit");b.body=g.html();a(!0);b.disableResizer(!1)});b.$subject_input.on("change",function(g){b.disableResizer(!0)})};CRMEmailConversationEmailSender.prototype.senderEmailSelect=function(){var a=this;
a.$wrapper.on("change",a.$sender_email_select,function(b){b.preventDefault();a.$sender_email.val(a.$sender_email_select.val());a.disableResizer(!0)})};CRMEmailConversationEmailSender.prototype.getFilesController=function(){function a(q){q.length&&(c.each(q,function(r,u){r=d.files_storage;var v=r.push,t=c(h);t.find(".js-name").text(u.name);k.prepend(t);f.prop("disabled")&&f.prop("disabled",!1);v.call(r,{$file:t,file:u})}),l.val(""))}function b(q){var r=[];c.each(d.files_storage,function(u,v){q[0]!==
v.$file[0]?r.push(v):q.remove()});d.files_storage=r}var d=this,e=d.$wrapper.find(".js-files-wrapper"),f=d.$wrapper.find(".c-visible .js-save-button");if(!e.length)return!1;var g=d.$wrapper.find(".js-default-drop-area"),l=d.$wrapper.find(".js-drop-field"),k=d.$wrapper.find(".c-upload-list"),h=d.file_template_html,n=c.crm.app_url+"?module=file&action=uploadTmp",m=0,p=0;d.files_storage=[];d.$form.on("click",".js-message-attachment",function(){l.click()});l.on("change",function(q){q.preventDefault();
a(this.files)});g.on("drop",function(q){q.preventDefault();a(q.originalEvent.dataTransfer.files)});g.on("dragover",function(q){q.preventDefault();g.addClass("is-hover");clearTimeout(p);p=setTimeout(function(){g.removeClass("is-hover")},100)});document.onpaste=function(q){q=(q.clipboardData||q.originalEvent.clipboardData).files;console.log(q);a(q)};d.$form.on("click",".js-file-delete",function(q){q.preventDefault();b(c(this).closest(".c-upload-item"))});return{uploadFiles:function(q,r){function u(t){function w(){var A=
new FormData,D=document.cookie.match(/(?:^|; )_csrf=([^;]*)/);(D=D?decodeURIComponent(D[1]):"")&&A.append("_csrf",D);q&&q.length&&c.each(q,function(E,F){F.name&&F.value&&A.append(F.name,F.value)});A.append("file_size",t.file.size);A.append("files",t.file);A.append("file_end",1);c.ajax({xhr:function(){var E=new window.XMLHttpRequest;E.upload.addEventListener("progress",function(F){F.lengthComputable&&(F=parseInt(F.loaded/F.total*100),y.css("--progress-value",F),100===F&&(y.css("background","transparent"),
z.show()))},!1);return E},url:n,data:A,cache:!1,contentType:!1,processData:!1,type:"POST",success:function(E){setTimeout(function(){c.contains(document,x[0])&&(--m,0>=m&&v())},2E3)}}).always(function(){d.is_locked=!1})}var x=t.$file,y=x.find(".js-bar"),z=y.find(".js-progress-success-icon"),B=x.find(".js-status");x.addClass("is-upload");if(d.max_upload_size>t.file.size)w();else{var C=d.$form.find(".js-submit-button");B.addClass("errormsg");x.removeClass("is-upload");d.is_locked=!1;f.find("svg").removeClass("fa-spinner fa-spin").addClass("fa-arrow-up");
C.attr("disabled",!1);d.$textarea_small.attr("disabled",!1);l.prop("disabled",!1);d.$form.find("button").prop("disabled",!1)}}var v=r?r:function(){};d.files_storage.length?(m=d.files_storage.length,c.each(d.files_storage,function(t,w){u(w)})):v()}}};CRMEmailConversationEmailSender.prototype.initWYSIWYG=function(){var a=this,b=a.$textarea;c.crm.initWYSIWYG(b,{maxHeight:50,allowedAttr:[["section","data-role"]],callbacks:{change:function(){a.disableResizer(!0)}}});a.body&&b.redactor("code.set",a.body);
a.$body_redactor_p=a.$wrapper.find(".redactor-layer.redactor-styles.redactor-layer-img-edit section p").eq(0)};CRMEmailConversationEmailSender.prototype.initSave=function(){function a(){l.css("min-height",0);var m=l[0].scrollHeight;250>m?l.css("min-height",m+"px"):l.css("min-height","250px")}function b(){var m=g.send_action_url,p=g.$form.serializeArray();n.prop("disabled",!0);l.attr("disabled",!0);c.ajax({method:"POST",url:m,data:p,dataType:"json"}).done(function(q){var r=jQuery.parseJSON(q.data.html);
q=q.data.id?q.data.id:q.data.message_id;g.$message_list.append(r);f();d(q);c(document).trigger("new_message_blockquot");k.attr("disabled",!0);h.attr("disabled",!0);g.body=g.body_old;g.$replySection.find(".js-revert").trigger("click");a();c("#c-messages-page #c-messages-sidebar").length&&c(document).trigger("msg_sidebar_upd_needed");var u=g.$wrapper.find(".redactor-layer.redactor-styles.redactor-layer-img-edit");q=u.find("blockquote").eq(0);u=u.find("> p").eq(1);var v=c(r).find(".c-message-body").html(),
t=c(r).find(".c-contact-link--name").html();r=c(r).find(".c-date.hint").data("time");q.html(v);u.html(r+", "+t+" "+g.locales.wrote+":")}).fail(function(q){var r=g.$form.find("#tooltip-error-message");q=Object.values(response.errors);r.addClass("errormsg");c.each(q,function(u,v){r.append('<span><i class="fas fa-exclamation-triangle state-error"></i> <span class="small">'+v+"</span></span>")});f();k.attr("disabled",!0);h.attr("disabled",!0);g.body=g.body_old;g.$replySection.find(".js-revert").trigger("click");
a();g.is_locked=!1;response.errors&&console.error(response.errors);g.$textarea.on("focus",e);l.on("focus",e);g.$form.on("change",e)}).always(function(){g.is_locked=!1})}function d(m){function p(){0==u&&c(document).trigger("scroll_button_event",m)}var q=g.$message_list.find("[data-id="+m+"]"),r=q[0].getElementsByTagName("img");q=q[0].getElementsByTagName("video");var u=r.length+q.length;p();for(var v=0;v<q.length;v++)3<=q[v].readyState?(u--,p()):(q[v].addEventListener("loadeddata",function(){u--;p()}),
q[v].addEventListener("error",function(){u--;p()}));for(v=0;v<r.length;v++)r[v].complete?(u--,p()):(r[v].addEventListener("load",function(){u--;p()}),r[v].addEventListener("error",function(){u--;p()}))}function e(){g.$form.find("#tooltip-error-message").removeClass("errormsg").html("");l.off("focus",e);g.$textarea.off("focus",e);g.$form.off("change",e)}function f(){k.find("svg").removeClass("fa-spinner fa-spin").addClass("fa-arrow-up");h.attr("disabled",!1);l.attr("disabled",!1);n.prop("disabled",
!1);g.$form.find("button").prop("disabled",!1);l.val("").focus();if(g.files_storage.length){var m=g.$form.find(".c-upload-item");c.each(m,function(p,q){q.remove()});g.files_storage=[]}}var g=this,l=g.$textarea_small,k=g.$wrapper.find(".c-visible .js-save-button"),h=g.$form.find(".js-submit-button"),n=g.$form.find(".js-drop-field");g.$message_list=c(".js-messages-list");$main_wrapper=c(".c-messages-page-content-wrapper");c(document).on("wa_before_load",function(){c(document).off("wa_before_load")});
l.on("keydown",function(m){13!==m.keyCode&&10!==m.keyCode||m.ctrlKey||m.metaKey||m.shiftKey||(m.preventDefault(),""!==l.val()||g.files_storage.length?g.$form.submit():(l.addClass("shake animated"),setTimeout(function(){l.removeClass("shake animated")},500)))});l.on("keyup",function(m){if(13!==m.keyCode&&10!==m.keyCode||!(m.ctrlKey||m.metaKey||m.shiftKey))""!==l.val()||g.files_storage.length?k.prop("disabled")&&k.prop("disabled",!1):k.prop("disabled")||k.prop("disabled",!0);else if(!m.shiftKey){var p=
l.val(),q=l.prop("selectionStart");m=p.slice(0,q);p=p.slice(q);l.val(m+"\n"+p)}a();g.$body_redactor_p.html(l.val())});g.$form.on("submit",function(m){m.preventDefault();g.is_locked||(g.is_locked=!0,m=c('<span class="icon size-16"><i class="fas fa-spinner wa-animation-spin custom-mr-4"></i></span>'),k.find("svg").removeClass("fa-arrow-up").addClass("fa-spinner fa-spin"),h.attr("disabled",!0),m.insertBefore(h),g.$form.find("button").prop("disabled",!0),g.filesController.uploadFiles([{name:"hash",value:g.hash}],
b))})};CRMEmailConversationEmailSender.prototype.initPersonalSettingsDialog=function(){function a(){d||(d=!0,c.post(c.crm.app_url+"?module=email&action=personalSettingsDialog",{},function(e){c.waDialog({html:e,options:{onSave:function(f){b.$textarea.redactor("core.editor").find('[data-role="c-email-signature"]').html(f.email_signature||"");b.$wrapper.find(".js-sender-name").text(f.sender_name||"")}}})}).always(function(){d=!1}))}var b=this,d=!1;b.$wrapper.on("click",".js-show-personal-settings-dialog",
function(e){e.preventDefault();a()})};CRMEmailConversationEmailSender.prototype.initEmailCopy=function(){function a(){var m=c.trim(k.val()).split(/[,:;]/);if(m[0].length)return c.each(m,function(p,q){p=c.trim(q).split(/\s+/);var r=!1,u=q=null;c.each(p,function(v,t){c.crm.check.email(t)&&!r&&(q=t.replace(/<|>/g,""),r=v)});!1!==r&&p.splice(r,1);u=p.join(" ");q&&u&&d(0,q,u);q&&!u&&b(0,q,q);u&&!q&&(k.addClass("shake animated"),setTimeout(function(){k.removeClass("shake animated")},500));r=!1;u=q=null}),
!1}function b(m,p,q){l.children('[data-email="'+p+'"]').length&&"0"!==m||!p.length||(e.$wrapper.find(".email-copy-input-div").before('<div class="email-copy-user" title="'+c.crm.escape(p)+'" data-contact-id="'+c.crm.escape(m)+'" data-email="'+c.crm.escape(p)+'">'+q+' <a title="'+e.locales.remove_form_cc+'" class="remove-cc js-remove-cc">x</a> <input name="cc['+c.crm.escape(p)+'][email]" type="hidden" value="'+c.crm.escape(p)+'" /><input name="cc['+c.crm.escape(p)+'][id]" type="hidden" value="'+c.crm.escape(m)+
'" /></div>'),e.$wrapper.find(".email-copy-text-collapsed").append('<div class="email-copy-user" title="'+c.crm.escape(p)+'" data-email="'+c.crm.escape(p)+'">'+q+"</div>"));k.val("").focus()}function d(m,p,q){l.children('[data-email="'+p+'"]').length&&"0"!==m||!p.length||(e.$wrapper.find(".email-copy-input-div").before('<div class="email-copy-user" title="'+c.crm.escape(p)+'" data-contact-id="'+m+'" data-email="'+c.crm.escape(p)+'">'+c.crm.escape(q)+' <a title="'+e.locales.remove_form_cc+'" class="remove-cc js-remove-cc">x</a> <input name="cc['+
c.crm.escape(p)+'][email]" type="hidden" value="'+c.crm.escape(p)+'" /><input name="cc['+c.crm.escape(p)+'][id]" type="hidden" value="'+c.crm.escape(m)+'" /><input name="cc['+c.crm.escape(p)+'][name]" type="hidden" value="'+c.crm.escape(q)+'" /></div>'),e.$wrapper.find(".email-copy-text-collapsed").append('<div class="email-copy-user" title="'+c.crm.escape(p)+'" data-email="'+c.crm.escape(p)+'">'+c.crm.escape(q)+"</div>"));k.val("").focus()}var e=this,f=e.$wrapper.find(".email-copy-wrapper"),g=f.find(".email-copy-area"),
l=g.find(".email-copy-text"),k=g.find(".email-copy-input"),h=f.find(".deal-participants-area"),n=e.$wrapper.find(".email-copy-wrapper-collapsed");k.autocomplete({source:c.crm.app_url+"?module=autocomplete&emailcomplete=true",appendTo:e.$wrapper,minLength:0,focus:function(){return!1},select:function(m,p){b(p.item.id,p.item.email,'<i class="icon userpic" style="background-image: url('+p.item.photo_url+');"></i><b>'+p.item.name+"</b>");k.val("");return!1}}).data("ui-autocomplete")._renderItem=function(m,
p){return c('<li class="ui-menu-item-html"><div>'+p.value+"</div></li>").appendTo(m)};k.on("focus",function(){k.data("uiAutocomplete").search(k.val())});e.$wrapper.on("click",".js-email-copy-link, .email-copy-text-collapsed",function(m){m.preventDefault();m=e.$wrapper.find(".js-email-copy-link-icon");f.toggleClass("email-copy-wrapper-block");f.is(":visible")?(m.removeClass("fa-caret-right").addClass("fa-caret-down"),k.focus(),n.removeClass("email-copy-wrapper-collapsed-block")):(m.removeClass("fa-caret-down").addClass("fa-caret-right"),
e.$wrapper.find(".email-copy-text-collapsed").children().length&&n.addClass("email-copy-wrapper-collapsed-block"));e.$wrapper.closest(".js-reply-wrapper").trigger("resize")});g.on("click",function(){k.focus()});h.on("click",".email-copy-user",function(){var m=c(this).data("cc-contact-id"),p=c(this).data("cc-email"),q=c(this).html();b(m,p,q)});k.on("focusout",function(m){a()});k.on("keydown",function(m){13==m.keyCode&&(m.preventDefault(),a())});l.on("click",".js-remove-cc",function(m){m.preventDefault();
m=c(this).parent(".email-copy-user");var p=m.data("email");m.remove();e.$wrapper.find(".email-copy-text-collapsed").children('[data-email="'+p+'"]').remove()});k.on("keydown",function(m){if(8==m.keyCode&&0==k.val().length){m=e.$wrapper.find(".email-copy-text .email-copy-user:last");var p=m.data("email");m.remove();e.$wrapper.find(".email-copy-text-collapsed").children('[data-email="'+p+'"]').remove();k.focus()}})};return CRMEmailConversationEmailSender}(jQuery),CRMImConversationSection=function(c){CRMImConversationSection=
function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$textarea=this.$form.find(".js-textarea");this.$submitButton=this.$form.find(".js-save-button");this.$attachment_icon=this.$form.find(".js-message-attachment");this.$skeleton_wrapper=this.$wrapper.closest(".c-messages-conversation-wrapper").find(".skeleton-wrapper");this.send_action_url=a.send_action_url;this.file_template_html=a.file_template_html;this.hash=a.hash;this.max_upload_size=a.max_upload_size;this.is_images_enabled=
a.is_images_enabled;this.is_files_enabled=a.is_files_enabled;this.hover_class="is-hover";this.files_controller=this.getFilesController();this.is_locked=!1;this.initClass()};CRMImConversationSection.prototype.initClass=function(){this.initSubmit()};CRMImConversationSection.prototype.getFilesController=function(){function a(m){m.length&&(c.each(m,function(p,q){p=d.files_storage;var r=p.push,u=c(l);u.find(".js-name").text(q.name);f.prepend(u);d.$submitButton.prop("disabled")&&d.$submitButton.prop("disabled",
!1);r.call(p,{$file:u,file:q})}),g.val(""))}function b(m){var p=[];c.each(d.files_storage,function(q,r){m[0]!==r.$file[0]?p.push(r):m.remove()});d.files_storage=p}var d=this,e=d.$form.find(".js-default-drop-area"),f=d.$form.find(".js-upload-list"),g=d.$form.find(".js-drop-field"),l=d.file_template_html,k=c.crm.app_url+"?module=file&action=uploadTmp";d.files_storage=[];var h=0,n=0;d.$attachment_icon.on("click",function(){g.click()});g.on("change",function(m){m.preventDefault();a(this.files)});e.on("drop",
function(m){m.preventDefault();a(m.originalEvent.dataTransfer.files)});e.on("dragover",function(m){m.preventDefault();e.addClass(d.hover_class);clearTimeout(n);n=setTimeout(function(){e.removeClass(d.hover_class)},100)});document.onpaste=function(m){m=(m.clipboardData||m.originalEvent.clipboardData).files;console.log(m);a(m)};d.$wrapper.on("click",".js-file-delete",function(m){m.preventDefault();b(c(this).closest(".c-upload-item"));d.files_storage.length||""!==d.$textarea.val()||d.$submitButton.prop("disabled")||
d.$submitButton.prop("disabled",!0)});return{uploadFiles:function(m,p,q){function r(v){function t(){var C=new FormData,A=document.cookie.match(/(?:^|; )_csrf=([^;]*)/);(A=A?decodeURIComponent(A[1]):"")&&C.append("_csrf",A);m&&m.length&&c.each(m,function(D,E){E.name&&E.value&&C.append(E.name,E.value)});C.append("file_size",v.file.size);C.append("files",v.file);C.append("file_end",1);c.ajax({xhr:function(){var D=new window.XMLHttpRequest;D.upload.addEventListener("progress",function(E){E.lengthComputable&&
(E=parseInt(E.loaded/E.total*100),B.css("--progress-value",E),100===E&&(B.css("background","transparent"),z.show()))},!1);return D},url:k,data:C,cache:!1,contentType:!1,processData:!1,type:"POST",success:function(D){setTimeout(function(){c.contains(document,x[0])&&(--h,0>=h&&u())},250)}}).always(function(){is_locked=!1})}var w="image"===v.file.type.split("/")[0]?"image":"file";w=p?w===p:!1;var x=v.$file;x.find(".js-file-delete");var y=x.find(".js-status"),z=x.find(".js-progress-success-icon"),B=x.find(".js-bar");
x.addClass("is-upload");d.max_upload_size>v.file.size?w?t():(--h,0>=h&&u()):(y.addClass("errormsg"),x.removeClass("is-upload"),d.is_locked=!1,d.$submitButton.prop("disabled",!1),d.$submitButton.find("svg").removeClass("fa-spinner fa-spin").addClass("fa-arrow-up"),d.$textarea.attr("disabled",!1),g.prop("disabled",!1),d.$form.find("button").prop("disabled",!1))}var u=q?q:function(){};d.files_storage.length?(h=d.files_storage.length,c.each(d.files_storage,function(v,t){r(t)})):u()}}};CRMImConversationSection.prototype.initSubmit=
function(){function a(){d.css("min-height",0);var k=d[0].scrollHeight;250>k?d.css("min-height",k+"px"):d.css("min-height","250px")}var b=this,d=b.$textarea,e=b.$submitButton;b.$form.find(".js-upload-list");var f=b.is_images_enabled?"files-":"",g=b.$form.find(".js-drop-field"),l=b.is_images_enabled?"file":!1;b.$message_list=c(".js-messages-list");b.is_locked=!1;c(document).on("wa_before_load",function(){c(document).off("wa_before_load")});d.on("keydown",function(k){13!==k.keyCode&&10!==k.keyCode||
k.ctrlKey||k.metaKey||k.shiftKey||(k.preventDefault(),""!==d.val()||b.files_storage.length?b.$form.submit():(d.addClass("shake animated"),setTimeout(function(){d.removeClass("shake animated")},500)))});d.on("keyup",function(k){if(13!==k.keyCode&&10!==k.keyCode||!(k.ctrlKey||k.metaKey||k.shiftKey))""!==d.val()||b.files_storage.length?e.prop("disabled")&&e.prop("disabled",!1):e.prop("disabled")||e.prop("disabled",!0);else if(!k.shiftKey){var h=d.val(),n=d.prop("selectionStart");k=h.slice(0,n);h=h.slice(n);
d.val(k+"\n"+h)}a()});b.$form.on("submit",function(k){function h(r){function u(){0==w&&c(document).trigger("scroll_button_event",r)}var v=b.$message_list.find("[data-id="+r+"]"),t=v[0].getElementsByTagName("img");v=v[0].getElementsByTagName("video");var w=t.length+v.length;u();for(var x=0;x<v.length;x++)3<=v[x].readyState?(w--,u()):(v[x].addEventListener("loadeddata",function(){w--;u()}),v[x].addEventListener("error",function(){w--;u()}));for(x=0;x<t.length;x++)t[x].complete?(w--,u()):(t[x].addEventListener("load",
function(){w--;u()}),t[x].addEventListener("error",function(){w--;u()}))}function n(){b.$form.find("#tooltip-error-message").removeClass("errormsg").html("");b.$form.off("change",n);d.off("focus",n)}function m(){e.prop("disabled",!1);e.find("svg").removeClass("fa-spinner fa-spin").addClass("fa-arrow-up");d.attr("disabled",!1);g.prop("disabled",!1);b.$form.find("button").prop("disabled",!1);d.val("").focus();if(b.files_storage.length){var r=b.$form.find(".c-upload-item");c.each(r,function(u,v){v.remove()});
b.files_storage=[]}}k.preventDefault();if(!b.is_locked){var p=function(){var r=b.send_action_url,u=b.$form.serializeArray();d.attr("disabled",!0);g.prop("disabled",!0);c.post(r,u,function(v){if("ok"===v.status){var t=jQuery.parseJSON(v.data.html);v=v.data.message_id;b.$message_list.append(t);m();h(v);e.prop("disabled",!0);a();c("#c-messages-page #c-messages-sidebar").length&&c(document).trigger("msg_sidebar_upd_needed")}else{console.error(v);var w=b.$form.find("#tooltip-error-message");t=Object.values(v.errors);
w.addClass("errormsg");c.each(t,function(x,y){w.append('<span><i class="fas fa-exclamation-triangle state-error"></i> <span class="small">'+y+"</span></span>")});d.addClass("shake animated");setTimeout(function(){d.removeClass("shake animated")},500);b.is_locked=!1;m();e.prop("disabled",!0);a();d.on("focus",n);b.$form.on("change",n)}}).always(function(){b.is_locked=!1})};b.is_locked=!0;e.prop("disabled",!0);e.find("svg").removeClass("fa-arrow-up").addClass("fa-spinner fa-spin");b.$form.find("button").prop("disabled",
!0);if(b.is_images_enabled||b.is_files_enabled){k=function(){b.files_controller.uploadFiles(q,l,p)};var q=[{name:"hash",value:f+b.hash}];b.is_images_enabled?b.files_controller.uploadFiles([{name:"hash",value:"photos-"+b.hash}],"image",k):k()}}})};return CRMImConversationSection}(jQuery),CRMConversationAssociateDealDialog=function(c){CRMConversationAssociateDealDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$footer=this.$wrapper.find(".js-dialog-footer");this.$submit=
this.$form.find(".js-submit");this.$deal_name=this.$form.find(".js-deal-name");this.$deal_funnel=this.$form.find(".js-select-deal-funnel");this.$deal_stage=this.$form.find(".js-select-deal-stage");this.$deal_id=this.$form.find(".js-deal-id");this.$dialog=this.$wrapper.data("dialog");this.initClass()};CRMConversationAssociateDealDialog.prototype.initClass=function(){this.initSelectDeal();this.initSubmit()};CRMConversationAssociateDealDialog.prototype.initSelectDeal=function(){var a=this,b=a.$form.find(".js-select-deal .js-visible-link .js-text"),
d=a.$form.find(".js-select-funnel"),e=a.$form.find(".js-deals-list"),f=a.$form.find(".js-deal-name-field");a.$form.on("click",".js-create-new-deal",function(){a.$submit.addClass("yellow").removeAttr("disabled");var g=c(this).find(".js-text").html();a.deal_selected=!0;d.removeClass("hidden");f.removeClass("hidden");a.$deal_name.focus();b.html(g);a.$deal_id.val("0")});a.$form.on("click",".js-deal-item",function(){a.$submit.addClass("yellow").removeAttr("disabled");var g=c(this).find(".js-text").html();
a.deal_selected=!0;e.find("li").removeClass("selected");c(this).parent().addClass("selected");b.html(g);d.addClass("hidden");f.addClass("hidden");a.$deal_name.val("");a.$deal_id.val(c(this).data("deal-id"))});e.on("click",function(){e.hide();setTimeout(function(){e.removeAttr("style")},200)});a.$form.on("change",".js-select-deal-funnel",function(){a.$form.find(".js-select-stage-wrapper").load("?module=deal&action=stagesByFunnel&id="+c(this).val())})};CRMConversationAssociateDealDialog.prototype.initSubmit=
function(){function a(){var d=c('<span class="icon size-16"><i class="fas fa-spinner wa-animation-spin custom-mr-4"></i></span>'),e=c.crm.app_url+"?module=message&action=conversationAssociateDealSave",f=b.$form.serializeArray();b.$submit.prop("disabled",!0);b.$footer.append(d);c.post(e,f,function(g){"ok"===g.status?(c.crm.content.reload(),b.$dialog.close()):(b.$submit.prop("disabled",!1),d.remove())})}var b=this;b.$form.on("submit",function(d){d.preventDefault();if(!b.$deal_id.val())return b.$wrapper.addClass("shake animated"),
setTimeout(function(){b.$wrapper.removeClass("shake animated")},500),!1;if(0==b.$deal_id.val()&&!c.trim(b.$deal_name.val()))return b.$deal_name.addClass("shake animated"),setTimeout(function(){b.$deal_name.removeClass("shake animated")},500),!1;a()})};return CRMConversationAssociateDealDialog}(jQuery);var CRMPageMessagesOperations=function(c){CRMPageMessagesOperations=function(a){this.$wrapper=a.$wrapper;this.$bar=this.$wrapper.find(".js-operation-wrapper");this.$list=this.$wrapper.find(".js-messages-section");this.$list_header=this.$wrapper.find(".c-messages-header");this.$checkbox_all=this.$bar.find("#js-operation-main-checkbox");this.$checkbox_all_counter=this.$bar.find(".js-operation-badge");this.is_admin=a.is_admin;this.page=a.page||1;this.limit=a.limit||30;this.total_count=a.total_count||
0;this.total_items_at_page_count=this.getTotalItemsAtPage()||0;this.view=a.view||"all";this.locales=a.locales||[];this.checked_count=0;this.read_list=[];this.unread_list=[];this.unread_counter=this.read_counter=0;this.deal_list=[];this.deal_counter=0;this.no_deal_list=[];this.no_deal_counter=0;this.is_shown=0<this.checked_count;this.is_checked_all=!1;this.initClass()};CRMPageMessagesOperations.prototype.initClass=function(){this.initCheckboxAll();this.showOrHideBar();this.initOperations();this.initItemCheckbox()};
CRMPageMessagesOperations.prototype.initElasticHeader=function(){function a(){c.contains(document,f[0])?d.scrollTop()>g.top?(f.addClass("is-fixed").css({left:g.left,width:l}),k=!0):(f.removeClass("is-fixed").removeAttr("style"),k=!1):d.off("scroll",a)}function b(){c.contains(document,f[0])?(l=e.outerWidth(),k&&f.width(l)):d.off("resize",b)}var d=c(window),e=this.$wrapper.find(".js-messages-section"),f=this.$bar,g=e.offset(),l=f.outerWidth(),k=!1;d.on("scroll",a).on("resize",b)};CRMPageMessagesOperations.prototype.initCheckboxAll=
function(){var a=this;a.$checkbox_all.click(function(){var b=c(this),d=b.is(":checked");0<a.checked_count?a.checked_count<=a.getTotalItemsAtPage()?a.unselectAll():a.selectAll():(b.prop("checked",d),d?a.selectAll():a.unselectAll());a.formBar()})};CRMPageMessagesOperations.prototype.initOperations=function(){var a=this;a.$bar.on("click",".crm-operation-link",function(b){b.preventDefault();switch(c(this).data("id")){case "associate":a.associateWithDeal();break;case "detach":a.detachFromDeals();break;
case "read":a.markAsRead();break;case "unread":a.markAsUnread();break;case "delete":a.deleteConversation()}})};CRMPageMessagesOperations.prototype.updateBarCount=function(a,b,d){0<b?(a.removeClass(d),a.find(".crm-count").text(b)):(a.addClass(d),a.find(".crm-count").text(""))};CRMPageMessagesOperations.prototype.showOrHideBar=function(){var a=this;a.$list_header.on("click",".js-operations-show",function(){a.$bar.hasClass("hidden")&&(a.$bar.removeClass("hidden"),a.$list.addClass("active-operations"))});
a.$bar.on("click",".js-operation-hide",function(){a.$bar.addClass("hidden");a.$list.removeClass("active-operations");a.unselectAll()})};CRMPageMessagesOperations.prototype.getSelectedIds=function(){return this.$list.find(".c-checkbox :checkbox:checked").map(function(){return parseInt(c(this).val())}).toArray()};CRMPageMessagesOperations.prototype.getTotalItemsAtPage=function(){return this.$list.find(".c-checkbox :checkbox").length};CRMPageMessagesOperations.prototype.formBar=function(){var a=this.$bar.find('.crm-operation-li[data-id="detach"] a'),
b=this.$bar.find('.crm-operation-li[data-id="read"] a'),d=this.$bar.find('.crm-operation-li[data-id="unread"] a'),e=this.$bar.find('.crm-operation-li[data-id="delete"] a');this.updateBarCount(b,this.unread_counter,"disabled");this.updateBarCount(d,this.read_counter,"disabled");this.updateBarCount(a,this.deal_counter,"disabled");this.updateBarCount(e,this.checked_count,"disabled")};CRMPageMessagesOperations.prototype.initItemCheckbox=function(){var a=this;a.$list.on("change",".js-checkbox",function(b,
d){b=c(this);var e=b.closest(".js-message-wrapper");"undefined"!==typeof d&&b.attr("checked",d);a.markAsReadList(e);a.markAsUnreadList(e);a.detachFromDealsList(e);e.find(".js-checkbox").is(":checked")?a.checked_count+=1:0<a.checked_count&&--a.checked_count;a.$checkbox_all_counter.text(a.checked_count);a.formBar();0<a.checked_count?a.checked_count<a.getTotalItemsAtPage()?a.$checkbox_all.parent().addClass("indeterminate").find("svg").addClass("fa-minus").removeClass("fa-check"):(a.$checkbox_all.prop("checked",
!0),a.$checkbox_all.parent().removeClass("indeterminate").find("svg").removeClass("fa-minus").addClass("fa-check")):(a.$checkbox_all.prop("checked",!1),a.$checkbox_all.parent().removeClass("indeterminate").find("svg").removeClass("fa-minus").addClass("fa-check"))})};CRMPageMessagesOperations.prototype.selectAll=function(){this.$list.find(".c-checkbox :checkbox").prop("checked",!0).trigger("change",[!0]);this.checked_count=this.getSelectedIds().length;this.is_checked_all=!0};CRMPageMessagesOperations.prototype.unselectAll=
function(){this.$list.find(".c-checkbox :checkbox").prop("checked",!1).trigger("change",[!1]);this.$checkbox_all.prop("checked",!1);this.checked_count=0;this.is_checked_all=!1};CRMPageMessagesOperations.prototype.associateWithDeal=function(){var a=this.no_deal_list;1===a.length?this.$list.find('tr[data-id="'+a[0]+'"] .js-associate-deal').trigger("click"):c.get("/webasyst/crm/?module=message&action=conversationAssociateDealDialog&conversation_id="+a[0],function(b){new CRMDialog({html:b})})};CRMPageMessagesOperations.prototype.associateWithDealList=
function(a){var b=this,d=a.data("has-deal");a=a.data("id");d||-1!==b.no_deal_list.indexOf(a)||b.no_deal_list.push(a);b.no_deal_list=b.getSelectedIds().filter(function(e){return-1<b.no_deal_list.indexOf(e)});b.no_deal_counter=b.no_deal_list.length};CRMPageMessagesOperations.prototype.detachFromDeals=function(){var a=this,b=a.view,d=a.deal_list,e={message_ids:d},f="detachDeals";"conversation"===b&&(e={conversation_ids:d},f="detachDealsFromConversations");var g=c.crm.app_url+"?module=messageOperation&action="+
f,l=function(k,h){c.waDialog.confirm({title:'<i class="fas fa-exclamation-triangle smaller state-error"></i> '+k,text:c.trim(h),success_button_title:a.locales.detach_button,success_button_class:"danger",cancel_button_title:a.locales.cancel_button,cancel_button_class:"light-gray",onSuccess:function(){c.post(g,e).done(function(n){var m=Object.keys(e)[0];n=n.data[m];n.length&&(n.forEach(function(p){c('.js-message-wrapper[data-id="'+p+'"]',a.$list).data("has-deal",0).attr("data-has-deal",0);a.no_deal_list.push(p);
a.deal_list=a.deal_list.splice(p,1)}),a.no_deal_counter=a.no_deal_list.length,a.deal_counter=a.deal_list.length,a.formBar());n=a.$list.find(".js-message-wrapper.selected").data("id");c.message.content.reload(n)}).fail(function(n){console.error("Detach Deals From Conversations",n)})},onClose:function(n){}})};(function(){if("conversation"===b){var k=c.extend({check:1},e,!0);return c.post(g,k)}return c.Deferred().resolve({})})().done(function(k){l(a.locales.detach_dialog_h2,"ok"===k.status&&k.data&&
k.data.text||"")})};CRMPageMessagesOperations.prototype.detachFromDealsList=function(a){var b=this,d=a.data("has-deal");a=a.data("id");d&&-1===b.deal_list.indexOf(a)&&b.deal_list.push(a);b.deal_list=b.getSelectedIds().filter(function(e){return-1<b.deal_list.indexOf(e)});b.deal_counter=b.deal_list.length};CRMPageMessagesOperations.prototype.markAsRead=function(){var a=this,b=c.crm.app_url+"?module=messageOperation&action=markAsRead",d=a.unread_list,e={message_ids:d};"conversation"===a.view&&(e={conversation_ids:d});
c.post(b,e).done(function(f){var g=Object.keys(e)[0];f=f.data[g];f.length&&(f.map(function(l){a.$list.find('.js-message-wrapper[data-id="'+l+'"]').removeClass("unread").data("read",1).attr("data-read",1);a.read_list.push(l);a.unread_list=a.unread_list.splice(l,1)}),a.read_counter=a.read_list.length,a.unread_counter=a.unread_list.length,a.formBar())}).fail(function(f){console.error("Mark as read",f)})};CRMPageMessagesOperations.prototype.markAsReadList=function(a){var b=this,d=a.data("id");1===a.data("read")&&
-1===b.read_list.indexOf(d)&&b.read_list.push(d);b.read_list=b.getSelectedIds().filter(function(e){return-1<b.read_list.indexOf(e)});b.read_counter=b.read_list.length};CRMPageMessagesOperations.prototype.markAsUnread=function(){var a=this,b=c.crm.app_url+"?module=messageOperation&action=markAsUnread",d=a.read_list,e={message_ids:d};"conversation"===a.view&&(e={conversation_ids:d});c.post(b,e).done(function(f){var g=Object.keys(e)[0];f=f.data[g];f.length&&(f.map(function(l){a.$list.find('.js-message-wrapper[data-id="'+
l+'"]').addClass("unread").data("read",0).attr("data-read",0);a.unread_list.push(l);a.read_list=a.read_list.splice(l,1)}),a.unread_counter=a.unread_list.length,a.read_counter=a.read_list.length,a.formBar())}).fail(function(f){console.error("Mark as unread",f)})};CRMPageMessagesOperations.prototype.markAsUnreadList=function(a){var b=this,d=a.data("id");0===a.data("read")&&-1===b.unread_list.indexOf(d)&&b.unread_list.push(d);b.unread_list=b.getSelectedIds().filter(function(e){return-1<b.unread_list.indexOf(e)});
b.unread_counter=b.unread_list.length};CRMPageMessagesOperations.prototype.deleteConversation=function(){var a=this,b=a.view,d=a.getSelectedIds(),e={message_ids:d},f="delete";"conversation"===b&&(e={conversation_ids:d},f="deleteConversations");var g=c.crm.app_url+"?module=messageOperation&action="+f,l=a.is_admin?'\n            <label>\n                <span class="wa-checkbox">\n                    <input type="checkbox" name="ban_checkbox" id="ban_checkbox">\n                    <span>\n                        <span class="icon">\n                            <i class="fas fa-check"></i>\n                        </span>\n                    </span>\n                </span>\n                    '+
a.locales.ban_text+"\n            </label>":"",k=function(h,n){n='<div class="flexbox vertical space-16">'+l+' <span class="text-red">'+c.trim(n)+"</span></div>";c.waDialog.confirm({title:'<i class="fas fa-exclamation-triangle smaller state-error"></i> '+h,text:n,success_button_title:a.locales.delete_button,success_button_class:"danger",cancel_button_title:a.locales.cancel_button,cancel_button_class:"light-gray",onSuccess:function(m,p){m=m.$content.find("#ban_checkbox").prop("checked");var q=e;m&&
(q=c.extend({ban_contacts:1},e,!0));c.post(g,q).done(function(r){var u=Object.keys(q);r=r.data[u[u.length-1]];r.length&&(r.map(function(v){c('.js-message-wrapper[data-id="'+v+'"]',a.$list).hide()}),a.checked_count-=d.length,a.total_count-=d.length,a.unselectAll(),a.formBar(),1>a.total_count&&(a.$list.hide().before('<div class="no-messages">'+a.locales.no_messages+"</div>"),a.unselectAll(),a.$bar.addClass("hidden"),a.$list.removeClass("active-operations")))}).fail(function(r){console.error("Delete messages",
r)})},onClose:function(m){}})};(function(){if("conversation"===b){var h=c.extend({check:1},e,!0);return c.post(g,h)}return c.Deferred().resolve({})})().done(function(h){k(a.locales.delete_dialog_h2,"ok"===h.status&&h.data&&h.data.text||"")})};return CRMPageMessagesOperations}(jQuery);var CRMSendEmailDialog=function(c){function a(b){(b=b.data("redactor"))&&"core"in b&&b.core.destroy()}CRMSendEmailDialog=function(b){this.$wrapper=b.$wrapper;this.$form=this.$wrapper.find("form");this.$textarea=this.$wrapper.find(".js-wysiwyg");this.$sender_email_select=this.$wrapper.find(".js-sender-email-select");this.$sender_email=this.$wrapper.find(".js-sender-email");this.$to_input=this.$wrapper.find(".js-to-input");this.$to_id=this.$wrapper.find(".js-to-id");this.dialog=this.$wrapper.data("dialog");
this.success_html=b.success_html;this.error_html=b.error_html;this.file_template_html=b.file_template_html;this.max_upload_size=b.max_upload_size;this.locales=b.locales;this.hash=b.hash;this.send_action_url=b.send_action_url;this.body=b.body||"";var d=!1;window&&window.parent&&window.parent.$&&window.parent.$.crm?d=window.parent.$.crm:window.$&&window.$.crm&&(d=window.$.crm);this.crm=d;this.action=b.action;this.deal_id=b.deal_id;this.is_admin=b.is_admin;this.iframe=b.iframe;this.app_url=b.crm_app_url||
this.crm&&this.crm.app_url;if(!this.send_action_url)throw Error("send_action_url option required");this.filesController=this.getFilesController();this.initClass()};CRMSendEmailDialog.prototype.initClass=function(){var b=this;b.initWYSIWYG();b.initSendMessage();b.initPersonalSettingsDialog();b.senderEmailSelect();b.initEmailCopy();"new"==b.action&&(0==b.$to_id.val()&&b.initEmailTo(),b.initSelectDeal(),b.$to_input.focus());"forward"==b.action&&(b.initEmailTo(),b.$to_input.focus(),b.deal_id||b.initSelectDeal());
"reply"!=b.action||b.deal_id||b.initSelectDeal();!b.iframe&&b.dialog.resize();b.iframe&&(console.log(c(window.parent).width()),760>c(window.parent).width()&&c(".dialog .dialog-content",window.parent.document).css("padding","0 0.75rem"),b.$wrapper.on("click",".js-close-dialog",function(d){d.preventDefault();c(".dialog iframe",window.parent.document)[0].dispatchEvent(new Event("close"));a(b.$textarea)}))};CRMSendEmailDialog.prototype.getFilesController=function(){function b(r){r.length&&c.each(r,function(u,
v){u=m;var t=u.push,w=c(h);w.find(".js-name").text(v.name);k.prepend(w);!e.iframe&&e.dialog.resize();t.call(u,{$file:w,file:v})})}function d(r){var u=[];c.each(m,function(v,t){r[0]!==t.$file[0]?u.push(t):r.remove()});m=u}var e=this,f=e.$wrapper.find(".js-files-wrapper");if(!f.length)return!1;var g=e.$wrapper.find(".js-drop-area"),l=e.$wrapper.find(".js-drop-field"),k=f.find(".c-upload-list"),h=e.file_template_html,n=e.app_url+"?module=file&action=uploadTmp",m=[],p=0,q=0;l.on("change",function(r){r.preventDefault();
b(this.files)});g.on("drop",function(r){r.preventDefault();b(r.originalEvent.dataTransfer.files)});g.on("dragover",function(r){r.preventDefault();g.addClass("is-hover");clearTimeout(q);q=setTimeout(function(){g.removeClass("is-hover")},100)});f.on("click",".js-file-delete",function(r){r.preventDefault();d(c(this).closest(".c-upload-item"))});return{uploadFiles:function(r,u){function v(w){function x(){var E=new FormData,F=document.cookie.match(/(?:^|; )_csrf=([^;]*)/);(F=F?decodeURIComponent(F[1]):
"")&&E.append("_csrf",F);r&&r.length&&c.each(r,function(G,H){H.name&&H.value&&E.append(H.name,H.value)});E.append("file_size",w.file.size);E.append("files",w.file);E.append("file_end",1);c.ajax({xhr:function(){var G=new window.XMLHttpRequest;G.upload.addEventListener("progress",function(H){H.lengthComputable&&(H=parseInt(H.loaded/H.total*100),z.css("--progress-value",H),100===H&&(z.css("background","transparent"),B.show()))},!1);return G},url:n,data:E,cache:!1,contentType:!1,processData:!1,type:"POST",
success:function(G){setTimeout(function(){c.contains(document,y[0])&&(y.remove(),--p,0>=p&&t())},2E3)}}).always(function(){e.is_locked=!1})}e.is_locked=!0;var y=w.$file,z=y.find(".js-bar"),B=z.find(".js-progress-success-icon"),C=y.find(".js-status");y.addClass("is-upload");if(e.max_upload_size>w.file.size)x();else{C.addClass("errormsg");y.removeClass("is-upload");e.is_locked=!1;C=e.$form.find(".js-submit-button");var A=e.$form.find(".js-drop-field"),D=e.$form.find(".submit-loader");C.attr("disabled",
!1);A.attr("disabled",!1);D.remove();e.$form.find("button").prop("disabled",!1)}}var t=u?u:function(){};m.length?(p=m.length,c.each(m,function(w,x){v(x)})):t()}}};CRMSendEmailDialog.prototype.initWYSIWYG=function(){var b=this,d=b.$textarea,e=0;b.iframe||(b.dialog.onClose=function(){a(d)});b.crm.initWYSIWYG(d,{allowedAttr:[["section","data-role"]],callbacks:{change:function(){var f=b.iframe?0:b.dialog.$block.height();e&&e===f||(e=f,!b.iframe&&b.dialog.resize())}}});b.body&&d.redactor("code.set",b.body)};
CRMSendEmailDialog.prototype.initSendMessage=function(){var b=this,d=b.$wrapper.find(".js-to-email"),e=b.$to_id,f=b.$wrapper.find(".js-to-new-name");b.is_locked=!1;b.$form.on("submit",function(l){l.preventDefault();if(!(0!=e.val()||c.trim(f.val())&&c.trim(d.val())||"new"!=b.action&&"forward"!=b.action))return c(".js-to-input, .js-to-add-name, .js-to-add-email").addClass("shake animated").focus(),setTimeout(function(){c(".js-to-input, .js-to-add-name, .js-to-add-email").removeClass("shake animated").focus()},
500),!1;if(!c.trim(d.val()))return b.$to_input.addClass("shake animated").focus(),setTimeout(function(){b.$to_input.removeClass("shake animated").focus()},500),!1;if(!b.is_locked){b.is_locked=!0;l=b.$form.find(".js-submit-button");var k=b.$form.find(".js-drop-field"),h=c('<span class="icon size-16 submit-loader"><i class="fas fa-spinner wa-animation-spin custom-mr-4"></i></span>');l.attr("disabled",!0);h.insertAfter(l);k.attr("disabled",!0);b.$form.find("button").prop("disabled",!0);b.filesController.uploadFiles([{name:"hash",
value:b.hash}],g)}});var g=function(){var l=b.send_action_url,k=b.$form.serializeArray(),h=function(n,m){if(!c.isEmptyObject(n)){n=c.extend(!0,{},n);var p=b.locales.send_error_title||"Send error",q=b.locales.send_error_text||"Can't send email message";q=c(b.error_html).find(".js-error-text").text(q).end();var r=n.common;b.is_admin&&(r?(q.find(".js-technical-info-block.js-known-error").show(),q.find(".js-technical-info-text").text(r)):q.find(".js-technical-info-block.js-unknown-error").show());c.crm.alert.show({title:p,
text:q.get(0).outerHTML,button:b.locales.close||"close",button_class:"red",onOpen:function(u){u.find(".js-technical-info-link").one("click",function(){c(this).remove();u.find(".js-technical-info-text").show()})}});delete n.common;c.isEmptyObject(n)||console.log.error(n)}m&&console.log.error(m)};c.post(l,k,"json").done(function(n){if("ok"===n.status){a(b.$textarea);b.$wrapper.find(".dialog-body").html(b.success_html);!b.iframe&&b.dialog.resize();var m=null;b.iframe||(b.dialog.onClose=function(){m&&
clearTimeout(m);m=null;c.crm?c.crm.content.reload():b.crm.content.reload()});m=setTimeout(function(){b.iframe?c(".dialog iframe",window.parent.document)[0].dispatchEvent(new Event("close")):b.dialog.close()},2500)}else!b.iframe&&b.dialog.close(),c.isEmptyObject(n.errors)?h({common:"Send error"},n):h(n.errors)}).always(function(){b.is_locked=!1}).fail(function(n){h({},n);!b.iframe&&b.dialog.close()})}};CRMSendEmailDialog.prototype.initPersonalSettingsDialog=function(){function b(){d.is_locked||(d.is_locked=
!0,c.post(d.crm.app_url+"?module=email&action=personalSettingsDialog",{},function(e){c.waDialog({html:e,options:{onSave:function(f){d.$textarea.redactor("core.editor").find('[data-role="c-email-signature"]').html(f.email_signature||"");d.$wrapper.find(".js-sender-name").text(f.sender_name||"")}}})}).always(function(){d.is_locked=!1}))}var d=this;d.$wrapper.on("click",".js-show-personal-settings-dialog",function(e){e.preventDefault();b()})};CRMSendEmailDialog.prototype.senderEmailSelect=function(){var b=
this;b.$wrapper.on("change",b.$sender_email_select,function(d){d.preventDefault();b.$sender_email.val(b.$sender_email_select.val())})};CRMSendEmailDialog.prototype.initEmailTo=function(){function b(){var t=c.trim(l.val()).split(/\s+/),w=!1;c.each(t,function(x,y){c.crm.check.email(y)&&!w&&(g=y.replace(/<|>/g,""),w=x)});!1!==w&&t.splice(w,1);f=t.join(" ");g&&f&&(t='<span class="js-edit-recipient" title="'+e.locales.edit_recipient+'"><b>'+c.crm.escape(f)+'</b> <span style="color: #999;">&lt;'+c.crm.escape(g)+
"&gt;</span></span>",d(0,g,t),h.val(c.crm.escape(f)));if(f&&!g)return t='<span class="js-edit-recipient" title="'+e.locales.edit_recipient+'"><b>'+c.crm.escape(f)+'</b></span> <input class="c-to-input js-to-add-email" type="text" autocomplete="off" placeholder="'+e.locales.type_email+'" style="margin-left: 8px; width: 150px;" />',d(0,null,t),h.val(c.crm.escape(f)),c(".js-to-add-email").focus(),!1;if(g&&!f)return t='<input class="c-to-input js-to-add-name" type="text" autocomplete="off" placeholder="'+
e.locales.type_name+'" style="margin-right: 8px; width: 150px;" > <span class="js-edit-recipient" title="'+e.locales.edit_recipient+'" style="color: #999;">&lt;'+c.crm.escape(g)+"&gt;</span>",d(0,g,t),c(".js-to-add-name").focus(),!1}function d(t,w,x){m.prepend('<div class="c-email-to-user js-email-to-user">'+x+' <a title="'+e.locales.change_recipient+'" class="c-remove-to-email js-remove-to-email text-gray"><i class="icon fas fa-times-circle delete"></i></a></div>');p.removeClass("hidden");l.addClass("hidden").val("");
k.val(w);n.val(t).trigger("change")}var e=this,f=null,g=null,l=e.$to_input,k=e.$wrapper.find(".js-to-email"),h=e.$wrapper.find(".js-to-new-name"),n=e.$to_id,m=e.$wrapper.find(".js-to-name"),p=e.$wrapper.find(".js-deal-field"),q=e.$wrapper.find(".js-select-funnel"),r=e.$wrapper.find(".js-select-deal .js-visible-link .js-text"),u=e.$wrapper.find(".js-deals-list"),v=e.$wrapper.find(".js-create-new-deal");l.autocomplete({source:c.crm.app_url+"?module=autocomplete&emailcomplete=true",appendTo:e.$wrapper,
minLength:0,focus:function(){return!1},select:function(t,w){t=w.item;w=(t.criteria||{}).email||t.email;d(t.id,w,'<i class="icon userpic" style="background-image: url('+t.photo_url+');"></i>'+t.name+' <span style="color: #999;">&lt;'+w+"&gt;</span>");return!1}}).data("ui-autocomplete")._renderItem=function(t,w){return c('<li class="ui-menu-item-html"><div>'+w.value+"</div></li>").appendTo(t)};l.on("focus",function(){l.data("uiAutocomplete").search(l.val())});l.on("keydown",function(t){if(13==t.keyCode)return t.preventDefault(),
l.blur(),!1});l.on("focusout",function(t){t.preventDefault();b();return!1});m.on("click",".js-remove-to-email",function(){c(this).parent(".js-email-to-user").remove();l.removeClass("hidden").focus();p.addClass("hidden");q.addClass("hidden");u.html(v);r.html(""+e.locales.deal_select);k.val("");h.val("");n.val("").trigger("change");g=f=null});e.$wrapper.on("click",".js-edit-recipient",function(){var t=[f,g].join(" ");l.val(c.trim(t)).removeClass("hidden").focus();c(".js-email-to-user").remove();g=f=
null;k.val("");h.val("")});e.$wrapper.on("keydown",".js-to-add-email",function(t){13==t.keyCode&&(t.preventDefault(),c(this).blur())});e.$wrapper.on("focusout",".js-to-add-email",function(){var t=c(".js-to-add-email"),w=c.trim(t.val());w.length&&!0===c.crm.check.email(w)&&(g=w,k.val(c.crm.escape(w)),t.before(c('<span class="js-edit-recipient" title="'+e.locales.edit_recipient+'" style="color: #999;"></span>').text("<"+w+">")).remove())});e.$wrapper.on("keydown",".js-to-add-name",function(t){13==t.keyCode&&
(t.preventDefault(),c(this).blur())});e.$wrapper.on("focusout",".js-to-add-name",function(){var t=c.trim(c(".js-to-add-name").val());t.length&&(f=t,h.val(c.crm.escape(t)),c(".js-to-add-name:first-child").before(c('<span class="js-edit-recipient" title="'+e.locales.edit_recipient+'"><b></b></span>').text(t)).remove())})};CRMSendEmailDialog.prototype.initEmailCopy=function(){function b(){var p=c.trim(h.val()).split(/[,:;]/);if(p[0].length)return c.each(p,function(q,r){q=c.trim(r).split(/\s+/);var u=
!1,v=r=null;c.each(q,function(t,w){c.crm.check.email(w)&&!u&&(r=w.replace(/<|>/g,""),u=t)});!1!==u&&q.splice(u,1);v=q.join(" ");r&&v&&e(0,r,v);r&&!v&&d(0,r,r);v&&!r&&(h.addClass("shake animated"),setTimeout(function(){h.removeClass("shake animated")},500));u=!1;v=r=null}),!1}function d(p,q,r){k.children('[data-email="'+q+'"]').length&&"0"!==p||!q.length||(c(".email-copy-input-div").before('<div class="email-copy-user" title="'+c.crm.escape(q)+'" data-contact-id="'+c.crm.escape(p)+'" data-email="'+
c.crm.escape(q)+'">'+r+' <a title="'+f.locales.remove_form_cc+'" class="remove-cc js-remove-cc">x</a> <input name="cc['+c.crm.escape(q)+'][email]" type="hidden" value="'+c.crm.escape(q)+'" /><input name="cc['+c.crm.escape(q)+'][id]" type="hidden" value="'+c.crm.escape(p)+'" /></div>'),c(".email-copy-text-collapsed").append('<div class="email-copy-user" title="'+c.crm.escape(q)+'" data-email="'+c.crm.escape(q)+'">'+r+"</div>"));h.val("").focus()}function e(p,q,r){k.children('[data-email="'+q+'"]').length&&
"0"!==p||!q.length||(c(".email-copy-input-div").before('<div class="email-copy-user" title="'+c.crm.escape(q)+'" data-contact-id="'+p+'" data-email="'+c.crm.escape(q)+'">'+c.crm.escape(r)+' <a title="'+f.locales.remove_form_cc+'" class="remove-cc js-remove-cc">x</a> <input name="cc['+c.crm.escape(q)+'][email]" type="hidden" value="'+c.crm.escape(q)+'" /><input name="cc['+c.crm.escape(q)+'][id]" type="hidden" value="'+c.crm.escape(p)+'" /><input name="cc['+c.crm.escape(q)+'][name]" type="hidden" value="'+
c.crm.escape(r)+'" /></div>'),c(".email-copy-text-collapsed").append('<div class="email-copy-user" title="'+c.crm.escape(q)+'" data-email="'+c.crm.escape(q)+'">'+c.crm.escape(r)+"</div>"));h.val("").focus()}var f=this,g=f.$wrapper.find(".email-copy-wrapper"),l=g.find(".email-copy-area"),k=l.find(".email-copy-text"),h=l.find(".email-copy-input"),n=g.find(".deal-participants-area"),m=f.$wrapper.find(".email-copy-wrapper-collapsed");h.autocomplete({source:c.crm.app_url+"?module=autocomplete&emailcomplete=true",
appendTo:f.$wrapper,minLength:0,focus:function(){return!1},select:function(p,q){p=q.item;d(p.id,(p.criteria||{}).email||p.email,'<i class="icon userpic" style="background-image: url('+p.photo_url+');"></i>'+p.name);h.val("");return!1}}).data("ui-autocomplete")._renderItem=function(p,q){return c('<li class="ui-menu-item-html"><div>'+q.value+"</div></li>").appendTo(p)};h.on("focus",function(){h.data("uiAutocomplete").search(h.val())});f.$wrapper.on("click",".js-email-copy-link, .email-copy-text-collapsed",
function(p){p.preventDefault();p=f.$wrapper.find(".js-email-copy-link-icon");g.toggleClass("email-copy-wrapper-block");g.is(":visible")?(p.removeClass("fa-caret-right").addClass("fa-caret-down"),h.focus(),m.removeClass("email-copy-wrapper-collapsed-block")):(p.removeClass("fa-caret-down").addClass("fa-caret-right"),c(".email-copy-text-collapsed").children().length&&m.addClass("email-copy-wrapper-collapsed-block"))});l.on("click",function(){h.focus()});n.on("click",".email-copy-user",function(){var p=
c(this).data("cc-contact-id"),q=c(this).data("cc-email"),r=c(this).html();d(p,q,r)});h.on("focusout",function(p){b()});h.on("keydown",function(p){13==p.keyCode&&(p.preventDefault(),b())});k.on("click",".js-remove-cc",function(p){p.preventDefault();p=c(this).parent(".email-copy-user");var q=p.data("email");p.remove();c(".email-copy-text-collapsed").children('[data-email="'+q+'"]').remove()});h.on("keydown",function(p){if(8==p.keyCode&&0==h.val().length){p=c(".email-copy-text .email-copy-user:last");
var q=p.data("email");p.remove();c(".email-copy-text-collapsed").children('[data-email="'+q+'"]').remove();h.focus()}})};CRMSendEmailDialog.prototype.initSelectDeal=function(){function b(){var m=h.val();k.val("none");m&&c.get("?module=deal&action=byContact&id="+m,function(p){"ok"===p.status&&c.each(p.data.deals,function(q,r){l.prepend('<li><a href="javascript:void(0);" class="js-deal-item" data-deal-id="'+r.id+'"><span class="js-text flexbox"><i class="fas fa-circle funnel-state" style="color: '+
p.data.funnels[r.funnel_id].stages[r.stage_id].color+'"></i><span class="flexbox">'+r.name+"</span></span></a></li>")})},"json")}var d=this,e=d.$form.find(".js-select-deal .js-visible-link .js-text"),f=d.$form.find(".js-select-funnel"),g=d.$wrapper.find(".js-deal-field"),l=d.$form.find(".js-deals-list"),k=d.$form.find(".js-deal-id"),h=d.$to_id,n=d.$form.find(".js-empty-deal");d.$form.on("click",".js-create-new-deal",function(){var m=c(this).find(".js-text").html();f.removeClass("hidden");n.removeClass("c-empty-deal-hidden");
e.html(m);k.val("0")});n.on("click",function(){c(this).addClass("c-empty-deal-hidden");f.addClass("hidden");l.find("li").removeClass("selected");e.html(d.locales.deal_empty);k.val("none")});d.$form.on("click",".js-deal-item",function(){var m=c(this).find(".js-text").html();l.find("li").removeClass("selected");c(this).parent().addClass("selected");e.html(m);n.removeClass("c-empty-deal-hidden");f.addClass("hidden");k.val(c(this).data("deal-id"))});"reply"==d.action&&b();"new"==d.action&&0<h.val()&&
(b(),g.removeClass("hidden"));h.on("change",b);l.on("click",function(){l.hide();setTimeout(function(){l.removeAttr("style")},200)});d.$form.on("change",".js-select-deal-funnel",function(){d.$form.find(".js-select-stage-wrapper").load("?module=deal&action=stagesByFunnel&id="+c(this).val())})};return CRMSendEmailDialog}(jQuery);var CRMSendSmsDialog=function(c){CRMSendSmsDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$textarea=this.$wrapper.find(".js-send-sms-textarea");this.dialog=this.$wrapper.data("dialog");this.success_html=a.success_html;this.error_html=a.error_html;this.hash=a.hash;this.send_action_url=a.send_action_url;var b=!1;window&&window.parent&&window.parent.$&&window.parent.$.crm?b=window.parent.$.crm:window.$&&window.$.crm&&(b=window.$.crm);this.crm=b;this.action=a.action;
this.locales=a.locales||{};this.iframe=a.iframe;this.app_url=a.crm_app_url||this.crm&&this.crm.app_url;if(!this.send_action_url)throw Error("send_action_url option required");this.initClass()};CRMSendSmsDialog.prototype.initClass=function(){this.initSenderSelector();this.initSendMessage();!this.iframe&&this.dialog.resize();if(this.iframe)this.$wrapper.on("click",".js-close-dialog",function(a){a.preventDefault();c(".dialog iframe",window.parent.document)[0].dispatchEvent(new Event("close"))})};CRMSendSmsDialog.prototype.initSenderSelector=
function(){var a=this.$wrapper,b=a.find(".js-specified-sms-sender");a.find(".js-sms-sender-list").change(function(){"specified"===c(this).val()?b.attr("disabled",!1).show():b.attr("disabled",!0).hide()})};CRMSendSmsDialog.prototype.initSendMessage=function(){var a=this,b=!1;a.$form.on("submit",function(d){d.preventDefault();if(!b){b=!0;d=a.$form.find(".js-submit-button");var e=c('<span class="icon loading"><i class="fas fa-spinner wa-animation-spin"></i></span>');d.attr("disabled",!0);e.insertAfter(d);
d=a.send_action_url;e=a.$form.serializeArray();var f=function(g){var l=a.locales.send_error_title||"Send error",k=a.locales.send_error_text||"Can't send sms message",h=c(a.error_html).find(".js-error-text").text(k);a.iframe&&a.$wrapper.find(".dialog-body").html(a.error_html).find(".js-error-text").text(k);a.iframe||c.crm.alert.show({title:l,text:h.get(0).outerHTML,button_class:"red"});g&&console.error(g)};c.post(d,e,function(g){if("ok"===g.status){a.$wrapper.find(".dialog-body").html(a.success_html);
!a.iframe&&a.dialog.resize();var l=null,k=a.dialog.onClose;a.dialog.onClose=function(){k();l&&clearTimeout(l);l=null;a.crm.content.reload()};l=setTimeout(function(){a.iframe?c(".dialog iframe",window.parent.document)[0].dispatchEvent(new Event("close")):a.dialog.close()},2500)}else!a.iframe&&a.dialog.close(),f(g.errors||{})},"json").always(function(){b=!1}).fail(function(g){!a.iframe&&a.dialog.close();f(g)})}})};return CRMSendSmsDialog}(jQuery);var CRMImSourceMessageDialog=function(c){CRMImSourceMessageDialog=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".js-reply-button");this.dialog=this.$wrapper.data("dialog");this.send_dialog=null;this.message=a.message||{};this.locales=a.locales||{};var b=!1;window&&window.parent&&window.parent.$&&window.parent.$.crm?b=window.parent.$.crm:window.$&&window.$.crm&&(b=window.$.crm);this.crm=b;this.app_url=a.crm_app_url||this.crm&&this.crm.app_url;this.initClass()};CRMImSourceMessageDialog.prototype.initClass=
function(){this.initMessageDeleteLink();this.initMessageReplyBtn()};CRMImSourceMessageDialog.prototype.initMessageReplyBtn=function(){function a(k){f.append(g);c.post(b.app_url+"?module=message&action=writeReplyDialog",{id:b.message.id},function(h){c.waDialog({html:h,onOpen:function(n,m){b.send_dialog=m;n.find(".js-cancel-dialog").click(function(){b.send_dialog.hide();e.show()});k&&k()},onClose:function(){b.send_dialog=null;b.dialog&&b.dialog.close();b.dialog=null}})})}var b=this,d=b.$wrapper,e=b.dialog,
f=d.find(".js-dialog-footer"),g=c('<span class="icon size-16"><i class="fas fa-spinner wa-animation-spin custom-mr-4"></i></span>'),l=d.find(".js-reply-button");l.click(function(){l.attr("disabled",!0);var k=function(){g.remove();l.attr("disabled",!1);e.hide()};b.send_dialog?(b.send_dialog.show(),k()):a(function(){k();var h=b.dialog.onClose;b.dialog.onClose=function(){h.apply(this,arguments);b.dialog=null;b.send_dialog&&b.send_dialog.close();b.send_dialog=null}})})};CRMMessageDeleteLinkMixin.mixInFor(CRMImSourceMessageDialog);
return CRMImSourceMessageDialog}(jQuery);var CRMImSourceSendMessageDialog=function(c){CRMImSourceSendMessageDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$button=this.$form.find(":submit");this.dialog=this.$wrapper.data("dialog");this.message=a.message||{};this.locales=a.locales||{};this.success_html=a.success_html||"";var b=!1;window&&window.parent&&window.parent.$&&window.parent.$.crm?b=window.parent.$.crm:window.$&&window.$.crm&&(b=window.$.crm);this.crm=b;this.app_url=a.crm_app_url||this.crm&&
this.crm.app_url;this.send_action_url=a.send_action_url;if(!this.send_action_url)throw Error("send_action_url option required");this.initClass()};CRMImSourceSendMessageDialog.prototype.initClass=function(){this.initSendMessage();this.initErrorCleaner()};CRMImSourceSendMessageDialog.prototype.initErrorCleaner=function(){function a(){b.clearErrors()}var b=this,d=b.$wrapper,e=null;d.on("keydown",":input",function(){e&&clearTimeout(e);e=setTimeout(function(){a()},250)});d.on("change",":input",a)};CRMImSourceSendMessageDialog.prototype.initSendMessage=
function(){var a=this,b=a.$form,d=a.$button;b.on("submit",function(e){function f(k){k&&!c.isEmptyObject(k.errors)?a.showErrors(k.errors):console.error(k?["Server error",k]:"Server error")}e.preventDefault();var g=null,l=c('<span class="icon size-16"><i class="fas fa-spinner wa-animation-spin custom-mr-4"></i></span>');d.attr("disabled",!0).after(l);g&&g.abort();g=c.post(a.send_action_url,a.$form.serializeArray()).done(function(k){if("ok"!==k.status)f(k);else{a.$wrapper.find(".dialog-body").html(a.success_html);
a.dialog.resize();var h=null;a.dialog.onClose=function(){h&&clearTimeout(h);h=null;a.crm.content.reload()};h=setTimeout(function(){a.dialog.close()},2500)}}).fail(f).always(function(){d.attr("disabled",!1);l.remove();g=null})});b.on("click",".js-cancel-dialog",function(){a.$wrapper.css({display:"none"})})};CRMImSourceSendMessageDialog.prototype.showErrors=function(a){var b=this.$wrapper;c.each(a,function(d,e){d=b.find('[name="'+d+'"]');e='<span class="errormsg">'+e+"</span>";d.length?(d.addClass("state-error"),
d.after(e)):b.find(".js-errors-place").append(e)})};CRMImSourceSendMessageDialog.prototype.clearErrors=function(){var a=this.$wrapper;a.find(".state-error").removeClass("state-error");a.find(".errormsg").remove();a.find(".js-errors-place").empty()};return CRMImSourceSendMessageDialog}(jQuery);var CRMContactPage=function(c){CRMContactPage=function(a){this.$wrapper=a.$wrapper;this.$tabsW=this.$wrapper.find(".t-profile-tabs");this.photo_dialog_url=a.photo_dialog_url;this.locales=a.locales;this.contact_id=a.contact_id||!1;this.editable=a.editable||!1;this.initClass()};CRMContactPage.prototype.initClass=function(){this.initTabChange();this.initAddCompanyContactLink();this.initResponsibleLink();this.initClassifyAccessLink();this.initChangePhotoLink();this.initTopInfoFields();this.initEmployee();
this.initAssignTags();this.initSegments();this.initInfoTab();this.editable&&(this.initEditLink(),this.initDeleteLink(),this.initEditableName());this.initRemoveFiles();this.initFixedHeader();this.editInterception();this.deleteInterception();this.initMessage();this.initCall()};CRMContactPage.prototype.editInterception=function(){var a=this,b=location.pathname.replace(c.crm.app_url,"").split("/");c(window).load(function(){0<=b.indexOf("edit")&&a.$wrapper.find(".profile-header-links .js-edit-link").trigger("click")})};
CRMContactPage.prototype.deleteInterception=function(){var a=this,b=location.pathname.replace(c.crm.app_url,"").split("/");c(window).load(function(){0<=b.indexOf("delete")&&a.$wrapper.find(".profile-header-links .js-delete-link").trigger("click")})};CRMContactPage.prototype.initTopInfoFields=function(){var a=this.$wrapper.find(".js-info-list");this.$wrapper.on("click",".js-info-toggle",function(b){b.preventDefault();c(this).toggleClass("is-active");a.slideToggle()})};CRMContactPage.prototype.initChangePhotoLink=
function(){var a=this;a.$wrapper.find(".photo-change-link a").click(function(){c.get(a.photo_dialog_url,function(b){(new CRMDialog({html:b})).$wrapper.on("photo_updated photo_deleted",function(d,e){a.$wrapper.find(".c-userpic").attr("src",e.url)})},"html")})};CRMContactPage.prototype.initTabChange=function(){var a=window.history&&window.history.pushState;this.$wrapper.find(".t-profile-tabs").on("click",".t-tab a",function(b){b.preventDefault();if(a){b=c(this).data("tab-id");var d=window.location.href.match(/^.*\/(id|contact)\/[^\/]+/);
d&&b&&(b=d[0]+"/"+b+"/",history.replaceState({reload:!0,content_uri:b},"",b))}})};CRMContactPage.prototype.initEditLink=function(){var a=this;a.$wrapper.find(".profile-header-links .edit-link").on("click",function(){var d=a.$wrapper.find('.t-tab a[data-tab-id="info"]').closest(".t-tab");c("html, body").animate({scrollTop:d.offset().top},500);a.$wrapper.find(".t-profile-tabs").data("tabs_controller").switchToTab("info",function(e){return"function"===typeof e[0].contentWindow.$.wa.contactEditor.switchMode}).then(function(e){e[0].contentWindow.$.wa.contactEditor.switchMode("edit")})});
var b=a.$wrapper.find(".t-profile-tabs-iframes");b.on("contact_saved",function(d,e){c.crm.content.reload();b.children().hide();a.$wrapper.find(".t-profile-tabs").data("tabs_controller").showTabHtml("__internal",'<div class="block double-padded"><i class="icon16 loading"></i></div>')})};CRMContactPage.prototype.initInfoTab=function(){var a=null;this.$wrapper.find('.t-profile-tabs .t-tab[data-tab-id="info"] a').on("tab_content_updated",function(){a&&clearInterval(a);a=setInterval(function(){var b=c("#c-profile-page .t-profile-tabs-iframes iframe").filter(function(){return"info"==
c(this).data("tab-id")});try{if(!b[0].contentWindow.$.wa.contactEditor)return}catch(g){return}a&&clearInterval(a);a=null;var d=c('script[src*="wa-apps/crm"]:first').attr("src").match(/^(.*\/wa-apps\/crm\/)[^\?]*(\?.*)/),e=d[1],f=d[2];b[0].contentWindow.$("head").append('<link href="'+e+"js/jquery/jquery-ui.css"+f+'" rel="stylesheet" type="text/css">');["js/jquery/jquery-ui.min.js","js/crm.autocomplete.js","js/contact.info.js"].forEach(function(g){b[0].contentWindow.$("head").append('<script src="'+
e+g+f+'">\x3c/script>')})},100)})};CRMContactPage.prototype.initAddCompanyContactLink=function(){this.$wrapper.find(".js-add-company-contact").on("click",function(){c.get(c(this).data("dialog-url"),function(a){new CRMDialog({html:a})})})};CRMContactPage.prototype.initResponsibleLink=function(){this.$wrapper.find(".profile-header-links .responsible-link").on("click",function(){c.get(c(this).data("dialog-url"),function(a){new CRMDialog({remain_after_load:!0,html:a})})})};CRMContactPage.prototype.initDeleteLink=
function(){var a=this.$wrapper,b=a.find(".crm-delete-link"),d=this.contact_id,e=c.crm.app_url+"?module=contactOperation&action=delete",f=a.find(".crm-contact-operation-delete-checking").clone();b.click(function(g){g.preventDefault();new CRMDialog({html:f.show(),onOpen:function(l){var k=this;l.find(".crm-cancel").click(function(){k.close()});c.get(e,{contact_ids:[d],is_contact_page:1},function(h){new CRMDialog({html:h,onOpen:function(){k.close()}})})}})})};CRMContactPage.prototype.initClassifyAccessLink=
function(){this.$wrapper.find(".profile-header-links .classify-access-link").on("click",function(){c.get(c(this).data("dialog-url"),function(a){new CRMDialog({remain_after_load:!0,html:a})})})};CRMContactPage.prototype.initEmployee=function(){var a=this,b=!1;a.$wrapper.on("click",".js-view-employees",function(d){d.preventDefault();a.$tabsW.length&&c("html, body").scrollTop(a.$tabsW.offset().top)});a.$wrapper.on("click",".js-add-employee",function(d){d.preventDefault();d=c.crm.app_url+"?module=contact&action=addEmployee";
var e={company_contact_id:a.contact_id};b&&b.abort();b=c.post(d,e,function(f){new CRMDialog({html:f})})})};CRMContactPage.prototype.initAssignTags=function(){var a=this.$wrapper.find(".crm-contact-assign-tags"),b=c.crm.app_url+"?module=contactOperation&action=assignTags&is_assign=1",d=parseInt(this.contact_id)||0;a.click(function(e){e.preventDefault();c.get(b,{contact_ids:[d]},function(f){new CRMDialog({html:f})})})};CRMContactPage.prototype.initSegments=function(){function a(l){var k=b.$wrapper.find(".js-segment-list"),
h=k.find("a").length;l.length||l.push({id:!1,name:b.locales.no_segments});c.each(l,function(n,m){n="javascript:void(0);";var p="",q='<span class="hint">'+m.name+"</span>";m.id&&(n=c.crm.app_url+"contact/segment/"+m.id+"/",p='<i class="icon16 '+(m.icon?m.icon:"folder-dynamic")+'"></i>',q="<span>"+m.name+"</span>");m='<a href="'+n+'">'+p+q+"</a>";h&&(m=","+m);k.append(m);h=!0})}var b=this,d=b.$wrapper.find(".crm-contact-assign-segments"),e=c.crm.app_url+"?module=contactOperation&action=addToSegments&is_assign=1",
f=parseInt(b.contact_id)||0;d.click(function(l){l.preventDefault();c.get(e,{contact_ids:[f]},function(k){new CRMDialog({html:k,onOpen:function(h){new CRMContactsOperationAddToSegments({$wrapper:h,context:{contact_ids:[f]},is_assign:1})}})})});var g=!1;b.$wrapper.on("click",".js-show-dynamic-segments",function(l){l.preventDefault();var k=c(this);k.find(".icon16").removeClass("folder-dynamic").addClass("loading");g&&g.abort();g=c.post("?module=contact&action=segmentSearch",{id:b.contact_id},function(h){"ok"==
h.status&&(a(h.data.segments),k.remove())}).always(function(){g=!1})})};CRMContactPage.prototype.initEditableName=function(){var a=this.$wrapper.find(".js-name-editable").first();if(!(0>=a.length)){var b=this.contact_id;new CrmEditable({$wrapper:a,saveChanged:!0,saveNonempty:!0,placeholder:a.data("editable-placeholder"),onSave:function(d){if(!d.isLoading())if(d.isChanged()&&c.trim(d.getText())){d.loading();var e=d.getText();c.post(c.crm.app_url+"?module=contact&action=profileSave",{data:JSON.stringify({name:e}),
id:b}).always(function(){d.setText(e);d.loading(!1).hide();c.crm.content.reload()})}else d.hide()}})}};CRMContactPage.prototype.initRemoveFiles=function(){function a(d,e){c.post("?module=file&action=delete",{id:d},function(f){"ok"==f.status?e.remove():console&&console.log&&console.log("File Remove Error")})}var b=this;b.$wrapper.find(".js-files-list").on("click",".js-remove-file",function(d){d.preventDefault();var e=c(this).closest(".c-file");d=e.find(".c-name").text();var f=parseInt(e.data("id"));
0<f?c.crm.confirm.show({title:b.locales.remove_file_title,text:b.locales.remove_file_text.replace(/%s/,d),button:b.locales.remove_file_button,onConfirm:function(){a(f,e)}}):console&&console.log&&console.log("File ID is empty")})};CRMContactPage.prototype.initFixedHeader=function(){function a(){if(c.contains(document,e[0])){var k=b.scrollTop();k>f.top+70?(e.css({left:f.left,width:d.outerWidth()+"px"}).addClass("is-fixed"),k>f.top+d.outerHeight()-e.outerHeight()?e.removeClass("is-hover").css("background",
g):(k="linear-gradient(to bottom, "+g+" 0%, "+g+" 70%, rgba("+l.join(",")+") 100%)",e.addClass("is-hover").css("background",k)),d.addClass("is-over")):(e.removeAttr("style").removeClass("is-fixed"),d.removeClass("is-over"))}else b.off("scroll",a)}var b=c(window),d=this.$wrapper.find(".js-profile"),e=this.$wrapper.find(".js-short-profile"),f=d.offset(),g=d.css("background-color"),l=g.replace("rgba(","").replace("rgb(","").replace(")","").split(",");l=c.map(l,function(k){return parseInt(k)});3>=l.length?
l.push(0):l[3]=0;e.on("click",".js-short-responsible-link",function(){d.find(".profile-header-links .js-responsible-link").trigger("click")});e.on("click",".js-short-access-link",function(){d.find(".profile-header-links .js-access-link").trigger("click")});e.on("click",".js-short-edit-link",function(){d.find(".profile-header-links .js-edit-link").trigger("click")});e.on("click",".js-short-delete-link",function(){d.find(".profile-header-links .js-delete-link").trigger("click")});b.on("scroll",a)};
CRMContactPage.prototype.initMessage=function(){this.initSendEmail();this.initSendSMS()};CRMContactPage.prototype.initSendEmail=function(){var a=!1;this.$wrapper.on("click",".js-show-message-dialog",function(b){b.preventDefault();var d=c(this);b=d.data("id");d=d.data("email");!a&&b&&(a=!0,c.post("?module=message&action=writeNewDialog",{contact_id:b,email:d},function(e){new CRMDialog({html:e})}).always(function(){a=!1}))})};CRMContactPage.prototype.initSendSMS=function(){var a=!1;this.$wrapper.on("click",
".js-show-send-sms-dialog",function(b){b.preventDefault();var d=c(this);b=d.data("id");d=d.data("phone");!a&&b&&(a=!0,c.get("?module=message&action=writeSMSNewDialog",{contact_id:b,phone:d},function(e){new CRMDialog({html:e})}).always(function(){a=!1}))})};CRMContactPage.prototype.initCall=function(){var a=!1;this.$wrapper.on("click",".js-show-call-dialog",function(b){b.preventDefault();var d=c(this);b=d.data("id");d=d.data("phone");!a&&b&&d&&(a=!0,c.post("?module=call&action=initContactDialog",{contact_id:b,
phone:d},function(e){new CRMDialog({remain_after_load:!0,html:e})}).always(function(){a=!1}))})};return CRMContactPage}(jQuery),CRMNewContactPage=function(c){CRMNewContactPage=function(a){this.$wrapper=a.$wrapper;this.$contactSection=this.$wrapper.find(".js-contact-section");this.$accessSection=this.$wrapper.find(".js-access-section");this.$segmentsSection=this.$wrapper.find(".js-segments-section");this.$dealSection=this.$wrapper.find(".js-deal-section");this.$errorsSection=this.$wrapper.find(".js-errors-section");
this.$extendedFieldsW=this.$wrapper.find(".js-contact-extended-fields");this.call_id=a.call_id;this.funnels=a.funnels;this.locales=a.locales;this.contact_data=a.contact_data;this.stage_template_html=a.stage_template_html;this.extended_fields=a.extended_fields||{};this.is_extended=a.is_extended||!1;this.create_deal=this.selected_segments=!1;this.initClass()};CRMNewContactPage.prototype.initClass=function(){c.crm.renderSVG(this.$wrapper);this.contact_data&&this.setContactData(this.contact_data);this.initContactToggle();
this.initAccessToggle();this.initSegmentsToggle();this.initDealToggle();this.initDealSection();this.$extendedFieldsW.length&&this.initExtendedFields();this.initCreate();this.initHeaderActions();this.initWYSIWYG();this.initContactUpdateDialog()};CRMNewContactPage.prototype.initContactToggle=function(){var a=this;a.$contactSection.on("click",".js-extended-toggle",function(b){b.preventDefault();a.$contactSection.hasClass("is-extended")?(a.$contactSection.removeClass("is-extended"),a.is_extended=!1):
(a.$contactSection.addClass("is-extended"),a.is_extended=!0)})};CRMNewContactPage.prototype.initAccessToggle=function(){var a=this,b=a.$accessSection.find(".js-ibutton");b.iButton({labelOn:"",labelOff:"",classContainer:"c-ibutton ibutton-container mini"});b.on("change",function(){"checked"===b.attr("checked")?(a.$accessSection.addClass("is-extended"),a.selected_access=!0):(a.$accessSection.removeClass("is-extended"),a.selected_access=!1)})};CRMNewContactPage.prototype.initSegmentsToggle=function(){var a=
this,b=a.$segmentsSection.find(".js-ibutton");b.iButton({labelOn:"",labelOff:"",classContainer:"c-ibutton ibutton-container mini"});b.on("change",function(){"checked"===b.attr("checked")?(a.$segmentsSection.addClass("is-extended"),a.selected_segments=!0):(a.$segmentsSection.removeClass("is-extended"),a.selected_segments=!1)})};CRMNewContactPage.prototype.initDealToggle=function(){var a=this,b=a.$dealSection.find(".js-ibutton");b.iButton({labelOn:"",labelOff:"",classContainer:"c-ibutton ibutton-container mini"});
b.on("change",function(){"checked"===b.attr("checked")?(a.$dealSection.addClass("is-extended"),a.create_deal=!0):(a.$dealSection.removeClass("is-extended"),a.create_deal=!1)})};CRMNewContactPage.prototype.initDealSection=function(){var a=this,b=a.$wrapper.find(".js-funnels-list");(function(){var d=b.find(".js-visible-link"),e=b.find(".js-field"),f=b.find(".menu-v");f.on("click","a",function(){var g=c(this);d.find(".js-text").html(g.html());f.find(".selected").removeClass("selected");g.closest("li").addClass("selected");
f.hide();setTimeout(function(){f.removeAttr("style")},200);g=g.data("id");e.val(g).trigger("change");(g=a.funnels[g]||!1)&&b.trigger("changeFunnel",g)});c.crm.renderSVG(b)})();(function(){function d(h){k.html("");c.each(h,function(n,m){n=a.stage_template_html;var p=c("<div />").text(m.name).html();n=n.replace("%id%",m.id).replace("%color%",m.color).replace("%name%",p);m=c(n);k.append(m)});c.crm.renderSVG(f);k.find("li:first-child a").trigger("click")}var e=a.$wrapper.find(".js-funnels-list"),f=a.$wrapper.find(".js-funnel-stages-list"),
g=f.find(".js-visible-link"),l=f.find(".js-field"),k=f.find(".menu-v");k.on("click","a",function(){var h=c(this);g.find(".js-text").html(h.html());k.find(".selected").removeClass("selected");h.closest("li").addClass("selected");k.hide();setTimeout(function(){k.removeAttr("style")},200);h=h.data("id");l.val(h)});e.on("changeFunnel",function(h,n){d(n.stages)})})();(function(){function d(){var l=c.datepicker._defaults.dateFormat,k=!1;try{c.datepicker.parseDate(l,f.val()),k=!0}catch(h){}k?(f.data("last-correct-value",
f.val()),g.data("last-correct-value",g.val())):(f.val(f.data("last-correct-value")||""),g.val(g.data("last-correct-value")||""))}var e=a.$wrapper.find(".js-datepicker-wrapper"),f=e.find(".js-datepicker"),g=e.find('[name="deal[expected_date]"]');f.datepicker({altField:g,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,onSelect:d});f.on("blur",d);f.on("keydown keypress keyup",function(l){13===l.which&&l.preventDefault()});e.on("click",".js-icon",function(){f.focus()})})();(function(){var d=a.$wrapper.find(".js-contact-block"),
e=d.find(".js-view-toggle"),f=e.find(".is-active");e.on("click",".c-toggle",function(g){g.preventDefault();g=c(this);var l=g.data("id");if(g.hasClass("is-active"))return!1;a.contact_mode=l;f.length&&f.removeClass("is-active");g.addClass("is-active");f=g;d.find(".c-hidden.is-active").removeClass("is-active");d.find(".c-hidden-"+l).addClass("is-active")})})()};CRMNewContactPage.prototype.initCreate=function(){function a(){function g(){var m=e.$wrapper.find(".js-option-field:checked"),p=e.$wrapper.find(".js-vault-toggle"),
q=e.$wrapper.find(".js-owners-list");m.length&&(m=m.val(),"vaults"===m?(p=p.find(".js-field").val(),n.data.push({name:"vault_id",value:p})):"owners"===m&&(p=q.find(".c-owner"),p.length||n.errors.push({name:"owner[autocomplete]"}),p.each(function(){var r=c(this).data("id");0<r&&n.data.push({name:"owners[]",value:r})})))}function l(){var m=e.$segmentsSection.find("form").serializeArray();c.each(m,function(p,q){n.data.push(q)})}function k(){var m=e.$dealSection.find("form").serializeArray(),p=!0;c.each(m,
function(q,r){n.data.push(r);0<c.trim(r.value).length&&"deal[name]"===r.name&&(p=!1)});p&&n.errors.push({name:"deal[name]",value:e.locales.empty_deal_name})}function h(){var m=e.$extendedFieldsW.data("getFormData")();c.each(m.data,function(p,q){n.data.push(q)});c.each(m.errors,function(p,q){n.errors.push(q)})}var n={data:[],errors:[]};(function(){var m=e.$contactSection.find("form.c-general-form"),p=m.find(".js-phone-list"),q=m.find(".js-email-list");p.find("li .js-value, li .js-ext").removeAttr("name");
q.find("li .js-value, li .js-ext").removeAttr("name");m=m.serializeArray();var r=["contact[firstname]","contact[middlename]","contact[lastname]","contact[name]"],u=!0;c.each(m,function(v,t){t.value=c.trim(t.value);n.data.push(t);0<c.trim(t.value).length&&0<=r.indexOf(t.name)&&(u=!1)});u&&(m=e.$contactSection.find('[name="contact[firstname]"]'),m.length?n.errors.push({name:"contact[firstname]",value:e.locales.empty_contact_name}):(m=e.$contactSection.find('[name="contact[name]"]'),m.length&&n.errors.push({name:"contact[name]",
value:e.locales.empty_contact_name})));p.find("li").each(function(v){var t=c(this),w=t.find(".js-value");t=t.find(".js-ext");var x=w.val(),y=t.val();if(x){var z="contact[phone]["+v+"][value]";w.attr("name",z);n.data.push({name:z,value:x});v="contact[phone]["+v+"][ext]";t.attr("name",v);n.data.push({name:v,value:y})}});q.find("li").each(function(v){var t=c(this),w=t.find(".js-value");t=t.find(".js-ext");var x=w.val(),y=t.val();if(x){var z="contact[email]["+v+"][value]";w.attr("name",z);n.data.push({name:z,
value:x});v="contact[email]["+v+"][ext]";t.attr("name",v);n.data.push({name:v,value:y})}})})();e.$extendedFieldsW.length&&e.is_extended&&h();e.selected_access&&g();e.selected_segments&&l();e.create_deal&&k();return n}function b(g,l){l=l?l:[];g&&(l=g);c.each(l,function(k,h){k=h.value;var n=e.$wrapper.find(':input[name="'+h.name+'"]'),m=c("<div />").addClass("errormsg").text(k);n.length?n.hasClass("error")||(n.parent().append(m),n.addClass("error").one("focus click change",function(){n.removeClass("error");
m.remove()})):e.$errorsSection.append(m)})}function d(g){f||(f=!0,c.post("?module=contact&action=newSave",g,function(l){"ok"===l.status?c.crm.content.load(c.crm.app_url+"contact/"+l.data.contact.id+"/"):b(l.errors)},"json").always(function(){f=!1}))}var e=this,f=!1;e.$wrapper.on("click",".js-submit-form",function(g){g.preventDefault();e.$errorsSection.html("");g=a();g.errors.length?b(!1,g.errors):d(g.data)})};CRMNewContactPage.prototype.initExtendedFields=function(){function a(f){f=f||{};var g=b.$wrapper,
l="c-conditional-field-"+(""+Math.random()).slice(2),k=f.input_name;f.parent_field=f.parent_field||"";f.parent_options=f.parent_options||{};f.index=f.index||0;if(f.parent_field&&!c.isEmptyObject(f.parent_options)){var h=f.parent_field.split(":");if(!(1>=h.length)){h='[name="contact['+h[0]+"]["+f.index+"]["+h[1]+']"]';var n=g.find(h);if(!(0>=n.length)){f.show_empty_option=f.required;var m=f.parent_options,p=g.find(':input[name="'+k+'"]').first();if(!(0>=p.length)){if(p.is("input"))var q=p.next();else q=
p,p=q.prev();var r=function(){p[0].hasAttribute("name")||(p.attr("name",q.attr("name")),q[0].removeAttribute("name"));p.show().val("");q.hide()};g=function(){var u=p.is(":visible")?p.val():q.val();var v=c(this).val().toLowerCase();f.hide_unmatched&&p.closest(".field").show();if(m&&m[v]){v=m[v];p.hide();q.show().children().remove();f.show_empty_option&&q.append(c('<option value=""></option>'));for(var t=0;t<v.length;t++)q.append(c("<option></option>").attr("value",v[t]).text(v[t]));q.val(u);p[0].hasAttribute("name")&&
(q.attr("name",p.attr("name")),p[0].removeAttribute("name"))}else f.hide_unmatched?(r(),p.val(""),p.closest(".field").hide()):p.is(":visible")||(r(),p.val(u))};g.call(n);k=n.closest(".field");k.length?(k.off("."+l),k.on("change."+l,h,g)):(n.off("."+l),n.on("change."+l,g))}}}}}var b=this,d=b.$extendedFieldsW,e=d.find("form");(function(){var f=d.find(".js-dynamic-field-wrapper");f.each(function(){var g=c(this),l=g.find(".js-list"),k=l.find(".c-item")[0].outerHTML;g.on("click",".js-add",function(){l.append(k)});
g.on("click",".js-remove",function(){c(this).closest(".c-item").remove()});l.on("change",".js-ext-toggle",function(){var h=c(this),n=h.closest(".c-item").find(".js-ext-field");"custom"===h.val()?n.attr("disabled",!1).show():n.attr("disabled",!0).hide()})});d.on("prepareSave",function(){f.each(function(){c(this).find(".js-list").find(".c-item").each(function(g){c(this).find("[data-name-pattern]").each(function(){var l=c(this),k=l.data("name-pattern");k&&(k=k.replace("%index%",g),l.attr("name",k))})})})})})();
(function(){function f(g){function l(){h.each(function(){c(this).find(".js-address-wrapper").each(function(m){c(this).find("[data-name-pattern]").each(function(){var p=c(this),q=p.data("name-pattern");if(q&&(q=q.replace("%index%",m),p.attr("name",q),p.is("input"))){var r=p.closest(".js-custom-sub-field-line");r.is('[data-type="Conditional"]')&&(p=r.data("field-id"),r=r.data("subfield-id"),(p=k[p].fields[r])&&a(c.extend(p,{input_name:q,index:m})))}})})})}(function(){g.find(".js-custom-sub-field-line").each(function(){var m=
c(this),p=m.data("name-pattern");m.find(":input").each(function(){var q=c(this);q.attr("data-name-pattern",p);q.removeAttr("name")})});g.find('.js-custom-sub-field-line[data-type="Select"]').each(function(){var m=c(this);m.data("sub-type")||m.find("select").find('option[value=""]').text(m.data("label")+"...")});g.find('.js-custom-sub-field-line[data-type="Checkbox"]').each(function(){var m=c(this),p=m.find(":checkbox");p.wrap("<label>");p=p.parent();p.append("<span>");p.find("span").append(" "+m.data("label"))})})();
var k=b.extended_fields||{},h=g.find(".js-address-list"),n=g.find(".js-address-wrapper")[0].outerHTML;d.on("prepareSave",l);l();g.on("click",".js-add",function(){h.append(n);l()});g.on("click",".js-remove",function(){c(this).closest(".js-address-wrapper").remove()});g.on("click",".js-clear-selected-radio-value",function(){c(this).closest(".js-custom-sub-field-line").find(":radio:checked").attr("checked",!1)});g.on("change",".js-ext-toggle",function(){var m=c(this),p=m.closest(".js-address-wrapper").find(".js-ext-field");
"custom"===m.val()?p.attr("disabled",!1).show():p.attr("disabled",!0).hide()});g.on("change",".js-country-toggle",function(){function m(){w&&w.abort();w=c.post(c.crm.backend_url+"?module=profile&action=regions",{country:t},function(x){"ok"===x.status&&(c.isEmptyObject(x.data.options)?p(!1):p(x.data))}).always(function(){w=!1})}function p(x){u.html("");v.val("");x&&Object.keys(x).length?(u.attr("disabled",!1).show(),v.attr("disabled",!0).hide(),c.each(x.oOrder,function(y,z){(y=x.options[z])&&u.append('<option value="'+
z+'">'+y+"</option>")})):(u.attr("disabled",!0).hide(),v.attr("disabled",!1).show())}var q=c(this),r=q.closest(".js-address-wrapper"),u=r.find(".js-region-select"),v=r.find(".js-region-field"),t=q.val(),w=!1;t?m(t):p(!1)})}d.find(".js-address-section").each(function(){f(c(this))})})();(function(){var f=d.find(".js-bank-section");if(!f.length)return!1;var g=f.find(".js-bank-list"),l=f.find(".js-bank-wrapper")[0].outerHTML;f.on("click",".js-add",function(){g.append(l)});g.on("click",".js-remove",function(){c(this).closest(".js-bank-wrapper").remove()});
f.on("change",".js-ext-toggle",function(){var k=c(this),h=k.closest(".js-bank-wrapper").find(".js-ext-field");"custom"===k.val()?h.attr("disabled",!1).show():h.attr("disabled",!0).hide()});d.on("prepareSave",function(){g.each(function(){c(this).find(".js-bank-wrapper").each(function(k){c(this).find("[data-name-pattern]").each(function(){var h=c(this),n=h.data("name-pattern");n&&(n=n.replace("%index%",k),h.attr("name",n))})})})})})();(function(){d.find(".js-datepicker input:text").each(function(){function f(){try{c.datepicker.parseDate(c.datepicker._defaults.dateFormat,
g.val()),g.data("last-correct-value",g.val()),l.data("last-correct-value",l.val())}catch(k){g.val(g.data("last-correct-value")||""),l.val(l.data("last-correct-value")||"")}}var g=c(this),l=g.siblings('input[type="hidden"]');g.datepicker({altField:l,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,onSelect:f});g.on("blur",f);g.on("keydown keypress keyup",function(k){13===k.which&&k.preventDefault()})})})();d.data("getFormData",function(){d.trigger("prepareSave");var f=e.serializeArray(),g={data:[],
errors:[]};c.each(f,function(l,k){g.data.push(k)});return g})};CRMNewContactPage.prototype.setContactData=function(a){var b=this;c.each(a,function(d,e){"string"===typeof e||"number"===typeof e?(d=b.$wrapper.find('[name="contact['+d+']"]'),d.length&&d.val(e).trigger("change")):("phone"===d&&c.each(e,function(f,g){f={number:g.value,ext:g.ext};c(document).trigger("addContactPhone",f)}),"email"===d&&c.each(e,function(f,g){f={name:g.value,ext:g.ext};c(document).trigger("addContactEmail",f)}))})};CRMNewContactPage.prototype.initHeaderActions=
function(){function a(){b||(b=!0,c.post("?module=contact&action=createSettings",{},function(d){new CRMDialog({html:d})}).always(function(){b=!1}))}var b=!1;this.$wrapper.on("click",".js-show-personal-settings-dialog",function(d){d.preventDefault();a()})};CRMNewContactPage.prototype.initWYSIWYG=function(){var a=this.$wrapper.find(".js-wysiwyg");if(!a.length)return!1;a.each(function(){var b=c(this);c.crm.initWYSIWYG(b,{keydownCallback:function(d){}})})};CRMNewContactPage.prototype.initContactUpdateDialog=
function(){function a(){d||(d=!0,c.post(c.crm.app_url+"?module=contact&action=updateDialog",{call_id:b.call_id},function(e){new CRMDialog({html:e})}).always(function(){d=!1}))}var b=this,d=!1;b.$wrapper.on("click",".js-show-update-dialog",function(e){e.preventDefault();a()})};return CRMNewContactPage}(jQuery),CRMContactAccessDialogNew=function(c){CRMContactAccessDialogNew=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$optionsList=this.$wrapper.find(".js-options-list");
this.$vaultsToggle=this.$wrapper.find(".js-vault-toggle");this.$ownersList=this.$wrapper.find(".js-owners-list");this.$submitButton=this.$wrapper.find(".js-save");this.$errorsPlace=this.$wrapper.find(".js-errors-place");this.dialog=this.$wrapper.data("dialog");this.owner_template_html=a.owner_template_html;this.contact_id=a.contact_id;this.owners=a.owners;this.locales=a.locales;this.initClass()};CRMContactAccessDialogNew.prototype.initClass=function(){this.initChangeOptions();this.initAutocomplete();
this.initVaultToggle()};CRMContactAccessDialogNew.prototype.initChangeOptions=function(){var a=this.$optionsList.find(".c-option.is-active");this.$optionsList.on("change",".js-option-field",function(){var b=c(this),d=b.closest(".c-option");"checked"===b.attr("checked")&&(a.length&&a.removeClass("is-active"),a=d.addClass("is-active"))})};CRMContactAccessDialogNew.prototype.initAutocomplete=function(){function a(e){e.addClass("highlighted");setTimeout(function(){e.removeClass("highlighted")},2E3)}var b=
this,d=b.$ownersList.find(".js-autocomplete");d.autocomplete({source:c.crm.app_url+"?module=autocomplete&type=user",appendTo:b.$wrapper,minLength:0,focus:function(){return!1},select:function(e,f){e=b.$ownersList.find('.c-owner[data-id="'+f.item.id+'"]');e=e.length?e:void 0;if(!e){var g=f.item;e=b.owner_template_html;f=g.photo_url;e=e.replace(/%id%/,g.id);var l=e.replace;g=g.name;g=c("<div></div>").text(g).html();e=l.call(e,"%name%",g).replace("%photo_url%",f);f=c(e);b.$ownersList.append(f);e=f}a(e);
d.val("");return!1}}).data("ui-autocomplete")._renderItem=function(e,f){return c('<li class="ui-menu-item-html"><div>'+f.value+"</div></li>").appendTo(e)};d.on("focus",function(){d.data("uiAutocomplete").search(d.val())});b.$ownersList.on("click",".js-delete-owner",function(){c(this).closest(".c-owner").remove()})};CRMContactAccessDialogNew.prototype.initVaultToggle=function(){var a=this.$vaultsToggle,b=a.find(".js-visible-link"),d=a.find(".js-field"),e=a.find(".menu-v");e.on("click","a",function(){var f=
c(this);b.find(".js-text").html(f.html());e.find(".selected").removeClass("selected");f.closest("li").addClass("selected");e.hide();setTimeout(function(){e.removeAttr("style")},200);f=f.data("id");d.val(f)});c.crm.renderSVG(a)};return CRMContactAccessDialogNew}(jQuery),CRMContactResponsibleDialog=function(c){CRMContactResponsibleDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$responsibleList=this.$wrapper.find(".js-responsible-list");this.$submitButton=this.$wrapper.find(".js-save");
this.dialog=this.$wrapper.data("dialog");this.locales=a.locales;this.responsible_template_html=a.responsible_template_html;this.initClass()};CRMContactResponsibleDialog.prototype.initClass=function(){var a=this;a.$wrapper.on("change","input",function(){a.toggleButton(!0)});a.initSubmit();a.initClearResponsible();a.initAutocomplete()};CRMContactResponsibleDialog.prototype.initSubmit=function(){function a(){if(!e){e=!0;var f=c.crm.app_url+"?module=contact&action=responsibleSave",g=b();if(!g)return e=
!1;var l=c('<span class="icon loading"><i class="fas fa-spinner wa-animation-spin"></i></span>');l.appendTo(d.$submitButton.parent());d.$submitButton.attr("disabled",!0);c.post(f,g,function(k){"ok"===k.data.result?c.crm.content.reload().then(function(){d.dialog.close()}):"no_vault_access"===k.data.result&&(c(".no-access-error").html(k.data.message),setTimeout(function(){d.dialog.close()},5E3))},"json").always(function(){d.$submitButton.attr("disabled",!1);d.toggleButton(!1);l.remove();e=!1})}}function b(){var f=
c("#contact_id").val(),g=c("#responsible_id").val();return{contact_id:f,responsible_id:g}}var d=this,e=!1;d.$form.on("submit",function(f){f.preventDefault();a()})};CRMContactResponsibleDialog.prototype.initClearResponsible=function(){function a(){var e=c.crm.app_url+"?module=contact&action=responsibleSave",f={contact_id:c("#contact_id").attr("value"),responsible_id:0},g=c('<span class="icon loading"><i class="fas fa-spinner wa-animation-spin"></i></span>');g.appendTo(d.$submitButton.parent());d.$submitButton.attr("disabled",
!0);c.post(e,f,function(l){"ok"===l.status?c.crm.content.reload().then(function(){d.dialog.close()}):(console.log("Error saving Responsible contact classification: "+arguments[2],arguments),b("Error saving Responsible contact classification: "+arguments[2]))},"json").always(function(){d.$submitButton.attr("disabled",!1);d.toggleButton(!1);g.remove()})}function b(e){e=c('<div class="errormsg" />').text(e);d.$errorsPlace.append(e)}var d=this;d.$wrapper.on("click",".js-clear-responsible",function(e){e.preventDefault();
c.crm.confirm.show({title:d.locales.clear_responsible_title,text:d.locales.clear_responsible_text,button:d.locales.clear_responsible_button,onConfirm:a})})};CRMContactResponsibleDialog.prototype.initAutocomplete=function(){function a(f){f.addClass("highlighted");setTimeout(function(){f.removeClass("highlighted")},2E3)}var b=this,d=c("#contact_id").val(),e=b.$responsibleList.find(".js-autocomplete");e.autocomplete({source:c.crm.app_url+"?module=autocomplete&type=user&contact_id="+d,appendTo:b.$wrapper,
minLength:0,focus:function(){return!1},select:function(f,g){f=b.$responsibleList.find('.c-responsible[data-id="'+g.item.id+'"]');f=f.length?f:void 0;if(!f){g=g.item;var l=b.responsible_template_html;f=g.photo_url;l=l.replace(/%id%/,g.id);var k=l.replace;var h=g.name;h=c("<div></div>").text(h).html();l=k.call(l,"%name%",h).replace("%photo_url%",f);c("#responsible_id").val(g.id);g=c(l);b.$responsibleList.append(g);c(".js-input").css("display","none");b.$submitButton.attr("disabled",!1);b.toggleButton(!0);
f=g}a(f);b.toggleButton(!0);e.val("");return!1}}).data("ui-autocomplete")._renderItem=function(f,g){var l=c("<li />");l.addClass("ui-menu-item-html").append("<div>"+g.value+"</div>").appendTo(f);g.rights||(l.addClass("is-locked"),l.on("click",function(k){k.preventDefault();k.stopPropagation()}));return l};e.on("focus",function(){e.data("uiAutocomplete").search(e.val())});b.$responsibleList.on("click",".js-delete-responsible",function(){c(this).closest(".c-responsible").remove();c("#responsible_id").val("");
c(".js-input").css("display","");c(".js-autocomplete").focus();b.$submitButton.attr("disabled",!0);b.toggleButton(!0)})};CRMContactResponsibleDialog.prototype.toggleButton=function(a){var b=this.$submitButton;a?b.addClass("yellow"):b.removeClass("yellow")};return CRMContactResponsibleDialog}(jQuery),CRMContactAccessDialog=function(c){CRMContactAccessDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$optionsList=this.$wrapper.find(".js-options-list");this.$vaultsToggle=
this.$wrapper.find(".js-vault-toggle");this.$ownersList=this.$wrapper.find(".js-owners-list");this.$submitButton=this.$wrapper.find(".js-save");this.$errorsPlace=this.$wrapper.find(".js-errors-place");this.dialog=this.$wrapper.data("dialog");this.owner_template_html=a.owner_template_html;this.contact_id=a.contact_id;this.owners=a.owners;this.locales=a.locales;this.initClass()};CRMContactAccessDialog.prototype.initClass=function(){var a=this;a.$wrapper.on("change","input",function(){a.toggleButton(!0)});
a.initChangeOptions();a.initSubmit();a.initAutocomplete();a.initVaultToggle()};CRMContactAccessDialog.prototype.initSubmit=function(){function a(){if(!f){f=!0;e.$errorsPlace.html("");var g=c.crm.app_url+"?module=contact&action=accessSave",l=b();if(!l)return f=!1;var k=c('<span class="icon loading"><i class="fas fa-spinner wa-animation-spin"></i></span>');k.appendTo(e.$submitButton.parent());e.$submitButton.attr("disabled",!0);c.post(g,l,function(h){"ok"===h.status?c.crm.content.reload().then(function(){e.dialog.close()}):
(console.log("Error saving contact access classification: "+arguments[2],arguments),d("Error saving contact access classification: "+arguments[2]))},"json").always(function(){e.$submitButton.attr("disabled",!1);k.remove();e.toggleButton(!1);f=!1})}}function b(){var g=[],l=e.$wrapper.find(".js-option-field:checked");if(l.length){l=l.val();if("vaults"===l){var k=e.$vaultsToggle.find(".js-field").val();g.push({name:"vault_id",value:k})}if("owners"===l){k=e.$ownersList.find(".c-owner");if(!k.length)return d(e.locales.empty_owner),
!1;k.each(function(){var h=c(this).data("id");0<h&&g.push({name:"owners[]",value:h})})}"all"===l&&g.push({name:"vault_id",value:"0"});l=e.$wrapper.find(".js-employees-field");l.length&&"checked"===l.attr("checked")&&g.push({name:"employees",value:"on"});g.push({name:"contact_id",value:e.contact_id})}return g}function d(g){g=c('<div class="errormsg" />').text(g);e.$errorsPlace.append(g)}var e=this,f=!1;e.$form.on("submit",function(g){g.preventDefault();a()})};CRMContactAccessDialog.prototype.initChangeOptions=
function(){var a=this,b=a.$optionsList.find(".c-option.is-active");a.$optionsList.on("change",".js-option-field",function(){var d=c(this),e=d.closest(".c-option");"checked"===d.attr("checked")&&(b.length&&b.removeClass("is-active"),b=e.addClass("is-active"));a.dialog.resize()})};CRMContactAccessDialog.prototype.initAutocomplete=function(){function a(e){e.addClass("highlighted");setTimeout(function(){e.removeClass("highlighted")},2E3)}var b=this,d=b.$ownersList.find(".js-autocomplete");d.autocomplete({source:c.crm.app_url+
"?module=autocomplete&type=user",appendTo:b.$wrapper,minLength:0,focus:function(){return!1},select:function(e,f){e=b.$ownersList.find('.c-owner[data-id="'+f.item.id+'"]');e=e.length?e:void 0;if(!e){var g=f.item;e=b.owner_template_html;f=g.photo_url;e=e.replace(/%id%/g,g.id);var l=e.replace;g=g.name;g=c("<div></div>").text(g).html();e=l.call(e,"%name%",g).replace("%photo_url%",f);f=c(e);b.$ownersList.append(f);b.dialog.resize();e=f}a(e);b.toggleButton(!0);d.val("");return!1}}).data("ui-autocomplete")._renderItem=
function(e,f){return c('<li class="ui-menu-item-html"><div>'+f.value+"</div></li>").appendTo(e)};d.on("focus",function(){d.data("uiAutocomplete").search(d.val())});b.$ownersList.on("click",".js-delete-owner",function(){c(this).closest(".c-owner").remove();b.toggleButton(!0)})};CRMContactAccessDialog.prototype.toggleButton=function(a){var b=this.$submitButton;a?b.removeClass("green").addClass("yellow"):b.removeClass("yellow").addClass("green")};CRMContactAccessDialog.prototype.initVaultToggle=function(){var a=
this.$vaultsToggle,b=a.find(".js-visible-link"),d=a.find(".js-field"),e=a.find(".menu-v");e.on("click","a",function(){var f=c(this);b.find(".js-text").html(f.html());e.find(".selected").removeClass("selected");f.closest("li").addClass("selected");e.hide();setTimeout(function(){e.removeAttr("style")},200);f=f.data("id");d.val(f)});c.crm.renderSVG(a)};return CRMContactAccessDialog}(jQuery),CRMContactCreateSettings=function(c){CRMContactCreateSettings=function(a){this.$wrapper=a.$wrapper;this.$form=
this.$wrapper.find("form");this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMContactCreateSettings.prototype.initClass=function(){this.initSave()};CRMContactCreateSettings.prototype.initSave=function(){function a(){var g={data:[],errors:[]},l=e.serializeArray();c.each(l,function(k,h){g.data.push(h)});return g}function b(g){f||(f=!0,c.post("?module=contact&action=createSettingsSave",g,function(l){"ok"===l.status?d.dialog.close():(l=(l=l.errors)?l:[],console.log(l))},"json").always(function(){f=
!1}))}var d=this,e=d.$form,f=!1;e.on("submit",function(g){g.preventDefault();g=a();g.errors.length?(g=(g=g.errors)?g:[],console.log(g)):b(g.data)})};return CRMContactCreateSettings}(jQuery),CRMContactAddEmployeeDialog=function(c){CRMContactAddEmployeeDialog=function(a){this.$wrapper=a.$wrapper;this.contact_id=a.contact_id;this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMContactAddEmployeeDialog.prototype.initClass=function(){this.initAddEmployee()};CRMContactAddEmployeeDialog.prototype.initAddEmployee=
function(){function a(l){function k(n){var m=c('<div class="line errormsg" />').html(n);f.append(m);d.$form.one("submit",function(){m.remove()})}if(l[0])c.each(l,function(n,m){k(m.value)});else{var h=Object.keys(l);c.each(h,function(n,m){k(l[m])})}}function b(l){g||(g=!0,c.post("?module=contact&action=addEmployeeSave",l,function(k){"ok"===k.status?(c.crm.content.reload(),d.dialog.close()):k.errors&&a(k.errors)}).always(function(){g=!1}))}var d=this,e=d.$wrapper.find("#c-contact-add-employee-form"),
f=d.$wrapper.find(".js-errors-place"),g=!1;e.on("submit",function(l){l.preventDefault();l=e.serializeArray();var k=[];k.length?a(k):b(l)})};return CRMContactAddEmployeeDialog}(jQuery),CRMContactUpdateDialog=function(c){CRMContactUpdateDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$dialog=this.$wrapper.data("dialog");this.$footer=this.$wrapper.find(".js-dialog-footer");this.$submitButton=this.$wrapper.find(".js-submit-button");this.initClass()};CRMContactUpdateDialog.prototype.initClass=
function(){this.initAutocomplete();this.initSubmit()};CRMContactUpdateDialog.prototype.initAutocomplete=function(){var a=this,b=a.$wrapper.find(".js-autocomplete-wrapper"),d=b.find(".js-autocomplete"),e=b.find(".js-field");d.autocomplete({appendTo:b,source:c.crm.app_url+"?module=autocomplete",minLength:2,html:!0,focus:function(){return!1},select:function(f,g){f=c("<div />").text(g.item.name).text();d.val(f).blur();e.val(g.item.id).trigger("change");return!1}}).data("ui-autocomplete")._renderItem=
function(f,g){return c("<li />").addClass("ui-menu-item-html").append("<div>"+g.value+"</div>").appendTo(f)};e.on("change",function(){a.$submitButton.attr("disabled",!1)})};CRMContactUpdateDialog.prototype.initSubmit=function(){function a(){var k={data:[],errors:[]},h=f.serializeArray();c.each(h,function(n,m){k.data.push(m)});return k}function b(k){k=k?k:[];c.each(k,function(h,n){h=n.value;var m=f.find('[name="'+n.name+'"]'),p=c("<span />").addClass("errormsg").text(h);m.length?m.hasClass("error")||
(m.parent().append(p),m.addClass("error").one("focus click",function(){m.removeClass("error");p.remove()})):(g.append(p),f.one("submit",function(){p.remove()}))})}function d(k){l||(l=!0,c.post("?module=contact&action=update",k,function(h){"ok"===h.status?e.$dialog.close():b(h.errors)},"json").always(function(){l=!1}))}var e=this,f=e.$form,g=e.$wrapper.find(".js-errors-place"),l=!1;f.on("submit",function(k){k.preventDefault();k=a();k.errors.length?b(k.errors):d(k.data)})};return CRMContactUpdateDialog}(jQuery),
CRMContactAddCompanyContactDialog=function(c){CRMContactAddCompanyContactDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$company_value=this.$wrapper.find(".js-company-value");this.$submit=this.$wrapper.find(".js-submit");this.$footer=this.$wrapper.find(".js-dialog-footer");this.$company_id_input=this.$wrapper.find(".js-company-id");this.$company_name_input=this.$wrapper.find(".js-autocomplete-company");this.dialog=this.$wrapper.data("dialog");this.initClass()};
CRMContactAddCompanyContactDialog.prototype.initClass=function(){var a=this;a.$form.on("click",".js-company-item",function(){a.$submit.prop("disabled",!1)});a.initAutoComplete();a.initSubmit()};CRMContactAddCompanyContactDialog.prototype.initAutoComplete=function(){var a=this,b=a.$wrapper.find(".js-selected-company"),d=a.$wrapper.find(".js-change-company"),e=a.$wrapper.find(".js-label-new-company");a.$company_name_input.autocomplete({source:function(f,g){c.post("?module=autocomplete&type=company",
f,function(l){c.isEmptyObject(l)&&f.term?e.css({color:"#999"}):e.css({color:"#FFF"});g(l)},"json")},minLength:0,focus:function(){return!1},select:function(f,g){a.$company_id_input.val(g.item.id);b.html('<i class="icon userpic size-20" style="background-image: url('+g.item.photo_url+');"></i>').append(c("<span />").text(g.item.name)).removeClass("hidden");a.$company_name_input.addClass("hidden");return!1}}).data("ui-autocomplete")._renderItem=function(f,g){return c("<li />").addClass("ui-menu-item-html").append("<div>"+
g.value+"</div>").appendTo(f)};a.$company_name_input.on("focus",function(){a.$company_name_input.data("uiAutocomplete").search(a.company_name)});d.on("click",function(){a.$company_id_input.val(0);b.html("").addClass("hidden");a.$company_name_input.removeClass("hidden").focus()})};CRMContactAddCompanyContactDialog.prototype.initSubmit=function(){function a(){var d=c('<span class="icon loading"><i class="fas fa-spinner wa-animation-spin"></i></span>'),e=c.crm.app_url+"?module=contact&action=addCompanyContactSave",
f=b.$form.serializeArray();b.$submit.prop("disabled",!0);b.$footer.append(d);c.post(e,f,function(g){"ok"===g.status?c.crm.content.reload():(b.$submit.prop("disabled",!1),d.remove())})}var b=this;b.$form.on("submit",function(d){d.preventDefault();d=b.$company_id_input.val();var e=b.$company_name_input.val();if(0==d&&!c.trim(e))return b.$company_value.addClass("shake animated"),b.$company_name_input.focus(),setTimeout(function(){b.$company_value.removeClass("shake animated");b.$company_name_input.focus()},
500),!1;a()})};return CRMContactAddCompanyContactDialog}(jQuery);var CRMContactsPage=function(c){CRMContactsPage=function(a){this.$wrapper=a.$wrapper;this.$content=this.$wrapper.find("#js-content-block");this.is_admin=a.is_admin;this.context=a.context||{};this.view=a.view||"thumbs";this.total_count=a.total_count||0;this.page_count=a.page_count||0;this.locales=a.locales;this.sidebar=this.$wrapper.find(".c-contacts-sidebar").data("sidebar_controller");this.initClass()};CRMContactsPage.prototype.initClass=function(){this.initElastic();"segment"===this.context.type&&
this.initEditableName(c.crm.app_url+"?module=contactSegment&action=save&is_rename=1",this.context);"list"===this.view&&(this.initContactsColumnsSection(),this.initContactsTable());"thumbs"===this.view&&this.initContactsThumbs();this.initOperationsMenu();"segment"===this.context.type?this.initSegmentContext():"search"===this.context.type&&this.initCreateFilterLink();this.$wrapper.on("click",".pager a",function(){c(this).replaceWith('<i class="icon16 loading"></i>');c(document).one("wa_loaded",function(){c("html, body").scrollTop(0)})});
this.initTableSlider();this.initHoverNames();this.initDroppable()};CRMContactsPage.prototype.initEditableName=function(a,b){var d=this.$wrapper.find(".js-name-editable").first();if(!(0>=d.length)){var e=this,f=!1,g=null;new CrmEditable({$wrapper:d,onSave:function(l){var k=l.$field.val();k.length&&l.text!==k?(g&&g.abort(),k={id:b.info.id,name:k},l.$field.attr("disabled",!0),f||(f=c('<i class="icon16 loading"></i>').css("margin","0 0 0 4px").insertAfter(l.$field)),g=c.post(a,k,function(h){h&&h.data&&
h.data.segment&&(l.text=h.data.segment.name,l.$wrapper.text(h.data.segment.name),e.sidebar.updateItem(b,{name:h.data.segment.name}))},"json").always(function(){l.$field.attr("disabled",!1);l.toggle("hide");f.length&&(f.remove(),f=!1)})):(k.length||l.$field.val(l.text),l.toggle("hide"))}})}};CRMContactsPage.prototype.initElastic=function(){var a=this.$wrapper,b=this.$wrapper.find("#js-aside-block"),d=this.$content;new CRMElasticBlock({$wrapper:a,$aside:b,$content:d});new CRMElasticBlock({$wrapper:a,
$content:b,$aside:d})};CRMContactsPage.prototype.initContactsColumnsSection=function(){function a(k){if(c.contains(document,e[0])){var h=e.hasClass("is-active");k=c.contains(e[0],k.target);h&&!k&&d()}else c(document).off("click",a)}function b(k){k.preventDefault();l||(l=!0,k=c.crm.app_url+"?module=contact&action=columns",f.html(g),d(!0),c.post(k,{},function(h){f.html(h)}).always(function(){l=!1}))}function d(k){k?e.addClass("is-active"):e.removeClass("is-active")}var e=this.$wrapper.find(".js-contacts-columns-section"),
f=e.find(".js-load-here"),g=f.html(),l=!1;e.on("click",".js-show-contact-columns-dialog",function(k){e.hasClass("is-active")?d(!1):b(k)});c(document).on("click",a);e.on("close",function(){d(!1)})};CRMContactsPage.prototype.initContactsTable=function(){var a=this;(function(){a.$wrapper.find(".js-width-toggle-wrapper").each(function(){var b=c(this),d=b.data("fullColumnId");b.on("click",".js-set-width",function(){var e=c(this).data("id");c.post(c.crm.app_url+"?module=contactColumns&action=saveWidth",
{width:e,full_column_id:d},function(){c.crm.content.reload()})})})})()};CRMContactsPage.prototype.initContactsThumbs=function(){};CRMContactsPage.prototype.initOperationsMenu=function(){new CRMContactsOperations({$wrapper:this.$wrapper,total_count:this.total_count,page_count:this.page_count,context:this.context,sidebar:this.sidebar,is_admin:this.is_admin,view:this.view})};CRMContactsPage.prototype.initSegmentContext=function(){var a=this.$wrapper;this.initSegmentLinks();this.sidebar.updateItem(this.context,
{count:this.context.info.count});var b=c.crm.storage.get("crm/create/category")||{},d=+new Date;c.crm.storage.del("crm/create/category");"category"===this.context.info.type&&(a=a.find(".js-segment-add-contacts"),b.id==this.context.info.id&&3E4>=d-b.timestamp&&a.click())};CRMContactsPage.prototype.initSegmentLinks=function(){function a(g){g.preventDefault();f&&f.abort();f=c.post(c.crm.app_url+"?module=contactSegment&action=addContacts",{id:b.context.info.id},function(l){new CRMDialog({html:l})}).always(function(){f=
!1})}var b=this,d=b.$wrapper.find(".js-segment-actions-list"),e=!1,f=!1;d.on("click",".js-show-edit-dialog",function(g){g.preventDefault();f&&f.abort();f=c.post(c.crm.app_url+"?module=contactSegment&action=edit",{id:b.context.info.id},function(l){new CRMDialog({html:l})}).always(function(){f=!1})});d.on("click",".js-show-archive-dialog",function(g){g.preventDefault();if(!e){e=!0;var l=c(this).closest(".crm-segment-archive-li"),k=l.hasClass("archived");l.removeClass("archived not-archived").addClass("loading");
c.post(c.crm.app_url+"?module=contactSegment&action=archive",{id:b.context.info.id,archive:k?0:1},function(){l.addClass(k?"not-archived":"archived")}).always(function(){l.removeClass("loading");e=!1})}});d.on("click",".js-show-delete-confirm",function(){function g(){c.post(c.crm.app_url+"?module=contactSegment&action=delete",{id:b.context.info.id},function(l){"ok"===l.status&&c.crm.content.load(c.crm.app_url+"contact/")}).always(function(){e=!1})}e||(e=!0,c.crm.confirm.show({title:b.locales.delete_segment_title,
text:b.locales.delete_segment_text,button:b.locales.delete_segment_button,onConfirm:g}))});d.on("click","a",function(){d.hide();setTimeout(function(){d.removeAttr("style")},200)});if("category"===b.context.info.type)d.on("click",".js-segment-add-contacts",a)};CRMContactsPage.prototype.initCreateFilterLink=function(){var a=this.$wrapper;a.find(".crm-create-filter-link").click(function(b){b.preventDefault();var d=c(this).data("hash");b=c.crm.app_url+"?module=contactSegment&action=edit";d={type:"search",
hash:d,name:a.find(".crm-contact-list-name").text()};c.get(b,d).done(function(e){new CRMDialog({html:e})})})};CRMContactsPage.prototype.initTableSlider=function(){function a(){c.contains(document,g[0])?(q=g.outerWidth(),r=l.outerWidth(),b(),u&&(u=!1,v=0,e(v))):c(window).off("resize",a)}function b(){if(r>q){var t=v+q>=r,w=v+q<r;0<v?t?(m.addClass("is-active"),p.removeClass("is-active")):w&&(m.addClass("is-active"),p.addClass("is-active")):(m.removeClass("is-active"),p.addClass("is-active"))}else m.removeClass("is-active"),
p.removeClass("is-active")}function d(t){var w=q/3;t?(t=v+w,t>r-q&&(t=r-q)):(t=v-w,0>t&&(t=0));v=t;u=!0;e(t);b()}function e(t){var w="-"+t+"px";l.data("isLeftSet",0<t);l.css({"-webkit-transform":"translate("+w+",0)",transform:"translate("+w+",0)"});h.css({"-webkit-transform":"translate("+w+",0)",transform:"translate("+w+",0)"})}var f=this,g=f.$wrapper.find(".js-contacts-section");if(!g.length)return!1;var l=g.find(".js-slider-body"),k=g.find(".js-header-table-wrapper"),h=k.find(".js-header-table"),
n=g.find(".js-arrows-wrapper"),m=n.find(".js-arrow-left"),p=n.find(".js-arrow-right"),q=g.outerWidth(),r=l.outerWidth(),u=!1,v=0;b();(function(){function t(){if(c.contains(document,x[0])){var z=w.scrollTop()>y.top,B=f.$content.height()>w.height();z&&B?(k.css({left:y.left}).width(g.outerWidth()).addClass("is-fixed"),x.addClass("is-fixed")):(k.removeAttr("style").removeClass("is-fixed"),x.removeClass("is-fixed"))}else w.off("scroll",t)}var w=c(window),x=n,y=g.offset();w.on("scroll",t)})();m.on("click",
function(){d(!1)});p.on("click",function(){d(!0)});c(window).on("resize",a)};CRMContactsPage.prototype.initHoverNames=function(){function a(){g=setTimeout(function(){d.removeClass("is-shown").html("")},500)}var b=this.$wrapper.find(".js-contacts-section");if(!b.length)return!1;var d=b.find(".c-hint-wrapper"),e=this.$wrapper.find(".js-contacts-table"),f=e.offset(),g=0;e.on("mouseenter","tr",function(){var l=c(this);if(e.data("isLeftSet")){clearTimeout(g);var k=l.find(".c-name").html();l=l.find("td:first").offset();
d.html(k).css({top:l.top+10-(f.top-28),left:10}).addClass("is-shown")}});e.on("mouseleave","tr",function(){a()});d.on("mouseenter",function(){clearTimeout(g)});d.on("mouseleave",a)};CRMContactsPage.prototype.initDroppable=function(){function a(d,e){c.post(c.crm.app_url+"?module=contactSegment&action=addContactsSave",{id:d,contact_id:e},"json").done(function(f){"ok"===f.status&&f.data.segment&&b.sidebar.updateItem({type:"segment",info:{id:d}},{count:f.data.segment.count})})}var b=this;b.$wrapper.find(".js-sidebar").find(".js-segment-droparea").each(function(){var d=
c(this);d.droppable({tolerance:"pointer",hoverClass:"is-hovered",over:function(e,f){f.draggable.hasClass("ui-draggable")||d.removeClass("is-hovered")},drop:function(e,f){e=c(this).data("id");var g=[],l=f.helper.data("user-id");f=f.helper.data("user-ids");l="undefined"!==typeof l?l+"":null;f="undefined"!==typeof f?f+"":null;l?g.push(l):f&&(0<f.indexOf(",")?g=f.split(","):g.push(f));0<e&&0<g.length&&a(e,g)}})})};return CRMContactsPage}(jQuery),CRMContactsColumnsDialog=function(c){CRMContactsColumnsDialog=
function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$activeList=this.$wrapper.find(".js-active-list");this.$unactiveList=this.$wrapper.find(".js-unactive-list");this.initClass()};CRMContactsColumnsDialog.prototype.initClass=function(){this.initSubmit();this.initSort();this.initComboList();this.$wrapper.on("click",".js-close-dialog",function(){c(this).closest(".js-contacts-columns-section").trigger("close")})};CRMContactsColumnsDialog.prototype.initSubmit=function(){function a(){if(!e){e=
!0;var f=c.crm.app_url+"?module=contactColumns&action=save",g=b();c.post(f,g,function(l){"ok"===l.status?c.crm.content.reload():alert("Error")}).always(function(){e=!1})}}function b(){var f=d.serializeArray();c.each(f,function(g,l){l.value=g+1});return f}var d=this.$form,e=!1;d.on("submit",function(f){f.preventDefault();a()})};CRMContactsColumnsDialog.prototype.initSort=function(){this.$activeList.sortable({distance:10,handle:".c-toggle",helper:"clone",items:".js-item",axis:"y"})};CRMContactsColumnsDialog.prototype.initComboList=
function(){var a=this;a.$activeList.on("change",".c-field",function(){var b=c(this),d=b.closest(".js-item");"checked"===b.attr("checked")?d.appendTo(a.$activeList):d.appendTo(a.$unactiveList)});a.$unactiveList.on("change",".c-field",function(){var b=c(this),d=b.closest(".js-item");"checked"===b.attr("checked")?d.appendTo(a.$activeList):d.appendTo(a.$unactiveList)})};return CRMContactsColumnsDialog}(jQuery),CRMThumbContact=function(c){CRMThumbContact=function(a){this.$wrapper=a.$wrapper;this.user_id=
this.$wrapper.data("user-id");this.can_be_drag=a.can_be_drag;this.initClass()};CRMThumbContact.prototype.initClass=function(){this.can_be_drag&&this.initDraggable()};CRMThumbContact.prototype.initDraggable=function(){var a=c("#c-contacts-sidebar .js-segment-droparea");this.$wrapper.draggable({handle:".js-userpic",delay:200,cursorAt:{top:0,left:0},helper:function(){var b=c("#c-users-list .js-move-user.is-active").map(function(){return c(this).data("user-id")}).toArray();return 1<b.length?'<div id="c-users-helper" data-user-ids="'+
b.join(",")+'"><span class="indicator red">'+b.length+"</span></div>":c(this).clone().addClass("is-clone")},start:function(){a.length&&a.addClass("c-drop-here")},stop:function(b,d){b=d.helper;var e=b.clone();e.insertAfter(b).fadeOut(270);setTimeout(function(){e.remove()},300);a.length&&a.removeClass("c-drop-here")}})};return CRMThumbContact}(jQuery),CRMTableContact=function(c){CRMTableContact=function(a){this.$wrapper=a.$wrapper;this.user_id=this.$wrapper.data("user-id");this.can_be_drag=a.can_be_drag;
this.initClass()};CRMTableContact.prototype.initClass=function(){this.can_be_drag&&this.initDraggable()};CRMTableContact.prototype.initDraggable=function(){var a=this,b=c("#c-contacts-sidebar .js-segment-droparea"),d=c(".js-contacts-table .js-move-user");a.$wrapper.draggable({helper:function(){var e=[],f="";d.filter(".is-active").each(function(){var g=c(this).data("user-id");g&&e.push(g)});1>=e.length?(e.push(a.user_id),f=a.$wrapper.find(".userpic")[0].outerHTML,f='<div id="c-users-helper" data-user-ids="'+
e.join(",")+'">'+f+"</div>"):f='<div id="c-users-helper" data-user-ids="'+e.join(",")+'"><span class="indicator red">'+e.length+"</span></div>";return f},appendTo:"body",delay:200,cursorAt:{top:0,left:0},start:function(e,f){f.helper.addClass("is-clone");b.length&&b.addClass("c-drop-here")},stop:function(e,f){e=f.helper;var g=e.clone();g.insertAfter(e).fadeOut(270);setTimeout(function(){g.remove()},300);b.length&&b.removeClass("c-drop-here")}})};return CRMTableContact}(jQuery);var CRMContactsSidebar=function(c){CRMContactsSidebar=function(a){this.$wrapper=a.$wrapper;this.$segmentsLists=this.$wrapper.find(".c-segment-list");this.$add_new_segment_link=this.$wrapper.find(".c-create-new-segment");this.is_admin=a.is_admin;this.initClass()};CRMContactsSidebar.prototype.initClass=function(){this.initSortable();this.initAddLink();this.initAddNewSegmentLink();this.initHighlight();this.initSelectedLink();this.initArchivedToggles();this.initScrollTopOnClick()};CRMContactsSidebar.prototype.initSortable=
function(){function a(l){return l.find("> li").map(function(){var k=parseInt(c(this).data("id"),10);return 0<k?k:!1}).toArray()}function b(l,k){g&&(g.abort(),g=!1);g=c.post(l,k,function(){g=!1})}var d=this,e=c.crm.app_url+"?module=contact&action=sortSave",f,g=!1;d.$segmentsLists.each(function(){var l=c(this),k=l.data("shared")?1:0;!d.is_admin&&k||l.sortable({distance:10,items:"> li:not(.sort-disabled)",axis:"y",delay:200,tolerance:"pointer",start:function(h,n){f=n.item.index()},stop:function(h,n){n.item.removeAttr("style");
f!=n.item.index()&&(h=a(l),b(e,{segments:h,shared:k}))}})})};CRMContactsSidebar.prototype.initAddLink=function(){var a=!1,b=this.$wrapper.find(".js-add-link"),d=b.find(".icon16"),e=d.attr("class");b.on("click",function(){if(!a){a=!0;var f=c.crm.app_url+"?module=contact&action=add";d.attr("class","icon16 loading");c.post(f,{},function(g){new CRMDialog({html:g})}).always(function(){a=!1;d.attr("class",e)})}})};CRMContactsSidebar.prototype.initAddNewSegmentLink=function(){var a=this.$add_new_segment_link;
a.click(function(b){b.preventDefault();c.get(c.crm.app_url+"?module=contactSegment&action=edit").done(function(d){new CRMDialog({html:d})}).always(function(){a.find(".icon16").hide()})})};CRMContactsSidebar.prototype.updateItem=function(a,b){"segment"===a.type&&(a=this.$segmentsLists.find('li[data-id="'+a.info.id+'"]'),a.length&&(void 0!==b.name&&a.find(".name").text(b.name||""),void 0!==b.count&&a.find(".count").text(b.count||"")))};CRMContactsSidebar.prototype.initHighlight=function(a,b){var d=
c(".all-contacts-link");this.$wrapper.find('a[href^="'+c.crm.app_url+'"]').each(function(e,f){if(location.pathname==f.pathname)return e=c(f),f=e.closest("li"),f.length||(f=e),d.removeClass("selected"),f.addClass("selected"),!1;d.addClass("selected")})};CRMContactsSidebar.prototype.initSelectedLink=function(){var a=this;sessionStorage.getItem("selected_contacts")||sessionStorage.setItem("selected_contacts","[]");var b=this.$wrapper.find(".js-selected-contacts"),d=b.find(".count"),e=sessionStorage.getItem("selected_contacts");
if(e=JSON.parse(e).length)d.text(e),b.removeClass("js-selected-contacts-hidden");b.on("click",function(f){f.preventDefault();f=c.crm.app_url+"?module=contact&action=selected";var g=sessionStorage.getItem("selected_contacts");c.post(f,{selected_ids:g},function(l){l&&(history.pushState(null,null,c.crm.app_url+"contact/selected/"),c(document).find("#c-content-block").html(l),a.initHighlight())})})};CRMContactsSidebar.prototype.initArchivedToggles=function(){this.$wrapper.find(".js-archived-section").each(function(){var a=
c(this);a.on("click",".js-show-list",function(){a.find(".js-archive-show-link").hide();a.find(".js-archive-list").show()});a.on("click",".js-hide-list",function(){a.find(".js-archive-show-link").show();a.find(".js-archive-list").hide()})})};CRMContactsSidebar.prototype.initScrollTopOnClick=function(){this.$wrapper.on("click","a:not(.js-add-link)",function(){var a=c(this),b=!a.hasClass("js-stop-scroll");a.find(".icon16").attr("class","icon16 loading").attr("style","");b&&c(window).scrollTop(0)})};
return CRMContactsSidebar}(jQuery);
CRMContactsSidebar.initCollapsibleSidebar=function(){$.each(["mylists-my","tags","vaults","responsibles","admin"],function(){1==localStorage.getItem("collapsible_sidebar_"+this)&&($("#collapsible-"+this).find(".js-collapsible").css({display:"none"}),$("#collapsible-"+this).find(".caret .fas").removeClass("fa-caret-down").addClass("fa-caret-right"))});$(".c-contacts-sidebar").on("click",".collapse-handler",function(){var c=$(this).parents(".js-collapse-wrapper").data("block"),a=$(this).parents(".js-collapse-wrapper");
a=$(a).find(".js-collapsible");a.is(":visible")?($(a).css({display:"none"}),$(this).find("[data-fa-i2svg]").removeClass("fa-caret-down").addClass("fa-caret-right").attr("data-icon","caret-right"),localStorage.setItem("collapsible_sidebar_"+c,1)):($(a).css({display:""}),$(this).find("[data-fa-i2svg]").removeClass("fa-caret-right").addClass("fa-caret-down").attr("data-icon","caret-down"),localStorage.setItem("collapsible_sidebar_"+c,0))})};var CRMContactsOperations=function(c){CRMContactsOperations=function(a){this.$wrapper=a.$wrapper;this.$bar=this.$wrapper.find(".js-operations-wrapper");this.$list=this.$wrapper.find(".js-contacts-list");this.$list_header=this.$list.find(".c-list-header");this.$checkbox_all=this.$wrapper.find(".js-checkbox-all");this.$content=this.$wrapper.find("#js-content-block");this.$selected_link=this.$wrapper.find(".js-selected-contacts");this.$selected_count=this.$selected_link.find(".count");this.$remove_from_selected_list=
this.$bar.find('[data-id="remove_from_selected_list"]');this.page=a.page||1;this.limit=a.limit||30;this.total_items_at_page_count=this.getTotalItemsAtPage()||0;this.total_count=a.total_count||0;this.page_count=a.page_count||0;this.context=a.context||{};this.selected_page=c(document).find("#contact_selected_page").length;this.is_category_segment="segment"===this.context.type&&this.context.info&&"category"===this.context.info.type;this.view=a.view||"";this.sidebar=a.sidebar||null;this.checked_count=
0;this.is_shown=0<this.checked_count;this.is_checked_all=!1;this.initClass()};CRMContactsOperations.prototype.initClass=function(){this.initCheckboxAll();this.initOperations();this.initItemCheckbox();this.initElasticHeader();0<this.selected_page&&this.$remove_from_selected_list.show()};CRMContactsOperations.prototype.initCheckboxAll=function(){var a=this;a.$checkbox_all.click(function(){var b=c(this),d=b.is(":checked");0<a.checked_count?a.unselectAll():(b.prop("checked",d),d?a.selectAll():a.unselectAll());
a.formBar();a.showOrHideBar()})};CRMContactsOperations.prototype.initOperations=function(){var a=this;a.$bar.on("click",".crm-operation-link",function(b){b.preventDefault();switch(c(this).data("id")){case "add_to_segments":a.addToSegmentsOperation();break;case "export":a.exportOperation();break;case "merge":a.mergeOperation();break;case "delete":a.deleteOperation();break;case "exclude_from_list":a.excludeFromListOperation();break;case "assign_tags":a.assignTagsOperation();break;case "assign_responsible":a.assignResponsibleOperation();
break;case "remove_from_selected_list":a.removeFromSelectedListOperation()}})};CRMContactsOperations.prototype.showBar=function(){this.is_shown||(this.$bar.addClass("is-shown"),this.$list_header.removeClass("is-shown"),this.is_shown=!0)};CRMContactsOperations.prototype.hideBar=function(){this.is_shown&&(this.$bar.removeClass("is-shown"),this.$list_header.addClass("is-shown"),this.is_shown=!1)};CRMContactsOperations.prototype.updateBarCount=function(){this.$bar.find(".crm-count").text("("+this.checked_count+
")")};CRMContactsOperations.prototype.showOrHideBar=function(){0<this.checked_count?(this.showBar(),this.updateBarCount()):this.hideBar()};CRMContactsOperations.prototype.getSelectedContactList=function(){var a=sessionStorage.getItem("selected_contacts");return a?JSON.parse(a):null};CRMContactsOperations.prototype.setSelectedContacts=function(){this.getSelectedContactList()||sessionStorage.setItem("selected_contacts","[]");if(!(0<this.selected_page)){var a=this.getSelectedContactList(),b=this.getSelectedContactIds();
c.each(b,function(d,e){0>c.inArray(e,a)&&(a[a.length]=e)});sessionStorage.setItem("selected_contacts",JSON.stringify(a));this.showOrHideSelectedLink()}};CRMContactsOperations.prototype.delSelectedContact=function(a){var b=this.getSelectedContactList();a=b.indexOf(a);b.splice(a,1);sessionStorage.setItem("selected_contacts",JSON.stringify(b));this.showOrHideSelectedLink()};CRMContactsOperations.prototype.updateSelectedCount=function(){var a=this.getSelectedContactList().length;this.$selected_count.text(a)};
CRMContactsOperations.prototype.showOrHideSelectedLink=function(){this.updateSelectedCount();this.getSelectedContactList().length?this.showSelectedLink():this.hideSelectedLink()};CRMContactsOperations.prototype.showSelectedLink=function(){this.$selected_link.removeClass("js-selected-contacts-hidden")};CRMContactsOperations.prototype.hideSelectedLink=function(){this.$selected_link.addClass("js-selected-contacts-hidden")};CRMContactsOperations.prototype.getSelectedContactIds=function(){return this.$list.find(".c-checkbox :checkbox:checked").map(function(){return c(this).val()}).toArray()};
CRMContactsOperations.prototype.getTotalItemsAtPage=function(){return this.page*this.limit>this.total_count?this.total_count%this.limit:this.limit};CRMContactsOperations.prototype.formBar=function(){var a=this.$bar.find('.crm-operation-li[data-id="merge"]'),b=this.$bar.find('.crm-operation-li[data-id="delete"]'),d=this.$bar.find('.crm-operation-li[data-id="assign_responsible"]'),e=this.$bar.find('.crm-operation-li[data-id="exclude_from_list"]');1>=this.checked_count||this.checked_count>this.page_count?
a.hide():a.show();this.checked_count>this.page_count?b.hide():b.show();this.checked_count>this.page_count?d.hide():d.show();this.is_category_segment&&this.context.can_edit?e.show():e.hide()};CRMContactsOperations.prototype.initItemCheckbox=function(){function a(d){var e=d.find(".js-checkbox"),f=e.is(":checked");e=e.val();f?d.addClass("is-active"):d.removeClass("is-active");b.is_checked_all?(b.is_checked_all=!1,b.checked_count=b.$list.find(".c-checkbox :checkbox:checked").length):f?b.checked_count+=
1:--b.checked_count;b.formBar();b.showOrHideBar();b.showOrHideSelectedLink();0<b.selected_page||(f?b.setSelectedContacts():b.delSelectedContact(e))}var b=this;b.$list.on("change",".js-checkbox",function(d,e){d=c(this);var f=d.closest(".js-contact-wrapper");"undefined"!==typeof e&&d.attr("checked",e);a(f);0<b.checked_count?b.checked_count<b.limit&&b.checked_count!==b.total_items_at_page_count?b.$checkbox_all.prop("indeterminate",!0):b.$checkbox_all.prop("indeterminate",!1).prop("checked",!0):b.$checkbox_all.prop("indeterminate",
!1).prop("checked",!1)});b.$list.on("click",".js-contact-wrapper",function(d){var e=c(d.target);d=!(!e.is("a")&&!e.closest("a").length);e=e.is(":checkbox");d||(d=c(this),e||(d=d.find(".js-checkbox"),d.trigger("change",[!d.is(":checked")])))});b.$list.shiftSelectable({selector:".js-contact-wrapper",behavior_type:"thumbs"===b.view?"mixed":"vertical",onSelect:function(d,e){var f=c(e.target);f=!(!f.is("a")&&!f.closest("a").length);var g=e.extra.is_first;e=e.extra.is_last;f||g||e||(d.find(".js-checkbox").attr("checked",
!0),a(d))}})};CRMContactsOperations.prototype.removeFromSelectedListOperation=function(){var a=this,b=a.$list.find(".c-checkbox :checkbox:checked");c.each(b,function(){a.delSelectedContact(this.value);c(this).parents(".js-contact-wrapper").remove()});a.$checkbox_all.prop("checked",!1);a.checked_count=0;a.is_checked_all=!1;a.showOrHideBar();a.getSelectedContactList().length||(b=a.$wrapper.find(".js-header-table-wrapper"),a.$wrapper.find(".c-no-contacts").removeClass("hidden"),b.remove())};CRMContactsOperations.prototype.selectAll=
function(){this.$list.find(".c-checkbox :checkbox").prop("checked",!0).trigger("change",[!0]);this.checked_count=this.total_count;this.is_checked_all=!0;this.setSelectedContacts()};CRMContactsOperations.prototype.unselectAll=function(){this.$list.find(".c-checkbox :checkbox").prop("checked",!1).trigger("change",[!1]);this.$checkbox_all.prop("checked",!1);this.checked_count=0;this.is_checked_all=!1};CRMContactsOperations.prototype.getSelectedContext=function(){var a=c.extend({total_count:this.total_count,
page_count:this.page_count,checked_count:this.checked_count,is_checked_all:this.is_checked_all?1:0,contact_ids:null},this.context);a.is_checked_all||(a.contact_ids=this.getSelectedContactIds());return a};CRMContactsOperations.prototype.addToSegmentsOperation=function(){var a=this;c.get(c.crm.app_url+"?module=contactOperation&action=addToSegments",function(b){new CRMDialog({html:b,onOpen:function(d){new CRMContactsOperationAddToSegments({$wrapper:d,context:a.getSelectedContext(),sidebar:a.sidebar})}})})};
CRMContactsOperations.prototype.exportOperation=function(){var a=this,b=c.crm.app_url+"?module=contactOperation&action=export",d=a.getSelectedContext().checked_count;c.get(b,{checked_count:d},function(e){var f=null;new CRMDialog({html:e,esc:!1,onOpen:function(g){f=new CRMContactsOperationExport({$wrapper:g,context:a.getSelectedContext()})},onClose:function(){f&&f.cancel()}})})};CRMContactsOperations.prototype.mergeOperation=function(){if(!(1>=this.checked_count||this.checked_count>this.page_count)){var a=
this.getSelectedContactIds().join(",");c.crm.content.load(c.crm.app_url+"contact/merge/?ids="+a)}};CRMContactsOperations.prototype.deleteOperation=function(){if(!(this.checked_count>this.page_count)){var a=c.crm.app_url+"?module=contactOperation&action=delete",b=this.$wrapper,d=this.getSelectedContext();b=b.find(".crm-contact-operation-delete-checking").clone();new CRMDialog({html:b.show(),onOpen:function(e){var f=this;e.find(".crm-cancel").click(function(){f.close()});c.get(a,d,function(g){new CRMDialog({html:g,
onOpen:function(){f.close()}})})}})}};CRMContactsOperations.prototype.excludeFromListOperation=function(){var a=this;if(a.is_category_segment){var b=c.crm.app_url+"?module=contactOperation&action=excludeFromSegment",d=a.getSelectedContext();c.get(b,{id:a.context.info.id,checked_count:d.checked_count},function(e){new CRMDialog({html:e,onOpen:function(f){new CRMContactsOperationExcludeFromSegment({$wrapper:f,segment:a.context.info,context:a.getSelectedContext(),sidebar:a.sidebar})}})})}};CRMContactsOperations.prototype.assignTagsOperation=
function(){var a=c.crm.app_url+"?module=contactOperation&action=assignTags",b=c.extend({},this.getSelectedContext(),!0);b.is_checked_all||1!=b.checked_count||(a+="&is_assign=1");c.post(a,b,function(d){new CRMDialog({html:d})})};CRMContactsOperations.prototype.assignResponsibleOperation=function(){var a=c.crm.app_url+"?module=contactOperation&action=assignResponsible",b=c.extend({},this.getSelectedContext(),!0);c.post(a,b,function(d){new CRMDialog({html:d})})};CRMContactsOperations.prototype.initElasticHeader=
function(){function a(){if(c.contains(document,g[0])){var n=e.scrollTop()>l.top,m=d.$content.height()>e.height();n&&m?(g.addClass("is-fixed").css({left:l.left,width:k}),h=!0):(g.removeClass("is-fixed").removeAttr("style"),h=!1)}else e.off("scroll",a)}function b(){c.contains(document,g[0])?(k=f.outerWidth(),h&&g.width(k)):e.off("resize",b)}var d=this,e=c(window),f=d.$wrapper.find(".js-contacts-section"),g=d.$bar,l=f.offset(),k=g.outerWidth(),h=!1;e.on("scroll",a).on("resize",b)};return CRMContactsOperations}(jQuery);var CRMContactsOperationAddToSegments=function(c){CRMContactsOperationAddToSegments=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".js-save");this.$add_new_link=this.$wrapper.find(".crm-add-new-segment-link");this.context=a.context||{};this.dialog=this.$wrapper.data("dialog");this.url=c.crm.app_url+"?module=contactOperation&action=addToSegments";this.is_assign=a.is_assign?1:0;this.onSave=a.onSave||null;this.sidebar=a.sidebar||null;this.initClass()};CRMContactsOperationAddToSegments.prototype.initClass=
function(){this.is_assign||this.initButton();this.initSave();this.initAddNewLink()};CRMContactsOperationAddToSegments.prototype.initButton=function(){var a=this,b=function(){0<a.$wrapper.find('[name="segment[]"]:checked').length?a.$button.attr("disabled",!1):a.$button.attr("disabled",!0)};a.$wrapper.on("click",'[name="segment[]"]',b);b()};CRMContactsOperationAddToSegments.prototype.initSave=function(){var a=this,b=a.$button,d=a.$wrapper.find(".crm-loading"),e=c.crm.app_url+"?module=contactOperation&action=addToSegmentsProcess",
f=[],g=c.extend({},a.context,!0);g.is_assign=a.is_assign?1:0;var l=function(h){d.hide();b.attr("disabled",!1);a.sidebar&&c.each(h.segments||{},function(n,m){a.sidebar.updateItem({type:"segment",info:{id:m.id}},m)});g.is_assign?c.crm.content.reload():1==f.length?c.crm.content.load(c.crm.app_url+"contact/segment/"+f[0]+"/"):c.crm.content.load(c.crm.app_url)},k=function(h){h=c.extend({offset:h||0},g);c.post(e,h).done(function(n){"ok"==n.status&&(n.data.done?l(n.data):k(n.data.offset||0))})};b.click(function(h){h.preventDefault();
d.show();b.attr("disabled",!0);f=a.$wrapper.find('[name="segment[]"]:checked').map(function(){return c(this).val()}).toArray();g=c.extend({segment_ids:f},g);a.onSave&&!1===a.onSave(g,a.$wrapper)||k()})};CRMContactsOperationAddToSegments.prototype.reloadDialog=function(a){var b=this;c.get(b.url,function(d){b.dialog=c.waDialog({html:d,onOpen:function(e){a&&a(e);new CRMContactsOperationAddToSegments({$wrapper:e,context:b.context,sidebar:b.sidebar,onSave:b.onSave})}})})};CRMContactsOperationAddToSegments.prototype.initAddNewLink=
function(){var a=this;a.$add_new_link.click(function(b){b.preventDefault();a.$wrapper.find(".crm-add-new-segment-loading").show();c.get(c.crm.app_url+"?module=contactSegment&action=edit").done(function(d){a.dialog.close();var e=c.waDialog({html:d,onOpen:function(f){f.find(".js-close-dialog").hide();f.find(".crm-cancel-link").show().click(function(){f.find(".crm-cancel-loading").show();a.reloadDialog(function(){e.close()})})},options:{afterSave:function(f){a.reloadDialog(function(g){e.close();f.data.segment&&
g.find('input[name="segment[]"][value="'+f.data.segment.id+'"]').prop("checked",!0)});return!1}}})})})};return CRMContactsOperationAddToSegments}(jQuery);var CRMContactsOperationExcludeFromSegment=function(c){CRMContactsOperationExcludeFromSegment=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".js-save");this.$add_new_link=this.$wrapper.find(".crm-add-new-segment-link");this.context=a.context||{};this.segment=a.segment||{};this.dialog=this.$wrapper.data("dialog");this.sidebar=a.sidebar||null;this.initClass()};CRMContactsOperationExcludeFromSegment.prototype.initClass=function(){this.initStartExclude()};CRMContactsOperationExcludeFromSegment.prototype.initStartExclude=
function(){var a=this,b=a.$button,d=c.crm.app_url+"?module=contactOperation&action=excludeFromSegmentProcess",e=a.$wrapper.find(".crm-loading"),f=c.extend({},a.context);f.segment_id=a.segment.id;var g=function(l,k){l=c.extend({offset:l||0,process_count:k||0},f);c.post(d,l).done(function(h){"ok"==h.status&&(h.data.done?(h=h.data,e.hide(),b.attr("disabled",!1),a.segment=h.segment,a.sidebar.updateItem({type:"segment",info:{id:a.segment.id}},a.segment),a.dialog.close(),c.crm.content.load(c.crm.app_url+
"contact/segment/"+a.segment.id+"/")):g(h.data.offset,h.data.process_count))})};b.click(function(l){l.preventDefault();e.show();b.attr("disabled",!0);g()})};return CRMContactsOperationExcludeFromSegment}(jQuery);var CRMContactsOperationExport=function(c){CRMContactsOperationExport=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".js-save");this.$download_button=this.$wrapper.find(".js-download");this.$cancel=this.$wrapper.find(".crm-js-cancel");this.$download_file_form=this.$wrapper.find(".crm-download-file-form");this.context=a.context||{};this.url=c.crm.app_url+"?module=contactOperationExport&action=process";this.dialog=this.$wrapper.data("dialog");this.$dialog_parent=window.parent.$(".dialog");
this.$dialog_parent_close=this.$dialog_parent.find(".dialog-close");this.pid="";this.currentProcess=null;this.initClass()};CRMContactsOperationExport.prototype.initClass=function(){this.initStartExport()};CRMContactsOperationExport.prototype.initStartExport=function(){var a=this,b=a.$button;b.click(function(d){d.preventDefault();b.attr("disabled",!0);a.currentProcess=a.process()});a.$wrapper.on("click",".crm-js-cancel",function(d){d.preventDefault();a.currentProcess&&a.currentProcess.cancel();a.$dialog_parent_close[0].click()});
a.dialog&&(a.dialog.onCancel=function(){a.currentProcess&&a.currentProcess.cancel();a.dialog.close()})};CRMContactsOperationExport.prototype.cancel=function(){this.currentProcess&&this.currentProcess.cancel()};CRMContactsOperationExport.prototype.process=function(){var a=this,b=a.url,d=a.$wrapper,e=d.find(".js-export-contacts-progressbar").find(".js-export-contacts-progressbar-progress"),f=d.find(".progressbar-text"),g=null,l=null,k=!1,h=0,n=c.extend({},a.context,!0);n.separator=d.find("[name=separator]").val();
n.encoding=d.find("[name=encoding]").val();n.export_fields_name=d.find("[name=export_fields_name]").is(":checked")?1:0;n.not_export_empty_columns=d.find("[name=not_export_empty_columns]").is(":checked")?1:0;var m=function(q,r){0>=q?q=0:100<=q&&(q=100);r?(e.stop(),e.clearQueue(),e.animate({width:""+Math.round(q)+"%"},{duration:250,queue:!0})):e.css({width:""+Math.round(q)+"%"});100>q?f.text(Math.round(100*q/100)+"%"):(a.$wrapper.find(".crm-process-block .loader").html('<i class="icon fas fa-check yes"></i>'),
f.text("100%"),k=!0)},p=function(){a.$wrapper.find(".dialog-footer--visible").addClass("hidden");l&&clearTimeout(l);l=setTimeout(p,3200);!g||2<=h||(n.processId=g,c.post(b,n,function(q){h--;if(g&&q.ready){if(a.pid=g,a.pid){l&&clearTimeout(l);g=l=null;q=c.crm.app_url+"?module=contactOperationExport&action=process&processId="+a.pid;var r=a.$download_file_form.find('input[name="_csrf"]').val(),u=a.$download_file_form.find('input[name="file"]').val();c.post(q,{processId:a.pid,_csrf:r,file:u},function(v){v=
JSON.parse(v);a.$download_button.attr("href",c.crm.app_url+"?module=contactOperation&action=download&file="+v.file)});a.$wrapper.find(".dialog-footer--hidden").removeClass("hidden")}}else q.progress&&m(q.progress,!k)},"json"),h++)};a.$wrapper.find(".crm-start-block").hide();a.$wrapper.find(".crm-process-block").show();m(0,!1);c.post(b,n,function(q){q.processId||alert("Error processing request.");g=q.processId;p()},"json");return{cancel:function(){l&&clearTimeout(l);c.post(b,{processId:g,ready:1})}}};
return CRMContactsOperationExport}(jQuery);var CRMContactsOperationAssignTags=function(c){CRMContactsOperationAssignTags=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".js-save");this.$input=this.$wrapper.find(".crm-tags-input");this.context=a.context||{};this.dialog=this.$wrapper.data("dialog");this.default_text=this.$input.attr("placeholder");this.is_assign=a.is_assign||!1;this.initClass()};CRMContactsOperationAssignTags.prototype.initClass=function(){this.initTagsInput();this.initPopularTags();this.initSave()};CRMContactsOperationAssignTags.prototype.initTagsInput=
function(){var a=c.crm.app_url+"?module=contact&action=tags";this.$input.tagsInput({defaultText:this.default_text,width:this.$wrapper.find(".crm-dialog-content").width()-16,autocomplete_url:"",autocomplete:{html:!0,source:function(b,d){c.getJSON(a,{term:b.term},function(e){"ok"===e.status?d(e.data.tags||[]):d([])})}}})};CRMContactsOperationAssignTags.prototype.initPopularTags=function(){var a=this.$input;this.$wrapper.find(".crm-popular-tags").find(".crm-popular-tag-item-link").click(function(){var b=
c(this);b=c.trim(b.text());a.removeTag(b);a.addTag(b)})};CRMContactsOperationAssignTags.prototype.initSave=function(){var a=this,b=a.$button,d=a.$input,e=c.crm.app_url+"?module=contactOperation&action=assignTagsProcess",f=c.extend({},a.context,!0),g=a.$wrapper.find(".crm-loading");b.click(function(l){l.preventDefault();g.show();b.attr("disabled",!0);l=c("#"+d.attr("id")+"_tag");(l=c.trim(l.val()))&&l!==a.default_text&&d.addTag(l);f.tags=c.trim(d.val());f.is_assign=a.is_assign?1:0;var k=function(h){h=
c.extend({offset:h||0},f);c.post(e,h).done(function(n){"ok"==n.status&&(n.data.done?(g.hide(),b.attr("disabled",!1),c.crm.content.reload(),a.dialog.close()):k(n.data.offset||0))})};k()})};return CRMContactsOperationAssignTags}(jQuery);var CRMContactsOperationAssignResponsible=function(c){CRMContactsOperationAssignResponsible=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$responsibleList=this.$wrapper.find(".js-responsible-list");this.$submitButton=this.$wrapper.find(".js-save");this.$close_dialog=a.Close_dialog;this.$errorh1=a.Error_h1;this.dialog=this.$wrapper.data("dialog");this.responsible_template_html=a.responsible_template_html;this.initClass()};CRMContactsOperationAssignResponsible.prototype.initClass=
function(){var a=this;a.$wrapper.on("change","input",function(){a.toggleButton(!0)});a.initSubmit();a.initAutocomplete()};CRMContactsOperationAssignResponsible.prototype.initSubmit=function(){function a(){if(!e){e=!0;var f=c.crm.app_url+"?module=contactOperation&action=assignResponsibleProcess",g=b();if(!g)return e=!1;var l=c('<i class="icon16 loading" style="vertical-align: middle; margin: 0;"></i>');l.appendTo(d.$submitButton.parent());d.$submitButton.attr("disabled",!0);var k=c("#responsible_id").val(),
h=k?c.crm.app_url+"contact/responsible/"+k+"/":c.crm.app_url+"contact/";c.post(f,g,function(n){"ok"===n.data.result?c.crm.content.reload().then(function(){d.dialog.close();c.crm.content.load(h)}):"no_vault_access"===n.data.result&&(c(".crm-dialog-header h1").html(d.$errorh1),c(".crm-dialog-content p, .js-responsible-list").html(""),c(".crm-dialog-footer").html('<a class="button js-close-dialog" href="javascript:void(0);">'+d.$close_dialog+"</a>"),c(".no-access-error").html(n.data.message),c.each(n.data.users,
function(m,p){c(".no-access-users").append('<a href="'+p.id+'" style="display: block; margin-top: 10px;"><i class="icon16 userpic20" style="background-image: url('+p.photo+');"></i><span>'+p.name+"</span></a>")}))},"json").always(function(){d.$submitButton.attr("disabled",!1);d.toggleButton(!1);l.remove();e=!1})}}function b(){var f=c("#responsible_id").val();return{contact_ids:c("#contact_ids").val(),responsible_id:f}}var d=this,e=!1;d.$form.on("submit",function(f){f.preventDefault();a()})};CRMContactsOperationAssignResponsible.prototype.initAutocomplete=
function(){function a(e){e.addClass("highlighted");setTimeout(function(){e.removeClass("highlighted")},2E3)}var b=this,d=b.$responsibleList.find(".js-autocomplete");d.autocomplete({source:c.crm.app_url+"?module=autocomplete&type=user",appendTo:b.$wrapper,minLength:0,focus:function(){return!1},select:function(e,f){e=b.$responsibleList.find('.c-responsible[data-id="'+f.item.id+'"]');e=e.length?e:void 0;if(!e){f=f.item;var g=b.responsible_template_html;e=f.photo_url;g=g.replace(/%id%/,f.id);var l=g.replace;
var k=f.name;k=c("<div></div>").text(k).html();g=l.call(g,"%name%",k).replace("%photo_url%",e);c("#responsible_id").val(f.id);f=c(g);b.$responsibleList.append(f);c(".js-input").css("display","none");b.$submitButton.attr("disabled",!1);b.toggleButton(!0);e=f}a(e);b.toggleButton(!0);d.val("");return!1}}).data("ui-autocomplete")._renderItem=function(e,f){return c('<li class="ui-menu-item-html"><div>'+f.value+"</div></li>").appendTo(e)};d.on("focus",function(){d.data("uiAutocomplete").search(d.val())});
b.$responsibleList.on("click",".js-delete-responsible",function(){c(this).closest(".c-responsible").remove();c("#responsible_id").val("");c(".js-input").css("display","");c(".js-autocomplete").focus();b.$submitButton.attr("disabled",!0);b.toggleButton(!0)})};CRMContactsOperationAssignResponsible.prototype.toggleButton=function(a){var b=this.$submitButton;a?b.removeClass("green").addClass("yellow"):b.removeClass("yellow").addClass("green")};return CRMContactsOperationAssignResponsible}(jQuery);var CRMContactsOperationDelete=function(c){CRMContactsOperationDelete=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".crm-delete");this.context=a.context||{};this.dialog=this.$wrapper.data("dialog");this.is_contact_page=a.is_contact_page||0;this.initClass()};CRMContactsOperationDelete.prototype.initClass=function(){this.initStartDelete()};CRMContactsOperationDelete.prototype.initStartDelete=function(){var a=this,b=a.$button,d=c(".crm-loading",a.$wrapper),e=c.crm.app_url+"?module=contactOperation&action=deleteProcess",
f=c.extend({},a.context,!0);b.click(function(g){g.preventDefault();d.show();b.attr("disabled",!0);c.post(e,f).done(function(l){a.dialog.close();"ok"===l.status&&(a.is_contact_page?c.crm.content.load(c.crm.app_url+"contact/"):c.crm.content.reload(),c.crm.sidebar.reload())}).always(function(){d.hide();b.attr("disabled",!1)})})};return CRMContactsOperationDelete}(jQuery);var CRMContactSegmentEdit=function(c){CRMContactSegmentEdit=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$button=this.$form.find(":submit");this.$icons_block=this.$wrapper.find(".crm-icons-block");this.$icon_input=this.$wrapper.find("[name=icon]");this.segment=a.segment||{};this.messages=a.messages||{};this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMContactSegmentEdit.prototype.initClass=function(){this.$wrapper.find(".crm-name-input").focus();this.initIcons();
this.initSubmit();this.bindEvents();0<this.segment.id&&this.initDeleteLink()};CRMContactSegmentEdit.prototype.initIcons=function(){var a=this;a.$icons_block.on("click","li a",function(b){b.preventDefault();b=c(this).closest("li");var d=b.data("icon");a.$icons_block.find("li.selected").removeClass("selected");a.$icon_input.val(d);b.addClass("selected");a.clearValidateErrors()})};CRMContactSegmentEdit.prototype.bindEvents=function(){var a=this,b=a.$form,d=null;b.on("change",":input",function(){a.clearValidateErrors()});
b.on("keyup",":input",function(){d&&clearTimeout(d);d=setTimeout(function(){a.clearValidateErrors()},200)})};CRMContactSegmentEdit.prototype.showValidateErrors=function(a){var b=this.$form;c.each(a||{},function(d,e){b.find(':input[name="'+d+'"]').addClass("state-error").after('<span class="errormsg">'+e+"</span>")})};CRMContactSegmentEdit.prototype.clearValidateErrors=function(){var a=this.$form;a.find(".state-error").removeClass("state-error");a.find(".errormsg").remove()};CRMContactSegmentEdit.prototype.initSubmit=
function(){var a=this,b=a.$form,d=b.find(".crm-loading"),e=a.$button;b.submit(function(f){f.preventDefault();a.clearValidateErrors();e.attr("disabled",!0);d.show();c.post(b.attr("action"),b.serialize()).done(function(g){if("ok"!==g.status)e.attr("disabled",!1),d.hide(),a.showValidateErrors(g.errors||{});else if(!a.dialog.options.afterSave||!1!==a.dialog.options.afterSave(g))a:if(g.data.segment){var l="search"==a.segment.type,k="category"===g.data.segment.type?"category":"search",h=g.data.segment.id;
if(0>=a.segment.id){if("search"===k&&!l){c.crm.content.load(c.crm.app_url+"contact/search/segment/"+g.data.segment.id+"/");break a}c.crm.storage.set("crm/create/category",{id:h,timestamp:+new Date})}c.crm.content.load(c.crm.app_url+"contact/segment/"+g.data.segment.id+"/")}})})};CRMContactSegmentEdit.prototype.initDeleteLink=function(){var a=this,b=a.$wrapper.find(".crm-delete-link"),d=null,e=c.crm.app_url+"?module=dialogConfirm",f=null,g=c.crm.app_url+"?module=contactSegment&action=delete";b.click(function(l){l.preventDefault();
d&&d.abort();d=c.post(e,{title:a.messages.delete_confirm_title,text:a.messages.delete_confirm_text,ok_button:a.messages.delete_button}).done(function(k){a.dialog.close();new CRMDialog({html:k,onConfirm:function(){f&&f.abort();f=c.post(g,{id:a.segment.id}).done(function(h){"ok"===h.status&&c.crm.content.load(c.crm.app_url+"contact/")}).always(function(){f=null});return!1}})}).always(function(){d=null})})};return CRMContactSegmentEdit}(jQuery);var CRMContactSegmentAddContacts=function(c){CRMContactSegmentAddContacts=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$button=this.$form.find(".js-submit-button");this.$find_contact=this.$wrapper.find(".js-find-contact");this.$contact_list=this.$wrapper.find(".c-contact-list");this.segment=a.segment||{};this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMContactSegmentAddContacts.prototype.initClass=function(){this.initAutocomplete();this.initDeleteLinks();
this.initSubmit()};CRMContactSegmentAddContacts.prototype.initAutocomplete=function(){var a=this.$find_contact,b=this.$contact_list,d=b.find(".is-template");a.focus();a.autocomplete({source:"?module=autocomplete",minLength:2,focus:function(){return!1},select:function(e,f){e=d.clone().removeClass("is-template");e.find(".c-contact-id").val(f.item.id);e.find(".c-contact-name").text(f.item.name);e.find(".c-contact-icon").css("backgroundImage","url("+f.item.photo_url+")");b.append(e.show());a.val("");
return!1}}).data("ui-autocomplete")._renderItem=function(e,f){return c("<li />").addClass("ui-menu-item-html").append("<div>"+f.value+"</div>").appendTo(e)}};CRMContactSegmentAddContacts.prototype.initDeleteLinks=function(){this.$wrapper.on("click",".c-contact-delete-link",function(a){a.preventDefault();c(this).closest(".c-contact-item").remove()})};CRMContactSegmentAddContacts.prototype.initSubmit=function(){var a=this,b=a.$form,d=a.$button,e=b.find(".c-loading");b.submit(function(f){f.preventDefault();
e.show();d.prop("disabled",!0);c.post(b.attr("action"),b.serialize()).done(function(g){"ok"==g.status&&c.crm.content.load(c.crm.app_url+"contact/segment/"+a.segment.id+"/")}).always(function(){e.hide();d.prop("disabled",!1);a.dialog.close()})})};return CRMContactSegmentAddContacts}(jQuery);var CRMContactEditForm=function(c){CRMContactEditForm=function(a){this.$wrapper=a.$wrapper;this.$phoneList=this.$wrapper.find(".js-phone-list");this.$emailList=this.$wrapper.find(".js-email-list");this.phone_template_html=a.phone_template_html;this.email_template_html=a.email_template_html;this.initClass()};CRMContactEditForm.prototype.initClass=function(){this.initAddPhone();this.initAddEmail();this.initCompanyAutocomplete()};CRMContactEditForm.prototype.initAddPhone=function(){function a(e,f){e.preventDefault();
e=c(b.phone_template_html);f&&(e.find(".js-value").val(f.number).trigger("change"),e.find(".js-ext").val(f.ext).trigger("change"));d.append(e)}var b=this,d=b.$phoneList;b.$wrapper.on("click",".js-add-phone",a);b.$wrapper.on("click",".js-remove-phone",function(e){e.preventDefault();c(this).closest("li").remove()});c(document).on("addContactPhone",function(e,f){a(e,f)})};CRMContactEditForm.prototype.initAddEmail=function(){function a(e,f){e.preventDefault();e=c(b.email_template_html);f&&(e.find(".js-value").val(f.name).trigger("change"),
e.find(".js-ext").val(f.ext).trigger("change"));d.append(e)}var b=this,d=b.$emailList;b.$wrapper.on("click",".js-add-email",a);b.$wrapper.on("click",".js-remove-email",function(e){e.preventDefault();c(this).closest("li").remove()});c(document).on("addContactEmail",function(e,f){a(e,f)})};CRMContactEditForm.prototype.initCompanyAutocomplete=function(){var a=this.$wrapper.find('[name="contact[company]"]'),b=this.$wrapper.find('[name="contact[company_contact_id]"]');a.length&&(a.autocomplete({appendTo:this.$wrapper,
source:"?module=autocomplete&type=company",minLength:2,focus:function(){return!1},select:function(d,e){d=c("<div />").text(e.item.name).text();a.val(d);b.val(0<e.item.id?e.item.id:"");return!1},search:function(){b.val("")}}).data("ui-autocomplete")._renderItem=function(d,e){return c("<li />").addClass("ui-menu-item-html").append("<div>"+e.value+"</div>").appendTo(d)})};return CRMContactEditForm}(jQuery),CRMContactAddDialog=function(c){CRMContactAddDialog=function(a){this.$wrapper=a.$wrapper;this.contact_id=
a.contact_id;this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMContactAddDialog.prototype.initClass=function(){this.$wrapper.find(".js-focus-field").focus();this.initToggle();this.initContactForm();this.initCompanyForm()};CRMContactAddDialog.prototype.initToggle=function(){var a=this,b=a.$wrapper.find(".js-content-toggle-wrapper"),d=b.find(".js-ibutton"),e=a.$wrapper.find(".js-toggle-content.is-selected");d.iButton({labelOn:"",labelOff:"",classContainer:"c-ibutton ibutton-container mini"});
d.on("change",function(){var f="checked"===d.attr("checked"),g=a.$wrapper.find('.js-toggle-content[data-content="'+(f?"company":"contact")+'"]');f?b.addClass("is-on"):b.removeClass("is-on");e.length&&e.removeClass("is-selected");g.length&&(e=g.addClass("is-selected"));a.$wrapper.find(".js-focus-field").focus();a.dialog.resize()})};CRMContactAddDialog.prototype.initContactForm=function(){function a(){var f=d.find(".js-phone-list"),g=d.find(".js-email-list");f.find("li .js-value, li .js-ext").removeAttr("name");
g.find("li .js-value, li .js-ext").removeAttr("name");var l=e.serializeArray(),k={data:[],errors:[]},h=["contact[firstname]","contact[middlename]","contact[lastname]","contact[name]"],n=!0;c.each(l,function(m,p){k.data.push({name:p.name,value:p.value});0<c.trim(p.value).length&&0<=h.indexOf(p.name)&&(n=!1)});n&&(k.errors.push({name:"contact[firstname]",value:"Name is empty"}),k.errors.push({name:"contact[name]",value:"Name is empty"}));f.find("li").each(function(m){var p=c(this),q=p.find(".js-value");
p=p.find(".js-ext");var r=q.val(),u=p.val();if(r){var v="contact[phone]["+m+"][value]";q.attr("name",v);k.data.push({name:v,value:r});m="contact[phone]["+m+"][ext]";p.attr("name",m);k.data.push({name:m,value:u})}});g.find("li").each(function(m){var p=c(this),q=p.find(".js-value");p=p.find(".js-ext");var r=q.val(),u=p.val();if(r){var v="contact[email]["+m+"][value]";q.attr("name",v);k.data.push({name:v,value:r});m="contact[email]["+m+"][ext]";p.attr("name",m);k.data.push({name:m,value:u})}});return k}
var b=this,d=b.$wrapper.find('.js-toggle-content[data-content="contact"]'),e=d.find("form");(function(){function f(h){c.post(b.contact_id?"?module=deal&action=contactUpdate":"?module=contact&action=save",h,function(n){"ok"==n.status?(b.dialog.close(),c.crm.content.load(c.crm.app_url+"contact/"+n.data.contact.id+"/")):n.errors&&g(n.errors)},"json").always(function(){k=!1})}function g(h){h=h?h:[];c.each(h,function(n,m){n=m.name;m=m.value;"name"===n&&(n="contact[firstname]");var p=e.find('[name="'+n+
'"]'),q=c("<span />").addClass("errormsg").text(m);p.length?p.hasClass("error")||(p.parent().append(q),p.addClass("error").one("focus click",function(){p.removeClass("error");q.remove()})):(l.append(q),e.one("submit",function(){q.remove()}))})}var l=b.$wrapper.find(".js-errors-place"),k=!1;e.on("submit",function(h){h.preventDefault();k||(k=!0,h=a(),h.errors.length?(g(h.errors),k=!1):f(h.data))})})();(function(){d.on("click",".js-extended-form",function(){var f=a(),g=[];g.push("extended=true");c.each(f.data,
function(l,k){(l=c.trim(k.value))&&g.push(k.name+"="+l)});f=c.crm.app_url+"contact/new/?"+g.join("&");c.crm.content.load(f)})})();a()};CRMContactAddDialog.prototype.initCompanyForm=function(){function a(){var f=d.find(".js-phone-list"),g=d.find(".js-email-list");f.find("li .js-value, li .js-ext").removeAttr("name");g.find("li .js-value, li .js-ext").removeAttr("name");var l=e.serializeArray(),k={data:[],errors:[]},h=["contact[firstname]","contact[middlename]","contact[lastname]","contact[name]"],
n=!0;c.each(l,function(m,p){k.data.push({name:p.name,value:p.value});0<c.trim(p.value).length&&0<=h.indexOf(p.name)&&(n=!1)});n&&(k.errors.push({name:"contact[firstname]",value:"Name is empty"}),k.errors.push({name:"contact[name]",value:"Name is empty"}));f.find("li").each(function(m){var p=c(this),q=p.find(".js-value");p=p.find(".js-ext");var r=q.val(),u=p.val();if(r){var v="contact[phone]["+m+"][value]";q.attr("name",v);k.data.push({name:v,value:r});m="contact[phone]["+m+"][ext]";p.attr("name",
m);k.data.push({name:m,value:u})}});g.find("li").each(function(m){var p=c(this),q=p.find(".js-value");p=p.find(".js-ext");var r=q.val(),u=p.val();if(r){var v="contact[email]["+m+"][value]";q.attr("name",v);k.data.push({name:v,value:r});m="contact[email]["+m+"][ext]";p.attr("name",m);k.data.push({name:m,value:u})}});return k}var b=this,d=b.$wrapper.find('.js-toggle-content[data-content="company"]'),e=d.find("form");(function(){function f(){var n={data:[],errors:[]},m=e.serializeArray();c.each(m,function(p,
q){q.value=c.trim(q.value);"contact[company]"===q.name&&n.data.push({name:"contact[name]",value:q.value});n.data.push(q)});m=d.find(".js-phone-list");m.find("li .js-value, li .js-ext").removeAttr("name");m.find("li").each(function(p){var q=c(this),r=q.find(".js-value");q=q.find(".js-ext");var u=r.val(),v=q.val();if(u){var t="contact[phone]["+p+"][value]";r.attr("name",t);n.data.push({name:t,value:u});p="contact[phone]["+p+"][ext]";q.attr("name",p);n.data.push({name:p,value:v})}});m=d.find(".js-email-list");
m.find("li .js-value, li .js-ext").removeAttr("name");m.find("li").each(function(p){var q=c(this),r=q.find(".js-value");q=q.find(".js-ext");var u=r.val(),v=q.val();if(u){var t="contact[email]["+p+"][value]";r.attr("name",t);n.data.push({name:t,value:u});p="contact[email]["+p+"][ext]";q.attr("name",p);n.data.push({name:p,value:v})}});n.data.push({name:"contact[is_company]",value:1});return n}function g(n){n=n?n:[];c.each(n,function(m,p){m=p.name;p=p.value;var q=d.find('[name="'+m+'"]');"contact[firstname]"!==
m||q.is(":visible")||(q=d.find(".js-contact-autocomplete"));var r=c("<span class='c-error' />").addClass("errormsg").text(p);q.length&&!q.hasClass("error")?(q.parent().append(r),q.addClass("error").one("focus click change",function(){q.removeClass("error");r.remove()})):(h.append(r),e.one("submit",function(){remove(r)}))})}function l(n){k||(k=!0,c.post(b.contact_id?"?module=deal&action=contactUpdate":"?module=contact&action=save",n,function(m){"ok"===m.status?(b.dialog.close(),c.crm.content.load(c.crm.app_url+
"contact/"+m.data.contact.id+"/")):m.errors&&g(m.errors)},"json").always(function(){k=!1}))}var k=!1,h=d.find(".js-errors-place");e.on("submit",function(n){n.preventDefault();n=f();n.errors.length?g(errors):l(n.data)})})();(function(){d.on("click",".js-extended-form",function(){var f=a(),g=[];g.push("extended=true");g.push("type=company");c.each(f.data,function(l,k){(l=c.trim(k.value))&&g.push(k.name+"="+l)});f=c.crm.app_url+"contact/new/?"+g.join("&");c.crm.content.load(f)})})()};return CRMContactAddDialog}(jQuery),
CRMDealParticipantAdd=function(c){CRMDealParticipantAdd=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$content=this.$wrapper.find(".crm-dialog-content");this.dialog=this.$wrapper.data("dialog");this.deal_id=a.deal_id;this.initClass()};CRMDealParticipantAdd.prototype.initClass=function(){var a=this.$wrapper.find(".js-contact-autocomplete");a.length&&a.focus();this.initAddParticipant()};CRMDealParticipantAdd.prototype.initAddParticipant=function(){function a(f){function g(k){var h=
c('<div class="line errormsg" />').html(k);d.$content.append(h);d.$form.one("submit",function(){h.remove()})}if(f[0])c.each(f,function(k,h){g(h.value)});else{var l=Object.keys(f);c.each(l,function(k,h){g(f[h])})}}function b(f){e||(e=!0,c.post("?module=deal&action=addParticipantSave",f,function(g){"ok"==g.status?(d.dialog.options.onAdd(g.data.html),d.dialog.close()):g.errors&&a(g.errors)}).always(function(){e=!1}))}var d=this,e=!1;d.$form.on("submit",function(f){f.preventDefault();f=d.$form.serializeArray();
var g=[];g.length?a(g):b(f)})};return CRMDealParticipantAdd}(jQuery),CRMContactAddForm=function(c){CRMContactAddForm=function(a){this.$wrapper=a.$wrapper;this.$toggleW=this.$wrapper.find(".js-contact-view-toggle");this.initClass()};CRMContactAddForm.prototype.initClass=function(){this.initToggle();this.initContactAutocomplete();this.initCompanyAutocomplete()};CRMContactAddForm.prototype.initContactAutocomplete=function(){function a(n){if(0<n.id)e.val(n.name),g.val(n.id),b(n.data);else if(0>n.id){g.val("");
d.$toggleW.find(".js-show-fio").trigger("click",!0);f.val("");var m=0<=n.name.indexOf("@"),p=!!n.name.match(/^\+?\d/);m?d.$wrapper.find(".js-email-field").val(n.name).trigger("change"):p?d.$wrapper.find(".js-phone-field").val(n.name).trigger("change"):d.$wrapper.find(".js-firstname,.js-name").val(n.name).trigger("change")}}function b(n){c.each(l,function(m,p){m=n[p];var q="phone"===p||"email"===p,r;if(q){m="";for(r=(n[p]||[]).reverse();""==m&&0<r.length;)m=r.pop();c.isPlainObject(m)&&(m=m.value)}m=
c.trim(m||"");""!=m&&(p=q?d.$wrapper.find('[name="contact['+p+'][0][value]"]'):d.$wrapper.find('[name="contact['+p+']"]'),p.val(m))});f.attr("disabled",!0)}var d=this,e=d.$wrapper.find(".js-contact-autocomplete"),f=d.$wrapper.find(".js-field"),g=d.$wrapper.find(".js-contact-id-field"),l=["firstname","company","jobtitle","phone","email"],k="?module=autocomplete&add_new=true&join="+l.join(","),h=!1;e.autocomplete({appendTo:d.$wrapper,source:k,minLength:2,html:!0,focus:function(){return!1},select:function(n,
m){h=!0;a(m.item);e.blur();return!1},search:function(){g.val("")},open:function(){h=!1},change:function(){h||a({id:-1,name:e.val()})}}).data("ui-autocomplete")._renderItem=function(n,m){return c("<li />").addClass("ui-menu-item-html").append("<div>"+m.value+"</div>").appendTo(n)};e.on("keydown",function(n){13!==n.keyCode&&(f.attr("disabled",!1),f.val(""))})};CRMContactAddForm.prototype.initCompanyAutocomplete=function(){var a=this.$wrapper.find(".js-company-autocomplete"),b=this.$wrapper.find(".js-company-id-field");
if(!a.length||!b.length)return!1;a.autocomplete({appendTo:this.$wrapper,source:"?module=autocomplete&type=company",minLength:2,html:!0,focus:function(){return!1},select:function(d,e){a.val(e.item.name);b.val(e.item.id);return!1},search:function(){b.val("")}}).data("ui-autocomplete")._renderItem=function(d,e){return c("<li />").addClass("ui-menu-item-html").append("<div>"+e.value+"</div>").appendTo(d)}};CRMContactAddForm.prototype.initToggle=function(){var a=this,b=a.$toggleW,d=b.find(".is-active"),
e=a.$wrapper.find(".js-action-field"),f=a.$wrapper.find(".js-field"),g=a.$wrapper.find(".js-fio"),l=a.$wrapper.find(".js-combo-name");b.on("click",".c-toggle",function(k,h){k.preventDefault();h=!h;k=c(this);var n=k.data("mode");if(k.hasClass("is-active"))return!1;d.length&&d.removeClass("is-active");k.addClass("is-active");d=k;h&&a.$wrapper.find("input").val("").trigger("change");"fio"===n?(g.show(),l.hide(),e.val("new"),f.attr("disabled",!1)):(g.hide(),l.show(),e.val("search"));c(document).trigger("toggleChanged");
c(document).trigger("resizeDialog")})};return CRMContactAddForm}(jQuery),CRMCompanyAddForm=function(c){CRMCompanyAddForm=function(a){this.$wrapper=a.$wrapper;this.phone_template_html=a.phone_template_html;this.email_template_html=a.email_template_html;this.initClass()};CRMCompanyAddForm.prototype.initClass=function(){this.initAddPhone();this.initAddEmail()};CRMCompanyAddForm.prototype.initAddPhone=function(){var a=this,b=a.$wrapper.find(".js-phone-list");a.$wrapper.on("click",".js-add-phone",function(d){d.preventDefault();
d=c(a.phone_template_html);b.append(d)});a.$wrapper.on("click",".js-remove-phone",function(d){d.preventDefault();c(this).closest("li").remove()})};CRMCompanyAddForm.prototype.initAddEmail=function(){function a(e,f){e.preventDefault();e=c(b.email_template_html);f&&(e.find(".js-value").val(f.name).trigger("change"),e.find(".js-ext").val(f.ext).trigger("change"));d.append(e)}var b=this,d=b.$wrapper.find(".js-email-list");b.$wrapper.on("click",".js-add-email",a);b.$wrapper.on("click",".js-remove-email",
function(e){e.preventDefault();c(this).closest("li").remove()});c(document).on("addContactEmail",function(e,f){a(e,f)})};return CRMCompanyAddForm}(jQuery);var CRMContactImportPage=function(c){CRMContactImportPage=function(a){this.$wrapper=a.$wrapper;this.$iframe=this.$wrapper.find("iframe");this.initClass()};CRMContactImportPage.prototype.initClass=function(){this.initViewToggle();this.initSubmit()};CRMContactImportPage.prototype.initSubmit=function(){function a(f){f.on("change keydown","input, select, textarea",function(){f.find("input:submit").attr("disabled",!1)});f.on("submit",function(){f.find(".loading").show();e=!0})}var b=this,d=b.$iframe,e=
!1;b.$wrapper.find("form").each(function(){a(c(this))});d.on("load",function(){if(!e)return!1;var f=c(this).contents().find("body").html(),g=null;try{g=JSON.parse(f)}catch(l){}g&&g.errors?(b.$wrapper.find(".loading").hide(),alert(g.errors)):c.crm.content.load(c.crm.app_url+"contact/import/upload/")})};CRMContactImportPage.prototype.initViewToggle=function(){var a=this,b=a.$wrapper.find(".js-view-toggle"),d=b.find(".selected").data("content");b.on("click",".c-toggle",function(e){e.preventDefault();
var f=c(this).data("content"),g=f===d;console.log(e.target);if(g)return!1;d=f;a.$wrapper.find(".js-toggle-content.is-active").removeClass("is-active");e=a.$wrapper.find('.js-toggle-content[data-content="'+f+'"]');e.length&&e.addClass("is-active")})};return CRMContactImportPage}(jQuery);var crmContactImportUpload=function(c){var a=function(d){var e=d.$wrapper,f=e.find("form"),g=e.find(".crm-import-upload-table"),l=e.find(".crm-import-upload-button"),k=e.find(".crm-total-count-column .crm-count");this.$wrapper=e;this.$form=f;var h=d.fieldInfo,n=/[\s~!@#\$%\^&\*\(\)_\+\|\\=\-`\{\}:"<>\?\[\];',\.\/]+/g,m=function(u,v){u+=1;v?(g.find("td:nth-child("+u+")").addClass("crm-highlight-cell"),l.attr("disabled",!1)):g.find("td:nth-child("+u+")").removeClass("crm-highlight-cell")};c("select",
g).each(function(u){c(this).change(function(){m(u,c(this).val())})});var p=function(){c(this).is(":checked")?(g.find("tbody tr:first").removeClass("crm-ignored-row"),k.html((parseInt(k.html(),10)||0)+1)):(g.find("tbody tr:first").addClass("crm-ignored-row"),k.html(parseInt(k.html(),10)-1||""))};c("input[name='first_line']",f).change(p);var q=!1,r=g.find("select");g.find("tbody tr:first-child td").each(function(u,v){var t=null,w=0,x=!1;v=c(v).text().toLowerCase().replace(n,"");for(var y in h){var z=
h[y],B=!1,C=0,A=!1;y.length>w&&!x&&0==v.indexOf(y)&&(C=y.length,B=!0);var D=z.name.toLowerCase().replace(n,"");D&&D.length>w&&0==v.indexOf(D)&&(C=D.length,A=B=!0);if(B){D=B=null;if(z.fields){for(var E in z.fields){if(0<=v.indexOf(E)){B=E;C+=E.length;break}if(0<=v.indexOf(z.fields[E].name.toLowerCase().replace(n,""))){B=E;C+=z.fields[E].name.length;break}}if(!B)continue}if(z.ext)for(var F in z.ext){if(0<=v.indexOf(F)){D=F;break}if(0<=v.indexOf(z.ext[F].toLowerCase().replace(n,""))){D=F;break}}t=y+
(B?":"+B:"")+(D?"."+D:"");w=C;x=A}}t&&w&&(r.eq(u).val(t),m(u,!0),q=!0)});q&&p.call(f.find("input[name='first_line']").attr("checked",!1));this.initCreateDealsSettings();this.initAddToSegments();f.submit(function(u){u.preventDefault();u=e.find(".crm-warning-require-primary-fields").hide();var v=!1;g.find("select").each(function(){var t=c(this).val();if("firstname"==t||"lastname"==t||"company"==t||"email"==t.substr(0,5))return v=!0,!1});v?(e.find(".crm-loading").show(),(new b({$wrapper:e,need_validation:f.find("[name=validate]").is(":checked"),
messages:d.messages||{}})).run()):u.show()})};a.prototype.initCreateDealsSettings=function(){var d=this.$form,e=d.find('[name="create_deals"]'),f=d.find(".crm-deals-settings-wrapper"),g=d.find('[name="deal_funnel_id"]'),l=d.find('[name="deal_stage_id"]');e.click(function(){c(this).is(":checked")?f.show():f.hide()});g.change(function(){l.load("?module=contactImportUpload&action=stagesByFunnel&id="+c(this).val())})};a.prototype.initAddToSegments=function(){var d=this.$form;d.find('[name="add_to_segments"]').click(function(){c(this).is(":checked")?
c.get(c.crm.app_url+"?module=contactOperation&action=AddToSegments",function(e){c.waDialog({html:e,onOpen:function(f){new CRMContactsOperationAddToSegments({$wrapper:f,onSave:function(g,l){var k=l.data("dialog"),h=[],n=[];l=c(".c-segment-item",l);for(var m=0;m<g.segment_ids.length;m+=1){var p=g.segment_ids[m],q=l.filter('[data-id="'+p+'"]');h.push(q.find(".c-name").text());n.push('<input type="hidden" name="segment_id[]" value="'+p+'">')}h="<span>"+h.join(",")+"</span>";n=n.join(" ");c(".c-add-to-segments-names",
d).html(h+n);k.close();return!1}})}})}):c(".c-add-to-segments-names",d).html("")})};var b=function(d){this.$wrapper=d.$wrapper;this.$form=this.$wrapper.find("form");this.processId=null;this.requests=0;this.$loading=this.$wrapper.find(".crm-loading");this.timer=null;this.messages=d.messages||{};this.url=c.crm.app_url+"?module=contact&action=importProcess"+(d.need_validation?"&need_validation=1":"");this.$progress_bar_dialog=this.$wrapper.find(".crm-import-progressbar-dialog");this.$progress_bar=this.$progress_bar_dialog.find(".crm-progressbar")};
b.prototype.run=function(){var d=this,e=function(){d.timer&&clearTimeout(d.timer);d.timer=setTimeout(e,3E3+400*(Math.random()-.5));!d.processId||2<=d.requests||(c.get(d.url,{processid:d.processId,t:Math.random()},function(f){d.requests--;var g=d.$progress_bar.find(".ui-progressbar-value");g.stop();g.clearQueue();d.processId&&f.ready?d.processId&&(d.timer&&clearTimeout(d.timer),d.timer=null,g.animate({width:"100%"},{duration:500,complete:function(){c.post(d.url,{processid:d.processId,file:1},"json");
var l="";l=0<f.rowsRejected?0>=f.rowsAdded?d.messages.no_imported:d.messages.some_imported:d.messages.all_imported;c.waDialog.alert({text:l,button_title:d.messages.button,button_class:"gray",onClose:function(){location.href=0<f.rowsAdded?c.crm.app_url+"contact/import/result/"+f.timeStart+"/":c.crm.app_url+"contact/import/"}})},queue:!1})):g.animate({width:""+Math.round(100*f.done/f.total)+"%"},{duration:500,queue:!1})},"json"),d.requests++)};c.post(d.url,d.$form.serializeArray(),function(f){d.processId=
f.processId;d.processId&&(d.$progress_bar_dialog.show(),d.$progress_bar.progressbar({value:0}),e())},"json")};return a}(jQuery);var CRMContactsMergePage=function(c){CRMContactsMergePage=function(a){this.$wrapper=a.$wrapper;this.$table=this.$wrapper.find(".js-duplicates-table");this.$form=this.$wrapper.find("form");this.$merge_field=this.$wrapper.find(".crm-search-duplicates-by-field");this.$auto_merge_link=this.$wrapper.find(".crm-auto-merge-duplicates-link");this.$auto_merge_start_button=this.$wrapper.find(".crm-auto-merge-duplicates-start");this.$auto_merge_pause_button=this.$wrapper.find(".crm-auto-merge-duplicates-break");
this.$auto_merge_resume_button=this.$wrapper.find(".crm-auto-merge-duplicates-resume");this.is_admin=a.is_admin;this.groups_count=a.groups_count;this.messages=a.messages;this.initClass()};CRMContactsMergePage.prototype.initClass=function(){this.initSubmit();this.initAutoMerge();this.initGroupMergeLinks()};CRMContactsMergePage.prototype.initSubmit=function(){var a=this;a.$form.on("submit",function(b){b.preventDefault();c(this).find(".js-icon").remove().end().find(".js-loading").show();b=a.$merge_field.val();
location.href=c.crm.app_url+"?module=contactMergeDuplicates&field="+b+(c.crm.iframe?"&iframe=1":"")})};CRMContactsMergePage.prototype.initAutoMerge=function(){var a=this,b=a.$wrapper,d=a.$merge_field,e=a.$wrapper.find(".crm-auto-merge-duplicates-start-text"),f=a.$wrapper.find(".crm-auto-merge-duplicates-progress"),g=a.$table,l=a.$auto_merge_start_button,k=a.$auto_merge_pause_button,h=a.$auto_merge_resume_button,n=null,m=!1;a.$auto_merge_link.on("click",function(r){r.preventDefault();e.toggle();l.toggle()});
var p=function(r,u){var v=a.messages.progress,t=Math.round(1E3*parseFloat(r/u))/10;r=v.replace(":percentage:",t||0).replace(":count:",r).replace(":total_count:",u);f.find(".crm-text").text(r)},q=function(){var r=d.val(),u=0,v=a.groups_count;k.show();l.hide();h.hide();f.show();b.find(".pager").hide();var t=function(){var C=b.find(".crm-merge.crm-js-partial").length;c.get(c.crm.app_url+"?module=contact&action=mergeDuplicates",{offset:C,field:r,no_js:1}).done(function(A){if(A){A=c("<div>").html(A);var D=
A.find(".crm-duplicates-table tbody").find(".crm-mergeduplicates-row");D.length?(g.find("tbody").append(D),z()):B();A.remove()}else B()})},w=function(C){var A=c.crm.app_url+"?module=contact&action=mergeDuplicatesGetContacts";C.attr("data-field-value");c.get(A,{field:r,value:C.attr("data-field-value"),master_slaves:1},function(D){D&&"ok"===D.status&&!c.isEmptyObject(D.data)?x(C,D.data):(C.addClass("crm-finished"),n.resolve())},"json").fail(function(){n.resolve()})},x=function(C,A){crmContactMerger.merge({master_id:A.master,
slave_ids:A.slaves,onDone:function(D){if(D.result&&D.result.total_count===D.result.merged_count){var E=c.crm.app_url+"contact/"+D.master.id+"/";C.closest("tr").find("td:not(:first)").css({textDecoration:"line-through"}).end().find("td:first").html('<a href="'+E+'" target="_blank">'+c.crm.encodeHTML(D.master.name)+"</a>")}else C.addClass("crm-partial");D=D.message||a.messages.done||"Done";C.closest("td").css({textDecoration:""}).html('<span class="float-right" style="margin-right: 10px;">'+D+"</span>").append(C.hide().addClass("crm-finished"));
n.resolve()},onError:function(){n.resolve()}})},y=function(){m?setTimeout(y,1E3):z()},z=function(){var C=b.find(".crm-merge:not(.crm-finished):first");C.length?(C.parent().find(".crm-loading").css("opacity",1),n=new c.Deferred,n.fail(function(){k.hide();h.show()}),n.done(function(){u+=1;p(u,v);m?y():z()}),w(C)):u<v?t():B()},B=function(){l.hide();h.hide();k.hide();f.hide();a.$wrapper.find(".crm-attention-message").hide();a.$wrapper.find(".crm-done-message").show()};z()};l.click(function(r){r.preventDefault();
q()});h.click(function(r){r.preventDefault();k.show();h.hide();m=!1});k.click(function(r){r.preventDefault();m=!0;k.hide();h.show()});p(0,a.groups_count)};CRMContactsMergePage.prototype.initGroupMergeLinks=function(){var a=(new URLSearchParams(document.location.search)).get("iframe");if(window.parent&&a)this.$table.find(".js-merge-group-link").on("click",function(b){b.preventDefault();window.parent.history&&window.parent.history.pushState?window.parent.history.pushState({reload:!0},"",this.href):
window.parent.location.href=this.href})};return CRMContactsMergePage}(jQuery);var crmContactMerge=function(c){var a=function(b){this.$wrapper=b.$wrapper;this.$button=this.$wrapper.find(".crm-merge-submit");this.slave_ids=b.slave_ids||[];this.messages=b.messages||{};this.is_admin=b.is_admin;this.initClass()};a.prototype.initClass=function(){this.initSelectors();this.initMergeButton();this.$wrapper.on("click",".crm-contact-row-wrapper",function(b){var d=c(this).find(".crm-selector");d[0]!==b.target&&d.click()})};a.prototype.initSelectors=function(){var b=this;b.$wrapper.on("click",
".crm-selector",function(d){var e=c(this).closest(".crm-contact-row-wrapper"),f=e.find(".crm-contact-row");d=b.$wrapper.find(".crm-merge-description");b.$wrapper.find(".crm-js-hide-when-not-selected").hide();b.$wrapper.find(".crm-selected").removeClass("crm-selected");f.addClass("crm-selected");f.find(".crm-js-hide-when-not-selected").show();e=e.find(".crm-merge-description-for-master").html();d.html(e);d.find(".crm-js-not-allowed-as-master").length?b.$button.prop("disabled",!0):b.$button.prop("disabled",
!1)})};a.prototype.initMergeButton=function(){var b=this,d=b.slave_ids,e=b.$wrapper.find(".crm-loading");b.$button.click(function(f){f.preventDefault();var g=b.$wrapper.find(".crm-selector:checked").val();g?0<=d.indexOf(g)&&1===d.length?alert(b.messages.choose_master):(b.$button.attr("disabled",!0),e.show(),crmContactMerger.merge({master_id:g,slave_ids:d,onDone:function(){c.crm.storage.del("crm/merge/field");var l=c.crm.app_url+"contact/"+g+"/",k=(new URLSearchParams(document.location.search)).get("iframe");
window.parent&&k?window.history&&history.pushState?window.parent.history.pushState({reload:!0},"",l):window.parent.location=l:c.crm.content.load(l)},onError:function(){b.$button.attr("disabled",!1);e.hide()}})):alert(b.messages.choose_master)})};return a}(jQuery);var crmContactMerger=function(c){var a=function(b){this.master_id=b.master_id||0;this.slave_ids=b.slave_ids||[];this.url=c.crm.app_url+"?module=contact&action=mergeRun";this.processId=this.timer=null;this.onDone=b.onDone||function(){};this.onError=b.onError||function(){throw Error("Error processing request.");}};a.prototype.process=function(){var b=this,d=b.url,e=0,f={};f.master_id=b.master_id;f.slave_ids=b.slave_ids;var g=function(){b.timer&&clearTimeout(b.timer);b.timer=setTimeout(g,3200);!b.processId||
2<=e||(f.processId=b.processId,c.post(d,f,null,"json").done(function(l){e--;b.processId&&l.ready&&b.processId&&(b.timer&&clearTimeout(b.timer),b.timer=null,b.processId=null,b.onDone(l))}).fail(b.onError),e++)};c.post(d,f,null,"json").done(function(l){if(!l.processId)b.onError();b.processId=l.processId;g()}).fail(b.onError);return this};a.prototype.cancel=function(){this.timer&&clearTimeout(this.timer);c.post(this.url,{processId:this.processId,ready:1});return this};a.merge=function(b){return(new a(b)).process()};
return a}(jQuery);var CRMReportPage=function(c){CRMReportPage=function(a){this.$wrapper=a.$wrapper;this.funnel_id=a.funnel_id;this.funnel_color=a.funnel_color;this.group_by=a.group_by;this.locales=a.locales;this.chartsData=a.chartsData;this.stages_data=a.stages_data;this.initClass()};CRMReportPage.prototype.initClass=function(){this.initSVG();"undefined"!==typeof d3&&(this.chartsData&&this.initChart(),this.stages_data&&this.initStageCharts(this.stages_data));this.initDateFilter();this.initTagsFilter()};CRMReportPage.prototype.initTagsFilter=
function(){var a=this.$wrapper.find(".js-tags-filter"),b=a.find(".js-show-all"),d=a.find(".js-popular-tags-part"),e=a.find(".js-hidden-tags-part");b.on("click",function(f){f.preventDefault();f.stopPropagation();d.remove();b.remove();e.slideDown(300)})};CRMReportPage.prototype.initDateFilter=function(){var a=this.$wrapper.find(".js-dates-filter"),b=a.find("form"),d=a.find(".js-list");a.find(".js-timeframe-field");var e=a.find(".js-link-text"),f=a.find(".js-hidden-part"),g=!1,l=d.find(".selected");
d.on("click",".js-toggle",function(k){k.preventDefault();k=c(this);var h=k.data("timeframe");e.html(k.find("a").html());l.length&&l.removeClass("selected");l=k.addClass("selected");"custom"!==h?f.removeClass("is-shown"):f.addClass("is-shown")});b.on("submit",function(k){k.preventDefault();g||(g=!0,k=b.serialize(),c.crm.content.load(c.crm.app_url+"report/?"+k))});(function(){a.find(".js-datepicker").each(function(){var k=c(this),h=a.find("."+k.data("selector"));k.datepicker({altField:h,altFormat:"yy-mm-dd",
changeMonth:!0,changeYear:!0})})})()};CRMReportPage.prototype.initSVG=function(){if("object"!==typeof d3)return!1;var a=function(b,d){function e(g){var l=g.$wrapper;g=g.start/100;var k={};k.width=l.outerWidth();k.height=l.outerHeight();k.inner_width=parseInt(k.width*g);k.inner_height=k.height;k.top=k.height-k.inner_height;k.left=parseInt((k.width-k.inner_width)/2);return k}function f(g){var l=[],k=parseInt((g.start-g.end)/200*g.area.width);l.push("0,0");l.push(g.area.inner_width+",0");l.push(g.area.inner_width-
k+","+g.area.height);l.push(k+","+g.area.height);return l.join(" ")}a=function(g){this.$wrapper=g.$wrapper;this.svg=d.select(this.$wrapper[0]).append("svg");this.start=parseInt(this.$wrapper.data("start"));this.end=parseInt(this.$wrapper.data("end"));this.color=this.$wrapper.data("color");this.polygon=!1;this.area=e(this);this.initClass()};a.prototype.initClass=function(){function g(){b.contains(document,l.$wrapper[0])?l.refresh():b(window).off("resize",g)}var l=this;l.svg.attr("width",l.area.width).attr("height",
l.area.height);l.renderRectangle();l.$wrapper.data("svg",l);b(window).on("resize",g)};a.prototype.renderRectangle=function(){var g=this.svg.append("g"),l=f(this);this.polygon=g.append("polygon").attr("points",l).attr("transform","translate("+this.area.left+","+this.area.top+")").style("fill",this.color)};a.prototype.refresh=function(){this.area=e(this);this.svg.attr("width",this.area.width).attr("height",this.area.height);this.polygon.attr("points",f(this)).attr("transform","translate("+this.area.left+
","+this.area.top+")")};return a}(jQuery,d3);this.$wrapper.find(".js-svg-bar").each(function(){var b=c(this);new a({$wrapper:b})})};CRMReportPage.prototype.initChart=function(){function a(f,g){function l(k,h,n){var m=k.date.split("-");k=parseInt(m[0]);var p=parseInt(m[1]);m=parseInt(m[2]);k=[k,p,m];"years"===n?(n=k.slice(),n[0]+=h?1:-1):"months"===n?(n=k.slice(),n[1]+=h?1:-1):(n=k.slice(),n[2]+=h?1:-1);n[1]=(10>n[1]?"0":"")+n[1];n[2]=(10>n[2]?"0":"")+n[2];return{date:n.join("-"),value:0}}c.each(f,
function(k){k=f[k];if(1===k.data.length){var h=k.data[0],n=l(h,!1,g),m=l(h,!0,g);console.log(h);console.log(n);console.log(m);h=[n].concat(k.data);h.push(m);k.data=h;console.log(k.data)}});return f}var b=this.$wrapper.find(".js-graph-section");if(!b.length)return!1;var d=function(f){function g(h){function n(w){var x=w.split("-");w=parseInt(x[0]);var y=parseInt(x[1])-1;x=parseInt(x[2]);return new Date(w,y,x)}for(var m=[],p=0;p<h.length;p++){for(var q=h[p].data,r=[],u=0;u<q.length;u++){var v=q[u],t=
parseInt(v.value);r.push({date:n(v.date),value:t})}m.push(r)}return d3.layout.stack().offset("zero").values(function(w){return w}).x(function(w){return w.date}).y(function(w){return w.value})(m)}function l(h,n){n=(n[1]||1)-n[0]+1;for(var m=n/(h-1),p=[],q=0;q<h;q++){var r=10<n?Math.round(q*m):parseInt(q*m*10)/10;p.push(r)}return p}function k(h,n){var m=f(window),p=m.width();m.height();m=n.$hint.outerWidth();var q=n.$hint.outerHeight(),r=n.$wrapper.offset();n=h.pageX;h={left:n-r.left+10,top:h.pageY-
r.top+(0<q?0-q-2:2)};p<h.left+m&&(h.left=n-(m+10));return h}d=function(h){this.$wrapper=h.$wrapper;this.$hint=this.$wrapper.find(".c-hint-wrapper");this.node=this.$wrapper.find(".js-graph")[0];this.d3node=d3.select(this.node);this.show_class="is-shown";this.charts=h.data;this.data=g(this.charts);this.color=h.color;this.group_by=h.group_by;this.locales=h.locales;this.margin={top:14,right:10,bottom:20,left:34};var n=this.node;h=this.margin;var m=n.offsetWidth;n=n.offsetHeight;this.area={outer_width:m,
outer_height:n,inner_width:m-h.left-h.right,inner_height:n-h.top-h.bottom};this.column_indent=4;h=this.area.inner_width;m=this.data[0].length;n=null;m+=1;h&&m&&(n=(h-this.column_indent*(m-1))/m,0>n&&(n=0));this.column_width=n;this.axisIndent=2;this.yDomain=this.xDomain=this.svgArea=this.svgLine=this.y=this.x=this.defs=this.svg=!1;this.initGraph()};d.prototype.initGraph=function(){var h=this,n=h.area;h.initGraphCore();h.svg=h.d3node.append("svg").attr("width",n.outer_width).attr("height",n.outer_height);
h.renderBackground();f.each(h.data,function(m,p){m=h.data.length-1-m;h.renderChart(h.data[m],h.charts[m])});h.renderAxis()};d.prototype.initGraphCore=function(){var h=this,n=h.data,m=h.area,p=h.x=d3.time.scale().range([0,m.inner_width]),q=h.y=d3.scale.linear().range([m.inner_height,0]);h.yDomain=function(){var r=d3.min(n,function(v){return d3.min(v,function(t){return t.value})});0<r&&(r=0);var u=d3.max(n,function(v){return d3.max(v,function(t){return t.value+t.y0})});return[r,u]}();h.xDomain=function(){var r=
n[0][0].date;var u=n[0][n[0].length-1].date;var v=.05*(u.getTime()-r.getTime());r=new Date(r.getTime()-v);u=new Date(u.getTime()+v);return[r,u]}();p.domain(h.xDomain);q.domain(h.yDomain);h.svgArea=d3.svg.area().interpolate("monotone").x(function(r){return p(r.date)}).y(function(r){return q(r.value+r.y0)-h.axisIndent}).y0(function(r){return q(0)});h.svgLine=d3.svg.line().interpolate("monotone").x(function(r){return p(r.date)}).y(function(r){return q(r.value+r.y0)-h.axisIndent})};d.prototype.renderAxis=
function(){var h=this.x,n=this.y,m=this.svg;h=d3.svg.axis().scale(h).orient("bottom").ticks(10);n=d3.svg.axis().scale(n).innerTickSize(2).orient("right").tickValues(l(6,this.yDomain)).tickFormat(function(p){return p+""});m=m.append("g").attr("class","axis");m.append("g").attr("transform","translate(10,"+this.margin.top+")").attr("class","y").call(n);m.append("g").attr("class","x").attr("transform","translate("+this.margin.left+","+(this.area.outer_height-this.margin.bottom)+")").call(h)};d.prototype.renderBackground=
function(){var h=this.area.inner_width,n=this.area.inner_height,m,p=this.svg.append("g").attr("class","background").attr("transform","translate("+this.margin.left+","+this.margin.top+")");p.append("rect").attr("width",h).attr("height",n);for(m=0;5>=m;m++){var q=1+(n-2)/5*m;p.append("line").attr("x1",1).attr("x2",h).attr("y1",q).attr("y2",q)}};d.prototype.renderChart=function(h,n){var m=this,p=n.color;m.svg.append("g").attr("class","c-graph-wrapper").attr("transform","translate("+m.margin.left+","+
m.margin.top+")").datum(h).append("path").style("stroke",function(){return 1<m.charts.length?"":m.color}).style("fill",function(){return p?p:m.color}).attr("class","area").attr("d",m.svgArea(h)).on("mouseover",function(q){m.showHint(d3.event,this,n)}).on("mousemove",function(){m.moveHint(this)}).on("mouseout",function(){m.hideHint()})};d.prototype.update=function(h){this.data=g(this.charts,h);this.initGraphCore();h=d3.svg.axis().scale(this.y).innerTickSize(2).orient("right").tickValues(l(6,this.yDomain)).tickFormat(function(n){return n+
""});this.svg.selectAll(".axis .y").call(h);this.renderCharts()};d.prototype.showHint=function(h,n,m){n=this.$hint.find(".js-name");this.$hint.find(".js-date");this.$hint.find(".js-value");m.name&&(n.text(m.name),h=k(h,this),this.$hint.css(h).addClass(this.show_class))};d.prototype.moveHint=function(){if(this.$hint.hasClass(this.show_class)){var h=k(event,this);this.$hint.css(h)}};d.prototype.hideHint=function(){this.$hint.removeAttr("style").removeClass(this.show_class)};return d}(jQuery),e=function(f){function g(k){function h(t){var w=
t.split("-");t=parseInt(w[0]);var x=parseInt(w[1])-1;w=parseInt(w[2]);return new Date(t,x,w)}for(var n=[],m=0;m<k.length;m++){for(var p=k[m].data,q=[],r=0;r<p.length;r++){var u=p[r],v=parseInt(u.value);q.push({date:h(u.date),value:v})}n.push(q)}return d3.layout.stack().offset("zero").values(function(t){return t}).x(function(t){return t.date}).y(function(t){return t.value})(n)}function l(k,h){var n=h[0];h=h[1]||1;n=0<h-n?h-n:1;h=n/(k-1);for(var m=[],p=0;p<k;p++){var q=10<n?Math.round(p*h):parseInt(p*
h*10)/10;q=0<parseInt(q)?parseInt(q):1;m.push(q)}return m}e=function(k){this.$wrapper=k.$wrapper;this.$hint=this.$wrapper.find(".c-hint-wrapper");this.node=this.$wrapper.find(".js-graph")[0];this.d3node=d3.select(this.node);this.show_class="is-shown";this.charts=k.data;this.data=g(this.charts);this.color=k.color;this.group_by=k.group_by;this.locales=k.locales;this.margin={top:8,right:10,bottom:4,left:34};var h=this.node;k=this.margin;var n=h.offsetWidth;h=h.offsetHeight;this.area={outer_width:n,outer_height:h,
inner_width:n-k.left-k.right,inner_height:h-k.top-k.bottom};this.column_indent=200<this.data[0].length?2:4;k=this.area.inner_width;n=this.data[0].length;h=null;n+=1;k&&n&&(h=(k-this.column_indent*(n-1))/n,1>h?h=1:20<h&&(h=20));this.column_width=h;this.yDomain=this.xDomain=this.y=this.x=this.defs=this.svg=!1;this.initGraph()};e.prototype.initGraph=function(){var k=this.area;this.initGraphCore();200<this.data[0].length?this.$wrapper.addClass("is-large"):this.$wrapper.removeClass("is-large");this.svg=
this.d3node.append("svg").attr("width",k.outer_width).attr("height",k.outer_height);this.renderBackground();this.renderCharts();this.renderAxis()};e.prototype.initGraphCore=function(){var k=this.data,h=this.area,n=this.x=d3.time.scale().range([0,h.inner_width]);h=this.y=d3.scale.linear().range([0,h.inner_height]);this.yDomain=function(){var m=d3.min(k,function(q){return d3.min(q,function(r){return r.value})});0<m&&(m=0);var p=d3.max(k,function(q){return d3.max(q,function(r){return r.value+r.y0})});
return[m,p]}();this.xDomain=function(){var m=k[0][0].date;var p=k[0][k[0].length-1].date;var q=.05*(p.getTime()-m.getTime());m=new Date(m.getTime()-q);p=new Date(p.getTime()+q);return[m,p]}();n.domain(this.xDomain);h.domain(this.yDomain)};e.prototype.renderAxis=function(){var k=this.x,h=this.y,n=this.svg;d3.svg.axis().scale(k).orient("bottom").ticks(10);k=d3.svg.axis().scale(h).innerTickSize(2).orient("right").tickValues(l(6,this.yDomain)).tickFormat(function(m){return m+""});n.append("g").attr("class",
"axis").append("g").attr("transform","translate(10,"+this.margin.top+")").attr("class","y").call(k)};e.prototype.renderBackground=function(){var k=this.area.inner_width,h=this.area.inner_height,n,m=this.svg.append("g").attr("class","background").attr("transform","translate("+this.margin.left+","+this.margin.top+")");m.append("rect").attr("width",k).attr("height",h);for(n=0;5>=n;n++){var p=1+(h-2)/5*n;m.append("line").attr("x1",1).attr("x2",k).attr("y1",p).attr("y2",p)}};e.prototype.renderCharts=function(){var k=
this,h=k.data;h=k.svg.selectAll(".c-graph-wrapper").data(h);h.enter().append("g").attr("class","c-graph-wrapper").attr("transform","translate("+k.margin.left+","+k.margin.top+")");var n=h.selectAll(".rect").data(function(q){return q}),m=!1;if(k.color){var p=f.crm.color(k.color).rgb;p.push(.5);m="rgba("+p.join(",")+")"}n.enter().append("rect").attr("class","rect").on("mouseover",function(q,r,u){k.showHint(d3.event,this,q,k.charts[u])}).on("mousemove",function(){k.moveHint(this)}).on("mouseout",function(){k.hideHint()});
n.transition().duration(1E3).attr("x",function(q,r){return k.x(q.date)-k.column_width/2}).attr("y",function(q){return k.y(q.y0)}).attr("height",function(q){return k.y(q.value)}).style("stroke",function(q,r,u){return k.charts[u].color?"":k.color}).style("fill",function(q,r,u){q=k.charts[u];return q.color?q.color:m}).attr("width",k.column_width);n.exit().remove();h.exit().remove()};e.prototype.update=function(k){this.data=g(this.charts,k);this.column_indent=200<this.data[0].length?2:4;200<this.data[0].length?
this.$wrapper.addClass("is-large"):this.$wrapper.removeClass("is-large");this.initGraphCore();k=d3.svg.axis().scale(this.y).innerTickSize(2).orient("right").tickValues(l(6,this.yDomain)).tickFormat(function(h){return h+""});this.svg.selectAll(".axis .y").call(k);this.renderCharts()};e.prototype.showHint=function(k,h,n,m){var p=this;k=f(h);if(!(0<Math.ceil(k.attr("height"))))return!1;var q=n.date;h=p.$hint.find(".js-name");var r=p.$hint.find(".js-date"),u=p.$hint.find(".js-value");q=function(v,t){var w=
parseInt(v.getMonth());"months"==t?(v=p.locales.months,v[w]||(v="\u042f\u043d\u0432\u0430\u0440\u044c \u0424\u0435\u0432\u0440\u0430\u043b\u044c \u041c\u0430\u0440\u0442 \u0410\u043f\u0440\u0435\u043b\u044c \u041c\u0430\u0439 \u0418\u044e\u043d\u044c \u0418\u044e\u043b\u044c \u0410\u0432\u0433\u0443\u0441\u0442 \u0421\u0435\u043d\u0442\u044f\u0431\u0440\u044c \u041e\u043a\u0442\u044f\u0431\u0440\u044c \u041d\u043e\u044f\u0431\u0440\u044c \u0414\u0435\u043a\u0430\u0431\u0440\u044c".split(" ")),w=v[w]):
(t=v.getDate(),w+=1,w=(10>t?"0"+t:t)+"."+(10>w?"0"+w:w)+"."+v.getFullYear());return w}(q,p.group_by);m.name?h.text(m.name+": ").show():h.hide();r.text(q);u.text(n.value);n=function(v){var t=f(window),w=t.width();t.height();t=p.$hint.outerWidth();var x=p.$hint.outerHeight(),y=Math.ceil(v.attr("width")),z=Math.ceil(v.attr("height")),B=p.$wrapper.offset();v=v.offset();x={left:v.left-B.left+y+10,top:v.top-B.top+(z<x?z-x-2:2)};w<x.left+t&&(x.left=v.left-(t+10));return x}(k);p.$hint.css(n).addClass(p.show_class)};
e.prototype.moveHint=function(){};e.prototype.hideHint=function(){this.$hint.removeAttr("style").removeClass(this.show_class)};return e}(jQuery);new d({$wrapper:b.find(".js-sum-graph"),data:a(this.chartsData.sum,this.group_by),color:this.funnel_color,group_by:this.group_by,locales:this.locales});new e({$wrapper:b.find(".js-amount-graph"),data:a(this.chartsData.qty,this.group_by),color:this.funnel_color,group_by:this.group_by,locales:this.locales})};CRMReportPage.prototype.initStageCharts=function(a){var b=
this.$wrapper.find(".js-stage-graph-section"),d=a.stages;if(!b.length||!d.length)return!1;var e=[0,2*d.length],f=function(l){f=function(k){this.$wrapper=k.$wrapper;this.$hint=this.$wrapper.find(".c-hint-wrapper");this.node=this.$wrapper.find(".js-graph")[0];this.d3node=d3.select(this.node);this.show_class="is-shown";console.log(k.data);for(var h=k.data,n=0;n<h.length;n++){var m=h[n];1!==n||m.color||(m.color="#e07d6e")}h=this.charts=h;n=[];for(m=0;m<h.length;m++){for(var p=h[m].data,q=[],r=0;r<p.length;r++){var u=
parseInt(p[r].value);q.push({index:1+2*r,value:u})}n.push(q)}this.data=n;this.color=k.color;this.group_by=k.group_by;this.locales=k.locales;this.margin={top:20,right:0,bottom:0,left:0};n=this.node;k=this.margin;h=n.offsetWidth;n=n.offsetHeight;this.area={outer_width:h,outer_height:n,inner_width:h-k.left-k.right,inner_height:n-k.top-k.bottom};this.column_indent=8;k=this.area.inner_width;h=this.data[0].length;n=null;k&&h&&(n=(k-this.column_indent*(h-1))/h,1>n&&(n=1));this.column_width=n;this.yDomain=
this.xDomain=this.y=this.x=this.defs=this.svg=!1;this.initGraph()};f.prototype.initGraph=function(){var k=this.area;this.initGraphCore();this.svg=this.d3node.append("svg").attr("width",k.outer_width).attr("height",k.outer_height);this.renderCharts()};f.prototype.initGraphCore=function(){var k=this.data,h=this.area,n=this.x=d3.scale.linear().range([0,h.inner_width]);h=this.y=d3.scale.linear().range([0,h.inner_height]);this.yDomain=function(){var m=d3.min(k,function(q){return d3.min(q,function(r){return r.value})});
0<m&&(m=0);var p=d3.max(k,function(q){return d3.max(q,function(r){return r.value})});return[m,p]}();this.xDomain=e;n.domain(this.xDomain);h.domain(this.yDomain)};f.prototype.renderCharts=function(){var k=this,h=k.data;h=k.svg.selectAll(".c-graph-wrapper").data(h);h.enter().append("g").attr("class","c-graph-wrapper").attr("transform","translate("+k.margin.left+","+k.margin.top+")");var n=h.selectAll(".rect").data(function(q){return q});n.enter().append("rect").attr("class","rect");n.transition().duration(1E3).attr("x",
function(q,r){return k.x(q.index)-k.column_width/2}).attr("y",function(q){return k.area.inner_height-k.y(q.value)}).attr("height",function(q){return k.y(q.value)}).style("stroke",function(q,r,u){return k.charts[u].color?"":k.color}).style("fill",function(q,r,u){q=k.charts[u];return q.color?q.color:k.color}).attr("width",k.column_width);var m=h.selectAll(".base-text").data(function(q){return q});m.enter().append("text").attr("class","base-text");m.transition().duration(1E3).attr("text-anchor","middle").attr("x",
function(q){return k.x(q.index)}).attr("y",function(q){return k.area.inner_height-10}).text(function(q,r,u){q="";if(r=k.charts[u].data[r])q=r.base_text;return q});var p=h.selectAll(".over-text").data(function(q){return q});p.enter().append("text").attr("class","base-text");p.transition().duration(1E3).attr("text-anchor","middle").attr("x",function(q){return k.x(q.index)}).attr("y",function(q){return k.area.inner_height-k.y(q.value)-6}).style("fill",function(q,r,u){return 1===u?"#cc270e":""}).text(function(q,
r,u){q="";if(r=k.charts[u].data[r])q=r.over_text;return q});m.exit().remove();p.exit().remove();n.exit().remove();h.exit().remove()};return f}(jQuery),g=function(l){function k(h){for(var n=[],m=0;m<h.length;m++){for(var p=h[m].data,q=[],r=0;r<p.length;r++){var u=parseInt(p[r].value);q.push({index:1+2*r,value:u})}n.push(q)}return d3.layout.stack().offset("zero").values(function(v){return v}).x(function(v){return v.index}).y(function(v){return v.value})(n)}g=function(h){this.$wrapper=h.$wrapper;this.$hint=
this.$wrapper.find(".c-hint-wrapper");this.node=this.$wrapper.find(".js-graph")[0];this.d3node=d3.select(this.node);this.show_class="is-shown";this.charts=h.data;this.data=k(this.charts);this.color=h.color;this.group_by=h.group_by;this.locales=h.locales;this.margin={top:0,right:0,bottom:20,left:0};var n=this.node;h=this.margin;var m=n.offsetWidth;n=n.offsetHeight;this.area={outer_width:m,outer_height:n,inner_width:m-h.left-h.right,inner_height:n-h.top-h.bottom};this.column_indent=8;h=this.area.inner_width;
m=this.data[0].length;n=null;h&&m&&(n=(h-this.column_indent*(m-1))/m,1>n&&(n=1));this.column_width=n;this.yDomain=this.xDomain=this.y=this.x=this.defs=this.svg=!1;this.initGraph()};g.prototype.initGraph=function(){var h=this.area;this.initGraphCore();this.svg=this.d3node.append("svg").attr("width",h.outer_width).attr("height",h.outer_height);this.renderCharts()};g.prototype.initGraphCore=function(){var h=this.data,n=this.area,m=this.x=d3.scale.linear().range([0,n.inner_width]);n=this.y=d3.scale.linear().range([0,
n.inner_height]);this.yDomain=function(){var p=d3.min(h,function(r){return d3.min(r,function(u){return u.value})});0<p&&(p=0);var q=d3.max(h,function(r){return d3.max(r,function(u){return u.value+u.y0})});return[p,q]}();this.xDomain=e;m.domain(this.xDomain);n.domain(this.yDomain)};g.prototype.renderCharts=function(){var h=this,n=h.data;n=h.svg.selectAll(".c-graph-wrapper").data(n);n.enter().append("g").attr("class","c-graph-wrapper").attr("transform","translate("+h.margin.left+","+h.margin.top+")");
var m=n.selectAll(".rect").data(function(r){return r});m.enter().append("rect").attr("class","rect");m.transition().duration(1E3).attr("x",function(r,u){return h.x(r.index)-h.column_width/2}).attr("y",function(r){return h.y(r.y0)}).attr("height",function(r){return h.y(r.value)}).style("stroke",function(r,u,v){return h.charts[v].color?"":h.color}).style("fill",function(r,u,v){r=h.charts[v];return r.color?r.color:h.color}).attr("width",h.column_width);var p=n.selectAll(".base-text").data(function(r){return r});
p.enter().append("text").attr("class","base-text").text(function(r,u,v){r="";if(u=h.charts[v].data[u])r=u.base_text;return r}).append("tspan").style("fill","#cc270e").text(function(r,u,v){r="";(u=h.charts[v].data[u])&&u.sub_text&&(r=" ("+u.sub_text+")");return r});p.transition().duration(1E3).attr("text-anchor","middle").attr("x",function(r){return h.x(r.index)}).attr("y",16);var q=n.selectAll(".over-text").data(function(r){return r});q.enter().append("text").attr("class","over-text");q.transition().duration(1E3).attr("text-anchor",
"middle").attr("x",function(r){return h.x(r.index)}).attr("y",function(r){r=h.y(r.y0)+h.y(r.value)+16;34>r&&(r=34);return r}).text(function(r,u,v){r="";if(u=h.charts[v].data[u])r=u.over_text;return r});p.exit().remove();q.exit().remove();m.exit().remove();n.exit().remove()};return g}(jQuery);d=b.find(".js-graph-wrapper-1");d.length&&new f({$wrapper:d,data:a.charts[0],color:"#d0d0d0",group_by:this.group_by,locales:this.locales});b=b.find(".js-graph-wrapper-2");b.length&&new g({$wrapper:b,data:[a.charts[1]],
color:"#b0b0b0",group_by:this.group_by,locales:this.locales})};return CRMReportPage}(jQuery);(function(c){c.crm=c.crm||{};c.crm.search={state:null,url:c.crm.app_url+"?module=contactSearch",serialize:function(a,b,d,e){var f={},g=a.serializeArray();a=0;for(var l=g.length;a<l;a+=1){var k=(g[a].value||"").trim();try{k=JSON.parse(k)}catch(t){}var h=g[a].name;if(!(!h||!k||c.isPlainObject(k)&&c.isEmptyObject(k)||b&&0!==h.indexOf(b)||void 0!==d&&-1===h.indexOf("["+d+"]"))){var n=""+(c.isPlainObject(k)?k.val:k);if(n=c.trim(n)){k=c.isPlainObject(k)?k.op||"=":"=";n=n.replace(/\//g,"\\/").replace(/&/,
"\\&");h=h.split(".");for(var m=f,p=0,q=h.length-1;p<q;p+=1){var r=(h[p]||"").trim();if("undefined"===typeof m[r]||"object"!==typeof m[r])m[r]={};m=m[r]}r=h[h.length-1];c.isArray(m[r])?m[r].push({val:n,op:k}):c.isPlainObject(m[r])||(m[r]=[{val:n,op:k}])}}}var u=function(t,w,x){if(c.isPlainObject(t))for(var y in t)t.hasOwnProperty(y)&&u(t[y],w,x?x+"."+y:y);else"undefined"!==typeof t&&(w[x]=t)};b={};u(f,b,"");f=[];for(var v in b)if(b.hasOwnProperty(v))if(c.isArray(b[v])&&1<b[v].length)for(a=0,l=b[v].length;a<
l;a+=1)n=b[v][a].val,e||(n=this.encodeURIComponent(b[v][a].val)),f.push(v+"["+a+"]"+b[v][a].op+n);else n=b[v][0].val,e||(n=this.encodeURIComponent(b[v][0].val)),f.push(v+b[v][0].op+n);return f.join("&")},encodeURIComponent:function(a){a=encodeURIComponent(a);return a=a.replace(/%2F/g,"%252F").replace(/%5C/g,"%255C")},indexBlocks:function(a){var b={},d=c('#c-search-block .js-field[data-multiple="1"]');a&&(d=d.filter('[data-id="'+a+'"]'));d.each(function(){var e=c(this),f=e.data("id"),g=void 0!==b[f]?
++b[f]:b[f]=0;e.attr("data-index",g);e.data("index",g);e.find(":input").each(function(){var l=c(this),k=l.attr("name").replace(/\[\d+\]/,"").replace(f,f+"["+g+"]");l.attr("name",k)})})}}})(jQuery);(function(c){c.widget("custom.combobox",{_create:function(){this.element.data("custom.combobox.inited")||(this.wrapper=c("<div style='position:relative;'>").addClass("custom-combobox").insertAfter(this.element),this.element.hide(),this._createAutocomplete(),this._createShowAllButton(),this.element.data("custom.combobox.inited",1))},_createAutocomplete:function(){this.ns=this.element.attr("name")||"element-"+(""+Math.random()).slice(2);_other_version_=!0;if(this.element.is("select")){var a=this.element.children(":selected"),
b=a.val()?a.text():"";this.h=24;var d=this;this.input=c("<input type='search'>").appendTo(this.wrapper).val(b).attr("title","").addClass("custom-combobox-input ui-widget");this.element.data("autocomplete")||this.element.data("readonly")?(this.input.autocomplete({delay:200,minLength:0,html:!0,source:c.proxy(this,"_source"),item_clz:"crm-search-ui-autocomplete-item",width:270}),this.ul=c(this.input).autocomplete("widget")):this.ul=c();this.offset=this.limit=this.element.data("limit");this.count=this.element.data("count");
this.wrapper.width(this.input.width()+30);this.ul.css({overflowY:"auto",overflowX:"hidden",maxHeight:10*this.h});this.element.attr("disabled")&&this.input.attr("disabled",!0);this.options.css&&this.input.css(this.options.css);this.element.find("option.cond").remove();this.element.data("readonly")&&this.input.attr("readonly",!0).addClass("readonly").css({cursor:"pointer"}).click(function(){c(this).autocomplete("widget").is(":visible")?c(this).autocomplete("close"):d._showSelectItems();return!1});this.hidden=
c("<input type='hidden'>").appendTo(this.wrapper);this.label=!1!==this.options.label?c('<span class="c-label"></span>').css({top:"3px",left:"-20px",position:"absolute"}).prependTo(this.wrapper):c();this.element.attr("name","");this.element.data("readonly")&&this.label.hide();this.element.attr("disabled")&&this.input.attr("disabled",!0);"*="===a.data("op")&&this.label.text("\u2248");if(a.val()&&!a.hasClass("value"))a.data("period")?(this.element.data("value",""),a=a.val().split("--"),this._updatePeriodInput((a[0]||
"").trim(),(a[1]||"").trim())):(this.element.data("value",""),"value"===this.element.data("pass")?this.hidden.attr("name",this.ns).val(a.val()):this.hidden.attr("name",this.ns+"."+a.val()).val("1"),this.input.val(a.text()),this.label.text("=")),this._removeIcon();else if(a.hasClass("value")||a.text()){this.element.val("");b=a.hasClass("value")?a.val()||a.text():a.text();var e=a.hasClass("value")?a.text():b;"*="===a.data("op")?this.element.data("readonly")?this.hidden.attr("name",this.ns).val(b):this.hidden.attr("name",
this.ns).val(JSON.stringify({op:"*=",val:b})):this.hidden.attr("name",this.ns).val(b);this.input.val(e);a.data("icon")&&this._addIcon(a.data("icon"))}else this.hidden.attr("name",this.ns);this.input.bind("autocompleteselect",function(g,l){l.item.option&&(l.item.option.selected=!0,c(this).trigger("select",g,{item:l.item.option}));if(l.item.option&&!c(l.item.option).hasClass("value"))if(c(l.item.option).data("period")){var k=d._showPeriodDialog();k.bind("select",function(n,m,p){d._updatePeriodInput(m,
p);d._removeIcon()});k.bind("cancel",function(){d.input.val("");d.hidden.attr("name",d.ns).val("");d.label.text("")})}else(k=c(l.item.option).val())?"value"===d.element.data("pass")?d.hidden.attr("name",d.ns).val(k):d.hidden.attr("name",d.ns+"."+k).val("1"):d.hidden.attr("name",d.ns).val(""),d.input.val(c(l.item.option).text()),d.label.text("="),d._removeIcon();else{k=l.item.value;var h=l.item.text||l.item.name;l.item.option&&(k=c(l.item.option).val());d.hidden.attr("name",d.ns).val(k);d.input.val(h);
d.label.text("=");l.item.icon?d._addIcon(l.item.icon):d._removeIcon()}d.element.trigger("change");d.element.data("readonly")&&setTimeout(function(){d.input.blur()});"function"===typeof d.options.select&&d.options.select.apply(this,[g,l]);return!1}).bind("autocompletechange",function(g,l){d._removeIfInvalid.call(d,g,l)});var f="";this.element.data("readonly")||(this.input.bind("keydown",function(){f=c(this).val()}),this.input.bind("keyup",function(){var g=c(this).val();f!==g&&(d._removeIcon(),g?(d.label.text("\u2248"),
d.hidden.attr("name",d.ns).val(JSON.stringify({val:g,op:"*="}))):(d.label.text(""),d.hidden.attr("name",d.ns).val("")));"function"===typeof d.options.keyup&&d.options.keyup.apply(this,[g,f]);f=g}));this.input.bind("keyup",function(g){13==g.keyCode&&!c(this).data("hold")&&c(this).val().trim()&&c(this).trigger("enter")});this.input.bind("search",function(){c(this).val()||(d._removeIcon(),d.hidden.attr("name",d.ns).val(""),d.label.text(""),d.ul.is(":visible")&&c(this).autocomplete("search",""),"function"===
typeof d.options.clear&&d.options.clear.apply(this))});this.input.bind("autocompleteopen",function(g,l){var k=d.input.width();d.ul.find("li.ui-menu-item").each(function(){var h=c(this),n=h.find(".count"),m=h.find(".crm-text");n.insertBefore(m);m.width(Math.max(k-n.outerWidth(!0)-30,0)).data("sep")&&h.css({borderTop:"0px solid #ccc"})});d.ul.width(k)});_other_version_||(this.input.bind("autocompleteopen",function(g,l){d.ul.width(d.input.outerWidth(!0)-5);void 0!==d.offset&&void 0!==d.count&&(d.offset<
d.count?(d.height=d.ul.height(),d.ul.unbind("scroll."+d.ns).bind("scroll."+d.ns,function(){var n=c(this).find(".dummy-end");n.length?c(this).scrollTop()+d.height>=n.position().top&&d.input.trigger("autocompleteload"):d.ul.unbind("scroll."+d.ns)}),g=d.ul.find(".ui-menu-item:first").height(),c('<li class="dummy-end ignore-hover" role="menuitem"><a class="ui-corner-all" style="padding: .2em .4em; line-height: 1.5; display: block;"></a></li>').height(g).appendTo(d.ul),d.ul.css({overflowY:"scroll",overflowX:"hidden",
height:d.height})):(d.ul.unbind("scroll."+d.ns),d.ul.css({overflowY:"",overflowX:""})));d.ul.find(".sep").closest("li").addClass("ignore-hover");var k=d.ul.width(),h="scroll"===d.ul.css("overflowY");d.ul.find("li.ui-menu-item").each(function(){var n=c(this);n.find(".sep").length?n.find(".sep").width(h?k-25:k-10):n.find(".crm-text").width(Math.max(k-n.find(".count").outerWidth(!0)-30,0))})}),this.input.bind("autocompleteload",function(g){!d.loading&&d.offset<d.count&&(d.loading=!0,d.input.addClass("ui-autocomplete-loading"),
c.get(d.options.url,{id:d.ns,offset:d.offset,limit:d.limit,term:d.input.val()},function(l){if("ok"===l.status){var k=l.data.values,h=[];d.ul.find(".ui-menu-item").each(function(){h.push(c(this).data("item.autocomplete"))});for(var n=0;n<k.length;n+=1)h.push(d._formItem(k[n]));d.count=l.data.count;d.response(h);d.offset+=k.length;d.offset>=d.count&&d.ul.find(".dummy-end").remove()}d.loading=!1;d.input.removeClass("ui-autocomplete-loading")},"json"))}));this.input.bind("autocompletefocus",function(g,
l){c(this).val(l.item.name);c(this).data("hold",1);return!1});this.input.bind("autocompleteclose",function(g,l){if(13===g.keyCode){var k=c(this);setTimeout(function(){k.data("hold",0)},200)}else c(this).data("hold",0)});this.input.focus(function(){d.arrow.show()}).blur(function(){d.wrapper.data("mouserover")||d.arrow.hide()});this.wrapper.mouseover(function(){c(this).data("mouserover",1);d.arrow.show()}).mouseout(function(){c(this).data("mouserover",0);d.input.is(":focus")||d.arrow.hide()})}},_createShowAllButton:function(){var a=
this.input,b=this.hidden,d=this.ns,e=this.element,f=this;e.find("option").length?(this.arrow=c("<a href='javascript:void(0);' style='margin: -2px 0 0 -20px;'><i class='fas fa-caret-down'></i></a>").attr("tabIndex",-1).appendTo(this.wrapper).removeClass("ui-corner-all").addClass("custom-combobox-toggle ui-corner-right").mousedown(function(){a.focus();b.attr("name",d);f.ul.is(":hidden")?f._showSelectItems():a.autocomplete("search","");return!1}).hide(),e.data("readonly")&&this.wrapper.find("svg").css({backgroundColor:"white"}).parent().css({})):
this.arrow=c()},_addIcon:function(a){this.input.after('<img class="flag" style="position: absolute; top: 3px; right: 41px; padding: 2px; background: white;" src="'+a+'"/>')},_removeIcon:function(){this.input.nextAll(".flag").remove()},_formItem:function(a,b){var d=a.label;!b||a.value||a.name||(d='<span style="visibility: hidden">empty</span>');_other_version_||(d=c.wa.encodeHTML(a.name));d='<span class="crm-text" data-sep="'+(a.sep?1:0)+'">'+d;a.icon&&(d+=' <img src="'+a.icon+'" />');d+="</span>";
c.isNumeric(a.count)&&(d+='<span class="count" style="float: right;">'+a.count+"</span>");a.label=d;a.value||(a.value=a.name);return a},_showSelectItems:function(){var a=this,b=null,d=a.element.data("readonly"),e=!1;a.input.autocomplete("search","");b=this.response;b(this.element.children("option").map(function(){var f=c(this);if(f.hasClass("sep"))e=!0;else return f=a._formItem({icon:f.data("icon"),count:f.data("count"),label:f.html(),name:f.text(),value:this.value,sep:e,option:this},d),e=!1,f}).toArray())},
_source:function(a,b){var d=new RegExp(c.ui.autocomplete.escapeRegex(a.term),"i"),e=this;e.response=b;if(_other_version_&&!a.term)b([]);else{var f=function(l,k){_other_version_&&(l.highlight=1);c.get(e.options.url,l,function(h){var n=[],m=0;h&&"ok"===h.status&&(c.isArray(h.data.values)&&h.data.values.length&&(n=h.data.values),h.data.count&&(m=h.data.count));h=0;for(var p=n.length;h<p;h+=1)n[h]=e._formItem(c.extend(n[h],{option:null}));e.offset=n.length;e.count=m;b(n)},"json")};if(_other_version_)a.term?
f({term:a.term,id:this.ns}):b(this.element.children("option").map(function(){var l=c(this),k=l.html();if(l.hasClass("sep"))return c.extend({},sep,{option:this});if(this.value&&(!a.term||d.test(k))){var h=k;l.data("icon")&&(h+=' <img src="'+l.data("icon")+'" />');c.isNumeric(l.data("count"))&&(h+='<span class="count">'+l.data("count")+"</span>");return{label:h,text:k,value:this.value,option:this}}}).toArray());else if(a.term&&this.element.data("autocomplete"))f({term:a.term,id:this.ns},function(l){e.ul.height(e.h*
l.length);return l});else{var g=this.element.children("option").map(function(){var l=c(this),k=l.html();if(l.hasClass("sep"))return c.extend({},sep,{option:this});if(this.value&&(!a.term||d.test(k))){var h=k;l.data("icon")&&(h+=' <img src="'+l.data("icon")+'" />');c.isNumeric(l.data("count"))&&(h+='<span class="count">'+l.data("count")+"</span>");return{label:h,text:k,value:this.value,option:this}}}).toArray();this.element.data("autocomplete")?f({term:"",id:this.ns},function(l){l.length&&g[g.length-
1]&&!c(g[g.length-1].option).hasClass("sep")&&g.push(sep);g=g.concat(l);e.ul.height(e.h*g.length);return g}):b(g)}}},_removeIfInvalid:function(a,b){if(!b.item){a=this.input;var d=a.val().toLowerCase(),e=!1;this.element.children("option").each(function(){if(c(this).text().toLowerCase()===d)return this.selected=e=!0,!1});e||((b=a.data("uiAutocomplete"))||(b=a.date("autocomplete")),b&&(b.term=""))}},_updatePeriodInput:function(a,b){this.label.text("");this.hidden.attr("name",this.ns+".period").val("");
var d=c.datepicker.formatDate("dd.mm.yy",new Date(a)),e=c.datepicker.formatDate("dd.mm.yy",new Date(b));a&&b?(this.hidden.val([c.datepicker.formatDate("yy-mm-dd",new Date(a)),c.datepicker.formatDate("yy-mm-dd",new Date(b))].join("--")),this.input.val(d===e?d:d+"\u2013"+e),this.label.text("=")):a?(this.hidden.val(JSON.stringify({val:c.datepicker.formatDate("yy-mm-dd",new Date(a)),op:">="})),this.input.val(d),this.label.text(">=")):b&&(this.hidden.val(JSON.stringify({val:c.datepicker.formatDate("yy-mm-dd",
new Date(b)),op:"<="})),this.label.text("<="))},_renderItem:function(a,b){return c("<li class='crm-search-ui-menu-item'>").append(c("<div>").text(b.label)).appendTo(a)},_showPeriodDialog:function(){c("#c-combobox-dialog").remove();return c('<div id="c-combobox-dialog"></div>').appendTo("body").periodDialog()},_destroy:function(){this.wrapper.remove();this.element.show()}})})(jQuery);(function(c){c.fn.periodDialog=function(a,b){function d(k){var h=g().find(".datepicker.start");h=new Date(h.datepicker("getDate"));return c.datepicker.formatDate(k,h)}function e(k){var h=g().find(".datepicker.end");h=new Date(h.datepicker("getDate"));return c.datepicker.formatDate(k,h)}function f(k,h,n){return c.datepicker.formatDate(k,new Date(h),n)}function g(){return this.data("$dialog")}if(!this.length)return this;if("getStartDate"===a)return d();if("getEndDate"===a)return e();if("formatDate"===
a)return f.apply(this,Array.prototype.slice.call(arguments,1));var l={};"object"===typeof a&&(this.data("periodDialogOptions",c.extend({start_datetime:null,end_datetime:null},a)),l=this.data("periodDialogOptions"));return function(){var k=c(".crm-dialog-search-period-wrapper.is-template").clone(),h="crm-dialog-search-period-wrapper-"+(Math.random()+"").slice(2);c(".crm-dialog-search-period-wrapper:not(.is-template)").remove();k.removeClass("is-template");k.attr("id",h);k.show();c.waDialog({html:k,
onOpen:function(n,m){n.find(".datepicker").datepicker();l.start_datetime&&n.find(".datepicker.start").datepicker("setDate",c.datepicker.parseDate("yy-mm-dd",l.start_datetime));l.end_datetime&&n.find(".datepicker.end").datepicker("setDate",c.datepicker.parseDate("yy-mm-dd",l.end_datetime));var p=n.find(".js-apply-action"),q=n.find(".js-cancel-action");p.click(function(r){r.preventDefault();r=n.find(".start").datepicker("getDate");var u=n.find(".end").datepicker("getDate");n.trigger("select",[r,u]);
m.close()});q.click(function(r){r.preventDefault();n.trigger("cancel");m.close()});m.resize()}});this.data("$dialog",c("#"+h));return this.data("$dialog")}.call(this)}})(jQuery);var CRMSettings=function(c){CRMSettings=function(a){this.$wrapper=a.$wrapper;this.$sidebar=a.$sidebar;this.$activeMenuItem=!1;this.initClass()};CRMSettings.prototype.initClass=function(){this.initMenu();this.initToggleSidebar()};CRMSettings.prototype.initToggleSidebar=function(){function a(f,g){0>g.content_uri.indexOf("/settings/")&&c("body").removeClass("noscroll");c(document).off("wa_before_load",a);e.off("click")}var b=this,d=b.$wrapper.find(".sidebar:first"),e=d.find(".js-expand-sidebar");e.length&&
(e.on("click",function(f){f.preventDefault();b.sidebarIsOpen=!b.sidebarIsOpen;d.toggleClass("sidebar-opened");e.find(".fa-arrow-right").toggleClass("fa-rotate-180");c("body").toggleClass("noscroll")}),c(document).on("wa_before_load",a))};CRMSettings.prototype.initMenu=function(){function a(f){if(e.length&&e[0]==f[0])return!1;e.length&&e.removeClass("selected");f.addClass("selected");e=f}function b(f){var g;f&&(g=d.find('a[href="'+f+'"]:first'));if(g&&g.length)a(g.closest("li"));else{f=d.find("a[href^='"+
c.crm.app_url+"']");var l=location.pathname,k=0,h=0;f.each(function(n){var m=c(this),p=m.attr("href");m=m.data("alias");var q=p.length;m&&p==m?h=n:0<=l.indexOf(p)&&q>k&&(k=q,h=n)});if(h||0===h)g=f.eq(h),a(g.closest("li"))}}var d=this.$sidebar,e=d.find("li.selected:first")||!1;e.length||b();d.on("click","li > a",function(){var f=c(this),g=f.attr("href");g&&"javascript:"!=g.substr(0,11)&&!f.hasClass("js-no-highlight")&&(a(f.closest("li")),c.crm.title.set(f.text()))})};return CRMSettings}(jQuery);var CRMSettingsCompanies=function(c){CRMSettingsCompanies=function(a){this.$wrapper=a.$wrapper;this.$footer=this.$wrapper.find(".js-footer-actions");this.$company=this.$wrapper.find(".c-company-section");this.$taxList=this.$company.find(".c-options-list");this.$logoWrapper=this.$wrapper.find(".js-logo-section");this.$submitButton=this.$wrapper.find(".js-submit-button");this.locales=a.locales;this.company_id=a.company_id;this.tax_option_template=a.tax_option_template;this.empty_class="is-empty";this.start_left=
0;this.logo=!1;this.files=[];this.initClass()};CRMSettingsCompanies.prototype.initClass=function(){var a=this;a.initTabs();a.initTaxActions();a.initLogoChange();a.initSubmit();a.initDeleteCompany();a.initTemplatesSection();a.$wrapper.on("change","input, select, textarea",function(){a.toggleButton(!0)})};CRMSettingsCompanies.prototype.initTabs=function(){var a=this.$wrapper.find(".c-tabs-wrapper"),b=this.$wrapper.find(".c-companies-wrapper"),d=b.find(".c-companies-list"),e=d.find(".c-company.selected");
(function(){function f(){c.contains(document,a[0])?g():l.off("resize",f)}function g(){var h=a.outerWidth(!0)-k-38;b.css("max-width",h+"px")}var l=c(window),k=a.find(".c-add-wrapper").outerWidth(!0);g();l.on("resize",f)})();c.crm.tabSlider({$wrapper:b,$slider:d,$activeSlide:e.length?e:!1});(function(){function f(){var l={ids:function(){var k=[];d.find(".c-company").each(function(){k.push(c(this).data("id"))});return k.join(",")}()};g&&g.abort();g=c.post("?module=settings&action=companiesSortSave",
l,function(k){}).always(function(){g=!1})}var g=!1;d.sortable({distance:10,items:"> li",axis:"x",start:function(l,k){},stop:f,onUpdate:f})})()};CRMSettingsCompanies.prototype.initTaxActions=function(){var a=this,b=a.$company.find(".js-tax-name"),d=a.$taxList;a.$company.on("click",".js-delete-option",function(e){e.preventDefault();c(this).closest("li").remove();b.find("li").length||b.attr("required",!1);a.toggleButton(!0)});a.$company.on("click",".js-add-option",function(e){e.preventDefault();c(a.tax_option_template).appendTo(d);
b.attr("required",!0);a.toggleButton(!0)});(function(){d.sortable({handler:".js-sort-toggle",helper:"clone",distance:10,items:"> li",axis:"y",start:function(e,f){},stop:function(e,f){a.toggleButton(!0)},onUpdate:function(e,f){a.toggleButton(!0)}})})()};CRMSettingsCompanies.prototype.initLogoChange=function(){function a(h){h=h[0];if(h.type.match(/^image\/(png|jpe?g|gif)$/)){var n=new FileReader;n.onload=function(m){k.attr("src",m.target.result);b.$logoWrapper.removeClass(b.empty_class)};n.readAsDataURL(h);
b.logo=h}}var b=this,d=!1,e=!1,f=b.$logoWrapper,g=f.find(".js-drop-area"),l=g.find(".js-field"),k=f.find(".js-image");g.on("drop",function(h){h.stopPropagation();h=h.originalEvent.dataTransfer.files;h.length&&(a(h),b.toggleButton(!0))});l.on("change",function(){var h=this.files;h.length&&(a(h),b.toggleButton(!0))});f.on("click",".js-delete-logo",function(h){h.preventDefault();k.attr("src","");if(h=l.attr("name")){var n=c('<input type="hidden" />').attr("name",h).val("delete");l.attr("name","").data("name",
h).after(n)}f.addClass(b.empty_class);b.logo=!1;b.toggleButton(!0)});c(document).on("myDragEnter",function(){c.contains(document,g[0])?g.addClass("is-highlighted"):c(document).off("myDragEnter",b.watcher)});c(document).on("myDragLeave",function(){c.contains(document,g[0])?g.removeClass("is-highlighted"):c(document).off("myDragLeave",b.watcher)});g.on("dragover",function(h){h.preventDefault();d?clearTimeout(d):e||(e=!0,g.addClass("is-hover"));d=setTimeout(function(){d=null;e=!1;g.removeClass("is-hover")},
100)})};CRMSettingsCompanies.prototype.initSubmit=function(){var a=this,b=a.$wrapper.find(".js-form"),d=a.$wrapper.find(".js-errors-place"),e=a.$taxList,f=!1;b.on("submit",function(g){function l(){e.find(".c-tax-option").each(function(n){var m=c(this),p=m.find(".js-type");m=m.find(".js-percent");p.attr("name","company[tax_options]["+n+"][tax_type]");m.attr("name","company[tax_options]["+n+"][tax_percent]")});return b.serializeArray()}function k(n){n=n?n:[];c.each(n,function(m,p){m=p.name;p=p.value;
var q=a.$wrapper.find('[name="'+m+'"]');q.removeClass("error");q.parent().find("span.errormsg").remove();"contact[firstname]"!==m||q.is(":visible")||(q=a.$wrapper.find(".js-contact-autocomplete"));var r=c("<span class='c-error' />").addClass("errormsg").text(p);q.length&&!q.hasClass("error")?(q.parent().append(r),q.addClass("error").one("focus click change",function(){q.removeClass("error");r.remove()})):(d.append(r),b.one("submit",function(){remove(r)}))})}g.preventDefault();if(!f){f=!0;g=function(n){var m=
new FormData;c.each(n,function(p,q){m.append(q.name,q.value)});c.each(a.files,function(p,q){m.append("images["+q.code+"]",q.file)});a.logo&&m.append("logo",a.logo);(n=(n=document.cookie.match(/(?:^|; )_csrf=([^;]*)/))?decodeURIComponent(n[1]):"")&&m.append("_csrf",n);return m}(l());var h=c(a.locales.loading);h.insertAfter(a.$submitButton);c.ajax({url:"?module=settings&action=companiesSave",data:g,dataType:"json",processData:!1,contentType:!1,type:"POST",success:function(n){"ok"===n.status?(c(a.locales.saved_html).insertAfter(a.$submitButton),
a.company_id?c.crm.content.reload():c.crm.content.load(c.crm.app_url+"settings/companies/"+n.data.id+"/")):n.errors&&k(n.errors)}}).always(function(){h.remove();f=!1})}});b.on("keydown keypress keyup","input",function(g){13===g.keyCode&&g.preventDefault()})};CRMSettingsCompanies.prototype.initDeleteCompany=function(){var a=this,b=!1;a.$wrapper.on("click",".js-company-delete",function(d){d.preventDefault();b||(b=!0,c.post("?module=settings&action=companyDeleteDialog",{id:a.company_id},function(e){c.waDialog({html:e})}).always(function(){b=
!1}))})};CRMSettingsCompanies.prototype.toggleButton=function(a){var b=this.$submitButton,d=this.$footer.find(".js-edit-actions");a?(b.addClass("yellow"),d.show()):(b.removeClass("yellow"),d.hide())};CRMSettingsCompanies.prototype.initTemplatesSection=function(){function a(n,m){xhr&&xhr.abort();xhr=c.post("?module=settings&action=companiesRenderParams",{company_id:m,template_id:n},function(p){g.html(p);g.find(".c-color-section").each(function(){b(c(this))});g.find(".js-image-section").each(function(){d(c(this))})}).always(function(){xhr=
!1})}function b(n){var m=n.find(".c-colors"),p=n.find(".js-color-field"),q=m.find(".is-active"),r=function(v){r=function(t){this.$wrapper=t.$wrapper;this.$field=p;this.$icon=this.$wrapper.find(".js-toggle");this.$colorPicker=this.$wrapper.find(".js-color-picker");this.farbtastic=this.is_opened=!1;this.initClass()};r.prototype.initClass=function(){function t(){q.length&&(q.removeClass("is-active"),q=!1)}var w=this;w.farbtastic=v.farbtastic(w.$colorPicker,function(x){w.$field.val()!==x&&(t(),w.$field.val(x).change())});
w.$wrapper.data("colorPicker",w);w.$field.on("change keyup",function(){var x=v(this).val();w.$icon.css("background-color",x);w.farbtastic.setColor(x)});w.$icon.on("click",function(x){x.preventDefault();w.displayToggle(!w.is_opened)});w.$field.on("focus",function(){w.is_opened||w.displayToggle(!0)});w.$field.on("keyup",t);v(document).on("keyup",w.watcher);w.watcher=function(x){v.contains(document,w.$wrapper[0])?27===x.keyCode&&w.is_opened&&w.displayToggle(!1):v(document).off("keyup",w.watcher)}};r.prototype.displayToggle=
function(t){t?(this.$wrapper.removeClass("is-hidden"),this.is_opened=!0):(this.$wrapper.addClass("is-hidden"),this.is_opened=!1)};return r}(jQuery),u=new r({$wrapper:n.find(".js-toggle-wrapper").first()});m.on("click",".js-set-color",function(v){v.preventDefault();v=c(this);q.length&&q.removeClass("is-active");v.addClass("is-active");q=v;v=v.data("color");p.val(v).change();u.is_opened&&u.displayToggle(!1)});p.trigger("change")}function d(n){function m(w){w=w[0];if(w.type.match(/^image\/(png|jpe?g|gif)$/)){var x=
new FileReader;x.onload=function(y){t.attr("src",y.target.result);n.removeClass(e.empty_class)};x.readAsDataURL(w);w={code:n.data("code"),type:"param_image",file:w};e.files.push(w);p();n.data("file",w)}}function p(){var w=n.data("file");w&&(w=e.files.indexOf(w),e.files.splice(w,1),n.data("file",!1))}var q=!1,r=!1,u=n.find(".js-drop-area"),v=u.find(".js-field"),t=n.find(".js-image");u.on("drop",function(w){w.stopPropagation();w=w.originalEvent.dataTransfer.files;w.length&&(m(w),e.toggleButton(!0))});
v.on("change",function(){var w=this.files;w.length&&(m(w),e.toggleButton(!0))});n.on("click",".js-delete-image",function(w){w.preventDefault();t.attr("src","");if(w=v.attr("name")){var x=c('<input type="hidden" />').attr("name",w).val("delete");v.attr("name","").data("name",w).after(x)}n.addClass(e.empty_class);p();e.toggleButton(!0)});c(document).on("myDragEnter",function(){c.contains(document,u[0])?u.addClass("is-highlighted"):c(document).off("myDragEnter",e.watcher)});c(document).on("myDragLeave",
function(){c.contains(document,u[0])?u.removeClass("is-highlighted"):c(document).off("myDragLeave",e.watcher)});u.on("dragover",function(w){w.preventDefault();q?clearTimeout(q):r||(r=!0,u.addClass("is-hover"));q=setTimeout(function(){q=null;r=!1;u.removeClass("is-hover")},100)})}var e=this,f=e.$wrapper.find(".c-templates-section"),g=f.find(".js-template-options-wrapper"),l=f.find(".c-templates-slider"),k=f.find(".c-templates-list"),h=k.find(".js-template-wrapper.is-active");xhr=!1;(function(){var n=
f.find(".js-template-wrapper.is-active");f.on("click",".js-template-wrapper",function(m){m.preventDefault();m=c(this);if(!m.hasClass("is-active")){var p=m.data("id");m.find(".js-field").attr("checked",!0).trigger("change");n.length&&n.removeClass("is-active");n=m.addClass("is-active");a(p,e.company_id)}})})();c.crm.tabSlider({$wrapper:l,$slider:k,$activeSlide:h.length?h:!1});f.find(".c-color-section").each(function(){b(c(this))});f.find(".js-image-section").each(function(){d(c(this))})};return CRMSettingsCompanies}(jQuery),
CRMCompanyDeleteDialog=function(c){CRMCompanyDeleteDialog=function(a){this.$wrapper=a.$wrapper;this.company_id=a.company_id;this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMCompanyDeleteDialog.prototype.initClass=function(){this.initDelete()};CRMCompanyDeleteDialog.prototype.initDelete=function(){function a(){var l={data:[],errors:[]},k=f.serializeArray();c.each(k,function(h,n){l.data.push(n)});return l}function b(l,k){k=k?k:[];if(l){var h=Object.keys(l);c.each(h,function(n,m){k.push({name:m,
value:l[m]})})}c.each(k,function(n,m){n=m.value;var p=e.$form.find('[name="'+m.name+'"]');if(p.length&&!p.hasClass("error")){var q=c("<span />").addClass("errormsg").text(n);e.$wrapper.append(q);p.addClass("error").one("focus click change",function(){p.removeClass("error");q.remove()})}})}function d(l){g||(g=!0,c.post("?module=settings&action=companyDelete",l,function(k){"ok"===k.status?c.crm.content.load(c.crm.app_url+"settings/companies/"):b(k.errors)},"json").always(function(){g=!1;e.dialog.close()}))}
var e=this,f=e.$wrapper.find("form"),g=!1;f.on("submit",function(l){l.preventDefault();l=a();l.errors.length?b(!1,l.errors):d(l.data)})};return CRMCompanyDeleteDialog}(jQuery);var CRMSettingsCurrencies=function(c){CRMSettingsCurrencies=function(a){this.$wrapper=a.$wrapper;this.$currenciesList=this.$wrapper.find(".js-currencies-list");this.$currencySelect=this.$wrapper.find(".js-add-currency");this.currencies_is_locked=a.currencies_is_locked;this.currency_template_html=a.currency_template_html;this.copy_shop_currencies_dialog_html=a.copy_shop_currencies_dialog_html;this.locales=a.locales;this.currencies=a.currencies;this.initClass()};CRMSettingsCurrencies.prototype.initClass=
function(){this.currencies_is_locked||(this.initCurrencyAdd(),this.initCurrencyRemove(),this.initCurrenciesSort(),this.initChangePrimary(),this.initCurrencyEdit());this.initShopToggle()};CRMSettingsCurrencies.prototype.initCurrencyAdd=function(){function a(d,e){d=d.toLowerCase();b.$currencySelect.find("option").each(function(){var f=c(this);f.attr("value").toLowerCase()===d&&f.attr("disabled",!!e)})}var b=this;b.$currencySelect.on("change",function(){var d=c(this),e=d.val(),f=b.currencies[e],g=f.title;
f=f.sign;d.attr("disabled",!0);d=c(b.currency_template_html);d.data("code",e);d.find(".js-name").text(g);d.find(".js-current-code").text(e);d.find(".js-sign").text(f);d.find(".js-save-currency").addClass("js-save-new");d.addClass("is-edit");b.$currenciesList.append(d);d.find(".c-rate").select()}).on("removeCurrency",function(d,e){a(e)})};CRMSettingsCurrencies.prototype.initCurrencyRemove=function(){var a=this,b=!1;a.$wrapper.on("click",".js-remove-currency",function(d){function e(){b||(b=!0,c.post("?module=settings&action=currenciesDelete",
{code:l},function(k){"ok"==k.status&&(a.$currencySelect.trigger("removeCurrency",l),f.remove())}).always(function(){b=!1}))}d.preventDefault();var f=c(this).closest(".c-currency"),g=f.data("title"),l=f.data("code");if(!l)return!1;(function(){b||(b=!0,c.waDialog.confirm({title:'<i class="fas fa-exclamation-triangle smaller state-error"></i> '+a.locales.confirm_delete_title.replace("%currency_name",g),text:a.locales.confirm_delete_text,success_button_title:a.locales.confirm_delete_button,success_button_class:"danger",
cancel_button_title:a.locales.confirm_cancel_button,cancel_button_class:"light-gray",onSuccess:function(){e()}}),b=!1)})()})};CRMSettingsCurrencies.prototype.initCurrenciesSort=function(){function a(){e&&e.abort();var f={codes:b()};e=c.post("?module=settings&action=currenciesSort",f,function(g){}).always(function(){e=!1})}function b(){var f=[];d.$currenciesList.find(".c-currency").each(function(){var g=c(this).data("code");g&&f.push(g)});return f}var d=this,e=!1;d.$wrapper.find(".js-currencies-list").sortable({distance:10,
handle:".js-sort-toggle",helper:"clone",items:"> .c-currency",axis:"y",stop:a,onUpdate:a})};CRMSettingsCurrencies.prototype.initShopToggle=function(){function a(){k.set(!1)}function b(){var h=c.waDialog({html:e.copy_shop_currencies_dialog_html}).$wrapper.find("form");h.on("submit",function(n){n.preventDefault();is_locked||(is_locked=!0,n=h.serializeArray(),c.post("?module=settings&action=currenciesShopCopy",n,function(){c.crm.content.reload()}).always(function(){is_locked=!1}))});h.on("click",".js-cancel-button",
a)}function d(h){is_locked||(is_locked=!0,c.post("?module=settings&action=currenciesShopCopy",h?{}:{disable:1},function(n){c.crm.content.reload()}).always(function(){is_locked=!1}))}var e=this,f=e.$wrapper.find(".js-shop-currency-toggle"),g=e.$wrapper.find("#shop-currency-switch");is_locked=!1;if(!f.length)return!1;var l=f.data("use-shop")||!1;g.waSwitch({change:function(h,n){is_locked||(h?l?c.waDialog.confirm({title:'<i class="fas fa-exclamation-triangle smaller state-error"></i> '+e.locales.confirm_shop_title,
text:e.locales.confirm_shop_text,success_button_title:e.locales.confirm_shop_button,success_button_class:"danger",cancel_button_title:""+e.locales.confirm_cancel_button,cancel_button_class:"light-gray",onSuccess:function(){d(!0)},onCancel:a}):b():d(!1))}});var k=g.waSwitch("switch")};CRMSettingsCurrencies.prototype.initChangePrimary=function(){function a(){b||(b=!0,c.post("?module=settings&action=currenciesPrimary",{},function(d){c.waDialog({html:d,options:{onChange:function(e){c.crm.content.reload()}}})}).always(function(){b=
!1}))}var b=!1;this.$wrapper.on("click",".js-change-primary",function(d){d.preventDefault();a()})};CRMSettingsCurrencies.prototype.initCurrencyEdit=function(){var a=this.$currencySelect;this.$wrapper.on("click",".js-edit-currency",function(b){b.preventDefault();c(this).closest(".c-currency").addClass("is-edit")});this.$wrapper.on("click",".js-save-currency",function(b){function d(h){h=h?h:[];c.each(h,function(n,m){n=m.value;var p=e.find('[name="'+m.name+'"]'),q=c("<span />").addClass("errormsg").text(n);
p.length&&!p.hasClass("error")&&(p.closest("div").append(q),p.addClass("error").one("focus click",function(){p.removeClass("error");q.remove()}))})}b.preventDefault();var e=c(this).closest(".c-currency"),f=!1;b="?module=settings&action=currenciesSave";0<e.find(".js-save-new").length&&(b="?module=settings&action=currenciesAdd");if(!f){f=!0;var g=e.find(".js-rate"),l=g.val();l=l.replace(",",".");String(l).split(".");if(!(0<l)||9999999<l)return g.addClass("error").one("click",function(){g.removeClass("error")}),
f=!1;var k={code:e.data("code"),rate:l};c.post(b,k,function(h){"ok"===h.status?e.toggleClass("is-edit").find(".js-rate-text").text(l):h.errors&&d(h.errors)}).always(function(){f=!1;a.attr("disabled",!1);a.find(":selected").attr("disabled",!0);a.prop("selectedIndex",0)})}});this.$wrapper.on("click",".js-cancel",function(b){b.preventDefault();b=c(this).closest(".c-currency");0<b.find(".js-save-new").length?(b.remove(),a.attr("disabled",!1),a.prop("selectedIndex",0)):b.removeClass("is-edit")});this.$wrapper.on("keyup",
".js-rate",function(b){13===b.keyCode&&c(this).closest(".c-currency").find(".js-save-currency").trigger("click")})};return CRMSettingsCurrencies}(jQuery),CRMSettingsCurrenciesPrimary=function(c){CRMSettingsCurrenciesPrimary=function(a){this.$wrapper=a.$wrapper;this.$toggle=this.$wrapper.find(".js-currencies-toggle");this.dialog=this.$wrapper.data("dialog");this.currency_code=a.currency_code;this.initClass()};CRMSettingsCurrenciesPrimary.prototype.initClass=function(){var a=this,b=!1;a.$wrapper.on("click",
".js-change-currency",function(d){d.preventDefault();var e=a.$toggle.val();e!==a.currency_code?b||(b=!0,c.post("?module=settings&action=currenciesPrimarySave",{code:e},function(f){"ok"==f.status&&(a.dialog.options.onChange(e),a.dialog.close())}).always(function(){b=!1})):a.dialog.close()})};return CRMSettingsCurrenciesPrimary}(jQuery);var CRMSettingsFunnel=function(c){CRMSettingsFunnel=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$stagesSection=this.$wrapper.find(".c-stages-section");this.$stages=this.$stagesSection.find(".c-stages-list");this.funnel_id=a.funnel_id;this.stage_html=a.stage_html;this.locales=a.locales;this.initClass()};CRMSettingsFunnel.prototype.initClass=function(){var a=this;a.initSave();a.initDelete();a.initColorSection();a.initStagesSection();a.initNoAccessList();a.$form.on("input",
function(){a.toggleButton(!0)})};CRMSettingsFunnel.prototype.initColorSection=function(){function a(h){var n=g.find(".c-stage .c-ornament .svg-icon"),m=n.length;if(4===h.length||7===h.length){var p=(new c.crm.color(h)).getRange();b.val(p[0]);d.val(p[1]);n.each(function(q){q=p.getColor(Math.floor(100*(q+1)/m));var r=c(this),u=r.find("svg");u.length?u.find("polygon").css("fill",q):r.data("color",q)})}}var b=this.$wrapper.find(".js-start-color-field"),d=this.$wrapper.find(".js-end-color-field"),e=this.$wrapper.find(".c-color-section .c-colors"),
f=this.$wrapper.find(".c-color-section .js-color-field"),g=this.$wrapper.find(".c-color-section .c-stages"),l=e.find(".is-active"),k=function(h){k=function(n){this.$wrapper=n.$wrapper;this.$field=f;this.$icon=this.$wrapper.find(".js-toggle");this.$colorPicker=this.$wrapper.find(".js-color-picker");this.farbtastic=this.is_opened=!1;this.initClass()};k.prototype.initClass=function(){function n(){l.length&&(l.removeClass("is-active"),l=!1)}var m=this;m.farbtastic=h.farbtastic(m.$colorPicker,function(p){m.$field.val()!==
p&&(n(),m.$field.val(p).change())});m.$wrapper.data("colorPicker",m);m.$field.on("change keyup",function(){var p=h(this).val();m.$icon.css("background-color",p);m.farbtastic.setColor(p)});m.$icon.on("click",function(p){p.preventDefault();m.displayToggle(!m.is_opened)});m.$field.on("click",function(){m.displayToggle(!m.is_opened)});m.$field.on("keyup",n)};k.prototype.displayToggle=function(n){n?(this.$wrapper.removeClass("is-hidden"),this.is_opened=!0):(this.$wrapper.addClass("is-hidden"),this.is_opened=
!1)};return k}(jQuery);e.on("click",".js-set-color",function(h){h.preventDefault();h=c(this);l.length&&l.removeClass("is-active");h.addClass("is-active");l=h;h=h.data("color");f.val(h).change()});f.on("change",function(){a(f.val())});new k({$wrapper:this.$wrapper.find(".js-toggle-wrapper").first()});f.change();c.crm.renderSVG(this.$wrapper)};CRMSettingsFunnel.prototype.initStagesSection=function(){function a(f){function g(l){function k(){var q=parseInt(n.val()),r=parseInt(p.val()),u="";0<q&&0<r&&
(u=q*r);m.val(u)}function h(q){q?(l.addClass("is-extended"),n.focus()):(l.removeClass("is-extended"),n.val(""),m.val(""),b.toggleButton(!0))}var n=l.find(".js-visible-time-field"),m=l.find(".js-hidden-time-field"),p=l.find(".js-time-period-select");l.on("click",".js-show-time",function(){h(!0)});l.on("click",".js-remove-limit",function(){h(!1)});n.on("change",k);p.on("change",k);n.on("keyup",function(){var q=c(this),r=q.val();r=parseInt(r.replace(",","").replace(".",""));isNaN(r)?q.val(""):r?q.val(r):
q.val("")});(function(){var q=m.val();q&&0<parseInt(q)&&(0===parseInt(q)%24?(p.val("24"),n.val(parseInt(q)/24)):p.val("1"))})()}f.find(".js-time-limit-wrapper").each(function(){g(c(this))})}var b=this,d=b.$stagesSection,e=b.$stages;e.on("click",".js-delete-stage",function(f){f.preventDefault();1<b.$stages.find("li").length&&c(this).closest(".c-stage").remove();b.toggleButton(!0)});e.on("keydown keypress keyup","input",function(f){13===f.keyCode&&f.preventDefault()});d.on("click",".js-add-stage",function(f){f.preventDefault();
f=c(b.stage_html);b.$stages.append(f);a(f);b.toggleButton(!0)});e.sortable({distance:10,handle:".js-sort-toggle",helper:"clone",items:"> li",axis:"y",start:function(f,g){},stop:function(f,g){b.toggleButton(!0)}});a(e)};CRMSettingsFunnel.prototype.initSave=function(){function a(){var k=d.$form.serializeArray();d.$stages.find("li").each(function(h){var n=c(this),m=n.data("id");k.push({name:"stages["+h+"][name]",value:n.find(".js-name-field").val()});m&&k.push({name:"stages["+h+"][id]",value:m})});return k}
function b(k){f.insertAfter(l);c.post("?module=settings&action=funnelSave",k,function(h){"ok"===h.status&&(f.remove(),g.insertAfter(l),c.crm.content.load(c.crm.app_url+"settings/funnels/"+h.data.id+"/"))},"json").always(function(){e=!1})}var d=this,e=!1,f=c('<span class="c-notice"><i class="fas fa-spinner wa-animation-spin speed-1000 js-loading"></i></span>'),g=c('<span class="c-notice"><i class="fas fa-check"></i></span>'),l=d.$wrapper.find(".js-funnel-save-button");d.$form.on("submit",function(k){k.preventDefault();
!e&&(k=a())&&(e=!0,b(k))})};CRMSettingsFunnel.prototype.initDelete=function(){function a(){var e={id:b.funnel_id};d||(d=!0,c.post("?module=settings&action=funnelDelete",e,function(f){c.crm.content.load(c.crm.app_url+"settings/funnels/")},"json").always(function(){d=!1}))}var b=this,d=!1;b.$wrapper.on("click",".js-delete-funnel",function(e){e.preventDefault();c.waDialog.confirm({title:'<i class="fas fa-exclamation-triangle smaller state-error"></i> '+b.locales.delete_confirm_title+"?",text:b.locales.delete_confirm_text,
success_button_title:b.locales.delete_confirm_button,success_button_class:"danger",cancel_button_title:""+b.locales.delete_cancel_button,cancel_button_class:"light-gray",onSuccess:a})})};CRMSettingsFunnel.prototype.toggleButton=function(a){var b=this.$wrapper.find(".js-funnel-save-button"),d=this.$wrapper.find(".js-hidden-actions");a?(b.removeClass("green").addClass("yellow"),d.show()):(b.removeClass("yellow").addClass("green"),d.hide())};CRMSettingsFunnel.prototype.initNoAccessList=function(){var a=
this.$wrapper.find(".js-no-access-wrapper");a.on("click",".js-show-access-list",function(b){b.preventDefault();a.addClass("is-active")});a.on("click",".js-hide-access-list",function(b){b.preventDefault();a.removeClass("is-active")})};return CRMSettingsFunnel}(jQuery);var CRMSettingsFunnels=function(c){CRMSettingsFunnels=function(a){this.$wrapper=a.$wrapper;this.initClass()};CRMSettingsFunnels.prototype.initClass=function(){this.initTabs()};CRMSettingsFunnels.prototype.initTabs=function(){var a=this.$wrapper.find(".js-funnels-tabs"),b=this.$wrapper.find(".c-funnels-wrapper"),d=b.find(".c-funnels-list"),e=d.find(".c-funnel.selected");(function(){function f(){c.contains(document,a[0])?g():l.off("resize",f)}function g(){var h=a.outerWidth(!0)-k-38;b.css("max-width",
h+"px")}var l=c(window),k=a.find(".c-add-wrapper").outerWidth();g();l.on("resize",f)})();c.crm.tabSlider({$wrapper:b,$slider:d,$activeSlide:e.length?e:!1});(function(){function f(){var l={ids:function(){var k=[];d.find(".c-funnel").each(function(){k.push(c(this).data("id"))});return k.join(",")}()};g&&g.abort();g=c.post("?module=settings&action=funnelsSortSave",l,function(k){}).always(function(){g=!1})}var g=!1;d.sortable({distance:10,items:"> li",axis:"x",stop:f,onUpdate:f})})()};return CRMSettingsFunnels}(jQuery);var crmSettingsField=function(c){var a=function(b){this.$wrapper=b.$wrapper;this.initClass()};a.prototype.initClass=function(){this.initSortable();this.bindEvents()};a.prototype.initSortable=function(){function b(k){return k.find(".field").map(function(){return c.trim(c(this).data("id"))||""}).toArray()}function d(k,h){g&&(g.abort(),g=null);return c.post(k,h,function(){g=null})}var e=c.crm.app_url+"?module=settings&action=fieldSaveSort",f,g=!1,l=this.$wrapper.find(".js-other-fields");l.sortable({helper:"clone",
handle:".sort",items:"> .field",axis:"y",tolerance:"pointer",start:function(k,h){f=h.item.index()},stop:function(k,h){f!=h.item.index()&&(k=b(l),d(e,{fields:k}))},onUpdate:function(k){k=b(l);d(e,{fields:k})}})};a.prototype.bindEvents=function(){var b=!1,d=c.crm.app_url+"?module=settings&action=fieldEdit",e=null;this.$wrapper.on("click",".crm-edit-field-link",function(){var f=c(this);b||(b=!0,e&&(e.abort(),e=null),e=c.post(d,{id:f.data("id")||null},function(g){c.waDialog({html:g,onOpen:function(l,
k){k.resize()},onClose:function(l,k){b=!1}})}))})};return a}(jQuery);var crmSettingsFieldEdit=function(c){var a=function(b){this.$wrapper=b.$wrapper;this.$form=this.$wrapper.find("form");this.dialog=this.$wrapper.data("dialog");this.field=b.field||null;this.locales=b.locales;this.initClass()};a.prototype.initClass=function(){var b=this.$form.find(".crm-local-input-wrapper").eq(0).find("input"),d=b.val();b.focus().val("").val(d);this.bindEvents();this.editSubFields();this.field||this.initIDAutoFiller()};a.prototype.bindEvents=function(){var b=this.$form;b.on("change",
".crm-field-type-select",function(){var d=c(this).val(),e=b.find(".crm-values-textarea-wrapper").hide();"Select"!==d&&"Radio"!==d||e.show()});b.on("change",".crm-add-name-another-language-wrapper",function(){var d=c(this).find("option:selected"),e=d.data("id"),f=d.data("nameRegion"),g=b.find(".crm-local-input-wrapper"),l=g.clone();l.find("input").attr("name","name["+e+"]").val("").attr("disabled",!1).attr("data-main-locale","").attr("data-error-id",e).removeClass("error").end().find(".crm-name-region").text(f).end().find(".state-error-hint").text("").end().insertAfter(g);
l.find("input").focus();d.closest("li").hide();0>=b.find(".crm-add-name-another-language:not(:hidden)").length&&b.find(".crm-add-name-another-language-wrapper").hide()});this.initSubmit();this.field&&(this.field.editable?this.initDeleteLink():this.initDisableLink())};a.prototype.initSubmit=function(){var b=this,d=null;b.$form.submit(function(e){e.preventDefault();d&&(d.abort(),d=null);d=b.save()})};a.prototype.initDeleteLink=function(){var b=this,d=c.crm.app_url+"?module=settings&action=fieldDeleteConfirm";
b.$wrapper.on("click",".crm-field-delete",function(e){e.preventDefault();c.post(d,{id:b.field.id},function(f){c.waDialog({html:f,options:{edit_dialog:b.dialog},onOpen:function(){b.dialog.$wrapper.hide()}})})})};a.prototype.initDisableLink=function(){var b=this,d=b.$form,e=null;d.on("click",".crm-field-enable,.crm-field-disable",function(f){f.preventDefault();e&&(e.abort(),e=null);f={enable:c(this).hasClass("crm-field-enable")};e=c.post(d.attr("action"),f,function(g){"ok"==g.status&&(b.dialog.close(),
location.href=c.crm.app_url+"settings/field/")})})};a.prototype.save=function(){var b=this,d=b.$form,e=c(".crm-dialog-edit-field-wrapper").find(".js-save"),f=c('<span class="icon loading" style="vertical-align: middle;margin-left: 10px;"><i class="fas fa-spinner fa-spin"></i></span>');c(".loading").remove();e.prop("disabled",!0);var g=!0;d.find(".errormsg").text("");d.find(".state-error").removeClass("state-error");c('[name$="[localized_names]"]').each(function(){var l=c(this);!l.val()&&0>=l.parents(".template").length&&
l.closest("tr").find('[name$="[_disabled]"]:checked').length&&(g=!1,l.addClass("state-error").parent().append(c('<span class="errormsg"></span>').text(b.locales.field_is_required)))});if(!g)return e.attr("disabled",!1),d.one("input, keydown",".state-error",function(){c(this).removeClass("state-error").nextAll(".state-error-hint:first, .errormsg:first").empty()}),!1;f.appendTo(e.parent());return c.post(d.attr("action"),d.serialize(),function(l){"ok"==l.status&&(c(".loading").remove(),c('<i class="fas fa-check-circle" style="vertical-align: middle;margin-left: 10px;"></i>').appendTo(e.parent()),
setTimeout(function(){c.crm.content.reload();b.dialog.close()},1E3));if("ok"!==l.status&&l.errors){e.removeProp("disabled");c(".loading").remove();for(var k=0,h=l.errors.length;k<h;k+=1){var n=l.errors[k];if("string"===typeof n)d.find(".errormsg.crm-common-errors").append(n);else if("object"===typeof n)for(var m in n)if(n.hasOwnProperty(m)){var p=d.find('[data-error-id="'+m+'"]');p.addClass("state-error");p.nextAll(".state-error-hint:first").text(n[m])}}d.one("input, keydown",".state-error",function(){c(this).removeClass("state-error").nextAll(".state-error-hint:first, .errormsg:first").empty()});
d.find("[type=submit]").attr("disabled",!1)}})};a.prototype.initIDAutoFiller=function(){var b,d=this.$form,e=d.find('input[name^="name["][data-main-locale]'),f=d.find('input[name="id_val"]'),g=null;f.on("keydown.check_edited",function(){var l=c(this);l.data("val",l.val())}).on("keyup.check_edited",function(){var l=c(this);l.val()&&l.val()!=l.data("value")&&(l.off(".check_edited"),l.data("edited",1))});if(!f.prop("disabled")&&!f.data("edited"))d.on("keydown.crm-id-auto-filler",'input[name^="name["]',
function(){var l=c(this),k=d.find('[type="submit"]'),h=f.next(".loading");if(l.data("main-locale")||!e.val())f.prop("disabled")||f.data("edited")?d.off(".crm-id-auto-filler"):(k.prop("disabled",!0),h=h.length?h:c('<i class="icon16 loading"></i>'),h.insertAfter(f),b&&clearTimeout(b),b=setTimeout(function(){var n=function(){g&&(g.abort(),g=null);b&&clearTimeout(b);k.prop("disabled",!1);h.remove()};f.data("edited")?n():g=c.post(c.crm.app_url+"?module=settings&action=fieldTransliterate",d.find('input[name^="name["]').serialize(),
function(m){n();"ok"!==m.status||f.data("edited")||f.val(m.data)},"json")},300))})};a.prototype.editSubFields=function(){function b(l){var k=c(".crm-dialog-edit-field-wrapper").find(".js-save");l?k.addClass("yellow").removeAttr("disabled"):k.removeClass("yellow")}var d=this,e=c(".crm-dialog-edit-field-wrapper"),f=e.find(".subfields-list > .ui-sortable"),g=1;f.sortable({items:".field-row",handle:".js-subfield-sort",axis:"y",update:function(l){b(!0)}});f.on("click","a.js-add-subfield",function(){var l=
f.find(".field-row.template");l=l.clone().insertBefore(l).removeClass("template").removeClass("hidden");d.dialog.resize();var k="__"+g;g++;l.find("[name]").each(function(){var h=c(this);h.attr("name",h.attr("name").replace(/%FID%/g,k))});l.data("fieldId",k);l.find("select.type-selector").change();b(!0);return!1});e.on("click",".js-edit-subfield",function(l){l.preventDefault();c(this).closest("tr").addClass("editor-on").removeClass("editor-off");b(!0)});e.on("click",".js-delete-subfield",function(l){l.preventDefault();
var k=c(this).closest("tr");k.hasClass("just-added")&&k.remove();c.crm.confirm.show({title:d.locales.delete_subfield_title,text:d.locales.delete_subfield_text,button:d.locales.delete_subfield_button,onConfirm:function(){k.addClass("editor-off").removeClass("editor-on");var h=k.find('input:hidden[name$="[_disabled]"]').attr("name").replace("[_disabled]","[_deleted]");c(".js-field-form-edit").append(c('<input type="hidden" name="" value="1">').attr("name",h));k.children().children(":not(label)").remove();
k.find("label").addClass("gray").addClass("strike");b(!0)}})});f.on("click","a.add-item",function(){d.dialog.resize()});e.on("change","select.type-selector",function(){var l=c(this),k=l.closest("tr"),h=k.closest("table"),n=k.find(".field-advanced-settings").html('<span class="icon"><i class="fas fa-spinner fa-spin"></i></span>');c.post(c.crm.app_url+"?module=settings&action=fieldEditor",{ftype:l.val(),fid:k.data("fieldId"),parent:h.data("fieldParent")||"",prefix:h.data("fieldPrefix")},function(m){n.html(m);
b(!0)})});e.on("change",":checkbox, .name-input",function(){b(!0)});e.on("input change",function(){b(!0)})};return a}(jQuery);var crmSettingsFieldEditSubfieldValues=function(c){var a=function(d){this.$wrapper=c(".subfields-list");this.$hidden=d.hidden;this.$dialog_link=d.dialog_link;this.dialog_url=d.dialog_url;this.locales=d.locales;this.initClass()};a.prototype.initClass=function(){this.initValuesLink()};a.prototype.initValuesLink=function(){var d=this,e=!1;d.$wrapper.find(d.$dialog_link).on("click",function(){e||(e=!0,c.get(d.dialog_url,function(f){c.waDialog({html:f,onOpen:function(g,l){l.resize();d.editValues(g,l);
d.initSubmit(g,l)},onClose:function(g,l){e=!1}})}))})};a.prototype.editValues=function(d,e){var f=d.find("form");d.on("click",".s-add-rule",function(){var g=d.find(".s-new-rule");if(g.length){var l=g.clone();l.removeClass("s-new-rule").show().insertBefore(g);l.find('input[name^="parent"]').attr("disabled",!1);l.find(".s-add-value").click();b(d);l=parseInt(g.find('input[name="parent[]"]').val(),10)+1||1;g.find('input[name="parent[]"]').val(l);g.find('input[name^="parent_value"]').attr("name","parent_value["+
l+"]");g.find('input[name^="value"]').attr("name","value["+l+"][0]");e.resize()}return!1});d.on("click",".s-add-value",function(){var g=c(this).parents("table:first").find(".s-new-value");if(g.length){var l=g.clone();l.addClass("sortable").removeClass("s-new-value").show().insertBefore(g);l.find("input").attr("disabled",!1);l=g.find("input:first").attr("name");var k=l.lastIndexOf("["),h=(parseInt(l.substr(k+1),10)||0)-1;l=l.substr(0,k)+"["+h+"]";g.find("input:first").attr("name",l)}e.resize();return!1});
d.on("click",".s-delete-value",function(){var g=c(this),l=g.attr("data-id");g=g.parents("tr:first");var k=g.parents("table:first");l&&f.append('<input type="hidden" name="delete[]" value="'+l+'">');g.remove();k.find("tr.sortable:first").length||k.parents("div.field:first").remove();e.resize();return!1});b(d);this.$hidden.val()?d.find("select.otherwise-options").val("hide"):d.find("select.otherwise-options").val("input")};a.prototype.initSubmit=function(d,e){var f=this,g=d.find("form"),l=d.find(".js-save-values"),
k=c('<span class="icon loading custom-ml-4"><i class="fas fa-spinner fa-spin"></i></span>'),h=c('<span class="icon yes custom-ml-4"><i class="icon fas fa-check"></i>');g.submit(function(n){n.preventDefault();l.prop("disabled",!0);c(".loading").remove();k.appendTo(l.parent());var m=!0;d.find(".errormsg").remove();d.find(".state-error").removeClass("state-error");d.find('[name^="parent_value["]:not(:disabled)').each(function(){this.value||(m=!1,c(this).addClass("state-error").after(c('<span class="errormsg"></span>').text(f.locales.field_is_required)))});
d.find('[name^="value["]:not(:disabled)').each(function(){this.value||(m=!1,c(this).addClass("state-error").after(c('<span class="errormsg"></span>').text(f.locales.field_is_required)))});if(!m)return c("#s-field-values").closest(".dialog").find(".dialog-buttons :submit").attr("disabled",!1),!1;"input"==d.find("select.otherwise-options").val()?f.$hidden.val(""):f.$hidden.val("1").closest("td").find('input:checkbox[name$="[required]"]').attr("checked",!1);c.post(g.attr("action"),g.serialize()).done(function(p){c(".loading").remove();
h.appendTo(l.parent());"ok"==p.status&&(f.$dialog_link.parents(".field-advanced-settings").find(".show-when-modified").show(),f.$dialog_link.parents(".field-advanced-settings").find(".hide-when-modified").hide(),setTimeout(function(){e.close()},1E3))})})};var b=function(d,e){d.find(".value table>tbody").sortable({distance:5,helper:"clone",items:"tr.sortable",opacity:.75,axis:"y",tolerance:"pointer"})};return a}(jQuery);var crmSettingsFieldDeleteConfirm=function(c){var a=function(b){this.$wrapper=b.$wrapper;this.$form=this.$wrapper.find("form");this.dialog=this.$wrapper.data("dialog");this.edit_dialog=this.dialog.options.edit_dialog;this.initClass()};a.prototype.initClass=function(){this.bindEvents()};a.prototype.bindEvents=function(){var b=this,d=b.$form;b.$form.find(".crm-cancel").click(function(){b.dialog.close();b.edit_dialog.$wrapper.show()});d.submit(function(e){e.preventDefault();b.save()})};a.prototype.save=
function(){var b=this,d=b.$form;c.post(d.attr("action"),d.serialize(),function(){b.dialog.close();b.edit_dialog.close();location.href=c.crm.app_url+"settings/field/"})};return a}(jQuery);var CRMSettingsSources=function(c){CRMSettingsSources=function(a){this.$wrapper=a.$wrapper;this.messages=a.messages||{};this.messages.enable=this.messages.enable||"";this.messages.disable=this.messages.disable||"";this.source_type=a.source_type;this.initClass()};CRMSettingsSources.prototype.initClass=function(){this.initTabs();this.initWebFormLinks();this.initSourcesClick();this.initDisableLinks()};CRMSettingsSources.prototype.initTabs=function(){var a=this.$wrapper,b=function(e){var f=a.find('.c-tab[data-type="'+
e+'"]'),g=a.find('.c-tab-content[data-type="'+e+'"]');a.find(".c-tab.selected").removeClass("selected");a.find(".c-tab-content").hide();f.addClass("selected");g.show();c.crm.storage.set("crm/settings/source_tab",e)},d=c.crm.storage.get("crm/settings/source_tab");d||(d="email");this.source_type&&(d=this.source_type);b(d);a.on("click",".c-tab-link",function(e){e.preventDefault();b(c(this).closest(".c-tab").data("type"))})};CRMSettingsSources.prototype.initWebFormLinks=function(){this.$wrapper.on("click",
".js-c-web-form-link",function(){c.crm.storage.set("crm/settings/web_form_referrer","settings/sources")})};CRMSettingsSources.prototype.initSourcesClick=function(){var a=this.$wrapper,b=c('<span class="icon size-16 loading " ><i class="fas fa-spinner fa-spin"></i></span>');a.on("click",".c-source-details a",function(){c(this).parent().append(b)})};CRMSettingsSources.prototype.initDisableLinks=function(){var a=this.$wrapper.find(".js-c-disable-link"),b=null,d=c.crm.app_url+"?module=settingsSource&action=disable";
a.each(function(){var e=c(this),f=e.closest(".c-source"),g=f.data("id"),l=f.find(".c-loading");e.find("#switch-"+g).waSwitch({ready:function(k){var h=k.$wrapper.siblings("label");k.$label=h;k.active_text=h.data("active-text");k.inactive_text=h.data("inactive-text")},change:function(k,h){l.show();h.disable(!0);b&&b.abort();b=c.post(d,{id:g,disabled:k?0:1}).done(function(n){"ok"===n.status&&(k?(h.$label.text(h.inactive_text),f.removeClass("c-is-disabled")):(h.$label.text(h.active_text),f.addClass("c-is-disabled")),
h.disable(!1))}).always(function(){b=null;l.hide()})}})})};CRMSettingsSources.deleteSource=function(a,b){b=b.messages||{};c.crm.confirm.show({title:b.delete_confirm_title,text:b.delete_confirm_text,button:b.delete_confirm_button,onConfirm:function(){var d=c.crm.app_url+"?module=settings&action=sourceDelete",e=c(".crm-confirm-dialog"),f=e.find(".crm-loading").show(),g=e.find(".js-confirm-dialog").attr("disabled",!0);c.post(d,{id:a}).always(function(){c.crm.content.load(c.crm.app_url+"settings/sources/");
f.hide();g.attr("disabled",!1)});return!1}})};return CRMSettingsSources}(jQuery);var CRMSettingsSourceEmail=function(c){CRMSettingsSourceEmail=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$button=this.$form.find("[type=submit]");this.source=a.source||{};this.messages=a.messages||{};this.changed=!1;this.submit_xhr=null;this.initClass()};CRMSettingsSourceEmail.prototype.initClass=function(){this.initBlockToggles();this.initSubmit();this.initSecureCheckboxes();this.initChangeListeners();this.initIButton();0<this.source.id&&this.initDeleteLink();
this.initBlocks()};CRMSettingsSourceEmail.prototype.initSecureCheckboxes=function(){var a=this.$form.find(".c-secure-checkbox");a.click(function(){var b=c(this);b.is(":checked")&&a.not(b).attr("checked",!1)})};CRMSettingsSourceEmail.prototype.initChangeListeners=function(){var a=this,b=a.$form;b.on("change","input,textarea,select",function(d){a.setFormChanged();d.isTrigger||CRMSettingsSourceEmail.clearValidateErrors(b)});b.on("keyup","input:text,input:password,textarea",function(d){a.setFormChanged();
d.isTrigger||CRMSettingsSourceEmail.clearValidateErrors(b)})};CRMSettingsSourceEmail.prototype.initBlockToggles=function(){this.initDealCreateToggle()};CRMSettingsSourceEmail.prototype.initDealCreateToggle=function(){var a=this.$wrapper;a.find(".crm-source-settings-block-create_deal").on("toggled",function(b,d){b=a.find(".js-responsible-section").data("block_object");d?b.reload({}):b.reload({funnel_id:0})})};CRMSettingsSourceEmail.prototype.setFormChanged=function(a){(a=void 0!==a?a:!0)?this.$button.addClass("yellow"):
this.$button.removeClass("yellow");this.changed=a};CRMSettingsSourceEmail.prototype.clearValidateErrors=function(){var a=this.$form;a.find(".error").removeClass("error");a.find(".crm-errors-block").remove()};CRMSettingsSourceEmail.prototype.initSubmit=function(){var a=this,b=a.$form,d=a.$wrapper.find(".crm-form-buttons").find(".crm-loading"),e=a.$button,f=b.find(".crm-success-status"),g=c.crm.app_url+"?module=settingsSource&action=save";CRMSettingsSourceEmail.clearValidateErrors(b);b.submit(function(l){function k(){CRMSettingsSourceEmail.showValidateErrors(b,
{"":a.messages.connection_failed})}function h(){d.hide();e.prop("disabled",!1);a.submit_xhr=null}l.preventDefault();l=b.serializeArray();l.push({name:"id",value:0<a.source.id?a.source.id:a.source.provider});d.show();e.prop("disabled",!0);a.submit_xhr&&a.submit_xhr.abort();a.submit_xhr=c.post(g,l,null,"json").done(function(n){n?"ok"!=n.status?CRMSettingsSourceEmail.showValidateErrors(b,n.errors||{}):(a.setFormChanged(!1),f.show().fadeOut(500,function(){n.data.source?c.crm.content.load(c.crm.app_url+
"settings/sources/"+n.data.source.id+"/"):c.crm.content.reload()})):(h(),k())}).fail(k).always(h)})};CRMSettingsSourceEmail.prototype.initDeleteLink=function(){var a=this;a.$wrapper.find(".crm-delete-source-link").click(function(b){b.preventDefault();CRMSettingsSources.deleteSource(a.source.id,{messages:a.messages})})};CRMSettingsSourceEmail.prototype.initIButton=function(){var a=this;a.$wrapper.find("#js-ibutton").each(function(){var b=c(this),d=b.closest(".fields-group").find(".js-crm-block");if(b.data("iButtonInit"))return b;
a.$switch=b.waSwitch({ready:function(e){var f=e.$wrapper.siblings("label");e.$label=f;e.active_text=f.data("active-text");e.inactive_text=f.data("inactive-text")},change:function(e,f){e?(f.$label.text(f.active_text),b.find(".js-ibutton").attr("checked",!0),d.slideDown(350)):(f.$label.text(f.inactive_text),b.find(".js-ibutton").attr("checked",!1),d.slideUp(350))}})})};CRMSettingsSourceEmail.prototype.initBlocks=function(){var a=this.$wrapper,b=a.find(".js-deal-section");a=a.find(".js-responsible-section");
b=b.data("block_object");a=a.data("block_object");b.setResponsibleBlock(a)};CRMSettingsSourceEmail.clearValidateErrors=function(a){a.find(".state-error").removeClass("state-error");a.find(".crm-errors-block").remove()};CRMSettingsSourceEmail.showValidateErrors=function(a,b){var d={};c.each(b||{},function(e,f){"params"===e?c.each(f,function(g,l){d["source[params]["+g+"]"]=c.isArray(l)?l:[l]}):d[e?"source["+e+"]":""]=c.isArray(f)?f:[f]});CRMSettingsSourceEmail.clearValidateErrors(a);c.each(d,function(e,
f){var g=c('<div class="crm-errors-block"></div>');e=e?a.find('[name="'+e+'"]'):c();e.addClass("state-error");c.each(f,function(l,k){g.append('<span class="errormsg text-red">'+k+"</span>")});e.length?e.after(g):a.find(".crm-common-errors-block").append(g)})};return CRMSettingsSourceEmail}(jQuery);var CRMSettingsSourceEmailConnectionTestBlock=function(c){CRMSettingsSourceEmailConnectionTestBlock=function(a){this.$wrapper=a.$wrapper;this.source=a.source||{};this.url=a.url||c.crm.app_url+"?module=settingsSource&action=testConnection";this.initClass()};CRMSettingsSourceEmailConnectionTestBlock.prototype.initClass=function(){var a=this,b=a.$wrapper,d=b.find(".c-test-connection-button-block"),e=d.find(".c-loading"),f=d.find(".c-test-connection-success-message"),g=d.find(".c-test-connection-fail-message"),
l=null,k=b.find(".js-connection-settings-input"),h=b.find(".js-connection-settings-checkbox"),n=b.find(".c-test-connection-button"),m=function(){var p=a.url;l&&l.abort();f.hide();g.hide();e.show();k.attr("disabled",!0);var q=function(){g.show()};c.post(p,function(){var r=function(v){return{name:c.trim(v.attr("name")).match(/^source\[params\]\[(.+)\]$/)[1],value:v.val()}},u=[];k.each(function(){u.push(r(c(this)))});h.each(function(){var v=c(this);v.is(":checked")&&u.push(r(v))});0<a.source.id?u.push({name:"id",
value:a.source.id}):u.push({name:"id",value:a.source.provider});return u}(),null,"json").done(function(r){r&&"ok"==r.status?f.show():(q(),CRMSettingsSourceEmail.showValidateErrors(b,r.errors||{}))}).fail(q).always(function(){l=null;k.attr("disabled",!1);e.hide()})};(function(){var p=k.length,q=function(){var y=0;k.each(function(){0<c.trim(c(this).val()).length&&(y+=1)});return 0>=a.source.id?y==p:y==p-1},r=function(){var y=[];k.each(function(){y.push(c.trim(c(this).val()))});h.each(function(){y.push(c(this).is(":checked")?
"1":"0")});return y.join("@")},u=r(),v=function(){var y=r(),z=y!==u;u=y;return z},t=function(){d.show();n.show();f.hide();g.hide()},w=function(){q()?v()&&t():d.hide()},x=null;k.on("change",w).on("keydown",function(){x&&clearTimeout(x);x=setTimeout(function(){w()},250)});h.on("change",function(){v()&&t()})})();(function(){n.click(function(p){p.preventDefault();m()})})()};return CRMSettingsSourceEmailConnectionTestBlock}(jQuery);var CRMSettingsSourceIm=function(c){CRMSettingsSourceIm=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$button=this.$form.find("[type=submit]");this.source=a.source||{};this.messages=a.messages||{};this.changed=!1;this.submit_xhr=null;this.initClass()};CRMSettingsSourceIm.prototype.initClass=function(){this.initBlockToggles();this.initSubmit();this.initChangeListeners();0<this.source.id&&this.initDeleteLink()};CRMSettingsSourceIm.prototype.initChangeListeners=function(){var a=
this,b=a.$form;b.on("change","input,textarea,select",function(d){a.setFormChanged();d.isTrigger||CRMSettingsSourceIm.clearValidateErrors(b)});b.on("keyup","input:text,input:password,textarea",function(d){a.setFormChanged();d.isTrigger||CRMSettingsSourceIm.clearValidateErrors(b)})};CRMSettingsSourceIm.prototype.initBlockToggles=function(){this.initDealCreateToggle()};CRMSettingsSourceIm.prototype.initDealCreateToggle=function(){var a=this.$wrapper;a.find(".crm-source-settings-block-create_deal").on("toggled",
function(b,d){b=a.find(".js-responsible-section").data("block_object");d?b.reload({}):b.reload({funnel_id:0})})};CRMSettingsSourceIm.prototype.setFormChanged=function(a){(a=void 0!==a?a:!0)?this.$button.addClass("yellow"):this.$button.removeClass("yellow");this.changed=a};CRMSettingsSourceIm.prototype.clearValidateErrors=function(){var a=this.$form;a.find(".error").removeClass("error");a.find(".crm-errors-block").remove()};CRMSettingsSourceIm.prototype.initSubmit=function(){var a=this,b=a.$form,d=
a.$wrapper.find(".crm-form-buttons").find(".crm-loading"),e=a.$button,f=b.find(".crm-success-status"),g=c.crm.app_url+"?module=settingsSource&action=save";CRMSettingsSourceIm.clearValidateErrors(b);b.submit(function(l){l.preventDefault();l=b.serializeArray();l.push({name:"id",value:0<a.source.id?a.source.id:a.source.provider});d.show();e.prop("disabled",!0);a.submit_xhr&&a.submit_xhr.abort();a.submit_xhr=c.post(g,l,null,"json").done(function(k){"ok"===k.status?(a.setFormChanged(!1),f.show().fadeOut(500,
function(){k.data.source?c.crm.content.load(c.crm.app_url+"settings/sources/"+k.data.source.id+"/"):c.crm.content.reload()})):CRMSettingsSourceIm.showValidateErrors(b,k.errors||{})}).always(function(){d.hide();e.prop("disabled",!1);a.submit_xhr=null})})};CRMSettingsSourceIm.prototype.initDeleteLink=function(){var a=this;a.$wrapper.find(".crm-delete-source-link").click(function(b){b.preventDefault();CRMSettingsSources.deleteSource(a.source.id,{messages:a.messages})})};CRMSettingsSourceIm.prototype.initIButton=
function(){var a=this;a.$wrapper.find(".c-checkbox .js-ibutton").each(function(){var b=c(this),d=b.parent();$switch_wrapper=c('<span class="switch smaller"></span>');$switch_wrapper.prependTo(d);b.clone().appendTo($switch_wrapper);b.remove();a.$switch=$switch_wrapper.waSwitch({ready:function(e){var f=e.$wrapper.siblings("label");e.$label=f;e.inactive_text=f.eq(0).text();e.active_text=f.eq(1).text();f.eq(0).removeClass("gray");f.eq(1).hide()},change:function(e,f){e?f.$label.text(f.active_text):f.$label.text(f.inactive_text)}})})};
CRMSettingsSourceIm.clearValidateErrors=function(a){a.find(".state-error").removeClass("state-error");a.find(".crm-errors-block").remove()};CRMSettingsSourceIm.showValidateErrors=function(a,b){var d={};c.each(b||{},function(e,f){"params"===e?c.each(f,function(g,l){d["source[params]["+g+"]"]=c.isArray(l)?l:[l]}):d[e?"source["+e+"]":""]=c.isArray(f)?f:[f]});CRMSettingsSourceIm.clearValidateErrors(a);c.each(d,function(e,f){var g=c('<div class="crm-errors-block"></div>');e=e?a.find('[name="'+e+'"]'):
c();e.addClass("state-error");c.each(f,function(l,k){g.append('<span class="errormsg">'+k+"</span>")});e.length?e.after(g):a.find(".crm-common-errors-block").append(g)})};return CRMSettingsSourceIm}(jQuery);var CRMSettingsSourceWithContactBlock=function(c){CRMSettingsSourceWithContactBlock=function(a){this.$wrapper=a.$wrapper;this.segments_list_stages=a.segments_list_stages||{};this.init()};CRMSettingsSourceWithContactBlock.prototype.init=function(){this.initAddToSegments()};CRMSettingsSourceWithContactBlock.prototype.initAddToSegments=function(){var a=this.$wrapper,b=this.segments_list_stages,d=a.find(".c-segments-ul-fold-link"),e=a.find(".c-segments-ul");d.click(function(){var f=d.data("state");f=
"fold"===f?"unfold":"fold";var g=(b[f]||{}).link_text||"";d.data("state",f).find(".c-link-text").text(g);"fold"===f?e.slideUp():e.slideDown()})};return CRMSettingsSourceWithContactBlock}(jQuery);var CRMSettingsSourceCreateDealBlock=function(c){CRMSettingsSourceCreateDealBlock=function(a){this.$wrapper=a.$wrapper;this.$funnel=this.$wrapper.find(".js-funnel-id");this.$stage=this.$wrapper.find(".js-stage-id");this.url=c.crm.app_url+"?module=settingsSourceBlock&action=createDeal";this.source=a.source||{};this.ns="."+c.trim(this.$wrapper.attr("id"));this.id=a.id;this.namespace=a.namespace||"";this.class_id=a.class_id||"";this.responsible_block=null;this.initClass();this.$wrapper.data("block_object",
this)};CRMSettingsSourceCreateDealBlock.prototype.setResponsibleBlock=function(a){this.responsible_block=a};CRMSettingsSourceCreateDealBlock.prototype.initClass=function(){var a=this;a.$funnel.on("change"+a.ns,function(){var b=a.$stage.closest(".dropdown"),d=b.find(".js-visible-link");b.find(".menu.with-icons").remove();d.find(".funnel-state").remove();d.prepend('<span class="icon size-16"><i class="fas fa-spinner fa-spin"></i></span>');a.reload()});a.initFunnelsSelect();a.initStagesSelect()};CRMSettingsSourceCreateDealBlock.prototype.initFunnelsSelect=
function(){var a=this.$wrapper.find(".js-funnels-list"),b=a.find(".js-visible-link"),d=a.find(".js-field"),e=a.find(".menu");e.on("click","a",function(){var f=c(this);b.html(f.html());e.find(".selected").removeClass("selected");f.closest("li").addClass("selected");e.hide();setTimeout(function(){e.removeAttr("style")},200);f=f.data("id");d.val(f).trigger("change")})};CRMSettingsSourceCreateDealBlock.prototype.initStagesSelect=function(){var a=this.$wrapper.find(".js-stages-list"),b=a.find(".js-visible-link"),
d=a.find(".js-field"),e=a.find(".menu");e.on("click","a",function(){var f=c(this);b.html(f.html());e.find(".selected").removeClass("selected");f.closest("li").addClass("selected");e.hide();setTimeout(function(){e.removeAttr("style")},200);f=f.data("id");d.val(f).trigger("change")})};CRMSettingsSourceCreateDealBlock.prototype.reload=function(){var a=this,b=a.$stage,d=a.url,e=a.responsible_block;b={id:a.id,funnel_id:a.$funnel.val(),stage_id:b.val(),namespace:a.namespace};var f=c.Deferred(),g=c.Deferred();
c.when(f,g).done(function(l,k){k&&l.setResponsibleBlock(k)});c.get(d,b,function(l){l=c("<div>").html(l);var k=l.find("."+a.class_id);a.$wrapper.replaceWith(k);f.resolve(k.data("block_object"));a.destroy();l.remove()});e?e.reload({funnel_id:b.funnel_id},function(l){g.resolve(l)}):g.resolve()};CRMSettingsSourceCreateDealBlock.prototype.destroy=function(){var a=this;a.$funnel.off(a.ns);a.$wrapper.removeData("block_object");c.each(a,function(b){delete a[b]})};return CRMSettingsSourceCreateDealBlock}(jQuery);var CRMSettingsSourceResponsibleBlock=function(c){CRMSettingsSourceResponsibleBlock=function(a){this.$wrapper=a.$wrapper;this.$group=this.$wrapper.find(".crm-group-id");this.$user=this.$wrapper.find(".crm-user");this.$user_id=this.$wrapper.find(".crm-responsible-contact_id");this.$user_info=this.$wrapper.find(".crm-user-info-block");this.$user_delete_link=this.$user_info.find(".crm-delete-link");this.url=c.crm.app_url+"?module=settingsSourceBlock&action=responsible";this.ns="."+c.trim(this.$wrapper.attr("id"));
this.source=a.source||{};this.funnel_id=this.source.funnel_id;this.namespace=a.namespace||"";this.class_id=a.class_id||"";this.initClass();this.$wrapper.data("block_object",this)};CRMSettingsSourceResponsibleBlock.prototype.initClass=function(){var a=this,b=a.$wrapper,d=a.$group,e=a.$user,f=a.$user_id,g=a.$user_delete_link,l=a.$user_info,k=f.val(),h=function(){e.show().attr("disabled",!1).attr("required",!0)},n=function(){e.hide().attr("disabled",!0).attr("required",!1)};d.on("change"+a.ns,function(){var m=
c(this),p=m.parents(".crm-fields").find(".js-group-hint");f.val("");"personally"===m.val()?h():(n(),l.hide());"personally"===m.val()||""===m.val()?p.hide():p.show();0<m.val()&&f.val(-m.val());k!=f.val()&&(b.trigger("changeResponsibleUser",[k,f.val()]),k=f.val())});g.on("click"+a.ns,function(m){m.preventDefault();f.val("");h();l.hide()});e.autocomplete({source:c.crm.app_url+"?module=autocomplete&type=user&funnel_id="+a.funnel_id,minLength:0,html:!0,focus:function(){return!1},select:function(m,p){e.val("");
if(0>=p.item.rights)return!1;n();l.show();l.find(".crm-user-icon").css("background-image","url("+p.item.photo_url+")");l.find(".crm-user-name").text(p.item.name).attr("title",p.item.name);f.val(p.item.id);k!=f.val()&&(b.trigger("changeResponsibleUser",[k,f.val()]),k=f.val());return!1}}).data("ui-autocomplete")._renderItem=function(m,p){var q=c("<li />");q.addClass("ui-menu-item-html").append("<div>"+p.value+"</div>").appendTo(m);0<a.funnel_id&&!p.rights&&(q.addClass("is-locked"),q.on("click"+a.ns,
function(r){r.preventDefault();r.stopPropagation()}));return q};e.on("focus"+a.ns,function(){e.data("uiAutocomplete").search(e.val())})};CRMSettingsSourceResponsibleBlock.prototype.reload=function(a,b){var d=this,e=this.$user_info,f=c('<span class="icon loading"><i class="fas fa-spinner fa-spin"></i></span>'),g=d.url;e.is(":visible")&&(d.$user_delete_link.hide(),f.css({marginTop:"-16px",marginRight:"-16px",float:"right"}));e.after(f);a=a||{};a.namespace=d.namespace;"undefined"===typeof a.funnel_id&&
(a.funnel_id=d.funnel_id);a.responsible_contact_id=d.$user_id.val();a.group_id=d.$group.val();f.show();c.get(g,a,function(l){l=c("<div>").html(l);var k=l.find("."+d.class_id);d.$wrapper.replaceWith(k);k=k.data("block_object");b&&b(k);l.remove();d.destroy()})};CRMSettingsSourceResponsibleBlock.prototype.destroy=function(){var a=this;a.$user_delete_link.off(a.ns);a.$group.off(a.ns);a.$wrapper.removeData("block_object");a.$user.data("ui-autocomplete")&&(a.$user.autocomplete("destroy"),a.$user.removeData("ui-autocomplete"));
c.each(a,function(b){delete a[b]})};return CRMSettingsSourceResponsibleBlock}(jQuery);var CRMSettingsForms=function(c){CRMSettingsForms=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$button=this.$form.find("[type=submit]");this.submit_xhr=null;this.initClass()};CRMSettingsForms.prototype.initClass=function(){};return CRMSettingsForms}(jQuery);var crmSettingsForm=function(c){crmSettingsForm=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find(".crm-form-settings-form");this.$form_fields=this.$wrapper.find(".crm-form-fields");this.$form_available_fields=this.$wrapper.find(".crm-available-fields");this.$confirmation_checkbox=this.$wrapper.find(".crm-confirmation-checkbox");this.$confirmation_enable_text=this.$wrapper.find(".crm-confirmation-enable-text");this.$email_confirm_block=this.$wrapper.find(".crm-form-email-confirm-block");
this.$back_button=this.$wrapper.find(".crm-form-header .js-back-button");this.$create_deal_block_wrapper=this.$wrapper.find(".crm-form-settings-block-form_create_deal");this.$button=this.$form.find("[type=submit]");this.$delete_link=this.$wrapper.find(".crm-delete-form-link");this.$copy=this.$wrapper.find(".js-copy");this.$iframe_textarea=this.$wrapper.find(".crm-iframe-code");this.$available_deal_related_field=this.$form_available_fields.find('.crm-form-field[data-form-field-type="deal"]').add(this.$form_available_fields.find('.crm-form-field[data-id="!deal_description"]')).add(this.$form_available_fields.find('.crm-form-field[data-id="!deal_attachments"]'));
this.$edit_dialog_template=this.$wrapper.find('.crm-settings-form-edit-field-wrapper[data-template="1"]');this.$paragraph_edit_dialog_template=this.$wrapper.find('.crm-settings-form-paragraph-edit-wrapper[data-template="1"]');this.$agreement_checkbox_edit_dialog_tempalte=this.$wrapper.find('.c-settings-form-agreement-checkbox-edit-wrapper[data-template="1"]');this.referrer=c.crm.storage.get("crm/settings/web_form_referrer");c.crm.storage.del("crm/settings/web_form_referrer");this.form=a.form||{};
this.form.params=this.form.params||{};this.form.params.fields=this.form.params.fields||{};this.available_fields=a.available_fields||{};this.lang=a.lang;this.messages=a.messages||{};a=a.default_checked_fields||[];if(0>=this.form.id&&"settings/sources"===this.referrer){var b=a.indexOf("password");0<=b?a[b]="!deal_description":a.push("!deal_description")}this.default_checked_fields=a;this.changed=!1;this.submit_xhr=null;this.initClass()};crmSettingsForm.prototype.initClass=function(){this.initDealCreateCheckbox();
this.renderDealDescription();this.bindEvents();this.initIButtons();this.initAddNewFieldLink();this.initAvailableFields();this.initDeleteFieldLinks();this.initPreviewButton();this.initFormWidthInput();this.initFields();this.initSubmit();this.initDeleteLink();this.initSortable();this.initTextEditor();this.initCopySmartyHelper();this.initIframeTextarea();this.initMessagesBlock();this.initCancelLink();this.initBlocks();this.initBackButton()};crmSettingsForm.prototype.initBackButton=function(){this.$back_button.on("click",
function(a){a.preventDefault();history.back()})};crmSettingsForm.prototype.renderDealDescription=function(a){var b=this.$form_fields.find('[data-id="!deal_description"]').find("textarea");a||(a=this.getField("!deal_description"));!a||0>=a.checked||!b.length||(a.redactor?b.data("redactor")?(a=b.redactor("core.editor"))&&0<a.length&&a[0].attr("placeholder",b.attr("placeholder")):c.crm.initWYSIWYG(b,{focus:!1,buttons:["bold","italic","underline","link"],plugins:[],maxHeight:100,minHeight:100}):(b.data("redactor")&&
b.redactor("core.destroy"),b.show()))};crmSettingsForm.prototype.bindEvents=function(){var a=this;a.$form.on("change","input,textarea,select",function(b){a.setFormChanged();b.isTrigger||a.clearValidateErrors()});a.$form.on("keyup","input:text,textarea",function(b){a.setFormChanged();b.isTrigger||a.clearValidateErrors()});a.$form.find(".crm-iframe-code-block-toggle").click(function(){a.$iframe_textarea.toggle()})};crmSettingsForm.prototype.initDealCreateCheckbox=function(){var a=this,b=a.referrer,
d=function(e){var f=a.$wrapper.find(".js-responsible-section").data("block_object");e?(a.$available_deal_related_field.removeClass("crm-disabled"),a.$wrapper.find(".js-hint-about-deal-fields").hide(),a.$wrapper.find(".js-hint-about-deal-fields").next().addClass("crm-top-bordered"),f.reload({})):(a.$available_deal_related_field.each(function(){var g=c(this).data("id");a.getFormField(g).find(".crm-delete-field-link").trigger("click")}),a.$available_deal_related_field.addClass("crm-disabled"),a.$wrapper.find(".js-hint-about-deal-fields").show(),
a.$wrapper.find(".js-hint-about-deal-fields").next().removeClass("crm-top-bordered"),f.reload({funnel_id:0}))};a.$create_deal_block_wrapper.on("toggled",function(e,f){d(f,!0)});0>=a.form.id&&"settings/sources"===b&&(a.$create_deal_block_wrapper.find(":checkbox").attr("checked",!0).trigger("change"),d(!0,!1))};crmSettingsForm.prototype.setFormChanged=function(a){(a=void 0!==a?a:!0)?this.$button.addClass("yellow"):this.$button.removeClass("yellow");this.changed=a};crmSettingsForm.prototype.initPreviewButton=
function(){var a=this.$wrapper,b=a.find(".crm-form-preview-submit-button-caption-input"),d=a.find(".crm-form-preview-submit-button"),e=function(f){f?(b.show(),d.hide(),b.val(d.val())):(b.hide(),d.show())};d.click(function(){e(!0)});b.blur(function(){d.val(b.val());e(!1)}).keyup(function(f){f.preventDefault();13==f.keyCode?(d.val(b.val()),e(!1)):27==f.keyCode&&e(!1)})};crmSettingsForm.prototype.initFormWidthInput=function(){var a=this.$wrapper,b=a.find(".crm-form-width-input"),d=a.find(".crm-form-preview-block");
b.keyup(function(e){13==e.keyCode&&(b.val(Math.max(Math.min(parseInt(b.val(),10)||0,600),200)),d.width(b.val()))})};crmSettingsForm.prototype.initTextEditor=function(){var a=this,b=a.$form.find('[name="form[params][confirm_mail_body]"]');b.waEditor({focus:!1,buttons:["formatting","bold","italic","link"],plugins:["fontcolor","fontsize","fontfamily"],minHeight:200,callbacks:{keydown:function(d){},change:function(){b.waEditor("sync");a.setFormChanged()}},lang:a.lang})};crmSettingsForm.prototype.initMessagesBlock=
function(){var a=this,b=a.$wrapper,d=b.find(".c-settings-messages-block");b=b.find(".js-deal-section");a.renderToVariantSelectors();d.on("loadEditor",function(){a.renderToVariantSelectors()});b.on("changeResponsibleUser",function(){a.renderToVariantSelectors()})};crmSettingsForm.prototype.renderToVariantSelectors=function(){var a=this.$wrapper.find(".c-settings-messages-block"),b=this.getField("email"),d=b&&0<b.checked,e=function(f,g){var l=f.closest("label");g?(f.data("checked",f.is(":checked")),
f.prop("disabled",!0).prop("checked",!1)):f.prop("disabled",!1).prop("checked",f.data("checked"));f.is(":checked")?l.addClass("bold"):l.removeClass("bold")};a.find(".c-message-to-selector").each(function(){var f=c(this),g=f.find(".c-label");f=f.find(".c-message-to-variants-list");var l=f.find(':checkbox[data-id="client"]');e(l,!d);var k=[];f.find(":checkbox:checked:not(:disabled)").each(function(){var h=c(this).closest("li");k.push(h.find(".c-variant-name-text").text())});k=0<k.length?k.join(", "):
g.data("initial_text");g.text(k)})};crmSettingsForm.prototype.getField=function(a,b){var d=this.form.params.fields,e=d.length,f=null;b="undefined"===typeof b?1:parseInt(b,10)||0;if(0>=b)return null;for(var g=0;g<e;g+=1)if(d[g].id==a&&d[g].checked==b){f=d[g];break}if(!f)return f;f.required=f.required||"";f.captionplace=f.captionplace||"left";f.caption=f.caption||"string"===typeof f.caption?f.caption:f.name;f.placeholder=f.placeholder||"";return f};crmSettingsForm.prototype.getAvailableField=function(a){if(this.available_fields[a]){a=
c.extend({},this.available_fields[a]);if("!horizontal_rule"===a.id||"!paragraph"===a.id)a.captionplace="none";return a}return null};crmSettingsForm.prototype.updateAvailableField=function(a,b){this.available_fields[a]&&c.extend(this.available_fields[a],b)};crmSettingsForm.prototype.addField=function(a,b,d){b=parseInt(b,10)||0;0>=b||!d||(this.deleteField(a,b),d=c.extend({},d,{id:a,checked:b}),this.form.params.fields.push(d))};crmSettingsForm.prototype.deleteField=function(a,b){var d=this.form.params.fields,
e=d.length;b=parseInt(b,10)||0;for(var f=[],g=0;g<e;g+=1)d[g].id==a&&d[g].checked==b||f.push(d[g]);b=0;e=f.length;for(g=0;g<e;g+=1)f[g].id==a&&(b+=1,f[g].checked=b);this.form.params.fields=f};crmSettingsForm.prototype.updateField=function(a,b,d){0>=b||(b=this.getField(a,b),b=c.extend(b,d),this.form.params.fields[a]=b,this.setFormChanged())};crmSettingsForm.prototype.renderField=function(a,b){var d=this.getField(a,b),e=this.$form_fields.find('.crm-form-field:not(.crm-form-field-template)[data-id="'+
a+'"][data-checked="'+b+'"]');if(d)if(e.length||(e=this.$form_fields.find('.crm-form-field-template.crm-form-field-template[data-id="'+a+'"]').clone(),e.removeClass("crm-form-field-template"),e.attr("data-checked",b),e.insertBefore(this.$form_fields.find(".crm-form-field-template:first")),e.show()),"!paragraph"===d.id)e.find(".crm-paragraph").html(d.text||"");else{a=e.find(".crm-caption");b=a.html;var f=(f=d.caption)&&(""+f).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");b.call(a,
"<label>"+f+(d.required&&"!captcha"!==d.id?" *":"")+"</label>");e.removeClass("crm-caption-style-none crm-caption-style-above").addClass("crm-caption-style-"+d.captionplace);e.find(":input:eq(0)").prop("placeholder",d.placeholder||"");"password"===d.id&&e.find(":input:eq(1)").prop("placeholder",d.placeholder_confirm||"");"!deal_description"===d.id&&this.renderDealDescription(d)}else e.remove()};crmSettingsForm.prototype.initFields=function(){var a=this;a.$form_fields.on("click",".crm-caption-col, .crm-input-col",
function(b){a.editField(c(this).closest(".crm-form-field"))})};crmSettingsForm.prototype.editField=function(a){var b=a.data("id");a=a.data("checked");if("!horizontal_rule"!==b){var d={html:"",id:b,checked:a,settingsForm:this};a="!agreement_checkbox"===b?this.$agreement_checkbox_edit_dialog_tempalte.clone():"!paragraph"===b?this.$paragraph_edit_dialog_template.clone():this.$edit_dialog_template.clone();a.removeAttr("data-template").attr("id","crm-settings-dialog-wrapper-"+b);a.appendTo("body");a.show();
d.html=a;"!agreement_checkbox"===b?new crmSettingsFormAgreementCheckboxEditDialog(d):"!paragraph"===b?new crmSettingsFormParagraphEditDialog(d):new crmSettingsFormFieldEditDialog(d)}};crmSettingsForm.prototype.initSubmit=function(){var a=this,b=a.$form,d=b.find(".crm-loading"),e=b.find(".crm-success-status");b.on("keypress","input",function(f){13==f.keyCode&&f.preventDefault()});b.submit(function(f){f.preventDefault();f=b.serializeArray();var g=[];c.each(a.form.params.fields,function(l,k){if(0<k.checked){var h=
g.length;c.each(k,function(n,m){"html"!==n&&(g[h]=g[l]||{},g[h][n]=m)})}});f.push({name:"form[params][fields]",value:JSON.stringify(g)});a.clearValidateErrors();d.show();a.$button.prop("disabled",!0);a.submit_xhr&&a.submit_xhr.abort();a.submit_xhr=c.post(b.attr("action"),f).done(function(l){"ok"!==l.status?(a.showValidateErrors(l.errors||{}),d.hide(),a.$button.prop("disabled",!1)):(e.show().fadeOut(500),c.crm.content.load(c.crm.app_url+"settings/form/"+l.data.form.id).then(function(){d.hide();a.$button.prop("disabled",
!1);a.setFormChanged(!1)}))}).fail(function(){a.showValidateErrors({"":a.messages.unknown_server_error});d.hide();a.$button.prop("disabled",!1)}).always(function(){})})};crmSettingsForm.prototype.clearValidateErrors=function(){var a=this.$form;a.find(".state-error").removeClass("state-error");a.find(".crm-errors-block").remove()};crmSettingsForm.prototype.showValidateErrors=function(a){var b=this.$form,d={};c.each(a||{},function(e,f){"params"===e?c.each(f,function(g,l){d["form[params]["+g+"]"]=c.isArray(l)?
l:[l]}):d[e?"form["+e+"]":""]=c.isArray(f)?f:[f]});this.clearValidateErrors();c.each(d,function(e,f){var g=c('<div class="crm-errors-block"></div>');e=e?b.find('[name="'+e+'"]'):c();e.addClass("state-error");c.each(f,function(l,k){g.append('<span class="errormsg">'+k+"</span>")});e.length?e.after(g):b.find(".crm-common-errors-block").append(g)})};crmSettingsForm.prototype.initDeleteLink=function(){var a=this,b=a.messages||{};a.$delete_link.click(function(d){d.preventDefault();c.crm.confirm.show({title:b.delete_confirm_title,
text:b.delete_confirm_text,button:b.delete_confirm_button,onConfirm:function(){var e=c(".crm-confirm-dialog"),f=e.find(".crm-loading").show(),g=e.find(".js-confirm-dialog").attr("disabled",!0);c.post(c.crm.app_url+"?module=settings&action=formDelete",{id:a.form.id}).always(function(){c.crm.content.load(c.crm.app_url+"settings/form");f.hide();g.attr("disabled",!1)});return!1}})})};crmSettingsForm.prototype.initSortable=function(){var a=this;a.$form_fields.sortable({distance:5,helper:"clone",items:".crm-form-field:not(:hidden)",
opacity:.75,handle:".sort",tolerance:"pointer",containment:a.$form_fields,update:function(){for(var b=a.form.params.fields,d=b.length,e={},f=[],g=a.$form_fields.find(".crm-form-field:not(.crm-form-field-template)"),l=0;l<d;l+=1)e[b[l].id+"-"+b[l].checked]=l;g.each(function(){var k=c(this),h=k.data("id");k=k.data("checked");f.push(b[e[h+"-"+k]])});a.form.params.fields=f;a.setFormChanged()}})};crmSettingsForm.prototype.initDeleteFieldLinks=function(){var a=this;a.$wrapper.on("click",".crm-delete-field-link",
function(){var b=c(this).closest(".crm-form-field");a.deleteFormField(b)})};crmSettingsForm.prototype.deleteFormField=function(a){if(!(0>=a.length)){var b=this,d=a.data("id"),e=a.data("checked"),f=b.getAvailableField(d);b.$form_available_fields.find('.crm-form-field[data-id="'+d+'"]').removeClass("crm-disabled");b.deleteField(d,e);a.remove();f&&b.updateAvailableField(d,{checked:f.checked-1});"email"===d&&(b.disableIButton(b.$confirmation_checkbox),b.$confirmation_checkbox.attr("disabled",!0),b.$confirmation_enable_text.show(),
b.$form_available_fields.find('.crm-form-field[data-id="password"]').addClass("crm-disabled"),a=b.getFormField("password"),b.deleteFormField(a),b.renderToVariantSelectors());"company"===d&&b.$form_available_fields.find(".crm-form-field[data-person-enabled=0][data-company-enabled=1]").each(function(){var g=c(this),l=g.data("id");l=b.getFormField(l);b.deleteFormField(l);g.addClass("crm-disabled")});b.setFormChanged()}};crmSettingsForm.prototype.getFormField=function(a,b){var d='.%clz%[data-id="%id%"]%extra%:not(.%not_clz%)';
a=[["%clz%","crm-form-field"],["%id%",a],["%extra%",void 0!==b?'[data-id="'+b+'"]':""],["%not_clz%","crm-form-field-template"]];b=0;for(var e=a.length;b<e;b+=1)d=d.replace(a[b][0],a[b][1]);return this.$form_fields.find(d)};crmSettingsForm.prototype.initAvailableFields=function(){var a=this,b=a.default_checked_fields,d=a.$form_available_fields;d.on("click",".crm-form-field:not(.crm-disabled)",function(e){a.addFormField(c(this))});0>=a.form.id&&0<b.length&&c.each(b,function(e,f){e=d.find('.crm-form-field[data-id="'+
f+'"]:not(.crm-disabled)');a.addFormField(e)})};crmSettingsForm.prototype.addFormField=function(a){if(!(0>=a.length)){var b=a.data("id"),d=this.getAvailableField(b);this.$form_available_fields.hide();var e=d.checked+1;d.is_multi||a.addClass("crm-disabled");this.getField(d.id,e)||this.addField(b,e,d);this.updateAvailableField(b,{checked:e});"email"===b&&(this.$confirmation_enable_text.hide(),this.enableIButton(this.$confirmation_checkbox),this.$confirmation_checkbox.attr("disabled",!1),(a=this.getAvailableField("password"))&&
0>=a.checked&&this.$form_available_fields.find('.crm-form-field[data-id="password"]').removeClass("crm-disabled"));"company"===b&&this.$form_available_fields.find(".crm-form-field.crm-disabled[data-person-enabled=0][data-company-enabled=1]").removeClass("crm-disabled");this.renderField(b,e);"!paragraph"===b&&(b=this.$form_fields.find('.crm-form-field[data-id="'+b+'"][data-checked="'+e+'"]'),this.editField(b));this.setFormChanged();this.renderToVariantSelectors()}};crmSettingsForm.prototype.initAddNewFieldLink=
function(){function a(e){c.contains(document,d[0])?27===e.keyCode&&d.is(":visible")&&d.hide():c(document).off("keypress",a)}function b(e){if(c.contains(document,d[0])){var f=c.contains(d[0],e.target);e=d[0]===e.target;!d.is(":visible")||e||f||d.hide()}else c(document).off("keypress",b)}var d=this.$form_available_fields;this.$wrapper.on("click",".crm-add-new-field-link",function(e){e.stopPropagation();d.toggle()});c(document).on("keydown",a).on("click",b)};crmSettingsForm.prototype.initIButtons=function(){var a=
this;a.$wrapper.find("#js-ibutton").each(function(){if(c(this).data("iButtonInit"))return c(this);a.$switch=c(this).waSwitch({ready:function(b){var d=b.$wrapper.siblings("label");b.$label=d;b.active_text=d.data("active-text");b.inactive_text=d.data("inactive-text")},change:function(b,d){b?(a.$switch.has(a.$confirmation_checkbox).length&&(a.$email_confirm_block.slideDown(300),a.$confirmation_checkbox.attr("checked",!0)),d.$label.text(d.active_text)):(a.$switch.has(a.$confirmation_checkbox).length&&
(a.$email_confirm_block.slideUp(300),a.$confirmation_checkbox.attr("checked",!1)),d.$label.text(d.inactive_text))}})})};crmSettingsForm.prototype.disableIButton=function(){var a=this.$switch.waSwitch("switch");a.set(!1);a.disable(!0)};crmSettingsForm.prototype.enableIButton=function(){this.$switch.waSwitch("switch").disable(!1)};crmSettingsForm.prototype.initCopySmartyHelper=function(){this.$copy.on("click",function(){var a=c(this),b=a.data("content"),d=c("<input>");c("body").append(d);d.val(b).select();
document.execCommand("copy");d.remove();a.html('<i class="fas fa-check-circle"></i>');setTimeout(function(){a.html('<i class="fas fa-copy"></i>')},2E3)})};crmSettingsForm.prototype.initIframeTextarea=function(){var a=this;a.$iframe_textarea.click(function(){a.$iframe_textarea.select()})};crmSettingsForm.prototype.initCancelLink=function(){var a=this.referrer;this.$wrapper.on("click",".js-c-cancel-link",function(b){b.preventDefault();"settings/sources"==a?(c.crm.storage.set("crm/settings/source_tab",
"form"),c.crm.content.load(c.crm.app_url+"settings/sources/")):c.crm.content.load(c.crm.app_url+"settings/form/")})};crmSettingsForm.prototype.initBlocks=function(){var a=this.$wrapper,b=a.find(".js-deal-section");a=a.find(".js-responsible-section");b=b.data("block_object");a=a.data("block_object");b.setResponsibleBlock(a)};return crmSettingsForm}(jQuery);var crmSettingsFormFieldEditDialog=function(c){var a=function(b){var d=this,e=b.onClose;b.onClose=function(g,l){e&&e(g,l)};var f=b.onOpen;b.onOpen=function(g,l){f&&f(g,l);d.$wrapper=g;d.$form=d.$wrapper.find("form");d.$button=d.$form.find("[type=submit]");d.id=b.id;d.checked=b.checked;d.settingsForm=b.settingsForm;d.dialog=l;d.initClass()};c.waDialog(b)};a.prototype.initClass=function(){var b=this.dialog.$block,d=this.settingsForm.getField(this.id,this.checked);c.each(d,function(g,l){"id"===g?c(".crm-field-id",
b).find(".value").text(d.name+" (ID="+l+")"):"name"!==g&&(g=c(".crm-field-"+g,b).find(".value").find(":input"),g.is(":checkbox")?g.prop("checked",!!l):g.is(":radio")?g.filter('[value="'+l+'"]').prop("checked",!0):g.val(l))});var e=function(g){c(".crm-field-"+g,b).hide().find(":input").attr("disabled",!0)},f=function(g){c(".crm-field-"+g,b).show().find(":input").attr("disabled",!1)};"Checkbox"!==d.type?f("captionplace"):e("captionplace");d.placeholder_need?f("placeholder"):e("placeholder");d.placeholder_need&&
"password"===d.id?f("placeholder_confirm"):e("placeholder_confirm");d.required_always?e("required"):f("required");"!deal_description"==d.id?f("redactor"):e("redactor");this.bindEvents()};a.prototype.bindEvents=function(){var b=this,d=b.$form,e=b.settingsForm.getField(b.id,b.checked);d.submit(function(f){f.preventDefault();d.find(":input[name*=params]:not(:disabled)").each(function(){var g=c(this),l=g.attr("name").replace("params[","").replace("]",""),k=g.val();g.is(":checkbox")?e[l]=g.is(":checked")?
!0:!1:g.is(":radio")?g.is(":checked")&&(e[l]=k):e[l]=k});b.settingsForm.updateField(b.id,b.checked,e);b.settingsForm.renderField(b.id,b.checked);b.dialog.close()});b.$form.on("change","input,textarea,select",function(){b.setFormChanged()});b.$form.on("keyup","input:text,textarea",function(){b.setFormChanged()})};a.prototype.setFormChanged=function(){this.$button.addClass("yellow")};return a}(jQuery);var crmSettingsFormParagraphEditDialog=function(c){var a=function(b){var d=this,e=b.onClose;b.onClose=function(g,l){e&&e(g,l);c(".redactor-dropdown").remove()};var f=b.onOpen;b.onOpen=function(g,l){f&&f(g,l);d.$wrapper=g;d.$textarea=d.$wrapper.find(".crm-paragraph-textarea");d.$button=d.$wrapper.find("[type=button]");d.id=b.id;d.checked=b.checked;d.settingsForm=b.settingsForm;d.dialog=l;d.initClass()};new CRMDialog(b)};a.prototype.initClass=function(){var b=this.$textarea,d=this.settingsForm.getField(this.id,
this.checked);b.val(d&&d.text||"");this.initWYSIWYG();this.initSaveButton()};a.prototype.initWYSIWYG=function(){var b=this,d=b.$textarea,e=b.settingsForm.getField(b.id,b.checked);c.crm.initWYSIWYG(d,{focus:!0,changeCallback:function(){b.setFormChanged()}});d.val(e.text||"");d.redactor("code.set",e.text||"")};a.prototype.initSaveButton=function(){var b=this,d=b.$textarea;b.$button.click(function(e){e.preventDefault();b.settingsForm.updateField(b.id,b.checked,{text:d.val()});b.settingsForm.renderField(b.id,
b.checked);b.dialog.close()})};a.prototype.setFormChanged=function(){this.$button.removeClass("green").addClass("yellow")};return a}(jQuery);var crmSettingsFormAgreementCheckboxEditDialog=function(c){c=function(a){var b=this,d=a.onOpen;a.onOpen=function(e,f){d&&d(e,f);b.$wrapper=e;b.$html_label=b.$wrapper.find(".c-html-label-textarea-wrapper textarea");b.$field_id=b.$wrapper.find(".c-field-id .value");b.$checked_by_default=b.$wrapper.find(".c-field-checked-by-default :checkbox");b.$button=b.$wrapper.find("[type=button]");b.id=a.id;b.checked=a.checked;b.settingsForm=a.settingsForm;b.dialog=f;b.initClass()};new CRMDialog(a)};c.prototype.initClass=
function(){var a=this.getField();this.$field_id.text(a.name+" (ID="+a.id+")");this.initHtmlLabel();this.initDefaultChecked();this.initSaveButton()};c.prototype.initHtmlLabel=function(){var a=this,b=a.$html_label,d=a.getField(),e=function(){a.setFormChanged()};b.val(d.html_label);var f=null;b.on("keyup",function(){f&&clearTimeout(f);f=setTimeout(function(){e()},300)});b.on("change",e)};c.prototype.initDefaultChecked=function(){var a=this,b=a.getField(),d=a.$checked_by_default;d.attr("checked",!!b.default_checked);
d.on("change",function(){a.setFormChanged()})};c.prototype.getField=function(){var a=this.settingsForm.getField(this.id,this.checked);a.name=a.name||"";a.id=a.id||"";a.html_label=a.html_label||"";a.default_checked=a.default_checked&&"0"!==a.default_checked?1:0;a.html_label_default_href_placeholder=a.html_label_default_href_placeholder||"";return a};c.prototype.initSaveButton=function(){var a=this,b=a.$html_label,d=a.$checked_by_default;a.$button.click(function(e){e.preventDefault();e={html_label:b.val(),
default_checked:d.is(":checked")?1:0};a.settingsForm.updateField(a.id,a.checked,e);a.renderField();a.dialog.close()})};c.prototype.renderField=function(){var a=this.id,b=this.checked,d=this.getField(a,b),e=this.settingsForm.$form_fields,f=e.find('.crm-form-field:not(.crm-form-field-template)[data-id="'+a+'"][data-checked="'+b+'"]');d?(f.length||(f=e.find('.crm-form-field-template.crm-form-field-template[data-id="'+a+'"]').clone(),f.removeClass("crm-form-field-template"),f.attr("data-checked",b),f.insertBefore(e.find(".crm-form-field-template:first")),
f.show()),a=d.html_label,a=a.replace(d.html_label_default_href_placeholder,"javascript:void(0)"),f.find(".c-agreement-checkbox-html-label").html(a),f.find(":checkbox").attr("checked",!!d.default_checked)):f.remove()};c.prototype.setFormChanged=function(){this.$button.removeClass("green").addClass("yellow")};return c}(jQuery);var CRMSettingsGeneral=function(c){CRMSettingsGeneral=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.initClass()};CRMSettingsGeneral.prototype.initClass=function(){this.initFooterToggle();this.initSubmit()};CRMSettingsGeneral.prototype.initSubmit=function(){var a=this.$form,b=a.find(".js-submit-button:first");a.submit(function(d){d.preventDefault();var e=b.text();b.empty();b.html(e+' <i class="fas fa-spinner fa-spin"></i>');c.post(a.attr("action"),a.serialize(),function(f){"ok"===
f.status&&(b.empty().html(e+' <i class="fas fa-check-circle"></i>'),c.crm.content.reload())})})};CRMSettingsGeneral.prototype.initFooterToggle=function(){var a=this.$wrapper.find(".js-footer-actions"),b=a.find(".js-submit-button");this.$wrapper.on("change keydown","input, textarea, select",function(){b.addClass("yellow");a.addClass("is-changed")})};return CRMSettingsGeneral}(jQuery);var CRMSettingsPersonal=function(c){CRMSettingsPersonal=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.initClass()};CRMSettingsPersonal.prototype.initClass=function(){this.initFooterToggle();this.initSubmit()};CRMSettingsPersonal.prototype.initSubmit=function(){var a=this.$wrapper.find(".c-reminder-settings-wrapper").data("instance"),b=this.$form,d=b.find(".js-submit-button:first");b.submit(function(e){e.preventDefault();var f=d.text();d.empty();d.html(f+' <i class="fas fa-spinner fa-spin"></i>');
a&&!1===a.validateBeforeSave()?d.empty().html(f):c.post(b.attr("action"),b.serialize(),function(g){"ok"===g.status&&(d.empty().html(f+' <i class="fas fa-check-circle"></i>'),c.crm.content.reload())})})};CRMSettingsPersonal.prototype.initFooterToggle=function(){var a=this.$wrapper.find(".js-footer-actions"),b=a.find(".js-submit-button");this.$wrapper.on("change keydown","input, textarea, select",function(){b.addClass("yellow");a.addClass("is-changed")})};return CRMSettingsPersonal}(jQuery);var CRMNotificationEdit=function(c){CRMNotificationEdit=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$footer=this.$wrapper.find(".js-footer-actions");this.messages=a.messages||{};this.messages.enable=this.messages.enable||"";this.messages.disable=this.messages.disable||"";this.$name=this.$wrapper.find(".js-notification-name");this.$subject=this.$wrapper.find(".js-notification-subject");this.$emailBody=this.$wrapper.find(".js-email-body");this.$smsBody=this.$wrapper.find(".js-sms-body");
this.$recipient=this.$wrapper.find(".js-recipient-list");this.$sender=this.$wrapper.find(".js-sender-list");this.$sender_block=this.$wrapper.find(".js-senders-block");this.$sms_sender=this.$wrapper.find(".js-sms-sender-list");this.$sms_sender_block=this.$wrapper.find(".js-sms-senders-block");this.notifications=a.notifications;this.locales=a.locales;this.notification_id=(this.notification=a.notification||{},this.notification.id);this.notification_event=this.notification&&this.notification.event;this.site_app_url=
a.site_app_url;this.recipients=a.recipients;this.sender=a.sender.split("|",2);this.user_data=a.user_data;this.dialog_template=a.dialog_template;this.success_html=a.success_html;this.transport="";this.initClass()};CRMNotificationEdit.prototype.initClass=function(){0>=this.notification.id&&this.initTransport();this.initRecipient();this.initBody();this.notification_id||this.initChangeEvent();this.initSubmit();this.initDelete();this.initFooterActions();this.initHelp();this.initSender();this.initSendTest()};
CRMNotificationEdit.prototype.initSendTest=function(){var a=this,b=!1,d=null;a.$wrapper.on("click",".js-send-test",function(e){e.preventDefault();c(document).trigger("updateEditorTextarea");c.waDialog.confirm({title:a.locales.send_confirm_title,text:function(){var f=c(a.dialog_template);d="sms"==a.$wrapper.find(".js-transport-toggle").filter(":checked").first().val()?a.user_data.phone:a.user_data.email;f.find(".js-user-contact").attr("value",d);return f["0"].outerHTML}(),success_button_title:a.locales.send_confirm_button,
success_button_class:"warning",cancel_button_title:a.locales.delete_cancel_button,cancel_button_class:"light-gray",onSuccess:function(f){b||(b=!0,f=a.$form.serializeArray(),f.push({name:"data[contact]",value:c(".dialog").find(".js-user-contact").val()}),c.post("?module=settingsNotifications&action=SendTest",f,function(g){"ok"===g.status&&(c.waDialog.alert({text:a.locales.success_text,button_title:a.locales.close_button,button_class:"light-gray"}),setTimeout(function(){c.contains(document,c(".dialog")[0])&&
c(".dialog").remove()},1E4))},"json").always(function(){b=!1}));return!1}})})};CRMNotificationEdit.prototype.initSender=function(){function a(){return k&&0<k.id?k.transport||"email":h.filter(":checked").first().val()}function b(){"email"===a()?(d("specified"===l.$sender.val()),g()):(f("specified"===l.$sms_sender.val()),e())}function d(n){var m=l.$sender_block.find(".js-specified-sender-name"),p=l.$sender_block.find(".js-specified-sender-email");l.$sender_block.show();l.$sender.attr("disabled",!1);
n?(m.attr("disabled",!1).show(),p.attr("disabled",!1).show(),"system"!==l.sender[0]&&(p.val(l.sender[0]),m.val(l.sender[1]))):(m.attr("disabled",!0).hide(),p.attr("disabled",!0).hide())}function e(){l.$sender_block.hide();l.$sender.attr("disabled",!0);l.$sender_block.find(".js-specified-sender-name").attr("disabled",!0).hide();l.$sender_block.find(".js-specified-sender-email").attr("disabled",!0).hide()}function f(n){var m=l.$sms_sender_block.find(".js-specified-sms-sender");l.$sms_sender_block.show();
l.$sms_sender.attr("disabled",!1);n?(m.attr("disabled",!1).show(),"system"!==l.sender[0]&&m.val(l.sender[0])):m.attr("disabled",!0).hide()}function g(){l.$sms_sender_block.hide();l.$sms_sender.attr("disabled",!0);l.$sms_sender_block.find(".js-specified-sms-sender").attr("disabled",!0).hide()}var l=this,k=l.notification,h=l.$wrapper.find(".js-transport-toggle");"email"===a()?(d("specified"===l.$sender.val()),g()):(f("specified"===l.$sms_sender.val()),e());h.on("change",b);l.$sender.on("change",b);
l.$sms_sender.on("change",b)};CRMNotificationEdit.prototype.initRecipient=function(){function a(){b(d.$recipient.val())}function b(k){var h=l.filter(":checked").first().val();!h&&0<d.notification.id&&(h=d.notification.transport);h=d.$wrapper.find('.c-recipient-content[data-id="'+h+'"]');d.$wrapper.find(".c-recipient-content").hide().attr("disabled",!0);"other"===k?(h.show(),h.attr("disabled",!1)):h.hide()}var d=this,e=d.notification.recipient,f=d.recipients,g=d.$recipient,l=d.$wrapper.find(".js-transport-toggle");
g.on("change",a);l.on("change",a);f[e]||(d.$recipient.val("other"),b("other"),d.$wrapper.find('.c-recipient-content[data-id="'+l.filter(":checked").first().val()+'"]').val(e))};CRMNotificationEdit.prototype.initChangeEvent=function(){var a=this,b=a.$wrapper.find(".js-event-toggle"),d=a.$wrapper.find(".js-event-company"),e=a.$wrapper.find(".js-fields-group");b.on("change",function(){var f=c.trim(c(this).val());a.notification_event=f;var g=a.notifications[f];g&&(a.$name.val(g.name),a.$subject.val(g.subject),
a.$emailBody.val(g.body).trigger("editorDataUpdated"),a.$smsBody.val(g.sms).trigger("editorDataUpdated"),g.recipient?a.$recipient.val(g.recipient):a.$recipient.val("client"));"invoice."===f.substr(0,8)?d.removeAttr("disabled").show():d.attr("disabled",!0).hide();e.show()})};CRMNotificationEdit.prototype.initTransport=function(){function a(f){f=f.val();b.transport=f;f=b.$wrapper.find('.c-transport-content[data-id="'+f+'"]');e?(e.removeClass("is-active"),e.find("input, textarea").attr("disabled",!0)):
b.$wrapper.find(".c-transport-content").find("input, textarea").attr("disabled",!0);f.find("input, textarea").attr("disabled",!1);e=f.addClass("is-active")}var b=this,d=b.$wrapper.find(".js-transport-toggle"),e=!1;a(d.filter(":checked").first());d.on("change",function(){a(c(this));b.$emailBody.trigger("editorDataUpdated");b.$smsBody.trigger("editorDataUpdated")})};CRMNotificationEdit.prototype.initBody=function(){this.$wrapper.find(".js-redactor-wrapper").each(function(a){var b=c(this),d=b.find("textarea"),
e=c('<div class="js-redactor" />'),f="js-textarea-"+a;a="js-redactor-"+a;e.attr("id",a).appendTo(b);d.attr("id",f);waEditorAceInit({id:f,ace_editor_container:a});"undefined"!==typeof wa_editor&&e.data("wa_editor",wa_editor);d.data("wa_editor",e.data("wa_editor"));d.on("editorDataUpdated",function(){var g=e.data("wa_editor");g&&g.getSession().setValue(d.val())});c(document).on("updateEditorTextarea",function(){var g=e.data("wa_editor");g&&(g=g.getValue(),d.val(g).trigger("change"))})})};CRMNotificationEdit.prototype.initSubmit=
function(){function a(){var l={data:[],errors:[]},k=f.serializeArray();c.each(k,function(h,n){l.data.push(n)});return l}function b(l,k){k=k?k:[];if(l){var h=Object.keys(l);c.each(h,function(n,m){k.push({name:m,value:l[m]})})}c.each(k,function(n,m){n=m.value;var p=e.$form.find('[name="'+m.name+'"]');if(p.length&&!p.hasClass("error")){var q=c("<span />").addClass("errormsg").text(n);e.$wrapper.append(q);p.addClass("error").one("focus click change",function(){p.removeClass("error");q.remove()})}})}function d(l){if(!g){g=
!0;var k=c(e.locales.saving);e.$footer.append(k);c.post("?module=settings&action=notificationsEditSave",l,"json").done(function(h){if("ok"!==h.status)b(h.errors||{});else if(0>=e.notification_id)c.crm.content.load(c.crm.app_url+"settings/notifications/edit/"+h.data.notification.id+"/");else{var n=c(e.locales.saved);e.$footer.append(n);setTimeout(function(){c.contains(document,n[0])&&n.remove()},2E3);c(document).trigger("formIsSaved")}}).always(function(){k.remove();g=!1})}}var e=this,f=e.$form,g=
!1;f.on("submit",function(l){l.preventDefault();c(document).trigger("updateEditorTextarea");l=a();l.errors.length?b(!1,l.errors):d(l.data)})};CRMNotificationEdit.prototype.initDelete=function(){var a=this,b=!1;a.$wrapper.on("click",".js-remove-notification",function(d){d.preventDefault();c.waDialog.confirm({title:'<i class="fas fa-exclamation-triangle smaller state-error"></i> '+a.locales.delete_confirm_title,text:a.locales.delete_confirm_text,success_button_title:a.locales.delete_confirm_button,
success_button_class:"danger",cancel_button_title:a.locales.delete_cancel_button,cancel_button_class:"light-gray",onSuccess:function(e){b||(b=!0,c.post("?module=settings&action=notificationsDelete",{id:a.notification_id},function(f){"ok"===f.status&&c.crm.content.load(c.crm.app_url+"settings/notifications/")}).always(function(){b=!1;e.close()}));return!1}})})};CRMNotificationEdit.prototype.initFooterActions=function(){function a(d){d?b.removeClass("yellow"):b.addClass("yellow")}var b=this.$footer.find(".js-submit-button");
this.$wrapper.on("change","input, textarea, select",function(){a()});c(document).on("formIsSaved",function(){a(!0)})};CRMNotificationEdit.prototype.initHelp=function(){function a(g){e.drawerWrapper=c(".drawer");e.drawerContent=e.drawerWrapper.find(".drawer-content");g?(e.drawerWrapper.on("click","ul.tabs li",b),e.drawerWrapper.on("click",".wa-help-vars-item",d),e.drawerWrapper.on("click",".drawer-background",function(){return e.drawer.hide()})):(e.drawerWrapper.off("click"),f=!1)}function b(g){g.preventDefault();
if(c(this).hasClass("selected"))return!1;g=c(this).attr("id")+"-content";c(this).addClass("selected").siblings().removeClass("selected");g=e.drawerContent.find("#"+g);g.siblings().hide();g.show()}function d(g){g.preventDefault();$body=e.$emailBody;"sms"===e.transport&&($body=e.$smsBody);if(g=$body.data("wa_editor"))g.insert(c.trim(c(this).find(".js-var").text())),e.drawer.hide()}var e=this,f=!1;c("#wa-editor-help-link").on("click",function(g){g.preventDefault();g=c.crm.app_url+"?module=settings&action=help";
var l="app=crm&key=notification."+e.notification_event;if(f)return e.drawer.show(),!1;e.drawer=c.waDrawer({html:'<div class="drawer crm-help" id=""> <div class="drawer-background"></div> <div class="drawer-body"> <a href="#" class="drawer-close js-close-drawer"><i class="fas fa-times"></i></a> <div class="drawer-block"><div class="flexbox middle width-100 height-100 spinner-wrapper"><div class="spinner custom-p-16"></div></div></div> </div> </div> ',direction:"right",onClose:function(){return a(!1)}});
c.get(g,l,function(k){c(".drawer .drawer-block").html(k);a(!0);f=!0},"html")})};return CRMNotificationEdit}(jQuery),CRMNotificationStatus=function(c){CRMNotificationStatus=function(a){this.$wrapper=a.$wrapper;this.messages=a.messages||{};this.messages.enable=this.messages.enable||"";this.messages.disable=this.messages.disable||"";this.notifications=a.notifications;this.initDisableLinks()};CRMNotificationStatus.prototype.initDisableLinks=function(){var a=this.$wrapper.find(".js-c-disable-link"),b=
null,d=c.crm.app_url+"?module=settingsNotifications&action=status";a.each(function(){var e=c(this),f=e.closest(".c-notification"),g=f.data("id"),l=f.find(".c-loading");e.find("#switch-"+g).waSwitch({ready:function(k){var h=k.$wrapper.siblings("label");k.$label=h;k.active_text=h.data("active-text");k.inactive_text=h.data("inactive-text")},change:function(k,h){l.show();h.disable(!0);b&&b.abort();b=c.post(d,{id:g,status:k?0:1}).done(function(n){"ok"===n.status&&(k?(h.$label.text(h.inactive_text),f.removeClass("c-is-disabled")):
(h.$label.text(h.active_text),f.addClass("c-is-disabled")),h.disable(!1))}).always(function(){b=null;l.hide()})}})})};return CRMNotificationStatus}(jQuery);var CRMSettingsPayments=function(c){CRMSettingsPayments=function(a){this.$wrapper=a.$wrapper;this.$dropdown=this.$wrapper.find(".dropdown");this.$pluginsDropdown=this.$wrapper.find(".js-plugins-dropdown");this.$table=this.$wrapper.find(".js-payments-table");this.company_id=a.company_id;this.locales=a.locales;this.initClass()};CRMSettingsPayments.prototype.initClass=function(){this.initTabs();this.initDelete();this.initSortable();this.initDropDown();var a=this.$wrapper.find(".c-payments-list");(new MutationObserver(function(b){a.trigger("refresh")})).observe(a[0],
{childList:!0,attributes:!0,subtree:!0})};CRMSettingsPayments.prototype.initTabs=function(){var a=this.$wrapper.find(".c-tabs-wrapper"),b=this.$wrapper.find(".c-companies-wrapper"),d=b.find(".c-companies-list"),e=d.find(".c-company.selected");(function(){function f(){c.contains(document,a[0])?g():l.off("resize refresh",f)}function g(){var h=a.outerWidth(!0)-k-38;b.css("max-width",h+"px")}var l=c(window),k=a.find(".c-add-wrapper").outerWidth();g();l.on("resize refresh",f)})();c.crm.tabSlider({$wrapper:b,
$slider:d,$activeSlide:e.length?e:!1})};CRMSettingsPayments.prototype.initDropDown=function(){this.$dropdown.waDropdown()};CRMSettingsPayments.prototype.initDelete=function(){var a=this,b=!1;a.$wrapper.on("click",".js-delete-payment",function(d){d.preventDefault();d=c(this);var e=d.closest("tr"),f=d.data("payment-id"),g=d.data("plugin");(function(){c.waDialog.confirm({title:'<i class="fas fa-exclamation-triangle smaller state-error"></i> '+a.locales.confirm_delete_title.replace("%payment",e.find(".js-name").text()),
text:a.locales.confirm_delete_text,success_button_title:a.locales.confirm_delete_button,success_button_class:"danger",cancel_button_title:a.locales.confirm_cancel_button,cancel_button_class:"light-gray",onSuccess:function(){b||(b=!0,c.post("?module=settings&action=paymentDelete",{id:f,company_id:a.company_id},function(l){"ok"==l.status&&(e.remove(),l=a.$pluginsDropdown.find('li[data-plugin="'+g+'"]'),l.length&&l.show())}).always(function(){b=!1}))}})})()})};CRMSettingsPayments.prototype.initSortable=
function(){function a(){var e={ids:function(){var f=[];b.$table.find("tr").each(function(){f.push(c(this).data("id"))});return f}(),company_id:b.company_id};d&&d.abort();d=c.post("?module=settings&action=paymentSort",e,function(f){}).always(function(){d=!1})}var b=this,d=!1;b.$table.find("tbody").sortable({distance:10,handle:".js-sort-toggle",helper:"clone",items:"> .payments-table-row",axis:"y",stop:a,onUpdate:a})};return CRMSettingsPayments}(jQuery),CRMPaymentEdit=function(c){CRMPaymentEdit=function(a){this.$wrapper=
a.$wrapper;this.$form=this.$wrapper.find("form");this.$footer=this.$wrapper.find(".js-footer");this.instance_id=a.instance_id;this.company_id=a.company_id;this.locales=a.locales;this.initClass()};CRMPaymentEdit.prototype.initClass=function(){this.initSubmit();this.initDelete()};CRMPaymentEdit.prototype.initSubmit=function(){function a(g){if(!e){e=!0;var l=c(d.locales.saving);d.$footer.append(l);c.post("?module=settings&action=paymentSave",g,function(k){if("ok"==k.status)if(l.remove(),d.instance_id){var h=
c(d.locales.saved);d.$footer.append(h);setTimeout(function(){c.contains(document,h[0])&&h.remove()},2E3)}else c.crm.content.load(c.crm.app_url+"settings/payment/?company="+d.company_id)}).always(function(){e=!1})}}function b(g,l){g=g?g:[];if(l){var k=Object.keys(l);c.each(k,function(h,n){g.push({name:n,value:l[n]})})}c.each(g,function(h,n){h=n.value;var m=d.$wrapper.find('[name="'+n.name+'"]');if(m.length&&!m.hasClass("error")){var p=c("<span />").addClass("errormsg").text(h);p.insertAfter(m);m.addClass("error").one("focus click",
function(){m.removeClass("error");p.remove()})}})}var d=this,e=!1,f=d.$form;f.on("submit",function(g){g.preventDefault();g=f.serializeArray();var l=[];l.length?b(l):a(g)})};CRMPaymentEdit.prototype.initDelete=function(){var a=this,b=!1;a.$wrapper.on("click",".js-delete-payment",function(d){function e(){b||(b=!0,c.post("?module=settings&action=paymentDelete",{id:a.instance_id,company_id:a.company_id},function(f){"ok"==f.status&&c.crm.content.load(c.crm.app_url+"settings/payment/?company="+a.company_id)}).always(function(){b=
!1}))}d.preventDefault();b||(b=!0,c.waDialog.confirm({title:'<i class="fas fa-exclamation-triangle smaller state-error"></i> '+a.locales.confirm_delete_title,text:a.locales.confirm_delete_text,success_button_title:a.locales.confirm_delete_button,success_button_class:"danger",cancel_button_title:a.locales.confirm_cancel_button,cancel_button_class:"light-gray",onSuccess:e}));b=!1})};return CRMPaymentEdit}(jQuery);var CRMReasonsPage=function(c){CRMReasonsPage=function(a){this.$wrapper=a.$wrapper;this.$reasonsList=this.$wrapper.find(".js-reasons-list");this.$footer=this.$wrapper.find(".js-footer-actions");this.$form=this.$wrapper.find("form");this.$freeField=this.$wrapper.find(".js-free-field");this.$submitButton=this.$wrapper.find(".js-submit-button");this.$hiddenActions=this.$footer.find(".js-hidden-actions");this.reason_template_html=a.reason_template_html;this.locales=a.locales;this.is_changed=!1;this.initClass()};
CRMReasonsPage.prototype.initClass=function(){var a=this;a.initSortable();a.initAddReason();a.initRemoveReason();a.initSubmit();a.$form.on("input change",function(){a.toggleButton(!0)})};CRMReasonsPage.prototype.initSortable=function(){var a=this;a.$reasonsList.sortable({distance:10,handle:".js-sort-toggle",helper:"clone",items:"> li",axis:"y",change:function(){a.toggleButton(!0)}})};CRMReasonsPage.prototype.initRemoveReason=function(){var a=this;a.$wrapper.on("click",".js-delete-reason",function(b){b.preventDefault();
c(this).closest(".c-reason").remove();a.$reasonsList.find(".c-reason").length||a.$freeField.attr("checked",!0).attr("disabled",!0);a.toggleButton(!0)})};CRMReasonsPage.prototype.initAddReason=function(){var a=this;a.$wrapper.on("click",".js-add-reason",function(b){b.preventDefault();b=c(a.reason_template_html);a.$reasonsList.append(b);a.$freeField.attr("disabled",!1);a.toggleButton(!0)})};CRMReasonsPage.prototype.initSubmit=function(){function a(f){if(!e){e=!0;var g=c(d.locales.saving);d.$submitButton.append(g);
f=b(f);c.post("?module=settings&action=lostReasonsSave",f,function(l){if("ok"==l.status){g.remove();var k=c(d.locales.saved);d.$submitButton.append(k);d.toggleButton(!1);setTimeout(function(){c.contains(document,k[0])&&k.remove()},2E3)}}).always(function(){e=!1})}}function b(f){var g=f.serializeArray();d.$freeField.is(":disabled")&&(d.$freeField.attr("disabled",!1),g=f.serializeArray(),d.$freeField.attr("disabled",!0));(function(l){d.$reasonsList.find(".c-reason").each(function(k){var h=c(this),n=
h.data("id"),m=h.find(".js-name-field").val();h=h.find(".js-funnel-id-field").val();m&&(n&&l.push({name:"reasons["+k+"][id]",value:n}),l.push({name:"reasons["+k+"][name]",value:m}),l.push({name:"reasons["+k+"][funnel_id]",value:h}))})})(g);return g}var d=this,e=!1;d.$form.on("submit",function(f){f.preventDefault();a(c(this))})};CRMReasonsPage.prototype.toggleButton=function(a){var b=this.$submitButton,d=this.$hiddenActions;a?(b.addClass("yellow"),d.show()):(b.removeClass("yellow"),d.hide())};return CRMReasonsPage}(jQuery);var CRMSettingsVaults=function(c){CRMSettingsVaults=function(a){this.$wrapper=a.$wrapper;this.$list=this.$wrapper.find(".js-vaults-list");this.locales=a.locales;this.vault_template_html=a.vault_template_html;this.initClass()};CRMSettingsVaults.prototype.initClass=function(){this.initEdit();this.initSort()};CRMSettingsVaults.prototype.initEdit=function(){function a(e,f){d&&d.abort();d=c.post("?module=settings&action=vaultDialog",{id:e?e:""},function(g){c.waDialog({html:g,options:{onSave:function(l,
k,h){f&&f.length||(f=c(b.vault_template_html),f.data("id",l).appendTo(b.$list));f.find(".js-name").text(k);f.find(".js-color").css("background-color",h)},onDelete:function(){f.remove()}}})}).always(function(){d=!1})}var b=this,d=!1;b.$wrapper.on("click",".js-vault-edit",function(){var e=c(this).closest(".c-vault-item"),f=e.data("id");a(f,e)});b.$wrapper.on("click",".js-vault-add",function(){a()})};CRMSettingsVaults.prototype.initSort=function(){function a(f,g){var l=f.item?c(f.item):c(g.item);e&&
e.abort();f={vaults:b()};var k=c(d.locales.saving);k.appendTo(l);e=c.post("?module=settings&action=vaultsSave",f,function(h){if("ok"==h.status){var n=c(d.locales.saved);n.appendTo(l);setTimeout(function(){c.contains(document,n[0])&&n.remove()},2E3)}}).always(function(){k.remove();e=!1})}function b(){var f=[];d.$list.find(".c-vault-item").each(function(){var g=c(this).data("id");g&&f.push(g)});return f}var d=this,e=!1;d.$list.sortable({distance:10,handle:".js-sort-toggle",helper:"clone",items:"> .c-vault-item",
axis:"y",stop:a,onUpdate:a})};return CRMSettingsVaults}(jQuery),CRMVaultEdit=function(c){CRMVaultEdit=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.locales=a.locales;this.count=a.count;this.vault_id=a.vault_id;this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMVaultEdit.prototype.initClass=function(){this.initDelete();this.initSave();this.initColorPicker();this.initNoAccessList()};CRMVaultEdit.prototype.initDelete=function(){function a(d,e){c.post("?module=settings&action=vaultDialogDelete",
{id:d},function(f){"ok"===f.status&&e&&"function"===typeof e&&e()})}var b=this;b.$wrapper.on("click",".js-vault-delete",function(d){d.preventDefault();var e=b.vault_id;c.waDialog.confirm({title:'<i class="fas fa-exclamation-triangle smaller state-error"></i> '+b.locales.confirm_delete_title+"?",text:b.locales.confirm_delete_text,success_button_title:""+b.locales.confirm_delete_button,success_button_class:"danger",cancel_button_title:""+b.locales.confirm_cancel_button,cancel_button_class:"light-gray",
onSuccess:function(){a(e,function(){b.dialog.options.onDelete();b.dialog.close()})}})})};CRMVaultEdit.prototype.initSave=function(){function a(){var h={data:[],errors:[]},n=f.serializeArray();c.each(n,function(m,p){"data[name]"===p.name&&(l=p.value);"data[color]"===p.name&&(k=p.value);h.data.push(p)});return h}function b(h,n){n=n?n:[];if(h){var m=Object.keys(h);c.each(m,function(p,q){n.push({name:q,value:h[q]})})}c.each(n,function(p,q){p=q.value;var r=e.$form.find('[name="'+q.name+'"]');if(r.length&&
!r.hasClass("error")){var u=c("<span />").addClass("errormsg").text(p);e.$wrapper.append(u);r.addClass("error").one("focus click change",function(){r.removeClass("error");u.remove()})}})}function d(h){g||(g=!0,c.post("?module=settings&action=vaultDialogSave",h,function(n){"ok"===n.status?(console.log(e.dialog),e.dialog.options.onSave(n.data.id,l,k),e.dialog.close()):n.errors&&b(n.errors)},"json").always(function(){g=!1}))}var e=this,f=e.$form,g=!1,l="",k="#aaa";f.on("submit",function(h){h.preventDefault();
h=a();h.errors.length?b(!1,h.errors):d(h.data)})};CRMVaultEdit.prototype.initColorPicker=function(){var a=function(b){a=function(d){this.$wrapper=d.$wrapper;this.$field=d.$field;this.$icon=d.$icon;this.$colorPicker=d.$colorPicker;this.farbtastic=this.is_opened=!1;this.initClass()};a.prototype.initClass=function(){var d=this;d.farbtastic=b.farbtastic(d.$colorPicker,function(e){d.$field.val(e).change()});d.$wrapper.data("colorPicker",d);d.bindEvents()};a.prototype.bindEvents=function(){var d=this;d.$icon.on("click",
function(e){e.preventDefault();e.stopPropagation();d.displayToggle(!d.is_opened)});d.$colorPicker.on("click",function(e){e.stopPropagation()});d.$field.on("click",function(e){e.stopPropagation()});d.$field.on("focus",function(){d.is_opened||d.displayToggle(!0)});d.$field.on("change keyup",function(){var e=b(this).val();d.$icon.css("background-color",e);d.farbtastic.setColor(e)});b(document).on("click",function(){d.displayToggle(!1)});b(document).on("colorPickerIsOpened",function(){d.is_opened&&d.displayToggle(!1)})};
a.prototype.displayToggle=function(d){var e=this.$colorPicker;d?(b(document).trigger("colorPickerIsOpened",this),e.addClass("is-shown"),this.is_opened=!0):(b(document).trigger("colorPickerIsClosed",this),e.removeClass("is-shown"),this.is_opened=!1)};return a}(jQuery);this.$wrapper.find(".js-color-toggle").each(function(){var b=c(this);new a({$wrapper:b,$field:b.find(".js-field"),$icon:b.find(".js-toggle"),$colorPicker:b.find(".js-color-picker")})})};CRMVaultEdit.prototype.initNoAccessList=function(){var a=
this,b=a.$wrapper.find(".js-no-access-wrapper");b.on("click",".js-show-access-list",function(d){d.preventDefault();b.addClass("is-active");a.dialog.resize()});b.on("click",".js-hide-access-list",function(d){d.preventDefault();b.removeClass("is-active");a.dialog.resize()})};return CRMVaultEdit}(jQuery);var CRMSettingsMessagesBlock=function(c){CRMSettingsMessagesBlock=function(a){this.$wrapper=a.$wrapper;this.namespace=a.namespace||"";this.type=a.type||"form";this.initClass()};CRMSettingsMessagesBlock.prototype.initClass=function(){var a=this,b=a.$wrapper,d=a.namespace,e=c.crm.app_url+"?module=settings&action=emailTemplateEditor";a.renderCheckboxLabel();b.on("click",".js-crm-add-message-checkbox",function(){var f=c(this),g=b.find(".crm-template").clone();g.removeClass("crm-template");b.find(".crm-one-message:last").after(g.show());
var l=b.find(".crm-editor-wrapper[data-i]").last().data("i");l?l=parseInt(l+"",10):0!==l&&(l=-1);var k=l+1;g.find(".crm-editor-wrapper").data("i",""+k).attr("data-i",""+k);c.post(e,{input_name:d+"["+k+"][tmpl]",to_name:d+"["+k+"][to]",sourcefrom_name:d+"["+k+"][sourcefrom]",add_attachments_name:d+"["+k+"][add_attachments]",type:a.type},function(h){g.find(".crm-editor-wrapper").html(h);b.trigger("loadEditor",[k,g])});a.renderCheckboxLabel();f.prop("checked",!1)});b.on("click",".js-crm-remove-message-checkbox",
function(){c(this).closest(".crm-one-message").remove();a.renderCheckboxLabel()})};CRMSettingsMessagesBlock.prototype.renderCheckboxLabel=function(){var a=this.$wrapper;0<a.find(".crm-one-message:not(.crm-template)").length?(a.find(".js-crm-when-no-messages").hide(),a.find(".js-crm-when-messages").show()):(a.find(".js-crm-when-no-messages").show(),a.find(".js-crm-when-messages").hide())};return CRMSettingsMessagesBlock}(jQuery);var CRMSettingsShop=function(c){CRMSettingsShop=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$button=this.$form.find("[type=submit]");this.source=a.source||{};this.messages=a.messages||{};this.submit_xhr=null;this.initClass()};CRMSettingsShop.prototype.initClass=function(){this.initToggle();this.initSubmit();this.initStoreToggle();this.initFooterToggle()};CRMSettingsShop.prototype.initToggle=function(){c("#toggle-menu").waToggle()};CRMSettingsShop.prototype.initStoreToggle=
function(){this.$wrapper.find(".js-ibutton-wrapper").each(function(){var a=c(this).find("#c-storefront-switch");a.waSwitch({ready:function(b){var d=b.$wrapper.siblings("label");b.$label=d;b.active_text=d.data("active-text");b.inactive_text=d.data("inactive-text")},change:function(b,d){var e=a.closest(".c-storefront").find(".c-storefront-params-block");b?(d.$label.text(d.active_text),e.slideDown(300)):(d.$label.text(d.inactive_text),e.slideUp(300))}})})};CRMSettingsShop.prototype.initSubmit=function(){var a=
this,b=a.$form,d=a.$button,e=b.find(".c-loading"),f=b.attr("action");b.submit(function(g){g.preventDefault();e.show();d.attr("disabled",!0);a.submit_xhr&&a.submit_xhr.abort();a.submit_xhr=c.post(f,b.serialize()).done(function(){c.crm.content.load(c.crm.app_url+"settings/shop/")}).always(function(){d.attr("disabled",!1);e.hide()})})};CRMSettingsShop.prototype.initFooterToggle=function(){var a=this.$wrapper.find(".js-footer-actions"),b=a.find(".js-submit-button");this.$wrapper.on("change keydown","input, textarea, select",
function(){b.addClass("yellow");a.addClass("is-changed")})};return CRMSettingsShop}(jQuery),CRMSettingsShopWorkflowPage=function(c){CRMSettingsShopWorkflowPage=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form").first();this.initClass()};CRMSettingsShopWorkflowPage.prototype.initClass=function(){c.crm.renderSVG(this.$wrapper);this.initToggle();this.initTabs();this.initFooterToggle();this.initSubmit()};CRMSettingsShopWorkflowPage.prototype.initToggle=function(){c("#toggle-menu").waToggle()};
CRMSettingsShopWorkflowPage.prototype.initTabs=function(){var a=this.$wrapper.find(".js-funnels-tabs"),b=this.$wrapper.find(".c-funnels-wrapper"),d=b.find(".c-funnels-list"),e=d.find(".c-funnel.selected");(function(){function f(){c.contains(document,a[0])?g():l.off("resize",f)}function g(){var k=a.width();b.css("max-width",k+"px")}var l=c(window);g();l.on("resize",f)})();c.crm.tabSlider({$wrapper:b,$slider:d,$activeSlide:e.length?e:!1})};CRMSettingsShopWorkflowPage.prototype.initFooterToggle=function(){var a=
this.$wrapper.find(".js-footer-actions"),b=a.find(".js-submit-button");this.$wrapper.on("change keydown","input, textarea, select",function(){b.addClass("yellow");a.addClass("is-changed")})};CRMSettingsShopWorkflowPage.prototype.initSubmit=function(){function a(){var k={data:[],errors:[]},h=f.serializeArray();c.each(h,function(n,m){k.data.push(m)});return k}function b(k){k&&k[0]||(k=[]);c.each(k,function(h,n){h=n.value;var m=e.$wrapper.find('[name="'+n.name+'"]'),p=c("<span class='c-error' />").addClass("errormsg").text(h);
m.length&&!m.hasClass("error")?(m.parent().append(p),m.addClass("error").one("focus click change",function(){m.removeClass("error");p.remove()})):(g.append(p),f.one("submit",function(){p.remove()}))})}function d(k){if(!l){l=!0;var h=c.crm.app_url+"?module=settings&action=shopWorkflowSave",n=e.$form.find(".c-loading");n.show();c.post(h,k,function(m){"ok"===m.status?c.crm.content.reload():b(m.errors)},"json").always(function(){l=!1;n.hide()})}}var e=this,f=e.$form,g=e.$wrapper.find(".js-errors-place"),
l=!1;f.on("submit",function(k){k.preventDefault();k=a();k.errors.length?b(k.errors):d(k.data)})};return CRMSettingsShopWorkflowPage}(jQuery);var CRMSettingsPbxPage=function(c){CRMSettingsPbxPage=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.locales=a.locales;this.user_template_html=a.user_template_html;this.initClass()};CRMSettingsPbxPage.prototype.initClass=function(){var a=this;a.$wrapper.find(".c-pair-wrapper").each(function(){a.initPair(c(this))})};CRMSettingsPbxPage.prototype.initPair=function(a){function b(l){c.each(l,function(k,h){c.waDialog.alert({title:d.locales.dialog_error_title,text:h,button_title:d.locales.dialog_error_button,
button_class:"warning"});setTimeout(function(){c(".js-dialog-close").click()},5E3)})}var d=this,e=a.data("plugin-id"),f=a.data("number"),g=!1;a.on("click",".js-user-delete",function(l){l.preventDefault();var k=c(this).closest(".c-user-wrapper"),h=k.find(".js-name");l=a.find(".js-number");h=h.html();c.waDialog.confirm({title:d.locales.delete_confirm_title.replace("%name%",h).replace("%number%",l.html()),text:d.locales.delete_confirm_text,success_button_title:d.locales.delete_confirm_button,success_button_class:"danger",
cancel_button_title:d.locales.dialog_error_button,cancel_button_class:"light-gray",onSuccess:function(){var n=k.data("id");g||(g=!0,c.post("?module=settingsPBX&action=delete",{p:e,n:f,u:n},function(m){"ok"===m.status&&k.remove()},"json").always(function(){g=!1}))}})});a.on("click",".js-delete-pbx-num",function(){var l=c(this).parents("tr"),k={p:e,n:f};l.addClass("hidden");c.post("?module=settingsPBX&action=deleteNumber",k,function(h){"ok"===h.status?l.remove():l.removeClass("hidden")},"json").always(function(){l.removeClass("hidden")})});
(function(){function l(p){p?h.addClass("is-shown"):h.removeClass("is-shown")}function k(p){m||(m=!0,c.post("?module=settingsPBX&action=add",{p:e,n:f,u:p.id},function(q){"ok"===q.status?(q=c(d.user_template_html),p.photo_url&&q.find(".userpic i").css("background-image","url("+p.photo_url+")"),q.find(".js-name").text(p.name),q.data("id",p.id),n.append(q)):b(q.errors)}).always(function(){m=!1}))}var h=a.find(".js-user-add-wrapper"),n=a.find(".js-users-list"),m=!1;h.on("click",".js-show-combobox",function(p){p.stopPropagation();
l(!0)});h.on("click",".js-hide-combobox",function(p){p.stopPropagation();l(!1)});(function(){var p=h.find(".js-autocomplete");p.length&&(p.autocomplete({appendTo:h,source:c.crm.app_url+"?module=autocomplete&type=user",minLength:0,html:!0,focus:function(){return!1},select:function(q,r){k(r.item);l(!1);p.val("");return!1}}).data("ui-autocomplete")._renderItem=function(q,r){return c("<li />").addClass("ui-menu-item-html").append("<div>"+r.value+"</div>").appendTo(q)},p.on("focus",function(){p.data("uiAutocomplete").search(p.val())}))})()})()};
return CRMSettingsPbxPage}(jQuery);var CRMSettingsTemplate=function(c){CRMSettingsTemplate=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find(".js-template-form");this.$paramsSection=this.$wrapper.find(".c-params-section");this.$param_list=this.$paramsSection.find(".c-params-list");this.$textarea=this.$wrapper.find(".js-content-body");this.$loading_icon=c('<span class="c-notice"><i class="fas fa-spinner wa-animation-spin speed-1000"></i></span>');this.preview_dialog_template=a.preview_dialog_template;this.site_app_url=
a.site_app_url;this.template=a.template||{};this.param_html=a.param_html;this.template_id=a.template_id;this.locales=a.locales;this.company_count=a.company_count;this.ace=null;this.initClass()};CRMSettingsTemplate.prototype.initClass=function(){var a=this;a.initHelp();a.initTabs();a.initAce();a.initSave();a.initDelete();a.initParamsSection();a.initPreviewIframe();a.initIDAutoFiller();a.$form.on("change","input, select, textarea",function(){a.toggleButton(!0)});a.$form.on("input change",function(){a.toggleButton(!0)});
a.initResetTemplate()};CRMSettingsTemplate.prototype.initTabs=function(){var a=this.$wrapper.find(".c-tabs-wrapper"),b=this.$wrapper.find(".c-companies-wrapper"),d=b.find(".c-companies-list"),e=d.find(".c-company.selected");(function(){function f(){c.contains(document,a[0])?g():l.off("resize refresh",f)}function g(){var h=a.outerWidth(!0)-k-38;b.css("max-width",h+"px")}var l=c(window),k=a.find(".c-add-wrapper").outerWidth();g();l.on("resize refresh",f)})();c.crm.tabSlider({$wrapper:b,$slider:d,$activeSlide:e.length?
e:!1})};CRMSettingsTemplate.prototype.initResetTemplate=function(){var a=this,b=a.$wrapper.find(".js-reset-template");a.$wrapper.find(".js-redactor-wrapper").on("keypress",function(){b.removeClass("hidden")});b.on("click",function(){c.post("?module=settings&action=templatesReset","template_id="+a.template_id,function(d){"ok"===d.status&&(c(".js-content-body").text(d.data.template),a.initAce(),a.toggleButton(!0))},"json").always(function(){});b.addClass("hidden")})};CRMSettingsTemplate.prototype.initIDAutoFiller=
function(){var a=null,b,d=this.$param_list,e=this.$form;d.on("change","input.js-code-field",function(){c(this).removeClass("auto-filler")});d.on("keyup","input.js-name-field",function(){var f=c(this),g=f.val(),l=f.parents("tr").find(".js-code-field"),k=l.hasClass("auto-filler"),h=e.find('[type="submit"]');f=l.next(".fa-spinner");!h.prop("disabled")&&k&&(f=f.length?f:c('<span class="c-notice"><i class="fas fa-spinner wa-animation-spin speed-1000"></i></span>'),f.insertAfter(l),h.prop("disabled",!0),
b&&clearTimeout(b),b=setTimeout(function(){a=c.post(c.crm.app_url+"?module=settings&action=fieldTransliterate",{"name[]":g},function(n){a&&(a.abort(),a=null);b&&clearTimeout(b);h.prop("disabled",!1);c(".fa-spinner").remove();"ok"===n.status&&k&&l.val(n.data)},"json")},300))})};CRMSettingsTemplate.prototype.validate=function(){var a=this.$param_list.find(".js-code-field"),b=this.locales;this.$param_list.find(".errormsg").remove();this.$param_list.find(".error").removeClass("error");a.each(function(){var d=
c(this),e=c(this).val(),f=c("<span />").addClass("errormsg"),g=e.search(/^\d/);e=e.search(/[^a-zA-Z0-9_]/);0<=g?(d.addClass("error"),d.after(f.text(b.validate_first_num))):0<=e?(d.addClass("error"),d.after(f.text(b.validate_symbols))):d.hasClass("error")||(f=a.filter(function(){return this.value===d.val()}),2<=f.length&&f.addClass("error").parent().append(c('<span class="errormsg">').text(b.validate_copies)))});return this.$param_list.find(".error").length?!1:!0};CRMSettingsTemplate.prototype.initDelete=
function(){function a(){var e={id:b.template_id};d||(d=!0,c.post("?module=settings&action=templatesDelete",e,function(f){c.crm.content.load(c.crm.app_url+"settings/templates/")},"json").always(function(){d=!1}))}var b=this,d=!1;b.$wrapper.on("click",".js-delete-template",function(e){e.preventDefault();if(b.company_count){var f=c.waDialog.alert({text:b.locales.success_text,button_title:b.locales.success_button});setTimeout(function(){c.contains(document,f.$wrapper[0])&&f.close()},1E4)}else c.waDialog.confirm({title:'<i class="fas fa-exclamation-triangle smaller state-error"></i> '+
b.locales.delete_confirm_title,text:b.locales.delete_confirm_text,success_button_title:b.locales.delete_confirm_button,success_button_class:"danger",cancel_button_title:b.locales.success_button,cancel_button_class:"light-gray",onSuccess:a})})};CRMSettingsTemplate.prototype.initSave=function(){function a(f){c.post("?module=settings&action=templatesSave",f,function(g){"ok"===g.status&&(c(".fa-spinner").remove(),c('<span class="c-notice"><i class="fas fa-check"></i></span>').insertAfter(e),c.crm.content.load(c.crm.app_url+
"settings/templates/"+g.data.id+"/"))},"json").always(function(){d=!1})}var b=this,d=!1,e=b.$wrapper.find(".js-template-save-button");$loading=b.$loading_icon;b.$form.on("submit",function(f){f.preventDefault();c(document).trigger("updateEditorTextarea");$loading.insertAfter(e);if(!b.validate())return!1;!d&&(f=b.$form.serializeArray())&&(d=!0,a(f))})};CRMSettingsTemplate.prototype.initParamsSection=function(){var a=this,b=a.$paramsSection;b.on("click",".js-delete-param",function(d){d.preventDefault();
c(this).closest("tr").remove();a.toggleButton(!0)});b.on("click",".js-add-param",function(d){d.preventDefault();d=c(a.param_html);a.$param_list.append(d);a.toggleButton(!0)})};CRMSettingsTemplate.prototype.toggleButton=function(a){var b=this.$wrapper.find(".js-template-save-button"),d=this.$wrapper.find(".js-hidden-actions");a?(b.addClass("yellow"),d.show()):(b.removeClass("yellow"),d.hide())};CRMSettingsTemplate.prototype.initAce=function(){var a=this;a.$wrapper.find(".js-redactor-wrapper").each(function(b){var d=
c(this),e=d.find("textarea"),f=c('<div class="js-redactor" />'),g="js-textarea-"+b;b="js-redactor-"+b;f.attr("id",b).appendTo(d);e.attr("id",g);waEditorAceInit({id:g,ace_editor_container:b});"undefined"!==typeof wa_editor&&f.data("wa_editor",wa_editor);e.data("wa_editor",f.data("wa_editor"));e.on("editorDataUpdated",function(){var l=f.data("wa_editor");l&&l.getSession().setValue(e.val())});setTimeout(function(){f.data("wa_editor").on("input",function(){a.toggleButton(!0)})},100);c(document).on("updateEditorTextarea",
function(){var l=f.data("wa_editor");l&&(l=l.getValue(),e.val(l).trigger("change"))})})};CRMSettingsTemplate.prototype.initHelp=function(){function a(g){e.drawerWrapper=c(".drawer");e.drawerContent=e.drawerWrapper.find(".drawer-content");g?(e.drawerWrapper.on("click","ul.tabs li",b),e.drawerWrapper.on("click",".wa-help-vars-item",d),e.drawerWrapper.on("click",".drawer-background",function(){return e.drawer.hide()})):(e.drawerWrapper.off("click"),f=!1)}function b(g){g.preventDefault();if(c(this).hasClass("selected"))return!1;
g=c(this).attr("id")+"-content";c(this).addClass("selected").siblings().removeClass("selected");g=e.drawerContent.find("#"+g);g.siblings().hide();g.show()}function d(g){g.preventDefault();$body=e.$textarea;if(g=$body.data("wa_editor"))g.insert(c.trim(c(this).find(".js-var").text())),e.toggleButton(!0),e.$wrapper.find(".js-reset-template").removeClass("hidden"),e.drawer.hide()}var e=this,f=!1;c("#wa-editor-help-link").on("click",function(g){g.preventDefault();g=c.crm.app_url+"?module=settings&action=help";
var l="app=crm&key=invoice&invoice_template_id="+e.template_id;if(f)return e.drawer.show(),!1;e.drawer=c.waDrawer({html:'<div class="drawer crm-help" id=""> <div class="drawer-background"></div> <div class="drawer-body"> <a href="#" class="drawer-close js-close-drawer"><i class="fas fa-times"></i></a> <div class="drawer-block"><div class="flexbox middle width-100 height-100 spinner-wrapper"><div class="spinner custom-p-16"></div></div></div> </div> </div> ',direction:"right",onClose:function(){return a(!1)}});
c.get(g,l,function(k){c(".drawer .drawer-block").html(k);a(!0);f=!0},"html")})};CRMSettingsTemplate.prototype.initPreviewIframe=function(){function a(){c(document).trigger("updateEditorTextarea");b.toggleButton(!1);c.waDialog({html:b.preview_dialog_template,onOpen:function(d){d.find("#js-preview-content").val(b.$textarea.val());d.find(".js-preview-form").trigger("submit")}})}var b=this;b.$wrapper.on("click",".js-show-preview",function(d){d.preventDefault();a()})};return CRMSettingsTemplate}(jQuery);var CRMEmailPersonalSettingsDialog=function(c){CRMEmailPersonalSettingsDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$textarea=this.$wrapper.find(".js-wysiwyg-field");this.dialog=this.$wrapper.data("dialog");a=!1;window&&window.parent&&window.parent.$&&window.parent.$.crm?a=window.parent.$.crm:window.$&&window.$.crm&&(a=window.$.crm);this.crm=a;this.initClass()};CRMEmailPersonalSettingsDialog.prototype.initClass=function(){this.initWYSIWYG();this.initSave()};
CRMEmailPersonalSettingsDialog.prototype.initSave=function(){function a(){if(!d){d=!0;var e=b.$form.serialize();c.post(b.crm.app_url+"?module=email&action=personalSettingsSave",e,function(f){"ok"===f.status&&(b.dialog.options.onSave(f.data||{}),b.dialog.close())}).always(function(){d=!1})}}var b=this,d=!1;b.$form.on("submit",function(e){e.preventDefault();a()})};CRMEmailPersonalSettingsDialog.prototype.initWYSIWYG=function(){var a=this.$textarea;this.crm.initWYSIWYG(a,{minHeight:130,maxHeight:130,
keydownCallback:function(b){}});this.dialog.onClose=function(){var b=a.data("redactor");b&&"core"in b&&b.core.destroy()}};return CRMEmailPersonalSettingsDialog}(jQuery);
//# sourceMappingURL=crm.min.js.map