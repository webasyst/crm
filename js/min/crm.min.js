var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(d,a,b){d instanceof String&&(d=String(d));for(var c=d.length,e=0;e<c;e++){var f=d[e];if(a.call(b,f,e,d))return{i:e,v:f}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(d,a,b){if(d==Array.prototype||d==Object.prototype)return d;d[a]=b.value;return d};$jscomp.getGlobal=function(d){d=["object"==typeof globalThis&&globalThis,d,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var a=0;a<d.length;++a){var b=d[a];if(b&&b.Math==Math)return b}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(d,a){var b=$jscomp.propertyToPolyfillSymbol[a];if(null==b)return d[a];b=d[b];return void 0!==b?b:d[a]};
$jscomp.polyfill=function(d,a,b,c){a&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(d,a,b,c):$jscomp.polyfillUnisolated(d,a,b,c))};$jscomp.polyfillUnisolated=function(d,a,b,c){b=$jscomp.global;d=d.split(".");for(c=0;c<d.length-1;c++){var e=d[c];if(!(e in b))return;b=b[e]}d=d[d.length-1];c=b[d];a=a(c);a!=c&&null!=a&&$jscomp.defineProperty(b,d,{configurable:!0,writable:!0,value:a})};
$jscomp.polyfillIsolated=function(d,a,b,c){var e=d.split(".");d=1===e.length;c=e[0];c=!d&&c in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var f=0;f<e.length-1;f++){var g=e[f];if(!(g in c))return;c=c[g]}e=e[e.length-1];b=$jscomp.IS_SYMBOL_NATIVE&&"es6"===b?c[e]:null;a=a(b);null!=a&&(d?$jscomp.defineProperty($jscomp.polyfills,e,{configurable:!0,writable:!0,value:a}):a!==b&&(void 0===$jscomp.propertyToPolyfillSymbol[e]&&(b=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[e]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(e):$jscomp.POLYFILL_PREFIX+b+"$"+e),$jscomp.defineProperty(c,$jscomp.propertyToPolyfillSymbol[e],{configurable:!0,writable:!0,value:a})))};$jscomp.polyfill("Array.prototype.find",function(d){return d?d:function(a,b){return $jscomp.findInternal(this,a,b).v}},"es6","es3");$jscomp.arrayIteratorImpl=function(d){var a=0;return function(){return a<d.length?{done:!1,value:d[a++]}:{done:!0}}};$jscomp.arrayIterator=function(d){return{next:$jscomp.arrayIteratorImpl(d)}};
$jscomp.initSymbol=function(){};$jscomp.polyfill("Symbol",function(d){if(d)return d;var a=function(f,g){this.$jscomp$symbol$id_=f;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:g})};a.prototype.toString=function(){return this.$jscomp$symbol$id_};var b="jscomp_symbol_"+(1E9*Math.random()>>>0)+"_",c=0,e=function(f){if(this instanceof e)throw new TypeError("Symbol is not a constructor");return new a(b+(f||"")+"_"+c++,f)};return e},"es6","es3");
$jscomp.polyfill("Symbol.iterator",function(d){if(d)return d;d=Symbol("Symbol.iterator");for(var a="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),b=0;b<a.length;b++){var c=$jscomp.global[a[b]];"function"===typeof c&&"function"!=typeof c.prototype[d]&&$jscomp.defineProperty(c.prototype,d,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}})}return d},"es6",
"es3");$jscomp.iteratorPrototype=function(d){d={next:d};d[Symbol.iterator]=function(){return this};return d};$jscomp.iteratorFromArray=function(d,a){d instanceof String&&(d+="");var b=0,c=!1,e={next:function(){if(!c&&b<d.length){var f=b++;return{value:a(f,d[f]),done:!1}}c=!0;return{done:!0,value:void 0}}};e[Symbol.iterator]=function(){return e};return e};$jscomp.polyfill("Array.prototype.keys",function(d){return d?d:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");
$jscomp.polyfill("Array.prototype.values",function(d){return d?d:function(){return $jscomp.iteratorFromArray(this,function(a,b){return b})}},"es8","es3");
(function(d){d.fn.shiftSelectable=function(){function a(m,n,p){var q=!1,r=m.get(0),t=n.get(0);b.find(h).each(function(){var u=this==r,v=this==t;u&&(q=!0);q&&(p.extra={is_first:u,is_last:v},l&&l(d(this),p));if(v)return q=!1})}var b=this,c=arguments;if(1<b.length)b.each(function(){d.fn.shiftSelectable.apply(d(this),c)});else{var e=b.data("shiftSelectable");if(d.isPlainObject(c[0])){if(d.isPlainObject(e))return;e=c[0]}var f=e.ns||(Math.random()+"").slice(2);if("destroy"===c[0])b.off("."+f),b.data("shiftSelectable");
else{var g,h=e.selector,l=e.onSelect,k=e.behavior_type;"vertical"!==k&&"horizontal"!==k&&"mixed"!==k&&(k="vertical");e=e.disable_text_selection;if(void 0!==e?e:1)b.attr("unselectable","on").css({"-moz-user-select":"-moz-none","-o-user-select":"none","-khtml-user-select":"none","-webkit-user-select":"none","-ms-user-select":"none","user-select":"none"}).on("selectstart",!1).on("mousedown",!1);b.on("click."+f,h,function(m){var n=d(this),p=m.shiftKey;if(g&&p){p=g.offset();var q=n.offset();p="vertical"===
k?q.top>p.top:"horizontal"===k?q.left>p.left:q.top>p.top||q.left>p.left;p?a(g,n,m):a(n,g,m)}g=n})}}}})(jQuery);var CRMDialog=function(d){function a(b){console&&console.log&&console.log(b)}CRMDialog=function(b){this.$wrapper=d(b.html);this.$block=this.$wrapper.find(".crm-dialog-block");this.position=b.position||!1;this.userPosition=b.setPosition||!1;this.options=b.options||!1;this.esc="undefined"===typeof b.esc?!0:!!b.esc;this.remain_after_load=b.remain_after_load||!1;this.$body=d(window.top.document).find("body");this.$window=d(window.top);this.is_closed=!1;this.is_visible=!0;this.onBgClick=b.onBgClick||!1;
this.onOpen=b.onOpen||function(){};this.onClose=b.onClose||function(){};this.onConfirm=b.onConfirm||function(){};this.onCancel=b.onCancel||function(){};this.onResize=b.onResize||!1;this.initClass()};CRMDialog.prototype.initClass=function(){var b=this;b.$wrapper.data("dialog",b);b.render();setTimeout(function(){b.bindEvents()},0)};CRMDialog.prototype.bindEvents=function(){function b(){f.is_closed||f.close();g.off("click",b);g.off("wa_before_load",b)}function c(){d.contains(document,f.$wrapper[0])?
f.resize():d(window).off("resize",c)}function e(){d.contains(document,f.$wrapper[0])?f.resize():d(document).off("refresh resizeDialog",e)}var f=this,g=d(document),h=f.$block?f.$block:f.$wrapper;f.$wrapper.on("close",b);if(!f.remain_after_load)g.on("wa_before_load",b);f.$wrapper.on("click",".crm-dialog-background",function(l){if(f.onBgClick)f.onBgClick(l);else l.stopPropagation()});if(f.esc)g.on("keyup",function(l){27===l.keyCode&&f.is_visible&&f.close()});h.on("click",".js-cancel-dialog",function(){if("function"==
typeof f.onCancel)f.onCancel(f);else a("Error: Cancel is not a function")});h.on("click",".js-confirm-dialog",function(l){l.stopPropagation();"function"==typeof f.onConfirm?!1!==f.onConfirm(f)&&f.close():a("Error: Confirm is not a function")});h.on("click",".js-close-dialog",b);d(window).on("resize",c);g.on("refresh resizeDialog",e)};CRMDialog.prototype.render=function(){try{this.$body.append(this.$wrapper)}catch(b){a("Error: "+b.message)}this.setPosition();this.onOpen(this.$wrapper,this)};CRMDialog.prototype.setPosition=
function(){function b(k){return{left:parseInt((e-k.width)/2),top:parseInt((f-k.height)/2)}}var c=this.$window,e=c.width(),f=c.height();c=this.$block?this.$block:this.$wrapper;var g=c.outerWidth(),h=c.outerHeight();var l=this.position?this.position:(this.userPosition?this.userPosition:b)({width:g,height:h});0<l.left&&l.left+g>e&&(l.left=e-g-20);0<l.top?l.top+h>f&&(l.top=f-h-20):(l.top=20,g=c.find(".crm-dialog-content"),g.hide(),h=c.outerHeight(),g.height(f-h-40).addClass("is-long-content").show());
c.css(l)};CRMDialog.prototype.close=function(){this.is_closed=!0;this.onClose(this.$wrapper,this);this.$wrapper.remove()};CRMDialog.prototype.resize=function(){this.$block.addClass("is-animated");this.setPosition();if(this.onResize)this.onResize(this.$wrapper,this)};CRMDialog.prototype.hide=function(){this.$wrapper.hide();this.is_visible=!1};CRMDialog.prototype.show=function(){this.$wrapper.show();this.is_visible=!0};return CRMDialog}(jQuery);var CRMElasticBlock=function(d){CRMElasticBlock=function(a){this.$window=d(window);this.$wrapper=a.$wrapper;this.$aside=a.$aside;this.$content=a.$content;this.top_fix_class="fixed-to-top";this.bottom_fix_class="fixed-to-bottom";this.debug=a.debug;this.initClass()};CRMElasticBlock.prototype.initClass=function(){function a(){if(d.contains(document,p[0])){var D=Math.floor(h.$content.outerHeight()),C=Math.floor(p.outerHeight()),F=Math.floor(n.height()),E=m.scrollTop(),G=Math.floor(p.offset().top),I=A>
E?1:-1,H=E-u;B=p.width();if(!(!v&&F>r&&760<=q)||D&&D<C)v?(F=Math.floor(n.height()),G=Math.floor(n.offset().top),G=F+G-r-E,I=C-r,v=!1,F>C&&E>u&&(I<G?e(0):f())):g();else{D=r>C+0;var J=E<=u,K=parseInt(G+C-E-r),L=0<K;K=0>=K;if(D)0<H+0?(w||x||!y)&&e(0):(w||y||x||z)&&g();else if(J){if(w||x||y)z?G<=u&&g():g()}else L?0<I?G>=0+E&&(w||!y||x)&&e():(!w||y||x)&&c(G-u):K?t.top+F<E+r?(!w||y||x)&&c(F-C):0<I?(!w||y||x)&&c(G-u):(w||y||!x)&&f():(!w||y||x)&&c(G-u)}A=E}else m.off("scroll",a)}function b(){d.contains(document,
p[0])?(q=Math.floor(m.width()),r=Math.floor(m.height()),g(),m.trigger("scroll")):m.off("scroll",b)}function c(D){h.log("Manual top scroll position");p.css("top",D).width(B).removeClass(l).removeClass(k);w=!0;y=x=z=!1}function e(D){h.log("Fixed to top scroll position");p.removeAttr("style").width(B).removeClass(k).addClass(l);D&&(z=!0,p.css("top",D));w=x=!1;y=!0}function f(){h.log("Fixed to bottom scroll position");p.removeAttr("style").width(B).removeClass(l).addClass(k);w=y=z=!1;x=!0}function g(){h.log("Default scroll position");
p.removeAttr("style").removeClass(k).removeClass(l);w=y=x=z=!1}var h=this,l=h.top_fix_class,k=h.bottom_fix_class,m=h.$window,n=h.$wrapper,p=h.$aside;p.addClass("crm-elastic-block");var q=Math.floor(m.width()),r=Math.floor(m.height()),t=n.offset(),u=p.offset().top,v=!0,w=!1,x=!1,y=!1,z=!1,A=0,B;m.on("scroll",a).on("resize",b)};CRMElasticBlock.prototype.log=function(a){this.debug&&console.log(a)};return CRMElasticBlock}(jQuery);(function(d){function a(c,e){var f=d(window);e=f.scrollTop();var g=f.scrollLeft()+f.width(),h=f.scrollTop()+f.height();f=f.scrollLeft();var l=c.element.offset();l.right=l.left+c.element.outerWidth();l.bottom=l.top+c.element.outerHeight();return e<l.top&&f<l.left&&g>l.right&&h>l.bottom}function b(c,e){return c.clone().addClass(e.fixed_class||"sticky-fixed").css(d.extend({position:"fixed",display:"none"},e.fixed_css||{})).removeAttr("id").insertAfter(c)}d.fn.sticky=function(c){function e(){f.closest("body").length?
d.each(h,function(l,k){g.isStaticVisible.call(k.element,k,g)?k.is_fixed&&(k.is_fixed=!1,k.fixed_clone.hide(),g.hideFixed&&g.hideFixed.call(k.fixed_clone,k,g)):(k.is_fixed||(k.is_fixed=!0,k.fixed_clone.show(),g.showFixed&&g.showFixed.call(k.fixed_clone,k,g)),g.updateFixed&&g.updateFixed.call(k.fixed_clone,k,g))}):d(window).off("resize scroll",e)}var f=this,g=d.extend({fixed_class:"sticky-fixed",isStaticVisible:a,getClone:b},c||{}),h=f.map(function(){var l=d(this);return{element:l,fixed_clone:g.getClone.call(l,
l,g),is_fixed:!1}}).get();d(window).on("resize scroll",e);e();return this}})(jQuery);(function(d){d.ajaxSetup({cache:!1});d(document).ajaxSend(function(a,b,c){c.crossDomain||"POST"!==(c.type||"").toUpperCase()||(a=(a=document.cookie.match(/(?:^|; )_csrf=([^;]*)/))?decodeURIComponent(a[1]):"",c.data||0===c.data||(c.data=""),"string"===typeof c.data?-1==c.data.indexOf("_csrf=")&&(c.data+=(0<c.data.length?"&":"")+"_csrf="+a,b.setRequestHeader("Content-type","application/x-www-form-urlencoded")):"object"===typeof c.data&&(window.FormData&&c.data instanceof window.FormData?"function"==
typeof c.data.set?c.data.set("_csrf",a):c.data.append("_csrf",a):c.data._csrf=a))});d(document).ajaxError(function(a,b,c,e){if(b.getResponseHeader("wa-session-expired"))return window.location.reload();502===b.status&&"abort"==e||c.url&&0<=c.url.indexOf("background_process")||c.data&&0<=c.data.indexOf("background_process")?console&&console.log&&console.log("Notice: XHR failed on load: "+c.url):200!==b.status&&b.responseText&&(a=b.responseText,d.crm&&d.crm.is_debug&&(a=d.crm.confirm.template.replace("%title%",
"XHR error "+b.status).replace("%text%",b.responseText).replace("%button%","Close")),(new CRMDialog({html:a})).$wrapper.find(".wa-exception-debug-dump #Trace pre").each(function(){var f=d(this),g=f.html().replace(/^(#(#|\d+)\s+(wa-system|index\.php|\{main\}).*)$/gm,'<span style="color:#999">$1</span>');f.html(g)}),-1===a.indexOf("crm-dialog-wrapper")&&(document.open("text/html"),document.write(b.responseText),document.close()))});d.crm=d.extend(d.crm||{},{lang:!1,app_url:!1,backend_url:!1,is_debug:!1,
is_page_loaded:!1,content:!1,sidebar:!1,storage:new d.store,locales:!1,confirm:{show:function(a){var b=a.text||"",c=a.button||"",e=a.onConfirm||function(){},f=a.onCancel||function(){},g=a.onClose||function(){},h=d.crm.confirm.template;if(h=h.replace("%title%",a.title||"").replace("%text%",b).replace("%button%",c))return new CRMDialog({html:h,onConfirm:e,onCancel:f,onClose:g})},template:""},alert:{show:function(a){var b=a.text||"",c=a.button||d.crm.locales.close||"",e=a.button_class||"gray",f=d.crm.alert.template;
f=f.replace("%title%",a.title||"").replace("%text%",b).replace("%button%",c);if(!f)throw"Not found alert dialog";a=d.extend({},a,!0);a.html=f;f=new CRMDialog(a);f.$wrapper.find(".js-close-dialog").addClass(e);return f},template:""},title:{pattern:"CRM \u2014 %s",set:function(a){if(a){var b=history.state;b&&(b.title=a);document.title=d.crm.title.pattern.replace("%s",a)}}},check:{email:function(a){var b=!1;0<a.length&&1<=(a.match(/.+?@.+/g)||[]).length&&(b=!0);return b}},encodeHTML:function(a){return a&&
(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},renderSVG:function(a){if("object"!==typeof d3)return!1;var b=function(c,e){b=function(f){this.$icon=f.$icon;this.svg=e.select(this.$icon[0]).append("svg");this.type=this.$icon.data("type");this.icon_w=this.$icon.outerWidth();this.icon_h=this.$icon.outerHeight();this.initClass()};b.prototype.initClass=function(){this.svg.attr("width",this.icon_w).attr("height",this.icon_h);this.$icon.hasClass("funnel-state")?this.renderFunnelState():
this.$icon.hasClass("funnel")?this.renderFunnel():this.$icon.hasClass("funnel-1")&&this.renderFunnel(1);this.$icon.data("icon",this)};b.prototype.renderFunnelState=function(){function f(m){return m/16*h.icon_w}function g(m){return m/16*h.icon_h}var h=this,l=h.$icon.data("color")||"#aaa",k=h.svg.append("g");k.append("polygon").attr("points",f(4)+","+g(16)+" "+f(0)+","+g(16)+" "+f(3.9)+","+g(7.9)+" "+f(0)+","+g(0)+" "+f(4)+","+g(0)+" "+f(8.7)+","+g(7.9)).style("opacity",.33).style("fill",l);k.append("polygon").attr("points",
f(8)+","+g(16)+" "+f(4)+","+g(16)+" "+f(7.9)+","+g(7.9)+" "+f(4)+","+g(0)+" "+f(8)+","+g(0)+" "+f(12.6)+","+g(7.9)).style("opacity",.66).style("fill",l);k.append("polygon").attr("points",f(11.9)+","+g(16)+" "+f(7.9)+","+g(16)+" "+f(11.8)+","+g(7.9)+" "+f(7.9)+","+g(0)+" "+f(11.9)+","+g(0)+" "+f(16)+","+g(7.9)).style("fill",l)};b.prototype.renderFunnel=function(f){function g(){var r=[],t=h.icon_w,u=h.icon_h;0<n&&(t-=n,u-=n);var v=t-6+",0";var w=t+","+u/2;t=t-6+","+u;var x="0,"+u;u="6,"+u/2;r.push("0,0");
r.push(v);r.push(w);r.push(t);r.push(x);f&&1===f||r.push(u);return r.join(" ")}var h=this,l=h.$icon.data("color")||"#aaa",k=c.crm.color(l),m=h.$icon.data("hover-color")||k.getTone(20),n=h.$icon.data("stroke-width")||0,p=h.$icon.data("hover")||!1,q=h.svg.append("g").append("polygon").attr("class","is-animated").attr("points",g()).attr("transform","translate("+n/2+","+n/2+")").style("fill",l);0<n&&(k=k.getTone(-20),q.style("stroke",k).style("stroke-width",n));p&&(p=q.node(),p=c(p).closest(".c-state-item "),
p.on("mouseenter",function(){q.style("fill",m)}),p.on("mouseleave",function(){q.style("fill",l)}));(function(){function r(){u||(u=!0,setTimeout(t,100))}function t(){c.contains(document,h.$icon[0])?(h.refresh(),q.attr("points",g())):c(window).off("resize refresh-icons",r);u=!1}var u=!1;c(window).on("resize refresh-icons",r)})()};b.prototype.refresh=function(){this.icon_w=this.$icon.outerWidth();this.icon_h=this.$icon.outerHeight();this.svg.attr("width",this.icon_w).attr("height",this.icon_h)};return b}(jQuery,
d3);"string"===typeof a&&(a=d(a));a.length&&a.find(".svg-icon").each(function(){var c=d(this),e=c.data("icon");e?e.refresh():b&&new b({$icon:c})})},tabSlider:function(a){var b=function(c){b=function(e){this.$wrapper=e.$wrapper;this.$slider=e.$slider;this.$activeSlide=e.$activeSlide||!1;this.type_class=!1;this.left=0;this.slider_w=this.wrapper_w=!1;this.initClass()};b.prototype.initClass=function(){function e(){c.contains(document,f.$wrapper[0])?f.wrapper_w!==f.$wrapper.outerWidth()&&f.reset():g.off("resize",
e)}var f=this,g=c(window);f.detectSliderWidth();f.initStartPosition();g.on("resize",e);f.$wrapper.on("click",".c-action",function(h){h.preventDefault();h=c(this);h.hasClass("left")&&f.moveSlider(!1);h.hasClass("right")&&f.moveSlider(!0)})};b.prototype.initStartPosition=function(){var e=0;if(this.$activeSlide.length){var f=this.$activeSlide.outerWidth(),g=Math.floor(Math.abs(this.$wrapper.offset().left-this.$activeSlide.offset().left));g+f>this.wrapper_w&&(e=g-40)}e?(this.start_left=e,this.moveSlider(!0,
e)):this.showArrows()};b.prototype.detectSliderWidth=function(){this.wrapper_w=this.$wrapper.outerWidth();this.slider_w=this.$slider.outerWidth()};b.prototype.showArrows=function(){function e(g){f.type_class&&f.$wrapper.removeClass(f.type_class);g&&(f.$wrapper.addClass(g),f.type_class=g)}var f=this;0<=f.left?f.wrapper_w<f.slider_w?e("type-1"):e():f.wrapper_w<f.slider_w-Math.abs(f.left)?e("type-2"):e("type-3")};b.prototype.setLeft=function(e){0<Math.abs(e)||(e=0);this.$slider.css("left",e?e+"px":0);
this.left=e};b.prototype.moveSlider=function(e,f){f=f?f:100;var g=this.slider_w-this.wrapper_w,h=0;0<g&&(h=Math.abs(this.left)+(e?f:-f),h>g?h=g:0>h&&(h=0));this.setLeft(-h);this.showArrows()};b.prototype.reset=function(){this.setLeft(0);this.detectSliderWidth();this.showArrows()};return b}(d);return new b(a)},color:function(a){var b=function(){function c(k,m,n){k=parseInt(k,16);m=parseInt(m,16);n=parseInt(n,16);return 0<=k&&0<=m&&0<=n?[k,m,n]:null}function e(k){k[0]=parseInt(k[0].toFixed());k[1]=
parseInt(k[1].toFixed());k[2]=parseInt(k[2].toFixed());var m=k[0].toString(16),n=k[1].toString(16);k=k[2].toString(16);return 0<=m.length&&0<=n.length&&0<=k.length?"#"+(1==m.length?"0"+m:m)+(1==n.length?"0"+n:n)+(1==k.length?"0"+k:k):null}function f(k){var m=(k[0]+16)/116,n=k[1]/500+m,p=m-k[2]/200;n=.95047*(.008856<n*n*n?n*n*n:(n-16/116)/7.787);m=.008856<m*m*m?m*m*m:(m-16/116)/7.787;p=1.08883*(.008856<p*p*p?p*p*p:(p-16/116)/7.787);k=3.2406*n+-1.5372*m+-.4986*p;var q=-.9689*n+1.8758*m+.0415*p;m=.0557*
n+-.204*m+1.057*p;k=.0031308<k?1.055*Math.pow(k,1/2.4)-.055:12.92*k;q=.0031308<q?1.055*Math.pow(q,1/2.4)-.055:12.92*q;m=.0031308<m?1.055*Math.pow(m,1/2.4)-.055:12.92*m;return[255*Math.max(0,Math.min(1,k)),255*Math.max(0,Math.min(1,q)),255*Math.max(0,Math.min(1,m))]}function g(k){var m=k[0]/255,n=k[1]/255,p=k[2]/255;m=.04045<m?Math.pow((m+.055)/1.055,2.4):m/12.92;n=.04045<n?Math.pow((n+.055)/1.055,2.4):n/12.92;p=.04045<p?Math.pow((p+.055)/1.055,2.4):p/12.92;k=(.4124*m+.3576*n+.1805*p)/.95047;var q=
.2126*m+.7152*n+.0722*p;m=(.0193*m+.1192*n+.9505*p)/1.08883;k=.008856<k?Math.pow(k,1/3):7.787*k+16/116;q=.008856<q?Math.pow(q,1/3):7.787*q+16/116;m=.008856<m?Math.pow(m,1/3):7.787*m+16/116;return[116*q-16,500*(k-q),200*(q-m)]}function h(k,m,n){var p=Math.floor(6*k),q=6*k-p;k=n*(1-m);var r=n*(1-q*m);m=n*(1-(1-q)*m);switch(p%6){case 0:var t=n;var u=m;var v=k;break;case 1:t=r;u=n;v=k;break;case 2:t=k;u=n;v=m;break;case 3:t=k;u=r;v=n;break;case 4:t=m;u=k;v=n;break;case 5:t=n,u=k,v=r}return[255*t,255*
u,255*v]}function l(k){var m=k[0]/255,n=k[1]/255,p=k[2]/255,q,r=Math.max(m,n,p);var t=r-Math.min(m,n,p);if(0==t)var u=q=0;else{q=t/r;k=(r-m)/6/t+.5;var v=(r-n)/6/t+.5;t=(r-p)/6/t+.5;m===r?u=t-v:n===r?u=1/3+k-t:p===r&&(u=2/3+v-k);0>u?u+=1:1<u&&--u}return{h:Math.round(360*u),s:Math.round(100*q),b:Math.round(100*r)}}b=function(k){k=this.hex=k;var m=!1;"string"===typeof k?(k=k.replace("#",""),3===k.length?m=c(k[0]+""+k[0],k[1]+""+k[1],k[2]+""+k[2]):6===k.length&&(m=c(k[0]+""+k[1],k[2]+""+k[3],k[4]+""+
k[5]))):"object"===typeof k&&3===k.length&&(m=k);this.rgb=m};b.prototype.getRange=function(){var k=this.rgb?g(this.rgb):!1;if(k){var m=f([90,k[1],k[2]]),n=f([40,k[1],k[2]]);k=e(m);var p=e(n);k=[k,p];k.getColor=function(q){if(0<=q&&100>=q){var r=m[0],t=m[1],u=m[2];return e([Math.floor(r+(n[0]-r)*q/100),Math.floor(t+(n[1]-t)*q/100),Math.floor(u+(n[2]-u)*q/100)])}return null};return k}return null};b.prototype.getTone=function(k){function m(p){100<p?p=100:0>p&&(p=0);return p}var n=l(this.rgb);n.s=m(n.s*
(1+k/100));n.b=m(n.b*(1+k/100));k=h(n.h/360,n.s/100,n.b/100);return e(k)};return b}();return new b(a)},initWYSIWYG:function(a,b){if(!a||!a.length||a.data("redactor"))return a;b=d.extend({minHeight:130,buttons:"inline bold italic underline deleted lists outdent indent image link horizontalrule fontcolor fontsize fontfamily".split(" "),plugins:["fontcolor","fontsize","fontfamily"],allowedTags:"a b i u pre blockquote p strong em del strike span ul ol li div span br".split(" "),uploadImage:!1,lang:this.lang},
b||{});a.redactor(b);d(document).one("wa_before_render",function(){d.contains(document,a[0])&&a.data("redactor")&&a.redactor("core.destroy")});return a},escape:function(a){return d("<div />").text(a).html()},runBackgroundWorker:function(a){var b=Math.floor(100*Math.random())/100,c=Math.floor(100*Math.random())/100,e=a.delay||1E4,f=e/2,g=a.id||(""+Math.random()).slice(2),h=null,l=null,k=a.url;k?(e+=f*b,200>=e?console.error("Delay value too low"):function(){try{var m=function(){h&&clearTimeout(h);l&&
l.abort();l=d.post(k,{process_id:g});l.always(function(){l=null;h=setTimeout(m,e)});l.error(function(){return!1})};h=setTimeout(m,500+300*c)}catch(n){console.error(["source email worker fail",n])}}()):console.error("Empty url")}})})(jQuery);(function(d,a){d.fn.serializeObject=function(){var b={};d.each(this.serializeArray(),function(c,e){c=e.name;e=e.value;b[c]=b[c]===a?e:d.isArray(b[c])?b[c].concat(e):[b[c],e]});return b}})(jQuery);
(function(d){var a=null,b=!1;d(document).on("dragover",function(c){c.preventDefault();a?clearTimeout(a):b||(b=!0,d(document).trigger("myDragEnter"));a=setTimeout(function(){a=null;b=!1;d(document).trigger("myDragLeave")},100)});d(document).on("drop",function(c){c.preventDefault()})})(jQuery);
var ContentRouter=function(d){ContentRouter=function(a){this.$window=d(window);this.$content=a.$content;this.api_enabled=!(!window.history||!window.history.pushState);this.xhr=!1;this.is_enabled=!0;this.need_confirm=!1;this.initClass()};ContentRouter.prototype.initClass=function(){this.bindEvents()};ContentRouter.prototype.bindEvents=function(){var a=this,b=window.location.origin+d.crm.app_url;d(document).on("click","a",function(c){var e=d(this),f=e.attr("href");f||(e.attr("href","javascript:void(0);"),
f=e.attr("href"));e=e.hasClass("js-disable-router");var g=this.href.substr(0,b.length)==b;f=!("#"===f||"javascript:"===f.substr(0,11));f=a.is_enabled&&!e&&g&&f;if(!c.ctrlKey&&!c.shiftKey&&!c.metaKey&&f){c.preventDefault();var h=this.href;a.need_confirm?d.crm.confirm.show({title:d.crm.locales.unsaved_dialog_title,text:d.crm.locales.unsaved_dialog_text,button:d.crm.locales.unsaved_dialog_button,onConfirm:function(){d(document).trigger("unsavedChanges",!1);a.load(h)}}):a.load(h)}});d("#wa-app-crm").on("click",
"a",function(c){c.stopPropagation()});a.api_enabled&&(window.onpopstate=function(c){c.stopPropagation();a.onPopState(c)});d(document).on("unsavedChanges",function(c,e){a.need_confirm=!!e})};ContentRouter.prototype.load=function(a,b){var c=this;if(!(0<=a.indexOf(d.crm.app_url)))return alert("Determine the path error"),!1;c.animate(!0);c.xhr&&c.xhr.abort();d(document).trigger("wa_before_load",{content_uri:a});c.xhr=d.ajax({method:"GET",url:a,dataType:"html",global:!1,cache:!1}).done(function(e){c.api_enabled&&
!b&&history.pushState({reload:!0,content_uri:a},"",a);c.setContent(e);c.animate(!1);c.xhr=!1;d(document).trigger("wa_loaded")}).fail(function(e){e.responseText&&(e={title:"Error",text:e.responseText,ok_button:"Close"},d.post("?module=dialogConfirm",e,function(f){new CRMDialog({html:f})}))});return c.xhr};ContentRouter.prototype.reload=function(){var a=this.api_enabled&&history.state&&history.state.content_uri?history.state.content_uri:location.href;return a?this.load(a,!0):d.when()};ContentRouter.prototype.setContent=
function(a){d(document).trigger("wa_before_render");this.$content.html(a)};ContentRouter.prototype.onPopState=function(a){if(a=a.state||!1){if(!a.content_uri)return alert("Determine the path error"),!1;d(document).trigger("wa_before_load");a.reload?this.reload(a.content_uri):a.content&&this.setContent(a.content);a.title&&d.crm.title.set(a.title);d(document).trigger("wa_loaded")}else location.reload()};ContentRouter.prototype.animate=function(a){};return ContentRouter}(jQuery),CrmEditable=function(d){var a=
function(b){this.$wrapper=b.$wrapper;this.save=b.onSave||function(){};this.render=b.onRender||!1;this.placeholder=b.placeholder||"";this.text=(this.is_empty=this.$wrapper.hasClass("is-empty"))?"":d.trim(this.$wrapper.text());this.is_edit=this.$field=!1;this.initClass()};a.prototype.initClass=function(){this.$field=this.renderField();this.bindEvents()};a.prototype.bindEvents=function(){var b=this;b.$wrapper.on("click",function(){b.toggle()});var c=!1,e=!1;b.$field.on("blur",function(){e||c||(c=!0,
b.save(b),c=!1);e=!1});b.$field.on("keyup",function(f){var g=27===f.keyCode;13!==f.keyCode||c?g&&(b.$field.val(b.text),b.toggle("hide"),e=!0):(c=!0,b.save(b),e=!0,c=!1)})};a.prototype.renderField=function(){var b=this.text,c=d('<input class="bold" type="text" name="" />');this.placeholder&&c.attr("placeholder",this.placeholder);this.is_empty||c.val(b);c.hide();this.$wrapper.after(c);this.render&&this.render(this,c);return c};a.prototype.toggle=function(b){if(b="hide"!==b){var c=this.$wrapper.parent().width(),
e=this.$wrapper.width(),f=Math.floor(c/2);c-=10;this.$field.width(e>c?c:e<f?f:e);this.$wrapper.hide();this.$field.show().focus()}else this.$wrapper.show(),this.$field.hide();this.is_edit=b};a.prototype.loading=function(b){this.$field.siblings(".crm-editable-loading").remove();arguments.length&&!b?this.$field.prop("disabled",!1):(this.$field.after('<i class="icon16 loading crm-editable-loading"></i>'),this.$field.prop("disabled",!0));return this};a.prototype.isLoading=function(b){return 0<this.$field.siblings(".crm-editable-loading").length};
a.prototype.getText=function(){return this.$field.val()};a.prototype.setText=function(b,c){this.text=b;this.$field.val(b);this.$wrapper.text(void 0===c?b:c);return this};a.prototype.hide=function(){this.reset();this.loading(!1);this.toggle("hide");return this};a.prototype.reset=function(){this.setText(this.text,this.$wrapper.text());return this};a.prototype.isChanged=function(){return this.getText()!==this.text};return a}($);(function(d){function a(e,f){var g=new RegExp(d.ui.autocomplete.escapeRegex(f),"i");return d.grep(e,function(h){return g.test(d("<div>").html(h.label||h.value||h).text())})}var b=d.ui.autocomplete.prototype,c=b._initSource;d.extend(b,{_initSource:function(){this.options.html&&d.isArray(this.options.source)?this.source=function(e,f){f(a(this.options.source,e.term))}:c.call(this)},_renderItem:function(e,f){var g=this.options.item_clz||"";this.options.html&&(g+=" ui-menu-item-html");return d("<li class='"+
g+"'></li>").data("item.autocomplete",f).append(d("<div></div>")[this.options.html?"html":"text"](f.label)).appendTo(e)}})})(jQuery);var CRMSidebar=function(d){CRMSidebar=function(a){this.$wrapper=a.$wrapper;this.selected_class="selected";this.$activeMenuItem=this.$wrapper.find("li."+this.selected_class+":first")||!1;this.xhr=!1;this.timer=0;this.initClass()};CRMSidebar.prototype.initClass=function(){var a=this;a.initElasticBlock();a.initUpdater();a.initSearch();a.initRecent();a.$activeMenuItem.length||a.selectLink();a.$wrapper.on("click","li > a",function(){var b=d(this),c=b.attr("href");b.find(".js-indicator").remove();if(c&&
"javascript:"!=c.substr(0,11)&&!b.hasClass("js-no-highlight")){if("icon16 loading"!==b.find(".icon16").attr("class")){var e=b.find(".icon16").attr("class"),f=b.find(".icon16").attr("style");b.find(".icon16").attr("class","icon16 loading").attr("style","");d(document).on("wa_loaded",function(){b.find(".icon16").attr("class",e).attr("style",f);b.find(".highlighted").remove()})}a.setItem(b.closest("li"));d.crm.title.set(b.text())}})};CRMSidebar.prototype.setItem=function(a){if(this.$activeMenuItem&&
this.$activeMenuItem[0]==a[0])return!1;this.$activeMenuItem&&this.$activeMenuItem.removeClass(this.selected_class);a.addClass(this.selected_class);this.$activeMenuItem=a};CRMSidebar.prototype.selectLink=function(a){var b;a&&(b=this.$wrapper.find('a[href="'+a+'"]:first'));if(b&&b.length)this.setItem(b.closest("li"));else{a=this.$wrapper.find("a[href^='"+d.crm.app_url+"']");var c=location.pathname,e=0,f=0;a.each(function(g){var h=d(this).attr("href"),l=h.length;0<=c.indexOf(h)&&l>e&&(e=l,f=g)});if(f||
0===f)b=a.eq(f),this.setItem(b.closest("li"))}};CRMSidebar.prototype.reload=function(a){var b=this,c=d.crm.app_url+"?module=sidebar";a&&(c+="&background_process=1");clearTimeout(b.timer);b.xhr&&b.xhr.abort();b.xhr=d.get(c,function(e){b.xhr=!1;b.$wrapper.replaceWith(e)})};CRMSidebar.prototype.initElasticBlock=function(){var a=this;d(document).ready(function(){new CRMElasticBlock({$wrapper:d("#wa-app"),$aside:a.$wrapper,$content:d.crm.content.$content});var b=d(window);0<b.scrollTop()&&b.trigger("scroll")})};
CRMSidebar.prototype.initUpdater=function(){var a=this;a.timer=setTimeout(function(){d.contains(document,a.$wrapper[0])&&a.reload(!0)},3E5)};CRMSidebar.prototype.initRecent=function(){var a=this.$wrapper.find(".js-recent-wrapper"),b=a.find(".js-pinned-list");a.find(".js-recent-list");var c=a.find(".heading"),e=c.find(".icon16");a.on("click",".js-pin-recent",function(f){f.preventDefault();f.stopPropagation();var g=d(this),h=g.closest("li");f={contact_id:h.data("id")};d.post("?module=recent&action=pin",
f,function(l){if("ok"==l.status){g.removeClass("js-pin-recent").addClass("js-unpin-recent").removeClass("star-empty").addClass("star");l=b.offset().top;var k=b.outerHeight(),m=h.offset().top;l=l+k+3-m;h.addClass("highlighted");l&&(l+="px",h.css({"-webkit-transform":"translate(0,"+l+")",transform:"translate(0,"+l+")"}));setTimeout(function(){h.removeClass("highlighted").removeAttr("style");h.appendTo(b)},400)}})});a.on("click",".js-unpin-recent",function(f){f.preventDefault();f.stopPropagation();var g=
d(this).closest("li");f={contact_id:g.data("id")};d.post("?module=recent&action=unpin",f,function(h){"ok"==h.status&&g.remove()})});a.on("click",".js-recent-heading-hidden",function(){a.removeClass("js-recent-fold-hidden").addClass("js-recent-fold-visible");c.removeClass("js-recent-heading-hidden").addClass("js-recent-heading-visible");e.attr("class","icon16 darr");d.post("?module=recent&action=fold",{fold_hidden:0});d(window).trigger("scroll")});a.on("click",".js-recent-heading-visible",function(){a.removeClass("js-recent-fold-visible").addClass("js-recent-fold-hidden");
c.removeClass("js-recent-heading-visible").addClass("js-recent-heading-hidden");e.attr("class","icon16 rarr");d.post("?module=recent&action=fold",{fold_hidden:1});d(window).trigger("scroll")})};CRMSidebar.prototype.initSearch=function(){var a=this.$wrapper.find(".js-search-form"),b=a.find(".js-search-field");a.on("submit",function(c){c.preventDefault();c=b.val();c=c.replace(/\//g,"\\/").replace(/&/g,"\\&").replace(/\+/g,"");if(!c.length||!d.trim(c))return!1;c=d.crm.app_url+"contact/search/result/contact_info."+
(0<=c.indexOf("@")?"email":"name.name")+"*="+encodeURIComponent(c);d.crm.content.load(c);b.val("")});b.autocomplete({appendTo:a,classes:{"ui-autocomplete":"c-search-results-list"},source:"?module=autocompleteSidebar",minLength:2,html:!0,focus:function(){return!1},select:function(c,e){(c=e.item.link)&&d.crm.content.load(d.crm.app_url+c);b.val("");return!1}}).data("ui-autocomplete")._renderItem=function(c,e){return d("<li />").addClass("ui-menu-item-html").append("<div>"+e.value+"</div>").appendTo(c)}};
return CRMSidebar}(jQuery);var CRMDeal=function(d){var a=function(c){a=function(e){this.$window=c(window);this.$wrapper=e.$wrapper;this.$outer_wrapper=e.$outer_wrapper;this.debug=e.debug;this.indent={top:0};this.$clone=null;this.offset=this.getOffset();this.type=null;this.init()};a.prototype.init=function(){function e(){c.contains(document,g.$wrapper[0])?(g.reset(),g.onScroll()):c(document).off("refresh",e)}function f(){if(c.contains(g.$window[0].document,g.$wrapper[0]))g.onScroll();else g.$window.off("scroll",f)}var g=this;
g.$clone=function(l){var k=c("<div />");l.before(k);return k.hide()}(g.$wrapper);g.onScroll();var h=0;g.$window.on("resize",function(){clearTimeout(h);h=setTimeout(function(){g.reset();g.onScroll()},50)});c(document).on("refresh",e);g.$window.on("scroll",f)};a.prototype.onScroll=function(){var e=this.$window.scrollTop(),f=this.$window,g=f.width();f.height();f=this.offset;var h=this.$outer_wrapper.outerHeight();!(0<g)||h<=this.offset.height?this.fixTo("default"):e<=f.top-this.indent.top?this.fixTo("default"):
this.fixTo("fix_top")};a.prototype.fixTo=function(e,f){e=e?e:null;this.type!==e&&("fix_top"===e?(this.$wrapper.removeAttr("style"),this.$clone.css({height:this.$wrapper.outerHeight()}).show(),this.$wrapper.css({position:"fixed",top:this.indent.top,left:this.offset.left-10,width:this.offset.width+20}),this.$wrapper.addClass("is-fixed-top")):(this.$wrapper.removeClass("is-fixed-top").removeAttr("style"),this.$clone.hide().height(0),this.$wrapper[0].scrollTop=0),c(document).trigger("refresh-icons"),
this.type=e,this.log(e))};a.prototype.reset=function(){this.fixTo("default");this.offset=this.getOffset()};a.prototype.getOffset=function(){var e=this.$wrapper.offset();return{top:e.top,left:e.left,width:this.$wrapper.outerWidth(),height:this.$wrapper.outerHeight()}};a.prototype.log=function(e){this.debug&&console.log(e)};return a}(jQuery),b=function(c){function e(f){var g=0;f.indent&&(g="function"===typeof f.indent?f.indent():f.indent);return g}b=function(f){this.$window=c(window);this.$wrapper=
f.$wrapper;this.$outer_wrapper=f.$outer_wrapper;this.debug=f.debug;this.indent=f.indent;this.$clone=null;this.offset=this.getOffset();this.type=null;this.init()};b.prototype.init=function(){function f(){c.contains(document,h.$wrapper[0])?(h.reset(),h.onScroll()):c(document).off("refresh",f)}function g(){if(c.contains(h.$window[0].document,h.$wrapper[0]))h.onScroll();else h.$window.off("scroll",g)}var h=this;h.$clone=function(k){var m=c("<div />");k.before(m);return m.hide()}(h.$wrapper);h.onScroll();
var l=0;h.$window.on("resize",function(){clearTimeout(l);l=setTimeout(function(){h.reset();h.onScroll()},50)});c(document).on("refresh",f);h.$window.on("scroll",g)};b.prototype.onScroll=function(){var f=this.$window.scrollTop(),g=e(this),h=this.$window,l=h.width();h.height();h=this.offset;var k=this.$outer_wrapper.outerHeight();!(0<l)||k<=this.offset.height?this.fixTo("default"):f<=h.top-g?this.fixTo("default"):this.fixTo("fix_top")};b.prototype.fixTo=function(f,g){function h(){var m=k.getHeight();
k.$wrapper.css({position:"static",top:"auto",left:"auto",width:"auto",height:m});k.$clone.hide().height(0)}function l(){var m=k.getHeight();k.$wrapper.css({position:"fixed",top:e(k),left:k.offset.left,width:k.offset.width,height:m});k.$clone.css({height:m}).show()}var k=this;f=f?f:null;"fix_top"===f?(l(),k.type!==f&&k.$wrapper.addClass("is-fixed")):(h(),k.type!==f&&k.$wrapper.removeClass("is-fixed"));k.type=f;k.log(f)};b.prototype.reset=function(){this.fixTo("default");this.offset=this.getOffset()};
b.prototype.getOffset=function(){var f=this.$wrapper.offset();return{top:f.top,left:f.left,width:this.$wrapper.outerWidth(),height:this.$wrapper.outerHeight()}};b.prototype.log=function(f){this.debug&&console.log(f)};b.prototype.getHeight=function(){var f=this.$window.height(),g=e(this);this.offset.top-this.$window.scrollTop()>g&&(g=this.offset.top-this.$window.scrollTop());var h=this.$outer_wrapper.offset().top+this.$outer_wrapper.outerHeight(),l=this.$window.height()+this.$window.scrollTop();return f-
g-(0>h-l?Math.abs(h-l):0)};return b}(jQuery);CRMDeal=function(c){this.$wrapper=c.$wrapper;this.$aside=this.$wrapper.find(".c-deal-aside");this.$log_section=this.$wrapper.find(".js-deal-log-section");this.locales=c.locales;this.templates=c.templates;this.deal=c.deal||{};this.deal_id=this.deal.id||0;this.order_id=c.order_id||0;this.user_id=c.user_id;this.funnel_id=c.funnel_id;this.can_edit_deal=c.can_edit_deal||!1;this.shop_in_welcome_stage=c.shop_in_welcome_stage||!1;this.remove_is_locked=this.is_locked=
!1;this.init()};CRMDeal.prototype.init=function(){var c=this;d.crm.renderSVG(c.$wrapper);d.crm.sidebar.reload();c.can_edit_deal&&(c.initChangeState(),c.initCloseDeal(),c.initReopenDeal(),c.initAddContact(),c.initRemoveFiles(),c.initEditableName(),c.initChangeDate(),c.initChangePrice(),c.initChangeField(),c.initWYSIWYG(),c.initChangeDescription(),c.initChangeUser(),c.initChangeClient(),c.initDealDelete(),c.initAssignTags(),c.initCreateOrderLink(),c.initEditOrderLink());c.initCall();c.initMessages();
c.initOrderEditShippingDetailLink();c.initSticky();c.initOrderSection();c.initScroll();c.deal_id&&c.initLogSection();c.$wrapper.on("click",".js-remove-owner",function(e){e.preventDefault();c.remove_is_locked||c.removeOwner(d(this).closest(".c-contact"))});c.$wrapper.on("click",".js-remove-contact",function(e){e.preventDefault();c.remove_is_locked||c.removeContact(d(this).closest(".c-contact"))});c.$wrapper.on("click",".js-add-external-contact",function(e){e.preventDefault();c.addExternalContact(d(this))})};
CRMDeal.prototype.initLogSection=function(){var c=this.deal_id;this.$log_section.on("click",".js-open-conversation",function(e){e.preventDefault();e=d(this).attr("href");-1===e.indexOf("?")?window.location.href=e+"?deal_id="+c:window.location.href=e+"&deal_id="+c})};CRMDeal.prototype.initScroll=function(){function c(){d.contains(document,h.$wrapper[0])?f():l.off("scroll",c)}function e(){d.contains(document,h.$wrapper[0])?g():l.off("resize",e)}function f(){0<l.scrollTop()?m||(k.show(),m=!0):m&&(k.hide(),
m=!1)}function g(){var q=p.offset().left;k.css("right",l.width()-q)}var h=this,l=d(window),k=d('<div class="c-scroll-action"><div class="c-icon to-top"></div></div>'),m=!1,n=h.$wrapper.find(".c-deal-board"),p=h.$wrapper.find(".c-deal-aside-wrapper");n.append(k);f();g();k.on("click",function(){d("html, body").animate({scrollTop:0},500)});l.on("scroll",c);l.on("resize",e)};CRMDeal.prototype.initSticky=function(){function c(){0<f[0].scrollTop?f.addClass("is-scrolled"):f.removeClass("is-scrolled")}var e=
this.$wrapper.find(".js-page-header"),f=this.$wrapper.find("#js-deal-aside");new a({$wrapper:e,$outer_wrapper:this.$wrapper,debug:!1});new b({$wrapper:f,$outer_wrapper:f.closest(".c-deal-board"),indent:function(){return e.outerHeight()},debug:!1});c();f.on("scroll",c)};CRMDeal.prototype.initChangeState=function(){function c(f){function g(){d.crm.content.load(d.crm.app_url+"deal/"+e.deal_id+"/")}d.post("?module=deal&action=move",{deal_id:e.deal_id,stage_id:f},function(h){"ok"===h.status&&(h.data.dialog_html&&
h.data.dialog_html.html?new CRMDialog({html:h.data.dialog_html.html,options:{onShopSubmit:g},onConfirm:function(){d.post("?module=deal&action=move",{deal_id:e.deal_id,stage_id:f,force_execute:1},g)}}):g())},"json")}var e=this;e.$wrapper.find(".c-funnel-wrapper").on("click",".c-state-item.js-set-state",function(f){f.preventDefault();f=d(this);if(f.hasClass("selected"))return!1;f=f.data("id");c(f)})};CRMDeal.prototype.initCloseDeal=function(){var c=this,e=!1;c.$wrapper.on("click",".js-close-deal",function(f){f.preventDefault();
e||(e=!0,d.post("?module=deal&action=closeDialog",{id:c.deal_id},function(g){new CRMDialog({html:g})}).always(function(){e=!1}))})};CRMDeal.prototype.initReopenDeal=function(){var c=this,e=!1;c.$wrapper.on("click",".js-reopen-deal",function(f){f.preventDefault();e||(e=!0,d.post("?module=deal&action=reopen",{id:c.deal_id},function(g){"ok"==g.status?d.crm.content.reload():alert("Error: Deal Reopen")},"json").always(function(){e=!1}))})};CRMDeal.prototype.initAddContact=function(){function c(l,k){l=
l.closest(".c-add-contact");k?(h.hide(),l.addClass("is-shown")):(h.show(),l.removeClass("is-shown"))}function e(l,k){function m(n){n=n?n:[];d.each(n,function(p,q){p=q.text;var r=d('<div class="errormsg" />').html(p);h.one("click",function(){r.remove()});g.prepend(r)})}k=k?k:function(){};d.post("?module=deal&action=userAdd",{contact_id:l,deal_id:f.deal_id},function(n){"ok"===n.status?k(n.data.html):n.errors&&m(n.errors)},"json")}var f=this,g=f.$aside.find(".js-add-user-wrapper"),h=g.find(".js-add-contact");
h.on("click",function(l){l.preventDefault();c(d(this),!0)});g.on("click",".js-close-add-contact",function(l){l.preventDefault();c(d(this))});(function(){function l(m,n){var p=f.$aside.find('.c-contact[data-id="'+m+'"]');p.length&&k(p);e(m,function(q){q=d(q);n.before(q);k(q);d(document).trigger("refresh")})}function k(m){m.addClass("is-highlight");setTimeout(function(){d.each(m,function(n,p){d.contains(document,p)&&d(this).removeClass("is-highlight")})},3E3)}f.$aside.find(".js-contact-autocomplete").each(function(){var m=
d(this);m.autocomplete({appendTo:f.$aside,source:d.crm.app_url+"?module=autocomplete&type=user&funnel_id="+f.funnel_id,minLength:0,html:!0,focus:function(){return!1},select:function(n,p){l(p.item.id,m.closest(".c-add-contact"));m.val("");f.$aside.find(".js-close-add-contact").trigger("click");return!1}}).data("ui-autocomplete")._renderItem=function(n,p){var q=d("<li />");q.addClass("ui-menu-item-html").append("<div>"+p.value+"</div>").appendTo(n);p.rights||(q.addClass("is-locked"),q.on("click",function(r){r.preventDefault();
r.stopPropagation()}));return q};m.on("focus",function(){m.data("uiAutocomplete").search(m.val())})})})()};CRMDeal.prototype.initRemoveFiles=function(){function c(g,h){d.post("?module=file&action=delete",{id:g},function(l){"ok"==l.status?h.remove():console&&console.log&&console.log("File Remove Error")})}var e=this,f;e.$wrapper.find(".c-files-wrapper").on("click",".js-remove-file",function(g){g.preventDefault();var h=d(this).closest(".c-file");g=h.find(".c-name").text();var l=parseInt(h.data("id"));
f&&f.abort();g={title:e.locales.remove_file_title,text:e.locales.remove_file_text.replace(/%s/,g),ok_button:e.locales.remove_file_button};0<l?f=d.post("?module=dialogConfirm",g,function(k){new CRMDialog({html:k,onConfirm:function(){c(l,h)}})}).always(function(){f=!1}):console&&console.log&&console.log("File ID is empty")})};CRMDeal.prototype.initEditableName=function(){var c=this.$wrapper.find(".js-editable").first();if(!(0>=c.length)){var e=d.crm.app_url+"?module=deal&action=rename",f=this.deal_id,
g=null;new CrmEditable({$wrapper:c,onSave:function(h){var l=h.$field.val();if(l.length&&h.text!==l){g&&g.abort();l={id:f,name:l};h.$field.attr("disabled",!0);var k=d('<i class="icon16 loading"></i>').css("margin","0 0 0 4px").insertAfter(h.$field);g=d.post(e,l,function(m){h.$field.attr("disabled",!1);k.remove();h.toggle("hide");m&&m.data&&m.data.deal&&(h.text=m.data.deal.name,h.$wrapper.text(m.data.deal.name),d.crm.title.set(m.data.deal.name))})}else l.length||h.$field.val(h.text),h.toggle("hide")}})}};
CRMDeal.prototype.initChangeDate=function(){function c(n){n?(g.addClass("is-shown"),k.focus()):(g.removeClass("is-shown"),k.datepicker("hide"))}function e(n){k.val()||(n="");d.post("?module=deal&action=changeExpectedDate",{id:f.deal_id,expected_date:n?n:""},function(p){"ok"==p.status&&p.data&&p.data.deal&&((p=p.data.deal.expected_date)?(h.hide(),l.show().find(".js-name").text(p)):(l.hide().find(".js-name").text(""),h.show()),c())},"json")}var f=this,g=f.$wrapper.find(".js-date-toggle");if(!g.length)return!1;
var h=g.find(".js-link"),l=g.find(".js-span"),k=g.find(".js-datepicker"),m=g.find(".js-field");g.on("click",".js-set-date",function(n){n.preventDefault();c(!0)});k.on("keydown keypress keyup",function(n){27===n.keyCode&&c()});g.on("click",".js-close-edit-date",function(){c()});(function(){k.datepicker({altField:m,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,onSelect:function(){var n=k.val(),p=m.val(),q=d.datepicker._defaults.dateFormat,r=!1;try{d.datepicker.parseDate(q,n),r=!0}catch(t){}if(r)e(p);
else return!1}});k.val()||k.datepicker("setDate","+0d")})()};CRMDeal.prototype.initChangePrice=function(){function c(p){p?h.addClass("is-shown"):h.removeClass("is-shown")}function e(p,q){d.post("?module=deal&action=changeAmount",{id:g.deal_id,amount:p?p:"",currency_id:q?q:""},function(r){"ok"==r.status&&r.data&&r.data.deal&&((r=r.data.deal.amount)?(l.hide(),k.show().text(r)):(k.hide().text(""),l.show()),c())},"json")}function f(){var p=m.val(),q=n.val(),r=!1;p&&(r=p.replace(",","."));0<=r?e(p,q):
m.addClass("error")}var g=this,h=g.$wrapper.find(".js-price-toggle");if(!h.length)return!1;var l=h.find(".js-link"),k=h.find(".js-span"),m=h.find(".js-price-field"),n=h.find(".js-currency-field");h.on("click",".js-set-price",function(p){p.preventDefault();c(!0)});h.on("click",".js-save-price",function(p){p.preventDefault();f()});h.on("click",".js-cancel",function(p){p.preventDefault();c()});m.on("focus",function(){m.hasClass("error")&&m.removeClass("error")});m.on("keydown",function(p){13===p.keyCode&&
(p.preventDefault(),f())})};CRMDeal.prototype.initChangeField=function(){function c(k,m){var n=d(k).parents(".js-field-toggle");m?(n.find(".c-hidden").css({height:d(k).height()+8}),d(k).closest(".js-field-toggle").hasClass("js-textarea")?(n.addClass("is-shown").find(".c-hidden").css("width","100%"),n.find("textarea").slideDown().next().find(".icon16").removeClass("loading").addClass("disk"),n.css({width:"100%","margin-left":0}).prev().hide()):(n.addClass("is-shown"),n.find(".js-datepicker-field").focus())):
d(document).trigger("mousedown")}function e(k){var m=h.data("deal-id"),n="",p=d(k).data("field-id"),q=d(k).data("field-type"),r=!1;switch(q){case "checkbox":d(k).prop("required")&&!d(k).prop("checked")?(r=!0,d(k).addClass("error")):n=Number(d(k).prop("checked"));break;case "date":var t=d(k).siblings(".js-datepicker-field"),u=d.datepicker._defaults.dateFormat,v=!1;try{d.datepicker.parseDate(u,t.val()),v=!0}catch(x){}""!=t.val()&&""!=t.val().trim()&&v||!d(k).prop("required")?n=t.val():(r=!0,t.addClass("error"));
break;case "text":t=d(k).parents(".c-hidden").find(".js-field-value-text");t.next().find(".icon16").removeClass("disk").addClass("loading");""!=t.val()&&""!=t.val().trim()||!t.prop("required")?n=t.val():(r=!0,d(k).parents(".c-hidden").find(".js-field-value-text").addClass("error"));break;case "select":var w=d(k).val();v=!1;d(k).find("option").each(function(x,y){d(y).val()==w&&(v=!0)});!v||""==w&&d(k).prop("required")?(r=!0,d(k).addClass("error")):n=w;break;case "radio":n=d(k).find(":checked").val();
break;case "number":w=d(k).val().replace(",",".");(""==w||isNaN(Number(w)))&&d(k).prop("required")?(r=!0,d(k).addClass("error")):n=w;break;default:w=d(k).val(),""!=w&&""!=w.trim()||!d(k).prop("required")?n=w:(r=!0,d(k).addClass("error"))}r||f(k,{id:m,field_id:p,value:n,value_type:q})}function f(k,m){d.post("?module=deal&action=changeValue",m,function(n){if("ok"==n.status){if(n.data&&n.data.deal_params){n=n.data.deal_params.value;var p=d(k).parents(".js-field-toggle").find(".js-output-value");n?(p.text(n),
d(k).removeClass("error")):(p.text(p.data("empty-text")),d(k).siblings(".js-datepicker-field").datepicker("hide"));c(k,!1)}}else d(k).addClass("error")},"json")}var g=this.$wrapper.find(".js-field-toggle"),h=d(".c-deal-options-section");if(!g.length)return!1;var l=g.find(".js-field-value");g.on("click",".js-output-value",function(k){k.preventDefault();c(this,!0)});g.on("click",".js-save-field",function(k){k.preventDefault();e(this)});g.on("click",".js-cancel",function(k){k.preventDefault();d(document).trigger("mousedown")});
g.on("click",".js-field-value-checkbox",function(){e(this)});g.on("change",".js-field-value-select",function(k){k.preventDefault();e(this)});g.on("click",".js-field-value-radio-block input",function(){e(d(this).closest(".js-field-value-radio-block"))});g.on("click",".js-field-value-radio-block .js-clear-link",function(k){k.preventDefault();k=d(this).closest(".js-field-value-radio-block");k.find(":checked").attr("checked",!1);e(k)});l.on("focus",function(){l.hasClass("error")&&l.removeClass("error")});
d(document).on("mousedown",function(k){0!==g.has(k.target).length||g.is(k.target)||g.each(function(m,n){var p=d(n);m=p.find("textarea");p.hasClass("js-textarea")?m.slideUp(function(){p.removeClass("is-shown").removeAttr("style").prev().show()}):p.removeClass("is-shown")})});l.on("keydown",function(k){13===k.keyCode&&(k.preventDefault(),d(this).hasClass("js-datepicker-field")?e(d(this).siblings(".js-field-value")):e(this))});(function(){var k=h.find(".js-datepicker-field"),m=k.siblings(".js-field-value");
k.datepicker({altField:m,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,onSelect:function(){var n=d(this).siblings(".js-field-value");e(n)}})})()};CRMDeal.prototype.initWYSIWYG=function(){var c=this.$wrapper.find(".js-wysiwyg");if(!c.length)return!1;d.crm.initWYSIWYG(c,{keydownCallback:function(e){}})};CRMDeal.prototype.initChangeDescription=function(){function c(l){l?g.addClass("is-shown"):g.removeClass("is-shown")}function e(l){d.post("?module=deal&action=changeDescription",l,function(k){if("ok"==
k.status){if(k.data&&k.data.deal_description){k=k.data.deal_description.value;var m=g.find(".js-output-value");k?(m.find(".c-description").html(k).show(),m.find(".js-add-description").hide()):(m.find(".js-add-description").show(),m.find(".c-description").html("").hide());c(!1)}}else d(f).addClass("error")},"json")}var f=this,g=f.$wrapper.find(".c-description-section .js-description-toggle");if(!g.length)return!1;var h=g.find(".js-field-value");g.on("click",".js-add-description, .js-edit-description",
function(l){l.preventDefault();c(!0)});g.on("hover",".c-description-wrapper",function(){""!=g.find(".c-description").html()&&g.find(".js-edit-description").css("visibility","visible")});g.on("mouseleave",".c-description-wrapper",function(){g.find(".js-edit-description").css("visibility","hidden")});g.on("click",".js-save-description",function(l){l.preventDefault();l=g.find('input[name="data[deal_id]"]').val();var k=g.find(".js-description-value").val();e({id:l,value:k})});g.on("click",".js-cancel",
function(l){l.preventDefault();c(!1)});h.on("focus",function(){h.hasClass("error")&&h.removeClass("error")})};CRMDeal.prototype.initChangeUser=function(){function c(k){if(!k.length)return!1;var m=k.closest(".c-contact");k.autocomplete({appendTo:m,source:"?module=autocomplete&type=user&funnel_id="+h.funnel_id,minLength:0,html:!0,focus:function(){return!1},select:function(n,p){e(p.item.id,m);k.val("");return!1}}).data("ui-autocomplete")._renderItem=function(n,p){var q=d("<li />");q.addClass("ui-menu-item-html").append("<div>"+
p.value+"</div>").appendTo(n);p.rights||(q.addClass("is-locked"),q.on("click",function(r){r.preventDefault();r.stopPropagation()}));return q};k.on("focus",function(){k.data("uiAutocomplete").search(k.val())})}function e(k,m){l?g(m):f(k,function(){l=!0;d.post("?module=deal&action=changeUser",{id:h.deal_id,user_contact_id:k},function(n){if("ok"!==n.status)n.errors?console.error(n.errors):console.error(n),d.crm.alert.show({title:"Error",button:"Error"});else if(n.data=n.data||{},n.data.deal_access_denied)window.location.href=
d.crm.app_url+"deal/";else if(n.data.html){n=d(n.data.html);var p=h.$aside.find('.c-users-section .c-contact[data-id="'+k+'"]').not(m);p.length&&p.remove();m.replaceWith(n);c(n.find(".js-owner-autocomplete"))}},"json").always(function(){l=!1})})}function f(k,m){d.post("?module=deal&action=changeUserConfirm",{id:h.deal_id,user_contact_id:k},"json").done(function(n){n.data&&n.data.need_confirm?new CRMDialog({html:n.data.html||"",onOpen:function(p,q){p.find(".js-confirm-button").on("click",function(){m()})}}):
m()})}function g(k,m){m?k.addClass("is-edit"):k.removeClass("is-edit")}var h=this,l=!1;h.$aside.on("click",".js-show-combobox",function(k){k.preventDefault();k=d(this).closest(".c-contact");g(k,!0)});h.$aside.on("click",".js-hide-combobox",function(k){k.preventDefault();k=d(this).closest(".c-contact");g(k)});h.$aside.find(".js-owner-autocomplete").each(function(){c(d(this))});(function(){function k(q){n||f(q,function(){n=!0;d.post("?module=deal&action=changeUser",{id:h.deal_id,user_contact_id:q},
function(r){if("ok"===r.status)if(r.data.deal_access_denied)window.location.href=d.crm.app_url+"deal/";else{r=d(r.data.html);var t=h.$aside.find('.c-users-section .c-contact[data-id="'+h.user_id+'"]');t.length&&t.remove();h.$aside.find('.c-contact[data-id="'+r.data("id")+'"]').remove();p.after(r).css("display","none");h.$aside.find(".js-add-user-wrapper").show();c(r.find(".js-owner-autocomplete"))}},"json").always(function(){n=!1})})}function m(q){q?p.addClass("is-extended"):p.removeClass("is-extended")}
var n=!1,p=h.$aside.find(".js-empty-user-wrapper");p.on("click",".js-set-user-me",function(q){q.preventDefault();k(h.user_id)});p.on("click",".js-set-extended",function(q){q.preventDefault();m(!0)});p.on("click",".js-unset-extended",function(q){q.preventDefault();m(!1)});(function(){p.find(".js-empty-user-autocomplete").each(function(){var q=d(this);q.autocomplete({appendTo:p,source:"?module=autocomplete&type=user&funnel_id="+h.funnel_id,minLength:0,html:!0,focus:function(){return!1},select:function(r,
t){k(t.item.id);q.val("");return!1}}).data("ui-autocomplete")._renderItem=function(r,t){var u=d("<li />");u.addClass("ui-menu-item-html").append("<div>"+t.value+"</div>").appendTo(r);t.rights||(u.addClass("is-locked"),u.on("click",function(v){v.preventDefault();v.stopPropagation()}));return u};q.on("focus",function(){q.data("uiAutocomplete").search(q.val())})})})()})()};CRMDeal.prototype.initChangeClient=function(){function c(l,k,m){g||(g=!0,d.post("?module=deal&action=changeClient",{deal_id:e.deal_id,
client_type:m,contact_id:k},function(n){new CRMDialog({html:n,options:{onChange:function(p){l.replaceWith(p.html);l.find(".js-add-company-contact").show();(parseInt(e.deal.contact_id)||0)===k&&p.contact.id!==k&&(e.deal.contact_id=p.contact.id);d(document).trigger("refresh")}}})}).always(function(){g=!1}))}var e=this,f=e.$wrapper.find(".js-contacts-section"),g=!1;f.on("click",".js-edit-company-owner",function(l){l.preventDefault();l=d(this).closest(".c-contact");var k=l.data("type"),m=l.data("id");
c(l,m,k)});var h=f.find(".js-empty-contact-wrapper");if(h.length)h.on("click",".js-set-company-owner",function(l){l.preventDefault();c(h,"","contact_owner")})};CRMDeal.prototype.initDealDelete=function(){function c(){f||(f=!0,d.post(d.crm.app_url+"?module=deal&action=delete",{id:e.deal_id},function(g){"ok"===g.status&&d.crm.content.load(d.crm.app_url+"deal/")},"json").always(function(){f=!1}))}var e=this,f=!1;e.$wrapper.on("click",".js-deal-delete",function(g){g.preventDefault();d.crm.confirm.show({title:e.locales.delete_deal_title,
text:e.locales.delete_deal_text,button:e.locales.delete_deal_button,onConfirm:c})})};CRMDeal.prototype.initCall=function(){var c=this,e=!1;c.$wrapper.on("click",".js-show-call-dialog",function(f){f.preventDefault();var g=d(this);f=g.data("id");g=g.data("phone");!e&&f&&g&&(e=!0,d.post("?module=call&action=initContactDialog",{deal_id:c.deal_id,contact_id:f,phone:g},function(h){new CRMDialog({remain_after_load:!0,html:h})}).always(function(){e=!1}))})};CRMDeal.prototype.initOrderSection=function(){var c=
this.$wrapper.find(".c-order-section"),e=c.find(".c-order-details"),f=c.find(".c-products-wrapper");e.on("click",".js-details-toggle",function(g){g.preventDefault();g=d(this).find(".icon16");e.hasClass("is-extended")?(g.removeClass("darr").addClass("rarr"),e.removeClass("is-extended")):(g.removeClass("rarr").addClass("darr"),e.addClass("is-extended"));d(document).trigger("refresh")});f.on("click",".js-products-toggle",function(g){g.preventDefault();g=d(this).find(".icon16");f.hasClass("is-extended")?
(g.removeClass("darr").addClass("rarr"),f.removeClass("is-extended")):(g.removeClass("rarr").addClass("darr"),f.addClass("is-extended"));d(document).trigger("refresh")})};CRMDeal.prototype.initMessages=function(){this.initSendEmail();this.initSendSMS()};CRMDeal.prototype.initSendEmail=function(){var c=this,e=!1;c.$wrapper.on("click",".js-show-message-dialog",function(f){f.preventDefault();var g=d(this);f=g.data("id");g=g.data("email");!e&&f&&(e=!0,d.post("?module=message&action=writeDealDialog",{deal_id:c.deal_id,
contact_id:f,email:g},function(h){new CRMDialog({html:h})}).always(function(){e=!1}))})};CRMDeal.prototype.initSendSMS=function(){var c=this,e=!1;c.$wrapper.on("click",".js-show-send-sms-dialog",function(f){f.preventDefault();var g=d(this);f=g.data("id");g=g.data("phone");!e&&f&&(e=!0,d.get("?module=message&action=writeSMSDealDialog",{deal_id:c.deal_id,contact_id:f,phone:g},function(h){new CRMDialog({html:h})}).always(function(){e=!1}))})};CRMDeal.prototype.addExternalContact=function(c){d.get(d.crm.app_url+
"?module=deal&action=addParticipant",{id:this.deal_id},function(e){new CRMDialog({html:e,options:{onAdd:function(f){c.closest(".c-add-contact").before(f);d(document).trigger("refresh")}}})})};CRMDeal.prototype.removeOwner=function(c){function e(l,k){l={owner_id:l,deal_id:k};var m=d(".js-empty-user-wrapper");f.remove_is_locked=!0;d.post("?module=deal&action=ownerDelete",l,function(n){"ok"==n.status&&(c.remove(),m.fadeIn())},"json").always(function(){f.remove_is_locked=!1})}var f=this,g=c.data("id"),
h=d.trim(c.find(".c-name").html());d.crm.confirm.show({title:f.locales.remove_owner_title,text:f.locales.remove_owner_text.replace(/%s/,h),button:f.locales.remove_owner_button,onConfirm:function(){e(g,f.deal_id)}})};CRMDeal.prototype.removeContact=function(c){function e(l,k,m){l={contact_id:l,deal_id:k,role_id:m};f.remove_is_locked=!0;d.post("?module=deal&action=contactDelete",l,function(n){"ok"==n.status&&c.remove()},"json").always(function(){f.remove_is_locked=!1})}var f=this,g=c.data("id"),h=d.trim(c.find(".c-name").html());
d.crm.confirm.show({title:f.locales.remove_contact_title,text:f.locales.remove_contact_text.replace(/%s/,h),button:f.locales.remove_contact_button,onConfirm:function(){e(g,f.deal_id,c.data("role-id"))}})};CRMDeal.prototype.initAssignTags=function(){var c=this.$wrapper.find(".js-assign-tags"),e=d.crm.app_url+"?module=dealOperation&action=assignTags&is_assign=1",f=parseInt(this.deal_id)||0;c.click(function(g){g.preventDefault();d.get(e,{deal_ids:[f]},function(h){new CRMDialog({html:h})})})};CRMDeal.prototype.initOrderEditShippingDetailLink=
function(){var c=this;c.$wrapper.find(".js-order-edit-shipping-details-link").click(function(){var e=d(this).parent().find(".js-order-edit-shipping-details-loading");e.show();c.loadEditOrderShippingDetailsDialog(c.order_id,{onLoad:function(){e.hide()}})})};CRMDeal.prototype.initCreateOrderLink=function(){var c=this;c.$wrapper.on("click",".js-create-order-link",function(e){e.preventDefault();if(c.shop_in_welcome_stage)d.crm.alert.show({title:c.locales.shop_alert_title||"",text:c.locales.shop_in_welcome_stage||
""});else{var f=d(this);f.addClass("is-loading");c.loadEditOrderDialog(0,{onLoad:function(){f.removeClass("is-loading")}})}})};CRMDeal.prototype.initEditOrderLink=function(){var c=this;c.$wrapper.on("click",".js-edit-order-link",function(e){e.preventDefault();if(c.shop_in_welcome_stage)d.crm.alert.show({title:c.locales.shop_alert_title||"",text:c.locales.shop_in_welcome_stage||""});else{var f=d(this);f.addClass("is-loading");c.loadEditOrderDialog(c.order_id,{onLoad:function(){f.removeClass("is-loading")}})}})};
CRMDeal.prototype.loadEditOrderDialog=function(c,e){var f=this.deal||{},g=d(this.templates.create_order_dialog_html),h=e.onLoad||function(){};g.hide();new CRMDialog({html:g,onOpen:function(){var l=this,k=d.crm.backend_url+"shop/?module=order&action=embededit",m=g.find(".crm-dialog-content");0<f.contact_id&&(k+="&customer_id="+f.contact_id);0<c&&(k+="&id="+c);m.html('<iframe src="'+k+'" class="c-content-iframe">');var n=m.find("iframe");n.one("load",function(){h();l.show();l.resize();var p=n.get(0);
d(p.contentWindow.document).find("#order-edit-form").append('<input type="hidden" name="crm_deal[id]" value="'+f.id+'">');p.contentWindow.$.order_edit.container.on("order_edit_save_success",function(){l.close();d.crm.content.reload()})})}})};CRMDeal.prototype.loadEditOrderShippingDetailsDialog=function(c,e){if(0>=c)console.error("Invalid input parameter");else{var f=this.$wrapper.find(".js-deal-edit-order-shipping-details-dialog").clone(),g=e.onLoad||function(){};f.hide();new CRMDialog({html:f,onOpen:function(){var h=
this,l=d.crm.backend_url+"shop/?module=workflow&action=prepare",k=f.find(".crm-dialog-content");d.post(l,{action_id:"editshippingdetails",id:c},function(m){k.html(m);k.find(".js-form-footer-actions").hide();h.show();h.resize();m=k.find("#wf-ship-form").height();f.find(".crm-dialog-block").height(m+150);var n=f.find(".js-submit-dialog-loading"),p=k.find(".js-form-footer-actions .js-submit-button");f.find(".js-submit-dialog-button").on("click",function(q){q.preventDefault();if(p.is(":disabled"))return!1;
k.bind("formSend",function(){n.hide();h.close();d.crm.content.reload()});n.show();p.trigger("click")});g&&g()})}})}};return CRMDeal}(jQuery),CRMDealChangeWorkflowDialog=function(d){CRMDealChangeWorkflowDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form").first();this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMDealChangeWorkflowDialog.prototype.initClass=function(){var a=this;a.$wrapper.find(".js-form-footer-actions").hide();a.$wrapper.on("click",".js-submit-dialog-button",
function(){a.$form.find(".js-submit-button").trigger("click")});a.$form.on("formSend",function(){if(a.dialog.options&&a.dialog.options.onShopSubmit)a.dialog.options.onShopSubmit();a.dialog.close()})};return CRMDealChangeWorkflowDialog}(jQuery);var CRMDealCloseDialog=function(d){CRMDealCloseDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$reasonSelect=this.$wrapper.find(".js-reason-select");this.$reasonFieldW=this.$wrapper.find(".js-reason-text");this.dialog=this.$wrapper.data("dialog");this.deal_id=a.deal_id;this.reason_require=a.reason_require;this.is_locked=!1;this.initClass()};CRMDealCloseDialog.prototype.initClass=function(){var a=this;a.$wrapper.on("click",".js-set-won",function(b){b.preventDefault();
a.setWon()});a.$wrapper.on("click",".js-show-form",function(b){b.preventDefault();a.showLostForm()});a.$wrapper.on("click",".js-set-lost",function(b){b.preventDefault();a.$form.trigger("submit")});a.$form.on("submit",function(b){b.preventDefault();a.setLost()});a.$reasonSelect.on("change",function(){d(this).val()?a.$reasonFieldW.hide():a.$reasonFieldW.show()})};CRMDealCloseDialog.prototype.showLostForm=function(a){var b=this.$wrapper.find(".c-visible"),c=this.$wrapper.find(".c-hidden");a?(b.show(),
c.hide()):(b.hide(),c.show());this.dialog.resize()};CRMDealCloseDialog.prototype.setWon=function(){var a=this;if(!a.is_locked){a.is_locked=!0;var b={id:a.deal_id,action:"WON"};d.post("?module=deal&action=close",b,function(c){"ok"===c.status&&a.afterRequest("?module=deal&action=close",b,c)}).always(function(){a.is_locked=!1})}};CRMDealCloseDialog.prototype.setLost=function(){function a(){var e=b.$form.serializeArray();e.push({name:"id",value:b.deal_id});e.push({name:"action",value:"LOST"});if(b.reason_require&&
!b.$reasonSelect.val())if(b.$reasonFieldW.is(":visible")){var f=b.$reasonFieldW.find("input");f.val()||(f.addClass("error").one("focus",function(){d(this).removeClass("error")}),e=!1)}else b.$reasonSelect.addClass("error").one("change",function(){d(this).removeClass("error")}),e=!1;return e}var b=this;if(!b.is_locked){b.is_locked=!0;var c=a();c?d.post("?module=deal&action=close",c,function(e){"ok"===e.status&&b.afterRequest("?module=deal&action=close",c,e)}).always(function(){b.is_locked=!1}):b.is_locked=
!1}};CRMDealCloseDialog.prototype.afterRequest=function(a,b,c){function e(){f.dialog.close();d.crm.content.reload()}var f=this;c.data.dialog_html&&c.data.dialog_html.html?new CRMDialog({html:c.data.dialog_html.html,onOpen:function(g){var h=g.find("form");h.length&&!d.isEmptyObject(b)&&d.each(b,function(l,k){h.append('<input type="hidden" name="crm_change_workflow_data['+k.name+']" value="'+k.value+'">')})},options:{onShopSubmit:e},onConfirm:function(){b.push({name:"force_execute",value:1});d.post(a,
b,e)}}):e()};return CRMDealCloseDialog}(jQuery);var CRMDealEdit=function(d){CRMDealEdit=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("#js-deal-edit-form");this.$deal_name_input=this.$form.find('[name="deal[name]"]');this.deal_id=a.deal_id;this.locales=a.locales;this.urls=a.urls;this.can_edit_contact=a.can_edit_contact||!1;this.suggester_values={};this.contact_mode=a.contact_mode||"edit";this.initClass()};CRMDealEdit.prototype.initClass=function(){this.initChangeCompanyContact();this.initEstimatedDate();this.initSuggestName();
this.initChangeFunnel();this.initWYSIWYG();this.initFieldsBlock();this.initSave();this.initCombobox()};CRMDealEdit.prototype.initEstimatedDate=function(){function a(){var f=d.datepicker._defaults.dateFormat,g=!1;try{d.datepicker.parseDate(f,c.val()),g=!0}catch(h){}g?(c.data("last-correct-value",c.val()),e.data("last-correct-value",e.val())):(c.val(c.data("last-correct-value")||""),e.val(e.data("last-correct-value")||""))}var b=this.$wrapper.find(".c-estimated-close-date-field").find(".js-datepicker-wrapper"),
c=b.find(".js-datepicker"),e=b.find('[name="deal[expected_date]"]');c.datepicker({altField:e,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,onSelect:a});c.on("blur",a);c.on("keydown keypress keyup",function(f){13===f.which&&f.preventDefault()});c.on("click",".js-icon",function(){c.focus()})};CRMDealEdit.prototype.initSave=function(){function a(){for(var n={data:[],errors:[]},p=h.serializeArray(),q=0;q<p.length-1;q++)for(var r=q+1;r<p.length;r++)p[q].name==p[r].name&&(""==p[q].value?p.splice(q,
1):""==p[r].value&&p.splice(r,1));d.each(p,function(t,u){t=d('[name="'+u.name+'"]');var v=0<d('[name="'+u.name+'"][type="radio"]').length,w=""==u.value||""==u.value.trim();1==d(t).prop("required")&&w&&n.errors.push({name:u.name,value:g.locales.bad_amount,is_radio:v});"deal[amount]"===u.name&&(u.value.length&&(u.value=d.trim(u.value)),v=u.value,t=!1,v.length&&(v=v.replace(",","."),0<v||"0"===v)&&(t=!0),t||n.errors.push({name:u.name,value:g.locales.bad_amount}));n.data.push(u)});"edit"===g.contact_mode?
g.can_edit_contact&&e(n):f(n);return n}function b(n){n&&n[0]||(n=[]);d.each(n,function(p,q){p=q.name;var r=q.value;if(q=q.is_radio)var t=g.$wrapper.find('[name="'+p+"\"][type='hidden']"),u=g.$wrapper.find('[name="'+p+"\"][type='radio']");else t=g.$wrapper.find('[name="'+p+'"]');"contact[firstname]"!==p||t.is(":visible")||(t=g.$wrapper.find(".js-contact-autocomplete"));var v=d("<span class='c-error' />").addClass("errormsg").text(r);if(t.length&&!t.hasClass("error"))if(t.parent().append(v),t.addClass("error"),
q)u.one("focus click change",function(){t.removeClass("error");v.remove()});else t.one("focus click change",function(){t.removeClass("error");v.remove()});else l.append(v),h.one("submit",function(){v.remove()})})}function c(n){if(!m){m=!0;var p=d.crm.app_url+"?module=deal&action=save";k.attr("disabled","disabled").prop("disabled",!0);var q=g.$wrapper.find(".loading");q.show();d.post(p,n,function(r){"ok"===r.status?d.crm.content.load(d.crm.app_url+"deal/"+r.data.deal.id+"/"):r.errors&&b(r.errors)},
"json").always(function(){q.hide();m=!1;k.removeAttr("disabled").prop("disabled",!1)})}}function e(n){var p=g.$wrapper.find("#c-contact-edit-form").closest("form"),q=p.find(".js-phone-list"),r=p.find(".js-email-list");p=p.serializeArray();var t=["contact[firstname]","contact[middlename]","contact[lastname]","contact[name]"],u=!0;d.each(p,function(v,w){n.data.push({name:w.name,value:w.value});0<d.trim(w.value).length&&0<=t.indexOf(w.name)&&(u=!1)});u&&(n.errors.push({name:"contact[firstname]",value:g.locales.empty_name}),
n.errors.push({name:"contact[name]",value:g.locales.empty_name}));q.find("li").each(function(v){var w=d(this),x=w.find(".js-value");w=w.find(".js-ext");var y=x.val(),z=w.val();if(y){var A="contact[phone]["+v+"][value]";x.attr("name",A);n.data.push({name:A,value:y});v="contact[phone]["+v+"][ext]";w.attr("name",v);n.data.push({name:v,value:z})}});r.find("li").each(function(v){var w=d(this),x=w.find(".js-value");w=w.find(".js-ext");var y=x.val(),z=w.val();if(y){var A="contact[email]["+v+"][value]";x.attr("name",
A);n.data.push({name:A,value:y});v="contact[email]["+v+"][ext]";w.attr("name",v);n.data.push({name:v,value:z})}});return n}function f(n){var p=g.$wrapper.find("#c-contact-add-form").closest("form").serializeArray(),q=!1,r=!1;d.each(p,function(t,u){t=u.name;var v=u.value;"deal[contact_id]"===t&&v&&(q=!0);"contact[firstname]"===t&&v&&(r=!0);"contact[lastname]"===t&&v&&(r=!0);"contact[middlename]"===t&&v&&(r=!0);"contact[name]"===t&&v&&(r=!0);n.data.push(u)});q||r||(n.errors.push({name:"contact[name]",
value:g.locales.empty_name}),n.errors.push({name:"contact[firstname]",value:g.locales.empty_name}))}var g=this,h=g.$form,l=g.$form.find(".js-errors-place"),k=g.$wrapper.find(".js-submit-button"),m=!1;k.on("click",function(){h.trigger("submit")});h.on("submit",function(n){n.preventDefault();n=a();n.errors.length?b(n.errors):c(n.data)})};CRMDealEdit.prototype.initSuggestName=function(){var a=this,b=a.$form,c=a.$deal_name_input;if(!c.data("edited")){c.one("mark-edited.crm-deal-suggestion",function(){c.data("edited",
1);c.off(".crm-deal-suggestion");b.off(".crm-deal-suggestion",".js-crm-deal-name-suggester-input")});c.on("keyup.crm-deal-suggestion",function(){var h=d(this);0<d.trim(h.val()).length&&h.trigger("mark-edited")});var e=null,f=null,g=function(){e&&(e.abort(),e=null);c.data("edited")||(e=d.post(d.crm.app_url+"?module=deal&action=suggestName",a.suggester_values,function(h){"ok"!==h.status||c.data("edited")||c.val(d.trim(h.data&&h.data.name)||"")}))};b.on("keyup.crm-deal-suggestion change.crm-deal-suggestion",
".js-crm-deal-name-suggester-input",function(h){var l=d(this);f&&clearTimeout(f);f=setTimeout(function(){if(l.hasClass("crm-find-contact-input")){if("keyup"===h.type)return;l=b.find('[name="deal[id]"]')}var k=l.attr("name")||"",m=d.trim(l.val());if(k){a.suggester_values[k]=d.trim(a.suggester_values[k]);if(a.suggester_values[k]===m)return;a.suggester_values[k]=m}g()},250)})}};CRMDealEdit.prototype.initChangeCompanyContact=function(){var a=this,b=a.$wrapper.find(".js-contact-block"),c=b.find(".js-view-toggle"),
e=c.find(".is-active");c.on("click",".c-toggle",function(f){f.preventDefault();f=d(this);var g=f.data("id");if(f.hasClass("is-active"))return!1;a.contact_mode=g;e.length&&e.removeClass("is-active");f.addClass("is-active");e=f;b.find(".c-hidden.is-active").removeClass("is-active");b.find(".c-hidden-"+g).addClass("is-active")})};CRMDealEdit.prototype.initChangeFunnel=function(){var a=this;a.$form.on("change",".js-select-deal-funnel",function(){a.$form.find(".js-select-stage-wrapper").load("?module=deal&action=stagesByFunnel&id="+
d(this).val())})};CRMDealEdit.prototype.initWYSIWYG=function(){var a=this.$wrapper.find(".js-wysiwyg");if(!a.length)return!1;d.crm.initWYSIWYG(a,{keydownCallback:function(b){}})};CRMDealEdit.prototype.initFieldsBlock=function(){var a=this.$wrapper.find(".js-ext-fields-section");a.on("click",".js-ext-fields-toggle",function(){a.toggleClass("is-extended");d(".js-show-fields-button, .js-hide-fields-button").removeAttr("style")})};CRMDealEdit.prototype.initCombobox=function(){function a(f){f?c.addClass("is-shown"):
c.removeClass("is-shown")}var b=this,c=b.$form.find(".js-contact-owner-wrapper"),e=c.find(".js-field");c.on("click",".js-show-combobox",function(f){f.stopPropagation();a(!0)});c.on("click",".js-hide-combobox",function(f){f.stopPropagation();a(!1)});(function(){var f=c.find(".js-autocomplete");f.autocomplete({appendTo:c,position:{my:"right top",at:"right bottom"},source:b.urls.owner_autocomplete,minLength:0,html:!0,focus:function(){return!1},select:function(g,h){g=h.item;h=c.find(".js-user");g.photo_url&&
h.find(".userpic20").css("background-image","url("+g.photo_url+")");h.find(".c-name").text(g.name);e.val(g.id);a(!1);f.val("");return!1}}).data("ui-autocomplete")._renderItem=function(g,h){return d("<li />").addClass("ui-menu-item-html").append("<div>"+h.value+"</div>").appendTo(g)};f.on("focus",function(){f.data("uiAutocomplete").search(f.val())})})()};return CRMDealEdit}(jQuery);var CRMDealChangeClient=function(d){CRMDealChangeClient=function(a){this.$wrapper=a.$wrapper;this.dialog=this.$wrapper.data("dialog");this.deal_id=a.deal_id;this.contact_id=a.contact_id;this.type=a.type;this.can_edit_contact=a.can_edit_contact||!1;this.initClass()};CRMDealChangeClient.prototype.initClass=function(){this.initViewToggle();this.can_edit_contact&&this.initContactChangeData();this.initSwitchContact()};CRMDealChangeClient.prototype.initViewToggle=function(){var a=this,b=a.$wrapper.find(".js-view-toggle"),
c=b.find(".is-active");b.on("click",".c-toggle",function(e){e.preventDefault();e=d(this);var f=e.data("id");if(e.hasClass("is-active"))return!1;c.length&&c.removeClass("is-active");e.addClass("is-active");c=e;a.$wrapper.find(".c-hidden.is-active").removeClass("is-active");a.$wrapper.find(".c-hidden-"+f).addClass("is-active");a.dialog.resize()})};CRMDealChangeClient.prototype.initContactChangeData=function(){function a(){var m=g.serializeArray(),n={data:[],errors:[]},p=["contact[firstname]","contact[middlename]",
"contact[lastname]","contact[name]"],q=!0;d.each(m,function(r,t){n.data.push({name:t.name,value:t.value});0<d.trim(t.value).length&&0<=p.indexOf(t.name)&&(q=!1)});q&&(n.errors.push({name:"contact[firstname]",value:"Name is empty"}),n.errors.push({name:"contact[name]",value:"Name is empty"}));l.find("li").each(function(r){var t=d(this),u=t.find(".js-value");t=t.find(".js-ext");var v=u.val(),w=t.val();if(v){var x="contact[phone]["+r+"][value]";u.attr("name",x);n.data.push({name:x,value:v});r="contact[phone]["+
r+"][ext]";t.attr("name",r);n.data.push({name:r,value:w})}});k.find("li").each(function(r){var t=d(this),u=t.find(".js-value");t=t.find(".js-ext");var v=u.val(),w=t.val();if(v){var x="contact[email]["+r+"][value]";u.attr("name",x);n.data.push({name:x,value:v});r="contact[email]["+r+"][ext]";t.attr("name",r);n.data.push({name:r,value:w})}});n.data.push({name:"deal_id",value:e.deal_id});return n}function b(m){d.post(e.contact_id?"?module=deal&action=contactUpdate":"?module=contact&action=save",m,function(n){"ok"==
n.status?(e.dialog.options.onChange(n.data.html),e.dialog.close()):n.errors&&c(n.errors)},"json").always(function(){h=!1})}function c(m){m=m?m:[];d.each(m,function(n,p){n=p.name;p=p.value;"contact[name]"===n&&(n="contact[firstname]");var q=g.find('[name="'+n+'"]'),r=d("<span />").addClass("errormsg").text(p);q.length?q.hasClass("error")||(q.parent().append(r),q.addClass("error").one("focus click",function(){q.removeClass("error");r.remove()})):(f.append(r),g.one("submit",function(){r.remove()}))})}
var e=this,f=e.$wrapper.find(".js-errors-place"),g=e.$wrapper.find("#c-contact-edit-form").closest("form"),h=!1,l=g.find(".js-phone-list"),k=g.find(".js-email-list");e.$wrapper.on("click",".js-save-changed-data",function(m){m.preventDefault();g.trigger("submit")});g.on("submit",function(m){m.preventDefault();h||(h=!0,m=a(),m.errors.length?(c(m.errors),h=!1):b(m.data))})};CRMDealChangeClient.prototype.initSwitchContact=function(){function a(h){h=h?h:[];d.each(h,function(l,k){l=k.name;k=k.value;"contact[name]"===
l&&(l="contact[firstname]");var m=f.find('[name="'+l+'"]'),n=d("<span />").addClass("errormsg").text(k);m.length?m.hasClass("error")||(m.parent().append(n),m.addClass("error").one("focus click",function(){m.removeClass("error");n.remove()})):(e.append(n),c.$wrapper.one("click",".js-switch-contact",function(){n.remove()}))})}function b(h){g||(g=!0,h.push({name:"deal_id",value:c.deal_id}),d.post("?module=deal&action=personUpdate",h,function(l){"ok"===l.status?(c.dialog.options.onChange(l.data),c.dialog.close()):
l.errors&&a(l.errors)}).always(function(){g=!1}))}var c=this,e=c.$wrapper.find(".js-errors-place"),f=c.$wrapper.find("#c-contact-add-form").closest("form"),g=!1;c.$wrapper.on("click",".js-switch-contact",function(h){h.preventDefault();h=f.serializeArray();var l=[];l.length?a(l):b(h)})};return CRMDealChangeClient}(jQuery);var CRMDealsFunnel=function(d){CRMDealsFunnel=function(a){this.$wrapper=a.$wrapper;this.$header=this.$wrapper.find("#js-funnel-header");this.$actionsHeader=this.$wrapper.find("#js-actions-header");this.$tableContent=this.$wrapper.find(".js-table-content");this.funnel_id=a.funnel_id;this.locales=a.locales;this.selected_deals=[];this.initClass()};CRMDealsFunnel.prototype.initClass=function(){this.initFixedHeader();this.initDealsMove();this.initMassiveActionsHeader();this.initMassActions()};CRMDealsFunnel.prototype.initFixedHeader=
function(){function a(){if(d.contains(document,e[0])){var m=c.scrollTop();h.top<m?g||(g=!0,f=d("<div />"),f.height(k).insertAfter(e),e.width(l).addClass("is-fixed-to-top")):b()}else c.off("scroll",a)}function b(){f&&f.length&&f.remove();f=!1;e.removeAttr("style").removeClass("is-fixed-to-top");l=e.width();k=e.height();g=!1}var c=d(window),e=this.$header,f=!1,g=!1,h=e.offset(),l=e.width(),k=e.height();c.on("scroll",a);c.on("resize",function(){b();c.trigger("scroll")})};CRMDealsFunnel.prototype.initDealsMove=
function(){function a(g,h,l,k){function m(){d.crm.content.reload()}if(!b){b=!0;var n=l.closest(".js-drop-area");e.draggable("disable");l.addClass("is-loading").removeAttr("style").prependTo(k);d.post("?module=deal&action=move",{deal_id:g,stage_id:h},function(p){"ok"===p.status&&(p.data.dialog_html&&p.data.dialog_html.html?new CRMDialog({html:p.data.dialog_html.html,options:{onShopSubmit:m},onCancel:function(){l.removeClass("is-loading").prependTo(n)},onConfirm:function(){d.post("?module=deal&action=move",
{deal_id:g,stage_id:h,force_execute:1},m)}}):m())},"json").always(function(){e.draggable("enable");b=!1})}}var b=!1,c=!1,e=this.$wrapper.find(".c-deal-wrapper"),f=this.$wrapper.find(".js-drop-area");e.draggable({handle:".js-drag-toggle",revert:!0,start:function(){var g=d(this),h=g.closest(".js-drop-area");g.data("stage-index",h.index()).data("stage-id",h.data("id")).draggable("option","revert",!0);c=h.addClass("is-wrapper")}});f.droppable({tolerance:"pointer",drop:function(g,h){g=d(this);h=d(h.draggable);
var l=g.data("id"),k=h.data("stage-id"),m=h.data("id");k!==l&&(h.draggable("option","revert",!1),a(m,l,h,g));c.length&&(c.removeClass("is-wrapper"),c=!1)}})};CRMDealsFunnel.prototype.initMassiveActionsHeader=function(){function a(){if(d.contains(document,f[0]))if(c.selected_deals.length){f.hasClass("is-hidden")&&f.removeClass("is-hidden");var n=e.scrollTop();l.top+m>n+e.height()?h||(h=!0,g=d("<div />"),g.height(m).insertAfter(f),f.width(k).addClass("is-fixed-to-bottom")):b()}else b(),f.hasClass("is-hidden")||
f.addClass("is-hidden");else e.off("scroll",a)}function b(){g&&g.length&&g.remove();g=!1;f.removeAttr("style").removeClass("is-fixed-to-bottom");k=f.width();m=f.height();h=!1}var c=this,e=d(window),f=c.$actionsHeader,g=!1,h=!1,l=f.offset(),k=f.width(),m=f.height();e.on("scroll",a);e.on("resize",function(){b();e.trigger("scroll")})};CRMDealsFunnel.prototype.initMassActions=function(){function a(l){l.find(".js-check-deal").is(":checked")?(l.addClass("is-active"),h.push(l[0])):(l.removeClass("is-active"),
l=h.indexOf(l[0]),h.splice(l,1));b();d(window).trigger("scroll")}function b(){function l(){var p=c("open"),q=f.find(".js-deals-close").closest(".c-action"),r=q.find(".js-open-count");p.length?(r.text(p.length),q.show()):q.hide()}function k(){var p=f.find(".js-deals-merge").closest(".c-action");1<h.length?p.show():p.hide()}function m(){var p=!1;d(h).each(function(){if(d(this).data("can-delete"))return p=!0,!1});var q=f.find(".js-deals-delete").closest(".c-action");p?q.show():q.hide()}var n=h.length;
0<h.length&&(f.find(".js-count").text(n),l(),k(),m())}function c(l){var k=[];d.each(h,function(m,n){m=d(n);n=m.data("id");(!l||m.data(l))&&n&&k.push(n)});return k}var e=this,f=e.$actionsHeader,g=f.find(".js-checkbox-all"),h=e.selected_deals;e.$wrapper.on("click",".js-deal-wrapper",function(l){l=d(l.target);var k=!(!l.is("a")&&!l.closest("a").length);l=l.is(":checkbox");if(!k){k=d(this);var m=k.find(".js-check-deal");l||m.attr("checked",!m.is(":checked"));a(k)}});e.$tableContent.find(".js-state-column").shiftSelectable({selector:".js-deal-wrapper",
onSelect:function(l,k){var m=d(k.target);m=!(!m.is("a")&&!m.closest("a").length);var n=k.extra.is_first;k=k.extra.is_last;m||n||k||(l.find(".js-check-deal").attr("checked",!0),a(l))}});g.on("change",function(){var l=d(this).is(":checked");e.$wrapper.find(".js-deal-wrapper").each(function(){var k=d(this),m=k.find(".js-check-deal");m.is(":checked")!==l&&(m.attr("checked",l),a(k))})});f.on("click",".js-deals-merge",function(l){l.preventDefault();l=c();l=d.crm.app_url+"deal/merge/?ids="+l.join(",");d.crm.content.load(l)});
(function(){var l=!1;f.on("click",".js-deals-delete",function(k){k.preventDefault();d.crm.confirm.show({title:e.locales.delete_confirm_title.replace("%s",h.length),text:e.locales.delete_confirm_text,button:e.locales.delete_confirm_button,onConfirm:function(m){function n(){var t=[],u=c();d.each(u,function(v,w){t.push({name:"id[]",value:w})});return t}function p(){var t=h.map(function(u){return u});d.each(t,function(u,v){u=d(v);u.find(".js-check-deal").attr("checked",!1).trigger("change");u.remove()})}
if(!l){l=!0;var q=d.crm.app_url+"?module=deal&action=delete",r=n();d.post(q,r,function(t){"ok"===t.status&&(p(),m.close(),d.crm.content.reload(),d.crm.sidebar.reload())}).always(function(){l=!1})}return!1}})})})();(function(){var l=!1;f.on("click",".js-deals-change-responsible",function(k){k.preventDefault();l||(l=!0,k={ids:c().join(",")},d.post("?module=deal&action=changeResponsible",k,function(m){new CRMDialog({html:m})}).always(function(){l=!1}))})})();(function(){var l=!1;f.on("click",".js-deals-close",
function(k){k.preventDefault();l||(l=!0,k={ids:c("open").join(",")},d.post("?module=deal&action=massClose",k,function(m){new CRMDialog({html:m})}).always(function(){l=!1}))})})();(function(){var l=!1;f.on("click",".js-deals-change-funnel",function(k){k.preventDefault();l||(l=!0,k={deal_ids:c().join(",")},d.post("?module=deal&action=changeFunnel",k,function(m){new CRMDialog({html:m})}).always(function(){l=!1}))})})();(function(){var l=!1;f.on("click",".js-deals-export",function(k){k.preventDefault();
l||(l=!0,k=c(),d.post(d.crm.app_url+"?module=deal&action=export",{ids:k},function(m){new CRMDialog({html:m})}).always(function(){l=!1}))})})();(function(){var l=!1;f.on("click",".js-deals-set-tags",function(k){k.preventDefault();if(!l){l=!0;k=c();var m=d.crm.app_url+"?module=dealOperation&action=assignTags",n={deal_ids:k};1===k.length&&(n.is_assign=1);d.post(m,n,function(p){new CRMDialog({html:p})}).always(function(){l=!1})}})})()};return CRMDealsFunnel}(jQuery),CRMDealsList=function(d){CRMDealsList=
function(a){this.$wrapper=a.$wrapper;this.$tableWrapper=this.$wrapper.find(".js-deals-table-wrapper");this.$tableHeaderW=this.$wrapper.find(".js-table-header-wrapper");this.$tableHeader=this.$wrapper.find(".js-table-header");this.$tableActions=this.$wrapper.find(".js-table-actions");this.$tableBody=this.$wrapper.find("#c-table-body");this.funnel_id=a.funnel_id;this.stage_id=a.stage_id;this.contact_id=a.contact_id;this.offset=a.offset;this.locales=a.locales;this.limit=a.limit;this.initClass()};CRMDealsList.prototype.initClass=
function(){this.initLazy();this.initElasticHeader();this.initMassActions()};CRMDealsList.prototype.initLazy=function(){function a(){if(d.contains(document,g[0])){var l=d(window).scrollTop(),k=e.height(),m=g.offset().top;l+k>=m&&(h||b())}else e.off("scroll",a)}function b(){var l={offset:g.data("offset")};c.stage_id&&(l.stage=c.stage_id);c.contact_id&&(l.user=c.contact_id);h=!0;d.post("?module=deal&action=list",l,function(k){var m=d(k).find(".js-lazyload");m.length?(c.limit+=l.offset,m.insertAfter(g),
g.remove(),g=m):g.remove();d(k).find(".c-deal-wrapper").insertAfter(f.find("tr:last"))}).always(function(){h=!1})}var c=this,e=d(window),f=c.$tableBody,g=c.$wrapper.find(".js-lazyload"),h=!1;g.length&&(e.on("scroll",a),g.offset().top<e.height()&&e.trigger("scroll"))};CRMDealsList.prototype.initElasticHeader=function(){function a(){d.contains(document,e[0])?b.scrollTop()>f.top?e.css({left:f.left}).width(c.outerWidth()).addClass("is-fixed"):e.removeAttr("style").removeClass("is-fixed"):b.off("scroll",
a)}var b=d(window),c=this.$tableWrapper,e=this.$tableHeaderW,f=c.offset();b.on("scroll",a)};CRMDealsList.prototype.initMassActions=function(){function a(n){n.find(".js-check-deal").prop("checked",!0).trigger("change",[!0])}function b(n){n.find(".js-check-deal").prop("checked",!1).trigger("change",[!1])}function c(n){n.find(".js-check-deal").is(":checked")?(n.addClass("is-active"),h.push(n[0])):(n.removeClass("is-active"),n=h.indexOf(n[0]),h.splice(n,1));e()}function e(){function n(){var t=f("open"),
u=k.find(".js-deals-close").closest(".c-operation-li"),v=u.find(".js-open-count");t.length?(v.text(t.length),u.show()):u.hide()}function p(){var t=k.find(".js-deals-merge").closest(".c-operation-li");1<h.length?t.show():t.hide()}function q(){var t=!1;d(h).each(function(){if(d(this).data("can-delete"))return t=!0,!1});var u=k.find(".js-deals-delete").closest(".c-operation-li");t?u.show():u.hide()}var r=h.length;0<r?(l.hide(),k.show().find(".js-count").text(r),n(),p(),q(),r<g.limit?m.prop("indeterminate",
!0):m.prop("indeterminate",!1).prop("checked",!0)):(l.show(),k.hide(),m.prop("indeterminate",!1).prop("checked",!1))}function f(n){var p=[];d.each(h,function(q,r){q=d(r);r=q.data("id");(!n||q.data(n))&&r&&p.push(r)});return p}var g=this,h=[],l=g.$tableHeader,k=g.$tableActions,m=g.$tableHeaderW.find(".js-checkbox-all");g.$tableBody.on("click",".js-deal-wrapper",function(n){n=d(n.target);var p=d(this),q=p.find(".js-check-deal");q.closest("td");var r=!(!n.is("a")&&!n.closest("a").length),t=!(!n.is(".c-column-checkbox")&&
!n.closest(".c-column-checkbox").length);if(n.is(":checkbox"))return c(p),!0;if(r)return!0;t&&(q.attr("checked",!q.is(":checked")),c(p))});g.$tableBody.shiftSelectable({selector:".js-deal-wrapper",onSelect:function(n,p){var q=d(p.target);q=!(!q.is("a")&&!q.closest("a").length);var r=p.extra.is_first;p=p.extra.is_last;q||r||p||(n.find(".js-check-deal").attr("checked",!0),c(n))}});m.on("change",function(){var n=d(this).is(":checked"),p=g.$wrapper.find(".js-deal-wrapper"),q=p.find(".js-check-deal").filter(":checked").length;
0<q?q<g.limit||q===g.limit?b(p):a(p):n?a(p):b(p);p.each(function(){c(d(this))})});k.on("click",".js-deals-merge",function(n){n.preventDefault();n=f();n=d.crm.app_url+"deal/merge/?ids="+n.join(",");d.crm.content.load(n)});(function(){var n=!1;k.on("click",".js-deals-delete",function(p){p.preventDefault();d.crm.confirm.show({title:g.locales.delete_confirm_title.replace("%s",h.length),text:g.locales.delete_confirm_text,button:g.locales.delete_confirm_button,onConfirm:function(q){function r(){var w=[],
x=f();d.each(x,function(y,z){w.push({name:"id[]",value:z})});return w}function t(){var w=h.map(function(x){return x});d.each(w,function(x,y){x=d(y);x.find(".js-check-deal").attr("checked",!1).trigger("change");x.remove()})}if(!n){n=!0;var u=d.crm.app_url+"?module=deal&action=delete",v=r();d.post(u,v,function(w){"ok"===w.status&&(t(),q.close(),l.show(),k.hide(),m.prop("indeterminate",!1).prop("checked",!1),d.crm.content.reload(),d.crm.sidebar.reload())}).always(function(){n=!1})}return!1}})})})();
(function(){var n=!1;k.on("click",".js-deals-change-responsible",function(p){p.preventDefault();n||(n=!0,p={ids:f().join(",")},d.post("?module=deal&action=changeResponsible",p,function(q){new CRMDialog({html:q})}).always(function(){n=!1}))})})();(function(){var n=!1;k.on("click",".js-deals-close",function(p){p.preventDefault();n||(n=!0,p={ids:f("open").join(",")},d.post("?module=deal&action=massClose",p,function(q){new CRMDialog({html:q})}).always(function(){n=!1}))})})();(function(){var n=!1;k.on("click",
".js-deals-change-funnel",function(p){p.preventDefault();n||(n=!0,p={deal_ids:f().join(",")},d.post("?module=deal&action=changeFunnel",p,function(q){new CRMDialog({html:q})}).always(function(){n=!1}))})})();(function(){var n=!1;k.on("click",".js-deals-export",function(p){p.preventDefault();n||(n=!0,p=f(),d.post(d.crm.app_url+"?module=deal&action=export",{ids:p},function(q){new CRMDialog({html:q})}).always(function(){n=!1}))})})();(function(){var n=!1;k.on("click",".js-deals-set-tags",function(p){p.preventDefault();
if(!n){n=!0;p=f();var q=d.crm.app_url+"?module=dealOperation&action=assignTags",r={deal_ids:p};1===p.length&&(r.is_assign=1);d.post(q,r,function(t){new CRMDialog({html:t})}).always(function(){n=!1})}})})()};return CRMDealsList}(jQuery),CRMDealsMergePage=function(d){CRMDealsMergePage=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$submitButton=this.$wrapper.find(".js-submit-button");this.$activeDeal=this.is_deal_set=!1;this.initClass()};CRMDealsMergePage.prototype.initClass=
function(){this.initSubmit();this.initSelectDeal()};CRMDealsMergePage.prototype.initSubmit=function(){function a(){function e(g){var h="";d.each(g,function(l,k){if("master_id"===k.name)return h=k.value,!1});return h}if(!c){c=!0;var f=b.serializeArray();d.post("?module=deal&action=mergeRun",f,function(g){g=d.crm.app_url+"deal/"+e(f)+"/";d.crm.content.load(g)},"json").always(function(){c=!1})}}var b=this.$form,c=!1;b.on("submit",function(e){e.preventDefault();a()})};CRMDealsMergePage.prototype.initSelectDeal=
function(){var a=this;a.$wrapper.on("change",".js-field",function(){var b=d(this);"checked"===b.attr("checked")&&(b=b.closest(".js-deal"),a.$activeDeal&&a.$activeDeal.removeClass("is-active"),a.$activeDeal=b.addClass("is-active"),a.is_deal_set||(a.$submitButton.attr("disabled",!1),a.is_deal_set=!0))});a.$wrapper.on("click",".js-deal",function(b){var c=d(this).find(".js-field"),e=c[0]==b.target;b=!!d(b.target).attr("href");e||b||c.trigger("click")})};return CRMDealsMergePage}(jQuery),CRMDealsChangeResponsibleDialog=
function(d){CRMDealsChangeResponsibleDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$submitButton=this.$wrapper.find(".js-submit-button");this.dialog=this.$wrapper.data("dialog");this.is_responsive_set=!1;this.initClass()};CRMDealsChangeResponsibleDialog.prototype.initClass=function(){this.initSubmit();this.initChangeResponsible()};CRMDealsChangeResponsibleDialog.prototype.initChangeResponsible=function(){var a=this,b=a.$wrapper.find(".js-users-list"),c=b.find(".js-visible-link"),
e=a.$wrapper.find(".js-user-field"),f=b.find(".menu-v");f.on("click","a",function(){var g=d(this),h=g.closest(".js-user");c.find(".js-text").html(g.html());f.find(".selected").removeClass("selected");h.addClass("selected");f.hide();setTimeout(function(){f.removeAttr("style")},200);g=h.data("id");e.val(g).trigger("change");a.is_responsive_set||(a.$submitButton.attr("disabled",!1),a.is_responsive_set=!0)})};CRMDealsChangeResponsibleDialog.prototype.initSubmit=function(){function a(){if(!e){e=!0;var f=
c.serializeArray();d.post("?module=deal&action=changeResponsibleRun",f,function(g){"ok"===g.status?(b.dialog.close(),d.crm.content.reload()):alert("errors")},"json").always(function(){e=!1})}}var b=this,c=b.$form,e=!1;c.on("submit",function(f){f.preventDefault();a()})};return CRMDealsChangeResponsibleDialog}(jQuery),CRMDealsCloseDialog=function(d){CRMDealsCloseDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$reasonSelect=this.$wrapper.find(".js-reason-select");
this.$reasonFieldW=this.$wrapper.find(".js-reason-text");this.dialog=this.$wrapper.data("dialog");this.deal_ids=a.deal_ids;this.reason_require=a.reason_require;this.is_locked=!1;this.initClass()};CRMDealsCloseDialog.prototype.initClass=function(){var a=this;a.$wrapper.on("click",".js-set-won",function(b){b.preventDefault();a.setWon()});a.$wrapper.on("click",".js-show-form",function(b){b.preventDefault();a.showLostForm()});a.$wrapper.on("click",".js-set-lost",function(b){b.preventDefault();a.$form.trigger("submit")});
a.$form.on("submit",function(b){b.preventDefault();a.setLost()});a.$reasonSelect.on("change",function(){d(this).val()?a.$reasonFieldW.hide():a.$reasonFieldW.show()})};CRMDealsCloseDialog.prototype.showLostForm=function(a){var b=this.$wrapper.find(".c-visible"),c=this.$wrapper.find(".c-hidden");a?(b.show(),c.hide()):(b.hide(),c.show());this.dialog.resize()};CRMDealsCloseDialog.prototype.setWon=function(){var a=this;if(!a.is_locked){a.is_locked=!0;var b={deal_ids:a.deal_ids.join(","),action:"WON"};
d.post("?module=deal&action=massCloseRun",b,function(c){"ok"==c.status&&(a.dialog.close(),d.crm.content.reload())}).always(function(){a.is_locked=!1})}};CRMDealsCloseDialog.prototype.setLost=function(){function a(){var e=b.$form.serializeArray();e.push({name:"deal_ids",value:b.deal_ids.join(",")});e.push({name:"action",value:"LOST"});if(b.reason_require&&!b.$reasonSelect.val())if(b.$reasonFieldW.is(":visible")){var f=b.$reasonFieldW.find("input");f.val()||(f.addClass("error").one("focus",function(){d(this).removeClass("error")}),
e=!1)}else b.$reasonSelect.addClass("error").one("change",function(){d(this).removeClass("error")}),e=!1;return e}var b=this;if(!b.is_locked){b.is_locked=!0;var c=a();c?d.post("?module=deal&action=massCloseRun",c,function(e){"ok"==e.status&&(b.dialog.close(),d.crm.content.reload())}).always(function(){b.is_locked=!1}):b.is_locked=!1}};return CRMDealsCloseDialog}(jQuery),CRMDealsChangeFunnelDialog=function(d){CRMDealsChangeFunnelDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");
this.dialog=this.$wrapper.data("dialog");this.funnels=a.funnels;this.stage_template_html=a.stage_template_html;this.initClass()};CRMDealsChangeFunnelDialog.prototype.initClass=function(){this.initChangeFunnel();this.initChangeStage();this.initSubmit();d.crm.renderSVG(this.$wrapper)};CRMDealsChangeFunnelDialog.prototype.initChangeFunnel=function(){function a(h){(h=b.funnels[h]||!1)&&c.trigger("changeFunnel",h)}var b=this,c=b.$wrapper.find(".js-funnels-list"),e=c.find(".js-visible-link"),f=c.find(".js-field"),
g=c.find(".menu-v");g.on("click","a",function(){var h=d(this);e.find(".js-text").html(h.html());g.find(".selected").removeClass("selected");h.closest("li").addClass("selected");g.hide();setTimeout(function(){g.removeAttr("style")},200);h=h.data("id");f.val(h).trigger("change");a(h)})};CRMDealsChangeFunnelDialog.prototype.initChangeStage=function(){function a(l){h.html("");d.each(l,function(k,m){k=b.stage_template_html;var n=d("<div />").text(m.name).html();k=k.replace("%id%",m.id).replace("%color%",
m.color).replace("%name%",n);m=d(k);h.append(m)});d.crm.renderSVG(e);h.find("li:first-child a").trigger("click")}var b=this,c=b.$wrapper.find(".js-funnels-list"),e=b.$wrapper.find(".js-funnel-stages-list"),f=e.find(".js-visible-link"),g=e.find(".js-field"),h=e.find(".menu-v");h.on("click","a",function(){var l=d(this);f.find(".js-text").html(l.html());h.find(".selected").removeClass("selected");l.closest("li").addClass("selected");h.hide();setTimeout(function(){h.removeAttr("style")},200);l=l.data("id");
g.val(l)});c.on("changeFunnel",function(l,k){a(k.stages)})};CRMDealsChangeFunnelDialog.prototype.initSubmit=function(){var a=this,b=a.$form,c=!1;b.on("submit",function(e){e.preventDefault();c||(c=!0,e=b.serializeArray(),d.post("?module=deal&action=changeFunnelRun",e,function(f){"ok"===f.status&&(a.dialog.close(),d.crm.content.reload())},"json").always(function(){c=!1}))})};return CRMDealsChangeFunnelDialog}(jQuery),CRMDealRemindersFilter=function(d){CRMDealRemindersFilter=function(a){this.$wrapper=
a.$wrapper;this.$menu=this.$wrapper.find(".js-hidden-list");this.$buttons=this.$menu.find(".js-buttons");this.apply_url_pattern=a.redirect_uri;this.filters=a.filters;this.selected_filters=a.selected_filters;this.redirect_uri=this.apply_url_pattern;this.selected_ids_before=Object.keys(this.selected_filters);this.initClass()};CRMDealRemindersFilter.prototype.initClass=function(){var a=this;a.$menu.on("change",".js-checkbox",function(){a.setItem(d(this))});a.$menu.on("click",".js-show-all",function(b){b.preventDefault();
a.$menu.find(".js-checkbox").attr("checked",!1).trigger("change");a.update()});a.$menu.on("click",".js-revert",function(b){b.preventDefault();a.$menu.find(".js-checkbox").each(function(){var c=d(this),e=c.closest(".c-item").data("id");console.log(e,0<=a.selected_ids_before.indexOf(e));c.attr("checked",0<=a.selected_ids_before.indexOf(e)).trigger("change")})});a.$menu.on("click",".js-submit",function(b){b.preventDefault();a.update()})};CRMDealRemindersFilter.prototype.setItem=function(a){var b=a.closest(".c-item"),
c=b.data("id"),e=!!this.selected_filters[c];(a=a.is(":checked"))?b.addClass("selected"):b.removeClass("selected");a?e||(this.selected_filters[c]=this.filters[c]):e&&delete this.selected_filters[c];this.setApplyUrl();this.watcher()};CRMDealRemindersFilter.prototype.watcher=function(){(function(a,b){var c=!0;a.length===b.length&&(c=!1,d.each(b,function(e,f){if(0<=a.indexOf(f))c=!1;else return c=!0,!1}));return c})(Object.keys(this.selected_filters),this.selected_ids_before)?this.$buttons.show():this.$buttons.hide()};
CRMDealRemindersFilter.prototype.setApplyUrl=function(){var a=Object.keys(this.selected_filters);this.redirect_uri=this.apply_url_pattern.replace("reminder=none",a.length?"reminder="+a.join("-"):"reminder=none")};CRMDealRemindersFilter.prototype.update=function(){d.crm.content.load(this.redirect_uri)};return CRMDealRemindersFilter}(jQuery);var CRMDealsExport=function(d){CRMDealsExport=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".js-save");this.$cancel=this.$wrapper.find(".crm-js-cancel");this.$download_file_form=this.$wrapper.find(".crm-download-file-form");this.ids=a.ids||[];this.url=d.crm.app_url+"?module=dealExport&action=process";this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMDealsExport.prototype.initClass=function(){this.initStartExport()};CRMDealsExport.prototype.initStartExport=function(){var a=
this,b=a.$cancel,c=null;a.$button.click(function(e){e.preventDefault();c=a.process()});b.click(function(e){e.preventDefault();c&&c.cancel()})};CRMDealsExport.prototype.process=function(){var a=this,b=a.url,c=a.$wrapper,e=null,f=null,g=0,h={};h.separator=c.find("[name=separator]").val();h.encoding=c.find("[name=encoding]").val();h.export_fields_name=c.find("[name=export_fields_name]").is(":checked")?1:0;h.not_export_empty_columns=c.find("[name=not_export_empty_columns]").is(":checked")?1:0;h.ids=[].concat(a.ids);
var l=function(){f&&clearTimeout(f);f=setTimeout(l,3200);!e||2<=g||(h.processId=e,d.post(b,h,function(k){g--;e&&k.ready&&(k=e)&&(f&&clearTimeout(f),e=f=null,a.$download_file_form.attr("action",a.url+"&processId="+k).appendTo("body").submit(function(){setTimeout(function(){a.$download_file_form.appendTo(a.$wrapper.find(".crm-dialog-content"));a.dialog.close()},200)}).submit())},"json"),g++)};a.$wrapper.find(".crm-start-block").hide();a.$wrapper.find(".crm-process-block").show();d.post(b,h,function(k){k.processId||
alert("Error processing request.");e=k.processId;l()},"json");return{cancel:function(){f&&clearTimeout(f);d.post(b,{processId:e,ready:1})}}};return CRMDealsExport}(jQuery);var CRMDealOperationAssignTags=function(d){CRMDealOperationAssignTags=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".js-save");this.$input=this.$wrapper.find(".crm-tags-input");this.context=a.context||{};this.dialog=this.$wrapper.data("dialog");this.default_text=this.$input.attr("placeholder");this.is_assign=a.is_assign||!1;this.initClass()};CRMDealOperationAssignTags.prototype.initClass=function(){this.initTagsInput();this.initPopularTags();this.initSave()};CRMDealOperationAssignTags.prototype.initTagsInput=
function(){var a=d.crm.app_url+"?module=contact&action=tags";this.$input.tagsInput({defaultText:this.default_text,width:this.$wrapper.find(".crm-dialog-content").width()-16,autocomplete_url:"",autocomplete:{html:!0,source:function(b,c){d.getJSON(a,{term:b.term},function(e){"ok"===e.status?c(e.data.tags||[]):c([])})}}})};CRMDealOperationAssignTags.prototype.initPopularTags=function(){var a=this.$input;this.$wrapper.find(".crm-popular-tags").find(".crm-popular-tag-item-link").click(function(){var b=
d(this);b=d.trim(b.text());a.removeTag(b);a.addTag(b)})};CRMDealOperationAssignTags.prototype.initSave=function(){var a=this,b=a.$button,c=a.$input,e=d.crm.app_url+"?module=dealOperation&action=assignTagsProcess",f=d.extend({},a.context,!0),g=a.$wrapper.find(".crm-loading");b.click(function(h){h.preventDefault();g.show();b.attr("disabled",!0);h=d("#"+c.attr("id")+"_tag");(h=d.trim(h.val()))&&h!==a.default_text&&c.addTag(h);f.tags=d.trim(c.val());f.is_assign=a.is_assign?1:0;var l=function(k){k=d.extend({offset:k||
0},f);d.post(e,k).done(function(m){"ok"==m.status&&(m.data.done?(g.hide(),b.attr("disabled",!1),d.crm.content.reload()):l(m.data.offset||0))})};l()})};return CRMDealOperationAssignTags}(jQuery);var CRMInvoiceEdit=function(d){function a(c,e){c=c.toFixed(2);"ru"===e&&(c=c.replace(".",","));return c}function b(c){var e=0;c&&c.length&&(c=c.replace(/,/g,".").replace(/\s/g,""),e=parseFloat(c)!=c?!1:parseFloat(c));return e}CRMInvoiceEdit=function(c){this.$wrapper=c.$wrapper;this.$form=this.$wrapper.find("form");this.$table=this.$wrapper.find(".c-product-table");this.$tableBody=this.$table.find("tbody");this.$emptyTax=this.$table.find(".js-empty-tax");this.$emptyTaxLink=this.$table.find(".js-empty-tax-link");
this.$tax=this.$table.find(".js-tax-toggle");this.$taxPercent=this.$table.find(".js-tax-percent");this.$taxType=this.$table.find(".js-tax-type");this.$taxName=this.$table.find(".js-tax-name");this.$taxHeader=this.$table.find(".js-tax-header");this.$currencyField=this.$wrapper.find(".js-currency-field");this.$companyField=this.$wrapper.find(".js-company-select");this.locale=c.locale;this.locales=c.locales;this.companies=c.companies||{};this.invoice_id=c.invoice_id;this.row_template_html=c.row_template_html;
this.confirm_dialog_template=c.confirm_dialog_template;this.shop_supported=c.shop_supported;this.tax_set_class="is-changed";this.currencies=c.currencies;this.supported_currencies=c.supported_currencies;this.company_id=c.company_id;this.tax=c.tax&&c.tax.name?c.tax:!1;this.active_tax_array=[];this.tax_percent=d(this.$tax.find("option")[this.$tax[0].selectedIndex]).data("percent")||"0";this.tax_type=d(this.$tax.find("option")[this.$tax[0].selectedIndex]).data("type");this.initClass()};CRMInvoiceEdit.prototype.initClass=
function(){this.initDatePickers();this.initTableEvents();this.initWYSIWYG();this.initSubmit();this.initChangeContact();this.initChangeCurrency();this.shop_supported&&this.initProductName();this.initChangeTax();this.initChangeCompany();this.initToggleButton()};CRMInvoiceEdit.prototype.initTableEvents=function(){function c(f){if(d.contains(document,e.$table[0])){var g=!0,h=e.$table.find(".js-tax-dropdown.is-active");f=d(f.target).closest(".js-tax-dropdown");f.length&&(g=f.hasClass("is-active"));h.removeClass("is-active");
g||"NONE"===e.tax_type||f.addClass("is-active")}else d(document).off("click",c)}var e=this;e.$table.on("focus",".js-name-field",function(){var f=d(this).closest("tr"),g=e.$tableBody.find("tr").length;f.index()+1>=g&&e.addTableRow(g+1)});e.$table.on("keypress",".js-name-field",function(f){13===f.keyCode&&f.preventDefault()});e.$table.on("click",".js-remove-row",function(f){f.preventDefault();1<e.$tableBody.find("tr").length&&e.removeTableRow(d(this).closest("tr"))});e.$table.on("change",".js-amount-field",
function(){e.changeTableRow(d(this))});e.$table.on("change",".js-price-field",function(){var f=d(this).closest("tr").find(".js-amount-field");f.val()||f.val("1");e.changeTableRow(d(this))});e.$table.on("click",".js-set-product-tax",function(){var f=d(this),g=f.closest(".js-tax-dropdown"),h=g.find(".js-product-tax-percent"),l=g.find(".js-product-tax-type");f=parseInt(f.data("tax-index"));if(f=e.active_tax_array[f])parseInt(e.tax_percent)===parseInt(f.tax_percent)&&e.tax_type===f.tax_type?g.removeClass(e.tax_set_class):
g.addClass(e.tax_set_class),g=e.tax_type,"NONE"===f.tax_type&&(g="NONE"),l.val(g).trigger("change"),l=f.tax_percent+"%","NONE"===f.tax_type&&(l=e.companies[e.$companyField.val()],l=e.locales.no_tax.replace("%name",l.tax_name)),h.val(l).trigger("change"),e.refreshTable()});d(document).on("click",c)};CRMInvoiceEdit.prototype.addTableRow=function(c){var e=d(this.row_template_html);e.find(".js-product-number").text(c);this.renderProductTaxOptions(e);this.$tableBody.append(e);this.renderProductTaxFields();
this.shop_supported&&this.$wrapper.trigger("addProduct",e)};CRMInvoiceEdit.prototype.removeTableRow=function(c){c.remove();this.$tableBody.find("tr").each(function(e){d(this).find(".js-product-number").text(e+1)});this.refreshTable()};CRMInvoiceEdit.prototype.changeTableRow=function(c){var e=this.locale,f="price"===c.data("type"),g=c.val(),h=0;g&&g.length&&(g=g.replace(/,/g,".").replace(/\s/g,""),0<parseFloat(g)&&(h=parseFloat(g)));c.val(f?a(h,e):h);this.refreshTable()};CRMInvoiceEdit.prototype.refreshTable=
function(){var c=this,e=function(){var l=[];c.$tableBody.find("tr").each(function(){var k=d(this),m=k.find(".js-amount-field"),n=k.find(".js-price-field"),p=k.find(".js-product-total"),q=k.find(".js-product-tax-percent");m=b(m.val());n=b(n.val());var r=0;0<m&&0<n&&(r=n*m);p.text(a(r,c.locale));(p=parseInt(q.val()))&&(0<p||0===p)||(p=0);l.push({$tr:k,percent:p,amount:m,price:n,total:r})});return l}(),f=c.tax_type&&"INCLUDE"===c.tax_type,g=0,h=0;d.each(e,function(l,k){g+=k.total;l=k.percent/100;h+=
f?l/(1+l)*k.total:k.total*l});c.$table.find(".js-subtotal").text(a(g,c.locale));c.$table.find(".js-tax").text(a(h,c.locale));c.$table.find(".js-total").text(a(g+(f?0:h),c.locale))};CRMInvoiceEdit.prototype.renderProductTaxOptions=function(c){var e=this,f=!1,g;f=c&&c.length?c.find(".js-tax-dropdown"):e.$tableBody.find(".js-tax-dropdown");var h=f.find(".js-hidden-list").html(""),l=e.companies[e.$companyField.val()],k=[];d.each(e.active_tax_array,function(m,n){g="NONE"===n.tax_type?e.locales.no_tax.replace("%name",
l.tax_name):n.tax_percent+"%";0>k.indexOf(g)&&(k.push(g),h.append('<li class="ui-menu-item-html ui-menu-item"><div class="ui-menu-item-wrapper"><div class="js-set-product-tax" data-tax-index="'+m+'">'+g+"</div></div></li>"))})};CRMInvoiceEdit.prototype.renderProductTaxFields=function(c){var e=this,f=e.$tableBody.find(".js-tax-dropdown");c&&f.removeClass(e.tax_set_class);f.each(function(){var g=d(this),h=g.find(".js-product-tax-percent"),l=g.find(".js-product-tax-type");g.hasClass(e.tax_set_class)&&
"NONE"!==e.tax_type||(l.val(e.tax_type).trigger("change"),l=e.tax_percent+"%","NONE"===e.tax_type&&(l="\u2014",g.removeClass(e.tax_set_class)),h.val(l).trigger("change"))})};CRMInvoiceEdit.prototype.initSubmit=function(){function c(){var k={data:[],errors:[]},m=h.serializeArray();d.each(m,function(n,p){"invoice[contact]"!==p.name&&k.data.push(p);"invoice[contact_id]"===p.name&&(0<p.value||k.errors.push({name:"invoice[contact_id]",value:g.locales.empty_contact}))});(function(n){g.$tableBody.find("tr").each(function(p){var q=
d(this),r=q.find(".js-product-field"),t=q.find(".js-amount-field"),u=q.find(".js-price-field"),v=q.find(".js-product-tax-percent"),w=q.find(".js-product-tax-type");q=q.find(".js-name-field");t=b(t.val());u=b(u.val());v=parseInt(v.val());w=w.val();r=r.val();q=q.val();if(t||u||q)n.push({name:"items["+p+"][name]",value:q}),n.push({name:"items["+p+"][price]",value:u}),n.push({name:"items["+p+"][quantity]",value:t}),n.push({name:"items["+p+"][tax_percent]",value:0<v||0===v?v:""}),n.push({name:"items["+
p+"][tax_type]",value:w});r&&n.push({name:"items["+p+"][product_id]",value:r})})})(k.data);return k}function e(k,m){m=m?m:[];if(k){var n=Object.keys(k);d.each(n,function(p,q){m.push({name:q,value:k[q]})})}d.each(m,function(p,q){p=q.value;var r=g.$form.find('[name="'+q.name+'"]');if(r.length&&!r.hasClass("error")){var t=d("<span />").addClass("errormsg").text(p);q=r.offset();p=g.$wrapper.offset();var u=q.top-p.top+r.outerHeight();t.css({left:q.left-p.left+"px",top:u+"px"});g.$wrapper.append(t);r.addClass("error").one("focus click change",
function(){r.removeClass("error");t.remove()})}})}function f(k){l||(l=!0,d.post(d.crm.app_url+"?module=invoice&action=save",k,function(m){"ok"===m.status?m.data.id&&(d(document).trigger("unsavedChanges",!1),d.crm.content.load(d.crm.app_url+"invoice/"+m.data.id+"/")):e(m.errors)},"json").always(function(){l=!1}))}var g=this,h=g.$form,l=!1;h.on("submit",function(k){k.preventDefault();k=c();k.errors.length?e(!1,k.errors):f(k.data)})};CRMInvoiceEdit.prototype.initDatePickers=function(){var c=this,e=c.$wrapper.find(".js-invoice-datepicker"),
f=c.$wrapper.find(".js-invoice-due-datepicker"),g=c.$wrapper.find(".js-due-days-field"),h=c.$wrapper.find(".js-clear-due-date");(function(){var l=e.parent().find("input[type='hidden']");e.datepicker({altField:l,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0});c.invoice_id||e.datepicker("setDate","+0d")})();(function(){var l=f.parent().find("input[type='hidden']");f.datepicker({altField:l,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0});f.on("change",function(){var k=d(this).val();d.trim(k).length?
h.show():(l.val(""),h.hide())})})();c.$wrapper.on("click",".js-focus-on-field",function(){d(this).parent().find("input:text").trigger("focus")});g.on("change",function(){var l=g.val(),k=0;l&&l.length&&0<parseInt(l)&&(k=parseInt(l),g.val(k));0<k?h.show():h.hide();g.val(k);l=k;k=e.datepicker("getDate");l=new Date(k.getTime()+864E5*l);f.datepicker("setDate",l)});e.on("change",function(){var l=g.val();l&&l.length&&0<parseInt(l)&&g.trigger("change")});f.on("change",function(){g.val("")});h.on("click",
function(){f.val("").trigger("change")})};CRMInvoiceEdit.prototype.initChangeContact=function(){var c=this.$wrapper.find(".js-contact-toggle"),e=c.find(".js-name"),f=c.find(".js-contact-id"),g=!1;c.on("click",".js-change-contact",function(h){h.preventDefault();var l=d(this);d.get(d.crm.app_url+"?module=invoice&action=contactAdd",function(k){new CRMDialog({html:k,options:{onAdd:function(m,n){f.val(m).trigger("change");e.text(n);g||(m=l.find(".js-label"),n=m.data("change-text"),m.text(n),g=!0)}}})})})};
CRMInvoiceEdit.prototype.initChangeCompany=function(){function c(h,l,k){h&&h.length&&(e.active_tax_array=h);g.find("option").remove();e.$taxHeader.text(l.length?l:"\u2014");h&&l?(e.$emptyTax.hide(),e.$tax.show(),d.each(h,function(m,n){m=d('<option value="'+m+'"></option>');if("INCLUDE"===n.tax_type){m.data("type","INCLUDE");var p=e.locales.include_tax}else"APPEND"===n.tax_type?(m.data("type","APPEND"),p=e.locales.append_tax):"NONE"===n.tax_type&&(m.data("type","NONE"),n.tax_percent=0,p=e.locales.no_tax);
0<n.tax_percent?(m.data("percent",n.tax_percent),p=p.replace("%value",n.tax_percent+"%")):(m.data("percent",0),p=p.replace("%value",""));if(p=p.replace("%name",l)){if(e.tax){var q=l===e.tax.name,r=n.tax_type===e.tax.type;n=(+n.tax_percent).toFixed(2)===(+e.tax.percent).toFixed(2);q&&r&&n&&m.attr("selected",!0)}m.text(p);m.data("name",l);g.append(m)}})):(e.$tax.hide(),e.$emptyTax.show(),h=e.$emptyTaxLink.data("href"),e.$emptyTaxLink.attr("href",h+e.$companyField.val().toString()+"/"));g.trigger("change",
!k)}var e=this,f=e.$companyField,g=e.$tax;f.on("change",function(h,l){h=d(this).val();var k=e.companies[h];e.active_tax_array=[];k&&(h=k.tax_name||e.locales.tax,k=JSON.parse(k.tax_options),c(k,h,l))});f.trigger("change",!0)};CRMInvoiceEdit.prototype.initChangeTax=function(){var c=this;c.$tax.on("change",function(e,f){e=d(this).find("option");c.tax_percent=0;c.tax_type="NONE";c.tax_name="";e.length&&(e=e[this.selectedIndex],c.tax_percent=d(e).data("percent")||0,c.tax_type=d(e).data("type"),c.tax_name=
d(e).data("name"));c.$taxPercent.val(c.tax_percent);c.$taxType.val(c.tax_type);c.$taxName.val(c.tax_name);c.renderProductTaxOptions();c.renderProductTaxFields(f);c.refreshTable()})};CRMInvoiceEdit.prototype.initWYSIWYG=function(){var c=this.$wrapper.find(".js-wysiwyg");d.crm.initWYSIWYG(c,{keydownCallback:function(e){}})};CRMInvoiceEdit.prototype.initProductName=function(){function c(g){function h(x){w&&w.abort();var y=d.crm.backend_url+"shop/?action=autocomplete&with_counts=1";x={term:x};k("loading");
w=d.get(y,x,function(z){z.length?(r.html(""),d.each(z,function(A,B){A=d("<div />");A.html(B.label).data("product",B).addClass("js-set-product");k(A)})):e.$wrapper.trigger("searchProduct")},"json").always(function(){w=!1})}function l(x){w&&w.abort();k("loading");var y=e.$currencyField.val();w=d.get(d.crm.backend_url+"shop/?module=orders&action=getProduct",{product_id:x.id,currency:y},function(z){"ok"===z.status?(r.html(""),d.each(z.data.sku_ids,function(A,B){A=d("<div />");B=z.data.product.skus[B];
A.text(z.data.product.name+(B.name.length?" ("+B.name+")":"")).data("product",z.data.product).data("sku",B).addClass("js-set-sku");k(A);1===z.data.sku_ids.length&&A.trigger("click")})):e.$wrapper.trigger("searchProduct")},"json").always(function(){w=!1})}function k(x){if("loading"===x)r.html("").append('<li class="ui-menu-item-html ui-menu-item"><div class="ui-menu-item-wrapper"><i class="icon16 loading"></i></div></li>');else{var y=d("<li />").addClass("ui-menu-item-html ui-menu-item");d("<div />").addClass("ui-menu-item-wrapper").append(x).appendTo(y);
y.appendTo(r)}}function m(){g.removeClass("is-active");r.html("");u=!1}function n(x){var y=r.find("li"),z=y.filter(".is-highlighted");if(!y.length)return!1;z.length&&1<y.length?(z.removeClass("is-highlighted"),x?(x=z.next(),x.length||(x=y.first())):(x=z.prev(),x.length||(x=y.last()))):x=y.first();x.addClass("is-highlighted")}function p(){var x=r.find("li.is-highlighted");x.length&&x.find(".ui-menu-item-wrapper > *").first().trigger("click")}var q=g.find(".js-name-field"),r=g.find(".js-hidden-list"),
t=g.find(".js-product-field"),u=!1,v=0,w=!1;q.on("keyup",function(x){x=x.keyCode;if(0<=[13,27,37,38,39,40].indexOf(x))switch(x){case 13:p();break;case 27:m();q.trigger("blur");break;case 38:n(!1);break;case 40:n(!0)}else{var y=d(this).val();1<y.length?(u||(e.$wrapper.trigger("searchProduct"),g.addClass("is-active"),u=!0),clearTimeout(v),v=setTimeout(function(){h(y)},500)):e.$wrapper.trigger("searchProduct")}});q.on("change",function(){t.val("").trigger("change")});e.$wrapper.on("searchProduct",m);
r.on("click",".js-set-product",function(){var x=d(this).data("product");x&&l(x)});r.on("click",".js-set-sku",function(){var x=d(this),y=x.data("product");x=x.data("sku")||!1;if(y){var z="shop:"+y.id+(x?":"+x.id:""),A=x.price;q.val(y.name+(x.name.length?" ("+x.name+")":"")).trigger("change");g.closest("tr").find(".js-price-field").val(A).trigger("change");t.val(z).trigger("change")}m();q.trigger("blur")})}var e=this,f=e.$wrapper.find(".js-name-autocomplete");f.length&&(f.each(function(){c(d(this))}),
e.refreshTable());e.$wrapper.on("addProduct",function(g,h){g=d(h).find(".js-name-autocomplete");g.length&&c(g)})};CRMInvoiceEdit.prototype.initChangeCurrency=function(){function c(g,h){e.$tableBody.find(".js-price-field").each(function(){var l=d(this),k=l.val(),m=0;k&&k.length&&(k=k.replace(/,/g,".").replace(/\s/g,""),0<parseFloat(k)&&(m=parseFloat(k)),l.val(m*e.currencies[h].rate/e.currencies[g].rate).trigger("change"))})}var e=this,f=e.$currencyField.val();e.$currencyField.on("change",function(){var g=
e.$currencyField.val(),h=!1;e.$tableBody.find(".js-price-field").each(function(){if(d(this).val().length)return h=!0,!1});h?(e.$currencyField.val(f),new CRMDialog({html:e.confirm_dialog_template,options:{changeCurrencyWithPrice:function(){e.$currencyField.val(g);c(g,f);f=g},changeCurrency:function(){e.$currencyField.val(g);f=g}}})):f=g})};CRMInvoiceEdit.prototype.initToggleButton=function(){var c=this.$wrapper.find(".js-footer-actions"),e=c.find(".js-submit-button");this.$wrapper.on("change keydown",
"input, textarea, select",function(){e.removeClass("green").addClass("yellow");c.addClass("is-changed");d(document).trigger("unsavedChanges",!0)})};return CRMInvoiceEdit}(jQuery),CRMInvoiceContactAdd=function(d){CRMInvoiceContactAdd=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.dialog=this.$wrapper.data("dialog");this.locales=a.locales;this.initClass()};CRMInvoiceContactAdd.prototype.initClass=function(){function a(){var g=e.$form.serializeArray(),h={data:[],errors:[]},
l=!1,k=!1;d.each(g,function(m,n){m=n.name;var p=n.value;"deal[contact_id]"===m&&p&&(l=!0);"contact[firstname]"===m&&p&&(k=!0);"contact[lastname]"===m&&p&&(k=!0);"contact[middlename]"===m&&p&&(k=!0);"contact[name]"===m&&p&&(k=!0);h.data.push(n)});l||k||(h.errors.push({name:"contact[name]",value:e.locales.empty_name}),h.errors.push({name:"contact[firstname]",value:e.locales.empty_name}));return h}function b(g){d.post("?module=invoice&action=contactAddSave",g,function(h){"ok"===h.status?(e.dialog.options.onAdd(h.data.id,
h.data.name),e.dialog.close()):c(h.errors)},"json").always(function(){f=!1})}function c(g,h){h=h?h:[];if(g){var l=Object.keys(g);d.each(l,function(k,m){h.push({name:m,value:g[m]})})}d.each(h,function(k,m){k=m.name;m=m.value;"name"===k&&(k="contact[firstname]");var n=e.$form.find('[name="'+k+'"]');"contact[firstname]"!==k||n.is(":visible")||(n=e.$form.find(".js-contact-autocomplete"));if(n.length&&!n.hasClass("error")){var p=d("<span />").addClass("errormsg").text(m);p.insertAfter(n);n.addClass("error").one("focus click",
function(){n.removeClass("error");p.remove()});d(document).on("toggleChanged",function(){n.removeClass("error");p.remove()})}})}var e=this,f=!1;e.$form.on("submit",function(g){g.preventDefault();g=e.$wrapper.find(".js-contact-id-field").val();if(g){var h=e.$wrapper.find(".js-contact-autocomplete").val();e.dialog.options.onAdd(g,h);e.dialog.close()}else f||(f=!0,g=a(),g.errors.length?(c(!1,g.errors),f=!1):b(g.data))})};return CRMInvoiceContactAdd}(jQuery),CRMInvoicePage=function(d){function a(b,c){if(!b)return!1;
b=d('.js-invoices-list .c-invoice[data-id="'+b+'"]');b.length&&(c?b.replaceWith(c):b.remove())}CRMInvoicePage=function(b){this.$wrapper=b.$wrapper;this.invoice_id=b.invoice_id;this.locales=b.locales;this.initClass()};CRMInvoicePage.prototype.initClass=function(){var b=this;b.initChangeState();b.initDelete();b.initRefund();b.initRestore();setTimeout(function(){d(document).trigger("viewInvoice",b.invoice_id)},100);b.$wrapper.data("page",b)};CRMInvoicePage.prototype.initChangeState=function(){function b(g){f||
(f=!0,d.post("?module=invoice&action=handleTransaction",{invoice_id:e,action:g},function(h){"ok"===h.status?(a(c.invoice_id,"delete"===g?"":h.data.html),c.load(d.crm.app_url+"invoice/"+c.invoice_id+"/")):alert(h.errors)},"json").always(function(){f=!1}))}var c=this,e=c.invoice_id,f=!1;c.$wrapper.on("click",".js-change-state",function(g){g.preventDefault();(g=d(this).data("action"))&&b(g)})};CRMInvoicePage.prototype.initDelete=function(){function b(){e||(e=!0,d.post("?module=invoice&action=handleTransaction",
{invoice_id:c.invoice_id,action:"delete"},function(f){"ok"===f.status&&d.crm.content.load(d.crm.app_url+"invoice/")},"json").always(function(){e=!1}))}var c=this,e=!1;c.$wrapper.on("click",".js-delete-invoice",function(f){f.preventDefault();d.crm.confirm.show({title:c.locales.delete_confirm_title,text:c.locales.delete_confirm_text,button:c.locales.delete_confirm_button,onConfirm:b})})};CRMInvoicePage.prototype.initRefund=function(){function b(){e||(e=!0,d.post(d.crm.app_url+"?module=invoice&action=refundDialog",
{invoice_id:c.invoice_id},function(f){new CRMDialog({html:f,options:{onRefund:function(){c.reload()}}})}).always(function(){e=!1}))}var c=this,e=!1;c.$wrapper.on("click",".js-change-refund",function(f){f.preventDefault();b()})};CRMInvoicePage.prototype.initRestore=function(){function b(){e||(e=!0,d.post("?module=invoiceRestore",{id:c.invoice_id},function(f){"ok"===f.status?(a(c.invoice_id,f.data.html),c.reload()):alert(f.errors)},"json").always(function(){e=!1}))}var c=this,e=!1;c.$wrapper.on("click",
".js-restore-invoice",function(f){f.preventDefault();b()})};CRMInvoicePage.prototype.load=function(b){b=d("<a />").addClass("js-disable-router").attr("href",b).hide();this.$wrapper.append(b);b.trigger("click")};CRMInvoicePage.prototype.reload=function(){this.load(location.href)};return CRMInvoicePage}(jQuery),CRMInvoiceRefundDialog=function(d){CRMInvoiceRefundDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.dialog=this.$wrapper.data("dialog");this.initClass()};
CRMInvoiceRefundDialog.prototype.initClass=function(){this.initSubmit()};CRMInvoiceRefundDialog.prototype.initSubmit=function(){function a(){var g={data:[],errors:[]},h=e.serializeArray();d.each(h,function(l,k){g.data.push(k)});return g}function b(g){f||(f=!0,d.post(d.crm.app_url+"?module=invoice&action=handleTransaction",g,function(h){"ok"===h.status?(c.dialog.options.onRefund(),c.dialog.close()):console.log(h.errors)},"json").always(function(){f=!1}))}var c=this,e=c.$form,f=!1;e.on("submit",function(g){g.preventDefault();
g=a();g.errors.length?console.log(g.errors):b(g.data)})};return CRMInvoiceRefundDialog}(jQuery);var CRMInvoices=function(d){function a(){var b=!1,c=d("#c-invoice-page");c.length&&(c=c.data("id"))&&(b=c);return b}CRMInvoices=function(b){this.$wrapper=b.$wrapper;this.$content=this.$wrapper.find("#js-inner-content");this.$sidebar=this.$wrapper.find("#js-aside-block");this.$invoiceList=this.$sidebar.find(".js-invoices-list");this.initClass()};CRMInvoices.prototype.initClass=function(){this.initElastic();this.initContentRouter();this.initLazy();this.initInvoiceList();this.initInvoiceSearch()};CRMInvoices.prototype.initElastic=
function(){var b=this.$wrapper,c=this.$sidebar,e=this.$content;new CRMElasticBlock({$wrapper:b,$aside:c,$content:e});new CRMElasticBlock({$wrapper:b,$content:c,$aside:e});(function(){function f(){d.contains(document,l[0])?g.scrollTop()>k.top?(n||(n=d('<div class="c-space-wrapper" />').height(m),l.after(n)),l.css({left:k.left}).width(h.outerWidth()).addClass("is-fixed")):(n&&n.length&&n.remove(),l.removeAttr("style").removeClass("is-fixed")):g.off("scroll",f)}var g=d(window),h=c,l=c.find(".js-aside-header"),
k=h.offset(),m=l.outerHeight(),n=!1;g.on("scroll",f)})();d(window).trigger("scroll")};CRMInvoices.prototype.initContentRouter=function(){function b(l){function k(m){d.post("?module=dialogConfirm",{title:"Error",text:m,ok_button:"Close"},function(n){new CRMDialog({html:n})})}h&&h.abort();d(document).trigger("wa_before_load");h=d.get(l,{content_only:1},function(m){g&&history.pushState({reload:!0,content_uri:l},"",l);d(document).trigger("wa_before_render");e.html(m);d(document).trigger("wa_loaded")}).fail(function(m){m.responseText&&
k(m.responseText)}).always(function(){c.xhr=!1})}var c=this,e=c.$content.find(".js-inner-content"),f=!1,g=!(!history||!history.pushState),h=!1;c.$wrapper.on("click","a",function(l){var k=d(this),m=k.hasClass("js-disable-router")?k.attr("href"):!1;l.ctrlKey||l.shiftKey||l.metaKey||!m||(l.preventDefault(),f?d.crm.confirm.show({title:d.crm.locales.unsaved_dialog_title,text:d.crm.locales.unsaved_dialog_text,button:d.crm.locales.unsaved_dialog_button,onConfirm:function(){d(document).trigger("unsavedChanges",
!1);b(m)}}):b(m))});d(document).on("unsavedChanges",function(l,k){f=!!k})};CRMInvoices.prototype.initLazy=function(){function b(){if(d.contains(document,g[0])){var l=d(window).scrollTop(),k=e.height(),m=g.offset().top;l+k>=m&&(h||c())}else e.off("scroll",b)}function c(){var l={offset:g.data("offset")},k=a();k&&(l.invoice_id=k);h=!0;d.post("?module=invoice&action=sidebar",l,function(m){var n=d(m);m=n.find(".js-lazyload");n=n.find(".c-invoice");m.length?(m.insertAfter(g),g.remove(),g=m):g.remove();
f.append(n)}).always(function(){h=!1})}var e=d(window),f=this.$invoiceList,g=this.$wrapper.find(".js-lazyload"),h=!1;g.length&&(e.on("scroll",b),g.offset().top<e.height()&&e.trigger("scroll"))};CRMInvoices.prototype.initInvoiceList=function(){function b(f){c.$invoiceList.find(".c-invoice").each(function(){var g=d(this),h=g.data("id");f==h&&(g.addClass("selected"),e=g)})}var c=this,e=c.$invoiceList.find(".c-invoice.selected");d(document).on("viewInvoice",function(f,g){e.length&&e.removeClass("selected");
g&&b(g)})};CRMInvoices.prototype.initInvoiceSearch=function(){var b=this.$wrapper.find(".js-search-field");b.autocomplete({appendTo:this.$sidebar,classes:{"ui-autocomplete":"c-search-results-list"},source:this.app_url+"?module=invoiceAutocomplete",minLength:1,html:!0,focus:function(){return!1},select:function(c,e){d.crm.content.load(d.crm.app_url+"invoice/"+e.item.id+"/");b.val("");return!1}}).data("ui-autocomplete")._renderItem=function(c,e){return d("<li />").addClass("ui-menu-item-html").append("<div>"+
e.value+"</div>").appendTo(c)}};return CRMInvoices}(jQuery);var CRMReminderFormEdit=function(d){CRMReminderFormEdit=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.reminder_id=a.reminder_id;this.locales=a.locales;this.app_url=a.app_url;this.initClass()};CRMReminderFormEdit.prototype.initClass=function(){this.initDatePicker();this.initTimeToggle();this.initTimePicker();this.initCombobox();this.initTypeToggle();this.initSubmit()};CRMReminderFormEdit.prototype.initCombobox=function(){function a(f){f?c.addClass("is-shown"):c.removeClass("is-shown")}
var b=this,c=b.$form.find(".js-contact-wrapper"),e=c.find(".js-field");c.on("click",".js-show-combobox",function(f){f.stopPropagation();a(!0)});c.on("click",".js-hide-combobox",function(f){f.stopPropagation();a(!1)});(function(){var f=c.find(".js-autocomplete");f.autocomplete({appendTo:c,position:{my:"right top",at:"right bottom"},source:b.app_url+"?module=autocomplete&type=user",minLength:0,html:!0,focus:function(){return!1},select:function(g,h){g=h.item;h=c.find(".js-user");g.photo_url&&h.find(".icon16").css("background-image",
"url("+g.photo_url+")");h.find(".c-name").text(g.name);e.val(g.id);a(!1);f.val("");return!1}}).data("ui-autocomplete")._renderItem=function(g,h){return d("<li />").addClass("ui-menu-item-html").append("<div>"+h.value+"</div>").appendTo(g)};f.on("focus",function(){f.data("uiAutocomplete").search(f.val())})})()};CRMReminderFormEdit.prototype.initDatePicker=function(){var a=this;a.$form.find(".js-datepicker").each(function(){var b=d(this),c=b.parent().find("input[type='hidden']");b.datepicker({altField:c,
altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0});b.parent().find(".calendar").on("click",function(){b.focus()});a.reminder_id||b.datepicker("setDate","+1d")})};CRMReminderFormEdit.prototype.initTimeToggle=function(){function a(e){e?b.addClass("is-active"):b.removeClass("is-active")}var b=this.$form.find(".js-time-toggle"),c=b.find(".js-timepicker");b.on("click",".js-show-time",function(){a(!0);c.focus()});b.on("click",".js-reset-time",function(){c.val("");a()})};CRMReminderFormEdit.prototype.initTimePicker=
function(){this.$form.find(".js-timepicker").each(function(){d(this).timepicker()})};CRMReminderFormEdit.prototype.initSubmit=function(){function a(){var h={data:[],errors:[]},l=f.serializeArray();d.each(l,function(k,m){m.value.length&&h.data.push(m)});return h}function b(h,l){l=l?l:[];if(h){var k=Object.keys(h);d.each(k,function(m,n){l.push({name:n,value:h[n]})})}d.each(l,function(m,n){m=n.value;var p=e.$form.find('[name="'+n.name+'"]');if(p.length&&!p.hasClass("error")){var q=d("<span />").addClass("errormsg").text(m);
e.$wrapper.append(q);p.addClass("error").one("focus click change",function(){p.removeClass("error");q.remove()})}})}function c(h){g||(g=!0,d.post(e.app_url+"?module=reminder&action=save",h,function(l){"ok"===l.status?d(document).trigger("reminderIsChanged"):b(l.errors)},"json").always(function(){g=!1}))}var e=this,f=e.$form,g=!1;f.on("submit",function(h){h.preventDefault();h=a();h.errors.length?b(!1,h.errors):c(h.data)})};CRMReminderFormEdit.prototype.initTypeToggle=function(){var a=this.$wrapper.find(".js-reminder-type-toggle"),
b=a.find(".js-visible-link"),c=a.find(".js-field"),e=a.find(".menu-v");e.on("click","a",function(){var f=d(this);b.find(".js-text").html(f.html());e.find(".selected").removeClass("selected");f.closest("li").addClass("selected");e.hide();setTimeout(function(){e.removeAttr("style")},200);f=f.data("type-id");c.val(f).trigger("change")})};return CRMReminderFormEdit}(jQuery);var CRMReminders=function(d){CRMReminders=function(a){this.$wrapper=a.$wrapper;this.$completedSection=this.$wrapper.find(".c-completed-reminders-section");this.user_id=a.user_id;this.locales=a.locales;this.initClass()};CRMReminders.prototype.initClass=function(){this.initAddReminder();this.initReopenReminder();this.initElastic();this.user_id&&this.$completedSection.length&&this.initCompletedReminders();this.initReminderSettings();this.initTarget()};CRMReminders.prototype.initAddReminder=function(){function a(k){var m=
d(k.target),n=d.contains(document,c[0]);k=d.contains(c[0],k.target);var p=!!m.closest(".ui-timepicker-wrapper").length;m=!!m.closest(".ui-datepicker").length;var q=!e.val().length;n?k||p||m||!q||b():d(document).off("click",a)}function b(){e.val("");c.removeClass("is-extended")}var c=d("#c-add-reminder-form"),e=c.find(".js-textarea"),f=c.find(".c-icon-column .icon16"),g=c.find("form"),h=!1,l=!1;g.on("submit",function(k){k.preventDefault();l||(l=!0,f.removeClass("c-plus").addClass("loading"),k=g.serializeArray(),
d.post("?module=reminder&action=save",k,function(m){"ok"===m.status&&(d.crm.content.reload(),d.crm.sidebar.reload())},"json").always(function(){l=!1}))});e.on("focus",function(){c.addClass("is-extended")});c.on("click",".js-cancel",b);e.on("keyup",function(k){var m=13===k.keyCode;e.val().length?h||(h=!0,e.addClass("is-changed")):(h=!1,e.removeClass("is-changed"));if(!m||k.shiftKey)e.css("min-height",0),e.css("min-height",e[0].scrollHeight+"px")});e.on("keydown",function(k){13!==k.keyCode||k.shiftKey||
(k.preventDefault(),g.find("input:submit").trigger("click"))});d(document).on("click",a);(function(k){function m(q){q?n.addClass("is-shown"):n.removeClass("is-shown")}var n=k.find(".js-contact-wrapper"),p=n.find(".js-field");n.on("click",".js-show-combobox",function(q){q.stopPropagation();m(!0)});n.on("click",".js-hide-combobox",function(q){q.stopPropagation();m(!1)});(function(){var q=n.find(".js-autocomplete");q.autocomplete({appendTo:n,position:{my:"right top",at:"right bottom"},source:d.crm.app_url+
"?module=autocomplete&type=user",minLength:0,html:!0,focus:function(){return!1},select:function(r,t){r=t.item;t=n.find(".js-user");r.photo_url&&t.find(".icon16").css("background-image","url("+r.photo_url+")");t.find(".c-name").text(r.name);p.val(r.id);m(!1);q.val("");return!1}}).data("ui-autocomplete")._renderItem=function(r,t){return d("<li />").addClass("ui-menu-item-html").append("<div>"+t.value+"</div>").appendTo(r)};q.on("focus",function(){q.data("uiAutocomplete").search(q.val())})})()})(c);
(function(k){k=k.find(".js-reminder-type-toggle");var m=k.find(".js-visible-link"),n=k.find(".js-field"),p=k.find(".menu-v");p.on("click","a",function(){var q=d(this);m.find(".js-text").html(q.html());p.find(".selected").removeClass("selected");q.closest("li").addClass("selected");p.hide();setTimeout(function(){p.removeAttr("style")},200);q=q.data("type-id");n.val(q).trigger("change")})})(c);(function(){c.find(".js-datepicker").each(function(){var k=d(this),m=k.parent().find("input[type='hidden']");
k.datepicker({altField:m,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0});k.parent().find(".calendar").on("click",function(){k.focus()})})})();(function(){function k(p){p?m.addClass("is-active"):m.removeClass("is-active")}var m=c.find(".js-time-toggle"),n=m.find(".js-timepicker");m.on("click",".js-show-time",function(){k(!0);n.focus()});m.on("click",".js-reset-time",function(){n.val("");k()})})();(function(){c.find(".js-timepicker").each(function(){d(this).timepicker()})})()};CRMReminders.prototype.initCompletedReminders=
function(){function a(){var m={user_id:e.user_id};k=!0;d.post("?module=reminder&action=completed",m,function(n){b(!0);h=!0;g.append(n);c();d(window).trigger("scroll")}).always(function(){k=!1})}function b(m,n){n?(f.toggleClass("is-shown"),l=!l):m?(f.addClass("is-shown"),l=!0):(f.removeClass("is-shown"),l=!1)}function c(){function m(){if(d.contains(document,q[0])){if(l){var t=q,u=d(window).scrollTop(),v=p.height(),w=t.offset().top;u+v>=w&&(r||n(t))}}else p.off("scroll",m)}function n(t){var u={user_id:e.user_id,
min_dt:g.find("> li[data-datetime]:last").data("datetime")};r=!0;d.post("?module=reminder&action=completed",u,function(v){t.remove();g.append(v);c()}).always(function(){r=!1})}var p=d(window),q=g.find(".js-lazy-load"),r=!1;if(q.length)p.on("scroll",m)}var e=this,f=e.$completedSection,g=f.find(".c-reminders-list"),h=!1,l=!1,k=!1;f.on("click",".js-load-completed-reminders",function(m){m.preventDefault();h?b(!1,!0):k||a()})};CRMReminders.prototype.initElastic=function(){var a=this.$wrapper,b=this.$wrapper.find("#js-aside-block"),
c=this.$wrapper.find("#js-content-block");b.length&&new CRMElasticBlock({$wrapper:a,$aside:b,$content:c});c.length&&new CRMElasticBlock({$wrapper:a,$content:b,$aside:c});d(window).trigger("scroll")};CRMReminders.prototype.initReopenReminder=function(){function a(c){b||(b=!0,d.post("?module=reminder&action=markAsUndone",{id:c},function(e){"ok"==e.status&&d.crm.content.reload()}).always(function(){b=!1}))}var b=!1;this.$wrapper.on("click",".js-reopen-reminder",function(c){c.preventDefault();c=d(this);
var e=c.closest(".c-reminder-wrapper");c.addClass("is-loading");a(e.data("id"))})};CRMReminders.prototype.initReminderSettings=function(){function a(){b||(b=!0,d.post("?module=reminder&action=settings",{},function(c){new CRMDialog({html:c})}).always(function(){b=!1}))}var b=!1;this.$wrapper.on("click",".js-show-settings",function(c){c.preventDefault();a()})};CRMReminders.prototype.initTarget=function(){var a=this;d(window).load(function(){setTimeout(function(){var b=a.$wrapper.find(".c-reminder-wrapper.is-target");
b.length&&(b=b.offset().top,d(window).scrollTop(b-50))},100)})};return CRMReminders}(jQuery),CRMReminder=function(d){CRMReminder=function(a){this.$wrapper=a.$wrapper;this.$marker=this.$wrapper.find(".c-marker");this.$steps=this.$wrapper.find(".c-step");this.$view=this.$steps.filter(".is-view");this.$edit=this.$steps.filter(".is-edit");this.$confirm=this.$steps.filter(".is-confirm");this.$textarea=this.$edit.find("textarea");this.id=a.id;this.shown_class="is-shown";this.$activeContent=this.$view;this.xhr=
!1;this.initClass()};CRMReminder.prototype.initClass=function(){function a(c){c?b.$confirm.addClass("is-shown"):b.$confirm.removeClass("is-shown")}var b=this;b.$wrapper.on("click",".js-cancel",function(c){c.preventDefault();b.toggleContent(b.$view)});b.$wrapper.on("click",".js-edit-reminder",function(c){c.preventDefault();b.$textarea.data("value")?b.$textarea.val(b.$textarea.data("value")):b.$textarea.data("value",b.$textarea.val());b.toggleContent(b.$edit)});b.$edit.find("form").on("submit",function(){d(document).one("reminderIsChanged",
function(){d.crm.content.reload()})});b.$wrapper.on("click",".js-confirm-delete",function(c){c.preventDefault();b.remove()});b.$wrapper.on("click",".js-remove",function(c){c.preventDefault();a(!0)});b.$wrapper.on("click",".js-confirm-cancel",function(c){c.preventDefault();a(!1)});b.initDone();b.initQuickDateToggle();b.initQuickContentEdit()};CRMReminder.prototype.remove=function(){var a=this,b={id:a.id};a.xhr&&a.xhr.abort();a.xhr=d.post("?module=reminder&action=delete",b,function(c){"ok"===c.status&&
(a.$wrapper.remove(),d.crm.content.reload(),d.crm.sidebar.reload())}).always(function(){a.xhr=!1})};CRMReminder.prototype.initDone=function(){var a=this,b=a.$wrapper;b.on("click",".js-mark-done",function(c){b.css("display","none");c.preventDefault();d(this).addClass("is-done");d.post("?module=reminder&action=markAsDone",{id:a.id},function(e){"ok"===e.status?(b.remove(),d.crm.content.reload(),d.crm.sidebar.reload()):b.css("display","")}).always(function(){})})};CRMReminder.prototype.toggleContent=
function(a){this.$activeContent.length&&this.$activeContent.removeClass(this.shown_class);a.addClass(this.shown_class);this.$activeContent=a};CRMReminder.prototype.initQuickDateToggle=function(){function a(m){if(d.contains(document,f[0])){var n=d.contains(f[0],m.target);if(g){var p=d(m.target);m=!!p.closest(".ui-timepicker-wrapper").length;var q=!!p.closest(".ui-datepicker").length;p=!!p.hasClass("ui-icon-circle-triangle-e");if(m||q||p)return!1}!n&&g&&c(!1)}else d(document).off("click",a)}function b(){if(!h){h=
!0;var m=l.serializeArray();e.renderLoading(!0);d.post("?module=reminder&action=save",m,function(n){"ok"===n.status&&(d.crm.content.reload(),d.crm.sidebar.reload())}).always(function(){e.renderLoading(!1);h=!1})}}function c(m){m?(f.addClass("is-extended"),k.focus(),g=!0):(f.removeClass("is-extended"),g=!1)}var e=this,f=e.$wrapper.find(".js-quick-date-toggle-wrapper"),g=!1,h=!1;if(!f.length)return!1;var l=f.find("form"),k=f.find(".js-date-field");f.on("click",".js-change-date",function(m){m.preventDefault();
c(!0)});f.on("click",".js-cancel-edit-date",function(m){m.preventDefault();c(!1)});f.on("click",".js-save-date",function(m){m.preventDefault();b()});d(document).on("click",a);(function(){var m=f.find(".js-alt-date-field");k.datepicker({altField:m,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0});k.parent().find(".calendar").on("click",function(){k.focus()})})();(function(){function m(q){q?n.addClass("is-active"):n.removeClass("is-active")}var n=f.find(".js-time-toggle"),p=n.find(".js-timepicker");
n.on("click",".js-show-time",function(){m(!0);p.focus()});n.on("click",".js-reset-time",function(){p.val("");m()});f.find(".js-timepicker").timepicker()})()};CRMReminder.prototype.initQuickContentEdit=function(){function a(){if(!l){l=!0;c.renderLoading(!0);var k=f.serializeArray();d.post("?module=reminder&action=save",k,function(m){"ok"===m.status&&(h=!1,g.removeClass("is-changed").blur())}).always(function(){l=!1;c.renderLoading(!1)})}}function b(){g.css("min-height",0);g.css("min-height",g[0].scrollHeight+
"px")}var c=this,e=c.$wrapper.find(".js-quick-content-toggle-wrapper");if(!e.length)return!1;var f=e.find("form"),g=f.find(".js-textarea"),h=!1,l=!1;g.on("keyup",function(k){var m=13===k.keyCode;g.val().length?h||(h=!0,g.addClass("is-changed")):(h=!1,g.removeClass("is-changed"));m&&!k.shiftKey||b()});g.on("keydown",function(k){13!==k.keyCode||k.shiftKey||(k.preventDefault(),h&&a())});g.on("blur",function(){h&&a()});b()};CRMReminder.prototype.renderLoading=function(a){var b=this.$marker,c=b.data("icon");
c||(c=d('<i class="icon16 loading"></i>'),b.prepend(c),b.data("icon",c));a?(b.addClass("is-load"),c.show()):(b.removeClass("is-load"),c.hide())};return CRMReminder}(jQuery),CRMCompletedReminder=function(d){CRMCompletedReminder=function(a){this.$wrapper=a.$wrapper;this.$marker=this.$wrapper.find(".c-marker");this.marker_html=this.$marker.html();this.reminder_id=a.reminder_id;this.initClass()};CRMCompletedReminder.prototype.initClass=function(){this.initQuickContentEdit()};CRMCompletedReminder.prototype.initQuickContentEdit=
function(){function a(){if(!l){l=!0;c.renderLoading(!0);var k=f.serializeArray();d.post("?module=reminder&action=save",k,function(m){"ok"===m.status&&(h=!1,g.removeClass("is-changed").blur())}).always(function(){l=!1;c.renderLoading(!1)})}}function b(){g.css("min-height",0);g.css("min-height",g[0].scrollHeight+"px")}var c=this,e=c.$wrapper.find(".js-quick-content-toggle-wrapper");if(!e.length)return!1;var f=e.find("form"),g=f.find(".js-textarea"),h=!1,l=!1;g.on("keyup",function(k){var m=13===k.keyCode;
g.val().length?h||(h=!0,g.addClass("is-changed")):(h=!1,g.removeClass("is-changed"));m&&!k.shiftKey||b()});g.on("keydown",function(k){13!==k.keyCode||k.shiftKey||(k.preventDefault(),h&&a())});g.on("blur",function(){h&&a()});b()};CRMCompletedReminder.prototype.renderLoading=function(a){var b=this.$marker;a?(b.addClass("is-load"),b.html('<i class="icon16 loading"></i>')):(b.removeClass("is-load"),b.html(this.marker_html))};return CRMCompletedReminder}(jQuery),CRMReminderSettingsDialog=function(d){CRMReminderSettingsDialog=
function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$button=this.$wrapper.find(".js-submit-button");this.$options=this.$wrapper.find(".js-options-list");this.$groups=this.$wrapper.find(".js-group-list");this.$select=this.$wrapper.find(".js-select-list");this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMReminderSettingsDialog.prototype.initClass=function(){var a=this;a.$form.on("change","input",function(){a.toggleButton(!0)});a.$options.on("change","input",function(){var b=
d(this),c=b.val();"checked"===b.attr("checked")&&("groups"===c?a.$groups.show():a.$groups.hide());a.dialog.resize()});a.$form.on("change",".daily-recap",function(){var b=d(this)["0"].checked,c=a.$select,e=d(".crm-reminders-recap-error");b?(c.attr("disabled",!1),e.length&&(d(e).fadeIn(),a.dialog.resize())):(c.attr("disabled",!0),e.length&&(d(e).fadeOut(),a.dialog.resize()))});a.$form.on("change",".js-pop-up-disabled",function(){var b=d(this),c=a.$wrapper.find(".js-pop-up-min");b.is(":checked")?(c.prop("readonly",
!1),c.focus()):c.prop("readonly",!0)});a.initSave()};CRMReminderSettingsDialog.prototype.initSave=function(){function a(){e||(e=!0,d('<i class="icon16 loading" style="vertical-align: middle;margin-left: 10px;"></i>').appendTo(".crm-actions"),d(".js-submit-button").prop("disabled",!0),d.post("?module=reminder&action=settingsSave",c.serializeArray(),function(g){"ok"===g.status&&("my"==b.$options.find(":checked").val()?d.crm.content.load(d.crm.app_url+"reminder/"):(d(".loading").remove(),d('<i class="icon16 yes" style="vertical-align: middle;margin-left: 10px;"></i>').appendTo(".crm-actions"),
setTimeout(function(){b.dialog.close();d.crm.content.reload()},1E3)))},"json").always(function(){b.toggleButton(!1);e=!1}))}var b=this,c=b.$form,e=!1,f=b.$wrapper.find(".js-pop-up-disabled");d(".js-submit-button").on("click",function(){f.is(":checked")?0<parseInt(d(".js-pop-up-min").val())?a():d(".enter-minutes").fadeIn().delay("2000").fadeOut():a()})};CRMReminderSettingsDialog.prototype.toggleButton=function(a){var b=this.$button;a?b.removeClass("green").addClass("yellow"):b.removeClass("yellow").addClass("green")};
return CRMReminderSettingsDialog}(jQuery),CRMReminderSettings=function(d){CRMReminderSettings=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".js-submit-button");this.$options=this.$wrapper.find(".js-options-list");this.$groups=this.$wrapper.find(".js-group-list");this.$select=this.$wrapper.find(".js-select-list");this.$wrapper.data("instance",this);this.initClass()};CRMReminderSettings.prototype.initClass=function(){var a=this;a.$options.on("change","input",function(){var b=
d(this),c=b.val();"checked"===b.attr("checked")&&("groups"===c?a.$groups.show():a.$groups.hide())});a.$wrapper.on("change",".daily-recap",function(){var b=d(this)["0"].checked,c=a.$select,e=d(".crm-reminders-recap-error");b?(c.attr("disabled",!1),e.length&&d(e).fadeIn()):(c.attr("disabled",!0),e.length&&d(e).fadeOut())});a.$wrapper.on("change",".js-pop-up-disabled",function(){var b=d(this),c=a.$wrapper.find(".js-pop-up-min");b.is(":checked")?(c.prop("readonly",!1),c.focus()):c.prop("readonly",!0)})};
CRMReminderSettings.prototype.validateBeforeSave=function(){return this.$wrapper.find(".js-pop-up-disabled").is(":checked")&&0>=parseInt(d(".js-pop-up-min").val())?(d(".enter-minutes").fadeIn().delay("2000").fadeOut(),!1):!0};return CRMReminderSettings}(jQuery);var CRMLogLive=function(d){var a=function(c){a=function(e){this.list_name=e.names.list;this.items_name=e.names.items;this.pagind_name=e.names.paging;this.log=e.log;this.$wrapper=e.$wrapper||!1;this.$list=this.$wrapper.find(this.list_name);this.$window=c(window);this.onLoad=e.onLoad||function(){};this.$paging=this.$wrapper.find(this.pagind_name);this.is_locked=this.xhr=!1;this.addWatcher()};a.prototype.addWatcher=function(){function e(){var h=window&&c.contains(document,f.$paging[0]);h&&g&&window.frameElement&&
(h=c.contains(g.document,window.frameElement));if(h)f.onScroll();else f.$window.off("scroll",e),c(g).off("scroll",e)}var f=this,g=window.parent;f.$window.on("scroll",e);if(g&&window.frameElement)c(g).on("scroll",e)};a.prototype.onScroll=function(){var e=this.$window,f=e.scrollTop();e=e.height();var g=this.$paging.offset().top;if(window.parent&&window.frameElement){var h=c(window.parent);e=h.height();f+=h.scrollTop();g+=c(window.frameElement).offset().top}f+e>=g&&!this.is_locked&&(this.is_locked=!0,
this.loadNextPage())};a.prototype.loadNextPage=function(){var e=this,f=e.log.filtersData.slice(0);f.push({name:"max_id",value:e.$paging.data("max-id")});f.push({name:"timestamp",value:e.$list.find(e.items_name).last().data("timestamp")});e.xhr&&e.xhr.abort();e.xhr=c.get("?module=logLive",f,function(g){var h=c("<div id='c-temp-wrapper' />");e.log.$wrapper.after(h);h.html(g);g=h.find(e.list_name+" "+e.items_name);h=h.find(e.pagind_name);e.$list.append(g);e.$paging.after(h);e.$paging.remove();e.$paging=
h;e.is_locked=!1;e.onLoad()})};return a}(jQuery),b=function(c){function e(l,k){var m=l.offsetWidth;l=l.offsetHeight;return{outer_width:m,outer_height:l,inner_width:m-k.left-k.right,inner_height:l-k.top-k.bottom}}function f(l){function k(v){var w=v.split("-");v=parseInt(w[0]);var x=parseInt(w[1])-1;w=parseInt(w[2]);return new Date(v,x,w)}var m=[];l=function(v){function w(x,y){var z=x.split("-");x=parseInt(z[0]);var A=parseInt(z[1])-1;z=parseInt(z[2]);A=new Date((new Date(x,A,z)).getTime()+(y?864E5:
-864E5));y=parseInt(A.getFullYear());x=parseInt(A.getMonth())+1;A=parseInt(A.getDate());10>A&&(A="0"+A);10>x&&(x="0"+x);return[y,x,A].join("-")}1===v[0].data.length&&c.each(v,function(x){var y=v[x].data[0],z={value:0,date:w(y.date,!1)},A={value:0,date:w(y.date,!0)};v[x].data=[z,y,A]});return v}(l);for(var n=0;n<l.length;n++){for(var p=l[n].data,q=[],r=0;r<p.length;r++){var t=p[r],u=parseInt(t.value);q.push({date:k(t.date),value:u})}m.push(q)}return d3.layout.stack().offset("zero").values(function(v){return v}).x(function(v){return v.date}).y(function(v){return v.value})(m)}
function g(l,k,m){var n=null;m+=1;l&&m&&(n=(l-k*(m-1))/m,1>n&&(n=1));return n}function h(l,k){var m=k[0];k=k[1]||1;m=k-m+(1<k-m?0:1);k=m/(l-1);for(var n=[],p=0;p<l;p++){var q=10<m?Math.round(p*k):parseInt(p*k*10)/10;n.push(q)}return n}b=function(l){this.$wrapper=l.$wrapper;this.$hint=this.$wrapper.find(".js-hint-wrapper");this.node=this.$wrapper.find(".js-chart-wrapper")[0];this.d3node=d3.select(this.node);this.show_class="is-shown";this.charts=l.data;this.data=f(this.charts);this.group_by=l.group_by;
this.locales=l.locales;this.margin={top:14,right:10,bottom:28,left:34};this.area=e(this.node,this.margin);this.column_indent=200<this.data[0].length?2:4;this.column_width=g(this.area.inner_width,this.column_indent,this.data[0].length);this.yAxis=this.xAxis=this.yDomain=this.xDomain=this.y=this.x=this.defs=this.svg=!1;this.initGraph()};b.prototype.initGraph=function(){var l=this,k=l.area;l.initGraphCore();200<l.data[0].length&&l.$wrapper.addClass("is-large");l.svg=l.d3node.append("svg").attr("width",
k.outer_width).attr("height",k.outer_height);l.renderBackground();l.renderCharts();l.renderAxis();setTimeout(function(){function m(){c.contains(document,l.$wrapper[0])?l.update():c(window).off("resize",m)}c(window).on("resize",m)},4)};b.prototype.initGraphCore=function(){var l=this.data,k=this.area,m=this.x=d3.time.scale().range([0,k.inner_width]);k=this.y=d3.scale.linear().range([k.inner_height,0]);this.yDomain=function(){var n=d3.min(l,function(q){return d3.min(q,function(r){return r.value})});
0<n&&(n=0);var p=d3.max(l,function(q){return d3.max(q,function(r){return r.value+r.y0})});return[n,p]}();this.xDomain=function(){var n=l[0][0].date;var p=l[0][l[0].length-1].date;var q=parseInt((l[0][1].date.getTime()-n.getTime())/2);n=new Date(n.getTime()-q);p=new Date(p.getTime()+q);return[n,p]}();m.domain(this.xDomain);k.domain(this.yDomain)};b.prototype.renderAxis=function(){var l=this.x,k=this.y,m=this.svg;this.xAxis=d3.svg.axis().scale(l).orient("bottom").ticks(10);this.yAxis=d3.svg.axis().scale(k).innerTickSize(2).orient("right").tickValues(h(6,
this.yDomain)).tickFormat(function(n){return n+""});l=m.append("g").attr("class","axis");l.append("g").attr("transform","translate(10,"+this.margin.top+")").attr("class","y").call(this.yAxis);l.append("g").attr("class","x").attr("transform","translate("+this.margin.left+","+(this.area.outer_height-this.margin.bottom)+")").call(this.xAxis)};b.prototype.renderBackground=function(){var l=this.area.inner_width,k=this.area.inner_height,m,n=this.svg.append("g").attr("class","background").attr("transform",
"translate("+this.margin.left+","+this.margin.top+")");n.append("rect").attr("width",l).attr("height",k);for(m=0;5>=m;m++){var p=1+(k-2)/5*m;n.append("line").attr("x1",1).attr("x2",l).attr("y1",p).attr("y2",p)}};b.prototype.renderCharts=function(){var l=this,k=l.data;k=l.svg.selectAll(".c-graph-wrapper").data(k);k.enter().append("g").attr("class","c-graph-wrapper").attr("transform","translate("+l.margin.left+","+l.margin.top+")");var m=k.selectAll(".rect").data(function(n){return n});m.enter().append("rect").attr("class",
"rect").style("fill",function(n,p,q){return(n=l.charts[q].color)?n:!1}).on("mouseover",function(n,p,q){l.showHint(d3.event,this,n,l.charts[q])}).on("mousemove",function(){l.moveHint(this)}).on("mouseout",function(){l.hideHint()});m.transition().duration(1E3).attr("x",function(n,p){return l.x(n.date)-l.column_width/2}).attr("y",function(n){return l.y(n.y0)+l.y(n.value)-l.area.inner_height}).attr("height",function(n){return l.area.inner_height-l.y(n.value)}).attr("width",l.column_width);m.exit().remove();
k.exit().remove()};b.prototype.update=function(l){if(!l)return!1;this.data=f(l.chart);this.group_by=l.group_by||"days";this.area=e(this.node,this.margin);this.column_indent=200<this.data[0].length?2:4;this.column_width=g(this.area.inner_width,this.column_indent,this.data[0].length);this.svg.attr("width",this.area.outer_width).attr("height",this.area.outer_height);200<this.data[0].length?this.$wrapper.addClass("is-large"):this.$wrapper.removeClass("is-large");this.initGraphCore();this.yAxis.scale(this.y).tickValues(h(6,
this.yDomain));this.svg.selectAll(".axis .y").transition().duration(600).call(this.yAxis);this.xAxis.scale(this.x);this.svg.selectAll(".axis .x").transition().duration(600).call(this.xAxis);this.renderCharts()};b.prototype.showHint=function(l,k,m,n){var p=this;l=c(k);if(!(0<Math.ceil(l.attr("height"))))return!1;var q=m.date;k=p.$hint.find(".c-date");var r=p.$hint.find(".c-app"),t=p.$hint.find(".c-value");q=function(u,v){var w=parseInt(u.getMonth());"months"==v?(u=p.locales.months,u[w]||(u="\u042f\u043d\u0432\u0430\u0440\u044c \u0424\u0435\u0432\u0440\u0430\u043b\u044c \u041c\u0430\u0440\u0442 \u0410\u043f\u0440\u0435\u043b\u044c \u041c\u0430\u0439 \u0418\u044e\u043d\u044c \u0418\u044e\u043b\u044c \u0410\u0432\u0433\u0443\u0441\u0442 \u0421\u0435\u043d\u0442\u044f\u0431\u0440\u044c \u041e\u043a\u0442\u044f\u0431\u0440\u044c \u041d\u043e\u044f\u0431\u0440\u044c \u0414\u0435\u043a\u0430\u0431\u0440\u044c".split(" ")),
w=u[w]):(v=u.getDate(),w+=1,w=(10>v?"0"+v:v)+"."+(10>w?"0"+w:w)+"."+u.getFullYear());return w}(q,p.group_by);k.text(q);r.text(n.name);t.text(m.value);m=function(u){var v=c(window),w=v.width();v.height();v=p.$hint.outerWidth();var x=p.$hint.outerHeight(),y=Math.ceil(u.attr("width")),z=Math.ceil(u.attr("height")),A=p.$wrapper.offset();u=u.offset();x={left:u.left-A.left+y+10,top:u.top-A.top+(z<x?z-x-2:2)};w<u.left+10+v&&(x.left=u.left-A.left-y-v);return x}(l);p.$hint.css(m).addClass(p.show_class)};b.prototype.moveHint=
function(){};b.prototype.hideHint=function(){this.$hint.removeAttr("style").removeClass(this.show_class)};return b}(jQuery);CRMLogLive=function(c){this.$wrapper=c.$wrapper;this.$filtersForm=this.$wrapper.find("form.js-filters-form");this.chartData=c.chartData;this.chartParams=c.chartParams;this.locales=c.locales;this.chart=!1;this.filtersData=this.$filtersForm.serializeArray();this.initClass()};CRMLogLive.prototype.initClass=function(){this.initLogList();this.initDateFilter();this.initChart()};CRMLogLive.prototype.initLogList=
function(){function c(){e.find(".c-activity-item.is-first").each(function(){var f=d(this).prev().prev();f.hasClass("is-last")||f.addClass("is-last")})}var e=this.$wrapper.find("#c-activity-section");c();new a({$wrapper:e,names:{list:".c-activity-list",items:"> li",paging:".c-paging-wrapper"},log:this,onLoad:c})};CRMLogLive.prototype.initDateFilter=function(){function c(t){var u=t.data("timeframe"),v=t.data("group")||"days";n.html(t.find("a").html());r.length&&r.removeClass("selected");r=t.addClass("selected");
l.hide();setTimeout(function(){l.removeAttr("style")},200);m.val(u);k.val(v);"custom"!==u?(p.removeClass("is-shown"),e()):p.addClass("is-shown")}function e(){var t=h.serializeArray();t.push({name:"chart",value:1});d.post("?module=logLive",t,function(u){"ok"==u.status&&(u=u.data,u.group_by=k.val(),f.chart.update(u))},"json").always(function(){q=!1})}var f=this,g=f.$wrapper.find(".js-dates-filter"),h=g.find("form"),l=g.find(".js-list"),k=g.find(".js-group-field"),m=g.find(".js-timeframe-field"),n=g.find(".js-link-text"),
p=g.find(".js-hidden-part"),q=!1,r=l.find(".selected");l.on("click",".js-toggle",function(t){t.preventDefault();c(d(this))});h.on("submit",function(t){t.preventDefault();q||(q=!0,e())});(function(){g.find(".js-datepicker").each(function(){var t=d(this),u=g.find("."+t.data("selector"));t.datepicker({altField:u,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0})})})()};CRMLogLive.prototype.initChart=function(){var c=this.$wrapper.find(".js-chart-section");c.length&&this.chartData&&this.chartData.length&&
(this.chart=new b({$wrapper:c,data:this.chartData,group_by:this.chartParams.group_by,locales:this.locales}))};return CRMLogLive}(jQuery),CRMLogLiveItem=function(d){CRMLogLiveItem=function(a){this.$wrapper=a.$wrapper;this.initClass()};CRMLogLiveItem.prototype.initClass=function(){d.crm.renderSVG(this.$wrapper);this.$wrapper.data("logLiveItem",this)};return CRMLogLiveItem}(jQuery);var CRMCallPage=function(d){CRMCallPage=function(a){this.$wrapper=a.$wrapper;this.call_ts=a.call_ts;this.locales=a.locales;this.numbers_assigned=a.numbers_assigned;this.initClass()};CRMCallPage.prototype.initClass=function(){d.wa_push&&d.wa_push.init();d.crm.renderSVG(this.$wrapper);this.initRedirectCall();this.initDeleteCall();this.numbers_assigned&&d.wa_push&&d.wa_push.init();this.initAssociateDeal();this.initBackgroundReload();this.initFinishCallLinks()};CRMCallPage.prototype.initFinishCallLinks=
function(){this.$wrapper.on("click",".js-finish-call",function(a){var b=d(this);a=d.crm.app_url+"?module=call&action=finish";var c=b.closest(".c-call-wrapper"),e=c.data("id");0>=e||b.data("loading")||(b.data("loading",1),b.find(".loading").show(),b.find(".yes-bw").hide(),d.post(a,{id:e},function(f){if("ok"===f.status){f=d("<div>").html(f.data.html);var g=f.find('.c-call-wrapper[data-id="'+e+'"]').find(".c-column-state");c.find(".c-column-state").replaceWith(g);f.remove()}else b.data("loading",0),
b.find(".loading").hide(),b.find(".yes-bw").show()}).error(function(){b.data("loading",0);b.find(".loading").hide();b.find(".yes-bw").show()}))})};CRMCallPage.prototype.initRedirectCall=function(){this.$wrapper.on("click",".js-redirect-call",function(a){a=d(this).parents(".c-call-wrapper").data("id");a=d.crm.app_url+"?module=call&action=redirectDialog&id="+a;var b=d(this);b.prop("disabled",!0).find(".icon16").removeClass("rotate-right").addClass("loading");d.get(a,function(c){new CRMDialog({html:c,
onOpen:function(){b.prop("disabled",!1).find(".icon16").removeClass("loading").addClass("rotate-right")}})})})};CRMCallPage.prototype.initDeleteCall=function(){function a(e){var f=e.closest(".c-call-wrapper"),g=f.data("id"),h=e.data("title");d.crm.confirm.show({title:h,text:b.locales.delete_confirm_text,button:b.locales.delete_confirm_button,onConfirm:function(){if(!c){c=!0;var l={id:g},k=e.find(".delete");k.removeClass("delete").addClass("loading");d.post("?module=call&action=delete",l,function(m){"ok"===
m.status&&f.remove()}).always(function(){k.removeClass("loading").addClass("delete");c=!1})}}})}var b=this,c=!1;b.$wrapper.on("click",".js-delete-call",function(e){e.preventDefault();a(d(this))})};CRMCallPage.prototype.initAssociateDeal=function(){this.$wrapper.find(".js-associate-deal").on("click",function(){var a=d(this).data("dialog-url");d.get(a,function(b){new CRMDialog({html:b})})})};CRMCallPage.prototype.initBackgroundReload=function(){function a(){clearTimeout(f);f=setTimeout(b,1E4)}function b(){var g=
!1,h=c.$wrapper.find("audio");d.each(h,function(l,k){d(k)[0].ended||(g=!0)});if(g)return a(),!1;e||(e=!0,d.post("?module=call&action=ts&background_process=1",{call_ts:c.call_ts},function(l){"ok"==l.status&&d.contains(document,c.$wrapper[0])&&(l.data!==c.call_ts?d.crm.content.reload():a())}).always(function(){e=!1}))}var c=this,e=!1,f=0;a()};return CRMCallPage}(jQuery);var CRMCallAssociateDealDialog=function(d){CRMCallAssociateDealDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$footer=this.$wrapper.find(".js-dialog-footer");this.$submit=this.$form.find(".js-submit");this.$deal_name=this.$form.find(".js-deal-name");this.$deal_funnel=this.$form.find(".js-select-deal-funnel");this.$deal_stage=this.$form.find(".js-select-deal-stage");this.$deal_id=this.$form.find(".js-deal-id");this.dialog=this.$wrapper.data("dialog");this.initClass()};
CRMCallAssociateDealDialog.prototype.initClass=function(){d.crm.renderSVG(this.$wrapper);this.initSelectDeal();this.initSubmit()};CRMCallAssociateDealDialog.prototype.initSelectDeal=function(){var a=this,b=a.$form.find(".js-select-deal .js-visible-link .js-text"),c=a.$form.find(".js-select-funnel"),e=a.$form.find(".js-deals-list"),f=a.$form.find(".js-deal-name-field");a.$form.on("click",".js-create-new-deal",function(){a.$submit.addClass("yellow").removeAttr("disabled");var g=d(this).find(".js-text").html();
a.deal_selected=!0;c.removeClass("hidden");f.removeClass("hidden");a.$deal_name.focus();b.html(g);a.$deal_id.val("0")});a.$form.on("click",".js-deal-item",function(){a.$submit.addClass("yellow").removeAttr("disabled");var g=d(this).find(".js-text").html();a.deal_selected=!0;e.find("li").removeClass("selected");d(this).parent().addClass("selected");b.html(g);c.addClass("hidden");f.addClass("hidden");a.$deal_name.val("");a.$deal_id.val(d(this).data("deal-id"))});e.on("click",function(){e.hide();setTimeout(function(){e.removeAttr("style")},
200)});a.$form.on("change",".js-select-deal-funnel",function(){a.$form.find(".js-select-stage-wrapper").load("?module=deal&action=stagesByFunnel&id="+d(this).val())})};CRMCallAssociateDealDialog.prototype.initSubmit=function(){function a(){var e=d('<i class="icon16 loading" style="vertical-align: middle; margin-left: 6px;"></i>'),f=d.crm.app_url+"?module=call&action=associateDealSave",g=b.$form.serializeArray();b.$submit.prop("disabled",!0);b.$footer.append(e);d.post(f,g,function(h){"ok"===h.status?
d.crm.content.reload():(b.$submit.prop("disabled",!1),e.remove())})}var b=this,c=b.$wrapper.find(".js-deal-value");b.$form.on("submit",function(e){e.preventDefault();if(!b.$deal_id.val())return c.addClass("shake animated").focus(),setTimeout(function(){c.removeClass("shake animated").focus()},500),!1;if(0==b.$deal_id.val()&&!d.trim(b.$deal_name.val()))return b.$deal_name.addClass("shake animated").focus(),setTimeout(function(){b.$deal_name.removeClass("shake animated").focus()},500),!1;a()})};return CRMCallAssociateDealDialog}(jQuery);var CRMCallInitContactDialog=function(d){CRMCallInitContactDialog=function(a){this.$wrapper=a.$wrapper;this.$footer=this.$wrapper.find(".js-dialog-footer");this.$form=this.$wrapper.find("form");this.$call_button=this.$form.find(".js-init-call");this.$content=this.$form.find(".js-content");this.$numbers_list=this.$form.find(".js-numbers-list");this.$plugin_id=this.$form.find(".js-plugin-id");this.dialog=this.$wrapper.data("dialog");this.call_id=0;this.call_ready=a.call_ready;this.locales=a.locales;
this.initClass()};CRMCallInitContactDialog.prototype.initClass=function(){"ready"===this.call_ready?this.initCall():(this.selectExtensionNumber(),this.submit())};CRMCallInitContactDialog.prototype.selectExtensionNumber=function(){var a=this;a.$form.on("click",".js-number-item",function(){var b=d(this).data("plugin-id");a.$plugin_id.val(d.crm.escape(b));a.$call_button.prop("disabled",!1)})};CRMCallInitContactDialog.prototype.submit=function(){var a=this;a.$form.on("submit",function(b){b.preventDefault();
if(!a.$plugin_id.val())return a.$numbers_list.addClass("shake animated"),setTimeout(function(){a.$numbers_list.removeClass("shake animated")},500),!1;a.initCall()})};CRMCallInitContactDialog.prototype.initCall=function(){var a=this,b=d('<i class="icon16 loading" style="vertical-align: middle; margin-left: 6px;"></i>'),c=d.crm.app_url+"?module=call&action=initNew",e=a.$form.serializeArray();a.$call_button.prop("disabled",!0);a.$footer.append(b);d.post(c,e).done(function(f){"ok"===f.status?(a.call_id=
f.data.call_id,a.callChecker()):console.error(f)}).fail(function(){a.dialog.close()}).always(function(){a.$call_button.prop("disabled",!1);b.remove()})};CRMCallInitContactDialog.prototype.callChecker=function(){function a(){d.post(d.crm.app_url+"?module=call&action=checkStatus",{id:c},function(k){try{k.errors&&(clearInterval(l),b.$content.html(h),setTimeout(function(){b.dialog.close();d.crm.content.reload()},3E3),console.log(k.errors.message)),"PENDING"===k.data.status_id?b.$content.html(f):"CONNECTED"===
k.data.status_id?b.$content.html(g):(b.$content.html(h),clearInterval(l),setTimeout(function(){b.dialog.close();d.crm.content.reload()},3E3))}catch(m){clearInterval(l),console.log("Error while updating call status"),console.log(m)}})}var b=this,c=b.call_id,e='<input class="button js-close-dialog" type="submit" value="'+b.locales.Close+'">',f='<div class="c-call-pending">'+b.locales.call_pending+'<i class="icon16 loading" style="vertical-align: middle; margin-left: 6px;"></i></div>',g='<div style="color: #00ff00;">'+
b.locales.call_connected+"</div>",h='<div style="color: #5159c3;">'+b.locales.call_finished+"</div>";b.$content.html(f);b.$footer.html(e);a();var l=setInterval(a,2E3)};return CRMCallInitContactDialog}(jQuery);var CRMCallRedirectDialog=function(d){CRMCallRedirectDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$button=this.$form.find(".js-submit");this.$autocomplete=this.$form.find(".js-autocomplete");this.$other_radio=this.$form.find(".js-other-candidate");this.$number=this.$form.find(".js-number");this.initClass()};CRMCallRedirectDialog.prototype.initClass=function(){this.initAutocomplete();this.initSelectCandidate();this.initSubmit()};CRMCallRedirectDialog.prototype.initAutocomplete=
function(){var a=this,b=a.$form.find(".js-candidate"),c=b.find(".js-delete-candidate");a.$autocomplete.autocomplete({source:d.crm.app_url+"?module=autocomplete&type=user&phonecomplete=true",appendTo:a.$wrapper,minLength:0,focus:function(){return!1},select:function(e,f){a.$number.val(f.item.phone);b.find(".js-label").html(f.item.label);a.$autocomplete.css("display","none");b.removeClass("hidden");return!1}}).data("ui-autocomplete")._renderItem=function(e,f){return d('<li class="ui-menu-item-html"><div>'+
f.value+"</div></li>").appendTo(e)};a.$autocomplete.on("focus",function(){d(this).data("uiAutocomplete").search(d(this).val())});c.on("click",function(){a.$number.val("");b.addClass("hidden");a.$autocomplete.val("").removeAttr("style").focus()})};CRMCallRedirectDialog.prototype.initSelectCandidate=function(){var a=this,b=a.$form.find(".js-other-lbl"),c=a.$form.find(".js-candidate"),e=a.$form.find(".js-number-type");a.$form.on("change",":radio[name='redirect[to]']",function(){a.$other_radio.prop("checked")?
(e.val("external"),a.$number.val(""),a.$autocomplete.removeAttr("style").focus(),b.css("display","none")):(e.val("interior"),a.$number.val(d(this).val()),a.$autocomplete.css("display","none"),c.addClass("hidden"),a.$autocomplete.val(""),b.removeAttr("style"));a.$button.prop("disabled",!1)})};CRMCallRedirectDialog.prototype.initSubmit=function(){var a=this,b=a.$form.find(".js-field-name");a.$form.on("submit",function(c){c.preventDefault();var e=a.$wrapper.find(".js-call-id").val(),f=a.$number.val();
d.trim(f)||(f=d.trim(a.$autocomplete.val()));if(!d.trim(f))return b.addClass("shake animated"),setTimeout(function(){b.removeClass("shake animated")},500),!1;(function(){var g=a.$form.find(".js-number-type").val(),h=a.$wrapper.find(".js-dialog-footer"),l=d('<i class="icon16 loading" style="vertical-align: middle; margin-left: 6px;"></i>');a.$button.prop("disabled",!0);h.append(l);d.post(d.crm.app_url+"?module=call&action=redirect",{call_id:e,number_type:g,number:f},function(k){"ok"===k.status&&(l.removeClass("loading").addClass("yes"),
setTimeout(function(){d.crm.content.reload()},2E3))})})()})};return CRMCallRedirectDialog}(jQuery);var CRMMessageDeleteLinkMixin=function(d){CRMMessageDeleteLinkMixin=function(){};CRMMessageDeleteLinkMixin.prototype.initMessageDeleteLink=function(){function a(){var c=d.crm.app_url+"?module=message&action=delete",e={id:b.message.id},f=d('<i class="icon16 loading" style="vertical-align: middle; margin-left: 12px;"></i>');f.appendTo(b.$button.parent());b.$button.attr("disabled",!0);d.post(c,e,function(g){if("ok"===g.status)d.crm.content.reload();else{console.log("Error saving Responsible contact classification: "+
arguments[2],arguments);var h="Error saving Responsible contact classification: "+arguments[2];h=d('<div class="errormsg" />').text(h);b.$errorsPlace.append(h)}},"json").always(function(){b.$button.attr("disabled",!1);f.remove()})}var b=this;b.$wrapper.find(".js-delete-message").on("click",function(){event.preventDefault();d.crm.confirm.show({title:b.locales.delete_message,text:b.locales.delete_message_text,button:b.locales["delete"],onConfirm:a})})};CRMMessageDeleteLinkMixin.mixInFor=function(a){a.prototype=
d.extend(a.prototype,CRMMessageDeleteLinkMixin.prototype);return a};return CRMMessageDeleteLinkMixin}(jQuery);var CRMMessagesPage=function(d){CRMMessagesPage=function(a){this.$wrapper=a.$wrapper;this.dialog=this.$wrapper.data("dialog")||!1;this.locales=a.locales;this.app_url=a.app_url||d&&d.crm&&d.crm.app_url;this.is_dialog=a.is_dialog||!1;this.is_dialog||(this.page=a.page,this.message_ts=a.message_ts);this.settings=a;this.initClass()};CRMMessagesPage.prototype.initClass=function(){d.crm.renderSVG(this.$wrapper);this.initWriteNewMessage();this.initMessageShowBodyLink();this.initMessagesByGroupLink();this.initSwitchLoader();
this.is_dialog||this.page||this.initBackgroundUpdate();new CRMPageMessagesOperations(this.settings)};CRMMessagesPage.prototype.initWriteNewMessage=function(){this.$wrapper.on("click",".js-write-message",function(){d.get("?module=message&action=writeNewDialog",function(a){new CRMDialog({html:a})})})};CRMMessagesPage.prototype.initMessagesByGroupLink=function(){var a=this,b=a.dialog;a.$wrapper.on("click",".js-message-by-group",function(){var c=d(this).parents("tr.c-message-wrapper"),e=c.data("last-message-id");
b&&b.hide();d.get(d(this).data("dialog-url"),function(f){new CRMDialog({html:f,onOpen:function(g,h){a.initMessageReplyBtn(g,h);a.initMessageForwardBtn(g,h);g.on("click",".c-message-wrapper a",function(l){l.preventDefault()});g.on("click",".c-message-wrapper",function(l){l.preventDefault();var k=d(l.target);l=d(this);var m=l.data("id");k=k.attr("href");e==m&&c.removeClass("bold");k||(l=l.find(".js-message-show-body"),l.length&&l.trigger("click"))})},onClose:function(){b&&b.show()}})})})};CRMMessagesPage.prototype.initMessageShowBodyLink=
function(){var a=this,b=a.dialog;a.$wrapper.find(".js-message-show-body").on("click","td:not(.c-checkbox)",function(){var c=d(this).parent();d.get(c.data("dialog-url"),function(e){b&&b.hide();new CRMDialog({html:e,onOpen:function(f,g){c.removeClass("bold");a.initMessageReplyBtn(f,g);a.initMessageForwardBtn(f,g)},onClose:function(){b&&b.show()}})})})};CRMMessagesPage.prototype.initMessageReplyBtn=function(a,b){var c=this,e=a.find(".js-dialog-footer"),f=d('<i class="icon16 loading" style="vertical-align: middle; margin-left: 6px;"></i>');
a.on("click",".js-message-reply",function(){var g=d(this).data("message-id");e.append(f);d.post(c.app_url+"?module=message&action=writeReplyDialog",{id:g},function(h){b.hide();new CRMDialog({html:h,onOpen:function(){f.remove()},onClose:function(){f.remove();b.show()}})})})};CRMMessagesPage.prototype.initMessageForwardBtn=function(a,b){var c=this,e=a.find(".js-dialog-footer"),f=d('<i class="icon16 loading" style="vertical-align: middle; margin-left: 6px;"></i>');a.on("click",".js-message-forward",
function(){var g=d(this).data("message-id");e.append(f);d.post(c.app_url+"?module=message&action=writeForwardDialog",{id:g},function(h){b.hide();new CRMDialog({html:h,onOpen:function(){f.remove()},onClose:function(){b.show()}})})})};CRMMessagesPage.prototype.initSwitchLoader=function(){this.$wrapper.on("click",".js-switch-message-view",function(){d(this).find(".icon16").attr("class","icon16 loading")})};CRMMessagesPage.prototype.initBackgroundUpdate=function(){function a(){f||(f=!0,d.contains(document,
c.$wrapper[0])&&d.post("?module=message&action=ts&background_process=1",{message_ts:e},function(h){"ok"===h.status&&(h=h.data!==e,d.contains(document,c.$wrapper[0])&&(h&&!d(".crm-dialog-wrapper:visible").length?b():(clearTimeout(g),g=setTimeout(a,12E4))))},"json").always(function(){f=!1}))}function b(){d.get(d.crm.app_url+"message/?view=all&reload=1",function(h){d.crm.content.$content.html(h)})}var c=this,e=c.message_ts,f=!1,g=0;clearTimeout(g);g=setTimeout(a,12E4)};return CRMMessagesPage}(jQuery),
CRMDealMessagesDialog=function(d){CRMDealMessagesDialog=function(a){this.$wrapper=a.$wrapper;this.initClass()};CRMDealMessagesDialog.prototype.initClass=function(){this.$wrapper.on("click",".c-message-wrapper a",function(a){a.preventDefault()});this.$wrapper.on("click",".c-message-wrapper",function(a){a.preventDefault();a=d(a.target);var b=d(this);a.attr("href")||(a=b.find(".js-message-show-body"),a.length&&a.trigger("click"))})};return CRMDealMessagesDialog}(jQuery),CRMMessageBodyDialog=function(d){CRMMessageBodyDialog=
function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".js-close-dialog");this.contact_id=a.contact_id;this.message=a.message||{};this.locales=a.locales;this.initClass()};CRMMessageBodyDialog.prototype.initClass=function(){this.initSelectDeal();this.initMessageDeleteLink()};CRMMessageBodyDialog.prototype.initSelectDeal=function(){function a(){n.html("<b><i>"+c.locales.deal_empty+"</i></b>");t.val("none");g.val("");f.addClass("c-deal-name-hidden");h.addClass("hidden").removeAttr("title");
m.addClass("c-empty-deal-hidden");p.addClass("hidden");r.find("li").removeClass("selected");l.removeClass("hidden")}function b(){var v=c.$wrapper.find(".js-created-deal"),w=q.find(".js-visible-link .js-text .funnel-state").clone(),x=d.trim(g.val()),y=e.serializeObject();y.message_id=c.message.id;if("none"===t.val())return e.addClass("shake animated"),setTimeout(function(){e.removeClass("shake animated")},500),!1;if(0>=t.val()&&!x)return f.addClass("shake animated"),setTimeout(function(){f.removeClass("shake animated");
g.focus()},500),!1;e.addClass("deal-form-hidden");v.removeClass("hidden");0>=t.val()?(v.html(w),v.append(d.crm.escape(x))):(x=l.find(".js-visible-link .js-text"),w=x.find(".funnel-state").clone(),x=x.find("b i").text(),v.html(w),v.append(d.crm.escape(x)));d.post(d.crm.app_url+"?module=message&action=associateDealSave",y,function(z){if("ok"===z.status&&z.data.deal_url){var A=v.html();v.html('<a href="'+z.data.deal_url+'">'+A+"</a>")}else v.html(""),v.addClass("hidden"),a(),e.removeClass("deal-form-hidden")})}
var c=this,e=c.$wrapper.find(".deal-form"),f=e.find(".js-deal-name"),g=e.find(".js-deal-name-input"),h=e.find(".js-save-deal"),l=e.find(".js-deals-dropdown"),k=e.find(".js-remove-deal"),m=l.find(".js-empty-deal"),n=e.find(".js-select-deal .js-visible-link .js-text"),p=e.find(".js-select-funnel-wrapper"),q=e.find(".js-select-stage-wrapper"),r=e.find(".js-deals-list"),t=e.find(".js-deal-id"),u=c.contact_id;t.val("none");u&&d.get("?module=deal&action=byContact&id="+u,function(v){"ok"===v.status&&(d.each(v.data.deals,
function(w,x){r.prepend('<li><a href="javascript:void(0);" class="js-deal-item" data-deal-id="'+x.id+'"><span class="js-text"><i class="icon16 funnel-state svg-icon" data-color="'+v.data.funnels[x.funnel_id].stages[x.stage_id].color+'"></i><b><i>'+x.name+"</i></b></span></a></li>")}),d.crm.renderSVG(c.$wrapper))},"json");e.on("click",".js-create-new-deal",function(){t.val("0");l.addClass("hidden");f.removeClass("c-deal-name-hidden");h.attr("title",c.locales.deal_create).removeClass("hidden");p.removeClass("hidden");
m.removeClass("c-empty-deal-hidden");g.focus()});e.on("click",".js-deal-item",function(){var v=d(this).find(".js-text").html();n.html(v);t.val(d(this).data("deal-id"));h.attr("title",c.locales.deal_add).removeClass("hidden");p.addClass("hidden");m.removeClass("c-empty-deal-hidden");r.find("li").removeClass("selected");d(this).parent().addClass("selected")});r.on("click",function(){r.hide();setTimeout(function(){r.removeAttr("style")},200)});m.on("click",function(){a()});k.on("click",function(){a()});
h.on("click",function(v){v.preventDefault();e.trigger("submit")});e.on("submit",function(v){v.preventDefault();b()});e.on("change",".js-select-deal-funnel",function(){e.find(".js-select-stage-wrapper").load("?module=deal&action=stagesByFunnel&id="+d(this).val())})};CRMMessageDeleteLinkMixin.mixInFor(CRMMessageBodyDialog);return CRMMessageBodyDialog}(jQuery),CRMMessagesListPage=function(d){CRMMessagesListPage=function(a){this.$wrapper=a.$wrapper;this.page=a.page;this.last_message_id=a.last_message_id;
this.settings=a;this.initClass()};CRMMessagesListPage.prototype.initClass=function(){d.crm.renderSVG(this.$wrapper);this.$wrapper.on("click",".js-associate-deal",function(a){a.preventDefault();a=d(this).data("dialog-url");d.get(a,function(b){new CRMDialog({html:b})})});this.$wrapper.on("click",".js-write-message",function(a){a.preventDefault();d.get(d.crm.app_url+"?module=message&action=writeNewDialog",function(b){new CRMDialog({html:b})})});this.$wrapper.on("click",".js-switch-message-view",function(){d(this).find(".icon16").attr("class",
"icon16 loading")});this.page||this.initBackgroundUpdate();new CRMPageMessagesOperations(this.settings)};CRMMessagesListPage.prototype.initBackgroundUpdate=function(){function a(){f||(f=!0,d.contains(document,c.$wrapper[0])&&d.post("?module=message&action=listByConversation",{check:1},function(h){"ok"===h.status&&(h=h.data!==e,d.contains(document,c.$wrapper[0])&&(h&&!d(".crm-dialog-wrapper:visible").length?b():(clearTimeout(g),g=setTimeout(a,12E4))))},"json").always(function(){f=!1}))}function b(){d.get(d.crm.app_url+
"message/?view=conversation&reload=1",function(h){d.crm.content.$content.html(h)})}var c=this,e=c.last_message_id,f=!1,g=0;clearTimeout(g);g=setTimeout(a,12E4)};return CRMMessagesListPage}(jQuery);var CRMMessageConversationPage=function(d){CRMMessageConversationPage=function(a){this.$wrapper=a.$wrapper;this.locales=a.locales;this.conversation_id=a.conversation_id;this.contact_id=a.contact_id;this.funnel_id=a.funnel_id;this.last_message_id=a.last_message_id;this.check_interval=a.check_interval;this.initClass()};CRMMessageConversationPage.prototype.initClass=function(){d.crm.renderSVG(this.$wrapper);this.$wrapper.find(".js-deal-link").length||this.initSelectDeal();this.initDealActions();this.initChangeResponsible();
this.initBackgroundActions();this.initMessageActions();this.initDelete();this.scroll2bottom();this.initStickiesAtSection();this.initSendEmail()};CRMMessageConversationPage.prototype.loadDealListByContact=function(a){a=a||function(){};var b=this.contact_id;0>=b?a({}):d.get("?module=deal&action=byContact&id="+b,"json").always(function(c){c&&"ok"===c.status?a(c.data||{}):a({})})};CRMMessageConversationPage.prototype.initSelectDeal=function(a){function b(){u.html("<b><i>"+e.locales.deal_empty+"</i></b>");
y.val("none");m.val("");k.addClass("c-deal-name-hidden");n.addClass("hidden").removeAttr("title");t.addClass("c-empty-deal-hidden");v.addClass("hidden");x.find("li").removeClass("selected");0<p.data("deals_count")?(p.removeClass("hidden"),q.addClass("hidden")):(p.addClass("hidden"),q.removeClass("hidden"))}function c(){var z=f.find(".js-created-deal"),A=w.find(".js-visible-link .js-text .funnel-state").clone(),B=d.trim(m.val()),D=l.serializeObject();D.conversation_id=e.conversation_id;if("none"===
y.val())return l.addClass("shake animated"),setTimeout(function(){l.removeClass("shake animated")},500),!1;if(0>=y.val()&&!B)return k.addClass("shake animated"),setTimeout(function(){k.removeClass("shake animated");m.focus()},500),!1;l.addClass("deal-form-hidden");z.removeClass("hidden");0>=y.val()?(z.html(A),z.append(d.crm.escape(B))):(B=p.find(".js-visible-link .js-text"),A=B.find(".funnel-state").clone(),B=B.find("b i").text(),z.html(A),z.append(d.crm.escape(B)));d.post(d.crm.app_url+"?module=message&action=conversationAssociateDealSave",
D,function(C){"ok"===C.status?d.crm.content.reload():(z.html(""),z.addClass("hidden"),b(),l.removeClass("deal-form-hidden"))})}var e=this;a=a||{};var f=a.$wrapper||e.$wrapper,g=function(z){z=z||{};var A=z.funnels||{},B=0;d.each(z.deals||{},function(D,C){D=x;var F=D.prepend;var E=A[C.funnel_id];if(!C||0>=C.id)C="";else{var G=C.id,I=C.name||"",H="",J="";E&&E.stages&&E.stages[C.stage_id]&&(H=E.stages[C.stage_id].color||"");d.isEmptyObject(E)&&(J='<span class="hint">'+e.locales.funnel_deleted+"</span>");
C='<li><a href="javascript:void(0);" class="js-deal-item" data-deal-id="'+G+'"><span class="js-text"><i class="icon16 funnel-state svg-icon" data-color="'+H+'"></i><b><i>'+I+"</i></b></span>"+J+"</a></li>"}F.call(D,C);B++});h.show();p.data("deals_count",B);0<B?(p.removeClass("hidden"),q.addClass("hidden")):(q.removeClass("hidden"),p.addClass("hidden"));d.crm.renderSVG(f)},h=f.find(".js-deal-selector-control-wrapper"),l=h.find(".deal-form"),k=l.find(".js-deal-name"),m=l.find(".js-deal-name-input"),
n=l.find(".js-save-deal"),p=l.find(".js-deals-dropdown"),q=l.find(".js-create-new-deal-link"),r=l.find(".js-remove-deal"),t=p.find(".js-empty-deal"),u=l.find(".js-select-deal .js-visible-link .js-text"),v=l.find(".js-select-funnel-wrapper"),w=l.find(".js-select-stage-wrapper"),x=l.find(".js-deals-list"),y=l.find(".js-deal-id");y.val("none");"undefined"===typeof a.data?e.loadDealListByContact(g):g(a.data);l.on("click",".js-create-new-deal",function(){y.val("0");p.addClass("hidden");q.addClass("hidden");
k.removeClass("c-deal-name-hidden");n.attr("title",e.locales.deal_create).removeClass("hidden");v.removeClass("hidden");t.removeClass("c-empty-deal-hidden");m.focus()});l.on("click",".js-deal-item",function(){var z=d(this).find(".js-text").html();u.html(z);y.val(d(this).data("deal-id"));n.attr("title",e.locales.deal_add).removeClass("hidden");v.addClass("hidden");t.removeClass("c-empty-deal-hidden");x.find("li").removeClass("selected");d(this).parent().addClass("selected")});x.on("click",function(){x.hide();
setTimeout(function(){x.removeAttr("style")},200)});t.on("click",function(){b()});r.on("click",function(){b()});n.on("click",function(z){z.preventDefault();l.trigger("submit")});l.on("submit",function(z){z.preventDefault();c()});l.on("change",".js-select-deal-funnel",function(){l.find(".js-select-stage-wrapper").load("?module=deal&action=stagesByFunnel&id="+d(this).val())});return{submit:function(){l.trigger("submit")}}};CRMMessageConversationPage.prototype.initDealActions=function(){var a=this,b=
a.$wrapper.find(".js-conversation-deal");b.on("click",".js-attach-other-deal",function(e){e.preventDefault();a.loadDealListByContact(function(f){d.get(d.crm.app_url+"?module=messageConversationDeal&action=attachDialog",{id:a.conversation_id},function(g){var h=d(g);new CRMDialog({html:h,onOpen:function(){var l=h.find(".js-conversation-deal"),k=a.initSelectDeal({$wrapper:l,data:f});h.find(".js-save-button").on("click",function(){k.submit()})}})})})});var c=null;b.on("click",".js-detach-deal",function(e){e.preventDefault();
e=b.find(".js-deal-link").text();d.crm.confirm.show({title:a.locales.deal_detach_title,text:a.locales.deal_detach_text.replace(/%s/,e),button:a.locales.deal_detach_confirm_button,onConfirm:function(){c&&c.abort();a.loadDealListByContact(function(f){c=d.post(d.crm.app_url+"?module=messageConversationDeal&action=detach",{id:a.conversation_id}).done(function(g){g&&"ok"===g.status&&(b.html(g.data&&g.data.html),a.initSelectDeal({data:f}))}).always(function(){c=null})})}})})};CRMMessageConversationPage.prototype.initStickiesAtSection=
function(){var a=this,b=function(f){b=function(g){this.$window=f(window);this.$wrapper=g.$wrapper;this.$section=g.$section;this.$wrapperContainer=this.$wrapper.parent();this.type=g.type||"bottom";this.offset={};this.is_fixed=this.$clone=!1;this.initClass()};b.prototype.initClass=function(){function g(){if(f.contains(l[0].document,h.$wrapper[0]))h.onScroll(l.scrollTop());else l.off("scroll",g)}var h=this,l=h.$window,k=0;l.on("resize",function(){clearTimeout(k);k=setTimeout(function(){h.resize()},100)});
l.on("scroll",g);h.$wrapper.on("resize",function(){h.resize()});h.init();h.$wrapper.data("block",h)};b.prototype.init=function(){if(!this.$clone){var g=f("<div />");this.$wrapperContainer.append(g);this.$clone=g}this.$clone.hide();g=this.$wrapper.offset();this.offset={left:g.left,top:g.top,width:this.$wrapper.outerWidth(),height:this.$wrapper.outerHeight()}};b.prototype.resize=function(){switch(this.type){case "top":this.fix2top(!1);break;case "bottom":this.fix2bottom(!1)}var g=this.$wrapper.offset();
this.offset={left:g.left,top:g.top,width:this.$wrapper.outerWidth(),height:this.$wrapper.outerHeight()};this.$window.trigger("scroll")};b.prototype.onScroll=function(g){this.$window.width();var h=this.$window.height();this.offset.top=this.$wrapperContainer.offset().top;switch(this.type){case "top":h=this.$section?g+this.offset.height<this.$section.height()+this.$section.offset().top:!0;this.fix2top(this.offset.top<g&&h);break;case "bottom":this.fix2bottom(this.offset.top&&g+h<this.offset.top+this.offset.height)}};
b.prototype.fix2top=function(g){g?(this.$wrapper.css({left:this.offset.left,width:this.offset.width}).addClass("is-top-fixed"),this.$clone.css({height:this.offset.height}).show()):(this.$wrapper.removeClass("is-top-fixed").removeAttr("style"),this.$clone.removeAttr("style").hide());this.is_fixed=!!g};b.prototype.fix2bottom=function(g){g?(this.$wrapper.css({left:this.offset.left,width:this.offset.width}).addClass("is-bottom-fixed"),this.$clone.css({height:this.offset.height}).show()):(this.$wrapper.removeClass("is-bottom-fixed").removeAttr("style"),
this.$clone.removeAttr("style").hide());this.is_fixed=!!g};return b}(jQuery),c=a.$wrapper.find(".js-reply-wrapper"),e=a.$wrapper.find(".js-conversation-header");(function(){function f(l){l?c.addClass("is-extended").trigger("resize"):h||c.removeClass("is-extended").trigger("resize")}var g=c.find(".js-textarea"),h=!1;g.on("focus",function(){f(!0);d(document).trigger("unmark-new-messages")});g.on("blur",function(){f(!1)});g.on("change paste keyup",function(){var l=d(this).val();h=0<d.trim(l).length});
new b({$wrapper:c,type:"bottom"})})();new b({$wrapper:e,type:"top"});(function(){var f=d('<div class="c-scroll-action to-top to-right"><div class="c-icon to-top"></div></div>'),g=d('<div class="c-scroll-action to-bottom to-right"><div class="c-icon to-bottom"></div></div>');f.appendTo(e);g.appendTo(c);f.on("click",function(){d("html, body").animate({scrollTop:0},500)});g.on("click",function(){a.scroll2bottom(!0,!0)})})()};CRMMessageConversationPage.prototype.initChangeResponsible=function(){function a(m){var n=
"?module=autocomplete&type=user";n=0<e.funnel_id?n+("&funnel_id="+e.funnel_id):n+("&contact_id="+e.contact_id);m.autocomplete({appendTo:m.parent(),source:n,minLength:0,html:!0,focus:function(){return!1},select:function(p,q){b(q.item.id);m.val("");return!1}}).data("ui-autocomplete")._renderItem=function(p,q){var r=d("<li />");r.addClass("ui-menu-item-html").append("<div>"+q.value+"</div>").appendTo(p);q.rights||(r.addClass("is-locked"),r.on("click",function(t){t.preventDefault();t.stopPropagation()}));
return r};m.on("focus",function(){m.data("uiAutocomplete").search(m.val())})}function b(m){f||(f=!0,d.post("?module=message&action=changeConversationUser",{action:"set",id:e.conversation_id,user_contact_id:m},function(n){"ok"===n.status&&(n=d(n.data.html),g.html(n),l.addClass("hidden"),n=g.find(".js-owner-autocomplete"),n.length&&a(n))},"json").always(function(){f=!1}))}function c(){f||(f=!0,d.post("?module=message&action=changeConversationUser",{action:"remove",id:e.conversation_id},function(m){"ok"===
m.status&&(g.html(""),l.removeClass("hidden"),f=!1)},"json").always(function(){f=!1}))}var e=this,f=!1,g=e.$wrapper.find(".js-responsible-wrapper"),h=g.find(".js-owner-autocomplete"),l=e.$wrapper.find(".js-responsible-empty-wrapper"),k=l.find(".js-responsible-empty-autocomplete");g.length&&k.length&&a(k);h.length&&a(h);l.on("click",".js-set-extended, .js-unset-extended",function(){l.toggleClass("is-extended");l.hasClass("is-extended")&&k.focus()});g.on("click",".js-show-combobox",function(){g.find(".c-conversation-member").addClass("is-edit");
g.find(".js-owner-autocomplete").focus()});g.on("click",".js-hide-combobox",function(){g.find(".c-conversation-member").removeClass("is-edit")});g.on("click",".js-remove-owner",function(m){m.preventDefault();m=d.trim(g.find(".c-name").html());d.crm.confirm.show({title:e.locales.remove_owner_title,text:e.locales.remove_owner_text.replace(/%s/,m),button:e.locales.remove_owner_button,onConfirm:function(){c()}})})};CRMMessageConversationPage.prototype.initBackgroundActions=function(){function a(){clearTimeout(g);
g=setTimeout(b,e.check_interval)}function b(){f||(f=!0,d.post("?module=message&action=conversationIdCheck",{id:e.conversation_id},function(h){"ok"===h.status&&(h.data!==e.last_message_id?c().then(function(l){l.length&&e.scroll2bottom(!0,!0);a()}):a())},"json").always(function(){f=!1}))}function c(){var h=d.Deferred();d.get(location.href,function(l){function k(q){function r(){q.removeClass("is-new");q.off("hover",r);t.off("unmark-new-messages",r)}var t=d(document);q.addClass("is-new");q.on("hover",
r);t.on("unmark-new-messages",r);setTimeout(function(){d.contains(document,q[0])&&r()},1E4)}var m=e.last_message_id,n=e.$wrapper.find(".js-messages-list").first();l=d(l).find(".js-messages-list .js-message-wrapper");var p=[];n.length&&(l.each(function(){var q=d(this),r=q.data("id");r>e.last_message_id&&(n.append(q),k(q),p.push({id:r,$message:q}),m=r)}),e.last_message_id=m);h.resolve(p)});return h.promise()}var e=this,f=!1,g=0;a()};CRMMessageConversationPage.prototype.initMessageActions=function(){function a(c){function e(g){if(!f.length)return!1;
g?f.removeClass("rotate-left").addClass("loading"):f.removeClass("loading").addClass("rotate-left")}var f=c.find(".icon16");c=c.closest(".js-message-wrapper").data("id");e(!0);d.post(d.crm.app_url+"?module=message&action=writeReplyDialog",{id:c},function(g){new CRMDialog({html:g})}).always(function(){e(!1)})}function b(c){function e(g){if(!f.length)return!1;g?f.removeClass("rotate-right").addClass("loading"):f.removeClass("loading").addClass("rotate-right")}var f=c.find(".icon16");c=c.closest(".js-message-wrapper").data("id");
e(!0);d.post(d.crm.app_url+"?module=message&action=writeForwardDialog",{id:c},function(g){new CRMDialog({html:g})}).always(function(){e(!1)})}this.$wrapper.on("click",".js-message-reply",function(c){c.preventDefault();a(d(this))});this.$wrapper.on("click",".js-message-forward",function(c){c.preventDefault();b(d(this))})};CRMMessageConversationPage.prototype.initDelete=function(){function a(){c=!0;d.post(d.crm.app_url+"?module=message&action=conversationIdDelete",{id:b.conversation_id},function(e){"ok"===
e.status&&d.crm.content.load(d.crm.app_url+"message/")}).always(function(){c=!1},"json")}var b=this,c=!1;b.$wrapper.on("click",".js-delete-conversation",function(e){e.preventDefault();c||d.crm.confirm.show({title:b.locales.delete_conversation_title,button:b.locales.delete_conversation_button,onConfirm:a})})};CRMMessageConversationPage.prototype.initSendEmail=function(){var a=!1;this.$wrapper.on("click",".js-show-message-dialog",function(b){b.preventDefault();var c=d(this);b=c.data("id");c=c.data("email");
!a&&b&&(a=!0,d.post("?module=message&action=writeNewDialog",{contact_id:b,email:c},function(e){new CRMDialog({html:e})}).always(function(){a=!1}))})};CRMMessageConversationPage.prototype.scroll2bottom=function(a,b){function c(){setTimeout(function(){d.contains(document,f.$wrapper[0])&&l&&e()},10)}function e(){var k=d(document).height();h<k&&(b?d("html, body").animate({scrollTop:k-h},500):g.scrollTop(k))}var f=this,g=d(window),h=g.height(),l=!0;if(a)e();else if(d.crm.is_page_loaded)c();else g.one("scroll",
function(){l=!1}).one("load",c)};return CRMMessageConversationPage}(jQuery),CRMEmailConversationEmailSender=function(d){CRMEmailConversationEmailSender=function(a){this.$wrapper=a.$wrapper;this.$replySection=this.$wrapper.closest(".js-reply-wrapper");this.$form=this.$wrapper.find("form");this.$textarea=this.$wrapper.find(".js-wysiwyg");this.$sender_email_select=this.$wrapper.find(".js-sender-email-select");this.$sender_email=this.$wrapper.find(".js-sender-email");this.file_template_html=a.file_template_html;
this.max_upload_size=a.max_upload_size;this.locales=a.locales;this.hash=a.hash;this.send_action_url=a.send_action_url;this.body=a.body||"";this.deal_id=a.deal_id;this.is_changed=!1;if(!this.send_action_url)throw Error("send_action_url option required");this.initClass();this.filesController=this.getFilesController()};CRMEmailConversationEmailSender.prototype.initClass=function(){this.senderEmailSelect();this.initWYSIWYG();this.initVisiblityWatcher();this.initSave();this.initPersonalSettingsDialog();
this.initEmailCopy()};CRMEmailConversationEmailSender.prototype.initVisiblityWatcher=function(){function a(c){c?b.addClass("is-extended").trigger("resize"):b.removeClass("is-extended").trigger("resize")}var b=this.$replySection;b.find(".js-visible-textarea").on("focus",function(){a(!0)});b.on("click",".js-revert",function(){a(!1)})};CRMEmailConversationEmailSender.prototype.senderEmailSelect=function(){var a=this;a.$wrapper.on("change",a.$sender_email_select,function(b){b.preventDefault();a.$sender_email.val(a.$sender_email_select.val())})};
CRMEmailConversationEmailSender.prototype.getFilesController=function(){function a(r){r.length&&d.each(r,function(t,u){t=n;var v=t.push,w=d(k);w.find(".js-name").text(u.name);l.prepend(w);v.call(t,{$file:w,file:u})})}function b(r){var t=[];d.each(n,function(u,v){r[0]!==v.$file[0]?t.push(v):r.remove()});n=t}var c=this,e=c.$wrapper.find(".js-files-wrapper");if(!e.length)return!1;var f=e.find(".js-drop-area"),g=e.find(".js-drop-text"),h=e.find(".js-drop-field"),l=e.find(".c-upload-list"),k=c.file_template_html,
m=d.crm.app_url+"?module=file&action=uploadTmp",n=[],p=0,q=0;h.on("change",function(r){r.preventDefault();a(this.files)});f.on("drop",function(r){r.preventDefault();a(r.originalEvent.dataTransfer.files)});f.on("dragover",function(r){r.preventDefault();f.addClass("is-hover");g.text(g.data("hover"));clearTimeout(q);q=setTimeout(function(){f.removeClass("is-hover");g.text(g.data("default"))},100)});e.on("click",".js-file-delete",function(r){r.preventDefault();b(d(this).closest(".c-upload-item"))});return{uploadFiles:function(r,
t){function u(w){function x(){var B=new FormData,D=document.cookie.match(/(?:^|; )_csrf=([^;]*)/);(D=D?decodeURIComponent(D[1]):"")&&B.append("_csrf",D);r&&r.length&&d.each(r,function(C,F){F.name&&F.value&&B.append(F.name,F.value)});B.append("file_size",w.file.size);B.append("files",w.file);B.append("file_end",1);d.ajax({xhr:function(){var C=new window.XMLHttpRequest;C.upload.addEventListener("progress",function(F){if(F.lengthComputable){F=parseInt(F.loaded/F.total*100);var E=[247,198,174];for(var G=
[174,247,196],I=[],H=0;H<E.length;H++)I.push(E[H]+(G[H]-E[H])/100*F);E="rgb("+I.join(",")+")";z.css("background-color",E).width(F+"%");A.text(F+"%")}},!1);return C},url:m,data:B,cache:!1,contentType:!1,processData:!1,type:"POST",success:function(C){A.text(A.data("success"));setTimeout(function(){d.contains(document,y[0])&&(y.remove(),--p,0>=p&&v())},2E3)}}).always(function(){})}var y=w.$file,z=y.find(".js-bar"),A=y.find(".js-status");y.addClass("is-upload");c.max_upload_size>w.file.size?x():(A.addClass("errormsg").text(c.locales.file_size),
y.find(".c-progress-wrapper").remove(),setTimeout(function(){d.contains(document,y[0])&&(y.remove(),--p,0>=p&&v())},2E3))}var v=t?t:function(){};n.length?(p=n.length,d.each(n,function(w,x){u(x)})):v()}}};CRMEmailConversationEmailSender.prototype.initWYSIWYG=function(){var a=this,b=a.$textarea;d.crm.initWYSIWYG(b,{maxHeight:150,allowedAttr:[["section","data-role"]],callbacks:{change:function(){a.is_changed=!0}}});a.body&&b.redactor("code.set",a.body)};CRMEmailConversationEmailSender.prototype.initSave=
function(){var a=this,b=!1;a.$form.on("submit",function(e){e.preventDefault();if(!b){b=!0;e=a.$form.find(".js-submit-button");var f=d('<i class="icon16 loading" style="vertical-align: baseline; margin: 0 4px; position: relative; top: 3px;"></i>');e.removeClass("blue").attr("disabled",!0);f.insertBefore(e);a.filesController.uploadFiles([{name:"hash",value:a.hash}],c)}});var c=function(){var e=a.send_action_url,f=a.$form.serializeArray();d.post(e,f,function(g){"ok"===g.status?d.crm.content.reload():
alert("error")},"json").always(function(){b=!1})}};CRMEmailConversationEmailSender.prototype.initPersonalSettingsDialog=function(){function a(){c||(c=!0,d.post(d.crm.app_url+"?module=email&action=personalSettingsDialog",{},function(e){new CRMDialog({html:e,options:{onSave:function(f){b.$textarea.redactor("core.editor").find('[data-role="c-email-signature"]').html(f.email_signature||"");b.$wrapper.find(".js-sender-name").text(f.sender_name||"")}}})}).always(function(){c=!1}))}var b=this,c=!1;b.$wrapper.on("click",
".js-show-personal-settings-dialog",function(e){e.preventDefault();a()})};CRMEmailConversationEmailSender.prototype.initEmailCopy=function(){function a(){var p=d.trim(k.val()).split(/[,:;]/);if(p[0].length)return d.each(p,function(q,r){q=d.trim(r).split(/\s+/);var t=!1,u=r=null;d.each(q,function(v,w){d.crm.check.email(w)&&!t&&(r=w.replace(/<|>/g,""),t=v)});!1!==t&&q.splice(t,1);u=q.join(" ");r&&u&&c(0,r,u);r&&!u&&b(0,r,r);u&&!r&&(k.addClass("shake animated"),setTimeout(function(){k.removeClass("shake animated")},
500));t=!1;u=r=null}),!1}function b(p,q,r){l.children('[data-email="'+q+'"]').length&&"0"!==p||!q.length||(e.$wrapper.find(".email-copy-input-div").before('<div class="email-copy-user" title="'+d.crm.escape(q)+'" data-contact-id="'+d.crm.escape(p)+'" data-email="'+d.crm.escape(q)+'">'+r+' <a title="'+e.locales.remove_form_cc+'" class="remove-cc js-remove-cc">x</a> <input name="cc['+d.crm.escape(q)+'][email]" type="hidden" value="'+d.crm.escape(q)+'" /><input name="cc['+d.crm.escape(q)+'][id]" type="hidden" value="'+
d.crm.escape(p)+'" /></div>'),e.$wrapper.find(".email-copy-text-collapsed").append('<div class="email-copy-user" title="'+d.crm.escape(q)+'" data-email="'+d.crm.escape(q)+'">'+r+"</div>"));k.val("").focus()}function c(p,q,r){l.children('[data-email="'+q+'"]').length&&"0"!==p||!q.length||(e.$wrapper.find(".email-copy-input-div").before('<div class="email-copy-user" title="'+d.crm.escape(q)+'" data-contact-id="'+p+'" data-email="'+d.crm.escape(q)+'">'+d.crm.escape(r)+' <a title="'+e.locales.remove_form_cc+
'" class="remove-cc js-remove-cc">x</a> <input name="cc['+d.crm.escape(q)+'][email]" type="hidden" value="'+d.crm.escape(q)+'" /><input name="cc['+d.crm.escape(q)+'][id]" type="hidden" value="'+d.crm.escape(p)+'" /><input name="cc['+d.crm.escape(q)+'][name]" type="hidden" value="'+d.crm.escape(r)+'" /></div>'),e.$wrapper.find(".email-copy-text-collapsed").append('<div class="email-copy-user" title="'+d.crm.escape(q)+'" data-email="'+d.crm.escape(q)+'">'+d.crm.escape(r)+"</div>"));k.val("").focus()}
var e=this,f=e.$wrapper.find(".email-copy-wrapper"),g=e.$wrapper.find(".js-email-copy-link-icon"),h=f.find(".email-copy-area"),l=h.find(".email-copy-text"),k=h.find(".email-copy-input"),m=f.find(".deal-participants-area"),n=e.$wrapper.find(".email-copy-wrapper-collapsed");k.autocomplete({source:d.crm.app_url+"?module=autocomplete&emailcomplete=true",appendTo:e.$wrapper,minLength:0,focus:function(){return!1},select:function(p,q){b(q.item.id,q.item.email,'<i class="icon16 userpic20" style="background-image: url('+
q.item.photo_url+');"></i><b>'+q.item.name+"</b>");k.val("");return!1}}).data("ui-autocomplete")._renderItem=function(p,q){return d('<li class="ui-menu-item-html"><div>'+q.value+"</div></li>").appendTo(p)};k.on("focus",function(){k.data("uiAutocomplete").search(k.val())});e.$wrapper.on("click",".js-email-copy-link, .email-copy-text-collapsed",function(p){p.preventDefault();f.toggleClass("email-copy-wrapper-block");f.is(":visible")?(g.removeClass("rarr").addClass("darr"),k.focus(),n.removeClass("email-copy-wrapper-collapsed-block")):
(g.removeClass("darr").addClass("rarr"),e.$wrapper.find(".email-copy-text-collapsed").children().length&&n.addClass("email-copy-wrapper-collapsed-block"));e.$wrapper.closest(".js-reply-wrapper").trigger("resize")});h.on("click",function(){k.focus()});m.on("click",".email-copy-user",function(){var p=d(this).data("cc-contact-id"),q=d(this).data("cc-email"),r=d(this).html();b(p,q,r)});k.on("focusout",function(p){a()});k.on("keydown",function(p){13==p.keyCode&&(p.preventDefault(),a())});l.on("click",
".js-remove-cc",function(p){p.preventDefault();p=d(this).parent(".email-copy-user");var q=p.data("email");p.remove();e.$wrapper.find(".email-copy-text-collapsed").children('[data-email="'+q+'"]').remove()});k.on("keydown",function(p){if(8==p.keyCode&&0==k.val().length){p=e.$wrapper.find(".email-copy-text .email-copy-user:last");var q=p.data("email");p.remove();e.$wrapper.find(".email-copy-text-collapsed").children('[data-email="'+q+'"]').remove();k.focus()}})};return CRMEmailConversationEmailSender}(jQuery),
CRMImConversationSection=function(d){CRMImConversationSection=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$textarea=this.$form.find(".js-textarea");this.send_action_url=a.send_action_url;this.initClass()};CRMImConversationSection.prototype.initClass=function(){this.initSubmit()};CRMImConversationSection.prototype.initSubmit=function(){function a(){e.css("min-height",0);var f=e[0].scrollHeight;152<f&&(f=152);e.css("min-height",f+2+"px");b.$wrapper.trigger("resize")}
var b=this,c=!1,e=b.$textarea;e.on("keydown",function(f){13!==f.keyCode&&10!==f.keyCode||f.ctrlKey||f.metaKey||f.shiftKey||(f.preventDefault(),b.$form.submit())});e.on("keyup",function(f){var g=8===f.keyCode,h=46===f.keyCode;13!==f.keyCode&&10!==f.keyCode||!(f.ctrlKey||f.metaKey||f.shiftKey)?g||h?a():e[0].scrollHeight>e.outerHeight()&&a():(f.shiftKey||(g=e.val(),h=e.prop("selectionStart"),f=g.slice(0,h),g=g.slice(h),e.val(f+"\n"+g)),a())});b.$form.on("submit",function(f){f.preventDefault();if(!c){c=
!0;f=b.send_action_url;var g=b.$form.serializeArray();d.post(f,g,function(h){"ok"===h.status?d.crm.content.reload():(e.addClass("shake animated").focus(),setTimeout(function(){e.removeClass("shake animated").focus()},500),c=!1)}).always(function(){c=!1})}})};return CRMImConversationSection}(jQuery),CRMConversationAssociateDealDialog=function(d){CRMConversationAssociateDealDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$footer=this.$wrapper.find(".js-dialog-footer");
this.$submit=this.$form.find(".js-submit");this.$deal_name=this.$form.find(".js-deal-name");this.$deal_funnel=this.$form.find(".js-select-deal-funnel");this.$deal_stage=this.$form.find(".js-select-deal-stage");this.$deal_id=this.$form.find(".js-deal-id");this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMConversationAssociateDealDialog.prototype.initClass=function(){d.crm.renderSVG(this.$wrapper);this.initSelectDeal();this.initSubmit()};CRMConversationAssociateDealDialog.prototype.initSelectDeal=
function(){var a=this,b=a.$form.find(".js-select-deal .js-visible-link .js-text"),c=a.$form.find(".js-select-funnel"),e=a.$form.find(".js-deals-list"),f=a.$form.find(".js-deal-name-field");a.$form.on("click",".js-create-new-deal",function(){a.$submit.addClass("yellow").removeAttr("disabled");var g=d(this).find(".js-text").html();a.deal_selected=!0;c.removeClass("hidden");f.removeClass("hidden");a.$deal_name.focus();b.html(g);a.$deal_id.val("0")});a.$form.on("click",".js-deal-item",function(){a.$submit.addClass("yellow").removeAttr("disabled");
var g=d(this).find(".js-text").html();a.deal_selected=!0;e.find("li").removeClass("selected");d(this).parent().addClass("selected");b.html(g);c.addClass("hidden");f.addClass("hidden");a.$deal_name.val("");a.$deal_id.val(d(this).data("deal-id"))});e.on("click",function(){e.hide();setTimeout(function(){e.removeAttr("style")},200)});a.$form.on("change",".js-select-deal-funnel",function(){a.$form.find(".js-select-stage-wrapper").load("?module=deal&action=stagesByFunnel&id="+d(this).val())})};CRMConversationAssociateDealDialog.prototype.initSubmit=
function(){function a(){var c=d('<i class="icon16 loading" style="vertical-align: middle; margin-left: 6px;"></i>'),e=d.crm.app_url+"?module=message&action=conversationAssociateDealSave",f=b.$form.serializeArray();b.$submit.prop("disabled",!0);b.$footer.append(c);d.post(e,f,function(g){"ok"===g.status?d.crm.content.reload():(b.$submit.prop("disabled",!1),c.remove())})}var b=this;b.$form.on("submit",function(c){c.preventDefault();if(!b.$deal_id.val())return b.$wrapper.addClass("shake animated"),setTimeout(function(){b.$wrapper.removeClass("shake animated")},
500),!1;if(0==b.$deal_id.val()&&!d.trim(b.$deal_name.val()))return b.$deal_name.addClass("shake animated").focus(),setTimeout(function(){b.$deal_name.removeClass("shake animated").focus()},500),!1;a()})};return CRMConversationAssociateDealDialog}(jQuery);var CRMPageMessagesOperations=function(d){CRMPageMessagesOperations=function(a){this.$wrapper=a.$wrapper;this.$bar=this.$wrapper.find(".js-operations-wrapper");this.$list=this.$wrapper.find("#js-messages-table");this.$list_header=this.$list.find(".js-list-header");this.$checkbox_all=this.$wrapper.find(".js-checkbox-all");this.$content=this.$wrapper.find(".js-messages-page");this.page=a.page||1;this.limit=a.limit||30;this.total_count=a.total_count||0;this.total_items_at_page_count=this.getTotalItemsAtPage()||
0;this.view=a.view||"all";this.locales=a.locales||[];this.checked_count=0;this.read_list=[];this.unread_list=[];this.unread_counter=this.read_counter=0;this.deal_list=[];this.deal_counter=0;this.no_deal_list=[];this.no_deal_counter=0;this.is_shown=0<this.checked_count;this.is_checked_all=!1;this.initClass()};CRMPageMessagesOperations.prototype.initClass=function(){this.initCheckboxAll();this.initOperations();this.initItemCheckbox();this.initElasticHeader()};CRMPageMessagesOperations.prototype.initElasticHeader=
function(){function a(){d.contains(document,f[0])?c.scrollTop()>g.top?(f.addClass("is-fixed").css({left:g.left,width:h}),l=!0):(f.removeClass("is-fixed").removeAttr("style"),l=!1):c.off("scroll",a)}function b(){d.contains(document,f[0])?(h=e.outerWidth(),l&&f.width(h)):c.off("resize",b)}var c=d(window),e=this.$wrapper.find(".js-messages-section"),f=this.$bar,g=e.offset(),h=f.outerWidth(),l=!1;c.on("scroll",a).on("resize",b)};CRMPageMessagesOperations.prototype.initCheckboxAll=function(){var a=this;
a.$checkbox_all.click(function(){var b=d(this),c=b.is(":checked");0<a.checked_count?a.checked_count<a.total_items_at_page_count||a.checked_count===a.total_items_at_page_count?a.unselectAll():a.selectAll():(b.prop("checked",c),c?a.selectAll():a.unselectAll());a.formBar();a.showOrHideBar()})};CRMPageMessagesOperations.prototype.initOperations=function(){var a=this;a.$bar.on("click",".crm-operation-link",function(b){b.preventDefault();switch(d(this).data("id")){case "associate":a.associateWithDeal();
break;case "detach":a.detachFromDeals();break;case "read":a.markAsRead();break;case "unread":a.markAsUnread();break;case "delete":a.deleteConversation()}})};CRMPageMessagesOperations.prototype.updateBarCount=function(a,b){a.find(".crm-count").text("("+b+")")};CRMPageMessagesOperations.prototype.showOrHideBar=function(){0<this.checked_count?(this.is_shown||(this.$bar.addClass("is-shown"),this.$list_header.removeClass("is-shown"),this.is_shown=!0),this.formBar()):this.is_shown&&(this.$bar.removeClass("is-shown"),
this.$list_header.addClass("is-shown"),this.is_shown=!1)};CRMPageMessagesOperations.prototype.getSelectedIds=function(){return this.$list.find(".c-checkbox :checkbox:checked").map(function(){return parseInt(d(this).val())}).toArray()};CRMPageMessagesOperations.prototype.getTotalItemsAtPage=function(){return this.page*this.limit>this.total_count?this.total_count%this.limit:this.limit};CRMPageMessagesOperations.prototype.formBar=function(){var a=this.$bar.find('.crm-operation-li[data-id="associate"]'),
b=this.$bar.find('.crm-operation-li[data-id="detach"]'),c=this.$bar.find('.crm-operation-li[data-id="read"]'),e=this.$bar.find('.crm-operation-li[data-id="unread"]'),f=this.$bar.find('.crm-operation-li[data-id="delete"]');0<this.unread_counter?(c.show(),this.updateBarCount(c,this.unread_counter)):c.hide();0<this.read_counter?(e.show(),this.updateBarCount(e,this.read_counter)):e.hide();0<this.no_deal_counter?(a.show(),this.updateBarCount(a,this.no_deal_counter)):a.hide();0<this.deal_counter?(b.show(),
this.updateBarCount(b,this.deal_counter)):b.hide();0<this.checked_count?(f.show(),this.updateBarCount(f,this.checked_count)):f.hide()};CRMPageMessagesOperations.prototype.initItemCheckbox=function(){var a=this;a.$list.on("change",".js-checkbox",function(b,c){var e=d(this);b=e.closest(".js-message-wrapper");"undefined"!==typeof c&&e.attr("checked",c);a.markAsReadList(b);a.markAsUnreadList(b);a.associateWithDealList(b);a.detachFromDealsList(b);(c=b.find(".js-checkbox").is(":checked"))?b.addClass("is-active"):
b.removeClass("is-active");a.is_checked_all?(a.is_checked_all=!1,a.checked_count=a.$list.find(".c-checkbox :checkbox:checked").length):c?a.checked_count+=1:--a.checked_count;a.formBar();a.showOrHideBar();0<a.checked_count?a.checked_count<a.limit&&a.checked_count!==a.total_items_at_page_count?a.$checkbox_all.prop("indeterminate",!0):a.$checkbox_all.prop("indeterminate",!1).prop("checked",!0):a.$checkbox_all.prop("indeterminate",!1).prop("checked",!1)});a.$list.on("click",".c-checkbox",function(b){b=
d(b.target).is(":checkbox");b||b||(b=d(this).find(".js-checkbox"),b.trigger("change",[!b.is(":checked")]))});a.$list.shiftSelectable({selector:".js-message-wrapper",behavior_type:"vertical",onSelect:function(b,c){var e=d(c.target);e=!(!e.is("a")&&!e.closest("a").length);var f=c.extra.is_first;c=c.extra.is_last;e||f||c||(b=b.find(".js-checkbox"),b.attr("checked",!0),b.trigger("change"))}})};CRMPageMessagesOperations.prototype.selectAll=function(){this.$list.find(".c-checkbox :checkbox").prop("checked",
!0).trigger("change",[!0]);this.checked_count=this.getSelectedIds().length;this.is_checked_all=!0};CRMPageMessagesOperations.prototype.unselectAll=function(){this.$list.find(".c-checkbox :checkbox").prop("checked",!1).trigger("change",[!1]);this.$checkbox_all.prop("checked",!1);this.checked_count=0;this.is_checked_all=!1};CRMPageMessagesOperations.prototype.associateWithDeal=function(){var a=this.no_deal_list;1===a.length?this.$list.find('tr[data-id="'+a[0]+'"] .js-associate-deal').trigger("click"):
d.get("/webasyst/crm/?module=message&action=conversationAssociateDealDialog&conversation_id="+a[0],function(b){new CRMDialog({html:b})})};CRMPageMessagesOperations.prototype.associateWithDealList=function(a){var b=this,c=a.data("has-deal");a=a.data("id");c||-1!==b.no_deal_list.indexOf(a)||b.no_deal_list.push(a);b.no_deal_list=b.getSelectedIds().filter(function(e){return-1<b.no_deal_list.indexOf(e)});b.no_deal_counter=b.no_deal_list.length};CRMPageMessagesOperations.prototype.detachFromDeals=function(){var a=
this,b=a.$wrapper.find(".crm-dialog-wrapper.js-detach-conversation").clone(),c=a.view,e=a.deal_list,f={message_ids:e},g="detachDeals";"conversation"===c&&(f={conversation_ids:e},g="detachDealsFromConversations");var h=d.crm.app_url+"?module=messageOperation&action="+g,l=function(k,m){new CRMDialog({html:b.show(),onOpen:function(n){n=n.find(".crm-dialog-content");n.find(".js-confirm-text").html(k);n=n.find(".js-check-text").hide();m=d.trim(m);0<m.length&&(n.find(".js-text").text(m),n.show())},onConfirm:function(){d.post(h,
f).done(function(n){var p=Object.keys(f)[0];n=n.data[p];n.length&&(n.forEach(function(q){var r='<a href="javascript:void(0);" class="inline-link small js-associate-deal nowrap" data-dialog-url="'+d.crm.app_url+"?module=message&action=conversationAssociateDealDialog&conversation_id="+q+'"><i class="icon10 add" style="vertical-align: baseline; margin: 0 4px 0 0;"></i><b><i>'+a.locales.associate_with_deal+"</i></b></a>";"all"===c&&(r="");d('tr[data-id="'+q+'"]',a.$list).data("has-deal",0).attr("data-has-deal",
0).find(".c-column-deal").html(r);a.no_deal_list.push(q);a.deal_list=a.deal_list.splice(q,1)}),a.no_deal_counter=a.no_deal_list.length,a.deal_counter=a.deal_list.length,a.formBar())}).fail(function(n){console.error("Detach Deals From Conversations",n)})},onClose:function(n){n.find(".crm-dialog-content").empty()}})};(function(){if("conversation"===c){var k=d.extend({check:1},f,!0);return d.post(h,k)}return d.Deferred().resolve({})})().done(function(k){l("<h2>"+a.locales.detach_dialog_h2+"</h2>","ok"===
k.status&&k.data&&k.data.text||"")})};CRMPageMessagesOperations.prototype.detachFromDealsList=function(a){var b=this,c=a.data("has-deal");a=a.data("id");c&&-1===b.deal_list.indexOf(a)&&b.deal_list.push(a);b.deal_list=b.getSelectedIds().filter(function(e){return-1<b.deal_list.indexOf(e)});b.deal_counter=b.deal_list.length};CRMPageMessagesOperations.prototype.markAsRead=function(){var a=this,b=d.crm.app_url+"?module=messageOperation&action=markAsRead",c=a.unread_list,e={message_ids:c};"conversation"===
a.view&&(e={conversation_ids:c});d.post(b,e).done(function(f){var g=Object.keys(e)[0];f=f.data[g];f.length&&(f.map(function(h){a.$list.find('tr[data-id="'+h+'"]').removeClass("bold").data("read",1).attr("data-read",1);a.read_list.push(h);a.unread_list=a.unread_list.splice(h,1)}),a.read_counter=a.read_list.length,a.unread_counter=a.unread_list.length,a.formBar())}).fail(function(f){console.error("Mark as read",f)})};CRMPageMessagesOperations.prototype.markAsReadList=function(a){var b=this,c=a.data("id");
1===a.data("read")&&-1===b.read_list.indexOf(c)&&b.read_list.push(c);b.read_list=b.getSelectedIds().filter(function(e){return-1<b.read_list.indexOf(e)});b.read_counter=b.read_list.length};CRMPageMessagesOperations.prototype.markAsUnread=function(){var a=this,b=d.crm.app_url+"?module=messageOperation&action=markAsUnread",c=a.read_list,e={message_ids:c};"conversation"===a.view&&(e={conversation_ids:c});d.post(b,e).done(function(f){var g=Object.keys(e)[0];f=f.data[g];f.length&&(f.map(function(h){a.$list.find('tr[data-id="'+
h+'"]').addClass("bold").data("read",0).attr("data-read",0);a.unread_list.push(h);a.read_list=a.read_list.splice(h,1)}),a.unread_counter=a.unread_list.length,a.read_counter=a.read_list.length,a.formBar())}).fail(function(f){console.error("Mark as unread",f)})};CRMPageMessagesOperations.prototype.markAsUnreadList=function(a){var b=this,c=a.data("id");0===a.data("read")&&-1===b.unread_list.indexOf(c)&&b.unread_list.push(c);b.unread_list=b.getSelectedIds().filter(function(e){return-1<b.unread_list.indexOf(e)});
b.unread_counter=b.unread_list.length};CRMPageMessagesOperations.prototype.deleteConversation=function(){var a=this,b=a.$wrapper.find(".js-delete-conversation").clone(),c=a.view,e=a.getSelectedIds(),f={message_ids:e},g="delete";"conversation"===c&&(f={conversation_ids:e},g="deleteConversations");var h=d.crm.app_url+"?module=messageOperation&action="+g,l=function(k,m){new CRMDialog({html:b.show(),onOpen:function(n){n=n.find(".crm-dialog-content");n.find(".js-confirm-text").html(k);n=n.find(".js-check-text").hide();
m=d.trim(m);0<m.length&&(n.find(".js-text").text(m),n.show())},onConfirm:function(){d.post(h,f).done(function(n){var p=Object.keys(f)[0];n=n.data[p];n.length&&(n.map(function(q){d('tr[data-id="'+q+'"]',a.$list).hide()}),a.checked_count-=e.length,a.total_count-=e.length,a.unselectAll(),a.formBar(),1>a.total_count&&(a.$list.hide().before('<div class="no-messages">'+a.locales.no_messages+"</div>"),a.unselectAll(),a.hideBar()))}).fail(function(n){console.error("Delete messages",n)})},onClose:function(n){n.find(".crm-dialog-content").empty()}})};
(function(){if("conversation"===c){var k=d.extend({check:1},f,!0);return d.post(h,k)}return d.Deferred().resolve({})})().done(function(k){l("<h2>"+a.locales.delete_dialog_h2+"</h2>","ok"===k.status&&k.data&&k.data.text||"")})};return CRMPageMessagesOperations}(jQuery);var CRMSendEmailDialog=function(d){function a(b){(b=b.data("redactor"))&&"core"in b&&b.core.destroy()}CRMSendEmailDialog=function(b){this.$wrapper=b.$wrapper;this.$form=this.$wrapper.find("form");this.$textarea=this.$wrapper.find(".js-wysiwyg");this.$sender_email_select=this.$wrapper.find(".js-sender-email-select");this.$sender_email=this.$wrapper.find(".js-sender-email");this.$to_input=this.$wrapper.find(".js-to-input");this.$to_id=this.$wrapper.find(".js-to-id");this.dialog=this.$wrapper.data("dialog");
this.success_html=b.success_html;this.error_html=b.error_html;this.file_template_html=b.file_template_html;this.max_upload_size=b.max_upload_size;this.locales=b.locales;this.hash=b.hash;this.send_action_url=b.send_action_url;this.body=b.body||"";var c=!1;window&&window.parent&&window.parent.$&&window.parent.$.crm?c=window.parent.$.crm:window.$&&window.$.crm&&(c=window.$.crm);this.crm=c;this.action=b.action;this.deal_id=b.deal_id;this.is_admin=b.is_admin;this.app_url=b.crm_app_url||this.crm&&this.crm.app_url;
if(!this.send_action_url)throw Error("send_action_url option required");this.filesController=this.getFilesController();this.initClass()};CRMSendEmailDialog.prototype.initClass=function(){this.initWYSIWYG();this.initSendMessage();this.initPersonalSettingsDialog();this.senderEmailSelect();this.initEmailCopy();"new"==this.action&&(0==this.$to_id.val()&&this.initEmailTo(),this.initSelectDeal(),this.$to_input.focus());"forward"==this.action&&(this.initEmailTo(),this.$to_input.focus(),this.deal_id||this.initSelectDeal());
"reply"!=this.action||this.deal_id||this.initSelectDeal();this.dialog.resize()};CRMSendEmailDialog.prototype.getFilesController=function(){function b(t){t.length&&d.each(t,function(u,v){u=p;var w=u.push,x=d(m);x.find(".js-name").text(v.name);k.prepend(x);e.dialog.resize();w.call(u,{$file:x,file:v})})}function c(t){var u=[];d.each(p,function(v,w){t[0]!==w.$file[0]?u.push(w):t.remove()});p=u}var e=this,f=e.$wrapper.find(".js-files-wrapper");if(!f.length)return!1;var g=f.find(".js-drop-area"),h=f.find(".js-drop-text"),
l=f.find(".js-drop-field"),k=f.find(".c-upload-list"),m=e.file_template_html,n=e.app_url+"?module=file&action=uploadTmp",p=[],q=0,r=0;l.on("change",function(t){t.preventDefault();b(this.files)});g.on("drop",function(t){t.preventDefault();b(t.originalEvent.dataTransfer.files)});g.on("dragover",function(t){t.preventDefault();g.addClass("is-hover");h.text(h.data("hover"));clearTimeout(r);r=setTimeout(function(){g.removeClass("is-hover");h.text(h.data("default"))},100)});f.on("click",".js-file-delete",
function(t){t.preventDefault();c(d(this).closest(".c-upload-item"))});return{uploadFiles:function(t,u){function v(x){function y(){var D=new FormData,C=document.cookie.match(/(?:^|; )_csrf=([^;]*)/);(C=C?decodeURIComponent(C[1]):"")&&D.append("_csrf",C);t&&t.length&&d.each(t,function(F,E){E.name&&E.value&&D.append(E.name,E.value)});D.append("file_size",x.file.size);D.append("files",x.file);D.append("file_end",1);d.ajax({xhr:function(){var F=new window.XMLHttpRequest;F.upload.addEventListener("progress",
function(E){if(E.lengthComputable){E=parseInt(E.loaded/E.total*100);var G=[247,198,174];for(var I=[174,247,196],H=[],J=0;J<G.length;J++)H.push(G[J]+(I[J]-G[J])/100*E);G="rgb("+H.join(",")+")";A.css("background-color",G).width(E+"%");B.text(E+"%")}},!1);return F},url:n,data:D,cache:!1,contentType:!1,processData:!1,type:"POST",success:function(F){B.text(B.data("success"));setTimeout(function(){d.contains(document,z[0])&&(z.remove(),--q,0>=q&&w())},2E3)}}).always(function(){})}var z=x.$file,A=z.find(".js-bar"),
B=z.find(".js-status");z.addClass("is-upload");e.max_upload_size>x.file.size?y():(B.addClass("errormsg").text(e.locales.file_size),z.find(".c-progress-wrapper").remove(),setTimeout(function(){d.contains(document,z[0])&&(z.remove(),--q,0>=q&&w())},2E3))}var w=u?u:function(){};p.length?(q=p.length,d.each(p,function(x,y){v(y)})):w()}}};CRMSendEmailDialog.prototype.initWYSIWYG=function(){var b=this,c=b.$textarea,e=0;b.crm.initWYSIWYG(c,{allowedAttr:[["section","data-role"]],callbacks:{change:function(){var g=
b.dialog.$block.height();e&&e===g||(e=g,b.dialog.resize())}}});b.body&&c.redactor("code.set",b.body);var f=b.dialog.onClose;b.dialog.onClose=function(){f(arguments);a(c)}};CRMSendEmailDialog.prototype.initSendMessage=function(){var b=this,c=!1,e=b.$wrapper.find(".js-to-email"),f=b.$to_id,g=b.$wrapper.find(".js-to-new-name");b.$form.on("submit",function(l){l.preventDefault();if(!(0!=f.val()||d.trim(g.val())&&d.trim(e.val())||"new"!=b.action&&"forward"!=b.action))return d(".js-to-input, .js-to-add-name, .js-to-add-email").addClass("shake animated").focus(),
setTimeout(function(){d(".js-to-input, .js-to-add-name, .js-to-add-email").removeClass("shake animated").focus()},500),!1;if(!d.trim(e.val()))return b.$to_input.addClass("shake animated").focus(),setTimeout(function(){b.$to_input.removeClass("shake animated").focus()},500),!1;if(!c){c=!0;l=b.$form.find(".js-submit-button");var k=d('<i class="icon16 loading" style="vertical-align: baseline; margin: 0 4px; position: relative; top: 3px;"></i>');l.removeClass("blue").attr("disabled",!0);k.insertAfter(l);
b.filesController.uploadFiles([{name:"hash",value:b.hash}],h)}});var h=function(){var l=b.send_action_url,k=b.$form.serializeArray(),m=function(n,p){if(!d.isEmptyObject(n)){n=d.extend(!0,{},n);var q=b.locales.send_error_title||"Send error",r=b.locales.send_error_text||"Can't send email message";r=d(b.error_html).find(".js-error-text").text(r).end();var t=n.common;b.is_admin&&(t?(r.find(".js-technical-info-block.js-known-error").show(),r.find(".js-technical-info-text").text(t)):r.find(".js-technical-info-block.js-unknown-error").show());
d.crm.alert.show({title:q,text:r.get(0).outerHTML,button:b.locales.close||"close",button_class:"red",onOpen:function(u){u.find(".js-technical-info-link").one("click",function(){d(this).remove();u.find(".js-technical-info-text").show()})}});delete n.common;d.isEmptyObject(n)||console.log.error(n)}p&&console.log.error(p)};d.post(l,k,"json").done(function(n){if("ok"===n.status){a(b.$textarea);b.$wrapper.find(".crm-dialog-block").html(b.success_html);b.dialog.resize();var p=null,q=b.dialog.onClose;b.dialog.onClose=
function(){q();p&&clearTimeout(p);p=null;b.crm.content.reload()};p=setTimeout(function(){b.dialog.close()},2500)}else b.dialog.close(),d.isEmptyObject(n.errors)?m({common:"Send error"},n):m(n.errors)}).always(function(){c=!1}).fail(function(n){m({},n);b.dialog.close()})}};CRMSendEmailDialog.prototype.initPersonalSettingsDialog=function(){function b(){e||(e=!0,d.post(c.crm.app_url+"?module=email&action=personalSettingsDialog",{},function(f){new CRMDialog({html:f,options:{onSave:function(g){c.$textarea.redactor("core.editor").find('[data-role="c-email-signature"]').html(g.email_signature||
"");c.$wrapper.find(".js-sender-name").text(g.sender_name||"")}}})}).always(function(){e=!1}))}var c=this,e=!1;c.$wrapper.on("click",".js-show-personal-settings-dialog",function(f){f.preventDefault();b()})};CRMSendEmailDialog.prototype.senderEmailSelect=function(){var b=this;b.$wrapper.on("change",b.$sender_email_select,function(c){c.preventDefault();b.$sender_email.val(b.$sender_email_select.val())})};CRMSendEmailDialog.prototype.initEmailTo=function(){function b(){var v=d.trim(h.val()).split(/\s+/),
w=!1;d.each(v,function(x,y){d.crm.check.email(y)&&!w&&(g=y.replace(/<|>/g,""),w=x)});!1!==w&&v.splice(w,1);f=v.join(" ");g&&f&&(v='<span class="js-edit-recipient" title="'+e.locales.edit_recipient+'"><b>'+d.crm.escape(f)+'</b> <span style="color: #999;">&lt;'+d.crm.escape(g)+"&gt;</span></span>",c(0,g,v),k.val(d.crm.escape(f)));if(f&&!g)return v='<span class="js-edit-recipient" title="'+e.locales.edit_recipient+'"><b>'+d.crm.escape(f)+'</b></span> <input class="c-to-input js-to-add-email" type="text" autocomplete="off" placeholder="'+
e.locales.type_email+'" style="margin-left: 8px; width: 150px;" />',c(0,null,v),k.val(d.crm.escape(f)),d(".js-to-add-email").focus(),!1;if(g&&!f)return v='<input class="c-to-input js-to-add-name" type="text" autocomplete="off" placeholder="'+e.locales.type_name+'" style="margin-right: 8px; width: 150px;" > <span class="js-edit-recipient" title="'+e.locales.edit_recipient+'" style="color: #999;">&lt;'+d.crm.escape(g)+"&gt;</span>",c(0,g,v),d(".js-to-add-name").focus(),!1}function c(v,w,x){n.prepend('<div class="c-email-to-user js-email-to-user">'+
x+' <a title="'+e.locales.change_recipient+'" class="c-remove-to-email js-remove-to-email">x</a></div>');p.removeClass("hidden");h.addClass("hidden").val("");l.val(w);m.val(v).trigger("change")}var e=this,f=null,g=null,h=e.$to_input,l=e.$wrapper.find(".js-to-email"),k=e.$wrapper.find(".js-to-new-name"),m=e.$to_id,n=e.$wrapper.find(".js-to-name"),p=e.$wrapper.find(".js-deal-field"),q=e.$wrapper.find(".js-select-funnel"),r=e.$wrapper.find(".js-select-deal .js-visible-link .js-text"),t=e.$wrapper.find(".js-deals-list"),
u=e.$wrapper.find(".js-create-new-deal");h.autocomplete({source:d.crm.app_url+"?module=autocomplete&emailcomplete=true",appendTo:e.$wrapper,minLength:0,focus:function(){return!1},select:function(v,w){v=w.item;w=(v.criteria||{}).email||v.email;c(v.id,w,'<i class="icon16 userpic20" style="background-image: url('+v.photo_url+');"></i> <b>'+v.name+'</b> <span style="color: #999;">&lt;'+w+"&gt;</span>");return!1}}).data("ui-autocomplete")._renderItem=function(v,w){return d('<li class="ui-menu-item-html"><div>'+
w.value+"</div></li>").appendTo(v)};h.on("focus",function(){h.data("uiAutocomplete").search(h.val())});h.on("keydown",function(v){if(13==v.keyCode)return v.preventDefault(),h.blur(),!1});h.on("focusout",function(v){v.preventDefault();b();return!1});n.on("click",".js-remove-to-email",function(){d(this).parent(".js-email-to-user").remove();h.removeClass("hidden").focus();p.addClass("hidden");q.addClass("hidden");t.html(u);r.html("<b><i>"+e.locales.deal_select+"</i></b>");l.val("");k.val("");m.val("").trigger("change");
g=f=null});e.$wrapper.on("click",".js-edit-recipient",function(){var v=[f,g].join(" ");h.val(d.trim(v)).removeClass("hidden").focus();d(".js-email-to-user").remove();g=f=null;l.val("");k.val("")});e.$wrapper.on("keydown",".js-to-add-email",function(v){13==v.keyCode&&(v.preventDefault(),d(this).blur())});e.$wrapper.on("focusout",".js-to-add-email",function(){var v=d(".js-to-add-email"),w=d.trim(v.val());w.length&&!0===d.crm.check.email(w)&&(g=w,l.val(d.crm.escape(w)),v.before(d('<span class="js-edit-recipient" title="'+
e.locales.edit_recipient+'" style="color: #999;"></span>').text("<"+w+">")).remove())});e.$wrapper.on("keydown",".js-to-add-name",function(v){13==v.keyCode&&(v.preventDefault(),d(this).blur())});e.$wrapper.on("focusout",".js-to-add-name",function(){var v=d.trim(d(".js-to-add-name").val());v.length&&(f=v,k.val(d.crm.escape(v)),d(".js-to-add-name:first-child").before(d('<span class="js-edit-recipient" title="'+e.locales.edit_recipient+'"><b></b></span>').text(v)).remove())})};CRMSendEmailDialog.prototype.initEmailCopy=
function(){function b(){var q=d.trim(m.val()).split(/[,:;]/);if(q[0].length)return d.each(q,function(r,t){r=d.trim(t).split(/\s+/);var u=!1,v=t=null;d.each(r,function(w,x){d.crm.check.email(x)&&!u&&(t=x.replace(/<|>/g,""),u=w)});!1!==u&&r.splice(u,1);v=r.join(" ");t&&v&&e(0,t,v);t&&!v&&c(0,t,t);v&&!t&&(m.addClass("shake animated"),setTimeout(function(){m.removeClass("shake animated")},500));u=!1;v=t=null}),!1}function c(q,r,t){k.children('[data-email="'+r+'"]').length&&"0"!==q||!r.length||(d(".email-copy-input-div").before('<div class="email-copy-user" title="'+
d.crm.escape(r)+'" data-contact-id="'+d.crm.escape(q)+'" data-email="'+d.crm.escape(r)+'">'+t+' <a title="'+f.locales.remove_form_cc+'" class="remove-cc js-remove-cc">x</a> <input name="cc['+d.crm.escape(r)+'][email]" type="hidden" value="'+d.crm.escape(r)+'" /><input name="cc['+d.crm.escape(r)+'][id]" type="hidden" value="'+d.crm.escape(q)+'" /></div>'),d(".email-copy-text-collapsed").append('<div class="email-copy-user" title="'+d.crm.escape(r)+'" data-email="'+d.crm.escape(r)+'">'+t+"</div>"));
m.val("").focus()}function e(q,r,t){k.children('[data-email="'+r+'"]').length&&"0"!==q||!r.length||(d(".email-copy-input-div").before('<div class="email-copy-user" title="'+d.crm.escape(r)+'" data-contact-id="'+q+'" data-email="'+d.crm.escape(r)+'">'+d.crm.escape(t)+' <a title="'+f.locales.remove_form_cc+'" class="remove-cc js-remove-cc">x</a> <input name="cc['+d.crm.escape(r)+'][email]" type="hidden" value="'+d.crm.escape(r)+'" /><input name="cc['+d.crm.escape(r)+'][id]" type="hidden" value="'+d.crm.escape(q)+
'" /><input name="cc['+d.crm.escape(r)+'][name]" type="hidden" value="'+d.crm.escape(t)+'" /></div>'),d(".email-copy-text-collapsed").append('<div class="email-copy-user" title="'+d.crm.escape(r)+'" data-email="'+d.crm.escape(r)+'">'+d.crm.escape(t)+"</div>"));m.val("").focus()}var f=this,g=f.$wrapper.find(".email-copy-wrapper"),h=f.$wrapper.find(".js-email-copy-link-icon"),l=g.find(".email-copy-area"),k=l.find(".email-copy-text"),m=l.find(".email-copy-input"),n=g.find(".deal-participants-area"),
p=f.$wrapper.find(".email-copy-wrapper-collapsed");m.autocomplete({source:d.crm.app_url+"?module=autocomplete&emailcomplete=true",appendTo:f.$wrapper,minLength:0,focus:function(){return!1},select:function(q,r){q=r.item;c(q.id,(q.criteria||{}).email||q.email,'<i class="icon16 userpic20" style="background-image: url('+q.photo_url+');"></i><b>'+q.name+"</b>");m.val("");return!1}}).data("ui-autocomplete")._renderItem=function(q,r){return d('<li class="ui-menu-item-html"><div>'+r.value+"</div></li>").appendTo(q)};
m.on("focus",function(){m.data("uiAutocomplete").search(m.val())});f.$wrapper.on("click",".js-email-copy-link, .email-copy-text-collapsed",function(q){q.preventDefault();g.toggleClass("email-copy-wrapper-block");g.is(":visible")?(h.removeClass("rarr").addClass("darr"),m.focus(),p.removeClass("email-copy-wrapper-collapsed-block")):(h.removeClass("darr").addClass("rarr"),d(".email-copy-text-collapsed").children().length&&p.addClass("email-copy-wrapper-collapsed-block"))});l.on("click",function(){m.focus()});
n.on("click",".email-copy-user",function(){var q=d(this).data("cc-contact-id"),r=d(this).data("cc-email"),t=d(this).html();c(q,r,t)});m.on("focusout",function(q){b()});m.on("keydown",function(q){13==q.keyCode&&(q.preventDefault(),b())});k.on("click",".js-remove-cc",function(q){q.preventDefault();q=d(this).parent(".email-copy-user");var r=q.data("email");q.remove();d(".email-copy-text-collapsed").children('[data-email="'+r+'"]').remove()});m.on("keydown",function(q){if(8==q.keyCode&&0==m.val().length){q=
d(".email-copy-text .email-copy-user:last");var r=q.data("email");q.remove();d(".email-copy-text-collapsed").children('[data-email="'+r+'"]').remove();m.focus()}})};CRMSendEmailDialog.prototype.initSelectDeal=function(){function b(){var n=k.val();l.val("none");n&&d.get("?module=deal&action=byContact&id="+n,function(p){"ok"===p.status&&(d.each(p.data.deals,function(q,r){h.prepend('<li><a href="javascript:void(0);" class="js-deal-item" data-deal-id="'+r.id+'"><span class="js-text"><i class="icon16 funnel-state svg-icon" data-color="'+
p.data.funnels[r.funnel_id].stages[r.stage_id].color+'"></i><b><i>'+r.name+"</i></b></span></a></li>")}),d.crm.renderSVG(c.$wrapper))},"json")}var c=this,e=c.$form.find(".js-select-deal .js-visible-link .js-text"),f=c.$form.find(".js-select-funnel"),g=c.$wrapper.find(".js-deal-field"),h=c.$form.find(".js-deals-list"),l=c.$form.find(".js-deal-id"),k=c.$to_id,m=c.$form.find(".js-empty-deal");c.$form.on("click",".js-create-new-deal",function(){var n=d(this).find(".js-text").html();f.removeClass("hidden");
m.removeClass("c-empty-deal-hidden");e.html(n);l.val("0")});m.on("click",function(){d(this).addClass("c-empty-deal-hidden");f.addClass("hidden");h.find("li").removeClass("selected");e.html("<b><i>"+c.locales.deal_empty+"</i></b>");l.val("none")});c.$form.on("click",".js-deal-item",function(){var n=d(this).find(".js-text").html();h.find("li").removeClass("selected");d(this).parent().addClass("selected");e.html(n);m.removeClass("c-empty-deal-hidden");f.addClass("hidden");l.val(d(this).data("deal-id"))});
"reply"==c.action&&b();"new"==c.action&&0<k.val()&&(b(),g.removeClass("hidden"));k.on("change",b);h.on("click",function(){h.hide();setTimeout(function(){h.removeAttr("style")},200)});c.$form.on("change",".js-select-deal-funnel",function(){c.$form.find(".js-select-stage-wrapper").load("?module=deal&action=stagesByFunnel&id="+d(this).val())})};return CRMSendEmailDialog}(jQuery);var CRMSendSmsDialog=function(d){CRMSendSmsDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$textarea=this.$wrapper.find(".js-send-sms-textarea");this.dialog=this.$wrapper.data("dialog");this.success_html=a.success_html;this.error_html=a.error_html;this.hash=a.hash;this.send_action_url=a.send_action_url;var b=!1;window&&window.parent&&window.parent.$&&window.parent.$.crm?b=window.parent.$.crm:window.$&&window.$.crm&&(b=window.$.crm);this.crm=b;this.action=a.action;
this.locales=a.locales||{};this.app_url=a.crm_app_url||this.crm&&this.crm.app_url;if(!this.send_action_url)throw Error("send_action_url option required");this.initClass()};CRMSendSmsDialog.prototype.initClass=function(){this.initSenderSelector();this.initSendMessage();this.dialog.resize()};CRMSendSmsDialog.prototype.initSenderSelector=function(){var a=this.$wrapper,b=a.find(".js-specified-sms-sender");a.find(".js-sms-sender-list").change(function(){"specified"===d(this).val()?b.attr("disabled",!1).show():
b.attr("disabled",!0).hide()})};CRMSendSmsDialog.prototype.initSendMessage=function(){var a=this,b=!1;a.$form.on("submit",function(c){c.preventDefault();if(!b){b=!0;c=a.$form.find(".js-submit-button");var e=d('<i class="icon16 loading" style="vertical-align: baseline; margin: 0 4px; position: relative; top: 3px;"></i>');c.removeClass("blue").attr("disabled",!0);e.insertAfter(c);c=a.send_action_url;e=a.$form.serializeArray();var f=function(g){var h=a.locales.send_error_title||"Send error",l=a.locales.send_error_text||
"Can't send sms message";l=d(a.error_html).find(".js-error-text").text(l).end();d.crm.alert.show({title:h,text:l.get(0).outerHTML,button_class:"red"});g&&console.error(g)};d.post(c,e,function(g){if("ok"===g.status){a.$wrapper.find(".crm-dialog-block").html(a.success_html);a.dialog.resize();var h=null,l=a.dialog.onClose;a.dialog.onClose=function(){l();h&&clearTimeout(h);h=null;a.crm.content.reload()};h=setTimeout(function(){a.dialog.close()},2500)}else a.dialog.close(),f(g.errors||{})},"json").always(function(){b=
!1}).error(function(g){a.dialog.close();f(g)})}})};return CRMSendSmsDialog}(jQuery);var CRMImSourceMessageDialog=function(d){CRMImSourceMessageDialog=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".js-reply-button");this.dialog=this.$wrapper.data("dialog");this.send_dialog=null;this.message=a.message||{};this.locales=a.locales||{};var b=!1;window&&window.parent&&window.parent.$&&window.parent.$.crm?b=window.parent.$.crm:window.$&&window.$.crm&&(b=window.$.crm);this.crm=b;this.app_url=a.crm_app_url||this.crm&&this.crm.app_url;this.initClass()};CRMImSourceMessageDialog.prototype.initClass=
function(){this.initMessageDeleteLink();this.initMessageReplyBtn()};CRMImSourceMessageDialog.prototype.initMessageReplyBtn=function(){function a(l){f.append(g);d.post(b.app_url+"?module=message&action=writeReplyDialog",{id:b.message.id},function(k){new CRMDialog({html:k,onOpen:function(m,n){b.send_dialog=n;m.find(".js-cancel-dialog").click(function(){b.send_dialog.hide();e.show()});l&&l()},onClose:function(){b.send_dialog=null;b.dialog&&b.dialog.close();b.dialog=null}})})}var b=this,c=b.$wrapper,
e=b.dialog,f=c.find(".js-dialog-footer"),g=d('<i class="icon16 loading" style="vertical-align: middle; margin-left: 6px;"></i>'),h=c.find(".js-reply-button");h.click(function(){h.attr("disabled",!0);var l=function(){g.remove();h.attr("disabled",!1);e.hide()};b.send_dialog?(b.send_dialog.show(),l()):a(function(){l();var k=b.dialog.onClose;b.dialog.onClose=function(){k.apply(this,arguments);b.dialog=null;b.send_dialog&&b.send_dialog.close();b.send_dialog=null}})})};CRMMessageDeleteLinkMixin.mixInFor(CRMImSourceMessageDialog);
return CRMImSourceMessageDialog}(jQuery);var CRMImSourceSendMessageDialog=function(d){CRMImSourceSendMessageDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$button=this.$form.find(":submit");this.dialog=this.$wrapper.data("dialog");this.message=a.message||{};this.locales=a.locales||{};this.success_html=a.success_html||"";var b=!1;window&&window.parent&&window.parent.$&&window.parent.$.crm?b=window.parent.$.crm:window.$&&window.$.crm&&(b=window.$.crm);this.crm=b;this.app_url=a.crm_app_url||this.crm&&
this.crm.app_url;this.send_action_url=a.send_action_url;if(!this.send_action_url)throw Error("send_action_url option required");this.initClass()};CRMImSourceSendMessageDialog.prototype.initClass=function(){this.initSendMessage();this.initErrorCleaner()};CRMImSourceSendMessageDialog.prototype.initErrorCleaner=function(){function a(){b.clearErrors()}var b=this,c=b.$wrapper,e=null;c.on("keydown",":input",function(){e&&clearTimeout(e);e=setTimeout(function(){a()},250)});c.on("change",":input",a)};CRMImSourceSendMessageDialog.prototype.initSendMessage=
function(){var a=this,b=a.$form,c=a.$button;b.on("submit",function(e){function f(l){l&&!d.isEmptyObject(l.errors)?a.showErrors(l.errors):console.error(l?["Server error",l]:"Server error")}e.preventDefault();var g=null,h=d('<i class="icon16 loading" style="vertical-align: baseline; margin: 0 4px; position: relative; top: 3px;"></i>');c.attr("disabled",!0).after(h);g&&g.abort();g=d.post(a.send_action_url,a.$form.serializeArray()).done(function(l){if("ok"!==l.status)f(l);else{a.$wrapper.find(".crm-dialog-block").html(a.success_html);
a.dialog.resize();var k=null,m=a.dialog.onClose;a.dialog.onClose=function(){m();k&&clearTimeout(k);k=null;a.crm.content.reload()};k=setTimeout(function(){a.dialog.close()},2500)}}).fail(f).always(function(){c.attr("disabled",!1);h.remove();g=null})});b.on("click",".js-cancel-dialog",function(){a.$wrapper.css({display:"none"})})};CRMImSourceSendMessageDialog.prototype.showErrors=function(a){var b=this.$wrapper;d.each(a,function(c,e){c=b.find('[name="'+c+'"]');e='<em class="errormsg">'+e+"</em>";c.length?
(c.addClass("error"),c.after(e)):b.find(".js-errors-place").append(e)})};CRMImSourceSendMessageDialog.prototype.clearErrors=function(){var a=this.$wrapper;a.find(".error").removeClass("error");a.find(".errormsg").remove();a.find(".js-errors-place").empty()};return CRMImSourceSendMessageDialog}(jQuery);var CRMContactPage=function(d){CRMContactPage=function(a){this.$wrapper=a.$wrapper;this.$tabsW=this.$wrapper.find(".t-profile-tabs");this.photo_dialog_url=a.photo_dialog_url;this.locales=a.locales;this.contact_id=a.contact_id||!1;this.editable=a.editable||!1;this.initClass()};CRMContactPage.prototype.initClass=function(){this.initTabChange();this.initAddCompanyContactLink();this.initResponsibleLink();this.initClassifyAccessLink();this.initChangePhotoLink();this.initTopInfoFields();this.initEmployee();
this.initAssignTags();this.initSegments();this.initInfoTab();this.editable&&(this.initEditLink(),this.initDeleteLink(),this.initEditableName());this.initRemoveFiles();this.initFixedHeader();this.editInterception();this.deleteInterception();this.initMessage();this.initCall()};CRMContactPage.prototype.editInterception=function(){var a=this,b=location.pathname.replace(d.crm.app_url,"").split("/");d(window).load(function(){0<=b.indexOf("edit")&&a.$wrapper.find(".profile-header-links .js-edit-link").trigger("click")})};
CRMContactPage.prototype.deleteInterception=function(){var a=this,b=location.pathname.replace(d.crm.app_url,"").split("/");d(window).load(function(){0<=b.indexOf("delete")&&a.$wrapper.find(".profile-header-links .js-delete-link").trigger("click")})};CRMContactPage.prototype.initTopInfoFields=function(){var a=this.$wrapper.find(".js-info-list");this.$wrapper.on("click",".js-info-toggle",function(b){b.preventDefault();d(this).toggleClass("is-active");a.slideToggle()})};CRMContactPage.prototype.initChangePhotoLink=
function(){var a=this;a.$wrapper.find(".photo-change-link a").click(function(){d.get(a.photo_dialog_url,function(b){(new CRMDialog({html:b})).$wrapper.on("photo_updated photo_deleted",function(c,e){a.$wrapper.find(".c-userpic").attr("src",e.url)})},"html")})};CRMContactPage.prototype.initTabChange=function(){var a=window.history&&window.history.pushState;this.$wrapper.find(".t-profile-tabs").on("click",".t-tab a",function(b){b.preventDefault();if(a){b=d(this).data("tab-id");var c=window.location.href.match(/^.*\/(id|contact)\/[^\/]+/);
c&&b&&(b=c[0]+"/"+b+"/",history.replaceState({reload:!0,content_uri:b},"",b))}})};CRMContactPage.prototype.initEditLink=function(){var a=this;a.$wrapper.find(".profile-header-links .edit-link").on("click",function(){var c=a.$wrapper.find('.t-tab a[data-tab-id="info"]').closest(".t-tab");d("html, body").animate({scrollTop:c.offset().top},500);a.$wrapper.find(".t-profile-tabs").data("tabs_controller").switchToTab("info",function(e){return"function"===typeof e[0].contentWindow.$.wa.contactEditor.switchMode}).then(function(e){e[0].contentWindow.$.wa.contactEditor.switchMode("edit")})});
var b=a.$wrapper.find(".t-profile-tabs-iframes");b.on("contact_saved",function(c,e){d.crm.content.reload();b.children().hide();a.$wrapper.find(".t-profile-tabs").data("tabs_controller").showTabHtml("__internal",'<div class="block double-padded"><i class="icon16 loading"></i></div>')})};CRMContactPage.prototype.initInfoTab=function(){var a=null;this.$wrapper.find('.t-profile-tabs .t-tab[data-tab-id="info"] a').on("tab_content_updated",function(){a&&clearInterval(a);a=setInterval(function(){var b=d("#c-profile-page .t-profile-tabs-iframes iframe").filter(function(){return"info"==
d(this).data("tab-id")});try{if(!b[0].contentWindow.$.wa.contactEditor)return}catch(g){return}a&&clearInterval(a);a=null;var c=d('script[src*="wa-apps/crm"]:first').attr("src").match(/^(.*\/wa-apps\/crm\/)[^\?]*(\?.*)/),e=c[1],f=c[2];b[0].contentWindow.$("head").append('<link href="'+e+"js/jquery/jquery-ui.css"+f+'" rel="stylesheet" type="text/css">');["js/jquery/jquery-ui.min.js","js/crm.autocomplete.js","js/contact.info.js"].forEach(function(g){b[0].contentWindow.$("head").append('<script src="'+
e+g+f+'">\x3c/script>')})},100)})};CRMContactPage.prototype.initAddCompanyContactLink=function(){this.$wrapper.find(".js-add-company-contact").on("click",function(){d.get(d(this).data("dialog-url"),function(a){new CRMDialog({html:a})})})};CRMContactPage.prototype.initResponsibleLink=function(){this.$wrapper.find(".profile-header-links .responsible-link").on("click",function(){d.get(d(this).data("dialog-url"),function(a){new CRMDialog({remain_after_load:!0,html:a})})})};CRMContactPage.prototype.initDeleteLink=
function(){var a=this.$wrapper,b=a.find(".crm-delete-link"),c=this.contact_id,e=d.crm.app_url+"?module=contactOperation&action=delete",f=a.find(".crm-contact-operation-delete-checking").clone();b.click(function(g){g.preventDefault();new CRMDialog({html:f.show(),onOpen:function(h){var l=this;h.find(".crm-cancel").click(function(){l.close()});d.get(e,{contact_ids:[c],is_contact_page:1},function(k){new CRMDialog({html:k,onOpen:function(){l.close()}})})}})})};CRMContactPage.prototype.initClassifyAccessLink=
function(){this.$wrapper.find(".profile-header-links .classify-access-link").on("click",function(){d.get(d(this).data("dialog-url"),function(a){new CRMDialog({remain_after_load:!0,html:a})})})};CRMContactPage.prototype.initEmployee=function(){var a=this,b=!1;a.$wrapper.on("click",".js-view-employees",function(c){c.preventDefault();a.$tabsW.length&&d("html, body").scrollTop(a.$tabsW.offset().top)});a.$wrapper.on("click",".js-add-employee",function(c){c.preventDefault();c=d.crm.app_url+"?module=contact&action=addEmployee";
var e={company_contact_id:a.contact_id};b&&b.abort();b=d.post(c,e,function(f){new CRMDialog({html:f})})})};CRMContactPage.prototype.initAssignTags=function(){var a=this.$wrapper.find(".crm-contact-assign-tags"),b=d.crm.app_url+"?module=contactOperation&action=assignTags&is_assign=1",c=parseInt(this.contact_id)||0;a.click(function(e){e.preventDefault();d.get(b,{contact_ids:[c]},function(f){new CRMDialog({html:f})})})};CRMContactPage.prototype.initSegments=function(){function a(h){var l=b.$wrapper.find(".js-segment-list"),
k=l.find("a").length;h.length||h.push({id:!1,name:b.locales.no_segments});d.each(h,function(m,n){m="javascript:void(0);";var p="",q='<span class="hint">'+n.name+"</span>";n.id&&(m=d.crm.app_url+"contact/segment/"+n.id+"/",p='<i class="icon16 '+(n.icon?n.icon:"folder-dynamic")+'"></i>',q="<span>"+n.name+"</span>");n='<a href="'+m+'">'+p+q+"</a>";k&&(n=","+n);l.append(n);k=!0})}var b=this,c=b.$wrapper.find(".crm-contact-assign-segments"),e=d.crm.app_url+"?module=contactOperation&action=addToSegments&is_assign=1",
f=parseInt(b.contact_id)||0;c.click(function(h){h.preventDefault();d.get(e,{contact_ids:[f]},function(l){new CRMDialog({html:l,onOpen:function(k){new CRMContactsOperationAddToSegments({$wrapper:k,context:{contact_ids:[f]},is_assign:1})}})})});var g=!1;b.$wrapper.on("click",".js-show-dynamic-segments",function(h){h.preventDefault();var l=d(this);l.find(".icon16").removeClass("folder-dynamic").addClass("loading");g&&g.abort();g=d.post("?module=contact&action=segmentSearch",{id:b.contact_id},function(k){"ok"==
k.status&&(a(k.data.segments),l.remove())}).always(function(){g=!1})})};CRMContactPage.prototype.initEditableName=function(){var a=this.$wrapper.find(".js-name-editable").first();if(!(0>=a.length)){var b=this.contact_id;new CrmEditable({$wrapper:a,saveChanged:!0,saveNonempty:!0,placeholder:a.data("editable-placeholder"),onSave:function(c){if(!c.isLoading())if(c.isChanged()&&d.trim(c.getText())){c.loading();var e=c.getText();d.post(d.crm.app_url+"?module=contact&action=profileSave",{data:JSON.stringify({name:e}),
id:b}).always(function(){c.setText(e);c.loading(!1).hide();d.crm.content.reload()})}else c.hide()}})}};CRMContactPage.prototype.initRemoveFiles=function(){function a(c,e){d.post("?module=file&action=delete",{id:c},function(f){"ok"==f.status?e.remove():console&&console.log&&console.log("File Remove Error")})}var b=this;b.$wrapper.find(".js-files-list").on("click",".js-remove-file",function(c){c.preventDefault();var e=d(this).closest(".c-file");c=e.find(".c-name").text();var f=parseInt(e.data("id"));
0<f?d.crm.confirm.show({title:b.locales.remove_file_title,text:b.locales.remove_file_text.replace(/%s/,c),button:b.locales.remove_file_button,onConfirm:function(){a(f,e)}}):console&&console.log&&console.log("File ID is empty")})};CRMContactPage.prototype.initFixedHeader=function(){function a(){if(d.contains(document,e[0])){var l=b.scrollTop();l>f.top+70?(e.css({left:f.left,width:c.outerWidth()+"px"}).addClass("is-fixed"),l>f.top+c.outerHeight()-e.outerHeight()?e.removeClass("is-hover").css("background",
g):(l="linear-gradient(to bottom, "+g+" 0%, "+g+" 70%, rgba("+h.join(",")+") 100%)",e.addClass("is-hover").css("background",l)),c.addClass("is-over")):(e.removeAttr("style").removeClass("is-fixed"),c.removeClass("is-over"))}else b.off("scroll",a)}var b=d(window),c=this.$wrapper.find(".js-profile"),e=this.$wrapper.find(".js-short-profile"),f=c.offset(),g=c.css("background-color"),h=g.replace("rgba(","").replace("rgb(","").replace(")","").split(",");h=d.map(h,function(l){return parseInt(l)});3>=h.length?
h.push(0):h[3]=0;e.on("click",".js-short-responsible-link",function(){c.find(".profile-header-links .js-responsible-link").trigger("click")});e.on("click",".js-short-access-link",function(){c.find(".profile-header-links .js-access-link").trigger("click")});e.on("click",".js-short-edit-link",function(){c.find(".profile-header-links .js-edit-link").trigger("click")});e.on("click",".js-short-delete-link",function(){c.find(".profile-header-links .js-delete-link").trigger("click")});b.on("scroll",a)};
CRMContactPage.prototype.initMessage=function(){this.initSendEmail();this.initSendSMS()};CRMContactPage.prototype.initSendEmail=function(){var a=!1;this.$wrapper.on("click",".js-show-message-dialog",function(b){b.preventDefault();var c=d(this);b=c.data("id");c=c.data("email");!a&&b&&(a=!0,d.post("?module=message&action=writeNewDialog",{contact_id:b,email:c},function(e){new CRMDialog({html:e})}).always(function(){a=!1}))})};CRMContactPage.prototype.initSendSMS=function(){var a=!1;this.$wrapper.on("click",
".js-show-send-sms-dialog",function(b){b.preventDefault();var c=d(this);b=c.data("id");c=c.data("phone");!a&&b&&(a=!0,d.get("?module=message&action=writeSMSNewDialog",{contact_id:b,phone:c},function(e){new CRMDialog({html:e})}).always(function(){a=!1}))})};CRMContactPage.prototype.initCall=function(){var a=!1;this.$wrapper.on("click",".js-show-call-dialog",function(b){b.preventDefault();var c=d(this);b=c.data("id");c=c.data("phone");!a&&b&&c&&(a=!0,d.post("?module=call&action=initContactDialog",{contact_id:b,
phone:c},function(e){new CRMDialog({remain_after_load:!0,html:e})}).always(function(){a=!1}))})};return CRMContactPage}(jQuery),CRMNewContactPage=function(d){CRMNewContactPage=function(a){this.$wrapper=a.$wrapper;this.$contactSection=this.$wrapper.find(".js-contact-section");this.$accessSection=this.$wrapper.find(".js-access-section");this.$segmentsSection=this.$wrapper.find(".js-segments-section");this.$dealSection=this.$wrapper.find(".js-deal-section");this.$errorsSection=this.$wrapper.find(".js-errors-section");
this.$extendedFieldsW=this.$wrapper.find(".js-contact-extended-fields");this.call_id=a.call_id;this.funnels=a.funnels;this.locales=a.locales;this.contact_data=a.contact_data;this.stage_template_html=a.stage_template_html;this.extended_fields=a.extended_fields||{};this.is_extended=a.is_extended||!1;this.create_deal=this.selected_segments=!1;this.initClass()};CRMNewContactPage.prototype.initClass=function(){d.crm.renderSVG(this.$wrapper);this.contact_data&&this.setContactData(this.contact_data);this.initContactToggle();
this.initAccessToggle();this.initSegmentsToggle();this.initDealToggle();this.initDealSection();this.$extendedFieldsW.length&&this.initExtendedFields();this.initCreate();this.initHeaderActions();this.initWYSIWYG();this.initContactUpdateDialog()};CRMNewContactPage.prototype.initContactToggle=function(){var a=this;a.$contactSection.on("click",".js-extended-toggle",function(b){b.preventDefault();a.$contactSection.hasClass("is-extended")?(a.$contactSection.removeClass("is-extended"),a.is_extended=!1):
(a.$contactSection.addClass("is-extended"),a.is_extended=!0)})};CRMNewContactPage.prototype.initAccessToggle=function(){var a=this,b=a.$accessSection.find(".js-ibutton");b.iButton({labelOn:"",labelOff:"",classContainer:"c-ibutton ibutton-container mini"});b.on("change",function(){"checked"===b.attr("checked")?(a.$accessSection.addClass("is-extended"),a.selected_access=!0):(a.$accessSection.removeClass("is-extended"),a.selected_access=!1)})};CRMNewContactPage.prototype.initSegmentsToggle=function(){var a=
this,b=a.$segmentsSection.find(".js-ibutton");b.iButton({labelOn:"",labelOff:"",classContainer:"c-ibutton ibutton-container mini"});b.on("change",function(){"checked"===b.attr("checked")?(a.$segmentsSection.addClass("is-extended"),a.selected_segments=!0):(a.$segmentsSection.removeClass("is-extended"),a.selected_segments=!1)})};CRMNewContactPage.prototype.initDealToggle=function(){var a=this,b=a.$dealSection.find(".js-ibutton");b.iButton({labelOn:"",labelOff:"",classContainer:"c-ibutton ibutton-container mini"});
b.on("change",function(){"checked"===b.attr("checked")?(a.$dealSection.addClass("is-extended"),a.create_deal=!0):(a.$dealSection.removeClass("is-extended"),a.create_deal=!1)})};CRMNewContactPage.prototype.initDealSection=function(){var a=this,b=a.$wrapper.find(".js-funnels-list");(function(){var c=b.find(".js-visible-link"),e=b.find(".js-field"),f=b.find(".menu-v");f.on("click","a",function(){var g=d(this);c.find(".js-text").html(g.html());f.find(".selected").removeClass("selected");g.closest("li").addClass("selected");
f.hide();setTimeout(function(){f.removeAttr("style")},200);g=g.data("id");e.val(g).trigger("change");(g=a.funnels[g]||!1)&&b.trigger("changeFunnel",g)});d.crm.renderSVG(b)})();(function(){function c(k){l.html("");d.each(k,function(m,n){m=a.stage_template_html;var p=d("<div />").text(n.name).html();m=m.replace("%id%",n.id).replace("%color%",n.color).replace("%name%",p);n=d(m);l.append(n)});d.crm.renderSVG(f);l.find("li:first-child a").trigger("click")}var e=a.$wrapper.find(".js-funnels-list"),f=a.$wrapper.find(".js-funnel-stages-list"),
g=f.find(".js-visible-link"),h=f.find(".js-field"),l=f.find(".menu-v");l.on("click","a",function(){var k=d(this);g.find(".js-text").html(k.html());l.find(".selected").removeClass("selected");k.closest("li").addClass("selected");l.hide();setTimeout(function(){l.removeAttr("style")},200);k=k.data("id");h.val(k)});e.on("changeFunnel",function(k,m){c(m.stages)})})();(function(){function c(){var h=d.datepicker._defaults.dateFormat,l=!1;try{d.datepicker.parseDate(h,f.val()),l=!0}catch(k){}l?(f.data("last-correct-value",
f.val()),g.data("last-correct-value",g.val())):(f.val(f.data("last-correct-value")||""),g.val(g.data("last-correct-value")||""))}var e=a.$wrapper.find(".js-datepicker-wrapper"),f=e.find(".js-datepicker"),g=e.find('[name="deal[expected_date]"]');f.datepicker({altField:g,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,onSelect:c});f.on("blur",c);f.on("keydown keypress keyup",function(h){13===h.which&&h.preventDefault()});e.on("click",".js-icon",function(){f.focus()})})();(function(){var c=a.$wrapper.find(".js-contact-block"),
e=c.find(".js-view-toggle"),f=e.find(".is-active");e.on("click",".c-toggle",function(g){g.preventDefault();g=d(this);var h=g.data("id");if(g.hasClass("is-active"))return!1;a.contact_mode=h;f.length&&f.removeClass("is-active");g.addClass("is-active");f=g;c.find(".c-hidden.is-active").removeClass("is-active");c.find(".c-hidden-"+h).addClass("is-active")})})()};CRMNewContactPage.prototype.initCreate=function(){function a(){function g(){var n=e.$wrapper.find(".js-option-field:checked"),p=e.$wrapper.find(".js-vault-toggle"),
q=e.$wrapper.find(".js-owners-list");n.length&&(n=n.val(),"vaults"===n?(p=p.find(".js-field").val(),m.data.push({name:"vault_id",value:p})):"owners"===n&&(p=q.find(".c-owner"),p.length||m.errors.push({name:"owner[autocomplete]"}),p.each(function(){var r=d(this).data("id");0<r&&m.data.push({name:"owners[]",value:r})})))}function h(){var n=e.$segmentsSection.find("form").serializeArray();d.each(n,function(p,q){m.data.push(q)})}function l(){var n=e.$dealSection.find("form").serializeArray(),p=!0;d.each(n,
function(q,r){m.data.push(r);0<d.trim(r.value).length&&"deal[name]"===r.name&&(p=!1)});p&&m.errors.push({name:"deal[name]",value:e.locales.empty_deal_name})}function k(){var n=e.$extendedFieldsW.data("getFormData")();d.each(n.data,function(p,q){m.data.push(q)});d.each(n.errors,function(p,q){m.errors.push(q)})}var m={data:[],errors:[]};(function(){var n=e.$contactSection.find("form.c-general-form"),p=n.find(".js-phone-list"),q=n.find(".js-email-list");p.find("li .js-value, li .js-ext").removeAttr("name");
q.find("li .js-value, li .js-ext").removeAttr("name");n=n.serializeArray();var r=["contact[firstname]","contact[middlename]","contact[lastname]","contact[name]"],t=!0;d.each(n,function(u,v){v.value=d.trim(v.value);m.data.push(v);0<d.trim(v.value).length&&0<=r.indexOf(v.name)&&(t=!1)});t&&(n=e.$contactSection.find('[name="contact[firstname]"]'),n.length?m.errors.push({name:"contact[firstname]",value:e.locales.empty_contact_name}):(n=e.$contactSection.find('[name="contact[name]"]'),n.length&&m.errors.push({name:"contact[name]",
value:e.locales.empty_contact_name})));p.find("li").each(function(u){var v=d(this),w=v.find(".js-value");v=v.find(".js-ext");var x=w.val(),y=v.val();if(x){var z="contact[phone]["+u+"][value]";w.attr("name",z);m.data.push({name:z,value:x});u="contact[phone]["+u+"][ext]";v.attr("name",u);m.data.push({name:u,value:y})}});q.find("li").each(function(u){var v=d(this),w=v.find(".js-value");v=v.find(".js-ext");var x=w.val(),y=v.val();if(x){var z="contact[email]["+u+"][value]";w.attr("name",z);m.data.push({name:z,
value:x});u="contact[email]["+u+"][ext]";v.attr("name",u);m.data.push({name:u,value:y})}})})();e.$extendedFieldsW.length&&e.is_extended&&k();e.selected_access&&g();e.selected_segments&&h();e.create_deal&&l();return m}function b(g,h){h=h?h:[];g&&(h=g);d.each(h,function(l,k){l=k.value;var m=e.$wrapper.find(':input[name="'+k.name+'"]'),n=d("<div />").addClass("errormsg").text(l);m.length?m.hasClass("error")||(m.parent().append(n),m.addClass("error").one("focus click change",function(){m.removeClass("error");
n.remove()})):e.$errorsSection.append(n)})}function c(g){f||(f=!0,d.post("?module=contact&action=newSave",g,function(h){"ok"===h.status?d.crm.content.load(d.crm.app_url+"contact/"+h.data.contact.id+"/"):b(h.errors)},"json").always(function(){f=!1}))}var e=this,f=!1;e.$wrapper.on("click",".js-submit-form",function(g){g.preventDefault();e.$errorsSection.html("");g=a();g.errors.length?b(!1,g.errors):c(g.data)})};CRMNewContactPage.prototype.initExtendedFields=function(){function a(f){f=f||{};var g=b.$wrapper,
h="c-conditional-field-"+(""+Math.random()).slice(2),l=f.input_name;f.parent_field=f.parent_field||"";f.parent_options=f.parent_options||{};f.index=f.index||0;if(f.parent_field&&!d.isEmptyObject(f.parent_options)){var k=f.parent_field.split(":");if(!(1>=k.length)){k='[name="contact['+k[0]+"]["+f.index+"]["+k[1]+']"]';var m=g.find(k);if(!(0>=m.length)){f.show_empty_option=f.required;var n=f.parent_options,p=g.find(':input[name="'+l+'"]').first();if(!(0>=p.length)){if(p.is("input"))var q=p.next();else q=
p,p=q.prev();var r=function(){p[0].hasAttribute("name")||(p.attr("name",q.attr("name")),q[0].removeAttribute("name"));p.show().val("");q.hide()};g=function(){var t=p.is(":visible")?p.val():q.val();var u=d(this).val().toLowerCase();f.hide_unmatched&&p.closest(".field").show();if(n&&n[u]){u=n[u];p.hide();q.show().children().remove();f.show_empty_option&&q.append(d('<option value=""></option>'));for(var v=0;v<u.length;v++)q.append(d("<option></option>").attr("value",u[v]).text(u[v]));q.val(t);p[0].hasAttribute("name")&&
(q.attr("name",p.attr("name")),p[0].removeAttribute("name"))}else f.hide_unmatched?(r(),p.val(""),p.closest(".field").hide()):p.is(":visible")||(r(),p.val(t))};g.call(m);l=m.closest(".field");l.length?(l.off("."+h),l.on("change."+h,k,g)):(m.off("."+h),m.on("change."+h,g))}}}}}var b=this,c=b.$extendedFieldsW,e=c.find("form");(function(){var f=c.find(".js-dynamic-field-wrapper");f.each(function(){var g=d(this),h=g.find(".js-list"),l=h.find(".c-item")[0].outerHTML;g.on("click",".js-add",function(){h.append(l)});
g.on("click",".js-remove",function(){d(this).closest(".c-item").remove()});h.on("change",".js-ext-toggle",function(){var k=d(this),m=k.closest(".c-item").find(".js-ext-field");"custom"===k.val()?m.attr("disabled",!1).show():m.attr("disabled",!0).hide()})});c.on("prepareSave",function(){f.each(function(){d(this).find(".js-list").find(".c-item").each(function(g){d(this).find("[data-name-pattern]").each(function(){var h=d(this),l=h.data("name-pattern");l&&(l=l.replace("%index%",g),h.attr("name",l))})})})})})();
(function(){function f(g){function h(){k.each(function(){d(this).find(".js-address-wrapper").each(function(n){d(this).find("[data-name-pattern]").each(function(){var p=d(this),q=p.data("name-pattern");if(q&&(q=q.replace("%index%",n),p.attr("name",q),p.is("input"))){var r=p.closest(".js-custom-sub-field-line");r.is('[data-type="Conditional"]')&&(p=r.data("field-id"),r=r.data("subfield-id"),(p=l[p].fields[r])&&a(d.extend(p,{input_name:q,index:n})))}})})})}(function(){g.find(".js-custom-sub-field-line").each(function(){var n=
d(this),p=n.data("name-pattern");n.find(":input").each(function(){var q=d(this);q.attr("data-name-pattern",p);q.removeAttr("name")})});g.find('.js-custom-sub-field-line[data-type="Select"]').each(function(){var n=d(this);n.data("sub-type")||n.find("select").find('option[value=""]').text(n.data("label")+"...")});g.find('.js-custom-sub-field-line[data-type="Checkbox"]').each(function(){var n=d(this),p=n.find(":checkbox");p.wrap("<label>");p=p.parent();p.append("<span>");p.find("span").append(" "+n.data("label"))})})();
var l=b.extended_fields||{},k=g.find(".js-address-list"),m=g.find(".js-address-wrapper")[0].outerHTML;c.on("prepareSave",h);h();g.on("click",".js-add",function(){k.append(m);h()});g.on("click",".js-remove",function(){d(this).closest(".js-address-wrapper").remove()});g.on("click",".js-clear-selected-radio-value",function(){d(this).closest(".js-custom-sub-field-line").find(":radio:checked").attr("checked",!1)});g.on("change",".js-ext-toggle",function(){var n=d(this),p=n.closest(".js-address-wrapper").find(".js-ext-field");
"custom"===n.val()?p.attr("disabled",!1).show():p.attr("disabled",!0).hide()});g.on("change",".js-country-toggle",function(){function n(){w&&w.abort();w=d.post(d.crm.backend_url+"?module=profile&action=regions",{country:v},function(x){"ok"===x.status&&(d.isEmptyObject(x.data.options)?p(!1):p(x.data))}).always(function(){w=!1})}function p(x){t.html("");u.val("");x&&Object.keys(x).length?(t.attr("disabled",!1).show(),u.attr("disabled",!0).hide(),d.each(x.oOrder,function(y,z){(y=x.options[z])&&t.append('<option value="'+
z+'">'+y+"</option>")})):(t.attr("disabled",!0).hide(),u.attr("disabled",!1).show())}var q=d(this),r=q.closest(".js-address-wrapper"),t=r.find(".js-region-select"),u=r.find(".js-region-field"),v=q.val(),w=!1;v?n(v):p(!1)})}c.find(".js-address-section").each(function(){f(d(this))})})();(function(){var f=c.find(".js-bank-section");if(!f.length)return!1;var g=f.find(".js-bank-list"),h=f.find(".js-bank-wrapper")[0].outerHTML;f.on("click",".js-add",function(){g.append(h)});g.on("click",".js-remove",function(){d(this).closest(".js-bank-wrapper").remove()});
f.on("change",".js-ext-toggle",function(){var l=d(this),k=l.closest(".js-bank-wrapper").find(".js-ext-field");"custom"===l.val()?k.attr("disabled",!1).show():k.attr("disabled",!0).hide()});c.on("prepareSave",function(){g.each(function(){d(this).find(".js-bank-wrapper").each(function(l){d(this).find("[data-name-pattern]").each(function(){var k=d(this),m=k.data("name-pattern");m&&(m=m.replace("%index%",l),k.attr("name",m))})})})})})();(function(){c.find(".js-datepicker input:text").each(function(){function f(){try{d.datepicker.parseDate(d.datepicker._defaults.dateFormat,
g.val()),g.data("last-correct-value",g.val()),h.data("last-correct-value",h.val())}catch(l){g.val(g.data("last-correct-value")||""),h.val(h.data("last-correct-value")||"")}}var g=d(this),h=g.siblings('input[type="hidden"]');g.datepicker({altField:h,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,onSelect:f});g.on("blur",f);g.on("keydown keypress keyup",function(l){13===l.which&&l.preventDefault()})})})();c.data("getFormData",function(){c.trigger("prepareSave");var f=e.serializeArray(),g={data:[],
errors:[]};d.each(f,function(h,l){g.data.push(l)});return g})};CRMNewContactPage.prototype.setContactData=function(a){var b=this;d.each(a,function(c,e){"string"===typeof e||"number"===typeof e?(c=b.$wrapper.find('[name="contact['+c+']"]'),c.length&&c.val(e).trigger("change")):("phone"===c&&d.each(e,function(f,g){f={number:g.value,ext:g.ext};d(document).trigger("addContactPhone",f)}),"email"===c&&d.each(e,function(f,g){f={name:g.value,ext:g.ext};d(document).trigger("addContactEmail",f)}))})};CRMNewContactPage.prototype.initHeaderActions=
function(){function a(){b||(b=!0,d.post("?module=contact&action=createSettings",{},function(c){new CRMDialog({html:c})}).always(function(){b=!1}))}var b=!1;this.$wrapper.on("click",".js-show-personal-settings-dialog",function(c){c.preventDefault();a()})};CRMNewContactPage.prototype.initWYSIWYG=function(){var a=this.$wrapper.find(".js-wysiwyg");if(!a.length)return!1;a.each(function(){var b=d(this);d.crm.initWYSIWYG(b,{keydownCallback:function(c){}})})};CRMNewContactPage.prototype.initContactUpdateDialog=
function(){function a(){c||(c=!0,d.post(d.crm.app_url+"?module=contact&action=updateDialog",{call_id:b.call_id},function(e){new CRMDialog({html:e})}).always(function(){c=!1}))}var b=this,c=!1;b.$wrapper.on("click",".js-show-update-dialog",function(e){e.preventDefault();a()})};return CRMNewContactPage}(jQuery),CRMContactAccessDialogNew=function(d){CRMContactAccessDialogNew=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$optionsList=this.$wrapper.find(".js-options-list");
this.$vaultsToggle=this.$wrapper.find(".js-vault-toggle");this.$ownersList=this.$wrapper.find(".js-owners-list");this.$submitButton=this.$wrapper.find(".js-save");this.$errorsPlace=this.$wrapper.find(".js-errors-place");this.dialog=this.$wrapper.data("dialog");this.owner_template_html=a.owner_template_html;this.contact_id=a.contact_id;this.owners=a.owners;this.locales=a.locales;this.initClass()};CRMContactAccessDialogNew.prototype.initClass=function(){this.initChangeOptions();this.initAutocomplete();
this.initVaultToggle()};CRMContactAccessDialogNew.prototype.initChangeOptions=function(){var a=this.$optionsList.find(".c-option.is-active");this.$optionsList.on("change",".js-option-field",function(){var b=d(this),c=b.closest(".c-option");"checked"===b.attr("checked")&&(a.length&&a.removeClass("is-active"),a=c.addClass("is-active"))})};CRMContactAccessDialogNew.prototype.initAutocomplete=function(){function a(e){e.addClass("highlighted");setTimeout(function(){e.removeClass("highlighted")},2E3)}var b=
this,c=b.$ownersList.find(".js-autocomplete");c.autocomplete({source:d.crm.app_url+"?module=autocomplete&type=user",appendTo:b.$wrapper,minLength:0,focus:function(){return!1},select:function(e,f){e=b.$ownersList.find('.c-owner[data-id="'+f.item.id+'"]');e=e.length?e:void 0;if(!e){var g=f.item;e=b.owner_template_html;f=g.photo_url;e=e.replace(/%id%/,g.id);var h=e.replace;g=g.name;g=d("<div></div>").text(g).html();e=h.call(e,"%name%",g).replace("%photo_url%",f);f=d(e);b.$ownersList.append(f);e=f}a(e);
c.val("");return!1}}).data("ui-autocomplete")._renderItem=function(e,f){return d('<li class="ui-menu-item-html"><div>'+f.value+"</div></li>").appendTo(e)};c.on("focus",function(){c.data("uiAutocomplete").search(c.val())});b.$ownersList.on("click",".js-delete-owner",function(){d(this).closest(".c-owner").remove()})};CRMContactAccessDialogNew.prototype.initVaultToggle=function(){var a=this.$vaultsToggle,b=a.find(".js-visible-link"),c=a.find(".js-field"),e=a.find(".menu-v");e.on("click","a",function(){var f=
d(this);b.find(".js-text").html(f.html());e.find(".selected").removeClass("selected");f.closest("li").addClass("selected");e.hide();setTimeout(function(){e.removeAttr("style")},200);f=f.data("id");c.val(f)});d.crm.renderSVG(a)};return CRMContactAccessDialogNew}(jQuery),CRMContactResponsibleDialog=function(d){CRMContactResponsibleDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$responsibleList=this.$wrapper.find(".js-responsible-list");this.$submitButton=this.$wrapper.find(".js-save");
this.dialog=this.$wrapper.data("dialog");this.locales=a.locales;this.responsible_template_html=a.responsible_template_html;this.initClass()};CRMContactResponsibleDialog.prototype.initClass=function(){var a=this;a.$wrapper.on("change","input",function(){a.toggleButton(!0)});a.initSubmit();a.initClearResponsible();a.initAutocomplete()};CRMContactResponsibleDialog.prototype.initSubmit=function(){function a(){if(!e){e=!0;var f=d.crm.app_url+"?module=contact&action=responsibleSave",g=b();if(!g)return e=
!1;var h=d('<i class="icon16 loading" style="vertical-align: middle; margin: 0;"></i>');h.appendTo(c.$submitButton.parent());c.$submitButton.attr("disabled",!0);d.post(f,g,function(l){"ok"===l.data.result?d.crm.content.reload().then(function(){c.dialog.close()}):"no_vault_access"===l.data.result&&(d(".no-access-error").html(l.data.message),setTimeout(function(){c.dialog.close()},5E3))},"json").always(function(){c.$submitButton.attr("disabled",!1);c.toggleButton(!1);h.remove();e=!1})}}function b(){var f=
d("#contact_id").val(),g=d("#responsible_id").val();return{contact_id:f,responsible_id:g}}var c=this,e=!1;c.$form.on("submit",function(f){f.preventDefault();a()})};CRMContactResponsibleDialog.prototype.initClearResponsible=function(){function a(){var e=d.crm.app_url+"?module=contact&action=responsibleSave",f={contact_id:d("#contact_id").attr("value"),responsible_id:0},g=d('<i class="icon16 loading" style="vertical-align: middle; margin: 0;"></i>');g.appendTo(c.$submitButton.parent());c.$submitButton.attr("disabled",
!0);d.post(e,f,function(h){"ok"===h.status?d.crm.content.reload().then(function(){c.dialog.close()}):(console.log("Error saving Responsible contact classification: "+arguments[2],arguments),b("Error saving Responsible contact classification: "+arguments[2]))},"json").always(function(){c.$submitButton.attr("disabled",!1);c.toggleButton(!1);g.remove()})}function b(e){e=d('<div class="errormsg" />').text(e);c.$errorsPlace.append(e)}var c=this;c.$wrapper.on("click",".js-clear-responsible",function(e){e.preventDefault();
d.crm.confirm.show({title:c.locales.clear_responsible_title,text:c.locales.clear_responsible_text,button:c.locales.clear_responsible_button,onConfirm:a})})};CRMContactResponsibleDialog.prototype.initAutocomplete=function(){function a(f){f.addClass("highlighted");setTimeout(function(){f.removeClass("highlighted")},2E3)}var b=this,c=d("#contact_id").val(),e=b.$responsibleList.find(".js-autocomplete");e.autocomplete({source:d.crm.app_url+"?module=autocomplete&type=user&contact_id="+c,appendTo:b.$wrapper,
minLength:0,focus:function(){return!1},select:function(f,g){f=b.$responsibleList.find('.c-responsible[data-id="'+g.item.id+'"]');f=f.length?f:void 0;if(!f){g=g.item;var h=b.responsible_template_html;f=g.photo_url;h=h.replace(/%id%/,g.id);var l=h.replace;var k=g.name;k=d("<div></div>").text(k).html();h=l.call(h,"%name%",k).replace("%photo_url%",f);d("#responsible_id").val(g.id);g=d(h);b.$responsibleList.append(g);d(".js-input").css("display","none");b.$submitButton.attr("disabled",!1);b.toggleButton(!0);
f=g}a(f);b.toggleButton(!0);e.val("");return!1}}).data("ui-autocomplete")._renderItem=function(f,g){var h=d("<li />");h.addClass("ui-menu-item-html").append("<div>"+g.value+"</div>").appendTo(f);g.rights||(h.addClass("is-locked"),h.on("click",function(l){l.preventDefault();l.stopPropagation()}));return h};e.on("focus",function(){e.data("uiAutocomplete").search(e.val())});b.$responsibleList.on("click",".js-delete-responsible",function(){d(this).closest(".c-responsible").remove();d("#responsible_id").val("");
d(".js-input").css("display","");d(".js-autocomplete").focus();b.$submitButton.attr("disabled",!0);b.toggleButton(!0)})};CRMContactResponsibleDialog.prototype.toggleButton=function(a){var b=this.$submitButton;a?b.removeClass("green").addClass("yellow"):b.removeClass("yellow").addClass("green")};return CRMContactResponsibleDialog}(jQuery),CRMContactAccessDialog=function(d){CRMContactAccessDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$optionsList=this.$wrapper.find(".js-options-list");
this.$vaultsToggle=this.$wrapper.find(".js-vault-toggle");this.$ownersList=this.$wrapper.find(".js-owners-list");this.$submitButton=this.$wrapper.find(".js-save");this.$errorsPlace=this.$wrapper.find(".js-errors-place");this.dialog=this.$wrapper.data("dialog");this.owner_template_html=a.owner_template_html;this.contact_id=a.contact_id;this.owners=a.owners;this.locales=a.locales;this.initClass()};CRMContactAccessDialog.prototype.initClass=function(){var a=this;a.$wrapper.on("change","input",function(){a.toggleButton(!0)});
a.initChangeOptions();a.initSubmit();a.initAutocomplete();a.initVaultToggle()};CRMContactAccessDialog.prototype.initSubmit=function(){function a(){if(!f){f=!0;e.$errorsPlace.html("");var g=d.crm.app_url+"?module=contact&action=accessSave",h=b();if(!h)return f=!1;var l=d('<i class="icon16 loading" style="vertical-align: middle; margin: 0;"></i>');l.appendTo(e.$submitButton.parent());e.$submitButton.attr("disabled",!0);d.post(g,h,function(k){"ok"===k.status?d.crm.content.reload().then(function(){e.dialog.close()}):
(console.log("Error saving contact access classification: "+arguments[2],arguments),c("Error saving contact access classification: "+arguments[2]))},"json").always(function(){e.$submitButton.attr("disabled",!1);l.remove();e.toggleButton(!1);f=!1})}}function b(){var g=[],h=e.$wrapper.find(".js-option-field:checked");if(h.length){h=h.val();if("vaults"===h){var l=e.$vaultsToggle.find(".js-field").val();g.push({name:"vault_id",value:l})}if("owners"===h){l=e.$ownersList.find(".c-owner");if(!l.length)return c(e.locales.empty_owner),
!1;l.each(function(){var k=d(this).data("id");0<k&&g.push({name:"owners[]",value:k})})}"all"===h&&g.push({name:"vault_id",value:"0"});h=e.$wrapper.find(".js-employees-field");h.length&&"checked"===h.attr("checked")&&g.push({name:"employees",value:"on"});g.push({name:"contact_id",value:e.contact_id})}return g}function c(g){g=d('<div class="errormsg" />').text(g);e.$errorsPlace.append(g)}var e=this,f=!1;e.$form.on("submit",function(g){g.preventDefault();a()})};CRMContactAccessDialog.prototype.initChangeOptions=
function(){var a=this,b=a.$optionsList.find(".c-option.is-active");a.$optionsList.on("change",".js-option-field",function(){var c=d(this),e=c.closest(".c-option");"checked"===c.attr("checked")&&(b.length&&b.removeClass("is-active"),b=e.addClass("is-active"));a.dialog.resize()})};CRMContactAccessDialog.prototype.initAutocomplete=function(){function a(e){e.addClass("highlighted");setTimeout(function(){e.removeClass("highlighted")},2E3)}var b=this,c=b.$ownersList.find(".js-autocomplete");c.autocomplete({source:d.crm.app_url+
"?module=autocomplete&type=user",appendTo:b.$wrapper,minLength:0,focus:function(){return!1},select:function(e,f){e=b.$ownersList.find('.c-owner[data-id="'+f.item.id+'"]');e=e.length?e:void 0;if(!e){var g=f.item;e=b.owner_template_html;f=g.photo_url;e=e.replace(/%id%/g,g.id);var h=e.replace;g=g.name;g=d("<div></div>").text(g).html();e=h.call(e,"%name%",g).replace("%photo_url%",f);f=d(e);b.$ownersList.append(f);b.dialog.resize();e=f}a(e);b.toggleButton(!0);c.val("");return!1}}).data("ui-autocomplete")._renderItem=
function(e,f){return d('<li class="ui-menu-item-html"><div>'+f.value+"</div></li>").appendTo(e)};c.on("focus",function(){c.data("uiAutocomplete").search(c.val())});b.$ownersList.on("click",".js-delete-owner",function(){d(this).closest(".c-owner").remove();b.toggleButton(!0)})};CRMContactAccessDialog.prototype.toggleButton=function(a){var b=this.$submitButton;a?b.removeClass("green").addClass("yellow"):b.removeClass("yellow").addClass("green")};CRMContactAccessDialog.prototype.initVaultToggle=function(){var a=
this.$vaultsToggle,b=a.find(".js-visible-link"),c=a.find(".js-field"),e=a.find(".menu-v");e.on("click","a",function(){var f=d(this);b.find(".js-text").html(f.html());e.find(".selected").removeClass("selected");f.closest("li").addClass("selected");e.hide();setTimeout(function(){e.removeAttr("style")},200);f=f.data("id");c.val(f)});d.crm.renderSVG(a)};return CRMContactAccessDialog}(jQuery),CRMContactCreateSettings=function(d){CRMContactCreateSettings=function(a){this.$wrapper=a.$wrapper;this.$form=
this.$wrapper.find("form");this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMContactCreateSettings.prototype.initClass=function(){this.initSave()};CRMContactCreateSettings.prototype.initSave=function(){function a(){var g={data:[],errors:[]},h=e.serializeArray();d.each(h,function(l,k){g.data.push(k)});return g}function b(g){f||(f=!0,d.post("?module=contact&action=createSettingsSave",g,function(h){"ok"===h.status?c.dialog.close():(h=(h=h.errors)?h:[],console.log(h))},"json").always(function(){f=
!1}))}var c=this,e=c.$form,f=!1;e.on("submit",function(g){g.preventDefault();g=a();g.errors.length?(g=(g=g.errors)?g:[],console.log(g)):b(g.data)})};return CRMContactCreateSettings}(jQuery),CRMContactAddEmployeeDialog=function(d){CRMContactAddEmployeeDialog=function(a){this.$wrapper=a.$wrapper;this.contact_id=a.contact_id;this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMContactAddEmployeeDialog.prototype.initClass=function(){this.initAddEmployee()};CRMContactAddEmployeeDialog.prototype.initAddEmployee=
function(){function a(h){function l(m){var n=d('<div class="line errormsg" />').html(m);f.append(n);c.$form.one("submit",function(){n.remove()})}if(h[0])d.each(h,function(m,n){l(n.value)});else{var k=Object.keys(h);d.each(k,function(m,n){l(h[n])})}}function b(h){g||(g=!0,d.post("?module=contact&action=addEmployeeSave",h,function(l){"ok"===l.status?(d.crm.content.reload(),c.dialog.close()):l.errors&&a(l.errors)}).always(function(){g=!1}))}var c=this,e=c.$wrapper.find("#c-contact-add-employee-form"),
f=c.$wrapper.find(".js-errors-place"),g=!1;e.on("submit",function(h){h.preventDefault();h=e.serializeArray();var l=[];l.length?a(l):b(h)})};return CRMContactAddEmployeeDialog}(jQuery),CRMContactUpdateDialog=function(d){CRMContactUpdateDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$footer=this.$wrapper.find(".js-dialog-footer");this.$submitButton=this.$wrapper.find(".js-submit-button");this.initClass()};CRMContactUpdateDialog.prototype.initClass=function(){this.initAutocomplete();
this.initSubmit()};CRMContactUpdateDialog.prototype.initAutocomplete=function(){var a=this,b=a.$wrapper.find(".js-autocomplete-wrapper"),c=b.find(".js-autocomplete"),e=b.find(".js-field");c.autocomplete({appendTo:b,source:d.crm.app_url+"?module=autocomplete",minLength:2,html:!0,focus:function(){return!1},select:function(f,g){f=d("<div />").text(g.item.name).text();c.val(f).blur();e.val(g.item.id).trigger("change");return!1}}).data("ui-autocomplete")._renderItem=function(f,g){return d("<li />").addClass("ui-menu-item-html").append("<div>"+
g.value+"</div>").appendTo(f)};e.on("change",function(){a.$submitButton.attr("disabled",!1)})};CRMContactUpdateDialog.prototype.initSubmit=function(){function a(){var h={data:[],errors:[]},l=e.serializeArray();d.each(l,function(k,m){h.data.push(m)});return h}function b(h){h=h?h:[];d.each(h,function(l,k){l=k.value;var m=e.find('[name="'+k.name+'"]'),n=d("<span />").addClass("errormsg").text(l);m.length?m.hasClass("error")||(m.parent().append(n),m.addClass("error").one("focus click",function(){m.removeClass("error");
n.remove()})):(f.append(n),e.one("submit",function(){n.remove()}))})}function c(h){g||(g=!0,d.post("?module=contact&action=update",h,function(l){"ok"===l.status?d.crm.content.load(d.crm.app_url+"contact/"+l.data.id+"/"):b(l.errors)},"json").always(function(){g=!1}))}var e=this.$form,f=this.$wrapper.find(".js-errors-place"),g=!1;e.on("submit",function(h){h.preventDefault();h=a();h.errors.length?b(h.errors):c(h.data)})};return CRMContactUpdateDialog}(jQuery),CRMContactAddCompanyContactDialog=function(d){CRMContactAddCompanyContactDialog=
function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$company_value=this.$wrapper.find(".js-company-value");this.$submit=this.$wrapper.find(".js-submit");this.$footer=this.$wrapper.find(".js-dialog-footer");this.$company_id_input=this.$wrapper.find(".js-company-id");this.$company_name_input=this.$wrapper.find(".js-autocomplete-company");this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMContactAddCompanyContactDialog.prototype.initClass=function(){var a=this;
a.$form.on("click",".js-company-item",function(){a.$submit.prop("disabled",!1)});a.initAutoComplete();a.initSubmit()};CRMContactAddCompanyContactDialog.prototype.initAutoComplete=function(){var a=this,b=a.$wrapper.find(".js-selected-company"),c=a.$wrapper.find(".js-change-company"),e=a.$wrapper.find(".js-label-new-company");a.$company_name_input.autocomplete({source:function(f,g){d.post("?module=autocomplete&type=company",f,function(h){d.isEmptyObject(h)&&f.term?e.css({color:"#999"}):e.css({color:"#FFF"});
g(h)},"json")},minLength:0,focus:function(){return!1},select:function(f,g){a.$company_id_input.val(g.item.id);b.html('<i class="icon16 userpic20" style="background-image: url('+g.item.photo_url+');"></i>').append(d("<span />").text(g.item.name)).removeClass("hidden");a.$company_name_input.addClass("hidden");return!1}}).data("ui-autocomplete")._renderItem=function(f,g){return d("<li />").addClass("ui-menu-item-html").append("<div>"+g.value+"</div>").appendTo(f)};a.$company_name_input.on("focus",function(){a.$company_name_input.data("uiAutocomplete").search(a.company_name)});
c.on("click",function(){a.$company_id_input.val(0);b.html("").addClass("hidden");a.$company_name_input.removeClass("hidden").focus()})};CRMContactAddCompanyContactDialog.prototype.initSubmit=function(){function a(){var c=d('<i class="icon16 loading" style="vertical-align: middle; margin-left: 6px;"></i>'),e=d.crm.app_url+"?module=contact&action=addCompanyContactSave",f=b.$form.serializeArray();b.$submit.prop("disabled",!0);b.$footer.append(c);d.post(e,f,function(g){"ok"===g.status?d.crm.content.reload():
(b.$submit.prop("disabled",!1),c.remove())})}var b=this;b.$form.on("submit",function(c){c.preventDefault();c=b.$company_id_input.val();var e=b.$company_name_input.val();if(0==c&&!d.trim(e))return b.$company_value.addClass("shake animated"),b.$company_name_input.focus(),setTimeout(function(){b.$company_value.removeClass("shake animated");b.$company_name_input.focus()},500),!1;a()})};return CRMContactAddCompanyContactDialog}(jQuery);var CRMContactsPage=function(d){CRMContactsPage=function(a){this.$wrapper=a.$wrapper;this.$content=this.$wrapper.find("#js-content-block");this.is_admin=a.is_admin;this.context=a.context||{};this.view=a.view||"thumbs";this.total_count=a.total_count||0;this.page_count=a.page_count||0;this.locales=a.locales;this.sidebar=this.$wrapper.find(".c-contacts-sidebar").data("sidebar_controller");this.initClass()};CRMContactsPage.prototype.initClass=function(){this.initElastic();"segment"===this.context.type&&
this.initEditableName(d.crm.app_url+"?module=contactSegment&action=save&is_rename=1",this.context);"list"===this.view&&(this.initContactsColumnsSection(),this.initContactsTable());"thumbs"===this.view&&this.initContactsThumbs();this.initOperationsMenu();"segment"===this.context.type?this.initSegmentContext():"search"===this.context.type&&this.initCreateFilterLink();this.$wrapper.on("click",".pager a",function(){d(this).replaceWith('<i class="icon16 loading"></i>');d(document).one("wa_loaded",function(){d("html, body").scrollTop(0)})});
this.initTableSlider();this.initHoverNames();this.initDroppable()};CRMContactsPage.prototype.initEditableName=function(a,b){var c=this.$wrapper.find(".js-name-editable").first();if(!(0>=c.length)){var e=this,f=!1,g=null;new CrmEditable({$wrapper:c,onSave:function(h){var l=h.$field.val();l.length&&h.text!==l?(g&&g.abort(),l={id:b.info.id,name:l},h.$field.attr("disabled",!0),f||(f=d('<i class="icon16 loading"></i>').css("margin","0 0 0 4px").insertAfter(h.$field)),g=d.post(a,l,function(k){k&&k.data&&
k.data.segment&&(h.text=k.data.segment.name,h.$wrapper.text(k.data.segment.name),e.sidebar.updateItem(b,{name:k.data.segment.name}))},"json").always(function(){h.$field.attr("disabled",!1);h.toggle("hide");f.length&&(f.remove(),f=!1)})):(l.length||h.$field.val(h.text),h.toggle("hide"))}})}};CRMContactsPage.prototype.initElastic=function(){var a=this.$wrapper,b=this.$wrapper.find("#js-aside-block"),c=this.$content;new CRMElasticBlock({$wrapper:a,$aside:b,$content:c});new CRMElasticBlock({$wrapper:a,
$content:b,$aside:c})};CRMContactsPage.prototype.initContactsColumnsSection=function(){function a(l){if(d.contains(document,e[0])){var k=e.hasClass("is-active");l=d.contains(e[0],l.target);k&&!l&&c()}else d(document).off("click",a)}function b(l){l.preventDefault();h||(h=!0,l=d.crm.app_url+"?module=contact&action=columns",f.html(g),c(!0),d.post(l,{},function(k){f.html(k)}).always(function(){h=!1}))}function c(l){l?e.addClass("is-active"):e.removeClass("is-active")}var e=this.$wrapper.find(".js-contacts-columns-section"),
f=e.find(".js-load-here"),g=f.html(),h=!1;e.on("click",".js-show-contact-columns-dialog",function(l){e.hasClass("is-active")?c(!1):b(l)});d(document).on("click",a);e.on("close",function(){c(!1)})};CRMContactsPage.prototype.initContactsTable=function(){var a=this;(function(){a.$wrapper.find(".js-width-toggle-wrapper").each(function(){var b=d(this),c=b.data("fullColumnId");b.on("click",".js-set-width",function(){var e=d(this).data("id");d.post(d.crm.app_url+"?module=contactColumns&action=saveWidth",
{width:e,full_column_id:c},function(){d.crm.content.reload()})})})})()};CRMContactsPage.prototype.initContactsThumbs=function(){};CRMContactsPage.prototype.initOperationsMenu=function(){new CRMContactsOperations({$wrapper:this.$wrapper,total_count:this.total_count,page_count:this.page_count,context:this.context,sidebar:this.sidebar,is_admin:this.is_admin,view:this.view})};CRMContactsPage.prototype.initSegmentContext=function(){var a=this.$wrapper;this.initSegmentLinks();this.sidebar.updateItem(this.context,
{count:this.context.info.count});var b=d.crm.storage.get("crm/create/category")||{},c=+new Date;d.crm.storage.del("crm/create/category");"category"===this.context.info.type&&(a=a.find(".js-segment-add-contacts"),b.id==this.context.info.id&&3E4>=c-b.timestamp&&a.click())};CRMContactsPage.prototype.initSegmentLinks=function(){function a(g){g.preventDefault();f&&f.abort();f=d.post(d.crm.app_url+"?module=contactSegment&action=addContacts",{id:b.context.info.id},function(h){new CRMDialog({html:h})}).always(function(){f=
!1})}var b=this,c=b.$wrapper.find(".js-segment-actions-list"),e=!1,f=!1;c.on("click",".js-show-edit-dialog",function(g){g.preventDefault();f&&f.abort();f=d.post(d.crm.app_url+"?module=contactSegment&action=edit",{id:b.context.info.id},function(h){new CRMDialog({html:h})}).always(function(){f=!1})});c.on("click",".js-show-archive-dialog",function(g){g.preventDefault();if(!e){e=!0;var h=d(this).closest(".crm-segment-archive-li"),l=h.hasClass("archived");h.removeClass("archived not-archived").addClass("loading");
d.post(d.crm.app_url+"?module=contactSegment&action=archive",{id:b.context.info.id,archive:l?0:1},function(){h.addClass(l?"not-archived":"archived")}).always(function(){h.removeClass("loading");e=!1})}});c.on("click",".js-show-delete-confirm",function(){function g(){d.post(d.crm.app_url+"?module=contactSegment&action=delete",{id:b.context.info.id},function(h){"ok"===h.status&&d.crm.content.load(d.crm.app_url+"contact/")}).always(function(){e=!1})}e||(e=!0,d.crm.confirm.show({title:b.locales.delete_segment_title,
text:b.locales.delete_segment_text,button:b.locales.delete_segment_button,onConfirm:g}))});c.on("click","a",function(){c.hide();setTimeout(function(){c.removeAttr("style")},200)});if("category"===b.context.info.type)c.on("click",".js-segment-add-contacts",a)};CRMContactsPage.prototype.initCreateFilterLink=function(){var a=this.$wrapper;a.find(".crm-create-filter-link").click(function(b){b.preventDefault();var c=d(this).data("hash");b=d.crm.app_url+"?module=contactSegment&action=edit";c={type:"search",
hash:c,name:a.find(".crm-contact-list-name").text()};d.get(b,c).done(function(e){new CRMDialog({html:e})})})};CRMContactsPage.prototype.initTableSlider=function(){function a(){d.contains(document,g[0])?(q=g.outerWidth(),r=h.outerWidth(),b(),t&&(t=!1,u=0,e(u))):d(window).off("resize",a)}function b(){if(r>q){var v=u+q>=r,w=u+q<r;0<u?v?(n.addClass("is-active"),p.removeClass("is-active")):w&&(n.addClass("is-active"),p.addClass("is-active")):(n.removeClass("is-active"),p.addClass("is-active"))}else n.removeClass("is-active"),
p.removeClass("is-active")}function c(v){var w=q/3;v?(v=u+w,v>r-q&&(v=r-q)):(v=u-w,0>v&&(v=0));u=v;t=!0;e(v);b()}function e(v){var w="-"+v+"px";h.data("isLeftSet",0<v);h.css({"-webkit-transform":"translate("+w+",0)",transform:"translate("+w+",0)"});k.css({"-webkit-transform":"translate("+w+",0)",transform:"translate("+w+",0)"})}var f=this,g=f.$wrapper.find(".js-contacts-section");if(!g.length)return!1;var h=g.find(".js-slider-body"),l=g.find(".js-header-table-wrapper"),k=l.find(".js-header-table"),
m=g.find(".js-arrows-wrapper"),n=m.find(".js-arrow-left"),p=m.find(".js-arrow-right"),q=g.outerWidth(),r=h.outerWidth(),t=!1,u=0;b();(function(){function v(){if(d.contains(document,x[0])){var z=w.scrollTop()>y.top,A=f.$content.height()>w.height();z&&A?(l.css({left:y.left}).width(g.outerWidth()).addClass("is-fixed"),x.addClass("is-fixed")):(l.removeAttr("style").removeClass("is-fixed"),x.removeClass("is-fixed"))}else w.off("scroll",v)}var w=d(window),x=m,y=g.offset();w.on("scroll",v)})();n.on("click",
function(){c(!1)});p.on("click",function(){c(!0)});d(window).on("resize",a)};CRMContactsPage.prototype.initHoverNames=function(){function a(){g=setTimeout(function(){c.removeClass("is-shown").html("")},500)}var b=this.$wrapper.find(".js-contacts-section");if(!b.length)return!1;var c=b.find(".c-hint-wrapper"),e=this.$wrapper.find(".js-contacts-table"),f=e.offset(),g=0;e.on("mouseenter","tr",function(){var h=d(this);if(e.data("isLeftSet")){clearTimeout(g);var l=h.find(".c-name").html();h=h.find("td:first").offset();
c.html(l).css({top:h.top+10-(f.top-28),left:10}).addClass("is-shown")}});e.on("mouseleave","tr",function(){a()});c.on("mouseenter",function(){clearTimeout(g)});c.on("mouseleave",a)};CRMContactsPage.prototype.initDroppable=function(){function a(c,e){d.post(d.crm.app_url+"?module=contactSegment&action=addContactsSave",{id:c,contact_id:e},"json").done(function(f){"ok"===f.status&&f.data.segment&&b.sidebar.updateItem({type:"segment",info:{id:c}},{count:f.data.segment.count})})}var b=this;b.$wrapper.find(".js-sidebar").find(".js-segment-droparea").each(function(){var c=
d(this);c.droppable({tolerance:"pointer",hoverClass:"is-hovered",over:function(e,f){f.draggable.hasClass("ui-draggable")||c.removeClass("is-hovered")},drop:function(e,f){e=d(this).data("id");var g=[],h=f.helper.data("user-id");f=f.helper.data("user-ids");h="undefined"!==typeof h?h+"":null;f="undefined"!==typeof f?f+"":null;h?g.push(h):f&&(0<f.indexOf(",")?g=f.split(","):g.push(f));0<e&&0<g.length&&a(e,g)}})})};return CRMContactsPage}(jQuery),CRMContactsColumnsDialog=function(d){CRMContactsColumnsDialog=
function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$activeList=this.$wrapper.find(".js-active-list");this.$unactiveList=this.$wrapper.find(".js-unactive-list");this.initClass()};CRMContactsColumnsDialog.prototype.initClass=function(){this.initSubmit();this.initSort();this.initComboList();this.$wrapper.on("click",".js-close-dialog",function(){d(this).closest(".js-contacts-columns-section").trigger("close")})};CRMContactsColumnsDialog.prototype.initSubmit=function(){function a(){if(!e){e=
!0;var f=d.crm.app_url+"?module=contactColumns&action=save",g=b();d.post(f,g,function(h){"ok"===h.status?d.crm.content.reload():alert("Error")}).always(function(){e=!1})}}function b(){var f=c.serializeArray();d.each(f,function(g,h){h.value=g+1});return f}var c=this.$form,e=!1;c.on("submit",function(f){f.preventDefault();a()})};CRMContactsColumnsDialog.prototype.initSort=function(){this.$activeList.sortable({distance:10,handle:".c-toggle",helper:"clone",items:".js-item",axis:"y"})};CRMContactsColumnsDialog.prototype.initComboList=
function(){var a=this;a.$activeList.on("change",".c-field",function(){var b=d(this),c=b.closest(".js-item");"checked"===b.attr("checked")?c.appendTo(a.$activeList):c.appendTo(a.$unactiveList)});a.$unactiveList.on("change",".c-field",function(){var b=d(this),c=b.closest(".js-item");"checked"===b.attr("checked")?c.appendTo(a.$activeList):c.appendTo(a.$unactiveList)})};return CRMContactsColumnsDialog}(jQuery),CRMThumbContact=function(d){CRMThumbContact=function(a){this.$wrapper=a.$wrapper;this.user_id=
this.$wrapper.data("user-id");this.can_be_drag=a.can_be_drag;this.initClass()};CRMThumbContact.prototype.initClass=function(){this.can_be_drag&&this.initDraggable()};CRMThumbContact.prototype.initDraggable=function(){var a=d("#c-contacts-sidebar .js-segment-droparea");this.$wrapper.draggable({handle:".js-userpic",delay:200,cursorAt:{top:0,left:0},helper:function(){var b=d("#c-users-list .js-move-user.is-active").map(function(){return d(this).data("user-id")}).toArray();return 1<b.length?'<div id="c-users-helper" data-user-ids="'+
b.join(",")+'"><span class="indicator red">'+b.length+"</span></div>":d(this).clone().addClass("is-clone")},start:function(){a.length&&a.addClass("c-drop-here")},stop:function(b,c){b=c.helper;var e=b.clone();e.insertAfter(b).fadeOut(270);setTimeout(function(){e.remove()},300);a.length&&a.removeClass("c-drop-here")}})};return CRMThumbContact}(jQuery),CRMTableContact=function(d){CRMTableContact=function(a){this.$wrapper=a.$wrapper;this.user_id=this.$wrapper.data("user-id");this.can_be_drag=a.can_be_drag;
this.initClass()};CRMTableContact.prototype.initClass=function(){this.can_be_drag&&this.initDraggable()};CRMTableContact.prototype.initDraggable=function(){var a=this,b=d("#c-contacts-sidebar .js-segment-droparea"),c=d(".js-contacts-table .js-move-user");a.$wrapper.draggable({helper:function(){var e=[],f="";c.filter(".is-active").each(function(){var g=d(this).data("user-id");g&&e.push(g)});1>=e.length?(e.push(a.user_id),f=a.$wrapper.find(".userpic")[0].outerHTML,f='<div id="c-users-helper" data-user-ids="'+
e.join(",")+'">'+f+"</div>"):f='<div id="c-users-helper" data-user-ids="'+e.join(",")+'"><span class="indicator red">'+e.length+"</span></div>";return f},appendTo:"body",delay:200,cursorAt:{top:0,left:0},start:function(e,f){f.helper.addClass("is-clone");b.length&&b.addClass("c-drop-here")},stop:function(e,f){e=f.helper;var g=e.clone();g.insertAfter(e).fadeOut(270);setTimeout(function(){g.remove()},300);b.length&&b.removeClass("c-drop-here")}})};return CRMTableContact}(jQuery);var CRMContactsSidebar=function(d){CRMContactsSidebar=function(a){this.$wrapper=a.$wrapper;this.$segmentsLists=this.$wrapper.find(".c-segment-list");this.$add_new_segment_link=this.$wrapper.find(".c-create-new-segment");this.is_admin=a.is_admin;this.initClass()};CRMContactsSidebar.prototype.initClass=function(){this.initSortable();this.initAddLink();this.initAddNewSegmentLink();this.initHighlight();this.initSelectedLink();this.initArchivedToggles();this.initScrollTopOnClick()};CRMContactsSidebar.prototype.initSortable=
function(){function a(h){return h.find("> li").map(function(){var l=parseInt(d(this).data("id"),10);return 0<l?l:!1}).toArray()}function b(h,l){g&&(g.abort(),g=!1);g=d.post(h,l,function(){g=!1})}var c=this,e=d.crm.app_url+"?module=contact&action=sortSave",f,g=!1;c.$segmentsLists.each(function(){var h=d(this),l=h.data("shared")?1:0;!c.is_admin&&l||h.sortable({distance:10,items:"> li:not(.sort-disabled)",axis:"y",delay:200,tolerance:"pointer",start:function(k,m){f=m.item.index()},stop:function(k,m){m.item.removeAttr("style");
f!=m.item.index()&&(k=a(h),b(e,{segments:k,shared:l}))}})})};CRMContactsSidebar.prototype.initAddLink=function(){var a=!1,b=this.$wrapper.find(".js-add-link"),c=b.find(".icon16"),e=c.attr("class");b.on("click",function(){if(!a){a=!0;var f=d.crm.app_url+"?module=contact&action=add";c.attr("class","icon16 loading");d.post(f,{},function(g){new CRMDialog({html:g})}).always(function(){a=!1;c.attr("class",e)})}})};CRMContactsSidebar.prototype.initAddNewSegmentLink=function(){var a=this.$add_new_segment_link;
a.click(function(b){b.preventDefault();d.get(d.crm.app_url+"?module=contactSegment&action=edit").done(function(c){new CRMDialog({html:c})}).always(function(){a.find(".icon16").hide()})})};CRMContactsSidebar.prototype.updateItem=function(a,b){"segment"===a.type&&(a=this.$segmentsLists.find('li[data-id="'+a.info.id+'"]'),a.length&&(void 0!==b.name&&a.find(".name").text(b.name||""),void 0!==b.count&&a.find(".count").text(b.count||"")))};CRMContactsSidebar.prototype.initHighlight=function(a,b){var c=
d(".all-contacts-link");this.$wrapper.find('a[href^="'+d.crm.app_url+'"]').each(function(e,f){if(location.pathname==f.pathname)return e=d(f),f=e.closest("li"),f.length||(f=e),c.removeClass("selected"),f.addClass("selected"),!1;c.addClass("selected")})};CRMContactsSidebar.prototype.initSelectedLink=function(){var a=this;sessionStorage.getItem("selected_contacts")||sessionStorage.setItem("selected_contacts","[]");var b=this.$wrapper.find(".js-selected-contacts"),c=b.find(".count"),e=sessionStorage.getItem("selected_contacts");
if(e=JSON.parse(e).length)c.text(e),b.removeClass("js-selected-contacts-hidden");b.on("click",function(f){f.preventDefault();f=d.crm.app_url+"?module=contact&action=selected";var g=sessionStorage.getItem("selected_contacts");d.post(f,{selected_ids:g},function(h){h&&(history.pushState(null,null,d.crm.app_url+"contact/selected/"),d(document).find("#c-content-block").html(h),a.initHighlight())})})};CRMContactsSidebar.prototype.initArchivedToggles=function(){this.$segmentsLists.find(".c-archived-section").each(function(){function a(c){c?
b.addClass("is-shown"):b.removeClass("is-shown")}var b=d(this);b.on("click",".js-show-list",function(){a(!0)});b.on("click",".js-hide-list",function(){a(!1)})})};CRMContactsSidebar.prototype.initScrollTopOnClick=function(){this.$wrapper.on("click","a:not(.js-add-link)",function(){var a=d(this),b=!a.hasClass("js-stop-scroll");a.find(".icon16").attr("class","icon16 loading").attr("style","");b&&d(window).scrollTop(0)})};return CRMContactsSidebar}(jQuery);
CRMContactsSidebar.initCollapsibleSidebar=function(){$.each(["mylists-my","tags","vaults","responsibles","admin"],function(){1==localStorage.getItem("collapsible_sidebar_"+this)&&($("#collapsible-"+this).find(".collapsible").css({display:"none"}),$("#collapsible-"+this).find(".icon16").removeClass("darr").addClass("rarr"))});$(".c-contacts-sidebar").on("click",".collapse-handler",function(){var d=$(this).parents(".block").data("block"),a=$(this).parents(".block"),b=$(a).find(".icon16");a=$(a).find(".collapsible");
a.is(":visible")?($(a).css({display:"none"}),$(b).removeClass("darr").addClass("rarr"),localStorage.setItem("collapsible_sidebar_"+d,1)):($(a).css({display:""}),$(b).removeClass("rarr").addClass("darr"),localStorage.setItem("collapsible_sidebar_"+d,0))})};var CRMContactsOperations=function(d){CRMContactsOperations=function(a){this.$wrapper=a.$wrapper;this.$bar=this.$wrapper.find(".js-operations-wrapper");this.$list=this.$wrapper.find(".js-contacts-list");this.$list_header=this.$list.find(".c-list-header");this.$checkbox_all=this.$wrapper.find(".js-checkbox-all");this.$content=this.$wrapper.find("#js-content-block");this.$selected_link=this.$wrapper.find(".js-selected-contacts");this.$selected_count=this.$selected_link.find(".count");this.$remove_from_selected_list=
this.$bar.find('[data-id="remove_from_selected_list"]');this.page=a.page||1;this.limit=a.limit||30;this.total_items_at_page_count=this.getTotalItemsAtPage()||0;this.total_count=a.total_count||0;this.page_count=a.page_count||0;this.context=a.context||{};this.selected_page=d(document).find("#contact_selected_page").length;this.is_category_segment="segment"===this.context.type&&this.context.info&&"category"===this.context.info.type;this.view=a.view||"";this.sidebar=a.sidebar||null;this.checked_count=
0;this.is_shown=0<this.checked_count;this.is_checked_all=!1;this.initClass()};CRMContactsOperations.prototype.initClass=function(){this.initCheckboxAll();this.initOperations();this.initItemCheckbox();this.initElasticHeader();0<this.selected_page&&this.$remove_from_selected_list.show()};CRMContactsOperations.prototype.initCheckboxAll=function(){var a=this;a.$checkbox_all.click(function(){var b=d(this),c=b.is(":checked");0<a.checked_count?a.unselectAll():(b.prop("checked",c),c?a.selectAll():a.unselectAll());
a.formBar();a.showOrHideBar()})};CRMContactsOperations.prototype.initOperations=function(){var a=this;a.$bar.on("click",".crm-operation-link",function(b){b.preventDefault();switch(d(this).data("id")){case "add_to_segments":a.addToSegmentsOperation();break;case "export":a.exportOperation();break;case "merge":a.mergeOperation();break;case "delete":a.deleteOperation();break;case "exclude_from_list":a.excludeFromListOperation();break;case "assign_tags":a.assignTagsOperation();break;case "assign_responsible":a.assignResponsibleOperation();
break;case "remove_from_selected_list":a.removeFromSelectedListOperation()}})};CRMContactsOperations.prototype.showBar=function(){this.is_shown||(this.$bar.addClass("is-shown"),this.$list_header.removeClass("is-shown"),this.is_shown=!0)};CRMContactsOperations.prototype.hideBar=function(){this.is_shown&&(this.$bar.removeClass("is-shown"),this.$list_header.addClass("is-shown"),this.is_shown=!1)};CRMContactsOperations.prototype.updateBarCount=function(){this.$bar.find(".crm-count").text("("+this.checked_count+
")")};CRMContactsOperations.prototype.showOrHideBar=function(){0<this.checked_count?(this.showBar(),this.updateBarCount()):this.hideBar()};CRMContactsOperations.prototype.getSelectedContactList=function(){var a=sessionStorage.getItem("selected_contacts");return a?JSON.parse(a):null};CRMContactsOperations.prototype.setSelectedContacts=function(){this.getSelectedContactList()||sessionStorage.setItem("selected_contacts","[]");if(!(0<this.selected_page)){var a=this.getSelectedContactList(),b=this.getSelectedContactIds();
d.each(b,function(c,e){0>d.inArray(e,a)&&(a[a.length]=e)});sessionStorage.setItem("selected_contacts",JSON.stringify(a));this.showOrHideSelectedLink()}};CRMContactsOperations.prototype.delSelectedContact=function(a){var b=this.getSelectedContactList();a=b.indexOf(a);b.splice(a,1);sessionStorage.setItem("selected_contacts",JSON.stringify(b));this.showOrHideSelectedLink()};CRMContactsOperations.prototype.updateSelectedCount=function(){var a=this.getSelectedContactList().length;this.$selected_count.text(a)};
CRMContactsOperations.prototype.showOrHideSelectedLink=function(){this.updateSelectedCount();this.getSelectedContactList().length?this.showSelectedLink():this.hideSelectedLink()};CRMContactsOperations.prototype.showSelectedLink=function(){this.$selected_link.removeClass("js-selected-contacts-hidden")};CRMContactsOperations.prototype.hideSelectedLink=function(){this.$selected_link.addClass("js-selected-contacts-hidden")};CRMContactsOperations.prototype.getSelectedContactIds=function(){return this.$list.find(".c-checkbox :checkbox:checked").map(function(){return d(this).val()}).toArray()};
CRMContactsOperations.prototype.getTotalItemsAtPage=function(){return this.page*this.limit>this.total_count?this.total_count%this.limit:this.limit};CRMContactsOperations.prototype.formBar=function(){var a=this.$bar.find('.crm-operation-li[data-id="merge"]'),b=this.$bar.find('.crm-operation-li[data-id="delete"]'),c=this.$bar.find('.crm-operation-li[data-id="assign_responsible"]'),e=this.$bar.find('.crm-operation-li[data-id="exclude_from_list"]');1>=this.checked_count||this.checked_count>this.page_count?
a.hide():a.show();this.checked_count>this.page_count?b.hide():b.show();this.checked_count>this.page_count?c.hide():c.show();this.is_category_segment&&this.context.can_edit?e.show():e.hide()};CRMContactsOperations.prototype.initItemCheckbox=function(){function a(c){var e=c.find(".js-checkbox"),f=e.is(":checked");e=e.val();f?c.addClass("is-active"):c.removeClass("is-active");b.is_checked_all?(b.is_checked_all=!1,b.checked_count=b.$list.find(".c-checkbox :checkbox:checked").length):f?b.checked_count+=
1:--b.checked_count;b.formBar();b.showOrHideBar();b.showOrHideSelectedLink();0<b.selected_page||(f?b.setSelectedContacts():b.delSelectedContact(e))}var b=this;b.$list.on("change",".js-checkbox",function(c,e){c=d(this);var f=c.closest(".js-contact-wrapper");"undefined"!==typeof e&&c.attr("checked",e);a(f);0<b.checked_count?b.checked_count<b.limit&&b.checked_count!==b.total_items_at_page_count?b.$checkbox_all.prop("indeterminate",!0):b.$checkbox_all.prop("indeterminate",!1).prop("checked",!0):b.$checkbox_all.prop("indeterminate",
!1).prop("checked",!1)});b.$list.on("click",".js-contact-wrapper",function(c){var e=d(c.target);c=!(!e.is("a")&&!e.closest("a").length);e=e.is(":checkbox");c||(c=d(this),e||(c=c.find(".js-checkbox"),c.trigger("change",[!c.is(":checked")])))});b.$list.shiftSelectable({selector:".js-contact-wrapper",behavior_type:"thumbs"===b.view?"mixed":"vertical",onSelect:function(c,e){var f=d(e.target);f=!(!f.is("a")&&!f.closest("a").length);var g=e.extra.is_first;e=e.extra.is_last;f||g||e||(c.find(".js-checkbox").attr("checked",
!0),a(c))}})};CRMContactsOperations.prototype.removeFromSelectedListOperation=function(){var a=this,b=a.$list.find(".c-checkbox :checkbox:checked");d.each(b,function(){a.delSelectedContact(this.value);d(this).parents(".js-contact-wrapper").remove()});a.$checkbox_all.prop("checked",!1);a.checked_count=0;a.is_checked_all=!1;a.showOrHideBar();a.getSelectedContactList().length||(b=a.$wrapper.find(".js-header-table-wrapper"),a.$wrapper.find(".c-no-contacts").removeClass("hidden"),b.remove())};CRMContactsOperations.prototype.selectAll=
function(){this.$list.find(".c-checkbox :checkbox").prop("checked",!0).trigger("change",[!0]);this.checked_count=this.total_count;this.is_checked_all=!0;this.setSelectedContacts()};CRMContactsOperations.prototype.unselectAll=function(){this.$list.find(".c-checkbox :checkbox").prop("checked",!1).trigger("change",[!1]);this.$checkbox_all.prop("checked",!1);this.checked_count=0;this.is_checked_all=!1};CRMContactsOperations.prototype.getSelectedContext=function(){var a=d.extend({total_count:this.total_count,
page_count:this.page_count,checked_count:this.checked_count,is_checked_all:this.is_checked_all?1:0,contact_ids:null},this.context);a.is_checked_all||(a.contact_ids=this.getSelectedContactIds());return a};CRMContactsOperations.prototype.addToSegmentsOperation=function(){var a=this;d.get(d.crm.app_url+"?module=contactOperation&action=addToSegments",function(b){new CRMDialog({html:b,onOpen:function(c){new CRMContactsOperationAddToSegments({$wrapper:c,context:a.getSelectedContext(),sidebar:a.sidebar})}})})};
CRMContactsOperations.prototype.exportOperation=function(){var a=this,b=d.crm.app_url+"?module=contactOperation&action=export",c=a.getSelectedContext().checked_count;d.get(b,{checked_count:c},function(e){var f=null;new CRMDialog({html:e,esc:!1,onOpen:function(g){f=new CRMContactsOperationExport({$wrapper:g,context:a.getSelectedContext()})},onClose:function(){f&&f.cancel()}})})};CRMContactsOperations.prototype.mergeOperation=function(){if(!(1>=this.checked_count||this.checked_count>this.page_count)){var a=
this.getSelectedContactIds().join(",");d.crm.content.load(d.crm.app_url+"contact/merge/?ids="+a)}};CRMContactsOperations.prototype.deleteOperation=function(){if(!(this.checked_count>this.page_count)){var a=d.crm.app_url+"?module=contactOperation&action=delete",b=this.$wrapper,c=this.getSelectedContext();b=b.find(".crm-contact-operation-delete-checking").clone();new CRMDialog({html:b.show(),onOpen:function(e){var f=this;e.find(".crm-cancel").click(function(){f.close()});d.get(a,c,function(g){new CRMDialog({html:g,
onOpen:function(){f.close()}})})}})}};CRMContactsOperations.prototype.excludeFromListOperation=function(){var a=this;if(a.is_category_segment){var b=d.crm.app_url+"?module=contactOperation&action=excludeFromSegment",c=a.getSelectedContext();d.get(b,{id:a.context.info.id,checked_count:c.checked_count},function(e){new CRMDialog({html:e,onOpen:function(f){new CRMContactsOperationExcludeFromSegment({$wrapper:f,segment:a.context.info,context:a.getSelectedContext(),sidebar:a.sidebar})}})})}};CRMContactsOperations.prototype.assignTagsOperation=
function(){var a=d.crm.app_url+"?module=contactOperation&action=assignTags",b=d.extend({},this.getSelectedContext(),!0);b.is_checked_all||1!=b.checked_count||(a+="&is_assign=1");d.post(a,b,function(c){new CRMDialog({html:c})})};CRMContactsOperations.prototype.assignResponsibleOperation=function(){var a=d.crm.app_url+"?module=contactOperation&action=assignResponsible",b=d.extend({},this.getSelectedContext(),!0);d.post(a,b,function(c){new CRMDialog({html:c})})};CRMContactsOperations.prototype.initElasticHeader=
function(){function a(){if(d.contains(document,g[0])){var m=e.scrollTop()>h.top,n=c.$content.height()>e.height();m&&n?(g.addClass("is-fixed").css({left:h.left,width:l}),k=!0):(g.removeClass("is-fixed").removeAttr("style"),k=!1)}else e.off("scroll",a)}function b(){d.contains(document,g[0])?(l=f.outerWidth(),k&&g.width(l)):e.off("resize",b)}var c=this,e=d(window),f=c.$wrapper.find(".js-contacts-section"),g=c.$bar,h=f.offset(),l=g.outerWidth(),k=!1;e.on("scroll",a).on("resize",b)};return CRMContactsOperations}(jQuery);var CRMContactsOperationAddToSegments=function(d){CRMContactsOperationAddToSegments=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".js-save");this.$add_new_link=this.$wrapper.find(".crm-add-new-segment-link");this.context=a.context||{};this.dialog=this.$wrapper.data("dialog");this.url=d.crm.app_url+"?module=contactOperation&action=addToSegments";this.is_assign=a.is_assign?1:0;this.onSave=a.onSave||null;this.sidebar=a.sidebar||null;this.initClass()};CRMContactsOperationAddToSegments.prototype.initClass=
function(){this.is_assign||this.initButton();this.initSave();this.initAddNewLink()};CRMContactsOperationAddToSegments.prototype.initButton=function(){var a=this,b=function(){0<a.$wrapper.find('[name="segment[]"]:checked').length?a.$button.attr("disabled",!1):a.$button.attr("disabled",!0)};a.$wrapper.on("click",'[name="segment[]"]',b);b()};CRMContactsOperationAddToSegments.prototype.initSave=function(){var a=this,b=a.$button,c=a.$wrapper.find(".crm-loading"),e=d.crm.app_url+"?module=contactOperation&action=addToSegmentsProcess",
f=[],g=d.extend({},a.context,!0);g.is_assign=a.is_assign?1:0;var h=function(k){c.hide();b.attr("disabled",!1);a.sidebar&&d.each(k.segments||{},function(m,n){a.sidebar.updateItem({type:"segment",info:{id:n.id}},n)});g.is_assign?d.crm.content.reload():1==f.length?d.crm.content.load(d.crm.app_url+"contact/segment/"+f[0]+"/"):d.crm.content.load(d.crm.app_url)},l=function(k){k=d.extend({offset:k||0},g);d.post(e,k).done(function(m){"ok"==m.status&&(m.data.done?h(m.data):l(m.data.offset||0))})};b.click(function(k){k.preventDefault();
c.show();b.attr("disabled",!0);f=a.$wrapper.find('[name="segment[]"]:checked').map(function(){return d(this).val()}).toArray();g=d.extend({segment_ids:f},g);a.onSave&&!1===a.onSave(g,a.$wrapper)||l()})};CRMContactsOperationAddToSegments.prototype.reloadDialog=function(a){var b=this;d.get(b.url,function(c){b.dialog=new CRMDialog({html:c,onOpen:function(e){a&&a(e);new CRMContactsOperationAddToSegments({$wrapper:e,context:b.context,sidebar:b.sidebar,onSave:b.onSave})}})})};CRMContactsOperationAddToSegments.prototype.initAddNewLink=
function(){var a=this;a.$add_new_link.click(function(b){b.preventDefault();a.$wrapper.find(".crm-add-new-segment-loading").show();d.get(d.crm.app_url+"?module=contactSegment&action=edit").done(function(c){a.dialog.close();var e=new CRMDialog({html:c,onOpen:function(f){f.find(".js-close-dialog").hide();f.find(".crm-cancel-link").show().click(function(){f.find(".crm-cancel-loading").show();a.reloadDialog(function(){e.close()})})},options:{afterSave:function(f){a.reloadDialog(function(g){e.close();f.data.segment&&
g.find('input[name="segment[]"][value="'+f.data.segment.id+'"]').prop("checked",!0)});return!1}}})})})};return CRMContactsOperationAddToSegments}(jQuery);var CRMContactsOperationExcludeFromSegment=function(d){CRMContactsOperationExcludeFromSegment=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".js-save");this.$add_new_link=this.$wrapper.find(".crm-add-new-segment-link");this.context=a.context||{};this.segment=a.segment||{};this.dialog=this.$wrapper.data("dialog");this.sidebar=a.sidebar||null;this.initClass()};CRMContactsOperationExcludeFromSegment.prototype.initClass=function(){this.initStartExclude()};CRMContactsOperationExcludeFromSegment.prototype.initStartExclude=
function(){var a=this,b=a.$button,c=d.crm.app_url+"?module=contactOperation&action=excludeFromSegmentProcess",e=a.$wrapper.find(".crm-loading"),f=d.extend({},a.context);f.segment_id=a.segment.id;var g=function(h,l){h=d.extend({offset:h||0,process_count:l||0},f);d.post(c,h).done(function(k){"ok"==k.status&&(k.data.done?(k=k.data,e.hide(),b.attr("disabled",!1),a.segment=k.segment,a.sidebar.updateItem({type:"segment",info:{id:a.segment.id}},a.segment),a.dialog.close(),d.crm.content.load(d.crm.app_url+
"contact/segment/"+a.segment.id+"/")):g(k.data.offset,k.data.process_count))})};b.click(function(h){h.preventDefault();e.show();b.attr("disabled",!0);g()})};return CRMContactsOperationExcludeFromSegment}(jQuery);var CRMContactsOperationExport=function(d){CRMContactsOperationExport=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".js-save");this.$cancel=this.$wrapper.find(".crm-js-cancel");this.$download_file_form=this.$wrapper.find(".crm-download-file-form");this.context=a.context||{};this.url=d.crm.app_url+"?module=contactOperationExport&action=process";this.dialog=this.$wrapper.data("dialog");this.currentProcess=null;this.initClass()};CRMContactsOperationExport.prototype.initClass=
function(){this.initStartExport()};CRMContactsOperationExport.prototype.initStartExport=function(){var a=this,b=a.$button,c=a.$cancel;b.click(function(e){e.preventDefault();b.attr("disabled",!0);a.currentProcess=a.process()});c.click(function(e){e.preventDefault();a.currentProcess&&a.currentProcess.cancel()});a.dialog.onCancel=function(){a.currentProcess&&a.currentProcess.cancel()}};CRMContactsOperationExport.prototype.cancel=function(){this.currentProcess&&this.currentProcess.cancel()};CRMContactsOperationExport.prototype.process=
function(){var a=this,b=a.url,c=a.$wrapper,e=c.find(".js-export-contacts-progressbar").find(".js-export-contacts-progressbar-progress"),f=c.find(".js-current-progress-txt"),g=null,h=null,l=0,k=d.extend({},a.context,!0);k.separator=c.find("[name=separator]").val();k.encoding=c.find("[name=encoding]").val();k.export_fields_name=c.find("[name=export_fields_name]").is(":checked")?1:0;k.not_export_empty_columns=c.find("[name=not_export_empty_columns]").is(":checked")?1:0;var m=function(p,q){0>=p?p=0:100<=
p&&(p=100);q?(e.stop(),e.clearQueue(),e.animate({width:""+Math.round(p)+"%"},{duration:250,queue:!0})):e.css({width:p});100>p?f.text(Math.round(100*p/100)+"%"):f.html('<span>100% <i class="icon16 yes"></i></span>')},n=function(){h&&clearTimeout(h);h=setTimeout(n,3200);!g||2<=l||(k.processId=g,d.post(b,k,function(p){l--;if(g&&p.ready){if(p=g)h&&clearTimeout(h),g=h=null,a.$download_file_form.attr("action",d.crm.app_url+"?module=contactOperationExport&action=process&processId="+p).appendTo("body").submit(function(){setTimeout(function(){a.$download_file_form.appendTo(a.$wrapper.find(".crm-dialog-content"));
a.dialog.close()},200)}).submit()}else p.progress&&m(p.progress,!0)},"json"),l++)};a.$wrapper.find(".crm-start-block").hide();a.$wrapper.find(".crm-process-block").show();m(0,!1);d.post(b,k,function(p){p.processId||alert("Error processing request.");g=p.processId;n()},"json");return{cancel:function(){h&&clearTimeout(h);d.post(b,{processId:g,ready:1})}}};return CRMContactsOperationExport}(jQuery);var CRMContactsOperationAssignTags=function(d){CRMContactsOperationAssignTags=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".js-save");this.$input=this.$wrapper.find(".crm-tags-input");this.context=a.context||{};this.dialog=this.$wrapper.data("dialog");this.default_text=this.$input.attr("placeholder");this.is_assign=a.is_assign||!1;this.initClass()};CRMContactsOperationAssignTags.prototype.initClass=function(){this.initTagsInput();this.initPopularTags();this.initSave()};CRMContactsOperationAssignTags.prototype.initTagsInput=
function(){var a=d.crm.app_url+"?module=contact&action=tags";this.$input.tagsInput({defaultText:this.default_text,width:this.$wrapper.find(".crm-dialog-content").width()-16,autocomplete_url:"",autocomplete:{html:!0,source:function(b,c){d.getJSON(a,{term:b.term},function(e){"ok"===e.status?c(e.data.tags||[]):c([])})}}})};CRMContactsOperationAssignTags.prototype.initPopularTags=function(){var a=this.$input;this.$wrapper.find(".crm-popular-tags").find(".crm-popular-tag-item-link").click(function(){var b=
d(this);b=d.trim(b.text());a.removeTag(b);a.addTag(b)})};CRMContactsOperationAssignTags.prototype.initSave=function(){var a=this,b=a.$button,c=a.$input,e=d.crm.app_url+"?module=contactOperation&action=assignTagsProcess",f=d.extend({},a.context,!0),g=a.$wrapper.find(".crm-loading");b.click(function(h){h.preventDefault();g.show();b.attr("disabled",!0);h=d("#"+c.attr("id")+"_tag");(h=d.trim(h.val()))&&h!==a.default_text&&c.addTag(h);f.tags=d.trim(c.val());f.is_assign=a.is_assign?1:0;var l=function(k){k=
d.extend({offset:k||0},f);d.post(e,k).done(function(m){"ok"==m.status&&(m.data.done?(g.hide(),b.attr("disabled",!1),d.crm.content.reload()):l(m.data.offset||0))})};l()})};return CRMContactsOperationAssignTags}(jQuery);var CRMContactsOperationAssignResponsible=function(d){CRMContactsOperationAssignResponsible=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$responsibleList=this.$wrapper.find(".js-responsible-list");this.$submitButton=this.$wrapper.find(".js-save");this.$close_dialog=a.Close_dialog;this.$errorh1=a.Error_h1;this.dialog=this.$wrapper.data("dialog");this.responsible_template_html=a.responsible_template_html;this.initClass()};CRMContactsOperationAssignResponsible.prototype.initClass=
function(){var a=this;a.$wrapper.on("change","input",function(){a.toggleButton(!0)});a.initSubmit();a.initAutocomplete()};CRMContactsOperationAssignResponsible.prototype.initSubmit=function(){function a(){if(!e){e=!0;var f=d.crm.app_url+"?module=contactOperation&action=assignResponsibleProcess",g=b();if(!g)return e=!1;var h=d('<i class="icon16 loading" style="vertical-align: middle; margin: 0;"></i>');h.appendTo(c.$submitButton.parent());c.$submitButton.attr("disabled",!0);var l=d("#responsible_id").val(),
k=l?d.crm.app_url+"contact/responsible/"+l+"/":d.crm.app_url+"contact/";d.post(f,g,function(m){"ok"===m.data.result?d.crm.content.reload().then(function(){c.dialog.close();d.crm.content.load(k)}):"no_vault_access"===m.data.result&&(d(".crm-dialog-header h1").html(c.$errorh1),d(".crm-dialog-content p, .js-responsible-list").html(""),d(".crm-dialog-footer").html('<a class="button js-close-dialog" href="javascript:void(0);">'+c.$close_dialog+"</a>"),d(".no-access-error").html(m.data.message),d.each(m.data.users,
function(n,p){d(".no-access-users").append('<a href="'+p.id+'" style="display: block; margin-top: 10px;"><i class="icon16 userpic20" style="background-image: url('+p.photo+');"></i><span>'+p.name+"</span></a>")}))},"json").always(function(){c.$submitButton.attr("disabled",!1);c.toggleButton(!1);h.remove();e=!1})}}function b(){var f=d("#responsible_id").val();return{contact_ids:d("#contact_ids").val(),responsible_id:f}}var c=this,e=!1;c.$form.on("submit",function(f){f.preventDefault();a()})};CRMContactsOperationAssignResponsible.prototype.initAutocomplete=
function(){function a(e){e.addClass("highlighted");setTimeout(function(){e.removeClass("highlighted")},2E3)}var b=this,c=b.$responsibleList.find(".js-autocomplete");c.autocomplete({source:d.crm.app_url+"?module=autocomplete&type=user",appendTo:b.$wrapper,minLength:0,focus:function(){return!1},select:function(e,f){e=b.$responsibleList.find('.c-responsible[data-id="'+f.item.id+'"]');e=e.length?e:void 0;if(!e){f=f.item;var g=b.responsible_template_html;e=f.photo_url;g=g.replace(/%id%/,f.id);var h=g.replace;
var l=f.name;l=d("<div></div>").text(l).html();g=h.call(g,"%name%",l).replace("%photo_url%",e);d("#responsible_id").val(f.id);f=d(g);b.$responsibleList.append(f);d(".js-input").css("display","none");b.$submitButton.attr("disabled",!1);b.toggleButton(!0);e=f}a(e);b.toggleButton(!0);c.val("");return!1}}).data("ui-autocomplete")._renderItem=function(e,f){return d('<li class="ui-menu-item-html"><div>'+f.value+"</div></li>").appendTo(e)};c.on("focus",function(){c.data("uiAutocomplete").search(c.val())});
b.$responsibleList.on("click",".js-delete-responsible",function(){d(this).closest(".c-responsible").remove();d("#responsible_id").val("");d(".js-input").css("display","");d(".js-autocomplete").focus();b.$submitButton.attr("disabled",!0);b.toggleButton(!0)})};CRMContactsOperationAssignResponsible.prototype.toggleButton=function(a){var b=this.$submitButton;a?b.removeClass("green").addClass("yellow"):b.removeClass("yellow").addClass("green")};return CRMContactsOperationAssignResponsible}(jQuery);var CRMContactsOperationDelete=function(d){CRMContactsOperationDelete=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".crm-delete");this.context=a.context||{};this.dialog=this.$wrapper.data("dialog");this.is_contact_page=a.is_contact_page||0;this.initClass()};CRMContactsOperationDelete.prototype.initClass=function(){this.initStartDelete()};CRMContactsOperationDelete.prototype.initStartDelete=function(){var a=this,b=a.$button,c=d(".crm-loading",a.$wrapper),e=d.crm.app_url+"?module=contactOperation&action=deleteProcess",
f=d.extend({},a.context,!0);b.click(function(g){g.preventDefault();c.show();b.attr("disabled",!0);d.post(e,f).done(function(h){a.dialog.close();"ok"===h.status&&(a.is_contact_page?d.crm.content.load(d.crm.app_url+"contact/"):d.crm.content.reload(),d.crm.sidebar.reload())}).always(function(){c.hide();b.attr("disabled",!1)})})};return CRMContactsOperationDelete}(jQuery);var CRMContactSegmentEdit=function(d){CRMContactSegmentEdit=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$button=this.$form.find(":submit");this.$icons_block=this.$wrapper.find(".crm-icons-block");this.$icon_input=this.$wrapper.find("[name=icon]");this.segment=a.segment||{};this.messages=a.messages||{};this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMContactSegmentEdit.prototype.initClass=function(){this.$wrapper.find(".crm-name-input").focus();this.initIcons();
this.initSubmit();this.bindEvents();0<this.segment.id&&this.initDeleteLink()};CRMContactSegmentEdit.prototype.initIcons=function(){var a=this;a.$icons_block.on("click","li a",function(b){b.preventDefault();b=d(this).closest("li");var c=b.data("icon");a.$icons_block.find("li.selected").removeClass("selected");a.$icon_input.val(c);b.addClass("selected");a.clearValidateErrors()})};CRMContactSegmentEdit.prototype.bindEvents=function(){var a=this,b=a.$form,c=null;b.on("change",":input",function(){a.clearValidateErrors()});
b.on("keyup",":input",function(){c&&clearTimeout(c);c=setTimeout(function(){a.clearValidateErrors()},200)})};CRMContactSegmentEdit.prototype.showValidateErrors=function(a){var b=this.$form;d.each(a||{},function(c,e){b.find(':input[name="'+c+'"]').addClass("error").after('<em class="errormsg">'+e+"</em>")})};CRMContactSegmentEdit.prototype.clearValidateErrors=function(){var a=this.$form;a.find(".error").removeClass("error");a.find(".errormsg").remove()};CRMContactSegmentEdit.prototype.initSubmit=function(){var a=
this,b=a.$form,c=b.find(".crm-loading"),e=a.$button;b.submit(function(f){f.preventDefault();a.clearValidateErrors();e.attr("disabled",!0);c.show();d.post(b.attr("action"),b.serialize()).done(function(g){if("ok"!==g.status)e.attr("disabled",!1),c.hide(),a.showValidateErrors(g.errors||{});else if(!a.dialog.options.afterSave||!1!==a.dialog.options.afterSave(g))a:if(g.data.segment){var h="search"==a.segment.type,l="category"===g.data.segment.type?"category":"search",k=g.data.segment.id;if(0>=a.segment.id){if("search"===
l&&!h){d.crm.content.load(d.crm.app_url+"contact/search/segment/"+g.data.segment.id+"/");break a}d.crm.storage.set("crm/create/category",{id:k,timestamp:+new Date})}d.crm.content.load(d.crm.app_url+"contact/segment/"+g.data.segment.id+"/")}})})};CRMContactSegmentEdit.prototype.initDeleteLink=function(){var a=this,b=a.$wrapper.find(".crm-delete-link"),c=null,e=d.crm.app_url+"?module=dialogConfirm",f=null,g=d.crm.app_url+"?module=contactSegment&action=delete";b.click(function(h){h.preventDefault();
c&&c.abort();c=d.post(e,{title:a.messages.delete_confirm_title,text:a.messages.delete_confirm_text,ok_button:a.messages.delete_button}).done(function(l){a.dialog.close();new CRMDialog({html:l,onConfirm:function(){f&&f.abort();f=d.post(g,{id:a.segment.id}).done(function(k){"ok"===k.status&&d.crm.content.load(d.crm.app_url+"contact/")}).always(function(){f=null});return!1}})}).always(function(){c=null})})};return CRMContactSegmentEdit}(jQuery);var CRMContactSegmentAddContacts=function(d){CRMContactSegmentAddContacts=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$button=this.$form.find(".js-submit-button");this.$find_contact=this.$wrapper.find(".js-find-contact");this.$contact_list=this.$wrapper.find(".c-contact-list");this.segment=a.segment||{};this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMContactSegmentAddContacts.prototype.initClass=function(){this.initAutocomplete();this.initDeleteLinks();
this.initSubmit()};CRMContactSegmentAddContacts.prototype.initAutocomplete=function(){var a=this.$find_contact,b=this.$contact_list,c=b.find(".is-template");a.focus();a.autocomplete({source:"?module=autocomplete",minLength:2,focus:function(){return!1},select:function(e,f){e=c.clone().removeClass("is-template");e.find(".c-contact-id").val(f.item.id);e.find(".c-contact-name").text(f.item.name);e.find(".c-contact-icon").css("backgroundImage","url("+f.item.photo_url+")");b.append(e.show());a.val("");
return!1}}).data("ui-autocomplete")._renderItem=function(e,f){return d("<li />").addClass("ui-menu-item-html").append("<div>"+f.value+"</div>").appendTo(e)}};CRMContactSegmentAddContacts.prototype.initDeleteLinks=function(){this.$wrapper.on("click",".c-contact-delete-link",function(a){a.preventDefault();d(this).closest(".c-contact-item").remove()})};CRMContactSegmentAddContacts.prototype.initSubmit=function(){var a=this,b=a.$form,c=a.$button,e=b.find(".c-loading");b.submit(function(f){f.preventDefault();
e.show();c.prop("disabled",!0);d.post(b.attr("action"),b.serialize()).done(function(g){"ok"==g.status&&d.crm.content.load(d.crm.app_url+"contact/segment/"+a.segment.id+"/")}).always(function(){e.hide();c.prop("disabled",!1);a.dialog.close()})})};return CRMContactSegmentAddContacts}(jQuery);var CRMContactEditForm=function(d){CRMContactEditForm=function(a){this.$wrapper=a.$wrapper;this.$phoneList=this.$wrapper.find(".js-phone-list");this.$emailList=this.$wrapper.find(".js-email-list");this.phone_template_html=a.phone_template_html;this.email_template_html=a.email_template_html;this.initClass()};CRMContactEditForm.prototype.initClass=function(){this.initAddPhone();this.initAddEmail();this.initCompanyAutocomplete()};CRMContactEditForm.prototype.initAddPhone=function(){function a(e,f){e.preventDefault();
e=d(b.phone_template_html);f&&(e.find(".js-value").val(f.number).trigger("change"),e.find(".js-ext").val(f.ext).trigger("change"));c.append(e)}var b=this,c=b.$phoneList;b.$wrapper.on("click",".js-add-phone",a);b.$wrapper.on("click",".js-remove-phone",function(e){e.preventDefault();d(this).closest("li").remove()});d(document).on("addContactPhone",function(e,f){a(e,f)})};CRMContactEditForm.prototype.initAddEmail=function(){function a(e,f){e.preventDefault();e=d(b.email_template_html);f&&(e.find(".js-value").val(f.name).trigger("change"),
e.find(".js-ext").val(f.ext).trigger("change"));c.append(e)}var b=this,c=b.$emailList;b.$wrapper.on("click",".js-add-email",a);b.$wrapper.on("click",".js-remove-email",function(e){e.preventDefault();d(this).closest("li").remove()});d(document).on("addContactEmail",function(e,f){a(e,f)})};CRMContactEditForm.prototype.initCompanyAutocomplete=function(){var a=this.$wrapper.find('[name="contact[company]"]'),b=this.$wrapper.find('[name="contact[company_contact_id]"]');a.length&&(a.autocomplete({appendTo:this.$wrapper,
source:"?module=autocomplete&type=company",minLength:2,focus:function(){return!1},select:function(c,e){c=d("<div />").text(e.item.name).text();a.val(c);b.val(0<e.item.id?e.item.id:"");return!1},search:function(){b.val("")}}).data("ui-autocomplete")._renderItem=function(c,e){return d("<li />").addClass("ui-menu-item-html").append("<div>"+e.value+"</div>").appendTo(c)})};return CRMContactEditForm}(jQuery),CRMContactAddDialog=function(d){CRMContactAddDialog=function(a){this.$wrapper=a.$wrapper;this.contact_id=
a.contact_id;this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMContactAddDialog.prototype.initClass=function(){this.$wrapper.find(".js-focus-field").focus();this.initToggle();this.initContactForm();this.initCompanyForm()};CRMContactAddDialog.prototype.initToggle=function(){var a=this,b=a.$wrapper.find(".js-content-toggle-wrapper"),c=b.find(".js-ibutton"),e=a.$wrapper.find(".js-toggle-content.is-selected");c.iButton({labelOn:"",labelOff:"",classContainer:"c-ibutton ibutton-container mini"});
c.on("change",function(){var f="checked"===c.attr("checked"),g=a.$wrapper.find('.js-toggle-content[data-content="'+(f?"company":"contact")+'"]');f?b.addClass("is-on"):b.removeClass("is-on");e.length&&e.removeClass("is-selected");g.length&&(e=g.addClass("is-selected"));a.$wrapper.find(".js-focus-field").focus();a.dialog.resize()})};CRMContactAddDialog.prototype.initContactForm=function(){function a(){var f=c.find(".js-phone-list"),g=c.find(".js-email-list");f.find("li .js-value, li .js-ext").removeAttr("name");
g.find("li .js-value, li .js-ext").removeAttr("name");var h=e.serializeArray(),l={data:[],errors:[]},k=["contact[firstname]","contact[middlename]","contact[lastname]","contact[name]"],m=!0;d.each(h,function(n,p){l.data.push({name:p.name,value:p.value});0<d.trim(p.value).length&&0<=k.indexOf(p.name)&&(m=!1)});m&&(l.errors.push({name:"contact[firstname]",value:"Name is empty"}),l.errors.push({name:"contact[name]",value:"Name is empty"}));f.find("li").each(function(n){var p=d(this),q=p.find(".js-value");
p=p.find(".js-ext");var r=q.val(),t=p.val();if(r){var u="contact[phone]["+n+"][value]";q.attr("name",u);l.data.push({name:u,value:r});n="contact[phone]["+n+"][ext]";p.attr("name",n);l.data.push({name:n,value:t})}});g.find("li").each(function(n){var p=d(this),q=p.find(".js-value");p=p.find(".js-ext");var r=q.val(),t=p.val();if(r){var u="contact[email]["+n+"][value]";q.attr("name",u);l.data.push({name:u,value:r});n="contact[email]["+n+"][ext]";p.attr("name",n);l.data.push({name:n,value:t})}});return l}
var b=this,c=b.$wrapper.find('.js-toggle-content[data-content="contact"]'),e=c.find("form");(function(){function f(k){d.post(b.contact_id?"?module=deal&action=contactUpdate":"?module=contact&action=save",k,function(m){"ok"==m.status?(b.dialog.close(),d.crm.content.load(d.crm.app_url+"contact/"+m.data.contact.id+"/")):m.errors&&g(m.errors)},"json").always(function(){l=!1})}function g(k){k=k?k:[];d.each(k,function(m,n){m=n.name;n=n.value;"name"===m&&(m="contact[firstname]");var p=e.find('[name="'+m+
'"]'),q=d("<span />").addClass("errormsg").text(n);p.length?p.hasClass("error")||(p.parent().append(q),p.addClass("error").one("focus click",function(){p.removeClass("error");q.remove()})):(h.append(q),e.one("submit",function(){q.remove()}))})}var h=b.$wrapper.find(".js-errors-place"),l=!1;e.on("submit",function(k){k.preventDefault();l||(l=!0,k=a(),k.errors.length?(g(k.errors),l=!1):f(k.data))})})();(function(){c.on("click",".js-extended-form",function(){var f=a(),g=[];g.push("extended=true");d.each(f.data,
function(h,l){(h=d.trim(l.value))&&g.push(l.name+"="+h)});f=d.crm.app_url+"contact/new/?"+g.join("&");d.crm.content.load(f)})})();a()};CRMContactAddDialog.prototype.initCompanyForm=function(){function a(){var f=c.find(".js-phone-list"),g=c.find(".js-email-list");f.find("li .js-value, li .js-ext").removeAttr("name");g.find("li .js-value, li .js-ext").removeAttr("name");var h=e.serializeArray(),l={data:[],errors:[]},k=["contact[firstname]","contact[middlename]","contact[lastname]","contact[name]"],
m=!0;d.each(h,function(n,p){l.data.push({name:p.name,value:p.value});0<d.trim(p.value).length&&0<=k.indexOf(p.name)&&(m=!1)});m&&(l.errors.push({name:"contact[firstname]",value:"Name is empty"}),l.errors.push({name:"contact[name]",value:"Name is empty"}));f.find("li").each(function(n){var p=d(this),q=p.find(".js-value");p=p.find(".js-ext");var r=q.val(),t=p.val();if(r){var u="contact[phone]["+n+"][value]";q.attr("name",u);l.data.push({name:u,value:r});n="contact[phone]["+n+"][ext]";p.attr("name",
n);l.data.push({name:n,value:t})}});g.find("li").each(function(n){var p=d(this),q=p.find(".js-value");p=p.find(".js-ext");var r=q.val(),t=p.val();if(r){var u="contact[email]["+n+"][value]";q.attr("name",u);l.data.push({name:u,value:r});n="contact[email]["+n+"][ext]";p.attr("name",n);l.data.push({name:n,value:t})}});return l}var b=this,c=b.$wrapper.find('.js-toggle-content[data-content="company"]'),e=c.find("form");(function(){function f(){var m={data:[],errors:[]},n=e.serializeArray();d.each(n,function(p,
q){q.value=d.trim(q.value);"contact[company]"===q.name&&m.data.push({name:"contact[name]",value:q.value});m.data.push(q)});n=c.find(".js-phone-list");n.find("li .js-value, li .js-ext").removeAttr("name");n.find("li").each(function(p){var q=d(this),r=q.find(".js-value");q=q.find(".js-ext");var t=r.val(),u=q.val();if(t){var v="contact[phone]["+p+"][value]";r.attr("name",v);m.data.push({name:v,value:t});p="contact[phone]["+p+"][ext]";q.attr("name",p);m.data.push({name:p,value:u})}});n=c.find(".js-email-list");
n.find("li .js-value, li .js-ext").removeAttr("name");n.find("li").each(function(p){var q=d(this),r=q.find(".js-value");q=q.find(".js-ext");var t=r.val(),u=q.val();if(t){var v="contact[email]["+p+"][value]";r.attr("name",v);m.data.push({name:v,value:t});p="contact[email]["+p+"][ext]";q.attr("name",p);m.data.push({name:p,value:u})}});m.data.push({name:"contact[is_company]",value:1});return m}function g(m){m=m?m:[];d.each(m,function(n,p){n=p.name;p=p.value;var q=c.find('[name="'+n+'"]');"contact[firstname]"!==
n||q.is(":visible")||(q=c.find(".js-contact-autocomplete"));var r=d("<span class='c-error' />").addClass("errormsg").text(p);q.length&&!q.hasClass("error")?(q.parent().append(r),q.addClass("error").one("focus click change",function(){q.removeClass("error");r.remove()})):(k.append(r),e.one("submit",function(){remove(r)}))})}function h(m){l||(l=!0,d.post(b.contact_id?"?module=deal&action=contactUpdate":"?module=contact&action=save",m,function(n){"ok"===n.status?(b.dialog.close(),d.crm.content.load(d.crm.app_url+
"contact/"+n.data.contact.id+"/")):n.errors&&g(n.errors)},"json").always(function(){l=!1}))}var l=!1,k=c.find(".js-errors-place");e.on("submit",function(m){m.preventDefault();m=f();m.errors.length?g(errors):h(m.data)})})();(function(){c.on("click",".js-extended-form",function(){var f=a(),g=[];g.push("extended=true");g.push("type=company");d.each(f.data,function(h,l){(h=d.trim(l.value))&&g.push(l.name+"="+h)});f=d.crm.app_url+"contact/new/?"+g.join("&");d.crm.content.load(f)})})()};return CRMContactAddDialog}(jQuery),
CRMDealParticipantAdd=function(d){CRMDealParticipantAdd=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$content=this.$wrapper.find(".crm-dialog-content");this.dialog=this.$wrapper.data("dialog");this.deal_id=a.deal_id;this.initClass()};CRMDealParticipantAdd.prototype.initClass=function(){var a=this.$wrapper.find(".js-contact-autocomplete");a.length&&a.focus();this.initAddParticipant()};CRMDealParticipantAdd.prototype.initAddParticipant=function(){function a(f){function g(l){var k=
d('<div class="line errormsg" />').html(l);c.$content.append(k);c.$form.one("submit",function(){k.remove()})}if(f[0])d.each(f,function(l,k){g(k.value)});else{var h=Object.keys(f);d.each(h,function(l,k){g(f[k])})}}function b(f){e||(e=!0,d.post("?module=deal&action=addParticipantSave",f,function(g){"ok"==g.status?(c.dialog.options.onAdd(g.data.html),c.dialog.close()):g.errors&&a(g.errors)}).always(function(){e=!1}))}var c=this,e=!1;c.$form.on("submit",function(f){f.preventDefault();f=c.$form.serializeArray();
var g=[];g.length?a(g):b(f)})};return CRMDealParticipantAdd}(jQuery),CRMContactAddForm=function(d){CRMContactAddForm=function(a){this.$wrapper=a.$wrapper;this.$toggleW=this.$wrapper.find(".js-contact-view-toggle");this.initClass()};CRMContactAddForm.prototype.initClass=function(){this.initToggle();this.initContactAutocomplete();this.initCompanyAutocomplete()};CRMContactAddForm.prototype.initContactAutocomplete=function(){function a(m){if(0<m.id)e.val(m.name),g.val(m.id),b(m.data);else if(0>m.id){g.val("");
c.$toggleW.find(".js-show-fio").trigger("click",!0);f.val("");var n=0<=m.name.indexOf("@"),p=!!m.name.match(/^\+?\d/);n?c.$wrapper.find(".js-email-field").val(m.name).trigger("change"):p?c.$wrapper.find(".js-phone-field").val(m.name).trigger("change"):c.$wrapper.find(".js-firstname,.js-name").val(m.name).trigger("change")}}function b(m){d.each(h,function(n,p){n=m[p];var q="phone"===p||"email"===p,r;if(q){n="";for(r=(m[p]||[]).reverse();""==n&&0<r.length;)n=r.pop();d.isPlainObject(n)&&(n=n.value)}n=
d.trim(n||"");""!=n&&(p=q?c.$wrapper.find('[name="contact['+p+'][0][value]"]'):c.$wrapper.find('[name="contact['+p+']"]'),p.val(n))});f.attr("disabled",!0)}var c=this,e=c.$wrapper.find(".js-contact-autocomplete"),f=c.$wrapper.find(".js-field"),g=c.$wrapper.find(".js-contact-id-field"),h=["firstname","company","jobtitle","phone","email"],l="?module=autocomplete&add_new=true&join="+h.join(","),k=!1;e.autocomplete({appendTo:c.$wrapper,source:l,minLength:2,html:!0,focus:function(){return!1},select:function(m,
n){k=!0;a(n.item);e.blur();return!1},search:function(){g.val("")},open:function(){k=!1},change:function(){k||a({id:-1,name:e.val()})}}).data("ui-autocomplete")._renderItem=function(m,n){return d("<li />").addClass("ui-menu-item-html").append("<div>"+n.value+"</div>").appendTo(m)};e.on("keydown",function(m){13!==m.keyCode&&(f.attr("disabled",!1),f.val(""))})};CRMContactAddForm.prototype.initCompanyAutocomplete=function(){var a=this.$wrapper.find(".js-company-autocomplete"),b=this.$wrapper.find(".js-company-id-field");
if(!a.length||!b.length)return!1;a.autocomplete({appendTo:this.$wrapper,source:"?module=autocomplete&type=company",minLength:2,html:!0,focus:function(){return!1},select:function(c,e){a.val(e.item.name);b.val(e.item.id);return!1},search:function(){b.val("")}}).data("ui-autocomplete")._renderItem=function(c,e){return d("<li />").addClass("ui-menu-item-html").append("<div>"+e.value+"</div>").appendTo(c)}};CRMContactAddForm.prototype.initToggle=function(){var a=this,b=a.$toggleW,c=b.find(".is-active"),
e=a.$wrapper.find(".js-action-field"),f=a.$wrapper.find(".js-field"),g=a.$wrapper.find(".js-fio"),h=a.$wrapper.find(".js-combo-name");b.on("click",".c-toggle",function(l,k){l.preventDefault();k=!k;l=d(this);var m=l.data("mode");if(l.hasClass("is-active"))return!1;c.length&&c.removeClass("is-active");l.addClass("is-active");c=l;k&&a.$wrapper.find("input").val("").trigger("change");"fio"===m?(g.show(),h.hide(),e.val("new"),f.attr("disabled",!1)):(g.hide(),h.show(),e.val("search"));d(document).trigger("toggleChanged");
d(document).trigger("resizeDialog")})};return CRMContactAddForm}(jQuery),CRMCompanyAddForm=function(d){CRMCompanyAddForm=function(a){this.$wrapper=a.$wrapper;this.phone_template_html=a.phone_template_html;this.email_template_html=a.email_template_html;this.initClass()};CRMCompanyAddForm.prototype.initClass=function(){this.initAddPhone();this.initAddEmail()};CRMCompanyAddForm.prototype.initAddPhone=function(){var a=this,b=a.$wrapper.find(".js-phone-list");a.$wrapper.on("click",".js-add-phone",function(c){c.preventDefault();
c=d(a.phone_template_html);b.append(c)});a.$wrapper.on("click",".js-remove-phone",function(c){c.preventDefault();d(this).closest("li").remove()})};CRMCompanyAddForm.prototype.initAddEmail=function(){function a(e,f){e.preventDefault();e=d(b.email_template_html);f&&(e.find(".js-value").val(f.name).trigger("change"),e.find(".js-ext").val(f.ext).trigger("change"));c.append(e)}var b=this,c=b.$wrapper.find(".js-email-list");b.$wrapper.on("click",".js-add-email",a);b.$wrapper.on("click",".js-remove-email",
function(e){e.preventDefault();d(this).closest("li").remove()});d(document).on("addContactEmail",function(e,f){a(e,f)})};return CRMCompanyAddForm}(jQuery);var CRMContactImportPage=function(d){CRMContactImportPage=function(a){this.$wrapper=a.$wrapper;this.$iframe=this.$wrapper.find("iframe");this.initClass()};CRMContactImportPage.prototype.initClass=function(){this.initViewToggle();this.initSubmit()};CRMContactImportPage.prototype.initSubmit=function(){function a(f){f.on("change keydown","input, select, textarea",function(){f.find("input:submit").attr("disabled",!1)});f.on("submit",function(){f.find(".loading").show();e=!0})}var b=this,c=b.$iframe,e=
!1;b.$wrapper.find("form").each(function(){a(d(this))});c.on("load",function(){if(!e)return!1;var f=d(this).contents().find("body").html(),g=null;try{g=JSON.parse(f)}catch(h){}g&&g.errors?(b.$wrapper.find(".loading").hide(),alert(g.errors)):d.crm.content.load(d.crm.app_url+"contact/import/upload/")})};CRMContactImportPage.prototype.initViewToggle=function(){var a=this,b=a.$wrapper.find(".js-view-toggle"),c=b.find(".is-active");b.on("click",".c-toggle",function(e){e.preventDefault();e=d(this);var f=
e.data("content");if(e.hasClass("is-active"))return!1;c.length&&c.removeClass("is-active");e.addClass("is-active");c=e;a.$wrapper.find(".js-toggle-content.is-active").removeClass("is-active");e=a.$wrapper.find('.js-toggle-content[data-content="'+f+'"]');e.length&&e.addClass("is-active")})};return CRMContactImportPage}(jQuery);var crmContactImportUpload=function(d){var a=function(c){var e=c.$wrapper,f=e.find("form"),g=e.find(".crm-import-upload-table"),h=e.find(".crm-import-upload-button"),l=e.find(".crm-total-count-column .crm-count");this.$wrapper=e;this.$form=f;var k=c.fieldInfo,m=/[\s~!@#\$%\^&\*\(\)_\+\|\\=\-`\{\}:"<>\?\[\];',\.\/]+/g,n=function(t,u){t+=1;u?(g.find("td:nth-child("+t+")").addClass("crm-highlight-cell"),h.attr("disabled",!1)):g.find("td:nth-child("+t+")").removeClass("crm-highlight-cell")};d("select",
g).each(function(t){d(this).change(function(){n(t,d(this).val())})});var p=function(){d(this).is(":checked")?(g.find("tbody tr:first").removeClass("crm-ignored-row"),l.html((parseInt(l.html(),10)||0)+1)):(g.find("tbody tr:first").addClass("crm-ignored-row"),l.html(parseInt(l.html(),10)-1||""))};d("input[name='first_line']",f).change(p);var q=!1,r=g.find("select");g.find("tbody tr:first-child td").each(function(t,u){var v=null,w=0,x=!1;u=d(u).text().toLowerCase().replace(m,"");for(var y in k){var z=
k[y],A=!1,B=0,D=!1;y.length>w&&!x&&0==u.indexOf(y)&&(B=y.length,A=!0);var C=z.name.toLowerCase().replace(m,"");C&&C.length>w&&0==u.indexOf(C)&&(B=C.length,D=A=!0);if(A){C=A=null;if(z.fields){for(var F in z.fields){if(0<=u.indexOf(F)){A=F;B+=F.length;break}if(0<=u.indexOf(z.fields[F].name.toLowerCase().replace(m,""))){A=F;B+=z.fields[F].name.length;break}}if(!A)continue}if(z.ext)for(var E in z.ext){if(0<=u.indexOf(E)){C=E;break}if(0<=u.indexOf(z.ext[E].toLowerCase().replace(m,""))){C=E;break}}v=y+
(A?":"+A:"")+(C?"."+C:"");w=B;x=D}}v&&w&&(r.eq(t).val(v),n(t,!0),q=!0)});q&&p.call(f.find("input[name='first_line']").attr("checked",!1));this.initCreateDealsSettings();this.initAddToSegments();f.submit(function(t){t.preventDefault();t=e.find(".crm-warning-require-primary-fields").hide();var u=!1;g.find("select").each(function(){var v=d(this).val();if("firstname"==v||"lastname"==v||"company"==v||"email"==v.substr(0,5))return u=!0,!1});u?(e.find(".crm-loading").show(),(new b({$wrapper:e,need_validation:f.find("[name=validate]").is(":checked"),
messages:c.messages||{}})).run()):t.show()})};a.prototype.initCreateDealsSettings=function(){var c=this.$form,e=c.find('[name="create_deals"]'),f=c.find(".crm-deals-settings-wrapper"),g=c.find('[name="deal_funnel_id"]'),h=c.find('[name="deal_stage_id"]');e.click(function(){d(this).is(":checked")?f.show():f.hide()});g.change(function(){h.load("?module=contactImportUpload&action=stagesByFunnel&id="+d(this).val())})};a.prototype.initAddToSegments=function(){var c=this.$form;c.find('[name="add_to_segments"]').click(function(){d(this).is(":checked")?
d.get(d.crm.app_url+"?module=contactOperation&action=AddToSegments",function(e){new CRMDialog({html:e,onOpen:function(f){new CRMContactsOperationAddToSegments({$wrapper:f,onSave:function(g,h){var l=h.data("dialog"),k=[],m=[];h=d(".c-segment-item",h);for(var n=0;n<g.segment_ids.length;n+=1){var p=g.segment_ids[n],q=h.filter('[data-id="'+p+'"]');k.push(q.find(".c-name").text());m.push('<input type="hidden" name="segment_id[]" value="'+p+'">')}k="<span>"+k.join(",")+"</span>";m=m.join(" ");d(".c-add-to-segments-names",
c).html(k+m);l.close();return!1}})}})}):d(".c-add-to-segments-names",c).html("")})};var b=function(c){this.$wrapper=c.$wrapper;this.$form=this.$wrapper.find("form");this.processId=null;this.$loading=this.$wrapper.find(".crm-loading");this.timer=null;this.messages=c.messages||{};this.url=d.crm.app_url+"?module=contact&action=importProcess"+(c.need_validation?"&need_validation=1":"");this.$progress_bar_dialog=this.$wrapper.find(".crm-import-progressbar-dialog");this.$progress_bar=this.$progress_bar_dialog.find(".crm-progressbar")};
b.prototype.run=function(){var c=this,e=function(){d.get(c.url,{processid:c.processId,t:Math.random()},function(f){c.timer&&clearTimeout(c.timer);c.timer=null;var g=c.$progress_bar.find(".ui-progressbar-value");g.stop();g.clearQueue();f.ready?(c.processId=null,g.animate({width:"100%"},{duration:500,complete:function(){d.post(c.url,{processid:c.processId,file:1},"json");0<f.rowsRejected?0>=f.rowsAdded?alert(c.messages.no_imported):alert(c.messages.some_imported):alert(c.messages.all_imported);location.href=
0<f.rowsAdded?d.crm.app_url+"contact/import/result/"+f.timeStart+"/":d.crm.app_url+"contact/import/"},queue:!1})):(g.animate({width:""+Math.round(100*f.done/f.total)+"%"},{duration:500,queue:!1}),c.timer=setTimeout(e,3E3+400*(Math.random()-.5)))},"json")};d.post(c.url,c.$form.serializeArray(),function(f){c.processId=f.processId;c.processId&&(c.$progress_bar_dialog.show(),c.$progress_bar.progressbar({value:0}),e())},"json")};return a}(jQuery);var CRMContactsMergePage=function(d){CRMContactsMergePage=function(a){this.$wrapper=a.$wrapper;this.$table=this.$wrapper.find(".js-duplicates-table");this.$form=this.$wrapper.find("form");this.$merge_field=this.$wrapper.find(".crm-search-duplicates-by-field");this.$auto_merge_link=this.$wrapper.find(".crm-auto-merge-duplicates-link");this.$auto_merge_start_button=this.$wrapper.find(".crm-auto-merge-duplicates-start");this.$auto_merge_pause_button=this.$wrapper.find(".crm-auto-merge-duplicates-break");
this.$auto_merge_resume_button=this.$wrapper.find(".crm-auto-merge-duplicates-resume");this.is_admin=a.is_admin;this.groups_count=a.groups_count;this.messages=a.messages;this.initClass()};CRMContactsMergePage.prototype.initClass=function(){this.initSubmit();this.initMergeLinks();this.initAutoMerge()};CRMContactsMergePage.prototype.initSubmit=function(){var a=this;a.$form.submit(function(b){b.preventDefault();b=a.$merge_field.val();location.href=d.crm.app_url+"contact/merge/duplicates/?field="+b})};
CRMContactsMergePage.prototype.initMergeLinks=function(){var a=this.$wrapper,b=!1;a.on("click",".js-merge-button",function(c){c.preventDefault();var e=d(this),f=e.parent().find(".loading").css("opacity",1),g=a.find(".crm-search-duplicates-by-field").val();b||(b=!0,c=d.crm.app_url+"?module=contact&action=mergeDuplicatesGetContacts",e={field:g,value:e.attr("data-field-value")},d.post(c,e,function(h){"ok"==h.status&&h.data.contacts&&(d.crm.storage.set("crm/merge/field",g),h=d.crm.app_url+"contact/merge/?ids="+
h.data.contacts.join(","),d.crm.content.load(h))},"json").always(function(){f.css("opacity",0);b=!1}))})};CRMContactsMergePage.prototype.initAutoMerge=function(){var a=this,b=a.$wrapper,c=a.$merge_field,e=a.$wrapper.find(".crm-auto-merge-duplicates-start-text"),f=a.$wrapper.find(".crm-auto-merge-duplicates-progress"),g=a.$table,h=a.$auto_merge_start_button,l=a.$auto_merge_pause_button,k=a.$auto_merge_resume_button,m=null,n=!1;a.$auto_merge_link.click(function(r){r.preventDefault();e.show();h.show()});
var p=function(r,t){var u=a.messages.progress,v=Math.round(1E3*parseFloat(r/t))/10;r=u.replace(":percentage:",v||0).replace(":count:",r).replace(":total_count:",t);f.find(".crm-text").text(r)},q=function(){var r=c.val(),t=0,u=a.groups_count;l.show();h.hide();k.hide();f.show();b.find(".pager").hide();var v=function(){var B=b.find(".crm-merge.crm-js-partial").length;d.get(d.crm.app_url+"?module=contact&action=mergeDuplicates",{offset:B,field:r,no_js:1}).done(function(D){if(D){D=d("<div>").html(D);var C=
D.find(".crm-duplicates-table tbody").find(".crm-mergeduplicates-row");C.length?(g.find("tbody").append(C),z()):A();D.remove()}else A()})},w=function(B){var D=d.crm.app_url+"?module=contact&action=mergeDuplicatesGetContacts";B.attr("data-field-value");d.get(D,{field:r,value:B.attr("data-field-value"),master_slaves:1},function(C){C&&"ok"===C.status&&!d.isEmptyObject(C.data)?x(B,C.data):(B.addClass("crm-finished"),m.resolve())},"json").fail(function(){m.resolve()})},x=function(B,D){crmContactMerger.merge({master_id:D.master,
slave_ids:D.slaves,onDone:function(C){if(C.result&&C.result.total_count===C.result.merged_count){var F=d.crm.app_url+"contact/"+C.master.id+"/";B.closest("tr").find("td:not(:first)").css({textDecoration:"line-through"}).end().find("td:first").html('<a href="'+F+'" target="_blank">'+d.crm.encodeHTML(C.master.name)+"</a>")}else B.addClass("crm-partial");C=C.message||a.messages.done||"Done";B.closest("td").css({textDecoration:""}).html('<span class="float-right" style="margin-right: 10px;">'+C+"</span>").append(B.hide().addClass("crm-finished"));
m.resolve()},onError:function(){m.resolve()}})},y=function(){n?setTimeout(y,1E3):z()},z=function(){var B=b.find(".crm-merge:not(.crm-finished):first");B.length?(B.parent().find(".crm-loading").css("opacity",1),m=new d.Deferred,m.fail(function(){l.hide();k.show()}),m.done(function(){t+=1;p(t,u);n?y():z()}),w(B)):t<u?v():A()},A=function(){h.hide();k.hide();l.hide();f.hide();a.$wrapper.find(".crm-attention-message").hide();a.$wrapper.find(".crm-done-message").show()};z()};h.click(function(r){r.preventDefault();
q()});k.click(function(r){r.preventDefault();l.show();k.hide();n=!1});l.click(function(r){r.preventDefault();n=!0;l.hide();k.show()});p(0,a.groups_count)};return CRMContactsMergePage}(jQuery);var crmContactMerge=function(d){var a=function(b){this.$wrapper=b.$wrapper;this.$button=this.$wrapper.find(".crm-merge-submit");this.slave_ids=b.slave_ids||[];this.messages=b.messages||{};this.is_admin=b.is_admin;this.initClass()};a.prototype.initClass=function(){this.initSelectors();this.initMergeButton();this.$wrapper.on("click",".crm-contact-row-wrapper",function(b){var c=d(this).find(".crm-selector");c[0]!==b.target&&c.click()})};a.prototype.initSelectors=function(){var b=this;b.$wrapper.on("click",
".crm-selector",function(c){var e=d(this).closest(".crm-contact-row-wrapper"),f=e.find(".crm-contact-row");c=b.$wrapper.find(".crm-merge-description");b.$wrapper.find(".crm-js-hide-when-not-selected").hide();b.$wrapper.find(".crm-selected").removeClass("crm-selected");f.addClass("crm-selected");f.find(".crm-js-hide-when-not-selected").show();e=e.find(".crm-merge-description-for-master").html();c.html(e);c.find(".crm-js-not-allowed-as-master").length?b.$button.prop("disabled",!0):b.$button.prop("disabled",
!1)})};a.prototype.initMergeButton=function(){var b=this,c=b.slave_ids,e=b.$wrapper.find(".crm-loading");b.$button.click(function(f){f.preventDefault();var g=b.$wrapper.find(".crm-selector:checked").val();g?0<=c.indexOf(g)&&1===c.length?alert(b.messages.choose_master):(b.$button.attr("disabled",!0),e.show(),crmContactMerger.merge({master_id:g,slave_ids:c,onDone:function(){d.crm.storage.del("crm/merge/field");d.crm.content.load(d.crm.app_url+"contact/"+g+"/")},onError:function(){b.$button.attr("disabled",
!1);e.hide()}})):alert(b.messages.choose_master)})};return a}(jQuery);var crmContactMerger=function(d){var a=function(b){this.master_id=b.master_id||0;this.slave_ids=b.slave_ids||[];this.url=d.crm.app_url+"?module=contact&action=mergeRun";this.processId=this.timer=null;this.onDone=b.onDone||function(){};this.onError=b.onError||function(){throw Error("Error processing request.");}};a.prototype.process=function(){var b=this,c=b.url,e=0,f={};f.master_id=b.master_id;f.slave_ids=b.slave_ids;var g=function(){b.timer&&clearTimeout(b.timer);b.timer=setTimeout(g,3200);!b.processId||
2<=e||(f.processId=b.processId,d.post(c,f,null,"json").done(function(h){e--;b.processId&&h.ready&&b.processId&&(b.timer&&clearTimeout(b.timer),b.timer=null,b.processId=null,b.onDone(h))}).fail(b.onError),e++)};d.post(c,f,null,"json").done(function(h){if(!h.processId)b.onError();b.processId=h.processId;g()}).fail(b.onError);return this};a.prototype.cancel=function(){this.timer&&clearTimeout(this.timer);d.post(this.url,{processId:this.processId,ready:1});return this};a.merge=function(b){return(new a(b)).process()};
return a}(jQuery);var CRMReportPage=function(d){CRMReportPage=function(a){this.$wrapper=a.$wrapper;this.funnel_id=a.funnel_id;this.funnel_color=a.funnel_color;this.group_by=a.group_by;this.locales=a.locales;this.chartsData=a.chartsData;this.stages_data=a.stages_data;this.initClass()};CRMReportPage.prototype.initClass=function(){this.initSVG();"undefined"!==typeof d3&&(this.chartsData&&this.initChart(),this.stages_data&&this.initStageCharts(this.stages_data));this.initDateFilter()};CRMReportPage.prototype.initDateFilter=
function(){var a=this.$wrapper.find(".js-dates-filter"),b=a.find("form"),c=a.find(".js-list");a.find(".js-timeframe-field");var e=a.find(".js-link-text"),f=a.find(".js-hidden-part"),g=!1,h=c.find(".selected");c.on("click",".js-toggle",function(l){l.preventDefault();l=d(this);var k=l.data("timeframe");e.html(l.find("a").html());h.length&&h.removeClass("selected");h=l.addClass("selected");"custom"!==k?f.removeClass("is-shown"):f.addClass("is-shown")});b.on("submit",function(l){l.preventDefault();g||
(g=!0,l=b.serialize(),d.crm.content.load(d.crm.app_url+"report/?"+l))});(function(){a.find(".js-datepicker").each(function(){var l=d(this),k=a.find("."+l.data("selector"));l.datepicker({altField:k,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0})})})()};CRMReportPage.prototype.initSVG=function(){if("object"!==typeof d3)return!1;var a=function(b,c){function e(g){var h=g.$wrapper;g=g.start/100;var l={};l.width=h.outerWidth();l.height=h.outerHeight();l.inner_width=parseInt(l.width*g);l.inner_height=
l.height;l.top=l.height-l.inner_height;l.left=parseInt((l.width-l.inner_width)/2);return l}function f(g){var h=[],l=parseInt((g.start-g.end)/200*g.area.width);h.push("0,0");h.push(g.area.inner_width+",0");h.push(g.area.inner_width-l+","+g.area.height);h.push(l+","+g.area.height);return h.join(" ")}a=function(g){this.$wrapper=g.$wrapper;this.svg=c.select(this.$wrapper[0]).append("svg");this.start=parseInt(this.$wrapper.data("start"));this.end=parseInt(this.$wrapper.data("end"));this.color=this.$wrapper.data("color");
this.polygon=!1;this.area=e(this);this.initClass()};a.prototype.initClass=function(){function g(){b.contains(document,h.$wrapper[0])?h.refresh():b(window).off("resize",g)}var h=this;h.svg.attr("width",h.area.width).attr("height",h.area.height);h.renderRectangle();h.$wrapper.data("svg",h);b(window).on("resize",g)};a.prototype.renderRectangle=function(){var g=this.svg.append("g"),h=f(this);this.polygon=g.append("polygon").attr("points",h).attr("transform","translate("+this.area.left+","+this.area.top+
")").style("fill",this.color)};a.prototype.refresh=function(){this.area=e(this);this.svg.attr("width",this.area.width).attr("height",this.area.height);this.polygon.attr("points",f(this)).attr("transform","translate("+this.area.left+","+this.area.top+")")};return a}(jQuery,d3);this.$wrapper.find(".js-svg-bar").each(function(){var b=d(this);new a({$wrapper:b})})};CRMReportPage.prototype.initChart=function(){function a(f,g){function h(l,k,m){var n=l.date.split("-");l=parseInt(n[0]);var p=parseInt(n[1]);
n=parseInt(n[2]);l=[l,p,n];"years"===m?(m=l.slice(),m[0]+=k?1:-1):"months"===m?(m=l.slice(),m[1]+=k?1:-1):(m=l.slice(),m[2]+=k?1:-1);m[1]=(10>m[1]?"0":"")+m[1];m[2]=(10>m[2]?"0":"")+m[2];return{date:m.join("-"),value:0}}d.each(f,function(l){l=f[l];if(1===l.data.length){var k=l.data[0],m=h(k,!1,g),n=h(k,!0,g);console.log(k);console.log(m);console.log(n);k=[m].concat(l.data);k.push(n);l.data=k;console.log(l.data)}});return f}var b=this.$wrapper.find(".js-graph-section");if(!b.length)return!1;var c=
function(f){function g(k){function m(w){var x=w.split("-");w=parseInt(x[0]);var y=parseInt(x[1])-1;x=parseInt(x[2]);return new Date(w,y,x)}for(var n=[],p=0;p<k.length;p++){for(var q=k[p].data,r=[],t=0;t<q.length;t++){var u=q[t],v=parseInt(u.value);r.push({date:m(u.date),value:v})}n.push(r)}return d3.layout.stack().offset("zero").values(function(w){return w}).x(function(w){return w.date}).y(function(w){return w.value})(n)}function h(k,m){m=(m[1]||1)-m[0]+1;for(var n=m/(k-1),p=[],q=0;q<k;q++){var r=
10<m?Math.round(q*n):parseInt(q*n*10)/10;p.push(r)}return p}function l(k,m){var n=f(window),p=n.width();n.height();n=m.$hint.outerWidth();var q=m.$hint.outerHeight(),r=m.$wrapper.offset();m=k.pageX;k={left:m-r.left+10,top:k.pageY-r.top+(0<q?0-q-2:2)};p<k.left+n&&(k.left=m-(n+10));return k}c=function(k){this.$wrapper=k.$wrapper;this.$hint=this.$wrapper.find(".c-hint-wrapper");this.node=this.$wrapper.find(".js-graph")[0];this.d3node=d3.select(this.node);this.show_class="is-shown";this.charts=k.data;
this.data=g(this.charts);this.color=k.color;this.group_by=k.group_by;this.locales=k.locales;this.margin={top:14,right:10,bottom:20,left:34};var m=this.node;k=this.margin;var n=m.offsetWidth;m=m.offsetHeight;this.area={outer_width:n,outer_height:m,inner_width:n-k.left-k.right,inner_height:m-k.top-k.bottom};this.column_indent=4;k=this.area.inner_width;n=this.data[0].length;m=null;n+=1;k&&n&&(m=(k-this.column_indent*(n-1))/n,0>m&&(m=0));this.column_width=m;this.axisIndent=2;this.yDomain=this.xDomain=
this.svgArea=this.svgLine=this.y=this.x=this.defs=this.svg=!1;this.initGraph()};c.prototype.initGraph=function(){var k=this,m=k.area;k.initGraphCore();k.svg=k.d3node.append("svg").attr("width",m.outer_width).attr("height",m.outer_height);k.renderBackground();f.each(k.data,function(n,p){n=k.data.length-1-n;k.renderChart(k.data[n],k.charts[n])});k.renderAxis()};c.prototype.initGraphCore=function(){var k=this,m=k.data,n=k.area,p=k.x=d3.time.scale().range([0,n.inner_width]),q=k.y=d3.scale.linear().range([n.inner_height,
0]);k.yDomain=function(){var r=d3.min(m,function(u){return d3.min(u,function(v){return v.value})});0<r&&(r=0);var t=d3.max(m,function(u){return d3.max(u,function(v){return v.value+v.y0})});return[r,t]}();k.xDomain=function(){var r=m[0][0].date;var t=m[0][m[0].length-1].date;var u=.05*(t.getTime()-r.getTime());r=new Date(r.getTime()-u);t=new Date(t.getTime()+u);return[r,t]}();p.domain(k.xDomain);q.domain(k.yDomain);k.svgArea=d3.svg.area().interpolate("monotone").x(function(r){return p(r.date)}).y(function(r){return q(r.value+
r.y0)-k.axisIndent}).y0(function(r){return q(0)});k.svgLine=d3.svg.line().interpolate("monotone").x(function(r){return p(r.date)}).y(function(r){return q(r.value+r.y0)-k.axisIndent})};c.prototype.renderAxis=function(){var k=this.x,m=this.y,n=this.svg;k=d3.svg.axis().scale(k).orient("bottom").ticks(10);m=d3.svg.axis().scale(m).innerTickSize(2).orient("right").tickValues(h(6,this.yDomain)).tickFormat(function(p){return p+""});n=n.append("g").attr("class","axis");n.append("g").attr("transform","translate(10,"+
this.margin.top+")").attr("class","y").call(m);n.append("g").attr("class","x").attr("transform","translate("+this.margin.left+","+(this.area.outer_height-this.margin.bottom)+")").call(k)};c.prototype.renderBackground=function(){var k=this.area.inner_width,m=this.area.inner_height,n,p=this.svg.append("g").attr("class","background").attr("transform","translate("+this.margin.left+","+this.margin.top+")");p.append("rect").attr("width",k).attr("height",m);for(n=0;5>=n;n++){var q=1+(m-2)/5*n;p.append("line").attr("x1",
1).attr("x2",k).attr("y1",q).attr("y2",q)}};c.prototype.renderChart=function(k,m){var n=this,p=m.color;n.svg.append("g").attr("class","c-graph-wrapper").attr("transform","translate("+n.margin.left+","+n.margin.top+")").datum(k).append("path").style("stroke",function(){return 1<n.charts.length?"":n.color}).style("fill",function(){return p?p:n.color}).attr("class","area").attr("d",n.svgArea(k)).on("mouseover",function(q){n.showHint(d3.event,this,m)}).on("mousemove",function(){n.moveHint(this)}).on("mouseout",
function(){n.hideHint()})};c.prototype.update=function(k){this.data=g(this.charts,k);this.initGraphCore();k=d3.svg.axis().scale(this.y).innerTickSize(2).orient("right").tickValues(h(6,this.yDomain)).tickFormat(function(m){return m+""});this.svg.selectAll(".axis .y").call(k);this.renderCharts()};c.prototype.showHint=function(k,m,n){m=this.$hint.find(".js-name");this.$hint.find(".js-date");this.$hint.find(".js-value");n.name&&(m.text(n.name),k=l(k,this),this.$hint.css(k).addClass(this.show_class))};
c.prototype.moveHint=function(){if(this.$hint.hasClass(this.show_class)){var k=l(event,this);this.$hint.css(k)}};c.prototype.hideHint=function(){this.$hint.removeAttr("style").removeClass(this.show_class)};return c}(jQuery),e=function(f){function g(l){function k(v){var w=v.split("-");v=parseInt(w[0]);var x=parseInt(w[1])-1;w=parseInt(w[2]);return new Date(v,x,w)}for(var m=[],n=0;n<l.length;n++){for(var p=l[n].data,q=[],r=0;r<p.length;r++){var t=p[r],u=parseInt(t.value);q.push({date:k(t.date),value:u})}m.push(q)}return d3.layout.stack().offset("zero").values(function(v){return v}).x(function(v){return v.date}).y(function(v){return v.value})(m)}
function h(l,k){var m=k[0];k=k[1]||1;m=0<k-m?k-m:1;k=m/(l-1);for(var n=[],p=0;p<l;p++){var q=10<m?Math.round(p*k):parseInt(p*k*10)/10;q=0<parseInt(q)?parseInt(q):1;n.push(q)}return n}e=function(l){this.$wrapper=l.$wrapper;this.$hint=this.$wrapper.find(".c-hint-wrapper");this.node=this.$wrapper.find(".js-graph")[0];this.d3node=d3.select(this.node);this.show_class="is-shown";this.charts=l.data;this.data=g(this.charts);this.color=l.color;this.group_by=l.group_by;this.locales=l.locales;this.margin={top:8,
right:10,bottom:4,left:34};var k=this.node;l=this.margin;var m=k.offsetWidth;k=k.offsetHeight;this.area={outer_width:m,outer_height:k,inner_width:m-l.left-l.right,inner_height:k-l.top-l.bottom};this.column_indent=200<this.data[0].length?2:4;l=this.area.inner_width;m=this.data[0].length;k=null;m+=1;l&&m&&(k=(l-this.column_indent*(m-1))/m,1>k?k=1:20<k&&(k=20));this.column_width=k;this.yDomain=this.xDomain=this.y=this.x=this.defs=this.svg=!1;this.initGraph()};e.prototype.initGraph=function(){var l=this.area;
this.initGraphCore();200<this.data[0].length?this.$wrapper.addClass("is-large"):this.$wrapper.removeClass("is-large");this.svg=this.d3node.append("svg").attr("width",l.outer_width).attr("height",l.outer_height);this.renderBackground();this.renderCharts();this.renderAxis()};e.prototype.initGraphCore=function(){var l=this.data,k=this.area,m=this.x=d3.time.scale().range([0,k.inner_width]);k=this.y=d3.scale.linear().range([0,k.inner_height]);this.yDomain=function(){var n=d3.min(l,function(q){return d3.min(q,
function(r){return r.value})});0<n&&(n=0);var p=d3.max(l,function(q){return d3.max(q,function(r){return r.value+r.y0})});return[n,p]}();this.xDomain=function(){var n=l[0][0].date;var p=l[0][l[0].length-1].date;var q=.05*(p.getTime()-n.getTime());n=new Date(n.getTime()-q);p=new Date(p.getTime()+q);return[n,p]}();m.domain(this.xDomain);k.domain(this.yDomain)};e.prototype.renderAxis=function(){var l=this.x,k=this.y,m=this.svg;d3.svg.axis().scale(l).orient("bottom").ticks(10);l=d3.svg.axis().scale(k).innerTickSize(2).orient("right").tickValues(h(6,
this.yDomain)).tickFormat(function(n){return n+""});m.append("g").attr("class","axis").append("g").attr("transform","translate(10,"+this.margin.top+")").attr("class","y").call(l)};e.prototype.renderBackground=function(){var l=this.area.inner_width,k=this.area.inner_height,m,n=this.svg.append("g").attr("class","background").attr("transform","translate("+this.margin.left+","+this.margin.top+")");n.append("rect").attr("width",l).attr("height",k);for(m=0;5>=m;m++){var p=1+(k-2)/5*m;n.append("line").attr("x1",
1).attr("x2",l).attr("y1",p).attr("y2",p)}};e.prototype.renderCharts=function(){var l=this,k=l.data;k=l.svg.selectAll(".c-graph-wrapper").data(k);k.enter().append("g").attr("class","c-graph-wrapper").attr("transform","translate("+l.margin.left+","+l.margin.top+")");var m=k.selectAll(".rect").data(function(q){return q}),n=!1;if(l.color){var p=f.crm.color(l.color).rgb;p.push(.5);n="rgba("+p.join(",")+")"}m.enter().append("rect").attr("class","rect").on("mouseover",function(q,r,t){l.showHint(d3.event,
this,q,l.charts[t])}).on("mousemove",function(){l.moveHint(this)}).on("mouseout",function(){l.hideHint()});m.transition().duration(1E3).attr("x",function(q,r){return l.x(q.date)-l.column_width/2}).attr("y",function(q){return l.y(q.y0)}).attr("height",function(q){return l.y(q.value)}).style("stroke",function(q,r,t){return l.charts[t].color?"":l.color}).style("fill",function(q,r,t){q=l.charts[t];return q.color?q.color:n}).attr("width",l.column_width);m.exit().remove();k.exit().remove()};e.prototype.update=
function(l){this.data=g(this.charts,l);this.column_indent=200<this.data[0].length?2:4;200<this.data[0].length?this.$wrapper.addClass("is-large"):this.$wrapper.removeClass("is-large");this.initGraphCore();l=d3.svg.axis().scale(this.y).innerTickSize(2).orient("right").tickValues(h(6,this.yDomain)).tickFormat(function(k){return k+""});this.svg.selectAll(".axis .y").call(l);this.renderCharts()};e.prototype.showHint=function(l,k,m,n){var p=this;l=f(k);if(!(0<Math.ceil(l.attr("height"))))return!1;var q=
m.date;k=p.$hint.find(".js-name");var r=p.$hint.find(".js-date"),t=p.$hint.find(".js-value");q=function(u,v){var w=parseInt(u.getMonth());"months"==v?(u=p.locales.months,u[w]||(u="\u042f\u043d\u0432\u0430\u0440\u044c \u0424\u0435\u0432\u0440\u0430\u043b\u044c \u041c\u0430\u0440\u0442 \u0410\u043f\u0440\u0435\u043b\u044c \u041c\u0430\u0439 \u0418\u044e\u043d\u044c \u0418\u044e\u043b\u044c \u0410\u0432\u0433\u0443\u0441\u0442 \u0421\u0435\u043d\u0442\u044f\u0431\u0440\u044c \u041e\u043a\u0442\u044f\u0431\u0440\u044c \u041d\u043e\u044f\u0431\u0440\u044c \u0414\u0435\u043a\u0430\u0431\u0440\u044c".split(" ")),
w=u[w]):(v=u.getDate(),w+=1,w=(10>v?"0"+v:v)+"."+(10>w?"0"+w:w)+"."+u.getFullYear());return w}(q,p.group_by);n.name?k.text(n.name+": ").show():k.hide();r.text(q);t.text(m.value);m=function(u){var v=f(window),w=v.width();v.height();v=p.$hint.outerWidth();var x=p.$hint.outerHeight(),y=Math.ceil(u.attr("width")),z=Math.ceil(u.attr("height")),A=p.$wrapper.offset();u=u.offset();x={left:u.left-A.left+y+10,top:u.top-A.top+(z<x?z-x-2:2)};w<x.left+v&&(x.left=u.left-(v+10));return x}(l);p.$hint.css(m).addClass(p.show_class)};
e.prototype.moveHint=function(){};e.prototype.hideHint=function(){this.$hint.removeAttr("style").removeClass(this.show_class)};return e}(jQuery);new c({$wrapper:b.find(".js-sum-graph"),data:a(this.chartsData.sum,this.group_by),color:this.funnel_color,group_by:this.group_by,locales:this.locales});new e({$wrapper:b.find(".js-amount-graph"),data:a(this.chartsData.qty,this.group_by),color:this.funnel_color,group_by:this.group_by,locales:this.locales})};CRMReportPage.prototype.initStageCharts=function(a){var b=
this.$wrapper.find(".js-stage-graph-section"),c=a.stages;if(!b.length||!c.length)return!1;var e=[0,2*c.length],f=function(h){f=function(l){this.$wrapper=l.$wrapper;this.$hint=this.$wrapper.find(".c-hint-wrapper");this.node=this.$wrapper.find(".js-graph")[0];this.d3node=d3.select(this.node);this.show_class="is-shown";console.log(l.data);for(var k=l.data,m=0;m<k.length;m++){var n=k[m];1!==m||n.color||(n.color="#e07d6e")}k=this.charts=k;m=[];for(n=0;n<k.length;n++){for(var p=k[n].data,q=[],r=0;r<p.length;r++){var t=
parseInt(p[r].value);q.push({index:1+2*r,value:t})}m.push(q)}this.data=m;this.color=l.color;this.group_by=l.group_by;this.locales=l.locales;this.margin={top:20,right:0,bottom:0,left:0};m=this.node;l=this.margin;k=m.offsetWidth;m=m.offsetHeight;this.area={outer_width:k,outer_height:m,inner_width:k-l.left-l.right,inner_height:m-l.top-l.bottom};this.column_indent=8;l=this.area.inner_width;k=this.data[0].length;m=null;l&&k&&(m=(l-this.column_indent*(k-1))/k,1>m&&(m=1));this.column_width=m;this.yDomain=
this.xDomain=this.y=this.x=this.defs=this.svg=!1;this.initGraph()};f.prototype.initGraph=function(){var l=this.area;this.initGraphCore();this.svg=this.d3node.append("svg").attr("width",l.outer_width).attr("height",l.outer_height);this.renderCharts()};f.prototype.initGraphCore=function(){var l=this.data,k=this.area,m=this.x=d3.scale.linear().range([0,k.inner_width]);k=this.y=d3.scale.linear().range([0,k.inner_height]);this.yDomain=function(){var n=d3.min(l,function(q){return d3.min(q,function(r){return r.value})});
0<n&&(n=0);var p=d3.max(l,function(q){return d3.max(q,function(r){return r.value})});return[n,p]}();this.xDomain=e;m.domain(this.xDomain);k.domain(this.yDomain)};f.prototype.renderCharts=function(){var l=this,k=l.data;k=l.svg.selectAll(".c-graph-wrapper").data(k);k.enter().append("g").attr("class","c-graph-wrapper").attr("transform","translate("+l.margin.left+","+l.margin.top+")");var m=k.selectAll(".rect").data(function(q){return q});m.enter().append("rect").attr("class","rect");m.transition().duration(1E3).attr("x",
function(q,r){return l.x(q.index)-l.column_width/2}).attr("y",function(q){return l.area.inner_height-l.y(q.value)}).attr("height",function(q){return l.y(q.value)}).style("stroke",function(q,r,t){return l.charts[t].color?"":l.color}).style("fill",function(q,r,t){q=l.charts[t];return q.color?q.color:l.color}).attr("width",l.column_width);var n=k.selectAll(".base-text").data(function(q){return q});n.enter().append("text").attr("class","base-text");n.transition().duration(1E3).attr("text-anchor","middle").attr("x",
function(q){return l.x(q.index)}).attr("y",function(q){return l.area.inner_height-10}).text(function(q,r,t){q="";if(r=l.charts[t].data[r])q=r.base_text;return q});var p=k.selectAll(".over-text").data(function(q){return q});p.enter().append("text").attr("class","base-text");p.transition().duration(1E3).attr("text-anchor","middle").attr("x",function(q){return l.x(q.index)}).attr("y",function(q){return l.area.inner_height-l.y(q.value)-6}).style("fill",function(q,r,t){return 1===t?"#cc270e":""}).text(function(q,
r,t){q="";if(r=l.charts[t].data[r])q=r.over_text;return q});n.exit().remove();p.exit().remove();m.exit().remove();k.exit().remove()};return f}(jQuery),g=function(h){function l(k){for(var m=[],n=0;n<k.length;n++){for(var p=k[n].data,q=[],r=0;r<p.length;r++){var t=parseInt(p[r].value);q.push({index:1+2*r,value:t})}m.push(q)}return d3.layout.stack().offset("zero").values(function(u){return u}).x(function(u){return u.index}).y(function(u){return u.value})(m)}g=function(k){this.$wrapper=k.$wrapper;this.$hint=
this.$wrapper.find(".c-hint-wrapper");this.node=this.$wrapper.find(".js-graph")[0];this.d3node=d3.select(this.node);this.show_class="is-shown";this.charts=k.data;this.data=l(this.charts);this.color=k.color;this.group_by=k.group_by;this.locales=k.locales;this.margin={top:0,right:0,bottom:20,left:0};var m=this.node;k=this.margin;var n=m.offsetWidth;m=m.offsetHeight;this.area={outer_width:n,outer_height:m,inner_width:n-k.left-k.right,inner_height:m-k.top-k.bottom};this.column_indent=8;k=this.area.inner_width;
n=this.data[0].length;m=null;k&&n&&(m=(k-this.column_indent*(n-1))/n,1>m&&(m=1));this.column_width=m;this.yDomain=this.xDomain=this.y=this.x=this.defs=this.svg=!1;this.initGraph()};g.prototype.initGraph=function(){var k=this.area;this.initGraphCore();this.svg=this.d3node.append("svg").attr("width",k.outer_width).attr("height",k.outer_height);this.renderCharts()};g.prototype.initGraphCore=function(){var k=this.data,m=this.area,n=this.x=d3.scale.linear().range([0,m.inner_width]);m=this.y=d3.scale.linear().range([0,
m.inner_height]);this.yDomain=function(){var p=d3.min(k,function(r){return d3.min(r,function(t){return t.value})});0<p&&(p=0);var q=d3.max(k,function(r){return d3.max(r,function(t){return t.value+t.y0})});return[p,q]}();this.xDomain=e;n.domain(this.xDomain);m.domain(this.yDomain)};g.prototype.renderCharts=function(){var k=this,m=k.data;m=k.svg.selectAll(".c-graph-wrapper").data(m);m.enter().append("g").attr("class","c-graph-wrapper").attr("transform","translate("+k.margin.left+","+k.margin.top+")");
var n=m.selectAll(".rect").data(function(r){return r});n.enter().append("rect").attr("class","rect");n.transition().duration(1E3).attr("x",function(r,t){return k.x(r.index)-k.column_width/2}).attr("y",function(r){return k.y(r.y0)}).attr("height",function(r){return k.y(r.value)}).style("stroke",function(r,t,u){return k.charts[u].color?"":k.color}).style("fill",function(r,t,u){r=k.charts[u];return r.color?r.color:k.color}).attr("width",k.column_width);var p=m.selectAll(".base-text").data(function(r){return r});
p.enter().append("text").attr("class","base-text").text(function(r,t,u){r="";if(t=k.charts[u].data[t])r=t.base_text;return r}).append("tspan").style("fill","#cc270e").text(function(r,t,u){r="";(t=k.charts[u].data[t])&&t.sub_text&&(r=" ("+t.sub_text+")");return r});p.transition().duration(1E3).attr("text-anchor","middle").attr("x",function(r){return k.x(r.index)}).attr("y",16);var q=m.selectAll(".over-text").data(function(r){return r});q.enter().append("text").attr("class","over-text");q.transition().duration(1E3).attr("text-anchor",
"middle").attr("x",function(r){return k.x(r.index)}).attr("y",function(r){r=k.y(r.y0)+k.y(r.value)+16;34>r&&(r=34);return r}).text(function(r,t,u){r="";if(t=k.charts[u].data[t])r=t.over_text;return r});p.exit().remove();q.exit().remove();n.exit().remove();m.exit().remove()};return g}(jQuery);c=b.find(".js-graph-wrapper-1");c.length&&new f({$wrapper:c,data:a.charts[0],color:"#d0d0d0",group_by:this.group_by,locales:this.locales});b=b.find(".js-graph-wrapper-2");b.length&&new g({$wrapper:b,data:[a.charts[1]],
color:"#b0b0b0",group_by:this.group_by,locales:this.locales})};return CRMReportPage}(jQuery);(function(d){d.crm=d.crm||{};d.crm.search={state:null,url:d.crm.app_url+"?module=contactSearch",serialize:function(a,b,c,e){var f={},g=a.serializeArray();a=0;for(var h=g.length;a<h;a+=1){var l=(g[a].value||"").trim();try{l=JSON.parse(l)}catch(v){}var k=g[a].name;if(!(!k||!l||d.isPlainObject(l)&&d.isEmptyObject(l)||b&&0!==k.indexOf(b)||void 0!==c&&-1===k.indexOf("["+c+"]"))){var m=""+(d.isPlainObject(l)?l.val:l);if(m=d.trim(m)){l=d.isPlainObject(l)?l.op||"=":"=";m=m.replace(/\//g,"\\/").replace(/&/,
"\\&");k=k.split(".");for(var n=f,p=0,q=k.length-1;p<q;p+=1){var r=(k[p]||"").trim();if("undefined"===typeof n[r]||"object"!==typeof n[r])n[r]={};n=n[r]}r=k[k.length-1];d.isArray(n[r])?n[r].push({val:m,op:l}):d.isPlainObject(n[r])||(n[r]=[{val:m,op:l}])}}}var t=function(v,w,x){if(d.isPlainObject(v))for(var y in v)v.hasOwnProperty(y)&&t(v[y],w,x?x+"."+y:y);else"undefined"!==typeof v&&(w[x]=v)};b={};t(f,b,"");f=[];for(var u in b)if(b.hasOwnProperty(u))if(d.isArray(b[u])&&1<b[u].length)for(a=0,h=b[u].length;a<
h;a+=1)m=b[u][a].val,e||(m=this.encodeURIComponent(b[u][a].val)),f.push(u+"["+a+"]"+b[u][a].op+m);else m=b[u][0].val,e||(m=this.encodeURIComponent(b[u][0].val)),f.push(u+b[u][0].op+m);return f.join("&")},encodeURIComponent:function(a){a=encodeURIComponent(a);return a=a.replace(/%2F/g,"%252F").replace(/%5C/g,"%255C")},indexBlocks:function(a){var b={},c=d('#c-search-block .js-field[data-multiple="1"]');a&&(c=c.filter('[data-id="'+a+'"]'));c.each(function(){var e=d(this),f=e.data("id"),g=void 0!==b[f]?
++b[f]:b[f]=0;e.attr("data-index",g);e.data("index",g);e.find(":input").each(function(){var h=d(this),l=h.attr("name").replace(/\[\d+\]/,"").replace(f,f+"["+g+"]");h.attr("name",l)})})}}})(jQuery);(function(d){d.widget("custom.combobox",{_create:function(){this.element.data("custom.combobox.inited")||(this.wrapper=d("<div style='position:relative;'>").addClass("custom-combobox").insertAfter(this.element),this.element.hide(),this._createAutocomplete(),this._createShowAllButton(),this.element.data("custom.combobox.inited",1))},_createAutocomplete:function(){this.ns=this.element.attr("name")||"element-"+(""+Math.random()).slice(2);_other_version_=!0;if(this.element.is("select")){var a=this.element.children(":selected"),
b=a.val()?a.text():"";this.h=24;var c=this;this.input=d("<input type='search'>").appendTo(this.wrapper).val(b).attr("title","").addClass("custom-combobox-input ui-widget");this.element.data("autocomplete")||this.element.data("readonly")?(this.input.autocomplete({delay:200,minLength:0,html:!0,source:d.proxy(this,"_source"),item_clz:"crm-search-ui-autocomplete-item"}),this.ul=d(this.input).autocomplete("widget")):this.ul=d();this.offset=this.limit=this.element.data("limit");this.count=this.element.data("count");
this.wrapper.width(this.input.width()+30);this.ul.css({overflowY:"auto",overflowX:"hidden",maxHeight:10*this.h});this.element.attr("disabled")&&this.input.attr("disabled",!0);this.options.css&&this.input.css(this.options.css);this.element.find("option.cond").remove();this.element.data("readonly")&&this.input.attr("readonly",!0).addClass("readonly").css({cursor:"pointer"}).click(function(){d(this).autocomplete("widget").is(":visible")?d(this).autocomplete("close"):c._showSelectItems();return!1});this.hidden=
d("<input type='hidden'>").appendTo(this.wrapper);this.label=!1!==this.options.label?d('<span class="c-label"></span>').css({left:"-20px",position:"absolute"}).prependTo(this.wrapper):d();this.element.attr("name","");this.element.data("readonly")&&this.label.hide();this.element.attr("disabled")&&this.input.attr("disabled",!0);"*="===a.data("op")&&this.label.text("\u2248");if(a.val()&&!a.hasClass("value"))a.data("period")?(this.element.data("value",""),a=a.val().split("--"),this._updatePeriodInput((a[0]||
"").trim(),(a[1]||"").trim())):(this.element.data("value",""),"value"===this.element.data("pass")?this.hidden.attr("name",this.ns).val(a.val()):this.hidden.attr("name",this.ns+"."+a.val()).val("1"),this.input.val(a.text()),this.label.text("=")),this._removeIcon();else if(a.hasClass("value")||a.text()){this.element.val("");b=a.hasClass("value")?a.val()||a.text():a.text();var e=a.hasClass("value")?a.text():b;"*="===a.data("op")?this.element.data("readonly")?this.hidden.attr("name",this.ns).val(b):this.hidden.attr("name",
this.ns).val(JSON.stringify({op:"*=",val:b})):this.hidden.attr("name",this.ns).val(b);this.input.val(e);a.data("icon")&&this._addIcon(a.data("icon"))}else this.hidden.attr("name",this.ns);this.input.bind("autocompleteselect",function(g,h){h.item.option&&(h.item.option.selected=!0,d(this).trigger("select",g,{item:h.item.option}));if(h.item.option&&!d(h.item.option).hasClass("value"))if(d(h.item.option).data("period")){var l=c._showPeriodDialog();l.bind("select",function(m,n,p){c._updatePeriodInput(n,
p);c._removeIcon()});l.bind("cancel",function(){c.input.val("");c.hidden.attr("name",c.ns).val("");c.label.text("")})}else(l=d(h.item.option).val())?"value"===c.element.data("pass")?c.hidden.attr("name",c.ns).val(l):c.hidden.attr("name",c.ns+"."+l).val("1"):c.hidden.attr("name",c.ns).val(""),c.input.val(d(h.item.option).text()),c.label.text("="),c._removeIcon();else{l=h.item.value;var k=h.item.text||h.item.name;h.item.option&&(l=d(h.item.option).val());c.hidden.attr("name",c.ns).val(l);c.input.val(k);
c.label.text("=");h.item.icon?c._addIcon(h.item.icon):c._removeIcon()}c.element.trigger("change");c.element.data("readonly")&&setTimeout(function(){c.input.blur()});"function"===typeof c.options.select&&c.options.select.apply(this,[g,h]);return!1}).bind("autocompletechange",function(g,h){c._removeIfInvalid.call(c,g,h)});var f="";this.element.data("readonly")||(this.input.bind("keydown",function(){f=d(this).val()}),this.input.bind("keyup",function(){var g=d(this).val();f!==g&&(c._removeIcon(),g?(c.label.text("\u2248"),
c.hidden.attr("name",c.ns).val(JSON.stringify({val:g,op:"*="}))):(c.label.text(""),c.hidden.attr("name",c.ns).val("")));"function"===typeof c.options.keyup&&c.options.keyup.apply(this,[g,f]);f=g}));this.input.bind("keyup",function(g){13==g.keyCode&&!d(this).data("hold")&&d(this).val().trim()&&d(this).trigger("enter")});this.input.bind("search",function(){d(this).val()||(c._removeIcon(),c.hidden.attr("name",c.ns).val(""),c.label.text(""),c.ul.is(":visible")&&d(this).autocomplete("search",""),"function"===
typeof c.options.clear&&c.options.clear.apply(this))});this.input.bind("autocompleteopen",function(g,h){var l=c.input.width();c.ul.find("li.ui-menu-item").each(function(){var k=d(this),m=k.find(".count"),n=k.find(".crm-text");m.insertBefore(n);n.width(Math.max(l-m.outerWidth(!0)-30,0)).data("sep")&&k.css({borderTop:"1px solid #ccc"})});c.ul.width(l)});_other_version_||(this.input.bind("autocompleteopen",function(g,h){c.ul.width(c.input.outerWidth(!0)-5);void 0!==c.offset&&void 0!==c.count&&(c.offset<
c.count?(c.height=c.ul.height(),c.ul.unbind("scroll."+c.ns).bind("scroll."+c.ns,function(){var m=d(this).find(".dummy-end");m.length?d(this).scrollTop()+c.height>=m.position().top&&c.input.trigger("autocompleteload"):c.ul.unbind("scroll."+c.ns)}),g=c.ul.find(".ui-menu-item:first").height(),d('<li class="dummy-end ignore-hover" role="menuitem"><a class="ui-corner-all" style="padding: .2em .4em; line-height: 1.5; display: block;"></a></li>').height(g).appendTo(c.ul),c.ul.css({overflowY:"scroll",overflowX:"hidden",
height:c.height})):(c.ul.unbind("scroll."+c.ns),c.ul.css({overflowY:"",overflowX:""})));c.ul.find(".sep").closest("li").addClass("ignore-hover");var l=c.ul.width(),k="scroll"===c.ul.css("overflowY");c.ul.find("li.ui-menu-item").each(function(){var m=d(this);m.find(".sep").length?m.find(".sep").width(k?l-25:l-10):m.find(".crm-text").width(Math.max(l-m.find(".count").outerWidth(!0)-30,0))})}),this.input.bind("autocompleteload",function(g){!c.loading&&c.offset<c.count&&(c.loading=!0,c.input.addClass("ui-autocomplete-loading"),
d.get(c.options.url,{id:c.ns,offset:c.offset,limit:c.limit,term:c.input.val()},function(h){if("ok"===h.status){var l=h.data.values,k=[];c.ul.find(".ui-menu-item").each(function(){k.push(d(this).data("item.autocomplete"))});for(var m=0;m<l.length;m+=1)k.push(c._formItem(l[m]));c.count=h.data.count;c.response(k);c.offset+=l.length;c.offset>=c.count&&c.ul.find(".dummy-end").remove()}c.loading=!1;c.input.removeClass("ui-autocomplete-loading")},"json"))}));this.input.bind("autocompletefocus",function(g,
h){d(this).val(h.item.name);d(this).data("hold",1);return!1});this.input.bind("autocompleteclose",function(g,h){if(13===g.keyCode){var l=d(this);setTimeout(function(){l.data("hold",0)},200)}else d(this).data("hold",0)});this.input.focus(function(){c.arrow.show()}).blur(function(){c.wrapper.data("mouserover")||c.arrow.hide()});this.wrapper.mouseover(function(){d(this).data("mouserover",1);c.arrow.show()}).mouseout(function(){d(this).data("mouserover",0);c.input.is(":focus")||c.arrow.hide()})}},_createShowAllButton:function(){var a=
this.input,b=this.hidden,c=this.ns,e=this.element,f=this;e.find("option").length?(this.arrow=d("<a href='javascript:void(0);' style='margin: -2px 0 0 -20px;'><i class='icon16 darr'></i></a>").attr("tabIndex",-1).appendTo(this.wrapper).removeClass("ui-corner-all").addClass("custom-combobox-toggle ui-corner-right").mousedown(function(){a.focus();b.attr("name",c);f.ul.is(":hidden")?f._showSelectItems():a.autocomplete("search","");return!1}).hide(),e.data("readonly")&&this.wrapper.find(".icon16").css({backgroundColor:"white"}).parent().css({})):
this.arrow=d()},_addIcon:function(a){this.input.after('<img class="flag" style="position: absolute; top: 3px; right: 41px; padding: 2px; background: white;" src="'+a+'"/>')},_removeIcon:function(){this.input.nextAll(".flag").remove()},_formItem:function(a,b){var c=a.label;!b||a.value||a.name||(c='<span style="visibility: hidden">empty</span>');_other_version_||(c=d.wa.encodeHTML(a.name));c='<span class="crm-text" data-sep="'+(a.sep?1:0)+'">'+c;a.icon&&(c+=' <img src="'+a.icon+'" />');c+="</span>";
d.isNumeric(a.count)&&(c+='<span class="count" style="margin-top: 2px;">'+a.count+"</span>");a.label=c;a.value||(a.value=a.name);return a},_showSelectItems:function(){var a=this,b=null,c=a.element.data("readonly"),e=!1;a.input.autocomplete("search","");b=this.response;b(this.element.children("option").map(function(){var f=d(this);if(f.hasClass("sep"))e=!0;else return f=a._formItem({icon:f.data("icon"),count:f.data("count"),label:f.html(),name:f.text(),value:this.value,sep:e,option:this},c),e=!1,f}).toArray())},
_source:function(a,b){var c=new RegExp(d.ui.autocomplete.escapeRegex(a.term),"i"),e=this;e.response=b;if(_other_version_&&!a.term)b([]);else{var f=function(h,l){_other_version_&&(h.highlight=1);d.get(e.options.url,h,function(k){var m=[],n=0;k&&"ok"===k.status&&(d.isArray(k.data.values)&&k.data.values.length&&(m=k.data.values),k.data.count&&(n=k.data.count));k=0;for(var p=m.length;k<p;k+=1)m[k]=e._formItem(d.extend(m[k],{option:null}));e.offset=m.length;e.count=n;b(m)},"json")};if(_other_version_)a.term?
f({term:a.term,id:this.ns}):b(this.element.children("option").map(function(){var h=d(this),l=h.html();if(h.hasClass("sep"))return d.extend({},sep,{option:this});if(this.value&&(!a.term||c.test(l))){var k=l;h.data("icon")&&(k+=' <img src="'+h.data("icon")+'" />');d.isNumeric(h.data("count"))&&(k+='<span class="count">'+h.data("count")+"</span>");return{label:k,text:l,value:this.value,option:this}}}).toArray());else if(a.term&&this.element.data("autocomplete"))f({term:a.term,id:this.ns},function(h){e.ul.height(e.h*
h.length);return h});else{var g=this.element.children("option").map(function(){var h=d(this),l=h.html();if(h.hasClass("sep"))return d.extend({},sep,{option:this});if(this.value&&(!a.term||c.test(l))){var k=l;h.data("icon")&&(k+=' <img src="'+h.data("icon")+'" />');d.isNumeric(h.data("count"))&&(k+='<span class="count">'+h.data("count")+"</span>");return{label:k,text:l,value:this.value,option:this}}}).toArray();this.element.data("autocomplete")?f({term:"",id:this.ns},function(h){h.length&&g[g.length-
1]&&!d(g[g.length-1].option).hasClass("sep")&&g.push(sep);g=g.concat(h);e.ul.height(e.h*g.length);return g}):b(g)}}},_removeIfInvalid:function(a,b){if(!b.item){a=this.input;var c=a.val().toLowerCase(),e=!1;this.element.children("option").each(function(){if(d(this).text().toLowerCase()===c)return this.selected=e=!0,!1});e||((b=a.data("uiAutocomplete"))||(b=a.date("autocomplete")),b&&(b.term=""))}},_updatePeriodInput:function(a,b){this.label.text("");this.hidden.attr("name",this.ns+".period").val("");
var c=d.datepicker.formatDate("dd.mm.yy",new Date(a)),e=d.datepicker.formatDate("dd.mm.yy",new Date(b));a&&b?(this.hidden.val([d.datepicker.formatDate("yy-mm-dd",new Date(a)),d.datepicker.formatDate("yy-mm-dd",new Date(b))].join("--")),this.input.val(c===e?c:c+"\u2013"+e),this.label.text("=")):a?(this.hidden.val(JSON.stringify({val:d.datepicker.formatDate("yy-mm-dd",new Date(a)),op:">="})),this.input.val(c),this.label.text(">=")):b&&(this.hidden.val(JSON.stringify({val:d.datepicker.formatDate("yy-mm-dd",
new Date(b)),op:"<="})),this.label.text("<="))},_renderItem:function(a,b){return d("<li class='crm-search-ui-menu-item'>").append(d("<div>").text(b.label)).appendTo(a)},_showPeriodDialog:function(){d("#c-combobox-dialog").remove();return d('<div id="c-combobox-dialog"></div>').appendTo("body").periodDialog()},_destroy:function(){this.wrapper.remove();this.element.show()}})})(jQuery);(function(d){d.fn.periodDialog=function(a,b){function c(l){var k=g().find(".datepicker.start");k=new Date(k.datepicker("getDate"));return d.datepicker.formatDate(l,k)}function e(l){var k=g().find(".datepicker.end");k=new Date(k.datepicker("getDate"));return d.datepicker.formatDate(l,k)}function f(l,k,m){return d.datepicker.formatDate(l,new Date(k),m)}function g(){return this.data("$dialog")}if(!this.length)return this;if("getStartDate"===a)return c();if("getEndDate"===a)return e();if("formatDate"===
a)return f.apply(this,Array.prototype.slice.call(arguments,1));var h={};"object"===typeof a&&(this.data("periodDialogOptions",d.extend({start_datetime:null,end_datetime:null},a)),h=this.data("periodDialogOptions"));return function(){var l=d(".crm-dialog-search-period-wrapper.is-template").clone(),k="crm-dialog-search-period-wrapper-"+(Math.random()+"").slice(2);d(".crm-dialog-search-period-wrapper:not(.is-template)").remove();l.removeClass("is-template");l.attr("id",k);l.appendTo("body");l.show();
new CRMDialog({html:l,onOpen:function(m,n){m.find(".datepicker").datepicker();h.start_datetime&&m.find(".datepicker.start").datepicker("setDate",d.datepicker.parseDate("yy-mm-dd",h.start_datetime));h.end_datetime&&m.find(".datepicker.end").datepicker("setDate",d.datepicker.parseDate("yy-mm-dd",h.end_datetime));var p=m.find(".js-apply-action"),q=m.find(".js-cancel-action");p.click(function(r){r.preventDefault();r=m.find(".start").datepicker("getDate");var t=m.find(".end").datepicker("getDate");m.trigger("select",
[r,t]);n.close()});q.click(function(r){r.preventDefault();m.trigger("cancel");n.close()})}});this.data("$dialog",d("#"+k));return this.data("$dialog")}.call(this)}})(jQuery);var CRMSettings=function(d){CRMSettings=function(a){this.$wrapper=a.$wrapper;this.$sidebar=a.$sidebar;this.$activeMenuItem=!1;this.initClass()};CRMSettings.prototype.initClass=function(){this.initMenu()};CRMSettings.prototype.initMenu=function(){function a(f){if(e.length&&e[0]==f[0])return!1;e.length&&e.removeClass("selected");f.addClass("selected");e=f}function b(f){var g;f&&(g=c.find('a[href="'+f+'"]:first'));if(g&&g.length)a(g.closest("li"));else{f=c.find("a[href^='"+d.crm.app_url+"']");var h=
location.pathname,l=0,k=0;f.each(function(m){var n=d(this).attr("href"),p=n.length;0<=h.indexOf(n)&&p>l&&(l=p,k=m)});if(k||0===k)g=f.eq(k),a(g.closest("li"))}}var c=this.$sidebar,e=c.find("li.selected:first")||!1;e.length||b();c.on("click","li > a",function(){var f=d(this),g=f.attr("href");g&&"javascript:"!=g.substr(0,11)&&!f.hasClass("js-no-highlight")&&(a(f.closest("li")),d.crm.title.set(f.text()))})};return CRMSettings}(jQuery);var CRMSettingsCompanies=function(d){CRMSettingsCompanies=function(a){this.$wrapper=a.$wrapper;this.$footer=this.$wrapper.find(".js-footer-actions");this.$company=this.$wrapper.find(".c-company-section");this.$taxList=this.$company.find(".c-options-list");this.$logoWrapper=this.$wrapper.find(".js-logo-section");this.$submitButton=this.$wrapper.find(".js-submit-button");this.locales=a.locales;this.company_id=a.company_id;this.tax_option_template=a.tax_option_template;this.empty_class="is-empty";this.start_left=
0;this.logo=!1;this.files=[];this.initClass()};CRMSettingsCompanies.prototype.initClass=function(){var a=this;a.initTabs();a.initTaxActions();a.initLogoChange();a.initSubmit();a.initDeleteCompany();a.initTemplatesSection();a.$wrapper.on("change","input, select, textarea",function(){a.toggleButton(!0)})};CRMSettingsCompanies.prototype.initTabs=function(){var a=this.$wrapper.find(".c-tabs-wrapper"),b=this.$wrapper.find(".c-companies-wrapper"),c=b.find(".c-companies-list"),e=c.find(".c-company.selected");
(function(){function f(){d.contains(document,a[0])?g():h.off("resize",f)}function g(){var k=a.width()-l-10;b.css("max-width",k+"px")}var h=d(window),l=a.find(".c-add-wrapper").outerWidth(!0);g();h.on("resize",f)})();d.crm.tabSlider({$wrapper:b,$slider:c,$activeSlide:e.length?e:!1});(function(){var f=!1;c.sortable({distance:10,items:"> li",axis:"x",start:function(g,h){},stop:function(){var g={ids:function(){var h=[];c.find(".c-company").each(function(){h.push(d(this).data("id"))});return h.join(",")}()};
f&&f.abort();f=d.post("?module=settings&action=companiesSortSave",g,function(h){}).always(function(){f=!1})}})})()};CRMSettingsCompanies.prototype.initTaxActions=function(){var a=this,b=a.$company.find(".js-tax-name"),c=a.$taxList;a.$company.on("click",".js-delete-option",function(e){e.preventDefault();d(this).closest("li").remove();b.find("li").length||b.attr("required",!1);a.toggleButton(!0)});a.$company.on("click",".js-add-option",function(e){e.preventDefault();d(a.tax_option_template).appendTo(c);
b.attr("required",!0);a.toggleButton(!0)});(function(){c.sortable({handler:".js-sort-toggle",helper:"clone",distance:10,items:"> li",axis:"y",start:function(e,f){},stop:function(e,f){}})})()};CRMSettingsCompanies.prototype.initLogoChange=function(){function a(k){k=k[0];if(k.type.match(/^image\/(png|jpe?g|gif)$/)){var m=new FileReader;m.onload=function(n){l.attr("src",n.target.result);b.$logoWrapper.removeClass(b.empty_class)};m.readAsDataURL(k);b.logo=k}}var b=this,c=!1,e=!1,f=b.$logoWrapper,g=f.find(".js-drop-area"),
h=g.find(".js-field"),l=f.find(".js-image");g.on("drop",function(k){k.stopPropagation();k=k.originalEvent.dataTransfer.files;k.length&&(a(k),b.toggleButton(!0))});h.on("change",function(){var k=this.files;k.length&&(a(k),b.toggleButton(!0))});f.on("click",".js-delete-logo",function(k){k.preventDefault();l.attr("src","");if(k=h.attr("name")){var m=d('<input type="hidden" />').attr("name",k).val("delete");h.attr("name","").data("name",k).after(m)}f.addClass(b.empty_class);b.logo=!1;b.toggleButton(!0)});
d(document).on("myDragEnter",function(){d.contains(document,g[0])?g.addClass("is-highlighted"):d(document).off("myDragEnter",watcher)});d(document).on("myDragLeave",function(){d.contains(document,g[0])?g.removeClass("is-highlighted"):d(document).off("myDragLeave",watcher)});g.on("dragover",function(k){k.preventDefault();c?clearTimeout(c):e||(e=!0,g.addClass("is-hover"));c=setTimeout(function(){c=null;e=!1;g.removeClass("is-hover")},100)})};CRMSettingsCompanies.prototype.initSubmit=function(){var a=
this,b=a.$wrapper.find(".js-form"),c=a.$wrapper.find(".js-errors-place"),e=a.$taxList,f=!1;b.on("submit",function(g){function h(){e.find(".c-tax-option").each(function(m){var n=d(this),p=n.find(".js-type");n=n.find(".js-percent");p.attr("name","company[tax_options]["+m+"][tax_type]");n.attr("name","company[tax_options]["+m+"][tax_percent]")});return b.serializeArray()}function l(m){m=m?m:[];d.each(m,function(n,p){n=p.name;p=p.value;var q=a.$wrapper.find('[name="'+n+'"]');q.removeClass("error");q.parent().find("span.errormsg").remove();
"contact[firstname]"!==n||q.is(":visible")||(q=a.$wrapper.find(".js-contact-autocomplete"));var r=d("<span class='c-error' />").addClass("errormsg").text(p);q.length&&!q.hasClass("error")?(q.parent().append(r),q.addClass("error").one("focus click change",function(){q.removeClass("error");r.remove()})):(c.append(r),b.one("submit",function(){remove(r)}))})}g.preventDefault();if(!f){f=!0;g=function(m){var n=new FormData;d.each(m,function(p,q){n.append(q.name,q.value)});d.each(a.files,function(p,q){n.append("images["+
q.code+"]",q.file)});a.logo&&n.append("logo",a.logo);(m=(m=document.cookie.match(/(?:^|; )_csrf=([^;]*)/))?decodeURIComponent(m[1]):"")&&n.append("_csrf",m);return n}(h());var k=d(a.locales.loading);k.insertAfter(a.$submitButton);d.ajax({url:"?module=settings&action=companiesSave",data:g,dataType:"json",processData:!1,contentType:!1,type:"POST",success:function(m){"ok"===m.status?(d(a.locales.saved_html).insertAfter(a.$submitButton),a.company_id?d.crm.content.reload():d.crm.content.load(d.crm.app_url+
"settings/companies/"+m.data.id+"/")):m.errors&&l(m.errors)}}).always(function(){k.remove();f=!1})}});b.on("keydown keypress keyup","input",function(g){13===g.keyCode&&g.preventDefault()})};CRMSettingsCompanies.prototype.initDeleteCompany=function(){var a=this,b=!1;a.$wrapper.on("click",".js-company-delete",function(c){c.preventDefault();b||(b=!0,d.post("?module=settings&action=companyDeleteDialog",{id:a.company_id},function(e){new CRMDialog({html:e,options:{onDelete:function(){d.crm.content.load(d.crm.app_url+
"settings/companies/")}}})}).always(function(){b=!1}))})};CRMSettingsCompanies.prototype.toggleButton=function(a){var b=this.$submitButton,c=this.$footer.find(".js-edit-actions");a?(b.addClass("yellow").removeClass("green"),c.show()):(b.removeClass("yellow").addClass("green"),c.hide())};CRMSettingsCompanies.prototype.initTemplatesSection=function(){function a(l,k){h&&h.abort();h=d.post("?module=settings&action=companiesRenderParams",{company_id:k,template_id:l},function(m){g.html(m);g.find(".c-color-section").each(function(){b(d(this))});
g.find(".js-image-section").each(function(){c(d(this))})}).always(function(){h=!1})}function b(l){var k=l.find(".c-colors"),m=l.find(".js-color-field"),n=k.find(".is-active"),p=function(r){p=function(t){this.$wrapper=t.$wrapper;this.$field=m;this.$icon=this.$wrapper.find(".js-toggle");this.$colorPicker=this.$wrapper.find(".js-color-picker");this.farbtastic=this.is_opened=!1;this.initClass()};p.prototype.initClass=function(){function t(){n.length&&(n.removeClass("is-active"),n=!1)}function u(w){r.contains(document,
v.$wrapper[0])?27===w.keyCode&&v.is_opened&&v.displayToggle(!1):r(document).off("keyup",u)}var v=this;v.farbtastic=r.farbtastic(v.$colorPicker,function(w){v.$field.val()!==w&&(t(),v.$field.val(w).change())});v.$wrapper.data("colorPicker",v);v.$field.on("change keyup",function(){var w=r(this).val();v.$icon.css("background-color",w);v.farbtastic.setColor(w)});v.$icon.on("click",function(w){w.preventDefault();v.displayToggle(!v.is_opened)});v.$field.on("focus",function(){v.is_opened||v.displayToggle(!0)});
v.$field.on("keyup",t);r(document).on("keyup",u)};p.prototype.displayToggle=function(t){t?(this.$wrapper.removeClass("is-hidden"),this.is_opened=!0):(this.$wrapper.addClass("is-hidden"),this.is_opened=!1)};return p}(jQuery),q=new p({$wrapper:l.find(".js-toggle-wrapper").first()});k.on("click",".js-set-color",function(r){r.preventDefault();r=d(this);n.length&&n.removeClass("is-active");r.addClass("is-active");n=r;r=r.data("color");m.val(r).change();q.is_opened&&q.displayToggle(!1)});m.trigger("change")}
function c(l){function k(u){u=u[0];if(u.type.match(/^image\/(png|jpe?g|gif)$/)){var v=new FileReader;v.onload=function(w){t.attr("src",w.target.result);l.removeClass(e.empty_class)};v.readAsDataURL(u);u={code:l.data("code"),type:"param_image",file:u};e.files.push(u);m();l.data("file",u)}}function m(){var u=l.data("file");u&&(u=e.files.indexOf(u),e.files.splice(u,1),l.data("file",!1))}var n=!1,p=!1,q=l.find(".js-drop-area"),r=q.find(".js-field"),t=l.find(".js-image");q.on("drop",function(u){u.stopPropagation();
u=u.originalEvent.dataTransfer.files;u.length&&(k(u),e.toggleButton(!0))});r.on("change",function(){var u=this.files;u.length&&(k(u),e.toggleButton(!0))});l.on("click",".js-delete-image",function(u){u.preventDefault();t.attr("src","");if(u=r.attr("name")){var v=d('<input type="hidden" />').attr("name",u).val("delete");r.attr("name","").data("name",u).after(v)}l.addClass(e.empty_class);m();e.toggleButton(!0)});d(document).on("myDragEnter",function(){d.contains(document,q[0])?q.addClass("is-highlighted"):
d(document).off("myDragEnter",watcher)});d(document).on("myDragLeave",function(){d.contains(document,q[0])?q.removeClass("is-highlighted"):d(document).off("myDragLeave",watcher)});q.on("dragover",function(u){u.preventDefault();n?clearTimeout(n):p||(p=!0,q.addClass("is-hover"));n=setTimeout(function(){n=null;p=!1;q.removeClass("is-hover")},100)})}var e=this,f=e.$wrapper.find(".c-templates-section"),g=f.find(".js-template-options-wrapper"),h=!1;(function(){var l=f.find(".js-template-wrapper.is-active");
f.on("click",".js-template-wrapper",function(k){k.preventDefault();k=d(this);if(!k.hasClass("is-active")){var m=k.data("id");k.find(".js-field").attr("checked",!0).trigger("change");l.length&&l.removeClass("is-active");l=k.addClass("is-active");a(m,e.company_id)}})})();(function(){var l=function(k){l=function(m){this.$wrapper=m.$wrapper;this.$slider=m.$slider;this.$activeSlide=m.$activeSlide||!1;this.type_class=!1;this.left=0;this.slider_w=this.wrapper_w=!1;this.initClass()};l.prototype.initClass=
function(){function m(){k.contains(document,n.$wrapper[0])?n.wrapper_w!==n.$wrapper.outerWidth()&&n.reset():p.off("resize",m)}var n=this,p=k(window);n.detectSliderWidth();n.initStartPosition();p.on("resize",m);n.$wrapper.on("click",".c-slider-arrow",function(q){q.preventDefault();q=k(this);q.hasClass("left")&&n.moveSlider(!1);q.hasClass("right")&&n.moveSlider(!0)})};l.prototype.initStartPosition=function(){var m=0;if(this.$activeSlide.length){var n=this.$activeSlide.outerWidth(),p=Math.floor(Math.abs(this.$wrapper.offset().left-
this.$activeSlide.offset().left));p+n>this.wrapper_w&&(m=p-40)}m?(this.start_left=m,this.moveSlider(!0,m)):this.showArrows()};l.prototype.detectSliderWidth=function(){this.wrapper_w=this.$wrapper.outerWidth();this.slider_w=this.$slider.outerWidth()};l.prototype.showArrows=function(){function m(p){n.type_class&&n.$wrapper.removeClass(n.type_class);p&&(n.$wrapper.addClass(p),n.type_class=p)}var n=this;0<=n.left?n.wrapper_w<n.slider_w?m("type-1"):m():n.wrapper_w<n.slider_w-Math.abs(n.left)?m("type-2"):
m("type-3")};l.prototype.setLeft=function(m){0<Math.abs(m)||(m=0);this.$slider.css({"-webkit-transform":"translate("+(m?m+"px":0)+", 0)",transform:"translate("+(m?m+"px":0)+", 0)"});this.left=m};l.prototype.moveSlider=function(m,n){n=n?n:parseInt(this.wrapper_w/2);var p=this.slider_w-this.wrapper_w,q=0;0<p&&(q=Math.abs(this.left)+(m?n:-n),q>p?q=p:0>q&&(q=0));this.setLeft(-q);this.showArrows()};l.prototype.reset=function(){this.setLeft(0);this.detectSliderWidth();this.showArrows()};return l}(d);new l({$wrapper:f.find(".c-templates-slider"),
$slider:f.find(".c-templates-list")})})();f.find(".c-color-section").each(function(){b(d(this))});f.find(".js-image-section").each(function(){c(d(this))})};return CRMSettingsCompanies}(jQuery),CRMCompanyDeleteDialog=function(d){CRMCompanyDeleteDialog=function(a){this.$wrapper=a.$wrapper;this.company_id=a.company_id;this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMCompanyDeleteDialog.prototype.initClass=function(){this.initDelete()};CRMCompanyDeleteDialog.prototype.initDelete=function(){function a(){var h=
{data:[],errors:[]},l=f.serializeArray();d.each(l,function(k,m){h.data.push(m)});return h}function b(h,l){l=l?l:[];if(h){var k=Object.keys(h);d.each(k,function(m,n){l.push({name:n,value:h[n]})})}d.each(l,function(m,n){m=n.value;var p=e.$form.find('[name="'+n.name+'"]');if(p.length&&!p.hasClass("error")){var q=d("<span />").addClass("errormsg").text(m);e.$wrapper.append(q);p.addClass("error").one("focus click change",function(){p.removeClass("error");q.remove()})}})}function c(h){g||(g=!0,d.post("?module=settings&action=companyDelete",
h,function(l){"ok"===l.status?d.crm.content.load(d.crm.app_url+"settings/companies/"):b(l.errors)},"json").always(function(){g=!1}))}var e=this,f=e.$wrapper.find("form"),g=!1;f.on("submit",function(h){h.preventDefault();h=a();h.errors.length?b(!1,h.errors):c(h.data)})};return CRMCompanyDeleteDialog}(jQuery);var CRMSettingsCurrencies=function(d){CRMSettingsCurrencies=function(a){this.$wrapper=a.$wrapper;this.$currenciesList=this.$wrapper.find(".js-currencies-list");this.$currencySelect=this.$wrapper.find(".js-add-currency");this.currencies_is_locked=a.currencies_is_locked;this.currency_template_html=a.currency_template_html;this.copy_shop_currencies_dialog_html=a.copy_shop_currencies_dialog_html;this.locales=a.locales;this.currencies=a.currencies;this.initClass()};CRMSettingsCurrencies.prototype.initClass=
function(){this.currencies_is_locked||(this.initCurrencyAdd(),this.initCurrencyRemove(),this.initCurrenciesSort(),this.initChangePrimary(),this.initCurrencyEdit());this.initShopToggle()};CRMSettingsCurrencies.prototype.initCurrencyAdd=function(){function a(c,e){c=c.toLowerCase();b.$currencySelect.find("option").each(function(){var f=d(this);f.attr("value").toLowerCase()===c&&f.attr("disabled",!!e)})}var b=this;b.$currencySelect.on("change",function(){var c=d(this),e=c.val(),f=b.currencies[e],g=f.title;
f=f.sign;c.attr("disabled",!0);c=d(b.currency_template_html);c.data("code",e);c.find(".js-name").text(g);c.find(".js-current-code").text(e);c.find(".js-sign").text(f);c.find(".js-save-currency").addClass("js-save-new");c.addClass("is-edit");b.$currenciesList.append(c);c.find(".c-rate").select()}).on("removeCurrency",function(c,e){a(e)})};CRMSettingsCurrencies.prototype.initCurrencyRemove=function(){var a=this,b=!1;a.$wrapper.on("click",".js-remove-currency",function(c){function e(){b||(b=!0,d.post("?module=settings&action=currenciesDelete",
{code:h},function(l){"ok"==l.status&&(a.$currencySelect.trigger("removeCurrency",h),f.remove())}).always(function(){b=!1}))}c.preventDefault();var f=d(this).closest(".c-currency"),g=f.data("title"),h=f.data("code");if(!h)return!1;(function(){if(!b){b=!0;var l={title:a.locales.confirm_delete_title.replace("%currency_name",g),text:a.locales.confirm_delete_text,ok_button:a.locales.confirm_delete_button};d.post("?module=dialogConfirm",l,function(k){new CRMDialog({html:k,onConfirm:function(){e()}})}).always(function(){b=
!1})}})()})};CRMSettingsCurrencies.prototype.initCurrenciesSort=function(){function a(){var e=[];b.$currenciesList.find(".c-currency").each(function(){var f=d(this).data("code");f&&e.push(f)});return e}var b=this,c=!1;b.$currenciesList.sortable({distance:10,handle:".js-sort-toggle",helper:"clone",items:"> .c-currency",axis:"y",stop:function(){c&&c.abort();var e={codes:a()};c=d.post("?module=settings&action=currenciesSort",e,function(f){}).always(function(){c=!1})}})};CRMSettingsCurrencies.prototype.initShopToggle=
function(){function a(){"checked"===g.attr("checked")?l?d.crm.confirm.show({title:f.locales.confirm_shop_title,text:f.locales.confirm_shop_text,button:f.locales.confirm_shop_button,onConfirm:function(){e(!0)},onCancel:b}):c():e(!1)}function b(){h||(h=!0,g.iButton("toggle",!1),h=!1)}function c(){var k=(new CRMDialog({html:f.copy_shop_currencies_dialog_html})).$wrapper.find("form");k.on("submit",function(m){m.preventDefault();h||(h=!0,g.attr("disabled",!0),m=k.serializeArray(),d.post("?module=settings&action=currenciesShopCopy",
m,function(){d.crm.content.reload()}).always(function(){g.iButton("disable");h=!1}))});k.on("click",".js-cancel-button",b)}function e(k){h||(h=!0,g.attr("disabled",!0),d.post("?module=settings&action=currenciesShopCopy",k?{}:{disable:1},function(m){d.crm.content.reload()}).always(function(){g.iButton("disable");h=!1}))}var f=this,g=f.$wrapper.find(".js-shop-currency-toggle"),h=!1;if(!g.length)return!1;var l=g.data("use-shop")||!1;g.on("change",function(){h||a()});g.iButton({labelOn:"",labelOff:"",
classContainer:"c-ibutton ibutton-container mini"})};CRMSettingsCurrencies.prototype.initChangePrimary=function(){function a(){b||(b=!0,d.post("?module=settings&action=currenciesPrimary",{},function(c){new CRMDialog({html:c,options:{onChange:function(e){d.crm.content.reload()}}})}).always(function(){b=!1}))}var b=!1;this.$wrapper.on("click",".js-change-primary",function(c){c.preventDefault();a()})};CRMSettingsCurrencies.prototype.initCurrencyEdit=function(){var a=this.$currencySelect;this.$wrapper.on("click",
".js-edit-currency",function(b){b.preventDefault();d(this).closest(".c-currency").addClass("is-edit")});this.$wrapper.on("click",".js-save-currency",function(b){function c(k){k=k?k:[];d.each(k,function(m,n){m=n.value;var p=e.find('[name="'+n.name+'"]'),q=d("<span />").addClass("errormsg").text(m);p.length&&!p.hasClass("error")&&(p.closest("div").append(q),p.addClass("error").one("focus click",function(){p.removeClass("error");q.remove()}))})}b.preventDefault();var e=d(this).closest(".c-currency"),
f=!1;b="?module=settings&action=currenciesSave";0<e.find(".js-save-new").length&&(b="?module=settings&action=currenciesAdd");if(!f){f=!0;var g=e.find(".js-rate"),h=g.val();h=h.replace(",",".");String(h).split(".");if(!(0<h)||9999999<h)return g.addClass("error").one("click",function(){g.removeClass("error")}),f=!1;var l={code:e.data("code"),rate:h};d.post(b,l,function(k){"ok"===k.status?e.toggleClass("is-edit").find(".js-rate-text").text(h):k.errors&&c(k.errors)}).always(function(){f=!1;a.attr("disabled",
!1);a.find(":selected").attr("disabled",!0);a.prop("selectedIndex",0)})}});this.$wrapper.on("click",".js-cancel",function(b){b.preventDefault();b=d(this).closest(".c-currency");0<b.find(".js-save-new").length?(b.remove(),a.attr("disabled",!1),a.prop("selectedIndex",0)):b.removeClass("is-edit")});this.$wrapper.on("keyup",".js-rate",function(b){13===b.keyCode&&d(this).closest(".c-currency").find(".js-save-currency").trigger("click")})};return CRMSettingsCurrencies}(jQuery),CRMSettingsCurrenciesPrimary=
function(d){CRMSettingsCurrenciesPrimary=function(a){this.$wrapper=a.$wrapper;this.$toggle=this.$wrapper.find(".js-currencies-toggle");this.dialog=this.$wrapper.data("dialog");this.currency_code=a.currency_code;this.initClass()};CRMSettingsCurrenciesPrimary.prototype.initClass=function(){var a=this,b=!1;a.$wrapper.on("click",".js-change-currency",function(c){c.preventDefault();var e=a.$toggle.val();e!==a.currency_code?b||(b=!0,d.post("?module=settings&action=currenciesPrimarySave",{code:e},function(f){"ok"==
f.status&&(a.dialog.options.onChange(e),a.dialog.close())}).always(function(){b=!1})):a.dialog.close()})};return CRMSettingsCurrenciesPrimary}(jQuery);var CRMSettingsFunnel=function(d){CRMSettingsFunnel=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$stagesSection=this.$wrapper.find(".c-stages-section");this.$stages=this.$stagesSection.find(".c-stages-list");this.funnel_id=a.funnel_id;this.stage_html=a.stage_html;this.locales=a.locales;this.initClass()};CRMSettingsFunnel.prototype.initClass=function(){var a=this;a.initSave();a.initDelete();a.initColorSection();a.initStagesSection();a.initNoAccessList();a.$form.on("input",
function(){a.toggleButton(!0)})};CRMSettingsFunnel.prototype.initColorSection=function(){function a(k){var m=g.find(".c-stage .c-ornament .svg-icon"),n=m.length;if(4===k.length||7===k.length){var p=(new d.crm.color(k)).getRange();b.val(p[0]);c.val(p[1]);m.each(function(q){q=p.getColor(Math.floor(100*(q+1)/n));var r=d(this),t=r.find("svg");t.length?t.find("polygon").css("fill",q):r.data("color",q)})}}var b=this.$wrapper.find(".js-start-color-field"),c=this.$wrapper.find(".js-end-color-field"),e=this.$wrapper.find(".c-color-section .c-colors"),
f=this.$wrapper.find(".c-color-section .js-color-field"),g=this.$wrapper.find(".c-color-section .c-stages"),h=e.find(".is-active"),l=function(k){l=function(m){this.$wrapper=m.$wrapper;this.$field=f;this.$icon=this.$wrapper.find(".js-toggle");this.$colorPicker=this.$wrapper.find(".js-color-picker");this.farbtastic=this.is_opened=!1;this.initClass()};l.prototype.initClass=function(){function m(){h.length&&(h.removeClass("is-active"),h=!1)}var n=this;n.farbtastic=k.farbtastic(n.$colorPicker,function(p){n.$field.val()!==
p&&(m(),n.$field.val(p).change())});n.$wrapper.data("colorPicker",n);n.$field.on("change keyup",function(){var p=k(this).val();n.$icon.css("background-color",p);n.farbtastic.setColor(p)});n.$icon.on("click",function(p){p.preventDefault();n.displayToggle(!n.is_opened)});n.$field.on("click",function(){n.displayToggle(!n.is_opened)});n.$field.on("keyup",m)};l.prototype.displayToggle=function(m){m?(this.$wrapper.removeClass("is-hidden"),this.is_opened=!0):(this.$wrapper.addClass("is-hidden"),this.is_opened=
!1)};return l}(jQuery);e.on("click",".js-set-color",function(k){k.preventDefault();k=d(this);h.length&&h.removeClass("is-active");k.addClass("is-active");h=k;k=k.data("color");f.val(k).change()});f.on("change",function(){a(f.val())});new l({$wrapper:this.$wrapper.find(".js-toggle-wrapper").first()});f.change();d.crm.renderSVG(this.$wrapper)};CRMSettingsFunnel.prototype.initStagesSection=function(){function a(f){function g(h){function l(){var q=parseInt(m.val()),r=parseInt(p.val()),t="";0<q&&0<r&&
(t=q*r);n.val(t)}function k(q){q?(h.addClass("is-extended"),m.focus()):(h.removeClass("is-extended"),m.val(""),n.val(""),b.toggleButton(!0))}var m=h.find(".js-visible-time-field"),n=h.find(".js-hidden-time-field"),p=h.find(".js-time-period-select");h.on("click",".js-show-time",function(){k(!0)});h.on("click",".js-remove-limit",function(){k(!1)});m.on("change",l);p.on("change",l);m.on("keyup",function(){var q=d(this),r=q.val();r=parseInt(r.replace(",","").replace(".",""));isNaN(r)?q.val(""):r?q.val(r):
q.val("")});(function(){var q=n.val();q&&0<parseInt(q)&&(0===parseInt(q)%24?(p.val("24"),m.val(parseInt(q)/24)):p.val("1"))})()}f.find(".js-time-limit-wrapper").each(function(){g(d(this))})}var b=this,c=b.$stagesSection,e=b.$stages;e.on("click",".js-delete-stage",function(f){f.preventDefault();1<b.$stages.find("li").length&&d(this).closest(".c-stage").remove();b.toggleButton(!0)});e.on("keydown keypress keyup","input",function(f){13===f.keyCode&&f.preventDefault()});c.on("click",".js-add-stage",function(f){f.preventDefault();
f=d(b.stage_html);b.$stages.append(f);a(f);b.toggleButton(!0)});e.sortable({distance:10,handle:".js-sort-toggle",helper:"clone",items:"> li",axis:"y",start:function(f,g){},stop:function(f,g){b.toggleButton(!0)}});a(e)};CRMSettingsFunnel.prototype.initSave=function(){function a(){var g=c.$form.serializeArray();c.$stages.find("li").each(function(h){var l=d(this),k=l.data("id");g.push({name:"stages["+h+"][name]",value:l.find(".js-name-field").val()});k&&g.push({name:"stages["+h+"][id]",value:k})});return g}
function b(g){f.removeClass("yes").removeClass("no").addClass("loading").show();d.post("?module=settings&action=funnelSave",g,function(h){"ok"===h.status?(f.removeClass("loading").addClass("yes").show(),d.crm.content.load(d.crm.app_url+"settings/funnels/"+h.data.id+"/")):f.hide()},"json").always(function(){e=!1})}var c=this,e=!1,f=c.$wrapper.find(".js-loading");c.$form.on("submit",function(g){g.preventDefault();!e&&(g=a())&&(e=!0,b(g))})};CRMSettingsFunnel.prototype.initDelete=function(){function a(){var e=
{id:b.funnel_id};c||(c=!0,d.post("?module=settings&action=funnelDelete",e,function(f){d.crm.content.load(d.crm.app_url+"settings/funnels/")},"json").always(function(){c=!1}))}var b=this,c=!1;b.$wrapper.on("click",".js-delete-funnel",function(e){e.preventDefault();d.crm.confirm.show({title:b.locales.delete_confirm_title,text:b.locales.delete_confirm_text,button:b.locales.delete_confirm_button,onConfirm:a})})};CRMSettingsFunnel.prototype.toggleButton=function(a){var b=this.$wrapper.find(".js-funnel-save-button"),
c=this.$wrapper.find(".js-hidden-actions");a?(b.removeClass("green").addClass("yellow"),c.show()):(b.removeClass("yellow").addClass("green"),c.hide())};CRMSettingsFunnel.prototype.initNoAccessList=function(){var a=this.$wrapper.find(".js-no-access-wrapper");a.on("click",".js-show-access-list",function(b){b.preventDefault();a.addClass("is-active")});a.on("click",".js-hide-access-list",function(b){b.preventDefault();a.removeClass("is-active")})};return CRMSettingsFunnel}(jQuery);var CRMSettingsFunnels=function(d){CRMSettingsFunnels=function(a){this.$wrapper=a.$wrapper;this.initClass()};CRMSettingsFunnels.prototype.initClass=function(){this.initTabs()};CRMSettingsFunnels.prototype.initTabs=function(){var a=this.$wrapper.find(".js-funnels-tabs"),b=this.$wrapper.find(".c-funnels-wrapper"),c=b.find(".c-funnels-list"),e=c.find(".c-funnel.selected");(function(){function f(){d.contains(document,a[0])?g():h.off("resize",f)}function g(){var k=a.width()-l-10;b.css("max-width",k+"px")}
var h=d(window),l=a.find(".c-add-wrapper").outerWidth(!0);g();h.on("resize",f)})();d.crm.tabSlider({$wrapper:b,$slider:c,$activeSlide:e.length?e:!1});(function(){var f=!1;c.sortable({distance:10,items:"> li",axis:"x",stop:function(){var g={ids:function(){var h=[];c.find(".c-funnel").each(function(){h.push(d(this).data("id"))});return h.join(",")}()};f&&f.abort();f=d.post("?module=settings&action=funnelsSortSave",g,function(h){}).always(function(){f=!1})}})})()};return CRMSettingsFunnels}(jQuery);var crmSettingsField=function(d){var a=function(b){this.$wrapper=b.$wrapper;this.initClass()};a.prototype.initClass=function(){this.initSortable();this.bindEvents()};a.prototype.initSortable=function(){function b(l){return l.find(".field").map(function(){return d.trim(d(this).data("id"))||""}).toArray()}function c(l,k){g&&(g.abort(),g=null);return d.post(l,k,function(){g=null})}var e=d.crm.app_url+"?module=settings&action=fieldSaveSort",f,g=!1,h=this.$wrapper.find(".crm-other-fields");h.sortable({handle:".sort",
items:".field",axis:"y",tolerance:"pointer",delay:200,start:function(l,k){f=k.item.index()},stop:function(l,k){f!=k.item.index()&&(l=b(h),c(e,{fields:l}))}})};a.prototype.bindEvents=function(){var b=d.crm.app_url+"?module=settings&action=fieldEdit",c=null;this.$wrapper.on("click",".crm-edit-field-link",function(){var e=d(this);c&&(c.abort(),c=null);c=d.post(b,{id:e.data("id")||null},function(f){new CRMDialog({html:f})})})};return a}(jQuery);var crmSettingsFieldEdit=function(d){var a=function(b){this.$wrapper=b.$wrapper;this.$form=this.$wrapper.find("form");this.dialog=this.$wrapper.data("dialog");this.field=b.field||null;this.locales=b.locales;this.initClass()};a.prototype.initClass=function(){var b=this.$form.find(".crm-local-input-wrapper").eq(0).find("input"),c=b.val();b.focus().val("").val(c);this.bindEvents();this.editSubFields();this.field||this.initIDAutoFiller()};a.prototype.bindEvents=function(){var b=this.$form;b.on("change",
".crm-field-type-select",function(){var c=d(this).val(),e=b.find(".crm-values-textarea-wrapper").hide();"Select"!==c&&"Radio"!==c||e.show()});b.on("click",".crm-add-name-another-language",function(){var c=d(this),e=c.data("id"),f=c.data("nameRegion"),g=b.find(".crm-local-input-wrapper"),h=g.clone();h.find("input").attr("name","name["+e+"]").val("").attr("disabled",!1).attr("data-main-locale","").attr("data-error-id",e).removeClass("error").end().find(".crm-name-region").text(f).end().find(".errormsg").text("").end().insertAfter(g);
h.find("input").focus();c.hide();0>=b.find(".crm-add-name-another-language:not(:hidden)").length&&b.find(".crm-add-name-another-language-wrapper").hide()});this.initSubmit();this.field&&(this.field.editable?this.initDeleteLink():this.initDisableLink())};a.prototype.initSubmit=function(){var b=this,c=null;b.$form.submit(function(e){e.preventDefault();c&&(c.abort(),c=null);c=b.save()})};a.prototype.initDeleteLink=function(){var b=this,c=d.crm.app_url+"?module=settings&action=fieldDeleteConfirm";b.$wrapper.on("click",
".crm-field-delete",function(e){e.preventDefault();d.post(c,{id:b.field.id},function(f){new CRMDialog({html:f,options:{edit_dialog:b.dialog},onOpen:function(){b.dialog.$wrapper.hide()}})})})};a.prototype.initDisableLink=function(){var b=this,c=b.$form,e=null;c.on("click",".crm-field-enable,.crm-field-disable",function(f){f.preventDefault();e&&(e.abort(),e=null);f={enable:d(this).hasClass("crm-field-enable")};e=d.post(c.attr("action"),f,function(g){"ok"==g.status&&(b.dialog.close(),location.href=d.crm.app_url+
"settings/field/")})})};a.prototype.save=function(){var b=this,c=b.$form,e=d(".crm-dialog-edit-field-wrapper").find(".js-save"),f=d('<i class="icon16 loading" style="vertical-align: middle;margin-left: 10px;"></i>');d(".loading").remove();e.prop("disabled",!0);var g=!0;c.find(".errormsg").text("");c.find(".error").removeClass("error");d('[name$="[localized_names]"]').each(function(){var h=d(this);!h.val()&&0>=h.parents(".template").length&&h.closest("tr").find('[name$="[_disabled]"]:checked').length&&
(g=!1,h.addClass("error").parent().append(d('<em class="errormsg"></em>').text(b.locales.field_is_required)))});if(!g)return e.attr("disabled",!1),!1;f.appendTo(e.parent());return d.post(c.attr("action"),c.serialize(),function(h){if("ok"==h.status){d(".loading").remove();var l=d('<i class="icon16 yes" style="vertical-align: middle;margin-left: 10px;"></i>');d.crm.content.reload();l.appendTo(e.parent());setTimeout(function(){b.dialog.close()},1E3)}if("ok"!==h.status&&h.errors){e.removeProp("disabled");
d(".loading").remove();l=0;for(var k=h.errors.length;l<k;l+=1){var m=h.errors[l];if("string"===typeof m)c.find(".errormsg.crm-common-errors").append(m);else if("object"===typeof m)for(var n in m)if(m.hasOwnProperty(n)){var p=c.find('[data-error-id="'+n+'"]');p.addClass("error");p.nextAll(".errormsg:first").text(m[n]);c.one("input, keydown",".error",function(){d(this).removeClass("error").nextAll(".errormsg:first").empty()})}}c.find("[type=submit]").attr("disabled",!1)}})};a.prototype.initIDAutoFiller=
function(){var b,c=this.$form,e=c.find('input[name^="name["][data-main-locale]'),f=c.find('input[name="id_val"]'),g=null;f.on("keydown.check_edited",function(){var h=d(this);h.data("val",h.val())}).on("keyup.check_edited",function(){var h=d(this);h.val()&&h.val()!=h.data("value")&&(h.off(".check_edited"),h.data("edited",1))});if(!f.prop("disabled")&&!f.data("edited"))c.on("keydown.crm-id-auto-filler",'input[name^="name["]',function(){var h=d(this),l=c.find('[type="submit"]'),k=f.next(".loading");
if(h.data("main-locale")||!e.val())f.prop("disabled")||f.data("edited")?c.off(".crm-id-auto-filler"):(l.prop("disabled",!0),k=k.length?k:d('<i class="icon16 loading"></i>'),k.insertAfter(f),b&&clearTimeout(b),b=setTimeout(function(){var m=function(){g&&(g.abort(),g=null);b&&clearTimeout(b);l.prop("disabled",!1);k.remove()};f.data("edited")?m():g=d.post(d.crm.app_url+"?module=settings&action=fieldTransliterate",c.find('input[name^="name["]').serialize(),function(n){m();"ok"!==n.status||f.data("edited")||
f.val(n.data)},"json")},300))})};a.prototype.editSubFields=function(){function b(h){var l=d(".crm-dialog-edit-field-wrapper").find(".js-save");h?(l.removeClass("green").addClass("yellow"),l.removeAttr("disabled")):l.removeClass("yellow").addClass("green")}var c=this,e=d(".crm-dialog-edit-field-wrapper"),f=e.find(".subfields-list > .ui-sortable"),g=1;f.sortable({items:".field-row",handle:".js-subfield-sort",axis:"y",update:function(h){b(!0)}});f.on("click","a.js-add-subfield",function(){var h=f.find(".field-row.template");
h=h.clone().insertBefore(h).removeClass("template").removeClass("hidden");c.dialog.resize();var l="__"+g;g++;h.find("[name]").each(function(){var k=d(this);k.attr("name",k.attr("name").replace(/%FID%/g,l))});h.data("fieldId",l);h.find("select.type-selector").change();b(!0);return!1});e.on("click",".edit",function(){d(this).parents("tr").addClass("editor-on").removeClass("editor-off");b(!0);return!1});e.on("click",".js-delete-subfield",function(){var h=d(this).closest("tr");if(h.hasClass("just-added"))return h.remove(),
!1;d.crm.confirm.show({title:c.locales.delete_subfield_title,text:c.locales.delete_subfield_text,button:c.locales.delete_subfield_button,onConfirm:function(){h.addClass("editor-off").removeClass("editor-on");var l=h.find('input:hidden[name$="[_disabled]"]').attr("name").replace("[_disabled]","[_deleted]");d(".js-field-form-edit").append(d('<input type="hidden" name="" value="1">').attr("name",l));h.children().children(":not(label)").remove();h.find("label").addClass("gray").addClass("strike");b(!0)}})});
f.on("click","a.add-item",function(){c.dialog.resize()});e.on("change","select.type-selector",function(){var h=d(this),l=h.closest("tr"),k=l.closest("table"),m=l.find(".field-advanced-settings").html('<i class="icon16 loading"></i>');d.post(d.crm.app_url+"?module=settings&action=fieldEditor",{ftype:h.val(),fid:l.data("fieldId"),parent:k.data("fieldParent")||"",prefix:k.data("fieldPrefix")},function(n){m.html(n);b(!0)})});e.on("change",":checkbox, .name-input",function(){b(!0)})};return a}(jQuery);var crmSettingsFieldEditSubfieldValues=function(d){var a=function(c){this.$wrapper=d(".subfields-list");this.$hidden=c.hidden;this.$dialog_link=c.dialog_link;this.dialog_url=c.dialog_url;this.locales=c.locales;this.initClass()};a.prototype.initClass=function(){this.initValuesLink()};a.prototype.initValuesLink=function(){var c=this;c.$wrapper.find(c.$dialog_link).on("click",function(){d.get(c.dialog_url,function(e){new CRMDialog({html:e,onOpen:function(f,g){c.editValues(f,g);c.initSubmit(f,g)}})})})};
a.prototype.editValues=function(c,e){var f=c.find("form");c.on("click",".s-add-rule",function(){var g=c.find(".s-new-rule");if(g.length){var h=g.clone();h.removeClass("s-new-rule").show().insertBefore(g);h.find('input[name^="parent"]').attr("disabled",!1);h.find(".s-add-value").click();b(c);h=parseInt(g.find('input[name="parent[]"]').val(),10)+1||1;g.find('input[name="parent[]"]').val(h);g.find('input[name^="parent_value"]').attr("name","parent_value["+h+"]");g.find('input[name^="value"]').attr("name",
"value["+h+"][0]");e.resize()}return!1});c.on("click",".s-add-value",function(){var g=d(this).parents("table:first").find(".s-new-value");if(g.length){var h=g.clone();h.addClass("sortable").removeClass("s-new-value").show().insertBefore(g);h.find("input").attr("disabled",!1);h=g.find("input:first").attr("name");var l=h.lastIndexOf("["),k=(parseInt(h.substr(l+1),10)||0)-1;h=h.substr(0,l)+"["+k+"]";g.find("input:first").attr("name",h)}e.resize();return!1});c.on("click",".s-delete-value",function(){var g=
d(this),h=g.attr("data-id");g=g.parents("tr:first");var l=g.parents("table:first");h&&f.append('<input type="hidden" name="delete[]" value="'+h+'">');g.remove();l.find("tr.sortable:first").length||l.parents("div.field:first").remove();e.resize();return!1});b(c);this.$hidden.val()?c.find("select.otherwise-options").val("hide"):c.find("select.otherwise-options").val("input")};a.prototype.initSubmit=function(c,e){var f=this,g=c.find("form"),h=c.find(".js-save-values"),l=d('<i class="icon16 loading" style="vertical-align: middle;margin-left: 10px;"></i>'),
k=d('<i class="icon16 yes" style="vertical-align: middle;margin-left: 10px;"></i>');g.submit(function(m){m.preventDefault();h.prop("disabled",!0);d(".loading").remove();l.appendTo(h.parent());var n=!0;c.find(".errormsg").remove();c.find(".error").removeClass("error");c.find('[name^="parent_value["]:not(:disabled)').each(function(){this.value||(n=!1,d(this).addClass("error").after(d('<em class="errormsg"></em>').text(f.locales.field_is_required)))});c.find('[name^="value["]:not(:disabled)').each(function(){this.value||
(n=!1,d(this).addClass("error").after(d('<em class="errormsg"></em>').text(f.locales.field_is_required)))});if(!n)return d("#s-field-values").closest(".dialog").find(".dialog-buttons :submit").attr("disabled",!1),!1;"input"==c.find("select.otherwise-options").val()?f.$hidden.val(""):f.$hidden.val("1").closest("td").find('input:checkbox[name$="[required]"]').attr("checked",!1);d.post(g.attr("action"),g.serialize()).done(function(p){d(".loading").remove();k.appendTo(h.parent());"ok"==p.status&&(f.$dialog_link.parents(".field-advanced-settings").find(".show-when-modified").show(),
f.$dialog_link.parents(".field-advanced-settings").find(".hide-when-modified").hide(),setTimeout(function(){e.close()},1E3))})})};var b=function(c,e){c.find(".value table>tbody").sortable({distance:5,helper:"clone",items:"tr.sortable",opacity:.75,axis:"y",tolerance:"pointer"})};return a}(jQuery);var crmSettingsFieldDeleteConfirm=function(d){var a=function(b){this.$wrapper=b.$wrapper;this.$form=this.$wrapper.find("form");this.dialog=this.$wrapper.data("dialog");this.edit_dialog=this.dialog.options.edit_dialog;this.initClass()};a.prototype.initClass=function(){this.bindEvents()};a.prototype.bindEvents=function(){var b=this,c=b.$form;b.$form.find(".crm-cancel").click(function(){b.dialog.close();b.edit_dialog.$wrapper.show()});c.submit(function(e){e.preventDefault();b.save()})};a.prototype.save=
function(){var b=this,c=b.$form;d.post(c.attr("action"),c.serialize(),function(){b.dialog.close();b.edit_dialog.close();location.href=d.crm.app_url+"settings/field/"})};return a}(jQuery);var CRMSettingsSources=function(d){CRMSettingsSources=function(a){this.$wrapper=a.$wrapper;this.messages=a.messages||{};this.messages.enable=this.messages.enable||"";this.messages.disable=this.messages.disable||"";this.source_type=a.source_type;this.initClass()};CRMSettingsSources.prototype.initClass=function(){d.crm.renderSVG(this.$wrapper);this.initTabs();this.initWebFormLinks();this.initDisableLinks()};CRMSettingsSources.prototype.initTabs=function(){var a=this.$wrapper,b=function(e){var f=a.find('.c-tab[data-type="'+
e+'"]'),g=a.find('.c-tab-content[data-type="'+e+'"]');a.find(".c-tab.selected").removeClass("selected");a.find(".c-tab-content").hide();f.addClass("selected");g.show();d.crm.storage.set("crm/settings/source_tab",e)},c=d.crm.storage.get("crm/settings/source_tab");c||(c="email");this.source_type&&(c=this.source_type);b(c);a.on("click",".c-tab-link",function(e){e.preventDefault();b(d(this).closest(".c-tab").data("type"))})};CRMSettingsSources.prototype.initWebFormLinks=function(){this.$wrapper.on("click",
".js-c-web-form-link",function(){d.crm.storage.set("crm/settings/web_form_referrer","settings/sources")})};CRMSettingsSources.prototype.initDisableLinks=function(){var a=this,b=null,c=d.crm.app_url+"?module=settingsSource&action=disable";a.$wrapper.on("click",".js-c-disable-link",function(e){e.preventDefault();var f=d(this),g=f.closest(".c-source");e=g.data("id");var h=g.hasClass("c-is-disabled"),l=g.find(".c-loading");b&&b.abort();l.show();b=d.post(c,{id:e,disabled:h?0:1}).done(function(k){"ok"===
k.status&&(k.data.disabled?(f.text(a.messages.enable),g.addClass("c-is-disabled")):(f.text(a.messages.disable),g.removeClass("c-is-disabled")))}).always(function(){b=null;l.hide()})})};CRMSettingsSources.deleteSource=function(a,b){b=b.messages||{};d.crm.confirm.show({title:b.delete_confirm_title,text:b.delete_confirm_text,button:b.delete_confirm_button,onConfirm:function(){var c=d.crm.app_url+"?module=settings&action=sourceDelete",e=this.$wrapper.find(".crm-loading").show(),f=this.$wrapper.find(".js-confirm-dialog").attr("disabled",
!0);d.post(c,{id:a}).always(function(){d.crm.content.load(d.crm.app_url+"settings/sources/");e.hide();f.attr("disabled",!1)});return!1}})};return CRMSettingsSources}(jQuery);var CRMSettingsSourceEmail=function(d){CRMSettingsSourceEmail=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$button=this.$form.find("[type=submit]");this.source=a.source||{};this.messages=a.messages||{};this.changed=!1;this.submit_xhr=null;this.initClass()};CRMSettingsSourceEmail.prototype.initClass=function(){this.initBlockToggles();this.initStickyButton();this.initSubmit();this.initSecureCheckboxes();this.initChangeListeners();this.initIButton();0<this.source.id&&
this.initDeleteLink();this.initBlocks()};CRMSettingsSourceEmail.prototype.initSecureCheckboxes=function(){var a=this.$form.find(".c-secure-checkbox");a.click(function(){var b=d(this);b.is(":checked")&&a.not(b).attr("checked",!1)})};CRMSettingsSourceEmail.prototype.initChangeListeners=function(){var a=this,b=a.$form;b.on("change","input,textarea,select",function(c){a.setFormChanged();c.isTrigger||CRMSettingsSourceEmail.clearValidateErrors(b)});b.on("keyup","input:text,input:password,textarea",function(c){a.setFormChanged();
c.isTrigger||CRMSettingsSourceEmail.clearValidateErrors(b)})};CRMSettingsSourceEmail.prototype.initBlockToggles=function(){this.$wrapper.find(".js-crm-block-toggle").change(function(){var a=d(this),b=a.closest(".field").find(".js-crm-block");a.is(":checked")?b.show():b.hide()}).trigger("change");this.initDealCreateToggle()};CRMSettingsSourceEmail.prototype.initDealCreateToggle=function(){var a=this.$wrapper;a.find(".crm-source-settings-block-create_deal").on("toggled",function(b,c){b=a.find(".js-responsible-section").data("block_object");
c?b.reload({}):b.reload({funnel_id:0})})};CRMSettingsSourceEmail.prototype.initStickyButton=function(){this.$wrapper.find(".crm-form-buttons").sticky({fixed_css:{bottom:0,"z-index":100},fixed_class:"sticky-bottom-shadow",showFixed:function(a){a.element.css("min-height",a.element.height());a.fixed_clone.empty().append(a.element.children())},hideFixed:function(a){a.fixed_clone.children().appendTo(a.element)},updateFixed:function(a,b){this.width(a.element.width())}})};CRMSettingsSourceEmail.prototype.setFormChanged=
function(a){(a=void 0!==a?a:!0)?this.$button.removeClass("green").addClass("yellow"):this.$button.removeClass("yellow").addClass("green");this.changed=a};CRMSettingsSourceEmail.prototype.clearValidateErrors=function(){var a=this.$form;a.find(".error").removeClass("error");a.find(".crm-errors-block").remove()};CRMSettingsSourceEmail.prototype.initSubmit=function(){var a=this,b=a.$form,c=a.$wrapper.find(".crm-form-buttons").find(".crm-loading"),e=a.$button,f=b.find(".crm-success-status"),g=d.crm.app_url+
"?module=settingsSource&action=save";CRMSettingsSourceEmail.clearValidateErrors(b);b.submit(function(h){function l(){CRMSettingsSourceEmail.showValidateErrors(b,{"":a.messages.connection_failed})}function k(){c.hide();e.prop("disabled",!1);a.submit_xhr=null}h.preventDefault();h=b.serializeArray();h.push({name:"id",value:0<a.source.id?a.source.id:a.source.provider});c.show();e.prop("disabled",!0);a.submit_xhr&&a.submit_xhr.abort();a.submit_xhr=d.post(g,h,null,"json").done(function(m){m?"ok"!=m.status?
CRMSettingsSourceEmail.showValidateErrors(b,m.errors||{}):(a.setFormChanged(!1),f.show().fadeOut(500,function(){m.data.source?d.crm.content.load(d.crm.app_url+"settings/sources/"+m.data.source.id+"/"):d.crm.content.reload()})):(k(),l())}).fail(l).always(k)})};CRMSettingsSourceEmail.prototype.initDeleteLink=function(){var a=this;a.$wrapper.find(".crm-delete-source-link").click(function(b){b.preventDefault();CRMSettingsSources.deleteSource(a.source.id,{messages:a.messages})})};CRMSettingsSourceEmail.prototype.initIButton=
function(){this.$wrapper.find(".js-ibutton").each(function(){var a=d(this);!a.data("iButton")&&a.iButton({labelOn:"",labelOff:"",classContainer:"c-ibutton ibutton-container mini"})})};CRMSettingsSourceEmail.prototype.initBlocks=function(){var a=this.$wrapper,b=a.find(".js-deal-section");a=a.find(".js-responsible-section");b=b.data("block_object");a=a.data("block_object");b.setResponsibleBlock(a)};CRMSettingsSourceEmail.clearValidateErrors=function(a){a.find(".error").removeClass("error");a.find(".crm-errors-block").remove()};
CRMSettingsSourceEmail.showValidateErrors=function(a,b){var c={};d.each(b||{},function(e,f){"params"===e?d.each(f,function(g,h){c["source[params]["+g+"]"]=d.isArray(h)?h:[h]}):c[e?"source["+e+"]":""]=d.isArray(f)?f:[f]});CRMSettingsSourceEmail.clearValidateErrors(a);d.each(c,function(e,f){var g=d('<div class="crm-errors-block"></div>');e=e?a.find('[name="'+e+'"]'):d();e.addClass("error");d.each(f,function(h,l){g.append('<em class="errormsg">'+l+"</em>")});e.length?e.after(g):a.find(".crm-common-errors-block").append(g)})};
return CRMSettingsSourceEmail}(jQuery);var CRMSettingsSourceEmailConnectionTestBlock=function(d){CRMSettingsSourceEmailConnectionTestBlock=function(a){this.$wrapper=a.$wrapper;this.source=a.source||{};this.url=a.url||d.crm.app_url+"?module=settingsSource&action=testConnection";this.initClass()};CRMSettingsSourceEmailConnectionTestBlock.prototype.initClass=function(){var a=this,b=a.$wrapper,c=b.find(".c-test-connection-button-block"),e=c.find(".c-loading"),f=c.find(".c-test-connection-success-message"),g=c.find(".c-test-connection-fail-message"),
h=null,l=b.find(".js-connection-settings-input"),k=b.find(".js-connection-settings-checkbox"),m=b.find(".c-test-connection-button"),n=function(){var p=a.url;h&&h.abort();f.hide();g.hide();e.show();l.attr("disabled",!0);var q=function(){g.show()};d.post(p,function(){var r=function(u){return{name:d.trim(u.attr("name")).match(/^source\[params\]\[(.+)\]$/)[1],value:u.val()}},t=[];l.each(function(){t.push(r(d(this)))});k.each(function(){var u=d(this);u.is(":checked")&&t.push(r(u))});0<a.source.id?t.push({name:"id",
value:a.source.id}):t.push({name:"id",value:a.source.provider});return t}(),null,"json").done(function(r){r&&"ok"==r.status?f.show():(q(),CRMSettingsSourceEmail.showValidateErrors(b,r.errors||{}))}).fail(q).always(function(){h=null;l.attr("disabled",!1);e.hide()})};(function(){var p=l.length,q=function(){var y=0;l.each(function(){0<d.trim(d(this).val()).length&&(y+=1)});return 0>=a.source.id?y==p:y==p-1},r=function(){var y=[];l.each(function(){y.push(d.trim(d(this).val()))});k.each(function(){y.push(d(this).is(":checked")?
"1":"0")});return y.join("@")},t=r(),u=function(){var y=r(),z=y!==t;t=y;return z},v=function(){c.show();m.show();f.hide();g.hide()},w=function(){q()?u()&&v():c.hide()},x=null;l.on("change",w).on("keydown",function(){x&&clearTimeout(x);x=setTimeout(function(){w()},250)});k.on("change",function(){u()&&v()})})();(function(){m.click(function(p){p.preventDefault();n()})})()};return CRMSettingsSourceEmailConnectionTestBlock}(jQuery);var CRMSettingsSourceIm=function(d){CRMSettingsSourceIm=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$button=this.$form.find("[type=submit]");this.source=a.source||{};this.messages=a.messages||{};this.changed=!1;this.submit_xhr=null;this.initClass()};CRMSettingsSourceIm.prototype.initClass=function(){this.initBlockToggles();this.initStickyButton();this.initSubmit();this.initChangeListeners();this.initIButton();0<this.source.id&&this.initDeleteLink()};CRMSettingsSourceIm.prototype.initChangeListeners=
function(){var a=this,b=a.$form;b.on("change","input,textarea,select",function(c){a.setFormChanged();c.isTrigger||CRMSettingsSourceIm.clearValidateErrors(b)});b.on("keyup","input:text,input:password,textarea",function(c){a.setFormChanged();c.isTrigger||CRMSettingsSourceIm.clearValidateErrors(b)})};CRMSettingsSourceIm.prototype.initBlockToggles=function(){this.$wrapper.find(".js-crm-block-toggle").change(function(){var a=d(this),b=a.closest(".field").find(".js-crm-block");a.is(":checked")?b.show():
b.hide()}).trigger("change");this.initDealCreateToggle()};CRMSettingsSourceIm.prototype.initDealCreateToggle=function(){var a=this.$wrapper;a.find(".crm-source-settings-block-create_deal").on("toggled",function(b,c){b=a.find(".js-responsible-section").data("block_object");c?b.reload({}):b.reload({funnel_id:0})})};CRMSettingsSourceIm.prototype.initStickyButton=function(){this.$wrapper.find(".crm-form-buttons").sticky({fixed_css:{bottom:0,"z-index":100},fixed_class:"sticky-bottom-shadow",showFixed:function(a){a.element.css("min-height",
a.element.height());a.fixed_clone.empty().append(a.element.children())},hideFixed:function(a){a.fixed_clone.children().appendTo(a.element)},updateFixed:function(a,b){this.width(a.element.width())}})};CRMSettingsSourceIm.prototype.setFormChanged=function(a){(a=void 0!==a?a:!0)?this.$button.removeClass("green").addClass("yellow"):this.$button.removeClass("yellow").addClass("green");this.changed=a};CRMSettingsSourceIm.prototype.clearValidateErrors=function(){var a=this.$form;a.find(".error").removeClass("error");
a.find(".crm-errors-block").remove()};CRMSettingsSourceIm.prototype.initSubmit=function(){var a=this,b=a.$form,c=a.$wrapper.find(".crm-form-buttons").find(".crm-loading"),e=a.$button,f=b.find(".crm-success-status"),g=d.crm.app_url+"?module=settingsSource&action=save";CRMSettingsSourceIm.clearValidateErrors(b);b.submit(function(h){h.preventDefault();h=b.serializeArray();h.push({name:"id",value:0<a.source.id?a.source.id:a.source.provider});c.show();e.prop("disabled",!0);a.submit_xhr&&a.submit_xhr.abort();
a.submit_xhr=d.post(g,h,null,"json").done(function(l){"ok"===l.status?(a.setFormChanged(!1),f.show().fadeOut(500,function(){l.data.source?d.crm.content.load(d.crm.app_url+"settings/sources/"+l.data.source.id+"/"):d.crm.content.reload()})):CRMSettingsSourceIm.showValidateErrors(b,l.errors||{})}).always(function(){c.hide();e.prop("disabled",!1);a.submit_xhr=null})})};CRMSettingsSourceIm.prototype.initDeleteLink=function(){var a=this;a.$wrapper.find(".crm-delete-source-link").click(function(b){b.preventDefault();
CRMSettingsSources.deleteSource(a.source.id,{messages:a.messages})})};CRMSettingsSourceIm.prototype.initIButton=function(){this.$wrapper.find(".js-ibutton").each(function(){var a=d(this);!a.data("iButton")&&a.iButton({labelOn:"",labelOff:"",classContainer:"c-ibutton ibutton-container mini"})})};CRMSettingsSourceIm.clearValidateErrors=function(a){a.find(".error").removeClass("error");a.find(".crm-errors-block").remove()};CRMSettingsSourceIm.showValidateErrors=function(a,b){var c={};d.each(b||{},function(e,
f){"params"===e?d.each(f,function(g,h){c["source[params]["+g+"]"]=d.isArray(h)?h:[h]}):c[e?"source["+e+"]":""]=d.isArray(f)?f:[f]});CRMSettingsSourceIm.clearValidateErrors(a);d.each(c,function(e,f){var g=d('<div class="crm-errors-block"></div>');e=e?a.find('[name="'+e+'"]'):d();e.addClass("error");d.each(f,function(h,l){g.append('<em class="errormsg">'+l+"</em>")});e.length?e.after(g):a.find(".crm-common-errors-block").append(g)})};return CRMSettingsSourceIm}(jQuery);var CRMSettingsSourceWithContactBlock=function(d){CRMSettingsSourceWithContactBlock=function(a){this.$wrapper=a.$wrapper;this.segments_list_stages=a.segments_list_stages||{};this.init()};CRMSettingsSourceWithContactBlock.prototype.init=function(){this.initAddToSegments()};CRMSettingsSourceWithContactBlock.prototype.initAddToSegments=function(){var a=this.$wrapper,b=this.segments_list_stages,c=a.find(".c-segments-ul-fold-link"),e=a.find(".c-segments-ul");c.click(function(){var f=c.data("state");f=
"fold"===f?"unfold":"fold";var g=(b[f]||{}).link_text||"";c.data("state",f).find(".c-link-text").text(g);"fold"===f?e.slideUp():e.slideDown()})};return CRMSettingsSourceWithContactBlock}(jQuery);var CRMSettingsSourceCreateDealBlock=function(d){CRMSettingsSourceCreateDealBlock=function(a){this.$wrapper=a.$wrapper;this.$funnel=this.$wrapper.find(".js-funnel-id");this.$stage=this.$wrapper.find(".js-stage-id");this.url=d.crm.app_url+"?module=settingsSourceBlock&action=createDeal";this.source=a.source||{};this.ns="."+d.trim(this.$wrapper.attr("id"));this.id=a.id;this.namespace=a.namespace||"";this.class_id=a.class_id||"";this.responsible_block=null;this.initClass();this.$wrapper.data("block_object",
this)};CRMSettingsSourceCreateDealBlock.prototype.setResponsibleBlock=function(a){this.responsible_block=a};CRMSettingsSourceCreateDealBlock.prototype.initClass=function(){var a=this;a.$funnel.on("change"+a.ns,function(){var b=a.$stage.closest("li"),c=b.find(".js-visible-link .js-text");b.find(".menu-v.with-icons").remove();c.find(".funnel-state").remove();c.prepend('<i class="icon16 loading">');a.reload()});a.initFunnelsSelect();a.initStagesSelect()};CRMSettingsSourceCreateDealBlock.prototype.initFunnelsSelect=
function(){var a=this.$wrapper.find(".js-funnels-list"),b=a.find(".js-visible-link"),c=a.find(".js-field"),e=a.find(".menu-v");e.on("click","a",function(){var f=d(this);b.find(".js-text").html(f.html());e.find(".selected").removeClass("selected");f.closest("li").addClass("selected");e.hide();setTimeout(function(){e.removeAttr("style")},200);f=f.data("id");c.val(f).trigger("change")});d.crm.renderSVG(a)};CRMSettingsSourceCreateDealBlock.prototype.initStagesSelect=function(){var a=this.$wrapper.find(".js-stages-list"),
b=a.find(".js-visible-link"),c=a.find(".js-field"),e=a.find(".menu-v");e.on("click","a",function(){var f=d(this);b.find(".js-text").html(f.html());e.find(".selected").removeClass("selected");f.closest("li").addClass("selected");e.hide();setTimeout(function(){e.removeAttr("style")},200);f=f.data("id");c.val(f).trigger("change")});d.crm.renderSVG(a)};CRMSettingsSourceCreateDealBlock.prototype.reload=function(){var a=this,b=a.$stage,c=a.url,e=a.responsible_block;b={id:a.id,funnel_id:a.$funnel.val(),
stage_id:b.val(),namespace:a.namespace};var f=d.Deferred(),g=d.Deferred();d.when(f,g).done(function(h,l){l&&h.setResponsibleBlock(l)});d.get(c,b,function(h){h=d("<div>").html(h);var l=h.find("."+a.class_id);a.$wrapper.replaceWith(l);f.resolve(l.data("block_object"));a.destroy();h.remove()});e?e.reload({funnel_id:b.funnel_id},function(h){g.resolve(h)}):g.resolve()};CRMSettingsSourceCreateDealBlock.prototype.destroy=function(){var a=this;a.$funnel.off(a.ns);a.$wrapper.removeData("block_object");d.each(a,
function(b){delete a[b]})};return CRMSettingsSourceCreateDealBlock}(jQuery);var CRMSettingsSourceResponsibleBlock=function(d){CRMSettingsSourceResponsibleBlock=function(a){this.$wrapper=a.$wrapper;this.$group=this.$wrapper.find(".crm-group-id");this.$user=this.$wrapper.find(".crm-user");this.$user_id=this.$wrapper.find(".crm-responsible-contact_id");this.$user_info=this.$wrapper.find(".crm-user-info-block");this.$user_delete_link=this.$user_info.find(".crm-delete-link");this.url=d.crm.app_url+"?module=settingsSourceBlock&action=responsible";this.ns="."+d.trim(this.$wrapper.attr("id"));
this.source=a.source||{};this.funnel_id=this.source.funnel_id;this.namespace=a.namespace||"";this.class_id=a.class_id||"";this.initClass();this.$wrapper.data("block_object",this)};CRMSettingsSourceResponsibleBlock.prototype.initClass=function(){var a=this,b=a.$wrapper,c=a.$group,e=a.$user,f=a.$user_id,g=a.$user_delete_link,h=a.$user_info,l=f.val(),k=function(){e.show().attr("disabled",!1).attr("required",!0)},m=function(){e.hide().attr("disabled",!0).attr("required",!1)};c.on("change"+a.ns,function(){var n=
d(this),p=n.parents(".crm-fields").find(".js-group-hint");f.val("");"personally"===n.val()?k():(m(),h.hide());"personally"===n.val()||""===n.val()?p.hide():p.show();0<n.val()&&f.val(-n.val());l!=f.val()&&(b.trigger("changeResponsibleUser",[l,f.val()]),l=f.val())});g.on("click"+a.ns,function(n){n.preventDefault();f.val("");k();h.hide()});e.autocomplete({source:d.crm.app_url+"?module=autocomplete&type=user&funnel_id="+a.funnel_id,minLength:0,html:!0,focus:function(){return!1},select:function(n,p){e.val("");
if(0>=p.item.rights)return!1;m();h.show();h.find(".crm-user-icon").css("background-image","url("+p.item.photo_url+")");h.find(".crm-user-name").text(p.item.name).attr("title",p.item.name);f.val(p.item.id);l!=f.val()&&(b.trigger("changeResponsibleUser",[l,f.val()]),l=f.val());return!1}}).data("ui-autocomplete")._renderItem=function(n,p){var q=d("<li />");q.addClass("ui-menu-item-html").append("<div>"+p.value+"</div>").appendTo(n);0<a.funnel_id&&!p.rights&&(q.addClass("is-locked"),q.on("click"+a.ns,
function(r){r.preventDefault();r.stopPropagation()}));return q};e.on("focus"+a.ns,function(){e.data("uiAutocomplete").search(e.val())})};CRMSettingsSourceResponsibleBlock.prototype.reload=function(a,b){var c=this,e=this.$user_info,f=d('<i class="icon16 loading"></i>'),g=c.url;e.is(":visible")&&(c.$user_delete_link.hide(),f.css({marginTop:"-16px",marginRight:"-16px",float:"right"}));e.after(f);a=a||{};a.namespace=c.namespace;"undefined"===typeof a.funnel_id&&(a.funnel_id=c.funnel_id);a.responsible_contact_id=
c.$user_id.val();a.group_id=c.$group.val();f.show();d.get(g,a,function(h){h=d("<div>").html(h);var l=h.find("."+c.class_id);c.$wrapper.replaceWith(l);l=l.data("block_object");b&&b(l);h.remove();c.destroy()})};CRMSettingsSourceResponsibleBlock.prototype.destroy=function(){var a=this;a.$user_delete_link.off(a.ns);a.$group.off(a.ns);a.$wrapper.removeData("block_object");a.$user.data("ui-autocomplete")&&(a.$user.autocomplete("destroy"),a.$user.removeData("ui-autocomplete"));d.each(a,function(b){delete a[b]})};
return CRMSettingsSourceResponsibleBlock}(jQuery);var CRMSettingsForms=function(d){CRMSettingsForms=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$button=this.$form.find("[type=submit]");this.submit_xhr=null;this.initClass()};CRMSettingsForms.prototype.initClass=function(){d.crm.renderSVG(this.$wrapper)};return CRMSettingsForms}(jQuery);var crmSettingsForm=function(d){crmSettingsForm=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find(".crm-form-settings-form");this.$form_fields=this.$wrapper.find(".crm-form-fields");this.$form_available_fields=this.$wrapper.find(".crm-available-fields");this.$confirmation_checkbox=this.$wrapper.find(".crm-confirmation-checkbox");this.$confirmation_enable_text=this.$wrapper.find(".crm-confirmation-enable-text");this.$email_confirm_block=this.$wrapper.find(".crm-form-email-confirm-block");
this.$create_deal_block_wrapper=this.$wrapper.find(".crm-form-settings-block-form_create_deal");this.$button=this.$form.find("[type=submit]");this.$delete_link=this.$wrapper.find(".crm-delete-form-link");this.$copy=this.$wrapper.find(".js-copy.icon16");this.$iframe_textarea=this.$wrapper.find(".crm-iframe-code");this.$available_deal_related_field=this.$form_available_fields.find('.crm-form-field[data-form-field-type="deal"]').add(this.$form_available_fields.find('.crm-form-field[data-id="!deal_description"]')).add(this.$form_available_fields.find('.crm-form-field[data-id="!deal_attachments"]'));
this.$edit_dialog_template=this.$wrapper.find('.crm-settings-form-edit-field-wrapper[data-template="1"]');this.$paragraph_edit_dialog_template=this.$wrapper.find('.crm-settings-form-paragraph-edit-wrapper[data-template="1"]');this.$agreement_checkbox_edit_dialog_tempalte=this.$wrapper.find('.c-settings-form-agreement-checkbox-edit-wrapper[data-template="1"]');this.referrer=d.crm.storage.get("crm/settings/web_form_referrer");d.crm.storage.del("crm/settings/web_form_referrer");this.form=a.form||{};
this.form.params=this.form.params||{};this.form.params.fields=this.form.params.fields||{};this.available_fields=a.available_fields||{};this.lang=a.lang;this.messages=a.messages||{};a=a.default_checked_fields||[];if(0>=this.form.id&&"settings/sources"===this.referrer){var b=a.indexOf("password");0<=b?a[b]="!deal_description":a.push("!deal_description")}this.default_checked_fields=a;this.changed=!1;this.submit_xhr=null;this.initClass()};crmSettingsForm.prototype.initClass=function(){this.initDealCreateCheckbox();
this.renderDealDescription();this.bindEvents();this.initAddNewFieldLink();this.initAvailableFields();this.initDeleteFieldLinks();this.initPreviewButton();this.initFormWidthInput();this.initStickyButton();this.initFields();this.initSubmit();this.initDeleteLink();this.initSortable();this.initIButtons();this.initTextEditor();this.initCopySmartyHelper();this.initIframeTextarea();this.initMessagesBlock();this.initCancelLink();this.initBlocks()};crmSettingsForm.prototype.renderDealDescription=function(a){var b=
this.$form_fields.find('[data-id="!deal_description"]').find("textarea");a||(a=this.getField("!deal_description"));!a||0>=a.checked||!b.length||(a.redactor?b.data("redactor")?(a=b.redactor("core.editor"))&&0<a.length&&a[0].attr("placeholder",b.attr("placeholder")):d.crm.initWYSIWYG(b,{focus:!1,buttons:["bold","italic","underline","link"],plugins:[],maxHeight:100,minHeight:100}):(b.data("redactor")&&b.redactor("core.destroy"),b.show()))};crmSettingsForm.prototype.bindEvents=function(){var a=this;a.$confirmation_checkbox.on("change",
function(){d(this).is(":checked")?a.$email_confirm_block.slideDown(200):a.$email_confirm_block.slideUp(200)});a.$form.on("change","input,textarea,select",function(b){a.setFormChanged();b.isTrigger||a.clearValidateErrors()});a.$form.on("keyup","input:text,textarea",function(b){a.setFormChanged();b.isTrigger||a.clearValidateErrors()});a.$form.find(".crm-iframe-code-block-toggle").click(function(){a.$iframe_textarea.toggle()})};crmSettingsForm.prototype.initDealCreateCheckbox=function(){var a=this,b=
a.referrer,c=function(e){var f=a.$wrapper.find(".js-responsible-section").data("block_object");e?(a.$available_deal_related_field.removeClass("crm-disabled"),a.$wrapper.find(".js-hint-about-deal-fields").hide(),a.$wrapper.find(".js-hint-about-deal-fields").next().addClass("crm-top-bordered"),f.reload({})):(a.$available_deal_related_field.each(function(){var g=d(this).data("id");a.getFormField(g).find(".crm-delete-field-link").trigger("click")}),a.$available_deal_related_field.addClass("crm-disabled"),
a.$wrapper.find(".js-hint-about-deal-fields").show(),a.$wrapper.find(".js-hint-about-deal-fields").next().removeClass("crm-top-bordered"),f.reload({funnel_id:0}))};a.$create_deal_block_wrapper.on("toggled",function(e,f){c(f,!0)});0>=a.form.id&&"settings/sources"===b&&(a.$create_deal_block_wrapper.find(":checkbox").attr("checked",!0).trigger("change"),c(!0,!1))};crmSettingsForm.prototype.setFormChanged=function(a){(a=void 0!==a?a:!0)?this.$button.removeClass("green").addClass("yellow"):this.$button.removeClass("yellow").addClass("green");
this.changed=a};crmSettingsForm.prototype.initPreviewButton=function(){var a=this.$wrapper,b=a.find(".crm-form-preview-submit-button-caption-input"),c=a.find(".crm-form-preview-submit-button"),e=function(f){f?(b.show(),c.hide(),b.val(c.val())):(b.hide(),c.show())};c.click(function(){e(!0)});b.blur(function(){c.val(b.val());e(!1)}).keyup(function(f){f.preventDefault();13==f.keyCode?(c.val(b.val()),e(!1)):27==f.keyCode&&e(!1)})};crmSettingsForm.prototype.initFormWidthInput=function(){var a=this.$wrapper,
b=a.find(".crm-form-width-input"),c=a.find(".crm-form-preview-block");b.keyup(function(e){13==e.keyCode&&(b.val(Math.max(Math.min(parseInt(b.val(),10)||0,600),200)),c.width(b.val()))})};crmSettingsForm.prototype.initStickyButton=function(){this.$wrapper.find(".crm-form-buttons").sticky({fixed_css:{bottom:0,"z-index":100},fixed_class:"sticky-bottom-shadow",showFixed:function(a){a.element.css("min-height",a.element.height());a.fixed_clone.empty().append(a.element.children())},hideFixed:function(a){a.fixed_clone.children().appendTo(a.element)},
updateFixed:function(a,b){this.width(a.element.width())}})};crmSettingsForm.prototype.initTextEditor=function(){var a=this,b=a.$form.find('[name="form[params][confirm_mail_body]"]');b.waEditor({focus:!1,buttons:["formatting","bold","italic","link"],plugins:["fontcolor","fontsize","fontfamily"],callbacks:{keydown:function(c){},change:function(){b.waEditor("sync");a.setFormChanged()}},lang:a.lang})};crmSettingsForm.prototype.initMessagesBlock=function(){var a=this,b=a.$wrapper,c=b.find(".c-settings-messages-block");
b=b.find(".js-deal-section");a.renderToVariantSelectors();c.on("loadEditor",function(){a.renderToVariantSelectors()});b.on("changeResponsibleUser",function(){a.renderToVariantSelectors()})};crmSettingsForm.prototype.renderToVariantSelectors=function(){var a=this.$wrapper.find(".c-settings-messages-block"),b=this.getField("email"),c=b&&0<b.checked,e=function(f,g){var h=f.closest("label");g?(f.data("checked",f.is(":checked")),f.prop("disabled",!0).prop("checked",!1)):f.prop("disabled",!1).prop("checked",
f.data("checked"));f.is(":checked")?h.addClass("bold"):h.removeClass("bold")};a.find(".c-message-to-selector").each(function(){var f=d(this),g=f.find(".c-label");f=f.find(".c-message-to-variants-list");var h=f.find(':checkbox[data-id="client"]');e(h,!c);var l=[];f.find(":checkbox:checked:not(:disabled)").each(function(){var k=d(this).closest("li");l.push(k.find(".c-variant-name-text").text())});l=0<l.length?l.join(", "):g.data("initial_text");g.text(l)})};crmSettingsForm.prototype.getField=function(a,
b){var c=this.form.params.fields,e=c.length,f=null;b="undefined"===typeof b?1:parseInt(b,10)||0;if(0>=b)return null;for(var g=0;g<e;g+=1)if(c[g].id==a&&c[g].checked==b){f=c[g];break}if(!f)return f;f.required=f.required||"";f.captionplace=f.captionplace||"left";f.caption=f.caption||"string"===typeof f.caption?f.caption:f.name;f.placeholder=f.placeholder||"";return f};crmSettingsForm.prototype.getAvailableField=function(a){if(this.available_fields[a]){a=d.extend({},this.available_fields[a]);if("!horizontal_rule"===
a.id||"!paragraph"===a.id)a.captionplace="none";return a}return null};crmSettingsForm.prototype.updateAvailableField=function(a,b){this.available_fields[a]&&d.extend(this.available_fields[a],b)};crmSettingsForm.prototype.addField=function(a,b,c){b=parseInt(b,10)||0;0>=b||!c||(this.deleteField(a,b),c=d.extend({},c,{id:a,checked:b}),this.form.params.fields.push(c))};crmSettingsForm.prototype.deleteField=function(a,b){var c=this.form.params.fields,e=c.length;b=parseInt(b,10)||0;for(var f=[],g=0;g<e;g+=
1)c[g].id==a&&c[g].checked==b||f.push(c[g]);b=0;e=f.length;for(g=0;g<e;g+=1)f[g].id==a&&(b+=1,f[g].checked=b);this.form.params.fields=f};crmSettingsForm.prototype.updateField=function(a,b,c){0>=b||(b=this.getField(a,b),b=d.extend(b,c),this.form.params.fields[a]=b,this.setFormChanged())};crmSettingsForm.prototype.renderField=function(a,b){var c=this.getField(a,b),e=this.$form_fields.find('.crm-form-field:not(.crm-form-field-template)[data-id="'+a+'"][data-checked="'+b+'"]');if(c)if(e.length||(e=this.$form_fields.find('.crm-form-field-template.crm-form-field-template[data-id="'+
a+'"]').clone(),e.removeClass("crm-form-field-template"),e.attr("data-checked",b),e.insertBefore(this.$form_fields.find(".crm-form-field-template:first")),e.show()),"!paragraph"===c.id)e.find(".crm-paragraph").html(c.text||"");else{a=e.find(".crm-caption");b=a.html;var f=(f=c.caption)&&(""+f).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");b.call(a,"<label>"+f+(c.required&&"!captcha"!==c.id?" *":"")+"</label>");e.removeClass("crm-caption-style-none crm-caption-style-above").addClass("crm-caption-style-"+
c.captionplace);e.find(":input:eq(0)").prop("placeholder",c.placeholder||"");"password"===c.id&&e.find(":input:eq(1)").prop("placeholder",c.placeholder_confirm||"");"!deal_description"===c.id&&this.renderDealDescription(c)}else e.remove()};crmSettingsForm.prototype.initFields=function(){var a=this;a.$form_fields.on("click",".crm-caption-col, .crm-input-col",function(b){a.editField(d(this).closest(".crm-form-field"))})};crmSettingsForm.prototype.editField=function(a){var b=a.data("id");a=a.data("checked");
if("!horizontal_rule"!==b){var c={html:"",id:b,checked:a,settingsForm:this};a="!agreement_checkbox"===b?this.$agreement_checkbox_edit_dialog_tempalte.clone():"!paragraph"===b?this.$paragraph_edit_dialog_template.clone():this.$edit_dialog_template.clone();a.removeAttr("data-template").attr("id","crm-settings-dialog-wrapper-"+b);a.appendTo("body");a.show();c.html=a;"!agreement_checkbox"===b?new crmSettingsFormAgreementCheckboxEditDialog(c):"!paragraph"===b?new crmSettingsFormParagraphEditDialog(c):
new crmSettingsFormFieldEditDialog(c)}};crmSettingsForm.prototype.initSubmit=function(){var a=this,b=a.$form,c=b.find(".crm-loading"),e=b.find(".crm-success-status");b.on("keypress","input",function(f){13==f.keyCode&&f.preventDefault()});b.submit(function(f){f.preventDefault();f=b.serializeArray();var g=[];d.each(a.form.params.fields,function(h,l){if(0<l.checked){var k=g.length;d.each(l,function(m,n){"html"!==m&&(g[k]=g[h]||{},g[k][m]=n)})}});f.push({name:"form[params][fields]",value:JSON.stringify(g)});
a.clearValidateErrors();c.show();a.$button.prop("disabled",!0);a.submit_xhr&&a.submit_xhr.abort();a.submit_xhr=d.post(b.attr("action"),f).done(function(h){"ok"!==h.status?a.showValidateErrors(h.errors||{}):(a.setFormChanged(!1),e.show().fadeOut(500),d.crm.content.load(d.crm.app_url+"settings/form/"+h.data.form.id))}).error(function(){a.showValidateErrors({"":a.messages.unknown_server_error})}).always(function(){c.hide();a.$button.prop("disabled",!1)})})};crmSettingsForm.prototype.clearValidateErrors=
function(){var a=this.$form;a.find(".error").removeClass("error");a.find(".crm-errors-block").remove()};crmSettingsForm.prototype.showValidateErrors=function(a){var b=this.$form,c={};d.each(a||{},function(e,f){"params"===e?d.each(f,function(g,h){c["form[params]["+g+"]"]=d.isArray(h)?h:[h]}):c[e?"form["+e+"]":""]=d.isArray(f)?f:[f]});this.clearValidateErrors();d.each(c,function(e,f){var g=d('<div class="crm-errors-block"></div>');e=e?b.find('[name="'+e+'"]'):d();e.addClass("error");d.each(f,function(h,
l){g.append('<em class="errormsg">'+l+"</em>")});e.length?e.after(g):b.find(".crm-common-errors-block").append(g)})};crmSettingsForm.prototype.initDeleteLink=function(){var a=this;a.$delete_link.click(function(b){b.preventDefault();confirm(a.messages.confirm_delete)&&d.post(d.crm.app_url+"?module=settings&action=formDelete",{id:a.form.id},function(){d.crm.content.load(d.crm.app_url+"settings/form")})})};crmSettingsForm.prototype.initSortable=function(){var a=this;a.$form_fields.sortable({distance:5,
helper:"clone",items:".crm-form-field:not(:hidden)",opacity:.75,handle:".sort",tolerance:"pointer",containment:a.$form_fields,update:function(){for(var b=a.form.params.fields,c=b.length,e={},f=[],g=a.$form_fields.find(".crm-form-field:not(.crm-form-field-template)"),h=0;h<c;h+=1)e[b[h].id+"-"+b[h].checked]=h;g.each(function(){var l=d(this),k=l.data("id");l=l.data("checked");f.push(b[e[k+"-"+l]])});a.form.params.fields=f;a.setFormChanged()}})};crmSettingsForm.prototype.initDeleteFieldLinks=function(){var a=
this;a.$wrapper.on("click",".crm-delete-field-link",function(){var b=d(this).closest(".crm-form-field");a.deleteFormField(b)})};crmSettingsForm.prototype.deleteFormField=function(a){if(!(0>=a.length)){var b=this,c=a.data("id"),e=a.data("checked"),f=b.getAvailableField(c);b.$form_available_fields.find('.crm-form-field[data-id="'+c+'"]').removeClass("crm-disabled");b.deleteField(c,e);a.remove();f&&b.updateAvailableField(c,{checked:f.checked-1});"email"===c&&(b.disableIButton(b.$confirmation_checkbox).attr("checked",
!1).trigger("change"),b.$confirmation_enable_text.show(),b.$form_available_fields.find('.crm-form-field[data-id="password"]').addClass("crm-disabled"),a=b.getFormField("password"),b.deleteFormField(a),b.renderToVariantSelectors());"company"===c&&b.$form_available_fields.find(".crm-form-field[data-person-enabled=0][data-company-enabled=1]").each(function(){var g=d(this),h=g.data("id");h=b.getFormField(h);b.deleteFormField(h);g.addClass("crm-disabled")});b.setFormChanged()}};crmSettingsForm.prototype.getFormField=
function(a,b){var c='.%clz%[data-id="%id%"]%extra%:not(.%not_clz%)';a=[["%clz%","crm-form-field"],["%id%",a],["%extra%",void 0!==b?'[data-id="'+b+'"]':""],["%not_clz%","crm-form-field-template"]];b=0;for(var e=a.length;b<e;b+=1)c=c.replace(a[b][0],a[b][1]);return this.$form_fields.find(c)};crmSettingsForm.prototype.initAvailableFields=function(){var a=this,b=a.default_checked_fields,c=a.$form_available_fields;c.on("click",".crm-form-field:not(.crm-disabled)",function(e){a.addFormField(d(this))});
0>=a.form.id&&0<b.length&&d.each(b,function(e,f){e=c.find('.crm-form-field[data-id="'+f+'"]:not(.crm-disabled)');a.addFormField(e)})};crmSettingsForm.prototype.addFormField=function(a){if(!(0>=a.length)){var b=a.data("id"),c=this.getAvailableField(b);this.$form_available_fields.hide();var e=c.checked+1;c.is_multi||a.addClass("crm-disabled");this.getField(c.id,e)||this.addField(b,e,c);this.updateAvailableField(b,{checked:e});"email"===b&&(this.$confirmation_enable_text.hide(),this.enableIButton(this.$confirmation_checkbox),
(a=this.getAvailableField("password"))&&0>=a.checked&&this.$form_available_fields.find('.crm-form-field[data-id="password"]').removeClass("crm-disabled"));"company"===b&&this.$form_available_fields.find(".crm-form-field.crm-disabled[data-person-enabled=0][data-company-enabled=1]").removeClass("crm-disabled");this.renderField(b,e);"!paragraph"===b&&(b=this.$form_fields.find('.crm-form-field[data-id="'+b+'"][data-checked="'+e+'"]'),this.editField(b));this.setFormChanged();this.renderToVariantSelectors()}};
crmSettingsForm.prototype.initAddNewFieldLink=function(){function a(e){d.contains(document,c[0])?27===e.keyCode&&c.is(":visible")&&c.hide():d(document).off("keypress",a)}function b(e){if(d.contains(document,c[0])){var f=d.contains(c[0],e.target);e=c[0]===e.target;!c.is(":visible")||e||f||c.hide()}else d(document).off("keypress",b)}var c=this.$form_available_fields;this.$wrapper.on("click",".crm-add-new-field-link",function(e){e.stopPropagation();c.toggle()});d(document).on("keydown",a).on("click",
b)};crmSettingsForm.prototype.initIButtons=function(){var a=this;a.$wrapper.find(".js-ibutton").each(function(){a.initIButton(d(this))})};crmSettingsForm.prototype.initIButton=function(a){return a.data("iButtonInit")?a:a.iButton({labelOn:"",labelOff:"",classContainer:"c-ibutton ibutton-container mini"}).data("iButtonInit",1)};crmSettingsForm.prototype.disableIButton=function(a){return this.initIButton(a).iButton("disable",!0)};crmSettingsForm.prototype.enableIButton=function(a){return this.initIButton(a).iButton("disable",
!1)};crmSettingsForm.prototype.initCopySmartyHelper=function(){this.$copy.on("click",function(){var a=d(this),b=a.data("content"),c=d("<input>");d("body").append(c);c.val(b).select();document.execCommand("copy");c.remove();a.removeClass("stack").addClass("yes");setTimeout(function(){a.removeClass("yes").addClass("stack")},2E3)})};crmSettingsForm.prototype.initIframeTextarea=function(){var a=this;a.$iframe_textarea.click(function(){a.$iframe_textarea.select()})};crmSettingsForm.prototype.initCancelLink=
function(){var a=this.referrer;this.$wrapper.on("click",".js-c-cancel-link",function(b){b.preventDefault();"settings/sources"==a?(d.crm.storage.set("crm/settings/source_tab","form"),d.crm.content.load(d.crm.app_url+"settings/sources/")):d.crm.content.load(d.crm.app_url+"settings/form/")})};crmSettingsForm.prototype.initBlocks=function(){var a=this.$wrapper,b=a.find(".js-deal-section");a=a.find(".js-responsible-section");b=b.data("block_object");a=a.data("block_object");b.setResponsibleBlock(a)};return crmSettingsForm}(jQuery);var crmSettingsFormFieldEditDialog=function(d){var a=function(b){var c=this,e=b.onClose;b.onClose=function(g,h){e&&e(g,h)};var f=b.onOpen;b.onOpen=function(g,h){f&&f(g,h);c.$wrapper=g;c.$form=c.$wrapper.find("form");c.$button=c.$form.find("[type=submit]");c.id=b.id;c.checked=b.checked;c.settingsForm=b.settingsForm;c.dialog=h;c.initClass()};new CRMDialog(b)};a.prototype.initClass=function(){var b=this.dialog.$block,c=this.settingsForm.getField(this.id,this.checked);d.each(c,function(g,h){"id"===g?
d(".crm-field-id",b).find(".value").text(c.name+" (ID="+h+")"):"name"!==g&&(g=d(".crm-field-"+g,b).find(".value").find(":input"),g.is(":checkbox")?g.prop("checked",!!h):g.is(":radio")?g.filter('[value="'+h+'"]').prop("checked",!0):g.val(h))});var e=function(g){d(".crm-field-"+g,b).hide().find(":input").attr("disabled",!0)},f=function(g){d(".crm-field-"+g,b).show().find(":input").attr("disabled",!1)};"Checkbox"!==c.type?f("captionplace"):e("captionplace");c.placeholder_need?f("placeholder"):e("placeholder");
c.placeholder_need&&"password"===c.id?f("placeholder_confirm"):e("placeholder_confirm");c.required_always?e("required"):f("required");"!deal_description"==c.id?f("redactor"):e("redactor");this.bindEvents()};a.prototype.bindEvents=function(){var b=this,c=b.$form,e=b.settingsForm.getField(b.id,b.checked);c.submit(function(f){f.preventDefault();c.find(":input[name*=params]:not(:disabled)").each(function(){var g=d(this),h=g.attr("name").replace("params[","").replace("]",""),l=g.val();g.is(":checkbox")?
e[h]=g.is(":checked")?!0:!1:g.is(":radio")?g.is(":checked")&&(e[h]=l):e[h]=l});b.settingsForm.updateField(b.id,b.checked,e);b.settingsForm.renderField(b.id,b.checked);b.dialog.close()});b.$form.on("change","input,textarea,select",function(){b.setFormChanged()});b.$form.on("keyup","input:text,textarea",function(){b.setFormChanged()})};a.prototype.setFormChanged=function(){this.$button.removeClass("green").addClass("yellow")};return a}(jQuery);var crmSettingsFormParagraphEditDialog=function(d){var a=function(b){var c=this,e=b.onClose;b.onClose=function(g,h){e&&e(g,h);d(".redactor-dropdown").remove()};var f=b.onOpen;b.onOpen=function(g,h){f&&f(g,h);c.$wrapper=g;c.$textarea=c.$wrapper.find(".crm-paragraph-textarea");c.$button=c.$wrapper.find("[type=button]");c.id=b.id;c.checked=b.checked;c.settingsForm=b.settingsForm;c.dialog=h;c.initClass()};new CRMDialog(b)};a.prototype.initClass=function(){var b=this.$textarea,c=this.settingsForm.getField(this.id,
this.checked);b.val(c&&c.text||"");this.initWYSIWYG();this.initSaveButton()};a.prototype.initWYSIWYG=function(){var b=this,c=b.$textarea,e=b.settingsForm.getField(b.id,b.checked);d.crm.initWYSIWYG(c,{focus:!0,changeCallback:function(){b.setFormChanged()}});c.val(e.text||"");c.redactor("code.set",e.text||"")};a.prototype.initSaveButton=function(){var b=this,c=b.$textarea;b.$button.click(function(e){e.preventDefault();b.settingsForm.updateField(b.id,b.checked,{text:c.val()});b.settingsForm.renderField(b.id,
b.checked);b.dialog.close()})};a.prototype.setFormChanged=function(){this.$button.removeClass("green").addClass("yellow")};return a}(jQuery);var crmSettingsFormAgreementCheckboxEditDialog=function(d){d=function(a){var b=this,c=a.onOpen;a.onOpen=function(e,f){c&&c(e,f);b.$wrapper=e;b.$html_label=b.$wrapper.find(".c-html-label-textarea-wrapper textarea");b.$field_id=b.$wrapper.find(".c-field-id .value");b.$checked_by_default=b.$wrapper.find(".c-field-checked-by-default :checkbox");b.$button=b.$wrapper.find("[type=button]");b.id=a.id;b.checked=a.checked;b.settingsForm=a.settingsForm;b.dialog=f;b.initClass()};new CRMDialog(a)};d.prototype.initClass=
function(){var a=this.getField();this.$field_id.text(a.name+" (ID="+a.id+")");this.initHtmlLabel();this.initDefaultChecked();this.initSaveButton()};d.prototype.initHtmlLabel=function(){var a=this,b=a.$html_label,c=a.getField(),e=function(){a.setFormChanged()};b.val(c.html_label);var f=null;b.on("keyup",function(){f&&clearTimeout(f);f=setTimeout(function(){e()},300)});b.on("change",e)};d.prototype.initDefaultChecked=function(){var a=this,b=a.getField(),c=a.$checked_by_default;c.attr("checked",!!b.default_checked);
c.on("change",function(){a.setFormChanged()})};d.prototype.getField=function(){var a=this.settingsForm.getField(this.id,this.checked);a.name=a.name||"";a.id=a.id||"";a.html_label=a.html_label||"";a.default_checked=a.default_checked&&"0"!==a.default_checked?1:0;a.html_label_default_href_placeholder=a.html_label_default_href_placeholder||"";return a};d.prototype.initSaveButton=function(){var a=this,b=a.$html_label,c=a.$checked_by_default;a.$button.click(function(e){e.preventDefault();e={html_label:b.val(),
default_checked:c.is(":checked")?1:0};a.settingsForm.updateField(a.id,a.checked,e);a.renderField();a.dialog.close()})};d.prototype.renderField=function(){var a=this.id,b=this.checked,c=this.getField(a,b),e=this.settingsForm.$form_fields,f=e.find('.crm-form-field:not(.crm-form-field-template)[data-id="'+a+'"][data-checked="'+b+'"]');c?(f.length||(f=e.find('.crm-form-field-template.crm-form-field-template[data-id="'+a+'"]').clone(),f.removeClass("crm-form-field-template"),f.attr("data-checked",b),f.insertBefore(e.find(".crm-form-field-template:first")),
f.show()),a=c.html_label,a=a.replace(c.html_label_default_href_placeholder,"javascript:void(0)"),f.find(".c-agreement-checkbox-html-label").html(a),f.find(":checkbox").attr("checked",!!c.default_checked)):f.remove()};d.prototype.setFormChanged=function(){this.$button.removeClass("green").addClass("yellow")};return d}(jQuery);var CRMSettingsGeneral=function(d){CRMSettingsGeneral=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.initClass()};CRMSettingsGeneral.prototype.initClass=function(){this.initStickyButton();this.initFooterToggle();this.initSubmit()};CRMSettingsGeneral.prototype.initStickyButton=function(){var a=d("#wa-app"),b=a.height();a=(a.offset()||{}).top;var c=d(window).height();b+a<c||this.$wrapper.find(".crm-form-buttons").sticky({fixed_css:{bottom:0,"z-index":9},fixed_class:"sticky-bottom-shadow",
showFixed:function(e){e.element.css("min-height",e.element.height());e.fixed_clone.empty().append(e.element.children())},hideFixed:function(e){e.fixed_clone.children().appendTo(e.element)},updateFixed:function(e,f){this.width(e.element.width())}})};CRMSettingsGeneral.prototype.initSubmit=function(){var a=this.$wrapper.find(".c-reminder-settings-wrapper").data("instance"),b=this.$form,c=b.find(".crm-loading");b.submit(function(e){e.preventDefault();c.show();a&&!1===a.validateBeforeSave()?c.hide():
d.post(b.attr("action"),b.serialize(),function(f){"ok"===f.status&&d.crm.content.reload()}).always(function(){b.find(".crm-loading").hide()})})};CRMSettingsGeneral.prototype.initFooterToggle=function(){var a=this.$wrapper.find(".js-footer-actions"),b=a.find(".js-submit-button");this.$wrapper.on("change keydown","input, textarea, select",function(){b.removeClass("green").addClass("yellow");a.addClass("is-changed")})};return CRMSettingsGeneral}(jQuery);var CRMNotificationEdit=function(d){CRMNotificationEdit=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$footer=this.$wrapper.find(".js-footer-actions");this.messages=a.messages||{};this.messages.enable=this.messages.enable||"";this.messages.disable=this.messages.disable||"";this.$name=this.$wrapper.find(".js-notification-name");this.$subject=this.$wrapper.find(".js-notification-subject");this.$emailBody=this.$wrapper.find(".js-email-body");this.$smsBody=this.$wrapper.find(".js-sms-body");
this.$recipient=this.$wrapper.find(".js-recipient-list");this.$sender=this.$wrapper.find(".js-sender-list");this.$sender_block=this.$wrapper.find(".js-senders-block");this.$sms_sender=this.$wrapper.find(".js-sms-sender-list");this.$sms_sender_block=this.$wrapper.find(".js-sms-senders-block");this.notifications=a.notifications;this.locales=a.locales;this.notification_id=(this.notification=a.notification||{},this.notification.id);this.notification_event=this.notification&&this.notification.event;this.site_app_url=
a.site_app_url;this.recipients=a.recipients;this.sender=a.sender.split("|",2);this.user_data=a.user_data;this.dialog_template=a.dialog_template;this.success_html=a.success_html;this.transport="";this.initClass()};CRMNotificationEdit.prototype.initClass=function(){0>=this.notification.id&&this.initTransport();this.initRecipient();this.initBody();this.notification_id||this.initChangeEvent();this.initSubmit();this.initDelete();this.initFooterActions();this.initHelp();this.initSender();this.initSendTest()};
CRMNotificationEdit.prototype.initSendTest=function(){var a=this,b=!1,c=null;a.$wrapper.on("click",".js-send-test",function(e){e.preventDefault();d(document).trigger("updateEditorTextarea");d.crm.confirm.show({title:a.locales.send_confirm_title,text:function(){var f=d(a.dialog_template);c="sms"==a.$wrapper.find(".js-transport-toggle").filter(":checked").first().val()?a.user_data.phone:a.user_data.email;f.find(".js-user-contact").attr("value",c);return f["0"].outerHTML}(),button:a.locales.send_confirm_button,
onConfirm:function(f){if(!b){b=!0;var g=a.$form.serializeArray();g.push({name:"data[contact]",value:f.$block.find(".js-user-contact").val()});d.post("?module=settingsNotifications&action=SendTest",g,function(h){"ok"===h.status&&(f.$wrapper.find(".crm-dialog-block").html(a.success_html),f.resize(),setTimeout(function(){d.contains(document,f.$wrapper[0])&&f.close()},1E4))},"json").always(function(){b=!1})}return!1}})})};CRMNotificationEdit.prototype.initSender=function(){function a(){return l&&0<l.id?
l.transport||"email":k.filter(":checked").first().val()}function b(){"email"===a()?(c("specified"===h.$sender.val()),g()):(f("specified"===h.$sms_sender.val()),e())}function c(m){var n=h.$sender_block.find(".js-specified-sender-name"),p=h.$sender_block.find(".js-specified-sender-email");h.$sender_block.show();h.$sender.attr("disabled",!1);m?(n.attr("disabled",!1).show(),p.attr("disabled",!1).show(),"system"!==h.sender[0]&&(p.val(h.sender[0]),n.val(h.sender[1]))):(n.attr("disabled",!0).hide(),p.attr("disabled",
!0).hide())}function e(){h.$sender_block.hide();h.$sender.attr("disabled",!0);h.$sender_block.find(".js-specified-sender-name").attr("disabled",!0).hide();h.$sender_block.find(".js-specified-sender-email").attr("disabled",!0).hide()}function f(m){var n=h.$sms_sender_block.find(".js-specified-sms-sender");h.$sms_sender_block.show();h.$sms_sender.attr("disabled",!1);m?(n.attr("disabled",!1).show(),"system"!==h.sender[0]&&n.val(h.sender[0])):n.attr("disabled",!0).hide()}function g(){h.$sms_sender_block.hide();
h.$sms_sender.attr("disabled",!0);h.$sms_sender_block.find(".js-specified-sms-sender").attr("disabled",!0).hide()}var h=this,l=h.notification,k=h.$wrapper.find(".js-transport-toggle");"email"===a()?(c("specified"===h.$sender.val()),g()):(f("specified"===h.$sms_sender.val()),e());k.on("change",b);h.$sender.on("change",b);h.$sms_sender.on("change",b)};CRMNotificationEdit.prototype.initRecipient=function(){function a(){b(c.$recipient.val())}function b(l){var k=h.filter(":checked").first().val();!k&&
0<c.notification.id&&(k=c.notification.transport);k=c.$wrapper.find('.c-recipient-content[data-id="'+k+'"]');c.$wrapper.find(".c-recipient-content").hide().attr("disabled",!0);"other"===l?(k.show(),k.attr("disabled",!1)):k.hide()}var c=this,e=c.notification.recipient,f=c.recipients,g=c.$recipient,h=c.$wrapper.find(".js-transport-toggle");g.on("change",a);h.on("change",a);f[e]||(c.$recipient.val("other"),b("other"),c.$wrapper.find('.c-recipient-content[data-id="'+h.filter(":checked").first().val()+
'"]').val(e))};CRMNotificationEdit.prototype.initChangeEvent=function(){var a=this,b=a.$wrapper.find(".js-event-toggle"),c=a.$wrapper.find(".js-event-company"),e=a.$wrapper.find(".js-fields-group");b.on("change",function(){var f=d.trim(d(this).val());a.notification_event=f;var g=a.notifications[f];g&&(a.$name.val(g.name),a.$subject.val(g.subject),a.$emailBody.val(g.body).trigger("editorDataUpdated"),a.$smsBody.val(g.sms).trigger("editorDataUpdated"),g.recipient?a.$recipient.val(g.recipient):a.$recipient.val("client"));
"invoice."===f.substr(0,8)?c.removeAttr("disabled").show():c.attr("disabled",!0).hide();e.show()})};CRMNotificationEdit.prototype.initTransport=function(){function a(f){f=f.val();b.transport=f;f=b.$wrapper.find('.c-transport-content[data-id="'+f+'"]');e?(e.removeClass("is-active"),e.find("input, textarea").attr("disabled",!0)):b.$wrapper.find(".c-transport-content").find("input, textarea").attr("disabled",!0);f.find("input, textarea").attr("disabled",!1);e=f.addClass("is-active")}var b=this,c=b.$wrapper.find(".js-transport-toggle"),
e=!1;a(c.filter(":checked").first());c.on("change",function(){a(d(this));b.$emailBody.trigger("editorDataUpdated");b.$smsBody.trigger("editorDataUpdated")})};CRMNotificationEdit.prototype.initBody=function(){this.$wrapper.find(".js-redactor-wrapper").each(function(a){var b=d(this),c=b.find("textarea"),e=d('<div class="js-redactor" />'),f="js-textarea-"+a;a="js-redactor-"+a;e.attr("id",a).appendTo(b);c.attr("id",f);waEditorAceInit({id:f,ace_editor_container:a});"undefined"!==typeof wa_editor&&e.data("wa_editor",
wa_editor);c.data("wa_editor",e.data("wa_editor"));c.on("editorDataUpdated",function(){var g=e.data("wa_editor");g&&g.getSession().setValue(c.val())});d(document).on("updateEditorTextarea",function(){var g=e.data("wa_editor");g&&(g=g.getValue(),c.val(g).trigger("change"))})})};CRMNotificationEdit.prototype.initSubmit=function(){function a(){var h={data:[],errors:[]},l=f.serializeArray();d.each(l,function(k,m){h.data.push(m)});return h}function b(h,l){l=l?l:[];if(h){var k=Object.keys(h);d.each(k,function(m,
n){l.push({name:n,value:h[n]})})}d.each(l,function(m,n){m=n.value;var p=e.$form.find('[name="'+n.name+'"]');if(p.length&&!p.hasClass("error")){var q=d("<span />").addClass("errormsg").text(m);e.$wrapper.append(q);p.addClass("error").one("focus click change",function(){p.removeClass("error");q.remove()})}})}function c(h){if(!g){g=!0;var l=d(e.locales.saving);e.$footer.append(l);d.post("?module=settings&action=notificationsEditSave",h,"json").done(function(k){if("ok"!==k.status)b(k.errors||{});else if(0>=
e.notification_id)d.crm.content.load(d.crm.app_url+"settings/notifications/edit/"+k.data.notification.id+"/");else{var m=d(e.locales.saved);e.$footer.append(m);setTimeout(function(){d.contains(document,m[0])&&m.remove()},2E3);d(document).trigger("formIsSaved")}}).always(function(){l.remove();g=!1})}}var e=this,f=e.$form,g=!1;f.on("submit",function(h){h.preventDefault();d(document).trigger("updateEditorTextarea");h=a();h.errors.length?b(!1,h.errors):c(h.data)})};CRMNotificationEdit.prototype.initDelete=
function(){var a=this,b=!1;a.$wrapper.on("click",".js-remove-notification",function(c){c.preventDefault();d.crm.confirm.show({title:a.locales.delete_confirm_title,text:a.locales.delete_confirm_text,button:a.locales.delete_confirm_button,onConfirm:function(e){b||(b=!0,d.post("?module=settings&action=notificationsDelete",{id:a.notification_id},function(f){"ok"===f.status&&d.crm.content.load(d.crm.app_url+"settings/notifications/")}).always(function(){b=!1;e.close()}));return!1}})})};CRMNotificationEdit.prototype.initFooterActions=
function(){function a(c){c?b.removeClass("yellow").addClass("green"):b.removeClass("green").addClass("yellow")}var b=this.$footer.find(".js-submit-button");this.$wrapper.on("change","input, textarea, select",function(){a()});d(document).on("formIsSaved",function(){a(!0)})};CRMNotificationEdit.prototype.initHelp=function(){var a=this,b=a.$wrapper,c=d(document),e=d("#wa-editor-help"),f=d("#wa-editor-help-link"),g=function(h){0>=c.find(b).length?c.off("click",g):(h=d(h.target),!h.is(e)&&0>=e.find(h).length&&
e.hide())};c.on("click",g);f.on("click",function(){if(e.is(":visible"))return e.hide(),!1;if(e.data("loaded."+a.notification_event))return e.show(),!1;e.load(a.site_app_url+"?module=pages&action=help","app=crm&key=notification."+a.notification_event,function(){e.find("#wa-help-wa").remove();e.find("#wa-help-wa-content").remove();e.show();e.find("ul>li.no-tab>p.bold").hide();e.data("loaded."+a.notification_event,!0)});return!1});e.on("click","div.fields a.inline-link",function(h){h.preventDefault();
h=d(this).find("i");var l=a.$emailBody;"sms"===a.transport&&(l=a.$smsBody);(l=l.data("wa_editor"))&&l.insert(d.trim(h.text()))})};return CRMNotificationEdit}(jQuery),CRMNotificationStatus=function(d){CRMNotificationStatus=function(a){this.$wrapper=a.$wrapper;this.messages=a.messages||{};this.messages.enable=this.messages.enable||"";this.messages.disable=this.messages.disable||"";this.notifications=a.notifications;this.initDisableLinks()};CRMNotificationStatus.prototype.initDisableLinks=function(){var a=
this,b=null,c=d.crm.app_url+"?module=settingsNotifications&action=status";a.$wrapper.on("click",".js-c-disable-link",function(e){e.preventDefault();var f=d(this),g=f.closest(".c-notification");e=g.data("id");var h=g.hasClass("c-is-disabled"),l=g.find(".c-loading");b&&b.abort();l.show();b=d.post(c,{id:e,status:h?0:1}).done(function(k){"ok"===k.status&&(0<k.data.notification.status?(f.text(a.messages.disable),g.removeClass("c-is-disabled")):(f.text(a.messages.enable),g.addClass("c-is-disabled")))}).always(function(){b=
null;l.hide()})})};return CRMNotificationStatus}(jQuery);var CRMSettingsPayments=function(d){CRMSettingsPayments=function(a){this.$wrapper=a.$wrapper;this.$pluginsDropdown=this.$wrapper.find(".js-plugins-dropdown");this.$table=this.$wrapper.find(".js-payments-table");this.company_id=a.company_id;this.locales=a.locales;this.initClass()};CRMSettingsPayments.prototype.initClass=function(){this.initTabs();this.initDelete();this.initSortable();var a=this.$wrapper.find(".c-payments-list");(new MutationObserver(function(b){a.trigger("refresh")})).observe(a[0],
{childList:!0,attributes:!0,subtree:!0})};CRMSettingsPayments.prototype.initTabs=function(){var a=this.$wrapper.find(".c-tabs-wrapper"),b=this.$wrapper.find(".c-companies-wrapper"),c=b.find(".c-companies-list"),e=c.find(".c-company.selected");(function(){function f(){d.contains(document,a[0])?g():h.off("resize refresh",f)}function g(){var k=a.width()-l-10;b.css("max-width",k+"px")}var h=d(window),l=a.find(".c-add-wrapper").outerWidth(!0);g();h.on("resize refresh",f)})();d.crm.tabSlider({$wrapper:b,
$slider:c,$activeSlide:e.length?e:!1})};CRMSettingsPayments.prototype.initDelete=function(){var a=this,b=!1;a.$wrapper.on("click",".js-delete-payment",function(c){c.preventDefault();c=d(this);var e=c.closest("tr"),f=c.data("payment-id"),g=c.data("plugin");(function(){d.crm.confirm.show({title:a.locales.confirm_delete_title.replace("%payment",e.find(".js-name").text()),text:a.locales.confirm_delete_text,button:a.locales.confirm_delete_button,onConfirm:function(){b||(b=!0,d.post("?module=settings&action=paymentDelete",
{id:f,company_id:a.company_id},function(h){"ok"==h.status&&(e.remove(),h=a.$pluginsDropdown.find('li[data-plugin="'+g+'"]'),h.length&&h.show())}).always(function(){b=!1}))}})})()})};CRMSettingsPayments.prototype.initSortable=function(){var a=this,b=!1;a.$table.sortable({distance:10,handle:".js-sort-toggle",helper:"clone",items:"tr",axis:"y",stop:function(){var c={ids:function(){var e=[];a.$table.find("tr").each(function(){e.push(d(this).data("id"))});return e}(),company_id:a.company_id};b&&b.abort();
b=d.post("?module=settings&action=paymentSort",c,function(e){}).always(function(){b=!1})}})};return CRMSettingsPayments}(jQuery),CRMPaymentEdit=function(d){CRMPaymentEdit=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$footer=this.$wrapper.find(".js-footer");this.instance_id=a.instance_id;this.company_id=a.company_id;this.locales=a.locales;this.initClass()};CRMPaymentEdit.prototype.initClass=function(){this.initSubmit();this.initDelete()};CRMPaymentEdit.prototype.initSubmit=
function(){function a(g){if(!e){e=!0;var h=d(c.locales.saving);c.$footer.append(h);d.post("?module=settings&action=paymentSave",g,function(l){if("ok"==l.status)if(h.remove(),c.instance_id){var k=d(c.locales.saved);c.$footer.append(k);setTimeout(function(){d.contains(document,k[0])&&k.remove()},2E3)}else d.crm.content.load(d.crm.app_url+"settings/payment/?company="+c.company_id)}).always(function(){e=!1})}}function b(g,h){g=g?g:[];if(h){var l=Object.keys(h);d.each(l,function(k,m){g.push({name:m,value:h[m]})})}d.each(g,
function(k,m){k=m.value;var n=c.$wrapper.find('[name="'+m.name+'"]');if(n.length&&!n.hasClass("error")){var p=d("<span />").addClass("errormsg").text(k);p.insertAfter(n);n.addClass("error").one("focus click",function(){n.removeClass("error");p.remove()})}})}var c=this,e=!1,f=c.$form;f.on("submit",function(g){g.preventDefault();g=f.serializeArray();var h=[];h.length?b(h):a(g)})};CRMPaymentEdit.prototype.initDelete=function(){var a=this,b=!1;a.$wrapper.on("click",".js-delete-payment",function(c){function e(){b||
(b=!0,d.post("?module=settings&action=paymentDelete",{id:a.instance_id,company_id:a.company_id},function(f){"ok"==f.status&&d.crm.content.load(d.crm.app_url+"settings/payment/?company="+a.company_id)}).always(function(){b=!1}))}c.preventDefault();(function(){b||(b=!0,d.post("?module=dialogConfirm",{title:a.locales.confirm_delete_title,text:a.locales.confirm_delete_text,ok_button:a.locales.confirm_delete_button},function(f){new CRMDialog({html:f,onConfirm:function(){e()}})}).always(function(){b=!1}))})()})};
return CRMPaymentEdit}(jQuery);var CRMReasonsPage=function(d){CRMReasonsPage=function(a){this.$wrapper=a.$wrapper;this.$reasonsList=this.$wrapper.find(".js-reasons-list");this.$footer=this.$wrapper.find(".js-footer-actions");this.$form=this.$wrapper.find("form");this.$freeField=this.$wrapper.find(".js-free-field");this.$submitButton=this.$wrapper.find(".js-submit-button");this.$hiddenActions=this.$footer.find(".js-hidden-actions");this.reason_template_html=a.reason_template_html;this.locales=a.locales;this.is_changed=!1;this.initClass()};
CRMReasonsPage.prototype.initClass=function(){var a=this;a.initSortable();a.initAddReason();a.initRemoveReason();a.initSubmit();a.$form.on("change","input",function(){a.toggleButton(!0)})};CRMReasonsPage.prototype.initSortable=function(){var a=this;a.$reasonsList.sortable({distance:10,handle:".js-sort-toggle",helper:"clone",items:"> li",axis:"y",change:function(){a.toggleButton(!0)}})};CRMReasonsPage.prototype.initRemoveReason=function(){var a=this;a.$wrapper.on("click",".js-delete-reason",function(b){b.preventDefault();
d(this).closest(".c-reason").remove();a.$reasonsList.find(".c-reason").length||a.$freeField.attr("checked",!0).attr("disabled",!0);a.toggleButton(!0)})};CRMReasonsPage.prototype.initAddReason=function(){var a=this;a.$wrapper.on("click",".js-add-reason",function(b){b.preventDefault();b=d(a.reason_template_html);a.$reasonsList.append(b);a.$freeField.attr("disabled",!1);a.toggleButton(!0)})};CRMReasonsPage.prototype.initSubmit=function(){function a(f){if(!e){e=!0;var g=d(c.locales.saving);c.$footer.append(g);
f=b(f);d.post("?module=settings&action=lostReasonsSave",f,function(h){if("ok"==h.status){g.remove();var l=d(c.locales.saved);c.$footer.append(l);c.toggleButton(!1);setTimeout(function(){d.contains(document,l[0])&&l.remove()},2E3)}}).always(function(){e=!1})}}function b(f){var g=f.serializeArray();c.$freeField.is(":disabled")&&(c.$freeField.attr("disabled",!1),g=f.serializeArray(),c.$freeField.attr("disabled",!0));(function(h){c.$reasonsList.find(".c-reason").each(function(l){var k=d(this),m=k.data("id"),
n=k.find(".js-name-field").val();k=k.find(".js-funnel-id-field").val();n&&(m&&h.push({name:"reasons["+l+"][id]",value:m}),h.push({name:"reasons["+l+"][name]",value:n}),h.push({name:"reasons["+l+"][funnel_id]",value:k}))})})(g);return g}var c=this,e=!1;c.$form.on("submit",function(f){f.preventDefault();a(d(this))})};CRMReasonsPage.prototype.toggleButton=function(a){var b=this.$submitButton,c=this.$hiddenActions;a?(b.removeClass("green").addClass("yellow"),c.show()):(b.removeClass("yellow").addClass("green"),
c.hide())};return CRMReasonsPage}(jQuery);var CRMSettingsRegions=function(d){var a=function(b){this.$wrapper=b.$wrapper;this.$form=this.$wrapper.find("form");this.$table=this.$form.find("table");b.title=b.title||"";b.title&&d.crm.title.set(b.title);this.country_iso3letter=b.country_iso3letter;this.messages=b.messages;this.initClass()};a.prototype.initClass=function(){this.initDeleteLinks();this.initFavorite();this.initAddLink();this.initSelector();this.initSubmit()};a.prototype.initDeleteLinks=function(){var b=this.$table;b.on("click",".delete",
function(){var c=d(this).parents("tr"),e=c.find('[name="region_names[]"]').attr("rel");if(e){var f=b.find("tr.template-deleted").clone().removeClass("hidden").removeClass("template-deleted");f.find(".insert-name-here").text(e);c.after(f).remove()}else c.remove(),0>=b.find("tbody tr:not(.white):visible").length&&b.find(".empty-stub").show()})};a.prototype.initFavorite=function(){var b=this,c=b.$form;b.$table.on("click",".fav",function(){var e=d(this).toggleClass("star").toggleClass("star-empty"),f=
e.hasClass("star")?"1":"";e.siblings("input:hidden").val(f);0>=e.parents(".just-added").length&&d.post(c.attr("action"),{fav:1,country:b.country_iso3letter,region:e.parents("tr").data("origCode"),fav_sort:f})});d("#favorite-country").click(function(){var e=d(this).toggleClass("star").toggleClass("star-empty"),f=e.hasClass("star")?"1":"";e.siblings('[name="country_fav"]').val(f);d.post(c.attr("action"),{fav:1,country:b.country_iso3letter,fav_sort:f})})};a.prototype.initAddLink=function(){var b=this.$table;
d("#add-region-link").click(function(){var c=b.find("tr.template-new").clone().removeClass("hidden").removeClass("template-new");d(this).parents("tr").before(c);c.siblings(".empty-stub").hide()})};a.prototype.initSelector=function(){var b=this,c=b.$form,e=c.find("select"),f=function(){return c.serialize().replace(/region_favs%5B%5D=[^&]*&/g,"").replace(/country_fav=[^&]*&/g,"")},g=f();e.change(function(){if(g!==f()&&!confirm(b.messages.confirm_region_not_saved))return e.val(b.country_iso3letter),
!1;var h=e.val();e.attr("disabled",!0);d("#c-settings-content").load(d.crm.app_url+"?module=settings&action=regions&country="+h)})};a.prototype.initSubmit=function(){var b=this,c=b.$form;c.submit(function(e){e.preventDefault();var f=!1;c.find(".zebra input:visible").each(function(){var g=d(this),h=g.val();h&&"0"!=h||(g.addClass("error").one("focus",function(){g.removeClass("error")}),f=!0)});f||(c.find(":submit").attr("disabled",!0),d.post(c.attr("action"),c.serialize(),function(g){d("#c-settings-content").html(g);
setTimeout(function(){var h=d('<span><i class="icon16 country yes"></i> '+b.messages.saved+"</span>");d("#regions-form :submit").after(h);h.fadeOut(1500,function(){d(this).remove()})},0)}))})};return a}(jQuery);var CRMSettingsVaults=function(d){CRMSettingsVaults=function(a){this.$wrapper=a.$wrapper;this.$list=this.$wrapper.find(".js-vaults-list");this.locales=a.locales;this.vault_template_html=a.vault_template_html;this.initClass()};CRMSettingsVaults.prototype.initClass=function(){this.initEdit();this.initSort()};CRMSettingsVaults.prototype.initEdit=function(){function a(e,f){c&&c.abort();c=d.post("?module=settings&action=vaultDialog",{id:e?e:""},function(g){new CRMDialog({html:g,options:{onSave:function(h,
l,k){f&&f.length||(f=d(b.vault_template_html),f.data("id",h).appendTo(b.$list));f.find(".js-name").text(l);f.find(".js-color").css("background",k)},onDelete:function(){f.remove()}}})}).always(function(){c=!1})}var b=this,c=!1;b.$wrapper.on("click",".js-vault-edit",function(){var e=d(this).closest(".c-vault-item"),f=e.data("id");a(f,e)});b.$wrapper.on("click",".js-vault-add",function(){a()})};CRMSettingsVaults.prototype.initSort=function(){function a(){var e=[];b.$list.find(".c-vault-item").each(function(){var f=
d(this).data("id");f&&e.push(f)});return e}var b=this,c=!1;b.$list.sortable({distance:10,handle:".js-sort-toggle",helper:"clone",items:"> .c-vault-item",axis:"y",stop:function(e,f){var g=d(f.item);c&&c.abort();e={vaults:a()};var h=d(b.locales.saving);h.appendTo(g);c=d.post("?module=settings&action=vaultsSave",e,function(l){if("ok"==l.status){var k=d(b.locales.saved);k.appendTo(g);setTimeout(function(){d.contains(document,k[0])&&k.remove()},2E3)}}).always(function(){h.remove();c=!1})}})};return CRMSettingsVaults}(jQuery),
CRMVaultEdit=function(d){CRMVaultEdit=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.locales=a.locales;this.count=a.count;this.vault_id=a.vault_id;this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMVaultEdit.prototype.initClass=function(){this.initDelete();this.initSave();this.initColorPicker();this.initNoAccessList()};CRMVaultEdit.prototype.initDelete=function(){function a(c,e){d.post("?module=settings&action=vaultDialogDelete",{id:c},function(f){"ok"===
f.status&&e&&"function"===typeof e&&e()})}var b=this;b.$wrapper.on("click",".js-vault-delete",function(c){c.preventDefault();var e=b.vault_id;d.crm.confirm.show({title:b.locales.confirm_delete_title,text:b.locales.confirm_delete_text,button:b.locales.confirm_delete_button,onConfirm:function(){a(e,function(){b.dialog.options.onDelete();b.dialog.close()})}})})};CRMVaultEdit.prototype.initSave=function(){function a(){var k={data:[],errors:[]},m=f.serializeArray();d.each(m,function(n,p){"data[name]"===
p.name&&(h=p.value);"data[color]"===p.name&&(l=p.value);k.data.push(p)});return k}function b(k,m){m=m?m:[];if(k){var n=Object.keys(k);d.each(n,function(p,q){m.push({name:q,value:k[q]})})}d.each(m,function(p,q){p=q.value;var r=e.$form.find('[name="'+q.name+'"]');if(r.length&&!r.hasClass("error")){var t=d("<span />").addClass("errormsg").text(p);e.$wrapper.append(t);r.addClass("error").one("focus click change",function(){r.removeClass("error");t.remove()})}})}function c(k){g||(g=!0,d.post("?module=settings&action=vaultDialogSave",
k,function(m){"ok"===m.status?(console.log(e.dialog),e.dialog.options.onSave(m.data.id,h,l),e.dialog.close()):m.errors&&b(m.errors)},"json").always(function(){g=!1}))}var e=this,f=e.$form,g=!1,h="",l="#aaa";f.on("submit",function(k){k.preventDefault();k=a();k.errors.length?b(!1,k.errors):c(k.data)})};CRMVaultEdit.prototype.initColorPicker=function(){var a=function(b){a=function(c){this.$wrapper=c.$wrapper;this.$field=c.$field;this.$icon=c.$icon;this.$colorPicker=c.$colorPicker;this.farbtastic=this.is_opened=
!1;this.initClass()};a.prototype.initClass=function(){var c=this;c.farbtastic=b.farbtastic(c.$colorPicker,function(e){c.$field.val(e).change()});c.$wrapper.data("colorPicker",c);c.bindEvents()};a.prototype.bindEvents=function(){var c=this;c.$icon.on("click",function(e){e.preventDefault();e.stopPropagation();c.displayToggle(!c.is_opened)});c.$colorPicker.on("click",function(e){e.stopPropagation()});c.$field.on("click",function(e){e.stopPropagation()});c.$field.on("focus",function(){c.is_opened||c.displayToggle(!0)});
c.$field.on("change keyup",function(){var e=b(this).val();c.$icon.css("background-color",e);c.farbtastic.setColor(e)});b(document).on("click",function(){c.displayToggle(!1)});b(document).on("colorPickerIsOpened",function(){c.is_opened&&c.displayToggle(!1)})};a.prototype.displayToggle=function(c){var e=this.$colorPicker;c?(b(document).trigger("colorPickerIsOpened",this),e.addClass("is-shown"),this.is_opened=!0):(b(document).trigger("colorPickerIsClosed",this),e.removeClass("is-shown"),this.is_opened=
!1)};return a}(jQuery);this.$wrapper.find(".js-color-toggle").each(function(){var b=d(this);new a({$wrapper:b,$field:b.find(".js-field"),$icon:b.find(".js-toggle"),$colorPicker:b.find(".js-color-picker")})})};CRMVaultEdit.prototype.initNoAccessList=function(){var a=this,b=a.$wrapper.find(".js-no-access-wrapper");b.on("click",".js-show-access-list",function(c){c.preventDefault();b.addClass("is-active");a.dialog.resize()});b.on("click",".js-hide-access-list",function(c){c.preventDefault();b.removeClass("is-active");
a.dialog.resize()})};return CRMVaultEdit}(jQuery);var CRMSettingsMessagesBlock=function(d){CRMSettingsMessagesBlock=function(a){this.$wrapper=a.$wrapper;this.namespace=a.namespace||"";this.type=a.type||"form";this.initClass()};CRMSettingsMessagesBlock.prototype.initClass=function(){var a=this,b=a.$wrapper,c=a.namespace,e=d.crm.app_url+"?module=settings&action=emailTemplateEditor";a.renderCheckboxLabel();b.on("click",".js-crm-add-message-checkbox",function(){var f=d(this),g=b.find(".crm-template").clone();g.removeClass("crm-template");b.find(".crm-one-message:last").after(g.show());
var h=b.find(".crm-editor-wrapper[data-i]").last().data("i");h?h=parseInt(h+"",10):0!==h&&(h=-1);var l=h+1;g.find(".crm-editor-wrapper").data("i",""+l).attr("data-i",""+l);d.post(e,{input_name:c+"["+l+"][tmpl]",to_name:c+"["+l+"][to]",sourcefrom_name:c+"["+l+"][sourcefrom]",add_attachments_name:c+"["+l+"][add_attachments]",type:a.type},function(k){g.find(".crm-editor-wrapper").html(k);b.trigger("loadEditor",[l,g])});a.renderCheckboxLabel();f.prop("checked",!1)});b.on("click",".js-crm-remove-message-checkbox",
function(){d(this).closest(".crm-one-message").remove();a.renderCheckboxLabel()})};CRMSettingsMessagesBlock.prototype.renderCheckboxLabel=function(){var a=this.$wrapper;0<a.find(".crm-one-message:not(.crm-template)").length?(a.find(".js-crm-when-no-messages").hide(),a.find(".js-crm-when-messages").show()):(a.find(".js-crm-when-no-messages").show(),a.find(".js-crm-when-messages").hide())};return CRMSettingsMessagesBlock}(jQuery);var CRMSettingsShop=function(d){CRMSettingsShop=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$button=this.$form.find("[type=submit]");this.source=a.source||{};this.messages=a.messages||{};this.submit_xhr=null;this.initClass()};CRMSettingsShop.prototype.initClass=function(){this.initSubmit();this.initStoreToggle();this.initFooterToggle()};CRMSettingsShop.prototype.initStoreToggle=function(){this.$wrapper.find(".js-ibutton-wrapper").each(function(){var a=d(this).find(".js-ibutton");
a.iButton({labelOn:"",labelOff:"",classContainer:"c-ibutton ibutton-container mini"});a.on("change",function(){var b=a.closest(".c-storefront").find(".c-storefront-params-block");"checked"===a.attr("checked")?b.show():b.hide()})})};CRMSettingsShop.prototype.initSubmit=function(){var a=this,b=a.$form,c=a.$button,e=b.find(".c-loading"),f=b.attr("action");b.submit(function(g){g.preventDefault();e.show();c.attr("disabled",!0);a.submit_xhr&&a.submit_xhr.abort();a.submit_xhr=d.post(f,b.serialize()).done(function(){d.crm.content.load(d.crm.app_url+
"settings/shop/")}).always(function(){c.attr("disabled",!1);e.hide()})})};CRMSettingsShop.prototype.initFooterToggle=function(){var a=this.$wrapper.find(".js-footer-actions"),b=a.find(".js-submit-button");this.$wrapper.on("change keydown","input, textarea, select",function(){b.removeClass("green").addClass("yellow");a.addClass("is-changed")})};return CRMSettingsShop}(jQuery),CRMSettingsShopWorkflowPage=function(d){CRMSettingsShopWorkflowPage=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form").first();
this.initClass()};CRMSettingsShopWorkflowPage.prototype.initClass=function(){d.crm.renderSVG(this.$wrapper);this.initTabs();this.initFooterToggle();this.initSubmit()};CRMSettingsShopWorkflowPage.prototype.initTabs=function(){var a=this.$wrapper.find(".js-funnels-tabs"),b=this.$wrapper.find(".c-funnels-wrapper"),c=b.find(".c-funnels-list"),e=c.find(".c-funnel.selected");(function(){function f(){d.contains(document,a[0])?g():h.off("resize",f)}function g(){var k=a.width()-l-10;b.css("max-width",k+"px")}
var h=d(window),l=a.find(".c-add-wrapper").outerWidth(!0);g();h.on("resize",f)})();d.crm.tabSlider({$wrapper:b,$slider:c,$activeSlide:e.length?e:!1})};CRMSettingsShopWorkflowPage.prototype.initFooterToggle=function(){var a=this.$wrapper.find(".js-footer-actions"),b=a.find(".js-submit-button");this.$wrapper.on("change keydown","input, textarea, select",function(){b.removeClass("green").addClass("yellow");a.addClass("is-changed")})};CRMSettingsShopWorkflowPage.prototype.initSubmit=function(){function a(){var l=
{data:[],errors:[]},k=f.serializeArray();d.each(k,function(m,n){l.data.push(n)});return l}function b(l){l&&l[0]||(l=[]);d.each(l,function(k,m){k=m.value;var n=e.$wrapper.find('[name="'+m.name+'"]'),p=d("<span class='c-error' />").addClass("errormsg").text(k);n.length&&!n.hasClass("error")?(n.parent().append(p),n.addClass("error").one("focus click change",function(){n.removeClass("error");p.remove()})):(g.append(p),f.one("submit",function(){p.remove()}))})}function c(l){h||(h=!0,d.post(d.crm.app_url+
"?module=settings&action=shopWorkflowSave",l,function(k){"ok"===k.status?d.crm.content.reload():b(k.errors)},"json").always(function(){h=!1}))}var e=this,f=e.$form,g=e.$wrapper.find(".js-errors-place"),h=!1;f.on("submit",function(l){l.preventDefault();l=a();l.errors.length?b(l.errors):c(l.data)})};return CRMSettingsShopWorkflowPage}(jQuery);var CRMSettingsPbxPage=function(d){CRMSettingsPbxPage=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.locales=a.locales;this.user_template_html=a.user_template_html;this.initClass()};CRMSettingsPbxPage.prototype.initClass=function(){var a=this;a.$wrapper.find(".c-pair-wrapper").each(function(){a.initPair(d(this))})};CRMSettingsPbxPage.prototype.initPair=function(a){var b=this,c=a.data("plugin-id"),e=a.data("number"),f=!1;a.on("click",".js-user-delete",function(g){g.preventDefault();
var h=d(this).closest(".c-user-wrapper"),l=h.find(".js-name");g=a.find(".js-number");l=l.html();d.crm.confirm.show({title:b.locales.delete_confirm_title.replace("%name%",l).replace("%number%",g.html()),text:b.locales.delete_confirm_text,button:b.locales.delete_confirm_button,onConfirm:function(){var k=h.data("id");f||(f=!0,d.post("?module=settingsPBX&action=delete",{p:c,n:e,u:k},function(m){"ok"===m.status&&h.remove()},"json").always(function(){f=!1}))}})});a.on("click",".js-delete-pbx-num",function(){var g=
d(this).parents("tr"),h={p:c,n:e};g.addClass("hidden");d.post("?module=settingsPBX&action=deleteNumber",h,function(l){"ok"===l.status?g.remove():g.removeClass("hidden")},"json").always(function(){g.removeClass("hidden")})});(function(){function g(n){n?l.addClass("is-shown"):l.removeClass("is-shown")}function h(n){m||(m=!0,d.post("?module=settingsPBX&action=add",{p:c,n:e,u:n.id},function(p){"ok"===p.status&&(p=d(b.user_template_html),n.photo_url&&p.find(".userpic20").css("background-image","url("+
n.photo_url+")"),p.find(".js-name").text(n.name),p.data("id",n.id),k.append(p))}).always(function(){m=!1}))}var l=a.find(".js-user-add-wrapper"),k=a.find(".js-users-list"),m=!1;l.on("click",".js-show-combobox",function(n){n.stopPropagation();g(!0)});l.on("click",".js-hide-combobox",function(n){n.stopPropagation();g(!1)});(function(){var n=l.find(".js-autocomplete");n.length&&(n.autocomplete({appendTo:l,source:d.crm.app_url+"?module=autocomplete&type=user",minLength:0,html:!0,focus:function(){return!1},
select:function(p,q){h(q.item);g(!1);n.val("");return!1}}).data("ui-autocomplete")._renderItem=function(p,q){return d("<li />").addClass("ui-menu-item-html").append("<div>"+q.value+"</div>").appendTo(p)},n.on("focus",function(){n.data("uiAutocomplete").search(n.val())}))})()})()};return CRMSettingsPbxPage}(jQuery);var CRMSettingsTemplate=function(d){CRMSettingsTemplate=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find(".js-template-form");this.$paramsSection=this.$wrapper.find(".c-params-section");this.$param_list=this.$paramsSection.find(".c-params-list");this.$textarea=this.$wrapper.find(".js-content-body");this.preview_dialog_template=a.preview_dialog_template;this.site_app_url=a.site_app_url;this.template=a.template||{};this.param_html=a.param_html;this.template_id=a.template_id;this.locales=
a.locales;this.company_count=a.company_count;this.initClass()};CRMSettingsTemplate.prototype.initClass=function(){var a=this;a.initHelp();a.initBody();a.initSave();a.initDelete();a.initParamsSection();a.initPreviewIframe();a.initIDAutoFiller();setTimeout(function(){a.initElasticFooter()},300);a.$form.on("change","input, select, textarea",function(){a.toggleButton(!0)});a.initResetTemplate()};CRMSettingsTemplate.prototype.initResetTemplate=function(){var a=this,b=a.$wrapper.find(".js-reset-template");
a.$wrapper.find(".js-redactor-wrapper").on("keypress",function(){b.removeClass("hidden")});b.on("click",function(){d.post("?module=settings&action=templatesReset","template_id="+a.template_id,function(c){"ok"===c.status&&(d(".js-content-body").text(c.data.template),a.initBody())},"json").always(function(){})})};CRMSettingsTemplate.prototype.initIDAutoFiller=function(){var a=null,b,c=this.$param_list,e=this.$form;c.on("change","input.js-code-field",function(){d(this).removeClass("auto-filler")});c.on("keyup",
"input.js-name-field",function(){var f=d(this),g=f.val(),h=f.parents("tr").find(".js-code-field"),l=h.hasClass("auto-filler"),k=e.find('[type="submit"]'),m=h.next(".loading");!k.prop("disabled")&&l&&(m=m.length?m:d('<i class="icon16 loading"></i>'),m.insertAfter(h),k.prop("disabled",!0),b&&clearTimeout(b),b=setTimeout(function(){a=d.post(d.crm.app_url+"?module=settings&action=fieldTransliterate",{"name[]":g},function(n){a&&(a.abort(),a=null);b&&clearTimeout(b);k.prop("disabled",!1);m.remove();"ok"===
n.status&&l&&h.val(n.data)},"json")},300))})};CRMSettingsTemplate.prototype.validate=function(){var a=this.$param_list.find(".js-code-field"),b=this.locales;this.$param_list.find(".errormsg").remove();this.$param_list.find(".error").removeClass("error");a.each(function(){var c=d(this),e=d(this).val(),f=d("<span />").addClass("errormsg"),g=e.search(/^\d/);e=e.search(/[^a-zA-Z0-9_]/);0<=g?(c.addClass("error"),c.after(f.text(b.validate_first_num))):0<=e?(c.addClass("error"),c.after(f.text(b.validate_symbols))):
c.hasClass("error")||(f=a.filter(function(){return this.value===c.val()}),2<=f.length&&f.addClass("error").parent().append(d('<span class="errormsg">').text(b.validate_copies)))});return this.$param_list.find(".error").length?!1:!0};CRMSettingsTemplate.prototype.initDelete=function(){function a(){var e={id:b.template_id};c||(c=!0,d.post("?module=settings&action=templatesDelete",e,function(f){d.crm.content.load(d.crm.app_url+"settings/templates/")},"json").always(function(){c=!1}))}var b=this,c=!1;
b.$wrapper.on("click",".js-delete-template",function(e){e.preventDefault();if(b.company_count){var f=d.crm.alert.show({text:b.locales.success_text,button:b.locales.success_button});setTimeout(function(){d.contains(document,f.$wrapper[0])&&f.close()},1E4)}else d.crm.confirm.show({title:b.locales.delete_confirm_title,text:b.locales.delete_confirm_text,button:b.locales.delete_confirm_button,onConfirm:a})})};CRMSettingsTemplate.prototype.initSave=function(){function a(e){d.post("?module=settings&action=templatesSave",
e,function(f){"ok"===f.status&&d.crm.content.load(d.crm.app_url+"settings/templates/"+f.data.id+"/")},"json").always(function(){c=!1})}var b=this,c=!1;b.$form.on("submit",function(e){e.preventDefault();d(document).trigger("updateEditorTextarea");if(!b.validate())return!1;!c&&(e=b.$form.serializeArray())&&(c=!0,a(e))})};CRMSettingsTemplate.prototype.initParamsSection=function(){var a=this,b=a.$paramsSection;b.on("click",".js-delete-param",function(c){c.preventDefault();d(this).closest("tr").remove();
a.toggleButton(!0)});b.on("click",".js-add-param",function(c){c.preventDefault();c=d(a.param_html);a.$param_list.append(c);a.toggleButton(!0)})};CRMSettingsTemplate.prototype.toggleButton=function(a){var b=this.$wrapper.find(".js-template-save-button"),c=this.$wrapper.find(".js-hidden-actions");a?(b.removeClass("green").addClass("yellow"),c.show()):(b.removeClass("yellow").addClass("green"),c.hide())};CRMSettingsTemplate.prototype.initBody=function(){var a=this;a.$wrapper.find(".js-redactor-wrapper").each(function(b){var c=
d(this),e=c.find("textarea"),f=d('<div class="js-redactor" />'),g="js-textarea-"+b;b="js-redactor-"+b;f.attr("id",b).appendTo(c);e.attr("id",g);waEditorAceInit({id:g,ace_editor_container:b});"undefined"!==typeof wa_editor&&f.data("wa_editor",wa_editor);e.data("wa_editor",f.data("wa_editor"));e.on("editorDataUpdated",function(){var h=f.data("wa_editor");h&&h.getSession().setValue(e.val())});setTimeout(function(){f.data("wa_editor").on("input",function(){a.toggleButton(!0)})},100);d(document).on("updateEditorTextarea",
function(){var h=f.data("wa_editor");h&&(h=h.getValue(),e.val(h).trigger("change"))})})};CRMSettingsTemplate.prototype.initHelp=function(){var a=this,b=a.$wrapper,c=d(document),e=d("#wa-editor-help"),f=d("#wa-editor-help-link"),g=function(h){0>=c.find(b).length?c.off("click",g):(h=d(h.target),!h.is(e)&&0>=e.find(h).length&&e.hide())};c.on("click",g);f.on("click",function(){if(e.is(":visible"))return e.hide(),!1;e.load(a.site_app_url+"?module=pages&action=help","app=crm&key=invoice&invoice_template_id="+
a.template_id,function(){e.find("#wa-help-wa").remove();e.find("#wa-help-wa-content").remove();e.show();e.find("ul>li.no-tab>p.bold").hide();e.data("loaded",!0)});return!1});e.on("click","div.fields a.inline-link",function(h){h.preventDefault();h=d(this).find("i");var l=a.$textarea.data("wa_editor");l&&l.insert(d.trim(h.text()))})};CRMSettingsTemplate.prototype.initPreviewIframe=function(){function a(){d(document).trigger("updateEditorTextarea");b.toggleButton(!1);new CRMDialog({html:b.preview_dialog_template,
onOpen:function(c){c.find("#js-preview-content").val(b.$textarea.val());c.find(".js-preview-form").trigger("submit")}})}var b=this;b.$wrapper.on("click",".js-show-preview",function(c){c.preventDefault();a()})};CRMSettingsTemplate.prototype.initElasticFooter=function(){function a(){d.contains(document,f[0])?b():e.off("scroll",a)}function b(){var n=e.scrollTop();l.top+m>n+e.height()?h||(h=!0,g=d("<div />"),g.height(m).insertAfter(f),f.css("left",l.left).width(k).addClass("is-fixed-to-bottom")):c()}
function c(){g&&g.length&&g.remove();g=!1;f.removeAttr("style").removeClass("is-fixed-to-bottom");l=f.offset();k=f.outerWidth();m=f.outerHeight();h=!1}var e=d(window),f=this.$wrapper.find(".js-footer-block"),g=!1,h=!1,l,k,m;c();e.on("scroll",a);e.on("resize",function(){c();e.trigger("scroll")});b()};return CRMSettingsTemplate}(jQuery);var CRMEmailPersonalSettingsDialog=function(d){CRMEmailPersonalSettingsDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$textarea=this.$wrapper.find(".js-wysiwyg-field");this.dialog=this.$wrapper.data("dialog");a=!1;window&&window.parent&&window.parent.$&&window.parent.$.crm?a=window.parent.$.crm:window.$&&window.$.crm&&(a=window.$.crm);this.crm=a;this.initClass()};CRMEmailPersonalSettingsDialog.prototype.initClass=function(){this.initWYSIWYG();this.initSave()};
CRMEmailPersonalSettingsDialog.prototype.initSave=function(){function a(){if(!c){c=!0;var e=b.$form.serialize();d.post(b.crm.app_url+"?module=email&action=personalSettingsSave",e,function(f){"ok"===f.status&&(b.dialog.options.onSave(f.data||{}),b.dialog.close())}).always(function(){c=!1})}}var b=this,c=!1;b.$form.on("submit",function(e){e.preventDefault();a()})};CRMEmailPersonalSettingsDialog.prototype.initWYSIWYG=function(){var a=this.$textarea;this.crm.initWYSIWYG(a,{minHeight:130,maxHeight:130,
keydownCallback:function(c){}});var b=this.dialog.onClose;this.dialog.onClose=function(){b(arguments);var c=a.data("redactor");c&&"core"in c&&c.core.destroy()}};return CRMEmailPersonalSettingsDialog}(jQuery);
