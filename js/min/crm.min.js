var $jscomp={scope:{},findInternal:function(d,a,b){d instanceof String&&(d=String(d));for(var c=d.length,e=0;e<c;e++){var f=d[e];if(a.call(b,f,e,d))return{i:e,v:f}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(d,a,b){if(b.get||b.set)throw new TypeError("ES3 does not support getters and setters.");d!=Array.prototype&&d!=Object.prototype&&(d[a]=b.value)};
$jscomp.getGlobal=function(d){return"undefined"!=typeof window&&window===d?d:"undefined"!=typeof global&&null!=global?global:d};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(d,a,b,c){if(a){b=$jscomp.global;d=d.split(".");for(c=0;c<d.length-1;c++){var e=d[c];e in b||(b[e]={});b=b[e]}d=d[d.length-1];c=b[d];a=a(c);a!=c&&null!=a&&$jscomp.defineProperty(b,d,{configurable:!0,writable:!0,value:a})}};
$jscomp.polyfill("Array.prototype.find",function(d){return d?d:function(a,b){return $jscomp.findInternal(this,a,b).v}},"es6-impl","es3");$jscomp.SYMBOL_PREFIX="jscomp_symbol_";$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(d){return $jscomp.SYMBOL_PREFIX+(d||"")+$jscomp.symbolCounter_++};
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var d=$jscomp.global.Symbol.iterator;d||(d=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[d]&&$jscomp.defineProperty(Array.prototype,d,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(d){var a=0;return $jscomp.iteratorPrototype(function(){return a<d.length?{done:!1,value:d[a++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(d){$jscomp.initSymbolIterator();d={next:d};d[$jscomp.global.Symbol.iterator]=function(){return this};return d};$jscomp.array=$jscomp.array||{};$jscomp.iteratorFromArray=function(d,a){$jscomp.initSymbolIterator();d instanceof String&&(d+="");var b=0,c={next:function(){if(b<d.length){var e=b++;return{value:a(e,d[e]),done:!1}}c.next=function(){return{done:!0,value:void 0}};return c.next()}};c[Symbol.iterator]=function(){return c};return c};
$jscomp.polyfill("Array.prototype.keys",function(d){return d?d:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6-impl","es3");$jscomp.polyfill("Array.prototype.values",function(d){return d?d:function(){return $jscomp.iteratorFromArray(this,function(a,b){return b})}},"es6","es3");
(function(d){d.fn.shiftSelectable=function(){function a(a,c,e){var f=!1,g=a.get(0),l=c.get(0);b.find(h).each(function(){var a=this==g,c=this==l;a&&(f=!0);f&&(e.extra={is_first:a,is_last:c},k&&k(d(this),e));if(c)return f=!1})}var b=this,c=arguments;if(1<b.length)b.each(function(){d.fn.shiftSelectable.apply(d(this),c)});else{var e=b.data("shiftSelectable");if(d.isPlainObject(c[0])){if(d.isPlainObject(e))return;e=c[0]}var f=e.ns||(Math.random()+"").slice(2);if("destroy"===c[0])b.off("."+f),b.data("shiftSelectable");
else{var g,h=e.selector,k=e.onSelect,l=e.behavior_type;"vertical"!==l&&"horizontal"!==l&&"mixed"!==l&&(l="vertical");e=e.disable_text_selection;if(void 0!==e?e:1)b.attr("unselectable","on").css({"-moz-user-select":"-moz-none","-o-user-select":"none","-khtml-user-select":"none","-webkit-user-select":"none","-ms-user-select":"none","user-select":"none"}).on("selectstart",!1).on("mousedown",!1);b.on("click."+f,h,function(c){var b=d(this),e=c.shiftKey;if(g&&e){var e=g.offset(),f=b.offset(),e="vertical"===
l?f.top>e.top:"horizontal"===l?f.left>e.left:f.top>e.top||f.left>e.left;e?a(g,b,c):a(b,g,c)}g=b})}}}})(jQuery);var CRMDialog=function(d){function a(a){console&&console.log&&console.log(a)}CRMDialog=function(a){this.$wrapper=d(a.html);this.$block=this.$wrapper.find(".crm-dialog-block");this.position=a.position||!1;this.userPosition=a.setPosition||!1;this.options=a.options||!1;this.remain_after_load=a.remain_after_load||!1;this.$body=d(window.top.document).find("body");this.$window=d(window.top);this.is_closed=!1;this.is_visible=!0;this.onBgClick=a.onBgClick||!1;this.onOpen=a.onOpen||function(){};this.onClose=
a.onClose||function(){};this.onConfirm=a.onConfirm||function(){};this.onCancel=a.onCancel||function(){};this.onResize=a.onResize||!1;this.initClass()};CRMDialog.prototype.initClass=function(){var a=this;a.$wrapper.data("dialog",a);a.render();setTimeout(function(){a.bindEvents()},0)};CRMDialog.prototype.bindEvents=function(){function b(){f.is_closed||f.close();g.off("click",b);g.off("wa_before_load",b)}function c(){d.contains(document,f.$wrapper[0])?f.resize():d(window).off("resize",c)}function e(){d.contains(document,
f.$wrapper[0])?f.resize():d(document).off("refresh resizeDialog",e)}var f=this,g=d(document),h=f.$block?f.$block:f.$wrapper;f.$wrapper.on("close",b);if(!f.remain_after_load)g.on("wa_before_load",b);f.$wrapper.on("click",".crm-dialog-background",function(a){if(f.onBgClick)f.onBgClick(a);else a.stopPropagation()});g.on("keyup",function(a){27===a.keyCode&&f.is_visible&&f.close()});h.on("click",".js-cancel-dialog",function(){if("function"==typeof f.onCancel)f.onCancel(f);else a("Error: Cancel is not a function")});
h.on("click",".js-confirm-dialog",function(c){c.stopPropagation();"function"==typeof f.onConfirm?!1!==f.onConfirm(f)&&f.close():a("Error: Confirm is not a function")});h.on("click",".js-close-dialog",b);d(window).on("resize",c);g.on("refresh resizeDialog",e)};CRMDialog.prototype.render=function(){try{this.$body.append(this.$wrapper)}catch(b){a("Error: "+b.message)}this.setPosition();this.onOpen(this.$wrapper,this)};CRMDialog.prototype.setPosition=function(){function a(a){return{left:parseInt((d-a.width)/
2),top:parseInt((f-a.height)/2)}}var c=this.$window,d=c.width(),f=c.height(),c=this.$block?this.$block:this.$wrapper,g=c.outerWidth(),h=c.outerHeight(),k;k=this.position?this.position:(this.userPosition?this.userPosition:a)({width:g,height:h});0<k.left&&k.left+g>d&&(k.left=d-g-20);0<k.top?k.top+h>f&&(k.top=f-h-20):(k.top=20,g=c.find(".crm-dialog-content"),g.hide(),h=c.outerHeight(),g.height(f-h-40).addClass("is-long-content").show());c.css(k)};CRMDialog.prototype.close=function(){this.is_closed=!0;
this.onClose(this.$wrapper,this);this.$wrapper.remove()};CRMDialog.prototype.resize=function(){this.$block.addClass("is-animated");this.setPosition();if(this.onResize)this.onResize(this.$wrapper,this)};CRMDialog.prototype.hide=function(){this.$wrapper.hide();this.is_visible=!1};CRMDialog.prototype.show=function(){this.$wrapper.show();this.is_visible=!0};return CRMDialog}(jQuery);var CRMElasticBlock=function(d){CRMElasticBlock=function(a){this.$window=d(window);this.$wrapper=a.$wrapper;this.$aside=a.$aside;this.$content=a.$content;this.top_fix_class="fixed-to-top";this.bottom_fix_class="fixed-to-bottom";this.debug=a.debug;this.initClass()};CRMElasticBlock.prototype.initClass=function(){function a(){if(d.contains(document,n[0])){var b=Math.floor(h.$content.outerHeight()),k=Math.floor(n.outerHeight()),l=Math.floor(p.height()),z=m.scrollTop(),B=Math.floor(n.offset().top),E=D>
z?1:-1,H=z-t;F=n.width();if(!(!A&&l>r&&760<=q)||b&&b<k)A?(l=Math.floor(p.height()),B=Math.floor(p.offset().top),B=l+B-r-z,E=k-r,A=!1,l>k&&z>t&&(E<B?e(0):f())):g();else{var b=r>k+0,I=z<=t,G=parseInt(B+k-z-r),J=0<G,G=0>=G;if(b)0<H+0?(v||x||!w)&&e(0):(v||w||x||y)&&g();else if(I){if(v||x||w)y?B<=t&&g():g()}else J?0<E?B>=0+z&&(v||!w||x)&&e():(!v||w||x)&&c(B-t):G?u.top+l<z+r?(!v||w||x)&&c(l-k):0<E?(!v||w||x)&&c(B-t):(v||w||!x)&&f():(!v||w||x)&&c(B-t)}D=z}else m.off("scroll",a)}function b(){d.contains(document,
n[0])?(q=Math.floor(m.width()),r=Math.floor(m.height()),g(),m.trigger("scroll")):m.off("scroll",b)}function c(a){h.log("Manual top scroll position");n.css("top",a).width(F).removeClass(k).removeClass(l);v=!0;w=x=y=!1}function e(a){h.log("Fixed to top scroll position");n.removeAttr("style").width(F).removeClass(l).addClass(k);a&&(y=!0,n.css("top",a));v=x=!1;w=!0}function f(){h.log("Fixed to bottom scroll position");n.removeAttr("style").width(F).removeClass(k).addClass(l);v=w=y=!1;x=!0}function g(){h.log("Default scroll position");
n.removeAttr("style").removeClass(l).removeClass(k);v=w=x=y=!1}var h=this,k=h.top_fix_class,l=h.bottom_fix_class,m=h.$window,p=h.$wrapper,n=h.$aside;n.addClass("crm-elastic-block");var q=Math.floor(m.width()),r=Math.floor(m.height()),u=p.offset(),t=n.offset().top,A=!0,v=!1,x=!1,w=!1,y=!1,D=0,F;m.on("scroll",a).on("resize",b)};CRMElasticBlock.prototype.log=function(a){this.debug&&console.log(a)};return CRMElasticBlock}(jQuery);(function(d){function a(a,b){var c=d(window),e=c.scrollTop(),h=c.scrollLeft()+c.width(),k=c.scrollTop()+c.height(),c=c.scrollLeft(),l=a.element.offset();l.right=l.left+a.element.outerWidth();l.bottom=l.top+a.element.outerHeight();return e<l.top&&c<l.left&&h>l.right&&k>l.bottom}function b(a,b){return a.clone().addClass(b.fixed_class||"sticky-fixed").css(d.extend({position:"fixed",display:"none"},b.fixed_css||{})).removeAttr("id").insertAfter(a)}d.fn.sticky=function(c){function e(){f.closest("body").length?
d.each(h,function(a,c){g.isStaticVisible.call(c.element,c,g)?c.is_fixed&&(c.is_fixed=!1,c.fixed_clone.hide(),g.hideFixed&&g.hideFixed.call(c.fixed_clone,c,g)):(c.is_fixed||(c.is_fixed=!0,c.fixed_clone.show(),g.showFixed&&g.showFixed.call(c.fixed_clone,c,g)),g.updateFixed&&g.updateFixed.call(c.fixed_clone,c,g))}):d(window).off("resize scroll",e)}var f=this,g=d.extend({fixed_class:"sticky-fixed",isStaticVisible:a,getClone:b},c||{}),h=f.map(function(){var a=d(this);return{element:a,fixed_clone:g.getClone.call(a,
a,g),is_fixed:!1}}).get();d(window).on("resize scroll",e);e();return this}})(jQuery);(function(d){d.ajaxSetup({cache:!1});d(document).ajaxSend(function(a,b,c){c.crossDomain||"POST"!==(c.type||"").toUpperCase()||(a=(a=document.cookie.match(/(?:^|; )_csrf=([^;]*)/))?decodeURIComponent(a[1]):"",c.data||0===c.data||(c.data=""),"string"===typeof c.data?-1==c.data.indexOf("_csrf=")&&(c.data+=(0<c.data.length?"&":"")+"_csrf="+a,b.setRequestHeader("Content-type","application/x-www-form-urlencoded")):"object"===typeof c.data&&(window.FormData&&c.data instanceof window.FormData?"function"==
typeof c.data.set?c.data.set("_csrf",a):c.data.append("_csrf",a):c.data._csrf=a))});d(document).ajaxError(function(a,b,c,e){if(b.getResponseHeader("wa-session-expired"))return window.location.reload();502===b.status&&"abort"==e||c.url&&0<=c.url.indexOf("background_process")||c.data&&0<=c.data.indexOf("background_process")?console&&console.log&&console.log("Notice: XHR failed on load: "+c.url):200!==b.status&&b.responseText&&(a=b.responseText,d.crm&&d.crm.is_debug&&(a=d.crm.confirm.template.replace("%title%",
"XHR error "+b.status).replace("%text%",b.responseText).replace("%button%","Close")),(new CRMDialog({html:a})).$wrapper.find(".wa-exception-debug-dump #Trace pre").each(function(){var a=d(this),c=a.html().replace(/^(#(#|\d+)\s+(wa-system|index\.php|\{main\}).*)$/gm,'<span style="color:#999">$1</span>');a.html(c)}),-1===a.indexOf("crm-dialog-wrapper")&&(document.open("text/html"),document.write(b.responseText),document.close()))});d.crm=d.extend(d.crm||{},{lang:!1,app_url:!1,backend_url:!1,is_debug:!1,
is_page_loaded:!1,content:!1,sidebar:!1,storage:new d.store,locales:!1,confirm:{show:function(a){var b=a.text||"",c=a.button||"",e=a.onConfirm||function(){},f=a.onCancel||function(){},g=a.onClose||function(){},h=d.crm.confirm.template;if(h=h.replace("%title%",a.title||"").replace("%text%",b).replace("%button%",c))return new CRMDialog({html:h,onConfirm:e,onCancel:f,onClose:g})},template:""},alert:{show:function(a){var b=a.text||"",c=a.button||d.crm.locales.close||"",e=a.button_class||"gray",f=d.crm.alert.template,
f=f.replace("%title%",a.title||"").replace("%text%",b).replace("%button%",c);if(!f)throw"Not found alert dialog";a=d.extend({},a,!0);a.html=f;f=new CRMDialog(a);f.$wrapper.find(".js-close-dialog").addClass(e);return f},template:""},title:{pattern:"CRM \u2014 %s",set:function(a){if(a){var b=history.state;b&&(b.title=a);document.title=d.crm.title.pattern.replace("%s",a)}}},check:{email:function(a){var b=!1;0<a.length&&1<=(a.match(/.+?\@.+/g)||[]).length&&(b=!0);return b}},encodeHTML:function(a){return a&&
(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},renderSVG:function(a){if("object"!==typeof d3)return!1;var b=function(a,d){b=function(a){this.$icon=a.$icon;this.svg=d.select(this.$icon[0]).append("svg");this.type=this.$icon.data("type");this.icon_w=this.$icon.outerWidth();this.icon_h=this.$icon.outerHeight();this.initClass()};b.prototype.initClass=function(){this.svg.attr("width",this.icon_w).attr("height",this.icon_h);this.$icon.hasClass("funnel-state")?this.renderFunnelState():
this.$icon.hasClass("funnel")?this.renderFunnel():this.$icon.hasClass("funnel-1")&&this.renderFunnel(1);this.$icon.data("icon",this)};b.prototype.renderFunnelState=function(){function a(a){return a/16*b.icon_w}function c(a){return a/16*b.icon_h}var b=this,d=b.$icon.data("color")||"#aaa",e=b.svg.append("g");e.append("polygon").attr("points",a(4)+","+c(16)+" "+a(0)+","+c(16)+" "+a(3.9)+","+c(7.9)+" "+a(0)+","+c(0)+" "+a(4)+","+c(0)+" "+a(8.7)+","+c(7.9)).style("opacity",.33).style("fill",d);e.append("polygon").attr("points",
a(8)+","+c(16)+" "+a(4)+","+c(16)+" "+a(7.9)+","+c(7.9)+" "+a(4)+","+c(0)+" "+a(8)+","+c(0)+" "+a(12.6)+","+c(7.9)).style("opacity",.66).style("fill",d);e.append("polygon").attr("points",a(11.9)+","+c(16)+" "+a(7.9)+","+c(16)+" "+a(11.8)+","+c(7.9)+" "+a(7.9)+","+c(0)+" "+a(11.9)+","+c(0)+" "+a(16)+","+c(7.9)).style("fill",d)};b.prototype.renderFunnel=function(c){function b(){var a=[],b=d.icon_w,e=d.icon_h,f,g,h;0<p&&(b-=p,e-=p);f=b-6+",0";g=b+","+e/2;b=b-6+","+e;h="0,"+e;e="6,"+e/2;a.push("0,0");
a.push(f);a.push(g);a.push(b);a.push(h);c&&1===c||a.push(e);return a.join(" ")}var d=this,e=d.$icon.data("color")||"#aaa",f=a.crm.color(e),m=d.$icon.data("hover-color")||f.getTone(20),p=d.$icon.data("stroke-width")||0,n=d.$icon.data("hover")||!1,q=d.svg.append("g").append("polygon").attr("class","is-animated").attr("points",b()).attr("transform","translate("+p/2+","+p/2+")").style("fill",e);0<p&&(f=f.getTone(-20),q.style("stroke",f).style("stroke-width",p));n&&(n=q.node(),n=a(n).closest(".c-state-item "),
n.on("mouseenter",function(){q.style("fill",m)}),n.on("mouseleave",function(){q.style("fill",e)}));(function(){function c(){f||(f=!0,setTimeout(e,100))}function e(){a.contains(document,d.$icon[0])?(d.refresh(),q.attr("points",b())):a(window).off("resize refresh-icons",c);f=!1}var f=!1;a(window).on("resize refresh-icons",c)})()};b.prototype.refresh=function(){this.icon_w=this.$icon.outerWidth();this.icon_h=this.$icon.outerHeight();this.svg.attr("width",this.icon_w).attr("height",this.icon_h)};return b}(jQuery,
d3);"string"===typeof a&&(a=d(a));a.length&&a.find(".svg-icon").each(function(){var a=d(this),e=a.data("icon");e?e.refresh():b&&new b({$icon:a})})},tabSlider:function(a){var b=function(a){b=function(a){this.$wrapper=a.$wrapper;this.$slider=a.$slider;this.$activeSlide=a.$activeSlide||!1;this.type_class=!1;this.left=0;this.slider_w=this.wrapper_w=!1;this.initClass()};b.prototype.initClass=function(){function c(){a.contains(document,b.$wrapper[0])?b.wrapper_w!==b.$wrapper.outerWidth()&&b.reset():d.off("resize",
c)}var b=this,d=a(window);b.detectSliderWidth();b.initStartPosition();d.on("resize",c);b.$wrapper.on("click",".c-action",function(c){c.preventDefault();c=a(this);c.hasClass("left")&&b.moveSlider(!1);c.hasClass("right")&&b.moveSlider(!0)})};b.prototype.initStartPosition=function(){var a=0;if(this.$activeSlide.length){var c=this.$activeSlide.outerWidth(),b=Math.floor(Math.abs(this.$wrapper.offset().left-this.$activeSlide.offset().left));b+c>this.wrapper_w&&(a=b-40)}a?(this.start_left=a,this.moveSlider(!0,
a)):this.showArrows()};b.prototype.detectSliderWidth=function(){this.wrapper_w=this.$wrapper.outerWidth();this.slider_w=this.$slider.outerWidth()};b.prototype.showArrows=function(){function a(a){c.type_class&&c.$wrapper.removeClass(c.type_class);a&&(c.$wrapper.addClass(a),c.type_class=a)}var c=this;0<=c.left?c.wrapper_w<c.slider_w?a("type-1"):a():c.wrapper_w<c.slider_w-Math.abs(c.left)?a("type-2"):a("type-3")};b.prototype.setLeft=function(a){0<Math.abs(a)||(a=0);this.$slider.css("left",a?a+"px":0);
this.left=a};b.prototype.moveSlider=function(a,c){var b=c?c:100,d=this.slider_w-this.wrapper_w,e=0;0<d&&(e=Math.abs(this.left)+(a?b:-b),e>d?e=d:0>e&&(e=0));this.setLeft(-e);this.showArrows()};b.prototype.reset=function(){this.setLeft(0);this.detectSliderWidth();this.showArrows()};return b}(d);return new b(a)},color:function(a){var b=function(){function a(a,c,b){a=parseInt(a,16);c=parseInt(c,16);b=parseInt(b,16);return 0<=a&&0<=c&&0<=b?[a,c,b]:null}function d(a){a[0]=parseInt(a[0].toFixed());a[1]=
parseInt(a[1].toFixed());a[2]=parseInt(a[2].toFixed());var c=a[0].toString(16),b=a[1].toString(16);a=a[2].toString(16);return 0<=c.length&&0<=b.length&&0<=a.length?"#"+(1==c.length?"0"+c:c)+(1==b.length?"0"+b:b)+(1==a.length?"0"+a:a):null}function f(a){var c=(a[0]+16)/116,b=a[1]/500+c,d=c-a[2]/200,e,b=.95047*(.008856<b*b*b?b*b*b:(b-16/116)/7.787),c=1*(.008856<c*c*c?c*c*c:(c-16/116)/7.787),d=1.08883*(.008856<d*d*d?d*d*d:(d-16/116)/7.787);a=3.2406*b+-1.5372*c+-.4986*d;e=-.9689*b+1.8758*c+.0415*d;c=
.0557*b+-.204*c+1.057*d;a=.0031308<a?1.055*Math.pow(a,1/2.4)-.055:12.92*a;e=.0031308<e?1.055*Math.pow(e,1/2.4)-.055:12.92*e;c=.0031308<c?1.055*Math.pow(c,1/2.4)-.055:12.92*c;return[255*Math.max(0,Math.min(1,a)),255*Math.max(0,Math.min(1,e)),255*Math.max(0,Math.min(1,c))]}function g(a){var c=a[0]/255,b=a[1]/255,d=a[2]/255,e,c=.04045<c?Math.pow((c+.055)/1.055,2.4):c/12.92,b=.04045<b?Math.pow((b+.055)/1.055,2.4):b/12.92,d=.04045<d?Math.pow((d+.055)/1.055,2.4):d/12.92;a=(.4124*c+.3576*b+.1805*d)/.95047;
e=(.2126*c+.7152*b+.0722*d)/1;c=(.0193*c+.1192*b+.9505*d)/1.08883;a=.008856<a?Math.pow(a,1/3):7.787*a+16/116;e=.008856<e?Math.pow(e,1/3):7.787*e+16/116;c=.008856<c?Math.pow(c,1/3):7.787*c+16/116;return[116*e-16,500*(a-e),200*(e-c)]}function h(a,c,b){var d,e,f,g=Math.floor(6*a),h=6*a-g;a=b*(1-c);var k=b*(1-h*c);c=b*(1-(1-h)*c);switch(g%6){case 0:d=b;e=c;f=a;break;case 1:d=k;e=b;f=a;break;case 2:d=a;e=b;f=c;break;case 3:d=a;e=k;f=b;break;case 4:d=c;e=a;f=b;break;case 5:d=b,e=a,f=k}return[255*d,255*
e,255*f]}function k(a){var c,b,d=a[0]/255,e=a[1]/255,f=a[2]/255,g,h,k=Math.max(d,e,f);b=k-Math.min(d,e,f);0==b?g=h=0:(h=b/k,a=(k-d)/6/b+.5,c=(k-e)/6/b+.5,b=(k-f)/6/b+.5,d===k?g=b-c:e===k?g=1/3+a-b:f===k&&(g=2/3+c-a),0>g?g+=1:1<g&&--g);return{h:Math.round(360*g),s:Math.round(100*h),b:Math.round(100*k)}}b=function(c){c=this.hex=c;var b=!1;"string"===typeof c?(c=c.replace("#",""),3===c.length?b=a(c[0]+""+c[0],c[1]+""+c[1],c[2]+""+c[2]):6===c.length&&(b=a(c[0]+""+c[1],c[2]+""+c[3],c[4]+""+c[5]))):"object"===
typeof c&&3===c.length&&(b=c);this.rgb=b};b.prototype.getRange=function(){var a=this.rgb?g(this.rgb):!1;if(a){var c=f([90,a[1],a[2]]),b=f([40,a[1],a[2]]),a=d(c),e=d(b),a=[a,e];a.getColor=function(a){if(0<=a&&100>=a){var e=c[0],f=c[1],g=c[2];return d([Math.floor(e+(b[0]-e)*a/100),Math.floor(f+(b[1]-f)*a/100),Math.floor(g+(b[2]-g)*a/100)])}return null};return a}return null};b.prototype.getTone=function(a){function c(a){100<a?a=100:0>a&&(a=0);return a}var b=k(this.rgb);b.s=c(b.s*(1+a/100));b.b=c(b.b*
(1+a/100));a=h(b.h/360,b.s/100,b.b/100);return d(a)};return b}();return new b(a)},initWYSIWYG:function(a,b){if(!a||!a.length||a.data("redactor"))return a;b=d.extend({minHeight:130,buttons:"inline bold italic underline deleted lists outdent indent image link horizontalrule fontcolor fontsize fontfamily".split(" "),plugins:["fontcolor","fontsize","fontfamily"],allowedTags:"a b i u pre blockquote p strong em del strike span ul ol li div span br".split(" "),uploadImage:!1,lang:this.lang},b||{});a.redactor(b);
d(document).one("wa_before_render",function(){d.contains(document,a[0])&&a.data("redactor")&&a.redactor("core.destroy")});return a},escape:function(a){return d("<div />").text(a).html()},runBackgroundWorker:function(a){var b=Math.floor(100*Math.random())/100,c=Math.floor(100*Math.random())/100,e=a.delay||1E4,f=e/2,g=a.id||(""+Math.random()).slice(2),h=null,k=null,l=a.url;l?(e+=f*b,200>=e?console.error("Delay value too low"):function(){try{var a=function(){h&&clearTimeout(h);k&&k.abort();k=d.post(l,
{process_id:g});k.always(function(){k=null;h=setTimeout(a,e)});k.error(function(){return!1})};h=setTimeout(a,500+300*c)}catch(p){console.error(["source email worker fail",p])}}()):console.error("Empty url")}})})(jQuery);(function(d,a){d.fn.serializeObject=function(){var b={};d.each(this.serializeArray(),function(c,e){var f=e.name,g=e.value;b[f]=b[f]===a?g:d.isArray(b[f])?b[f].concat(g):[b[f],g]});return b}})(jQuery);
(function(d){var a=null,b=!1;d(document).on("dragover",function(c){c.preventDefault();a?clearTimeout(a):b||(b=!0,d(document).trigger("myDragEnter"));a=setTimeout(function(){a=null;b=!1;d(document).trigger("myDragLeave")},100)});d(document).on("drop",function(a){a.preventDefault()})})(jQuery);
var ContentRouter=function(d){ContentRouter=function(a){this.$window=d(window);this.$content=a.$content;this.api_enabled=!(!window.history||!window.history.pushState);this.xhr=!1;this.is_enabled=!0;this.need_confirm=!1;this.initClass()};ContentRouter.prototype.initClass=function(){this.bindEvents()};ContentRouter.prototype.bindEvents=function(){var a=this,b=window.location.origin+d.crm.app_url;d(document).on("click","a",function(c){var e=d(this),f=e.attr("href");f||(e.attr("href","javascript:void(0);"),
f=e.attr("href"));var e=e.hasClass("js-disable-router"),g=this.href.substr(0,b.length)==b,f=!("#"===f||"javascript:"===f.substr(0,11)),f=a.is_enabled&&!e&&g&&f;if(!c.ctrlKey&&!c.shiftKey&&!c.metaKey&&f){c.preventDefault();var h=this.href;a.need_confirm?d.crm.confirm.show({title:d.crm.locales.unsaved_dialog_title,text:d.crm.locales.unsaved_dialog_text,button:d.crm.locales.unsaved_dialog_button,onConfirm:function(){d(document).trigger("unsavedChanges",!1);a.load(h)}}):a.load(h)}});d("#wa-app-crm").on("click",
"a",function(a){a.stopPropagation()});a.api_enabled&&(window.onpopstate=function(c){c.stopPropagation();a.onPopState(c)});d(document).on("unsavedChanges",function(c,b){a.need_confirm=!!b})};ContentRouter.prototype.load=function(a,b){var c=this;if(!(0<=a.indexOf(d.crm.app_url)))return alert("Determine the path error"),!1;c.animate(!0);c.xhr&&c.xhr.abort();d(document).trigger("wa_before_load",{content_uri:a});c.xhr=d.ajax({method:"GET",url:a,dataType:"html",global:!1,cache:!1}).done(function(e){c.api_enabled&&
!b&&history.pushState({reload:!0,content_uri:a},"",a);c.setContent(e);c.animate(!1);c.xhr=!1;d(document).trigger("wa_loaded")}).fail(function(a){a.responseText&&(a={title:"Error",text:a.responseText,ok_button:"Close"},d.post("?module=dialogConfirm",a,function(a){new CRMDialog({html:a})}))});return c.xhr};ContentRouter.prototype.reload=function(){var a=this.api_enabled&&history.state&&history.state.content_uri?history.state.content_uri:location.href;return a?this.load(a,!0):d.when()};ContentRouter.prototype.setContent=
function(a){d(document).trigger("wa_before_render");this.$content.html(a)};ContentRouter.prototype.onPopState=function(a){if(a=a.state||!1){if(!a.content_uri)return alert("Determine the path error"),!1;d(document).trigger("wa_before_load");a.reload?this.reload(a.content_uri):a.content&&this.setContent(a.content);a.title&&d.crm.title.set(a.title);d(document).trigger("wa_loaded")}else location.reload()};ContentRouter.prototype.animate=function(a){};return ContentRouter}(jQuery),CrmEditable=function(d){var a=
function(a){this.$wrapper=a.$wrapper;this.save=a.onSave||function(){};this.render=a.onRender||!1;this.placeholder=a.placeholder||"";this.text=(this.is_empty=this.$wrapper.hasClass("is-empty"))?"":d.trim(this.$wrapper.text());this.is_edit=this.$field=!1;this.initClass()};a.prototype.initClass=function(){this.$field=this.renderField();this.bindEvents()};a.prototype.bindEvents=function(){var a=this;a.$wrapper.on("click",function(){a.toggle()});var c=!1,d=!1;a.$field.on("blur",function(){d||c||(c=!0,
a.save(a),c=!1);d=!1});a.$field.on("keyup",function(b){var e=27===b.keyCode;13!==b.keyCode||c?e&&(a.$field.val(a.text),a.toggle("hide"),d=!0):(c=!0,a.save(a),d=!0,c=!1)})};a.prototype.renderField=function(){var a=this.text,c=d('<input class="bold" type="text" name="" />');this.placeholder&&c.attr("placeholder",this.placeholder);this.is_empty||c.val(a);c.hide();this.$wrapper.after(c);this.render&&this.render(this,c);return c};a.prototype.toggle=function(a){if(a="hide"!==a){var c=this.$wrapper.parent().width(),
b=this.$wrapper.width(),d=Math.floor(c/2),c=c-10;this.$field.width(b>c?c:b<d?d:b);this.$wrapper.hide();this.$field.show().focus()}else this.$wrapper.show(),this.$field.hide();this.is_edit=a};a.prototype.loading=function(a){this.$field.siblings(".crm-editable-loading").remove();arguments.length&&!a?this.$field.prop("disabled",!1):(this.$field.after('<i class="icon16 loading crm-editable-loading"></i>'),this.$field.prop("disabled",!0));return this};a.prototype.isLoading=function(a){return 0<this.$field.siblings(".crm-editable-loading").length};
a.prototype.getText=function(){return this.$field.val()};a.prototype.setText=function(a,c){this.text=a;this.$field.val(a);this.$wrapper.text(void 0===c?a:c);return this};a.prototype.hide=function(){this.reset();this.loading(!1);this.toggle("hide");return this};a.prototype.reset=function(){this.setText(this.text,this.$wrapper.text());return this};a.prototype.isChanged=function(){return this.getText()!==this.text};return a}($);(function(d){function a(a,c){var b=new RegExp(d.ui.autocomplete.escapeRegex(c),"i");return d.grep(a,function(a){return b.test(d("<div>").html(a.label||a.value||a).text())})}var b=d.ui.autocomplete.prototype,c=b._initSource;d.extend(b,{_initSource:function(){this.options.html&&d.isArray(this.options.source)?this.source=function(c,b){b(a(this.options.source,c.term))}:c.call(this)},_renderItem:function(a,c){var b=this.options.item_clz||"";this.options.html&&(b+=" ui-menu-item-html");return d("<li class='"+
b+"'></li>").data("item.autocomplete",c).append(d("<div></div>")[this.options.html?"html":"text"](c.label)).appendTo(a)}})})(jQuery);var CRMSidebar=function(d){CRMSidebar=function(a){this.$wrapper=a.$wrapper;this.selected_class="selected";this.$activeMenuItem=this.$wrapper.find("li."+this.selected_class+":first")||!1;this.xhr=!1;this.timer=0;this.initClass()};CRMSidebar.prototype.initClass=function(){var a=this;a.initElasticBlock();a.initUpdater();a.initSearch();a.initRecent();a.$activeMenuItem.length||a.selectLink();a.$wrapper.on("click","li > a",function(){var b=d(this),c=b.attr("href");b.find(".js-indicator").remove();if(c&&
"javascript:"!=c.substr(0,11)&&!b.hasClass("js-no-highlight")){if("icon16 loading"!==b.find(".icon16").attr("class")){var e=b.find(".icon16").attr("class"),f=b.find(".icon16").attr("style");b.find(".icon16").attr("class","icon16 loading").attr("style","");d(document).on("wa_loaded",function(){b.find(".icon16").attr("class",e).attr("style",f);b.find(".highlighted").remove()})}a.setItem(b.closest("li"));d.crm.title.set(b.text())}})};CRMSidebar.prototype.setItem=function(a){if(this.$activeMenuItem&&
this.$activeMenuItem[0]==a[0])return!1;this.$activeMenuItem&&this.$activeMenuItem.removeClass(this.selected_class);a.addClass(this.selected_class);this.$activeMenuItem=a};CRMSidebar.prototype.selectLink=function(a){var b;a&&(b=this.$wrapper.find('a[href="'+a+'"]:first'));if(b&&b.length)this.setItem(b.closest("li"));else{a=this.$wrapper.find("a[href^='"+d.crm.app_url+"']");var c=location.pathname,e=0,f=0;a.each(function(a){var b=d(this).attr("href"),g=b.length;0<=c.indexOf(b)&&g>e&&(e=g,f=a)});if(f||
0===f)b=a.eq(f),this.setItem(b.closest("li"))}};CRMSidebar.prototype.reload=function(){var a=this,b=d.crm.app_url+"?module=sidebar";clearTimeout(a.timer);a.xhr&&a.xhr.abort();a.xhr=d.get(b,function(c){a.xhr=!1;a.$wrapper.replaceWith(c)})};CRMSidebar.prototype.initElasticBlock=function(){var a=this;d(document).ready(function(){new CRMElasticBlock({$wrapper:d("#wa-app"),$aside:a.$wrapper,$content:d.crm.content.$content});var b=d(window);0<b.scrollTop()&&b.trigger("scroll")})};CRMSidebar.prototype.initUpdater=
function(){var a=this;a.timer=setTimeout(function(){d.contains(document,a.$wrapper[0])&&a.reload()},3E5)};CRMSidebar.prototype.initRecent=function(){var a=this.$wrapper.find(".js-recent-wrapper"),b=a.find(".js-pinned-list");a.find(".js-recent-list");var c=a.find(".heading"),e=c.find(".icon16");a.on("click",".js-pin-recent",function(a){a.preventDefault();a.stopPropagation();var c=d(this),e=c.closest("li");a={contact_id:e.data("id")};d.post("?module=recent&action=pin",a,function(a){if("ok"==a.status){c.removeClass("js-pin-recent").addClass("js-unpin-recent").removeClass("star-empty").addClass("star");
a=b.offset().top;var d=b.outerHeight(),f=e.offset().top;a=a+d+3-f;e.addClass("highlighted");a&&(a+="px",e.css({"-webkit-transform":"translate(0,"+a+")",transform:"translate(0,"+a+")"}));setTimeout(function(){e.removeClass("highlighted").removeAttr("style");e.appendTo(b)},400)}})});a.on("click",".js-unpin-recent",function(a){a.preventDefault();a.stopPropagation();var c=d(this).closest("li");a={contact_id:c.data("id")};d.post("?module=recent&action=unpin",a,function(a){"ok"==a.status&&c.remove()})});
a.on("click",".js-recent-heading-hidden",function(){a.removeClass("js-recent-fold-hidden").addClass("js-recent-fold-visible");c.removeClass("js-recent-heading-hidden").addClass("js-recent-heading-visible");e.attr("class","icon16 darr");d.post("?module=recent&action=fold",{fold_hidden:0});d(window).trigger("scroll")});a.on("click",".js-recent-heading-visible",function(){a.removeClass("js-recent-fold-visible").addClass("js-recent-fold-hidden");c.removeClass("js-recent-heading-visible").addClass("js-recent-heading-hidden");
e.attr("class","icon16 rarr");d.post("?module=recent&action=fold",{fold_hidden:1});d(window).trigger("scroll")})};CRMSidebar.prototype.initSearch=function(){var a=this.$wrapper.find(".js-search-form"),b=a.find(".js-search-field");a.on("submit",function(a){a.preventDefault();a=b.val();a=a.replace(/\//g,"\\/").replace(/&/g,"\\&").replace(/\+/g,"");if(!a.length||!d.trim(a))return!1;a=d.crm.app_url+"contact/search/result/contact_info."+(0<=a.indexOf("@")?"email":"name.name")+"*="+encodeURIComponent(a);
d.crm.content.load(a);b.val("")});b.autocomplete({appendTo:a,classes:{"ui-autocomplete":"c-search-results-list"},source:"?module=autocompleteSidebar",minLength:2,html:!0,focus:function(){return!1},select:function(a,e){var c=e.item.link;c&&d.crm.content.load(d.crm.app_url+c);b.val("");return!1}}).data("ui-autocomplete")._renderItem=function(a,b){return d("<li />").addClass("ui-menu-item-html").append("<div>"+b.value+"</div>").appendTo(a)}};return CRMSidebar}(jQuery);var CRMDeal=function(d){var a=function(c){a=function(a){this.$window=c(window);this.$wrapper=a.$wrapper;this.$outer_wrapper=a.$outer_wrapper;this.debug=a.debug;this.indent={top:0};this.$clone=null;this.offset=this.getOffset();this.type=null;this.init()};a.prototype.init=function(){function a(){c.contains(document,d.$wrapper[0])?(d.reset(),d.onScroll()):c(document).off("refresh",a)}function b(){if(c.contains(d.$window[0].document,d.$wrapper[0]))d.onScroll();else d.$window.off("scroll",b)}var d=this;
d.$clone=function(a){var b=c("<div />");a.before(b);return b.hide()}(d.$wrapper);d.onScroll();var h=0;d.$window.on("resize",function(){clearTimeout(h);h=setTimeout(function(){d.reset();d.onScroll()},50)});c(document).on("refresh",a);d.$window.on("scroll",b)};a.prototype.onScroll=function(){var a=this.$window.scrollTop(),c=this.$window,b=c.width();c.height();var c=this.offset,d=this.$outer_wrapper.outerHeight();!(0<b)||d<=this.offset.height?this.fixTo("default"):a<=c.top-this.indent.top?this.fixTo("default"):
this.fixTo("fix_top")};a.prototype.fixTo=function(a,b){a=a?a:null;this.type!==a&&("fix_top"===a?(this.$wrapper.removeAttr("style"),this.$clone.css({height:this.$wrapper.outerHeight()}).show(),this.$wrapper.css({position:"fixed",top:this.indent.top,left:this.offset.left-10,width:this.offset.width+20}),this.$wrapper.addClass("is-fixed-top")):(this.$wrapper.removeClass("is-fixed-top").removeAttr("style"),this.$clone.hide().height(0),this.$wrapper[0].scrollTop=0),c(document).trigger("refresh-icons"),
this.type=a,this.log(a))};a.prototype.reset=function(){this.fixTo("default");this.offset=this.getOffset()};a.prototype.getOffset=function(){var a=this.$wrapper.offset();return{top:a.top,left:a.left,width:this.$wrapper.outerWidth(),height:this.$wrapper.outerHeight()}};a.prototype.log=function(a){this.debug&&console.log(a)};return a}(jQuery),b=function(a){function c(a){var c=0;a.indent&&(c="function"===typeof a.indent?a.indent():a.indent);return c}b=function(c){this.$window=a(window);this.$wrapper=
c.$wrapper;this.$outer_wrapper=c.$outer_wrapper;this.debug=c.debug;this.indent=c.indent;this.$clone=null;this.offset=this.getOffset();this.type=null;this.init()};b.prototype.init=function(){function c(){a.contains(document,d.$wrapper[0])?(d.reset(),d.onScroll()):a(document).off("refresh",c)}function b(){if(a.contains(d.$window[0].document,d.$wrapper[0]))d.onScroll();else d.$window.off("scroll",b)}var d=this;d.$clone=function(c){var b=a("<div />");c.before(b);return b.hide()}(d.$wrapper);d.onScroll();
var e=0;d.$window.on("resize",function(){clearTimeout(e);e=setTimeout(function(){d.reset();d.onScroll()},50)});a(document).on("refresh",c);d.$window.on("scroll",b)};b.prototype.onScroll=function(){var a=this.$window.scrollTop(),b=c(this),d=this.$window,e=d.width();d.height();var d=this.offset,l=this.$outer_wrapper.outerHeight();!(0<e)||l<=this.offset.height?this.fixTo("default"):a<=d.top-b?this.fixTo("default"):this.fixTo("fix_top")};b.prototype.fixTo=function(a,b){function d(){var a=f.getHeight();
f.$wrapper.css({position:"static",top:"auto",left:"auto",width:"auto",height:a});f.$clone.hide().height(0)}function e(){var a=f.getHeight();f.$wrapper.css({position:"fixed",top:c(f),left:f.offset.left,width:f.offset.width,height:a});f.$clone.css({height:a}).show()}var f=this;a=a?a:null;"fix_top"===a?(e(),f.type!==a&&f.$wrapper.addClass("is-fixed")):(d(),f.type!==a&&f.$wrapper.removeClass("is-fixed"));f.type=a;f.log(a)};b.prototype.reset=function(){this.fixTo("default");this.offset=this.getOffset()};
b.prototype.getOffset=function(){var a=this.$wrapper.offset();return{top:a.top,left:a.left,width:this.$wrapper.outerWidth(),height:this.$wrapper.outerHeight()}};b.prototype.log=function(a){this.debug&&console.log(a)};b.prototype.getHeight=function(){var a=this.$window.height(),b=c(this);this.offset.top-this.$window.scrollTop()>b&&(b=this.offset.top-this.$window.scrollTop());var d=this.$outer_wrapper.offset().top+this.$outer_wrapper.outerHeight(),e=this.$window.height()+this.$window.scrollTop();return a-
b-(0>d-e?Math.abs(d-e):0)};return b}(jQuery);CRMDeal=function(a){this.$wrapper=a.$wrapper;this.$aside=this.$wrapper.find(".c-deal-aside");this.locales=a.locales;this.templates=a.templates;this.deal=a.deal||{};this.deal_id=this.deal.id||0;this.order_id=a.order_id||0;this.user_id=a.user_id;this.funnel_id=a.funnel_id;this.can_edit_deal=a.can_edit_deal||!1;this.shop_in_welcome_stage=a.shop_in_welcome_stage||!1;this.remove_is_locked=this.is_locked=!1;this.init()};CRMDeal.prototype.init=function(){var a=
this;d.crm.renderSVG(a.$wrapper);d.crm.sidebar.reload();a.can_edit_deal&&(a.initChangeState(),a.initCloseDeal(),a.initReopenDeal(),a.initAddContact(),a.initRemoveFiles(),a.initEditableName(),a.initChangeDate(),a.initChangePrice(),a.initChangeUser(),a.initChangeClient(),a.initDealDelete(),a.initAssignTags(),a.initCreateOrderLink(),a.initEditOrderLink());a.initCall();a.initMessages();a.initOrderEditShippingDetailLink();a.initSticky();a.initOrderSection();a.initScroll();a.$wrapper.on("click",".js-remove-owner",
function(c){c.preventDefault();a.remove_is_locked||a.removeOwner(d(this).closest(".c-contact"))});a.$wrapper.on("click",".js-remove-contact",function(c){c.preventDefault();a.remove_is_locked||a.removeContact(d(this).closest(".c-contact"))});a.$wrapper.on("click",".js-add-external-contact",function(c){c.preventDefault();a.addExternalContact(d(this))})};CRMDeal.prototype.initScroll=function(){function a(){d.contains(document,h.$wrapper[0])?f():k.off("scroll",a)}function b(){d.contains(document,h.$wrapper[0])?
g():k.off("resize",b)}function f(){0<k.scrollTop()?m||(l.show(),m=!0):m&&(l.hide(),m=!1)}function g(){var a=n.offset().left;l.css("right",k.width()-a)}var h=this,k=d(window),l=d('<div class="\u0441-scroll-action"><div class="c-icon to-top"></div></div>'),m=!1,p=h.$wrapper.find(".c-deal-board"),n=h.$wrapper.find(".c-deal-aside-wrapper");p.append(l);f();g();l.on("click",function(){d("html, body").animate({scrollTop:0},500)});k.on("scroll",a);k.on("resize",b)};CRMDeal.prototype.initSticky=function(){function c(){0<
f[0].scrollTop?f.addClass("is-scrolled"):f.removeClass("is-scrolled")}var d=this.$wrapper.find(".js-page-header"),f=this.$wrapper.find("#js-deal-aside");new a({$wrapper:d,$outer_wrapper:this.$wrapper,debug:!1});new b({$wrapper:f,$outer_wrapper:f.closest(".c-deal-board"),indent:function(){return d.outerHeight()},debug:!1});c();f.on("scroll",c)};CRMDeal.prototype.initChangeState=function(){function a(a){function c(){d.crm.content.load(d.crm.app_url+"deal/"+b.deal_id+"/")}d.post("?module=deal&action=move",
{deal_id:b.deal_id,stage_id:a},function(e){"ok"===e.status&&(e.data.dialog_html&&e.data.dialog_html.html?new CRMDialog({html:e.data.dialog_html.html,options:{onShopSubmit:c},onConfirm:function(){d.post("?module=deal&action=move",{deal_id:b.deal_id,stage_id:a,force_execute:1},c)}}):c())},"json")}var b=this;b.$wrapper.find(".c-funnel-wrapper").on("click",".c-state-item.js-set-state",function(c){c.preventDefault();c=d(this);if(c.hasClass("selected"))return!1;c=c.data("id");a(c)})};CRMDeal.prototype.initCloseDeal=
function(){var a=this,b=!1;a.$wrapper.on("click",".js-close-deal",function(c){c.preventDefault();b||(b=!0,d.post("?module=deal&action=closeDialog",{id:a.deal_id},function(a){new CRMDialog({html:a})}).always(function(){b=!1}))})};CRMDeal.prototype.initReopenDeal=function(){var a=this,b=!1;a.$wrapper.on("click",".js-reopen-deal",function(c){c.preventDefault();b||(b=!0,d.post("?module=deal&action=reopen",{id:a.deal_id},function(a){"ok"==a.status?d.crm.content.reload():alert("Error: Deal Reopen")},"json").always(function(){b=
!1}))})};CRMDeal.prototype.initAddContact=function(){function a(a,c){var b=a.closest(".c-add-contact");c?(h.hide(),b.addClass("is-shown")):(h.show(),b.removeClass("is-shown"))}function b(a,c){function b(a){a=a?a:[];d.each(a,function(a,c){var b=c.text,e=d('<div class="errormsg" />').html(b);h.one("click",function(){e.remove()});g.prepend(e)})}c=c?c:function(){};d.post("?module=deal&action=userAdd",{contact_id:a,deal_id:f.deal_id},function(a){"ok"===a.status?c(a.data.html):a.errors&&b(a.errors)},"json")}
var f=this,g=f.$aside.find(".js-add-user-wrapper"),h=g.find(".js-add-contact");h.on("click",function(c){c.preventDefault();a(d(this),!0)});g.on("click",".js-close-add-contact",function(c){c.preventDefault();a(d(this))});(function(){function a(a,e){var g=f.$aside.find('.c-contact[data-id="'+a+'"]');g.length&&c(g);b(a,function(a){a=d(a);e.before(a);c(a);d(document).trigger("refresh")})}function c(a){a.addClass("is-highlight");setTimeout(function(){d.each(a,function(a,c){d.contains(document,c)&&d(this).removeClass("is-highlight")})},
3E3)}f.$aside.find(".js-contact-autocomplete").each(function(){var c=d(this);c.autocomplete({appendTo:f.$aside,source:d.crm.app_url+"?module=autocomplete&type=user&funnel_id="+f.funnel_id,minLength:0,html:!0,focus:function(){return!1},select:function(b,d){a(d.item.id,c.closest(".c-add-contact"));c.val("");f.$aside.find(".js-close-add-contact").trigger("click");return!1}}).data("ui-autocomplete")._renderItem=function(a,c){var b=d("<li />");b.addClass("ui-menu-item-html").append("<div>"+c.value+"</div>").appendTo(a);
c.rights||(b.addClass("is-locked"),b.on("click",function(a){a.preventDefault();a.stopPropagation()}));return b};c.on("focus",function(){c.data("uiAutocomplete").search(c.val())})})})()};CRMDeal.prototype.initRemoveFiles=function(){function a(a,c){d.post("?module=file&action=delete",{id:a},function(a){"ok"==a.status?c.remove():console&&console.log&&console.log("File Remove Error")})}var b=this,f;b.$wrapper.find(".c-files-wrapper").on("click",".js-remove-file",function(c){c.preventDefault();var e=d(this).closest(".c-file");
c=e.find(".c-name").text();var g=parseInt(e.data("id"));f&&f.abort();c={title:b.locales.remove_file_title,text:b.locales.remove_file_text.replace(/%s/,c),ok_button:b.locales.remove_file_button};0<g?f=d.post("?module=dialogConfirm",c,function(c){new CRMDialog({html:c,onConfirm:function(){a(g,e)}})}).always(function(){f=!1}):console&&console.log&&console.log("File ID is empty")})};CRMDeal.prototype.initEditableName=function(){var a=this.$wrapper.find(".js-editable").first();if(!(0>=a.length)){var b=
d.crm.app_url+"?module=deal&action=rename",f=this.deal_id,g=null;new CrmEditable({$wrapper:a,onSave:function(a){var c=a.$field.val();if(c.length&&a.text!==c){g&&g.abort();c={id:f,name:c};a.$field.attr("disabled",!0);var e=d('<i class="icon16 loading"></i>').css("margin","0 0 0 4px").insertAfter(a.$field);g=d.post(b,c,function(c){a.$field.attr("disabled",!1);e.remove();a.toggle("hide");c&&c.data&&c.data.deal&&(a.text=c.data.deal.name,a.$wrapper.text(c.data.deal.name),d.crm.title.set(c.data.deal.name))})}else c.length||
a.$field.val(a.text),a.toggle("hide")}})}};CRMDeal.prototype.initChangeDate=function(){function a(a){a?(g.addClass("is-shown"),l.focus()):(g.removeClass("is-shown"),l.datepicker("hide"))}function b(c){l.val()||(c="");d.post("?module=deal&action=changeExpectedDate",{id:f.deal_id,expected_date:c?c:""},function(c){"ok"==c.status&&c.data&&c.data.deal&&((c=c.data.deal.expected_date)?(h.hide(),k.show().find(".js-name").text(c)):(k.hide().find(".js-name").text(""),h.show()),a())},"json")}var f=this,g=f.$wrapper.find(".js-date-toggle");
if(!g.length)return!1;var h=g.find(".js-link"),k=g.find(".js-span"),l=g.find(".js-datepicker"),m=g.find(".js-field");g.on("click",".js-set-date",function(c){c.preventDefault();a(!0)});l.on("keydown keypress keyup",function(c){27===c.keyCode&&a()});g.on("click",".js-close-edit-date",function(){a()});(function(){l.datepicker({altField:m,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,onSelect:function(){var a=l.val(),c=m.val(),e=d.datepicker._defaults.dateFormat,f=!1;try{d.datepicker.parseDate(e,
a),f=!0}catch(u){}if(f)b(c);else return!1}});l.val()||l.datepicker("setDate","+0d")})()};CRMDeal.prototype.initChangePrice=function(){function a(a){a?h.addClass("is-shown"):h.removeClass("is-shown")}function b(c,b){d.post("?module=deal&action=changeAmount",{id:g.deal_id,amount:c?c:"",currency_id:b?b:""},function(c){"ok"==c.status&&c.data&&c.data.deal&&((c=c.data.deal.amount)?(k.hide(),l.show().text(c)):(l.hide().text(""),k.show()),a())},"json")}function f(){var a=m.val(),c=p.val(),d=!1;a&&(d=a.replace(",",
"."));0<=d?b(a,c):m.addClass("error")}var g=this,h=g.$wrapper.find(".js-price-toggle");if(!h.length)return!1;var k=h.find(".js-link"),l=h.find(".js-span"),m=h.find(".js-price-field"),p=h.find(".js-currency-field");h.on("click",".js-set-price",function(c){c.preventDefault();a(!0)});h.on("click",".js-save-price",function(a){a.preventDefault();f()});h.on("click",".js-cancel",function(c){c.preventDefault();a()});m.on("focus",function(){m.hasClass("error")&&m.removeClass("error")});m.on("keydown",function(a){13===
a.keyCode&&(a.preventDefault(),f())})};CRMDeal.prototype.initChangeUser=function(){function a(a){if(!a.length)return!1;var c=a.closest(".c-contact");a.autocomplete({appendTo:c,source:"?module=autocomplete&type=user&funnel_id="+g.funnel_id,minLength:0,html:!0,focus:function(){return!1},select:function(d,e){b(e.item.id,c);a.val("");return!1}}).data("ui-autocomplete")._renderItem=function(a,c){var b=d("<li />");b.addClass("ui-menu-item-html").append("<div>"+c.value+"</div>").appendTo(a);c.rights||(b.addClass("is-locked"),
b.on("click",function(a){a.preventDefault();a.stopPropagation()}));return b};a.on("focus",function(){a.data("uiAutocomplete").search(a.val())})}function b(c,b){h||(h=!0,d.post("?module=deal&action=changeUser",{id:g.deal_id,user_contact_id:c},function(e){if("ok"!==e.status)e.errors?console.error(e.errors):console.error(e),d.crm.alert.show({title:"Error",button:"Error"});else if(e.data=e.data||{},e.data.deal_access_denied)location.reload();else if(e.data.html){e=d(e.data.html);var f=g.$aside.find('.c-users-section .c-contact[data-id="'+
c+'"]').not(b);f.length&&f.remove();b.replaceWith(e);a(e.find(".js-owner-autocomplete"))}},"json").always(function(){h=!1}));f(b)}function f(a,c){c?a.addClass("is-edit"):a.removeClass("is-edit")}var g=this,h=!1;g.$aside.on("click",".js-show-combobox",function(a){a.preventDefault();a=d(this).closest(".c-contact");f(a,!0)});g.$aside.on("click",".js-hide-combobox",function(a){a.preventDefault();a=d(this).closest(".c-contact");f(a)});g.$aside.find(".js-owner-autocomplete").each(function(){a(d(this))});
(function(){function c(c){e||(e=!0,d.post("?module=deal&action=changeUser",{id:g.deal_id,user_contact_id:c},function(c){if("ok"===c.status){c=d(c.data.html);var b=g.$aside.find('.c-users-section .c-contact[data-id="'+g.user_id+'"]');b.length&&b.remove();f.after(c).css("display","none");g.$aside.find(".js-add-user-wrapper").show();a(c.find(".js-owner-autocomplete"))}},"json").always(function(){e=!1}))}function b(a){a?f.addClass("is-extended"):f.removeClass("is-extended")}var e=!1,f=g.$aside.find(".js-empty-user-wrapper");
f.on("click",".js-set-user-me",function(a){a.preventDefault();c(g.user_id)});f.on("click",".js-set-extended",function(a){a.preventDefault();b(!0)});f.on("click",".js-unset-extended",function(a){a.preventDefault();b(!1)});(function(){f.find(".js-empty-user-autocomplete").each(function(){var a=d(this);a.autocomplete({appendTo:f,source:"?module=autocomplete&type=user&funnel_id="+g.funnel_id,minLength:0,html:!0,focus:function(){return!1},select:function(b,d){c(d.item.id);a.val("");return!1}}).data("ui-autocomplete")._renderItem=
function(a,c){var b=d("<li />");b.addClass("ui-menu-item-html").append("<div>"+c.value+"</div>").appendTo(a);c.rights||(b.addClass("is-locked"),b.on("click",function(a){a.preventDefault();a.stopPropagation()}));return b};a.on("focus",function(){a.data("uiAutocomplete").search(a.val())})})})()})()};CRMDeal.prototype.initChangeClient=function(){function a(a,c,e){g||(g=!0,d.post("?module=deal&action=changeClient",{deal_id:b.deal_id,client_type:e,contact_id:c},function(c){new CRMDialog({html:c,options:{onChange:function(c){a.replaceWith(c);
a.find(".js-add-company-contact").show();d(document).trigger("refresh")}}})}).always(function(){g=!1}))}var b=this,f=b.$wrapper.find(".js-contacts-section"),g=!1;f.on("click",".js-edit-company-owner",function(c){c.preventDefault();c=d(this).closest(".c-contact");var b=c.data("type"),e=c.data("id");a(c,e,b)});var h=f.find(".js-empty-contact-wrapper");if(h.length)h.on("click",".js-set-company-owner",function(c){c.preventDefault();a(h,"","contact_owner")})};CRMDeal.prototype.initDealDelete=function(){function a(){f||
(f=!0,d.post(d.crm.app_url+"?module=deal&action=delete",{id:b.deal_id},function(a){"ok"===a.status&&d.crm.content.load(d.crm.app_url+"deal/")},"json").always(function(){f=!1}))}var b=this,f=!1;b.$wrapper.on("click",".js-deal-delete",function(c){c.preventDefault();d.crm.confirm.show({title:b.locales.delete_deal_title,text:b.locales.delete_deal_text,button:b.locales.delete_deal_button,onConfirm:a})})};CRMDeal.prototype.initCall=function(){var a=this,b=!1;a.$wrapper.on("click",".js-show-call-dialog",
function(c){c.preventDefault();var e=d(this);c=e.data("id");e=e.data("phone");!b&&c&&e&&(b=!0,d.post("?module=call&action=initContactDialog",{deal_id:a.deal_id,contact_id:c,phone:e},function(a){new CRMDialog({remain_after_load:!0,html:a})}).always(function(){b=!1}))})};CRMDeal.prototype.initOrderSection=function(){var a=this.$wrapper.find(".c-order-section"),b=a.find(".c-order-details"),f=a.find(".c-products-wrapper");b.on("click",".js-details-toggle",function(a){a.preventDefault();a=d(this).find(".icon16");
b.hasClass("is-extended")?(a.removeClass("darr").addClass("rarr"),b.removeClass("is-extended")):(a.removeClass("rarr").addClass("darr"),b.addClass("is-extended"));d(document).trigger("refresh")});f.on("click",".js-products-toggle",function(a){a.preventDefault();a=d(this).find(".icon16");f.hasClass("is-extended")?(a.removeClass("darr").addClass("rarr"),f.removeClass("is-extended")):(a.removeClass("rarr").addClass("darr"),f.addClass("is-extended"));d(document).trigger("refresh")})};CRMDeal.prototype.initMessages=
function(){this.initSendEmail();this.initSendSMS()};CRMDeal.prototype.initSendEmail=function(){var a=this,b=!1;a.$wrapper.on("click",".js-show-message-dialog",function(c){c.preventDefault();var e=d(this);c=e.data("id");e=e.data("email");!b&&c&&(b=!0,d.post("?module=message&action=writeDealDialog",{deal_id:a.deal_id,contact_id:c,email:e},function(a){new CRMDialog({html:a})}).always(function(){b=!1}))})};CRMDeal.prototype.initSendSMS=function(){var a=this,b=!1;a.$wrapper.on("click",".js-show-send-sms-dialog",
function(c){c.preventDefault();var e=d(this);c=e.data("id");e=e.data("phone");!b&&c&&(b=!0,d.get("?module=message&action=writeSMSDealDialog",{deal_id:a.deal_id,contact_id:c,phone:e},function(a){new CRMDialog({html:a})}).always(function(){b=!1}))})};CRMDeal.prototype.addExternalContact=function(a){d.get(d.crm.app_url+"?module=deal&action=addParticipant",{id:this.deal_id},function(c){new CRMDialog({html:c,options:{onAdd:function(c){a.closest(".c-add-contact").before(c);d(document).trigger("refresh")}}})})};
CRMDeal.prototype.removeOwner=function(a){function c(c,e){var f={owner_id:c,deal_id:e},g=d(".js-empty-user-wrapper");b.remove_is_locked=!0;d.post("?module=deal&action=ownerDelete",f,function(c){"ok"==c.status&&(a.remove(),g.fadeIn())},"json").always(function(){b.remove_is_locked=!1})}var b=this,g=a.data("id"),h=d.trim(a.find(".c-name").html());d.crm.confirm.show({title:b.locales.remove_owner_title,text:b.locales.remove_owner_text.replace(/%s/,h),button:b.locales.remove_owner_button,onConfirm:function(){c(g,
b.deal_id)}})};CRMDeal.prototype.removeContact=function(a){function c(c,e,f){c={contact_id:c,deal_id:e,role_id:f};b.remove_is_locked=!0;d.post("?module=deal&action=contactDelete",c,function(c){"ok"==c.status&&a.remove()},"json").always(function(){b.remove_is_locked=!1})}var b=this,g=a.data("id"),h=d.trim(a.find(".c-name").html());d.crm.confirm.show({title:b.locales.remove_contact_title,text:b.locales.remove_contact_text.replace(/%s/,h),button:b.locales.remove_contact_button,onConfirm:function(){c(g,
b.deal_id,a.data("role-id"))}})};CRMDeal.prototype.initAssignTags=function(){var a=this.$wrapper.find(".js-assign-tags"),b=d.crm.app_url+"?module=dealOperation&action=assignTags&is_assign=1",f=parseInt(this.deal_id)||0;a.click(function(a){a.preventDefault();d.get(b,{deal_ids:[f]},function(a){new CRMDialog({html:a})})})};CRMDeal.prototype.initOrderEditShippingDetailLink=function(){var a=this;a.$wrapper.find(".js-order-edit-shipping-details-link").click(function(){var c=d(this).parent().find(".js-order-edit-shipping-details-loading");
c.show();a.loadEditOrderShippingDetailsDialog(a.order_id,{onLoad:function(){c.hide()}})})};CRMDeal.prototype.initCreateOrderLink=function(){var a=this;a.$wrapper.on("click",".js-create-order-link",function(c){c.preventDefault();if(a.shop_in_welcome_stage)d.crm.alert.show({title:a.locales.shop_alert_title||"",text:a.locales.shop_in_welcome_stage||""});else{var b=d(this);b.addClass("is-loading");a.loadEditOrderDialog(0,{onLoad:function(){b.removeClass("is-loading")}})}})};CRMDeal.prototype.initEditOrderLink=
function(){var a=this;a.$wrapper.on("click",".js-edit-order-link",function(c){c.preventDefault();if(a.shop_in_welcome_stage)d.crm.alert.show({title:a.locales.shop_alert_title||"",text:a.locales.shop_in_welcome_stage||""});else{var b=d(this);b.addClass("is-loading");a.loadEditOrderDialog(a.order_id,{onLoad:function(){b.removeClass("is-loading")}})}})};CRMDeal.prototype.loadEditOrderDialog=function(a,b){var c=this.deal||{},e=d(this.templates.create_order_dialog_html),h=b.onLoad||function(){};e.hide();
new CRMDialog({html:e,onOpen:function(){var b=this,f=d.crm.backend_url+"shop/?module=order&action=embededit",g=e.find(".crm-dialog-content");0<c.contact_id&&(f+="&customer_id="+c.contact_id);0<a&&(f+="&id="+a);g.html('<iframe src="'+f+'" class="c-content-iframe">');var p=g.find("iframe");p.one("load",function(){h();b.show();b.resize();var a=p.get(0);d(a.contentWindow.document).find("#order-edit-form").append('<input type="hidden" name="crm_deal[id]" value="'+c.id+'">');a.contentWindow.$.order_edit.container.on("order_edit_save_success",
function(){b.close();d.crm.content.reload()})})}})};CRMDeal.prototype.loadEditOrderShippingDetailsDialog=function(a,b){if(0>=a)console.error("Invalid input parameter");else{var c=this.$wrapper.find(".js-deal-edit-order-shipping-details-dialog").clone(),e=b.onLoad||function(){};c.hide();new CRMDialog({html:c,onOpen:function(){var b=this,f=d.crm.backend_url+"shop/?module=workflow&action=prepare",g=c.find(".crm-dialog-content");d.post(f,{action_id:"editshippingdetails",id:a},function(a){g.html(a);g.find(".js-form-footer-actions").hide();
b.show();b.resize();a=g.find("#wf-ship-form").height();c.find(".crm-dialog-block").height(a+150);var f=c.find(".js-submit-dialog-loading"),h=g.find(".js-form-footer-actions .js-submit-button");c.find(".js-submit-dialog-button").on("click",function(a){a.preventDefault();if(h.is(":disabled"))return!1;g.bind("formSend",function(){f.hide();b.close();d.crm.content.reload()});f.show();h.trigger("click")});e&&e()})}})}};return CRMDeal}(jQuery),CRMDealChangeWorkflowDialog=function(d){CRMDealChangeWorkflowDialog=
function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form").first();this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMDealChangeWorkflowDialog.prototype.initClass=function(){var a=this;a.$wrapper.find(".js-form-footer-actions").hide();a.$wrapper.on("click",".js-submit-dialog-button",function(){a.$form.find(".js-submit-button").trigger("click")});a.$form.on("formSend",function(){if(a.dialog.options&&a.dialog.options.onShopSubmit)a.dialog.options.onShopSubmit();a.dialog.close()})};
return CRMDealChangeWorkflowDialog}(jQuery);var CRMDealCloseDialog=function(d){CRMDealCloseDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$reasonSelect=this.$wrapper.find(".js-reason-select");this.$reasonFieldW=this.$wrapper.find(".js-reason-text");this.dialog=this.$wrapper.data("dialog");this.deal_id=a.deal_id;this.reason_require=a.reason_require;this.is_locked=!1;this.initClass()};CRMDealCloseDialog.prototype.initClass=function(){var a=this;a.$wrapper.on("click",".js-set-won",function(b){b.preventDefault();
a.setWon()});a.$wrapper.on("click",".js-show-form",function(b){b.preventDefault();a.showLostForm()});a.$wrapper.on("click",".js-set-lost",function(b){b.preventDefault();a.$form.trigger("submit")});a.$form.on("submit",function(b){b.preventDefault();a.setLost()});a.$reasonSelect.on("change",function(){d(this).val()?a.$reasonFieldW.hide():a.$reasonFieldW.show()})};CRMDealCloseDialog.prototype.showLostForm=function(a){var b=this.$wrapper.find(".c-visible"),c=this.$wrapper.find(".c-hidden");a?(b.show(),
c.hide()):(b.hide(),c.show());this.dialog.resize()};CRMDealCloseDialog.prototype.setWon=function(){var a=this;if(!a.is_locked){a.is_locked=!0;var b={id:a.deal_id,action:"WON"};d.post("?module=deal&action=close",b,function(c){"ok"===c.status&&a.afterRequest("?module=deal&action=close",b,c)}).always(function(){a.is_locked=!1})}};CRMDealCloseDialog.prototype.setLost=function(){function a(){var a=b.$form.serializeArray();a.push({name:"id",value:b.deal_id});a.push({name:"action",value:"LOST"});if(b.reason_require&&
!b.$reasonSelect.val())if(b.$reasonFieldW.is(":visible")){var c=b.$reasonFieldW.find("input");c.val()||(c.addClass("error").one("focus",function(){d(this).removeClass("error")}),a=!1)}else b.$reasonSelect.addClass("error").one("change",function(){d(this).removeClass("error")}),a=!1;return a}var b=this;if(!b.is_locked){b.is_locked=!0;var c=a();c?d.post("?module=deal&action=close",c,function(a){"ok"===a.status&&b.afterRequest("?module=deal&action=close",c,a)}).always(function(){b.is_locked=!1}):b.is_locked=
!1}};CRMDealCloseDialog.prototype.afterRequest=function(a,b,c){function e(){f.dialog.close();d.crm.content.reload()}var f=this;c.data.dialog_html&&c.data.dialog_html.html?new CRMDialog({html:c.data.dialog_html.html,onOpen:function(a){var c=a.find("form");c.length&&!d.isEmptyObject(b)&&d.each(b,function(a,b){c.append('<input type="hidden" name="crm_change_workflow_data['+b.name+']" value="'+b.value+'">')})},options:{onShopSubmit:e},onConfirm:function(){b.push({name:"force_execute",value:1});d.post(a,
b,e)}}):e()};return CRMDealCloseDialog}(jQuery);var CRMDealEdit=function(d){CRMDealEdit=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("#js-deal-edit-form");this.$deal_name_input=this.$form.find('[name="deal[name]"]');this.deal_id=a.deal_id;this.locales=a.locales;this.urls=a.urls;this.suggester_values={};this.contact_mode=0<this.deal_id?"edit":"replace";this.initClass()};CRMDealEdit.prototype.initClass=function(){this.initChangeCompanyContact();this.initEstimatedDate();this.initSuggestName();this.initChangeFunnel();this.initWYSIWYG();
this.initFieldsBlock();this.initSave();this.initCombobox()};CRMDealEdit.prototype.initEstimatedDate=function(){function a(){var a=d.datepicker._defaults.dateFormat,b=!1;try{d.datepicker.parseDate(a,c.val()),b=!0}catch(h){}b?(c.data("last-correct-value",c.val()),e.data("last-correct-value",e.val())):(c.val(c.data("last-correct-value")||""),e.val(e.data("last-correct-value")||""))}var b=this.$wrapper.find(".c-estimated-close-date-field").find(".js-datepicker-wrapper"),c=b.find(".js-datepicker"),e=b.find('[name="deal[expected_date]"]');
c.datepicker({altField:e,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,onSelect:a});c.on("blur",a);c.on("keydown keypress keyup",function(a){13===a.which&&a.preventDefault()});c.on("click",".js-icon",function(){c.focus()})};CRMDealEdit.prototype.initSave=function(){function a(){var a={data:[],errors:[]},c=h.serializeArray();d.each(c,function(c,b){if("deal[amount]"===b.name){b.value.length&&(b.value=d.trim(b.value));var e=b.value,f=!1;e.length&&(e=e.replace(",","."),0<e||"0"===e)&&(f=!0);f||a.errors.push({name:b.name,
value:g.locales.bad_amount})}a.data.push(b)});"edit"===g.contact_mode?e(a):f(a);return a}function b(a){a&&a[0]||(a=[]);d.each(a,function(a,c){var b=c.name,e=c.value,f=g.$wrapper.find('[name="'+b+'"]');"contact[firstname]"!==b||f.is(":visible")||(f=g.$wrapper.find(".js-contact-autocomplete"));var l=d("<span class='c-error' />").addClass("errormsg").text(e);f.length&&!f.hasClass("error")?(f.parent().append(l),f.addClass("error").one("focus click change",function(){f.removeClass("error");l.remove()})):
(k.append(l),h.one("submit",function(){l.remove()}))})}function c(a){if(!l){l=!0;var c=d.crm.app_url+"?module=deal&action=save",e=h.find(".loading");e.show();d.post(c,a,function(a){"ok"===a.status?d.crm.content.load(d.crm.app_url+"deal/"+a.data.deal.id+"/"):a.errors&&b(a.errors)},"json").always(function(){e.hide();l=!1})}}function e(a){var c=g.$wrapper.find("#c-contact-edit-form").closest("form"),b=c.find(".js-phone-list"),e=c.find(".js-email-list"),c=c.serializeArray(),f=["contact[firstname]","contact[middlename]",
"contact[lastname]","contact[name]"],h=!0;d.each(c,function(c,b){a.data.push({name:b.name,value:b.value});0<d.trim(b.value).length&&0<=f.indexOf(b.name)&&(h=!1)});h&&(a.errors.push({name:"contact[firstname]",value:g.locales.empty_name}),a.errors.push({name:"contact[name]",value:g.locales.empty_name}));b.find("li").each(function(c){var b=d(this),e=b.find(".js-value"),b=b.find(".js-ext"),f=e.val(),g=b.val();if(f){var h="contact[phone]["+c+"][value]";e.attr("name",h);a.data.push({name:h,value:f});c=
"contact[phone]["+c+"][ext]";b.attr("name",c);a.data.push({name:c,value:g})}});e.find("li").each(function(c){var b=d(this),e=b.find(".js-value"),b=b.find(".js-ext"),f=e.val(),g=b.val();if(f){var h="contact[email]["+c+"][value]";e.attr("name",h);a.data.push({name:h,value:f});c="contact[email]["+c+"][ext]";b.attr("name",c);a.data.push({name:c,value:g})}});return a}function f(a){var c=g.$wrapper.find("#c-contact-add-form").closest("form").serializeArray(),b=!1,e=!1;d.each(c,function(c,d){var f=d.name,
g=d.value;"deal[contact_id]"===f&&g&&(b=!0);"contact[firstname]"===f&&g&&(e=!0);"contact[lastname]"===f&&g&&(e=!0);"contact[middlename]"===f&&g&&(e=!0);"contact[name]"===f&&g&&(e=!0);a.data.push(d)});b||e||(a.errors.push({name:"contact[name]",value:g.locales.empty_name}),a.errors.push({name:"contact[firstname]",value:g.locales.empty_name}))}var g=this,h=g.$form,k=g.$form.find(".js-errors-place"),l=!1;g.$wrapper.on("click",".js-submit-button",function(){h.trigger("submit")});h.on("submit",function(d){d.preventDefault();
d=a();d.errors.length?b(d.errors):c(d.data)})};CRMDealEdit.prototype.initSuggestName=function(){var a=this,b=a.$form,c=a.$deal_name_input;if(!c.data("edited")){c.one("mark-edited.crm-deal-suggestion",function(){c.data("edited",1);c.off(".crm-deal-suggestion");b.off(".crm-deal-suggestion",".js-crm-deal-name-suggester-input")});c.on("keyup.crm-deal-suggestion",function(){var a=d(this);0<d.trim(a.val()).length&&a.trigger("mark-edited")});var e=null,f=null,g=function(){e&&(e.abort(),e=null);c.data("edited")||
(e=d.post(d.crm.app_url+"?module=deal&action=suggestName",a.suggester_values,function(a){"ok"!==a.status||c.data("edited")||c.val(d.trim(a.data&&a.data.name)||"")}))};b.on("keyup.crm-deal-suggestion change.crm-deal-suggestion",".js-crm-deal-name-suggester-input",function(c){var e=d(this);f&&clearTimeout(f);f=setTimeout(function(){if(e.hasClass("crm-find-contact-input")){if("keyup"===c.type)return;e=b.find('[name="deal[id]"]')}var f=e.attr("name")||"",h=d.trim(e.val());if(f){a.suggester_values[f]=
d.trim(a.suggester_values[f]);if(a.suggester_values[f]===h)return;a.suggester_values[f]=h}g()},250)})}};CRMDealEdit.prototype.initChangeCompanyContact=function(){var a=this,b=a.$wrapper.find(".js-contact-block"),c=b.find(".js-view-toggle"),e=c.find(".is-active");c.on("click",".c-toggle",function(c){c.preventDefault();c=d(this);var f=c.data("id");if(c.hasClass("is-active"))return!1;a.contact_mode=f;e.length&&e.removeClass("is-active");c.addClass("is-active");e=c;b.find(".c-hidden.is-active").removeClass("is-active");
b.find(".c-hidden-"+f).addClass("is-active")})};CRMDealEdit.prototype.initChangeFunnel=function(){var a=this;a.$form.on("change",".js-select-deal-funnel",function(){a.$form.find(".js-select-stage-wrapper").load("?module=deal&action=stagesByFunnel&id="+d(this).val())})};CRMDealEdit.prototype.initWYSIWYG=function(){var a=this.$wrapper.find(".js-wysiwyg");if(!a.length)return!1;d.crm.initWYSIWYG(a,{keydownCallback:function(a){}})};CRMDealEdit.prototype.initFieldsBlock=function(){var a=this.$wrapper.find(".js-ext-fields-section");
a.on("click",".js-ext-fields-toggle",function(){a.toggleClass("is-extended")})};CRMDealEdit.prototype.initCombobox=function(){function a(a){a?c.addClass("is-shown"):c.removeClass("is-shown")}var b=this,c=b.$form.find(".js-contact-owner-wrapper"),e=c.find(".js-field");c.on("click",".js-show-combobox",function(c){c.stopPropagation();a(!0)});c.on("click",".js-hide-combobox",function(c){c.stopPropagation();a(!1)});(function(){var f=c.find(".js-autocomplete");f.autocomplete({appendTo:c,position:{my:"right top",
at:"right bottom"},source:b.urls.owner_autocomplete,minLength:0,html:!0,focus:function(){return!1},select:function(b,d){var g=d.item,h=c.find(".js-user");g.photo_url&&h.find(".userpic20").css("background-image","url("+g.photo_url+")");h.find(".c-name").text(g.name);e.val(g.id);a(!1);f.val("");return!1}}).data("ui-autocomplete")._renderItem=function(a,c){return d("<li />").addClass("ui-menu-item-html").append("<div>"+c.value+"</div>").appendTo(a)};f.on("focus",function(){f.data("uiAutocomplete").search(f.val())})})()};
return CRMDealEdit}(jQuery);var CRMDealChangeClient=function(d){CRMDealChangeClient=function(a){this.$wrapper=a.$wrapper;this.dialog=this.$wrapper.data("dialog");this.deal_id=a.deal_id;this.contact_id=a.contact_id;this.type=a.type;this.initClass()};CRMDealChangeClient.prototype.initClass=function(){this.initViewToggle();this.initContactChangeData();this.initSwitchContact()};CRMDealChangeClient.prototype.initViewToggle=function(){var a=this,b=a.$wrapper.find(".js-view-toggle"),c=b.find(".is-active");b.on("click",".c-toggle",
function(b){b.preventDefault();b=d(this);var e=b.data("id");if(b.hasClass("is-active"))return!1;c.length&&c.removeClass("is-active");b.addClass("is-active");c=b;a.$wrapper.find(".c-hidden.is-active").removeClass("is-active");a.$wrapper.find(".c-hidden-"+e).addClass("is-active");a.dialog.resize()})};CRMDealChangeClient.prototype.initContactChangeData=function(){function a(){var a=g.serializeArray(),c={data:[],errors:[]},b=["contact[firstname]","contact[middlename]","contact[lastname]","contact[name]"],
f=!0;d.each(a,function(a,e){c.data.push({name:e.name,value:e.value});0<d.trim(e.value).length&&0<=b.indexOf(e.name)&&(f=!1)});f&&(c.errors.push({name:"contact[firstname]",value:"Name is empty"}),c.errors.push({name:"contact[name]",value:"Name is empty"}));k.find("li").each(function(a){var b=d(this),e=b.find(".js-value"),b=b.find(".js-ext"),f=e.val(),g=b.val();if(f){var h="contact[phone]["+a+"][value]";e.attr("name",h);c.data.push({name:h,value:f});a="contact[phone]["+a+"][ext]";b.attr("name",a);c.data.push({name:a,
value:g})}});l.find("li").each(function(a){var b=d(this),e=b.find(".js-value"),b=b.find(".js-ext"),f=e.val(),g=b.val();if(f){var h="contact[email]["+a+"][value]";e.attr("name",h);c.data.push({name:h,value:f});a="contact[email]["+a+"][ext]";b.attr("name",a);c.data.push({name:a,value:g})}});c.data.push({name:"deal_id",value:e.deal_id});return c}function b(a){d.post(e.contact_id?"?module=deal&action=contactUpdate":"?module=contact&action=save",a,function(a){"ok"==a.status?(e.dialog.options.onChange(a.data.html),
e.dialog.close()):a.errors&&c(a.errors)},"json").always(function(){h=!1})}function c(a){a=a?a:[];d.each(a,function(a,c){var b=c.name,e=c.value;"contact[name]"===b&&(b="contact[firstname]");var h=g.find('[name="'+b+'"]'),k=d("<span />").addClass("errormsg").text(e);h.length?h.hasClass("error")||(h.parent().append(k),h.addClass("error").one("focus click",function(){h.removeClass("error");k.remove()})):(f.append(k),g.one("submit",function(){k.remove()}))})}var e=this,f=e.$wrapper.find(".js-errors-place"),
g=e.$wrapper.find("#c-contact-edit-form").closest("form"),h=!1,k=g.find(".js-phone-list"),l=g.find(".js-email-list");e.$wrapper.on("click",".js-save-changed-data",function(a){a.preventDefault();g.trigger("submit")});g.on("submit",function(d){d.preventDefault();h||(h=!0,d=a(),d.errors.length?(c(d.errors),h=!1):b(d.data))})};CRMDealChangeClient.prototype.initSwitchContact=function(){function a(a){a=a?a:[];d.each(a,function(a,b){var g=b.name,h=b.value;"contact[name]"===g&&(g="contact[firstname]");var k=
f.find('[name="'+g+'"]'),l=d("<span />").addClass("errormsg").text(h);k.length?k.hasClass("error")||(k.parent().append(l),k.addClass("error").one("focus click",function(){k.removeClass("error");l.remove()})):(e.append(l),c.$wrapper.one("click",".js-switch-contact",function(){l.remove()}))})}function b(b){g||(g=!0,b.push({name:"deal_id",value:c.deal_id}),d.post("?module=deal&action=personUpdate",b,function(b){"ok"==b.status?(c.dialog.options.onChange(b.data.html),c.dialog.close()):b.errors&&a(b.errors)}).always(function(){g=
!1}))}var c=this,e=c.$wrapper.find(".js-errors-place"),f=c.$wrapper.find("#c-contact-add-form").closest("form"),g=!1;c.$wrapper.on("click",".js-switch-contact",function(c){var d;c.preventDefault();c=f.serializeArray();d=[];d.length?a(d):b(c)})};return CRMDealChangeClient}(jQuery);var CRMDealsFunnel=function(d){CRMDealsFunnel=function(a){this.$wrapper=a.$wrapper;this.$header=this.$wrapper.find("#js-funnel-header");this.$actionsHeader=this.$wrapper.find("#js-actions-header");this.$tableContent=this.$wrapper.find(".js-table-content");this.funnel_id=a.funnel_id;this.locales=a.locales;this.selected_deals=[];this.initClass()};CRMDealsFunnel.prototype.initClass=function(){this.initFixedHeader();this.initDealsMove();this.initMassiveActionsHeader();this.initMassActions()};CRMDealsFunnel.prototype.initFixedHeader=
function(){function a(){if(d.contains(document,e[0])){var m=c.scrollTop();h.top<m?g||(g=!0,f=d("<div />"),f.height(l).insertAfter(e),e.width(k).addClass("is-fixed-to-top")):b()}else c.off("scroll",a)}function b(){f&&f.length&&f.remove();f=!1;e.removeAttr("style").removeClass("is-fixed-to-top");k=e.width();l=e.height();g=!1}var c=d(window),e=this.$header,f=!1,g=!1,h=e.offset(),k=e.width(),l=e.height();c.on("scroll",a);c.on("resize",function(){b();c.trigger("scroll")})};CRMDealsFunnel.prototype.initDealsMove=
function(){function a(a,c,f,l){function g(){d.crm.content.reload()}if(!b){b=!0;var h=f.closest(".js-drop-area");e.draggable("disable");f.addClass("is-loading").removeAttr("style").prependTo(l);d.post("?module=deal&action=move",{deal_id:a,stage_id:c},function(b){"ok"===b.status&&(b.data.dialog_html&&b.data.dialog_html.html?new CRMDialog({html:b.data.dialog_html.html,options:{onShopSubmit:g},onCancel:function(){f.removeClass("is-loading").prependTo(h)},onConfirm:function(){d.post("?module=deal&action=move",
{deal_id:a,stage_id:c,force_execute:1},g)}}):g())},"json").always(function(){e.draggable("enable");b=!1})}}var b=!1,c=!1,e=this.$wrapper.find(".c-deal-wrapper"),f=this.$wrapper.find(".js-drop-area");e.draggable({handle:".js-drag-toggle",revert:!0,start:function(){var a=d(this),b=a.closest(".js-drop-area");a.data("stage-index",b.index()).data("stage-id",b.data("id")).draggable("option","revert",!0);c=b.addClass("is-wrapper")}});f.droppable({tolerance:"pointer",drop:function(b,e){var f=d(this),g=d(e.draggable),
h=f.data("id"),p=g.data("stage-id"),n=g.data("id");p!==h&&(g.draggable("option","revert",!1),a(n,h,g,f));c.length&&(c.removeClass("is-wrapper"),c=!1)}})};CRMDealsFunnel.prototype.initMassiveActionsHeader=function(){function a(){if(d.contains(document,f[0]))if(c.selected_deals.length){f.hasClass("is-hidden")&&f.removeClass("is-hidden");var p=e.scrollTop();k.top+m>p+e.height()?h||(h=!0,g=d("<div />"),g.height(m).insertAfter(f),f.width(l).addClass("is-fixed-to-bottom")):b()}else b(),f.hasClass("is-hidden")||
f.addClass("is-hidden");else e.off("scroll",a)}function b(){g&&g.length&&g.remove();g=!1;f.removeAttr("style").removeClass("is-fixed-to-bottom");l=f.width();m=f.height();h=!1}var c=this,e=d(window),f=c.$actionsHeader,g=!1,h=!1,k=f.offset(),l=f.width(),m=f.height();e.on("scroll",a);e.on("resize",function(){b();e.trigger("scroll")})};CRMDealsFunnel.prototype.initMassActions=function(){function a(a){a.find(".js-check-deal").is(":checked")?(a.addClass("is-active"),h.push(a[0])):(a.removeClass("is-active"),
a=h.indexOf(a[0]),h.splice(a,1));b();d(window).trigger("scroll")}function b(){function a(){var a=c("open"),b=f.find(".js-deals-close").closest(".c-action"),d=b.find(".js-open-count");a.length?(d.text(a.length),b.show()):b.hide()}function b(){var a=f.find(".js-deals-merge").closest(".c-action");1<h.length?a.show():a.hide()}var d=h.length;0<h.length&&(f.find(".js-count").text(d),a(),b())}function c(a){var c=[];d.each(h,function(b,e){var f=d(e),g=f.data("id");(!a||f.data(a))&&g&&c.push(g)});return c}
var e=this,f=e.$actionsHeader,g=f.find(".js-checkbox-all"),h=e.selected_deals;e.$wrapper.on("click",".js-deal-wrapper",function(c){c=d(c.target);var b=!(!c.is("a")&&!c.closest("a").length);c=c.is(":checkbox");if(!b){var b=d(this),e=b.find(".js-check-deal");c||e.attr("checked",!e.is(":checked"));a(b)}});e.$tableContent.find(".js-state-column").shiftSelectable({selector:".js-deal-wrapper",onSelect:function(c,b){var e=d(b.target),e=!(!e.is("a")&&!e.closest("a").length),f=b.extra.is_first,g=b.extra.is_last;
e||f||g||(c.find(".js-check-deal").attr("checked",!0),a(c))}});g.on("change",function(){var c=d(this).is(":checked");e.$wrapper.find(".js-deal-wrapper").each(function(){var b=d(this),e=b.find(".js-check-deal");e.is(":checked")!==c&&(e.attr("checked",c),a(b))})});f.on("click",".js-deals-merge",function(a){a.preventDefault();a=c();a=d.crm.app_url+"deal/merge/?ids="+a.join(",");d.crm.content.load(a)});(function(){var a=!1;f.on("click",".js-deals-delete",function(b){b.preventDefault();d.crm.confirm.show({title:e.locales.delete_confirm_title.replace("%s",
h.length),text:e.locales.delete_confirm_text,button:e.locales.delete_confirm_button,onConfirm:function(b){function e(){var a=[],b=c();d.each(b,function(c,b){a.push({name:"id[]",value:b})});return a}function f(){var a=h.map(function(a){return a});d.each(a,function(a,c){var b=d(c);b.find(".js-check-deal").attr("checked",!1).trigger("change");b.remove()})}if(!a){a=!0;var g=d.crm.app_url+"?module=deal&action=delete",k=e();d.post(g,k,function(a){"ok"===a.status&&(f(),b.close(),d.crm.content.reload(),d.crm.sidebar.reload())}).always(function(){a=
!1})}return!1}})})})();(function(){var a=!1;f.on("click",".js-deals-change-responsible",function(b){b.preventDefault();a||(a=!0,b={ids:c().join(",")},d.post("?module=deal&action=changeResponsible",b,function(a){new CRMDialog({html:a})}).always(function(){a=!1}))})})();(function(){var a=!1;f.on("click",".js-deals-close",function(b){b.preventDefault();a||(a=!0,b={ids:c("open").join(",")},d.post("?module=deal&action=massClose",b,function(a){new CRMDialog({html:a})}).always(function(){a=!1}))})})();(function(){var a=
!1;f.on("click",".js-deals-change-funnel",function(b){b.preventDefault();a||(a=!0,b={deal_ids:c().join(",")},d.post("?module=deal&action=changeFunnel",b,function(a){new CRMDialog({html:a})}).always(function(){a=!1}))})})();(function(){var a=!1;f.on("click",".js-deals-export",function(b){b.preventDefault();a||(a=!0,b=c(),d.post(d.crm.app_url+"?module=deal&action=export",{ids:b},function(a){new CRMDialog({html:a})}).always(function(){a=!1}))})})();(function(){var a=!1;f.on("click",".js-deals-set-tags",
function(b){b.preventDefault();if(!a){a=!0;b=c();var e=d.crm.app_url+"?module=dealOperation&action=assignTags",f={deal_ids:b};1===b.length&&(f.is_assign=1);d.post(e,f,function(a){new CRMDialog({html:a})}).always(function(){a=!1})}})})()};return CRMDealsFunnel}(jQuery),CRMDealsList=function(d){CRMDealsList=function(a){this.$wrapper=a.$wrapper;this.$tableWrapper=this.$wrapper.find(".js-deals-table-wrapper");this.$tableHeaderW=this.$wrapper.find(".js-table-header-wrapper");this.$tableHeader=this.$wrapper.find(".js-table-header");
this.$tableActions=this.$wrapper.find(".js-table-actions");this.$tableBody=this.$wrapper.find("#c-table-body");this.funnel_id=a.funnel_id;this.stage_id=a.stage_id;this.contact_id=a.contact_id;this.offset=a.offset;this.locales=a.locales;this.limit=a.limit;this.initClass()};CRMDealsList.prototype.initClass=function(){this.initLazy();this.initElasticHeader();this.initMassActions()};CRMDealsList.prototype.initLazy=function(){function a(){if(d.contains(document,g[0])){var c=d(window).scrollTop(),f=e.height(),
m=g.offset().top;c+f>=m&&(h||b())}else e.off("scroll",a)}function b(){var a={offset:g.data("offset")};c.stage_id&&(a.stage=c.stage_id);c.contact_id&&(a.user=c.contact_id);h=!0;d.post("?module=deal&action=list",a,function(b){var e=d(b).find(".js-lazyload");e.length?(c.limit+=a.offset,e.insertAfter(g),g.remove(),g=e):g.remove();d(b).find(".c-deal-wrapper").insertAfter(f.find("tr:last"))}).always(function(){h=!1})}var c=this,e=d(window),f=c.$tableBody,g=c.$wrapper.find(".js-lazyload"),h=!1;g.length&&
(e.on("scroll",a),g.offset().top<e.height()&&e.trigger("scroll"))};CRMDealsList.prototype.initElasticHeader=function(){function a(){d.contains(document,e[0])?b.scrollTop()>f.top?e.css({left:f.left}).width(c.outerWidth()).addClass("is-fixed"):e.removeAttr("style").removeClass("is-fixed"):b.off("scroll",a)}var b=d(window),c=this.$tableWrapper,e=this.$tableHeaderW,f=c.offset();b.on("scroll",a)};CRMDealsList.prototype.initMassActions=function(){function a(a){a.find(".js-check-deal").prop("checked",!0).trigger("change",
[!0])}function b(a){a.find(".js-check-deal").prop("checked",!1).trigger("change",[!1])}function c(a){a.find(".js-check-deal").is(":checked")?(a.addClass("is-active"),h.push(a[0])):(a.removeClass("is-active"),a=h.indexOf(a[0]),h.splice(a,1));e()}function e(){function a(){var a=f("open"),b=l.find(".js-deals-close").closest(".c-operation-li"),c=b.find(".js-open-count");a.length?(c.text(a.length),b.show()):b.hide()}function b(){var a=l.find(".js-deals-merge").closest(".c-operation-li");1<h.length?a.show():
a.hide()}var c=h.length;0<c?(k.hide(),l.show().find(".js-count").text(c),a(),b(),c<g.limit?m.prop("indeterminate",!0):m.prop("indeterminate",!1).prop("checked",!0)):(k.show(),l.hide(),m.prop("indeterminate",!1).prop("checked",!1))}function f(a){var b=[];d.each(h,function(c,e){var f=d(e),g=f.data("id");(!a||f.data(a))&&g&&b.push(g)});return b}var g=this,h=[],k=g.$tableHeader,l=g.$tableActions,m=g.$tableHeaderW.find(".js-checkbox-all");g.$tableBody.on("click",".js-deal-wrapper",function(a){a=d(a.target);
var b=d(this),e=b.find(".js-check-deal");e.closest("td");var f=!(!a.is("a")&&!a.closest("a").length),g=!(!a.is(".c-column-checkbox")&&!a.closest(".c-column-checkbox").length);if(a.is(":checkbox"))return c(b),!0;if(f)return!0;g&&(e.attr("checked",!e.is(":checked")),c(b))});g.$tableBody.shiftSelectable({selector:".js-deal-wrapper",onSelect:function(a,b){var e=d(b.target),e=!(!e.is("a")&&!e.closest("a").length),f=b.extra.is_first,g=b.extra.is_last;e||f||g||(a.find(".js-check-deal").attr("checked",!0),
c(a))}});m.on("change",function(){var e=d(this).is(":checked"),f=g.$wrapper.find(".js-deal-wrapper"),h=f.find(".js-check-deal").filter(":checked").length;0<h?h<g.limit||h===g.limit?b(f):a(f):e?a(f):b(f);f.each(function(){c(d(this))})});l.on("click",".js-deals-merge",function(a){a.preventDefault();a=f();a=d.crm.app_url+"deal/merge/?ids="+a.join(",");d.crm.content.load(a)});(function(){var a=!1;l.on("click",".js-deals-delete",function(b){b.preventDefault();d.crm.confirm.show({title:g.locales.delete_confirm_title.replace("%s",
h.length),text:g.locales.delete_confirm_text,button:g.locales.delete_confirm_button,onConfirm:function(b){function c(){var a=[],b=f();d.each(b,function(b,c){a.push({name:"id[]",value:c})});return a}function e(){var a=h.map(function(a){return a});d.each(a,function(a,b){var c=d(b);c.find(".js-check-deal").attr("checked",!1).trigger("change");c.remove()})}if(!a){a=!0;var g=d.crm.app_url+"?module=deal&action=delete",k=c();d.post(g,k,function(a){"ok"===a.status&&(e(),b.close(),d.crm.sidebar.reload())}).always(function(){a=
!1})}return!1}})})})();(function(){var a=!1;l.on("click",".js-deals-change-responsible",function(b){b.preventDefault();a||(a=!0,b={ids:f().join(",")},d.post("?module=deal&action=changeResponsible",b,function(a){new CRMDialog({html:a})}).always(function(){a=!1}))})})();(function(){var a=!1;l.on("click",".js-deals-close",function(b){b.preventDefault();a||(a=!0,b={ids:f("open").join(",")},d.post("?module=deal&action=massClose",b,function(a){new CRMDialog({html:a})}).always(function(){a=!1}))})})();(function(){var a=
!1;l.on("click",".js-deals-change-funnel",function(b){b.preventDefault();a||(a=!0,b={deal_ids:f().join(",")},d.post("?module=deal&action=changeFunnel",b,function(a){new CRMDialog({html:a})}).always(function(){a=!1}))})})();(function(){var a=!1;l.on("click",".js-deals-export",function(b){b.preventDefault();a||(a=!0,b=f(),d.post(d.crm.app_url+"?module=deal&action=export",{ids:b},function(a){new CRMDialog({html:a})}).always(function(){a=!1}))})})();(function(){var a=!1;l.on("click",".js-deals-set-tags",
function(b){b.preventDefault();if(!a){a=!0;b=f();var c=d.crm.app_url+"?module=dealOperation&action=assignTags",e={deal_ids:b};1===b.length&&(e.is_assign=1);d.post(c,e,function(a){new CRMDialog({html:a})}).always(function(){a=!1})}})})()};return CRMDealsList}(jQuery),CRMDealsMergePage=function(d){CRMDealsMergePage=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$submitButton=this.$wrapper.find(".js-submit-button");this.$activeDeal=this.is_deal_set=!1;this.initClass()};
CRMDealsMergePage.prototype.initClass=function(){this.initSubmit();this.initSelectDeal()};CRMDealsMergePage.prototype.initSubmit=function(){function a(){function a(a){var b="";d.each(a,function(a,c){if("master_id"===c.name)return b=c.value,!1});return b}if(!c){c=!0;var f=b.serializeArray();d.post("?module=deal&action=mergeRun",f,function(b){b=d.crm.app_url+"deal/"+a(f)+"/";d.crm.content.load(b)},"json").always(function(){c=!1})}}var b=this.$form,c=!1;b.on("submit",function(b){b.preventDefault();a()})};
CRMDealsMergePage.prototype.initSelectDeal=function(){var a=this;a.$wrapper.on("change",".js-field",function(){var b=d(this);"checked"===b.attr("checked")&&(b=b.closest(".js-deal"),a.$activeDeal&&a.$activeDeal.removeClass("is-active"),a.$activeDeal=b.addClass("is-active"),a.is_deal_set||(a.$submitButton.attr("disabled",!1),a.is_deal_set=!0))});a.$wrapper.on("click",".js-deal",function(a){var b=d(this).find(".js-field"),e=b[0]==a.target;a=!!d(a.target).attr("href");e||a||b.trigger("click")})};return CRMDealsMergePage}(jQuery),
CRMDealsChangeResponsibleDialog=function(d){CRMDealsChangeResponsibleDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$submitButton=this.$wrapper.find(".js-submit-button");this.dialog=this.$wrapper.data("dialog");this.is_responsive_set=!1;this.initClass()};CRMDealsChangeResponsibleDialog.prototype.initClass=function(){this.initSubmit();this.initChangeResponsible()};CRMDealsChangeResponsibleDialog.prototype.initChangeResponsible=function(){var a=this,b=a.$wrapper.find(".js-users-list"),
c=b.find(".js-visible-link"),e=a.$wrapper.find(".js-user-field"),f=b.find(".menu-v");f.on("click","a",function(){var b=d(this),h=b.closest(".js-user");c.find(".js-text").html(b.html());f.find(".selected").removeClass("selected");h.addClass("selected");f.hide();setTimeout(function(){f.removeAttr("style")},200);b=h.data("id");e.val(b).trigger("change");a.is_responsive_set||(a.$submitButton.attr("disabled",!1),a.is_responsive_set=!0)})};CRMDealsChangeResponsibleDialog.prototype.initSubmit=function(){function a(){if(!e){e=
!0;var a=c.serializeArray();d.post("?module=deal&action=changeResponsibleRun",a,function(a){"ok"===a.status?(b.dialog.close(),d.crm.content.reload()):alert("errors")},"json").always(function(){e=!1})}}var b=this,c=b.$form,e=!1;c.on("submit",function(b){b.preventDefault();a()})};return CRMDealsChangeResponsibleDialog}(jQuery),CRMDealsCloseDialog=function(d){CRMDealsCloseDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$reasonSelect=this.$wrapper.find(".js-reason-select");
this.$reasonFieldW=this.$wrapper.find(".js-reason-text");this.dialog=this.$wrapper.data("dialog");this.deal_ids=a.deal_ids;this.reason_require=a.reason_require;this.is_locked=!1;this.initClass()};CRMDealsCloseDialog.prototype.initClass=function(){var a=this;a.$wrapper.on("click",".js-set-won",function(b){b.preventDefault();a.setWon()});a.$wrapper.on("click",".js-show-form",function(b){b.preventDefault();a.showLostForm()});a.$wrapper.on("click",".js-set-lost",function(b){b.preventDefault();a.$form.trigger("submit")});
a.$form.on("submit",function(b){b.preventDefault();a.setLost()});a.$reasonSelect.on("change",function(){d(this).val()?a.$reasonFieldW.hide():a.$reasonFieldW.show()})};CRMDealsCloseDialog.prototype.showLostForm=function(a){var b=this.$wrapper.find(".c-visible"),c=this.$wrapper.find(".c-hidden");a?(b.show(),c.hide()):(b.hide(),c.show());this.dialog.resize()};CRMDealsCloseDialog.prototype.setWon=function(){var a=this;if(!a.is_locked){a.is_locked=!0;var b={deal_ids:a.deal_ids.join(","),action:"WON"};
d.post("?module=deal&action=massCloseRun",b,function(b){"ok"==b.status&&(a.dialog.close(),d.crm.content.reload())}).always(function(){a.is_locked=!1})}};CRMDealsCloseDialog.prototype.setLost=function(){function a(){var a=b.$form.serializeArray();a.push({name:"deal_ids",value:b.deal_ids.join(",")});a.push({name:"action",value:"LOST"});if(b.reason_require&&!b.$reasonSelect.val())if(b.$reasonFieldW.is(":visible")){var c=b.$reasonFieldW.find("input");c.val()||(c.addClass("error").one("focus",function(){d(this).removeClass("error")}),
a=!1)}else b.$reasonSelect.addClass("error").one("change",function(){d(this).removeClass("error")}),a=!1;return a}var b=this;if(!b.is_locked){b.is_locked=!0;var c=a();c?d.post("?module=deal&action=massCloseRun",c,function(a){"ok"==a.status&&(b.dialog.close(),d.crm.content.reload())}).always(function(){b.is_locked=!1}):b.is_locked=!1}};return CRMDealsCloseDialog}(jQuery),CRMDealsChangeFunnelDialog=function(d){CRMDealsChangeFunnelDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");
this.dialog=this.$wrapper.data("dialog");this.funnels=a.funnels;this.stage_template_html=a.stage_template_html;this.initClass()};CRMDealsChangeFunnelDialog.prototype.initClass=function(){this.initChangeFunnel();this.initChangeStage();this.initSubmit();d.crm.renderSVG(this.$wrapper)};CRMDealsChangeFunnelDialog.prototype.initChangeFunnel=function(){function a(a){(a=b.funnels[a]||!1)&&c.trigger("changeFunnel",a)}var b=this,c=b.$wrapper.find(".js-funnels-list"),e=c.find(".js-visible-link"),f=c.find(".js-field"),
g=c.find(".menu-v");g.on("click","a",function(){var b=d(this);e.find(".js-text").html(b.html());g.find(".selected").removeClass("selected");b.closest("li").addClass("selected");g.hide();setTimeout(function(){g.removeAttr("style")},200);b=b.data("id");f.val(b).trigger("change");a(b)})};CRMDealsChangeFunnelDialog.prototype.initChangeStage=function(){function a(a){h.html("");d.each(a,function(a,c){var e=b.stage_template_html,f=d("<div />").text(c.name).html(),e=e.replace("%id%",c.id).replace("%color%",
c.color).replace("%name%",f),e=d(e);h.append(e)});d.crm.renderSVG(e);h.find("li:first-child a").trigger("click")}var b=this,c=b.$wrapper.find(".js-funnels-list"),e=b.$wrapper.find(".js-funnel-stages-list"),f=e.find(".js-visible-link"),g=e.find(".js-field"),h=e.find(".menu-v");h.on("click","a",function(){var a=d(this);f.find(".js-text").html(a.html());h.find(".selected").removeClass("selected");a.closest("li").addClass("selected");h.hide();setTimeout(function(){h.removeAttr("style")},200);a=a.data("id");
g.val(a)});c.on("changeFunnel",function(b,c){a(c.stages)})};CRMDealsChangeFunnelDialog.prototype.initSubmit=function(){var a=this,b=a.$form,c=!1;b.on("submit",function(e){e.preventDefault();c||(c=!0,e=b.serializeArray(),d.post("?module=deal&action=changeFunnelRun",e,function(b){"ok"===b.status&&(a.dialog.close(),d.crm.content.reload())},"json").always(function(){c=!1}))})};return CRMDealsChangeFunnelDialog}(jQuery),CRMDealRemindersFilter=function(d){CRMDealRemindersFilter=function(a){this.$wrapper=
a.$wrapper;this.$menu=this.$wrapper.find(".js-hidden-list");this.$buttons=this.$menu.find(".js-buttons");this.apply_url_pattern=a.redirect_uri;this.filters=a.filters;this.selected_filters=a.selected_filters;this.redirect_uri=this.apply_url_pattern;this.selected_ids_before=Object.keys(this.selected_filters);this.initClass()};CRMDealRemindersFilter.prototype.initClass=function(){var a=this;a.$menu.on("change",".js-checkbox",function(){a.setItem(d(this))});a.$menu.on("click",".js-show-all",function(b){b.preventDefault();
a.$menu.find(".js-checkbox").attr("checked",!1).trigger("change");a.update()});a.$menu.on("click",".js-revert",function(b){b.preventDefault();a.$menu.find(".js-checkbox").each(function(){var b=d(this),e=b.closest(".c-item").data("id");console.log(e,0<=a.selected_ids_before.indexOf(e));b.attr("checked",0<=a.selected_ids_before.indexOf(e)).trigger("change")})});a.$menu.on("click",".js-submit",function(b){b.preventDefault();a.update()})};CRMDealRemindersFilter.prototype.setItem=function(a){var b=a.closest(".c-item"),
c=b.data("id"),d=!!this.selected_filters[c];(a=a.is(":checked"))?b.addClass("selected"):b.removeClass("selected");a?d||(this.selected_filters[c]=this.filters[c]):d&&delete this.selected_filters[c];this.setApplyUrl();this.watcher()};CRMDealRemindersFilter.prototype.watcher=function(){(function(a,b){var c=!0;a.length===b.length&&(c=!1,d.each(b,function(b,d){if(0<=a.indexOf(d))c=!1;else return c=!0,!1}));return c})(Object.keys(this.selected_filters),this.selected_ids_before)?this.$buttons.show():this.$buttons.hide()};
CRMDealRemindersFilter.prototype.setApplyUrl=function(){var a=Object.keys(this.selected_filters);this.redirect_uri=this.apply_url_pattern.replace("reminder=none",a.length?"reminder="+a.join("-"):"reminder=none")};CRMDealRemindersFilter.prototype.update=function(){d.crm.content.load(this.redirect_uri)};return CRMDealRemindersFilter}(jQuery);var CRMDealsExport=function(d){CRMDealsExport=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".js-save");this.$cancel=this.$wrapper.find(".crm-js-cancel");this.$download_file_form=this.$wrapper.find(".crm-download-file-form");this.ids=a.ids||[];this.url=d.crm.app_url+"?module=dealExport&action=process";this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMDealsExport.prototype.initClass=function(){this.initStartExport()};CRMDealsExport.prototype.initStartExport=function(){var a=
this,b=a.$cancel,c=null;a.$button.click(function(b){b.preventDefault();c=a.process()});b.click(function(a){a.preventDefault();c&&c.cancel()})};CRMDealsExport.prototype.process=function(){var a=this,b=a.url,c=a.$wrapper,e=null,f=null,g=0,h={};h.separator=c.find("[name=separator]").val();h.encoding=c.find("[name=encoding]").val();h.export_fields_name=c.find("[name=export_fields_name]").is(":checked")?1:0;h.not_export_empty_columns=c.find("[name=not_export_empty_columns]").is(":checked")?1:0;h.ids=[].concat(a.ids);
var k=function(){f&&clearTimeout(f);f=setTimeout(k,3200);!e||2<=g||(h.processId=e,d.post(b,h,function(b){g--;e&&b.ready&&(b=e)&&(f&&clearTimeout(f),e=f=null,a.$download_file_form.attr("action",a.url+"&processId="+b).appendTo("body").submit(function(){setTimeout(function(){a.$download_file_form.appendTo(a.$wrapper.find(".crm-dialog-content"));a.dialog.close()},200)}).submit())},"json"),g++)};a.$wrapper.find(".crm-start-block").hide();a.$wrapper.find(".crm-process-block").show();d.post(b,h,function(a){a.processId||
alert("Error processing request.");e=a.processId;k()},"json");return{cancel:function(){f&&clearTimeout(f);d.post(b,{processId:e,ready:1})}}};return CRMDealsExport}(jQuery);var CRMDealOperationAssignTags=function(d){CRMDealOperationAssignTags=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".js-save");this.$input=this.$wrapper.find(".crm-tags-input");this.context=a.context||{};this.dialog=this.$wrapper.data("dialog");this.default_text=this.$input.attr("placeholder");this.is_assign=a.is_assign||!1;this.initClass()};CRMDealOperationAssignTags.prototype.initClass=function(){this.initTagsInput();this.initPopularTags();this.initSave()};CRMDealOperationAssignTags.prototype.initTagsInput=
function(){var a=d.crm.app_url+"?module=contact&action=tags";this.$input.tagsInput({defaultText:this.default_text,width:this.$wrapper.find(".crm-dialog-content").width()-16,autocomplete_url:"",autocomplete:{html:!0,source:function(b,c){d.getJSON(a,{term:b.term},function(a){"ok"===a.status?c(a.data.tags||[]):c([])})}}})};CRMDealOperationAssignTags.prototype.initPopularTags=function(){var a=this.$input;this.$wrapper.find(".crm-popular-tags").find(".crm-popular-tag-item-link").click(function(){var b=
d(this),b=d.trim(b.text());a.removeTag(b);a.addTag(b)})};CRMDealOperationAssignTags.prototype.initSave=function(){var a=this,b=a.$button,c=a.$input,e=d.crm.app_url+"?module=dealOperation&action=assignTagsProcess",f=d.extend({},a.context,!0),g=a.$wrapper.find(".crm-loading");b.click(function(h){h.preventDefault();g.show();b.attr("disabled",!0);h=d("#"+c.attr("id")+"_tag");(h=d.trim(h.val()))&&h!==a.default_text&&c.addTag(h);f.tags=d.trim(c.val());f.is_assign=a.is_assign?1:0;var k=function(a){a=d.extend({offset:a||
0},f);d.post(e,a).done(function(a){"ok"==a.status&&(a.data.done?(g.hide(),b.attr("disabled",!1),d.crm.content.reload()):k(a.data.offset||0))})};k()})};return CRMDealOperationAssignTags}(jQuery);var CRMInvoiceEdit=function(d){function a(a,b){var c=a.toFixed(2);"ru"===b&&(c=c.replace(".",","));return c}function b(a){var b=0;a&&a.length&&(a=a.replace(/,/g,".").replace(/\s/g,""),b=parseFloat(a)!=a?!1:parseFloat(a));return b}CRMInvoiceEdit=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$table=this.$wrapper.find(".c-product-table");this.$tableBody=this.$table.find("tbody");this.$tax=this.$table.find(".js-tax-toggle");this.$taxPercent=this.$table.find(".js-tax-percent");
this.$taxType=this.$table.find(".js-tax-type");this.$taxName=this.$table.find(".js-tax-name");this.$taxHeader=this.$table.find(".js-tax-header");this.$currencyField=this.$wrapper.find(".js-currency-field");this.$companyField=this.$wrapper.find(".js-company-select");this.locale=a.locale;this.locales=a.locales;this.companies=a.companies||{};this.invoice_id=a.invoice_id;this.row_template_html=a.row_template_html;this.confirm_dialog_template=a.confirm_dialog_template;this.shop_supported=a.shop_supported;
this.tax_set_class="is-changed";this.currencies=a.currencies;this.supported_currencies=a.supported_currencies;this.company_id=a.company_id;this.tax=a.tax&&a.tax.name?a.tax:!1;this.active_tax_array=[];this.tax_percent=d(this.$tax.find("option")[this.$tax[0].selectedIndex]).data("percent")||"0";this.tax_type=d(this.$tax.find("option")[this.$tax[0].selectedIndex]).data("type");this.initClass()};CRMInvoiceEdit.prototype.initClass=function(){this.initDatePickers();this.initTableEvents();this.initWYSIWYG();
this.initSubmit();this.initChangeContact();this.initChangeCurrency();this.shop_supported&&this.initProductName();this.initChangeTax();this.initChangeCompany();this.initToggleButton()};CRMInvoiceEdit.prototype.initTableEvents=function(){function a(c){if(d.contains(document,b.$table[0])){var e=!0,f=b.$table.find(".js-tax-dropdown.is-active");c=d(c.target).closest(".js-tax-dropdown");c.length&&(e=c.hasClass("is-active"));f.removeClass("is-active");e||"NONE"===b.tax_type||c.addClass("is-active")}else d(document).off("click",
a)}var b=this;b.$table.on("focus",".js-name-field",function(){var a=d(this).closest("tr"),c=b.$tableBody.find("tr").length;a.index()+1>=c&&b.addTableRow(c+1)});b.$table.on("keypress",".js-name-field",function(a){13===a.keyCode&&a.preventDefault()});b.$table.on("click",".js-remove-row",function(a){a.preventDefault();1<b.$tableBody.find("tr").length&&b.removeTableRow(d(this).closest("tr"))});b.$table.on("change",".js-amount-field",function(){b.changeTableRow(d(this))});b.$table.on("change",".js-price-field",
function(){var a=d(this).closest("tr").find(".js-amount-field");a.val()||a.val("1");b.changeTableRow(d(this))});b.$table.on("click",".js-set-product-tax",function(){var a=d(this),c=a.closest(".js-tax-dropdown"),e=c.find(".js-product-tax-percent"),k=c.find(".js-product-tax-type"),a=parseInt(a.data("tax-index"));if(a=b.active_tax_array[a])parseInt(b.tax_percent)===parseInt(a.tax_percent)&&b.tax_type===a.tax_type?c.removeClass(b.tax_set_class):c.addClass(b.tax_set_class),c=b.tax_type,"NONE"===a.tax_type&&
(c="NONE"),k.val(c).trigger("change"),k=a.tax_percent+"%","NONE"===a.tax_type&&(k=b.companies[b.$companyField.val()],k=b.locales.no_tax.replace("%name",k.tax_name)),e.val(k).trigger("change"),b.refreshTable()});d(document).on("click",a)};CRMInvoiceEdit.prototype.addTableRow=function(a){var b=d(this.row_template_html);b.find(".js-product-number").text(a);this.renderProductTaxOptions(b);this.$tableBody.append(b);this.renderProductTaxFields();this.shop_supported&&this.$wrapper.trigger("addProduct",b)};
CRMInvoiceEdit.prototype.removeTableRow=function(a){a.remove();this.$tableBody.find("tr").each(function(a){d(this).find(".js-product-number").text(a+1)});this.refreshTable()};CRMInvoiceEdit.prototype.changeTableRow=function(b){var c=this.locale,d="price"===b.data("type"),g=b.val(),h=0;g&&g.length&&(g=g.replace(/,/g,".").replace(/\s/g,""),0<parseFloat(g)&&(h=parseFloat(g)));b.val(d?a(h,c):h);this.refreshTable()};CRMInvoiceEdit.prototype.refreshTable=function(){var c=this,e=function(){var e=[];c.$tableBody.find("tr").each(function(){var f=
d(this),g=f.find(".js-amount-field"),h=f.find(".js-price-field"),k=f.find(".js-product-total"),q=f.find(".js-product-tax-percent"),g=b(g.val()),h=b(h.val()),r=0;0<g&&0<h&&(r=h*g);k.text(a(r,c.locale));(k=parseInt(q.val()))&&(0<k||0===k)||(k=0);e.push({$tr:f,percent:k,amount:g,price:h,total:r})});return e}(),f=c.tax_type&&"INCLUDE"===c.tax_type,g=0,h=0;d.each(e,function(a,b){g+=b.total;var c=b.percent/100;h+=f?c/(1+c)*b.total:b.total*c});c.$table.find(".js-subtotal").text(a(g,c.locale));c.$table.find(".js-tax").text(a(h,
c.locale));c.$table.find(".js-total").text(a(g+(f?0:h),c.locale))};CRMInvoiceEdit.prototype.renderProductTaxOptions=function(a){var b=this,c=!1,g,c=a&&a.length?a.find(".js-tax-dropdown"):b.$tableBody.find(".js-tax-dropdown"),h=c.find(".js-hidden-list").html(""),k=b.companies[b.$companyField.val()],l=[];d.each(b.active_tax_array,function(a,c){g="NONE"===c.tax_type?b.locales.no_tax.replace("%name",k.tax_name):c.tax_percent+"%";0>l.indexOf(g)&&(l.push(g),h.append('<li class="ui-menu-item-html ui-menu-item"><div class="ui-menu-item-wrapper"><div class="js-set-product-tax" data-tax-index="'+
a+'">'+g+"</div></div></li>"))})};CRMInvoiceEdit.prototype.renderProductTaxFields=function(a){var b=this,c=b.$tableBody.find(".js-tax-dropdown");a&&c.removeClass(b.tax_set_class);c.each(function(){var a=d(this),c=a.find(".js-product-tax-percent"),e=a.find(".js-product-tax-type");a.hasClass(b.tax_set_class)&&"NONE"!==b.tax_type||(e.val(b.tax_type).trigger("change"),e=b.tax_percent+"%","NONE"===b.tax_type&&(e="\u2014",a.removeClass(b.tax_set_class)),c.val(e).trigger("change"))})};CRMInvoiceEdit.prototype.initSubmit=
function(){function a(){var a={data:[],errors:[]},c=h.serializeArray();d.each(c,function(b,c){"invoice[contact]"!==c.name&&a.data.push(c);"invoice[contact_id]"===c.name&&(0<c.value||a.errors.push({name:"invoice[contact_id]",value:g.locales.empty_contact}))});(function(a){g.$tableBody.find("tr").each(function(c){var e=d(this),f=e.find(".js-product-field"),g=e.find(".js-amount-field"),h=e.find(".js-price-field"),k=e.find(".js-product-tax-percent"),l=e.find(".js-product-tax-type"),e=e.find(".js-name-field"),
g=b(g.val()),h=b(h.val()),k=parseInt(k.val()),l=l.val(),f=f.val(),e=e.val();if(g||h||e)a.push({name:"items["+c+"][name]",value:e}),a.push({name:"items["+c+"][price]",value:h}),a.push({name:"items["+c+"][quantity]",value:g}),a.push({name:"items["+c+"][tax_percent]",value:0<k||0===k?k:""}),a.push({name:"items["+c+"][tax_type]",value:l});f&&a.push({name:"items["+c+"][product_id]",value:f})})})(a.data);return a}function e(a,b){b=b?b:[];if(a){var c=Object.keys(a);d.each(c,function(c,d){b.push({name:d,
value:a[d]})})}d.each(b,function(a,b){var c=b.value,e=g.$form.find('[name="'+b.name+'"]');if(e.length&&!e.hasClass("error")){var f=d("<span />").addClass("errormsg").text(c),c=e.offset(),h=g.$wrapper.offset(),k=c.top-h.top+e.outerHeight();f.css({left:c.left-h.left+"px",top:k+"px"});g.$wrapper.append(f);e.addClass("error").one("focus click change",function(){e.removeClass("error");f.remove()})}})}function f(a){k||(k=!0,d.post(d.crm.app_url+"?module=invoice&action=save",a,function(a){"ok"===a.status?
a.data.id&&(d(document).trigger("unsavedChanges",!1),d.crm.content.load(d.crm.app_url+"invoice/"+a.data.id+"/")):e(a.errors)},"json").always(function(){k=!1}))}var g=this,h=g.$form,k=!1;h.on("submit",function(b){b.preventDefault();b=a();b.errors.length?e(!1,b.errors):f(b.data)})};CRMInvoiceEdit.prototype.initDatePickers=function(){var a=this,b=a.$wrapper.find(".js-invoice-datepicker"),f=a.$wrapper.find(".js-invoice-due-datepicker"),g=a.$wrapper.find(".js-due-days-field"),h=a.$wrapper.find(".js-clear-due-date");
(function(){var c=b.parent().find("input[type='hidden']");b.datepicker({altField:c,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0});a.invoice_id||b.datepicker("setDate","+0d")})();(function(){var a=f.parent().find("input[type='hidden']");f.datepicker({altField:a,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0});f.on("change",function(){var b=d(this).val();d.trim(b).length?h.show():(a.val(""),h.hide())})})();a.$wrapper.on("click",".js-focus-on-field",function(){d(this).parent().find("input:text").trigger("focus")});
g.on("change",function(){var a=g.val(),c=0;a&&a.length&&0<parseInt(a)&&(c=parseInt(a),g.val(c));0<c?h.show():h.hide();g.val(c);a=c;c=b.datepicker("getDate");a=new Date(c.getTime()+864E5*a);f.datepicker("setDate",a)});b.on("change",function(){var a=g.val();a&&a.length&&0<parseInt(a)&&g.trigger("change")});f.on("change",function(){g.val("")});h.on("click",function(){f.val("").trigger("change")})};CRMInvoiceEdit.prototype.initChangeContact=function(){var a=this.$wrapper.find(".js-contact-toggle"),b=
a.find(".js-name"),f=a.find(".js-contact-id"),g=!1;a.on("click",".js-change-contact",function(a){a.preventDefault();var c=d(this);d.get(d.crm.app_url+"?module=invoice&action=contactAdd",function(a){new CRMDialog({html:a,options:{onAdd:function(a,d){f.val(a).trigger("change");b.text(d);if(!g){var e=c.find(".js-label"),h=e.data("change-text");e.text(h);g=!0}}}})})})};CRMInvoiceEdit.prototype.initChangeCompany=function(){function a(a,c,e){a&&a.length&&(b.active_tax_array=a);g.find("option").remove();
b.$taxHeader.text(c.length?c:"\u2014");a&&c&&d.each(a,function(a,e){var f=d('<option value="'+a+'"></option>'),h;"INCLUDE"===e.tax_type?(f.data("type","INCLUDE"),h=b.locales.include_tax):"APPEND"===e.tax_type?(f.data("type","APPEND"),h=b.locales.append_tax):"NONE"===e.tax_type&&(f.data("type","NONE"),e.tax_percent=0,h=b.locales.no_tax);0<e.tax_percent?(f.data("percent",e.tax_percent),h=h.replace("%value",e.tax_percent+"%")):(f.data("percent",0),h=h.replace("%value",""));if(h=h.replace("%name",c)){if(b.tax){var k=
c===b.tax.name,l=e.tax_type===b.tax.type,m=(+e.tax_percent).toFixed(2)===(+b.tax.percent).toFixed(2);k&&l&&m&&f.attr("selected",!0)}f.text(h);f.data("name",c);g.append(f)}});g.trigger("change",!e)}var b=this,f=b.$companyField,g=b.$tax;f.on("change",function(c,e){var f=d(this).val(),g=b.companies[f];b.active_tax_array=[];g&&(f=g.tax_name||b.locales.tax,g=JSON.parse(g.tax_options),a(g,f,e))});f.trigger("change",!0)};CRMInvoiceEdit.prototype.initChangeTax=function(){var a=this;a.$tax.on("change",function(b,
c){var e=d(this).find("option");a.tax_percent="";a.tax_type="";a.tax_name="";e.length&&(e=e[this.selectedIndex],a.tax_percent=d(e).data("percent")||0,a.tax_type=d(e).data("type"),a.tax_name=d(e).data("name"));a.$taxPercent.val(a.tax_percent);a.$taxType.val(a.tax_type);a.$taxName.val(a.tax_name);a.renderProductTaxOptions();a.renderProductTaxFields(c);a.refreshTable()})};CRMInvoiceEdit.prototype.initWYSIWYG=function(){var a=this.$wrapper.find(".js-wysiwyg");d.crm.initWYSIWYG(a,{keydownCallback:function(a){}})};
CRMInvoiceEdit.prototype.initProductName=function(){function a(a){function c(a){v&&v.abort();var c=d.crm.backend_url+"shop/?action=autocomplete&with_counts=1";a={term:a};f("loading");v=d.get(c,a,function(a){a.length?(r.html(""),d.each(a,function(a,b){var c=d("<div />");c.html(b.label).data("product",b).addClass("js-set-product");f(c)})):b.$wrapper.trigger("searchProduct")},"json").always(function(){v=!1})}function e(a){v&&v.abort();f("loading");var c=b.$currencyField.val();v=d.get(d.crm.backend_url+
"shop/?module=orders&action=getProduct",{product_id:a.id,currency:c},function(a){"ok"===a.status?(r.html(""),d.each(a.data.sku_ids,function(b,c){var e=d("<div />"),g=a.data.product.skus[c];e.text(a.data.product.name+(g.name.length?" ("+g.name+")":"")).data("product",a.data.product).data("sku",g).addClass("js-set-sku");f(e);1===a.data.sku_ids.length&&e.trigger("click")})):b.$wrapper.trigger("searchProduct")},"json").always(function(){v=!1})}function f(a){if("loading"===a)r.html("").append('<li class="ui-menu-item-html ui-menu-item"><div class="ui-menu-item-wrapper"><i class="icon16 loading"></i></div></li>');
else{var b=d("<li />").addClass("ui-menu-item-html ui-menu-item");d("<div />").addClass("ui-menu-item-wrapper").append(a).appendTo(b);b.appendTo(r)}}function g(){a.removeClass("is-active");r.html("");t=!1}function p(a){var b=r.find("li"),c=b.filter(".is-highlighted");if(!b.length)return!1;c.length&&1<b.length?(c.removeClass("is-highlighted"),a?(a=c.next(),a.length||(a=b.first())):(a=c.prev(),a.length||(a=b.last()))):a=b.first();a.addClass("is-highlighted")}function n(){var a=r.find("li.is-highlighted");
a.length&&a.find(".ui-menu-item-wrapper > *").first().trigger("click")}var q=a.find(".js-name-field"),r=a.find(".js-hidden-list"),u=a.find(".js-product-field"),t=!1,A=0,v=!1;q.on("keyup",function(e){e=e.keyCode;if(0<=[13,27,37,38,39,40].indexOf(e))switch(e){case 13:n();break;case 27:g();q.trigger("blur");break;case 38:p(!1);break;case 40:p(!0)}else{var f=d(this).val();1<f.length?(t||(b.$wrapper.trigger("searchProduct"),a.addClass("is-active"),t=!0),clearTimeout(A),A=setTimeout(function(){c(f)},500)):
b.$wrapper.trigger("searchProduct")}});q.on("change",function(){u.val("").trigger("change")});b.$wrapper.on("searchProduct",g);r.on("click",".js-set-product",function(){var a=d(this).data("product");a&&e(a)});r.on("click",".js-set-sku",function(){var b=d(this),c=b.data("product"),b=b.data("sku")||!1;if(c){var e="shop:"+c.id+(b?":"+b.id:""),f=b.price;q.val(c.name+(b.name.length?" ("+b.name+")":"")).trigger("change");a.closest("tr").find(".js-price-field").val(f).trigger("change");u.val(e).trigger("change")}g();
q.trigger("blur")})}var b=this,f=b.$wrapper.find(".js-name-autocomplete");f.length&&f.each(function(){a(d(this))});b.$wrapper.on("addProduct",function(b,c){var e=d(c).find(".js-name-autocomplete");e.length&&a(e)})};CRMInvoiceEdit.prototype.initChangeCurrency=function(){function a(a,c){b.$tableBody.find(".js-price-field").each(function(){var e=d(this),f=e.val(),g=0;f&&f.length&&(f=f.replace(/,/g,".").replace(/\s/g,""),0<parseFloat(f)&&(g=parseFloat(f)),e.val(g*b.currencies[c].rate/b.currencies[a].rate).trigger("change"))})}
var b=this,f=b.$currencyField.val();b.$currencyField.on("change",function(){var c=b.$currencyField.val(),e=!1;b.$tableBody.find(".js-price-field").each(function(){if(d(this).val().length)return e=!0,!1});e?(b.$currencyField.val(f),new CRMDialog({html:b.confirm_dialog_template,options:{changeCurrencyWithPrice:function(){b.$currencyField.val(c);a(c,f);f=c},changeCurrency:function(){b.$currencyField.val(c);f=c}}})):f=c})};CRMInvoiceEdit.prototype.initToggleButton=function(){var a=this.$wrapper.find(".js-footer-actions"),
b=a.find(".js-submit-button");this.$wrapper.on("change keydown","input, textarea, select",function(){b.removeClass("green").addClass("yellow");a.addClass("is-changed");d(document).trigger("unsavedChanges",!0)})};return CRMInvoiceEdit}(jQuery),CRMInvoiceContactAdd=function(d){CRMInvoiceContactAdd=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.dialog=this.$wrapper.data("dialog");this.locales=a.locales;this.initClass()};CRMInvoiceContactAdd.prototype.initClass=function(){function a(){var a=
e.$form.serializeArray(),b={data:[],errors:[]},c=!1,f=!1;d.each(a,function(a,d){var e=d.name,g=d.value;"deal[contact_id]"===e&&g&&(c=!0);"contact[firstname]"===e&&g&&(f=!0);"contact[lastname]"===e&&g&&(f=!0);"contact[middlename]"===e&&g&&(f=!0);"contact[name]"===e&&g&&(f=!0);b.data.push(d)});c||f||(b.errors.push({name:"contact[name]",value:e.locales.empty_name}),b.errors.push({name:"contact[firstname]",value:e.locales.empty_name}));return b}function b(a){d.post("?module=invoice&action=contactAddSave",
a,function(a){"ok"===a.status?(e.dialog.options.onAdd(a.data.id,a.data.name),e.dialog.close()):c(a.errors)},"json").always(function(){f=!1})}function c(a,b){b=b?b:[];if(a){var c=Object.keys(a);d.each(c,function(c,d){b.push({name:d,value:a[d]})})}d.each(b,function(a,b){var c=b.name,f=b.value;"name"===c&&(c="contact[firstname]");var g=e.$form.find('[name="'+c+'"]');"contact[firstname]"!==c||g.is(":visible")||(g=e.$form.find(".js-contact-autocomplete"));if(g.length&&!g.hasClass("error")){var h=d("<span />").addClass("errormsg").text(f);
h.insertAfter(g);g.addClass("error").one("focus click",function(){g.removeClass("error");h.remove()});d(document).on("toggleChanged",function(){g.removeClass("error");h.remove()})}})}var e=this,f=!1;e.$form.on("submit",function(d){d.preventDefault();d=e.$wrapper.find(".js-contact-id-field").val();var g;d?(g=e.$wrapper.find(".js-contact-autocomplete").val(),e.dialog.options.onAdd(d,g),e.dialog.close()):f||(f=!0,d=a(),d.errors.length?(c(!1,d.errors),f=!1):b(d.data))})};return CRMInvoiceContactAdd}(jQuery),
CRMInvoicePage=function(d){function a(a,c){if(!a)return!1;var b=d('.js-invoices-list .c-invoice[data-id="'+a+'"]');b.length&&(c?b.replaceWith(c):b.remove())}CRMInvoicePage=function(a){this.$wrapper=a.$wrapper;this.invoice_id=a.invoice_id;this.locales=a.locales;this.initClass()};CRMInvoicePage.prototype.initClass=function(){var a=this;a.initChangeState();a.initDelete();a.initRefund();a.initRestore();setTimeout(function(){d(document).trigger("viewInvoice",a.invoice_id)},100);a.$wrapper.data("page",
a)};CRMInvoicePage.prototype.initChangeState=function(){function b(b){f||(f=!0,d.post("?module=invoice&action=handleTransaction",{invoice_id:e,action:b},function(e){"ok"===e.status?(a(c.invoice_id,"delete"===b?"":e.data.html),c.load(d.crm.app_url+"invoice/"+c.invoice_id+"/")):alert(e.errors)},"json").always(function(){f=!1}))}var c=this,e=c.invoice_id,f=!1;c.$wrapper.on("click",".js-change-state",function(a){a.preventDefault();(a=d(this).data("action"))&&b(a)})};CRMInvoicePage.prototype.initDelete=
function(){function a(){e||(e=!0,d.post("?module=invoice&action=handleTransaction",{invoice_id:c.invoice_id,action:"delete"},function(a){"ok"===a.status&&d.crm.content.load(d.crm.app_url+"invoice/")},"json").always(function(){e=!1}))}var c=this,e=!1;c.$wrapper.on("click",".js-delete-invoice",function(b){b.preventDefault();d.crm.confirm.show({title:c.locales.delete_confirm_title,text:c.locales.delete_confirm_text,button:c.locales.delete_confirm_button,onConfirm:a})})};CRMInvoicePage.prototype.initRefund=
function(){function a(){e||(e=!0,d.post(d.crm.app_url+"?module=invoice&action=refundDialog",{invoice_id:c.invoice_id},function(a){new CRMDialog({html:a,options:{onRefund:function(){c.reload()}}})}).always(function(){e=!1}))}var c=this,e=!1;c.$wrapper.on("click",".js-change-refund",function(b){b.preventDefault();a()})};CRMInvoicePage.prototype.initRestore=function(){function b(){e||(e=!0,d.post("?module=invoiceRestore",{id:c.invoice_id},function(b){"ok"===b.status?(a(c.invoice_id,b.data.html),c.reload()):
alert(b.errors)},"json").always(function(){e=!1}))}var c=this,e=!1;c.$wrapper.on("click",".js-restore-invoice",function(a){a.preventDefault();b()})};CRMInvoicePage.prototype.load=function(a){a=d("<a />").addClass("js-disable-router").attr("href",a).hide();this.$wrapper.append(a);a.trigger("click")};CRMInvoicePage.prototype.reload=function(){this.load(location.href)};return CRMInvoicePage}(jQuery),CRMInvoiceRefundDialog=function(d){CRMInvoiceRefundDialog=function(a){this.$wrapper=a.$wrapper;this.$form=
this.$wrapper.find("form");this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMInvoiceRefundDialog.prototype.initClass=function(){this.initSubmit()};CRMInvoiceRefundDialog.prototype.initSubmit=function(){function a(){var a={data:[],errors:[]},b=e.serializeArray();d.each(b,function(b,c){a.data.push(c)});return a}function b(a){f||(f=!0,d.post(d.crm.app_url+"?module=invoice&action=handleTransaction",a,function(a){"ok"===a.status?(c.dialog.options.onRefund(),c.dialog.close()):console.log(a.errors)},
"json").always(function(){f=!1}))}var c=this,e=c.$form,f=!1;e.on("submit",function(c){c.preventDefault();c=a();c.errors.length?console.log(c.errors):b(c.data)})};return CRMInvoiceRefundDialog}(jQuery);var CRMInvoices=function(d){function a(){var a=!1,c=d("#c-invoice-page");c.length&&(c=c.data("id"))&&(a=c);return a}CRMInvoices=function(a){this.$wrapper=a.$wrapper;this.$content=this.$wrapper.find("#js-inner-content");this.$sidebar=this.$wrapper.find("#js-aside-block");this.$invoiceList=this.$sidebar.find(".js-invoices-list");this.initClass()};CRMInvoices.prototype.initClass=function(){this.initElastic();this.initContentRouter();this.initLazy();this.initInvoiceList();this.initInvoiceSearch()};CRMInvoices.prototype.initElastic=
function(){var a=this.$wrapper,c=this.$sidebar,e=this.$content;new CRMElasticBlock({$wrapper:a,$aside:c,$content:e});new CRMElasticBlock({$wrapper:a,$content:c,$aside:e});(function(){function a(){d.contains(document,k[0])?b.scrollTop()>l.top?(p||(p=d('<div class="c-space-wrapper" />').height(m),k.after(p)),k.css({left:l.left}).width(e.outerWidth()).addClass("is-fixed")):(p&&p.length&&p.remove(),k.removeAttr("style").removeClass("is-fixed")):b.off("scroll",a)}var b=d(window),e=c,k=c.find(".js-aside-header"),
l=e.offset(),m=k.outerHeight(),p=!1;b.on("scroll",a)})();d(window).trigger("scroll")};CRMInvoices.prototype.initContentRouter=function(){function a(a){function b(a){d.post("?module=dialogConfirm",{title:"Error",text:a,ok_button:"Close"},function(a){new CRMDialog({html:a})})}h&&h.abort();d(document).trigger("wa_before_load");h=d.get(a,{content_only:1},function(b){g&&history.pushState({reload:!0,content_uri:a},"",a);d(document).trigger("wa_before_render");e.html(b);d(document).trigger("wa_loaded")}).fail(function(a){a.responseText&&
b(a.responseText)}).always(function(){c.xhr=!1})}var c=this,e=c.$content.find(".js-inner-content"),f=!1,g=!(!history||!history.pushState),h=!1;c.$wrapper.on("click","a",function(b){var c=d(this),e=c.hasClass("js-disable-router")?c.attr("href"):!1;b.ctrlKey||b.shiftKey||b.metaKey||!e||(b.preventDefault(),f?d.crm.confirm.show({title:d.crm.locales.unsaved_dialog_title,text:d.crm.locales.unsaved_dialog_text,button:d.crm.locales.unsaved_dialog_button,onConfirm:function(){d(document).trigger("unsavedChanges",
!1);a(e)}}):a(e))});d(document).on("unsavedChanges",function(a,b){f=!!b})};CRMInvoices.prototype.initLazy=function(){function b(){if(d.contains(document,g[0])){var a=d(window).scrollTop(),f=e.height(),m=g.offset().top;a+f>=m&&(h||c())}else e.off("scroll",b)}function c(){var b={offset:g.data("offset")},c=a();c&&(b.invoice_id=c);h=!0;d.post("?module=invoice&action=sidebar",b,function(a){var b=d(a);a=b.find(".js-lazyload");b=b.find(".c-invoice");a.length?(a.insertAfter(g),g.remove(),g=a):g.remove();
f.append(b)}).always(function(){h=!1})}var e=d(window),f=this.$invoiceList,g=this.$wrapper.find(".js-lazyload"),h=!1;g.length&&(e.on("scroll",b),g.offset().top<e.height()&&e.trigger("scroll"))};CRMInvoices.prototype.initInvoiceList=function(){function a(a){c.$invoiceList.find(".c-invoice").each(function(){var b=d(this),c=b.data("id");a==c&&(b.addClass("selected"),e=b)})}var c=this,e=c.$invoiceList.find(".c-invoice.selected");d(document).on("viewInvoice",function(b,c){e.length&&e.removeClass("selected");
c&&a(c)})};CRMInvoices.prototype.initInvoiceSearch=function(){var a=this.$wrapper.find(".js-search-field");a.autocomplete({appendTo:this.$sidebar,classes:{"ui-autocomplete":"c-search-results-list"},source:this.app_url+"?module=invoiceAutocomplete",minLength:1,html:!0,focus:function(){return!1},select:function(b,e){d.crm.content.load(d.crm.app_url+"invoice/"+e.item.id+"/");a.val("");return!1}}).data("ui-autocomplete")._renderItem=function(a,b){return d("<li />").addClass("ui-menu-item-html").append("<div>"+
b.value+"</div>").appendTo(a)}};return CRMInvoices}(jQuery);var CRMReminderFormEdit=function(d){CRMReminderFormEdit=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.reminder_id=a.reminder_id;this.locales=a.locales;this.app_url=a.app_url;this.initClass()};CRMReminderFormEdit.prototype.initClass=function(){this.initDatePicker();this.initTimeToggle();this.initTimePicker();this.initCombobox();this.initTypeToggle();this.initSubmit()};CRMReminderFormEdit.prototype.initCombobox=function(){function a(a){a?c.addClass("is-shown"):c.removeClass("is-shown")}
var b=this,c=b.$form.find(".js-contact-wrapper"),e=c.find(".js-field");c.on("click",".js-show-combobox",function(b){b.stopPropagation();a(!0)});c.on("click",".js-hide-combobox",function(b){b.stopPropagation();a(!1)});(function(){var f=c.find(".js-autocomplete");f.autocomplete({appendTo:c,position:{my:"right top",at:"right bottom"},source:b.app_url+"?module=autocomplete&type=user",minLength:0,html:!0,focus:function(){return!1},select:function(b,d){var g=d.item,h=c.find(".js-user");g.photo_url&&h.find(".icon16").css("background-image",
"url("+g.photo_url+")");h.find(".c-name").text(g.name);e.val(g.id);a(!1);f.val("");return!1}}).data("ui-autocomplete")._renderItem=function(a,b){return d("<li />").addClass("ui-menu-item-html").append("<div>"+b.value+"</div>").appendTo(a)};f.on("focus",function(){f.data("uiAutocomplete").search(f.val())})})()};CRMReminderFormEdit.prototype.initDatePicker=function(){var a=this;a.$form.find(".js-datepicker").each(function(){var b=d(this),c=b.parent().find("input[type='hidden']");b.datepicker({altField:c,
altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0});b.parent().find(".calendar").on("click",function(){b.focus()});a.reminder_id||b.datepicker("setDate","+1d")})};CRMReminderFormEdit.prototype.initTimeToggle=function(){function a(a){a?b.addClass("is-active"):b.removeClass("is-active")}var b=this.$form.find(".js-time-toggle"),c=b.find(".js-timepicker");b.on("click",".js-show-time",function(){a(!0);c.focus()});b.on("click",".js-reset-time",function(){c.val("");a()})};CRMReminderFormEdit.prototype.initTimePicker=
function(){this.$form.find(".js-timepicker").each(function(){d(this).timepicker()})};CRMReminderFormEdit.prototype.initSubmit=function(){function a(){var a={data:[],errors:[]},b=f.serializeArray();d.each(b,function(b,c){c.value.length&&a.data.push(c)});return a}function b(a,b){b=b?b:[];if(a){var c=Object.keys(a);d.each(c,function(c,d){b.push({name:d,value:a[d]})})}d.each(b,function(a,b){var c=b.value,f=e.$form.find('[name="'+b.name+'"]');if(f.length&&!f.hasClass("error")){var g=d("<span />").addClass("errormsg").text(c);
e.$wrapper.append(g);f.addClass("error").one("focus click change",function(){f.removeClass("error");g.remove()})}})}function c(a){g||(g=!0,d.post(e.app_url+"?module=reminder&action=save",a,function(a){"ok"===a.status?d(document).trigger("reminderIsChanged"):b(a.errors)},"json").always(function(){g=!1}))}var e=this,f=e.$form,g=!1;f.on("submit",function(d){d.preventDefault();d=a();d.errors.length?b(!1,d.errors):c(d.data)})};CRMReminderFormEdit.prototype.initTypeToggle=function(){var a=this.$wrapper.find(".js-reminder-type-toggle"),
b=a.find(".js-visible-link"),c=a.find(".js-field"),e=a.find(".menu-v");e.on("click","a",function(){var a=d(this);b.find(".js-text").html(a.html());e.find(".selected").removeClass("selected");a.closest("li").addClass("selected");e.hide();setTimeout(function(){e.removeAttr("style")},200);a=a.data("type-id");c.val(a).trigger("change")})};return CRMReminderFormEdit}(jQuery);var CRMReminders=function(d){CRMReminders=function(a){this.$wrapper=a.$wrapper;this.$completedSection=this.$wrapper.find(".c-completed-reminders-section");this.user_id=a.user_id;this.locales=a.locales;this.initClass()};CRMReminders.prototype.initClass=function(){this.initAddReminder();this.initReopenReminder();this.initElastic();this.user_id&&this.$completedSection.length&&this.initCompletedReminders();this.initReminderSettings();this.initTarget()};CRMReminders.prototype.initAddReminder=function(){function a(f){var g=
d(f.target),h=d.contains(document,c[0]);f=d.contains(c[0],f.target);var k=!!g.closest(".ui-timepicker-wrapper").length,g=!!g.closest(".ui-datepicker").length,l=!e.val().length;h?f||k||g||!l||b():d(document).off("click",a)}function b(){e.val("");c.removeClass("is-extended")}var c=d("#c-add-reminder-form"),e=c.find(".js-textarea"),f=c.find(".c-icon-column .icon16"),g=c.find("form"),h=!1,k=!1;g.on("submit",function(a){a.preventDefault();k||(k=!0,f.removeClass("c-plus").addClass("loading"),a=g.serializeArray(),
d.post("?module=reminder&action=save",a,function(a){"ok"===a.status&&(d.crm.content.reload(),d.crm.sidebar.reload())},"json").always(function(){k=!1}))});e.on("focus",function(){c.addClass("is-extended")});c.on("click",".js-cancel",b);e.on("keyup",function(a){var b=13===a.keyCode;e.val().length?h||(h=!0,e.addClass("is-changed")):(h=!1,e.removeClass("is-changed"));if(!b||a.shiftKey)e.css("min-height",0),e.css("min-height",e[0].scrollHeight+"px")});e.on("keydown",function(a){13!==a.keyCode||a.shiftKey||
(a.preventDefault(),g.find("input:submit").trigger("click"))});d(document).on("click",a);(function(a){function b(a){a?c.addClass("is-shown"):c.removeClass("is-shown")}var c=a.find(".js-contact-wrapper"),e=c.find(".js-field");c.on("click",".js-show-combobox",function(a){a.stopPropagation();b(!0)});c.on("click",".js-hide-combobox",function(a){a.stopPropagation();b(!1)});(function(){var a=c.find(".js-autocomplete");a.autocomplete({appendTo:c,position:{my:"right top",at:"right bottom"},source:d.crm.app_url+
"?module=autocomplete&type=user",minLength:0,html:!0,focus:function(){return!1},select:function(d,f){var g=f.item,h=c.find(".js-user");g.photo_url&&h.find(".icon16").css("background-image","url("+g.photo_url+")");h.find(".c-name").text(g.name);e.val(g.id);b(!1);a.val("");return!1}}).data("ui-autocomplete")._renderItem=function(a,b){return d("<li />").addClass("ui-menu-item-html").append("<div>"+b.value+"</div>").appendTo(a)};a.on("focus",function(){a.data("uiAutocomplete").search(a.val())})})()})(c);
(function(a){a=a.find(".js-reminder-type-toggle");var b=a.find(".js-visible-link"),c=a.find(".js-field"),e=a.find(".menu-v");e.on("click","a",function(){var a=d(this);b.find(".js-text").html(a.html());e.find(".selected").removeClass("selected");a.closest("li").addClass("selected");e.hide();setTimeout(function(){e.removeAttr("style")},200);a=a.data("type-id");c.val(a).trigger("change")})})(c);(function(){c.find(".js-datepicker").each(function(){var a=d(this),b=a.parent().find("input[type='hidden']");
a.datepicker({altField:b,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0});a.parent().find(".calendar").on("click",function(){a.focus()})})})();(function(){function a(a){a?b.addClass("is-active"):b.removeClass("is-active")}var b=c.find(".js-time-toggle"),d=b.find(".js-timepicker");b.on("click",".js-show-time",function(){a(!0);d.focus()});b.on("click",".js-reset-time",function(){d.val("");a()})})();(function(){c.find(".js-timepicker").each(function(){d(this).timepicker()})})()};CRMReminders.prototype.initCompletedReminders=
function(){function a(){var a={user_id:e.user_id};l=!0;d.post("?module=reminder&action=completed",a,function(a){b(!0);h=!0;g.append(a);c();d(window).trigger("scroll")}).always(function(){l=!1})}function b(a,b){b?(f.toggleClass("is-shown"),k=!k):a?(f.addClass("is-shown"),k=!0):(f.removeClass("is-shown"),k=!1)}function c(){function a(){if(d.contains(document,h[0])){if(k){var c=h,e=d(window).scrollTop(),g=f.height(),m=c.offset().top;e+g>=m&&(l||b(c))}}else f.off("scroll",a)}function b(a){var b={user_id:e.user_id,
min_dt:g.find("> li[data-datetime]:last").data("datetime")};l=!0;d.post("?module=reminder&action=completed",b,function(b){a.remove();g.append(b);c()}).always(function(){l=!1})}var f=d(window),h=g.find(".js-lazy-load"),l=!1;if(h.length)f.on("scroll",a)}var e=this,f=e.$completedSection,g=f.find(".c-reminders-list"),h=!1,k=!1,l=!1;f.on("click",".js-load-completed-reminders",function(c){c.preventDefault();h?b(!1,!0):l||a()})};CRMReminders.prototype.initElastic=function(){var a=this.$wrapper,b=this.$wrapper.find("#js-aside-block"),
c=this.$wrapper.find("#js-content-block");b.length&&new CRMElasticBlock({$wrapper:a,$aside:b,$content:c});c.length&&new CRMElasticBlock({$wrapper:a,$content:b,$aside:c});d(window).trigger("scroll")};CRMReminders.prototype.initReopenReminder=function(){function a(a){b||(b=!0,d.post("?module=reminder&action=markAsUndone",{id:a},function(a){"ok"==a.status&&d.crm.content.reload()}).always(function(){b=!1}))}var b=!1;this.$wrapper.on("click",".js-reopen-reminder",function(b){b.preventDefault();b=d(this);
var c=b.closest(".c-reminder-wrapper");b.addClass("is-loading");a(c.data("id"))})};CRMReminders.prototype.initReminderSettings=function(){function a(){b||(b=!0,d.post("?module=reminder&action=settings",{},function(a){new CRMDialog({html:a})}).always(function(){b=!1}))}var b=!1;this.$wrapper.on("click",".js-show-settings",function(b){b.preventDefault();a()})};CRMReminders.prototype.initTarget=function(){var a=this;d(window).load(function(){setTimeout(function(){var b=a.$wrapper.find(".c-reminder-wrapper.is-target");
b.length&&(b=b.offset().top,d(window).scrollTop(b-50))},100)})};return CRMReminders}(jQuery),CRMReminder=function(d){CRMReminder=function(a){this.$wrapper=a.$wrapper;this.$marker=this.$wrapper.find(".c-marker");this.$steps=this.$wrapper.find(".c-step");this.$view=this.$steps.filter(".is-view");this.$edit=this.$steps.filter(".is-edit");this.$confirm=this.$steps.filter(".is-confirm");this.$textarea=this.$edit.find("textarea");this.id=a.id;this.shown_class="is-shown";this.$activeContent=this.$view;this.xhr=
!1;this.initClass()};CRMReminder.prototype.initClass=function(){function a(a){a?b.$confirm.addClass("is-shown"):b.$confirm.removeClass("is-shown")}var b=this;b.$wrapper.on("click",".js-cancel",function(a){a.preventDefault();b.toggleContent(b.$view)});b.$wrapper.on("click",".js-edit-reminder",function(a){a.preventDefault();b.$textarea.data("value")?b.$textarea.val(b.$textarea.data("value")):b.$textarea.data("value",b.$textarea.val());b.toggleContent(b.$edit)});b.$edit.find("form").on("submit",function(){d(document).one("reminderIsChanged",
function(){d.crm.content.reload()})});b.$wrapper.on("click",".js-confirm-delete",function(a){a.preventDefault();b.remove()});b.$wrapper.on("click",".js-remove",function(b){b.preventDefault();a(!0)});b.$wrapper.on("click",".js-confirm-cancel",function(b){b.preventDefault();a(!1)});b.initDone();b.initQuickDateToggle();b.initQuickContentEdit()};CRMReminder.prototype.remove=function(){var a=this,b={id:a.id};a.xhr&&a.xhr.abort();a.xhr=d.post("?module=reminder&action=delete",b,function(b){"ok"===b.status&&
(a.$wrapper.remove(),d.crm.content.reload(),d.crm.sidebar.reload())}).always(function(){a.xhr=!1})};CRMReminder.prototype.initDone=function(){var a=this,b=a.$wrapper;b.on("click",".js-mark-done",function(c){b.css("display","none");c.preventDefault();d(this).addClass("is-done");d.post("?module=reminder&action=markAsDone",{id:a.id},function(a){"ok"===a.status?(b.remove(),d.crm.content.reload(),d.crm.sidebar.reload()):b.css("display","")}).always(function(){})})};CRMReminder.prototype.toggleContent=
function(a){this.$activeContent.length&&this.$activeContent.removeClass(this.shown_class);a.addClass(this.shown_class);this.$activeContent=a};CRMReminder.prototype.initQuickDateToggle=function(){function a(b){if(d.contains(document,f[0])){var e=d.contains(f[0],b.target);if(g){var h=d(b.target);b=!!h.closest(".ui-timepicker-wrapper").length;var k=!!h.closest(".ui-datepicker").length,h=!!h.hasClass("ui-icon-circle-triangle-e");if(b||k||h)return!1}!e&&g&&c(!1)}else d(document).off("click",a)}function b(){if(!h){h=
!0;var a=k.serializeArray();e.renderLoading(!0);d.post("?module=reminder&action=save",a,function(a){"ok"===a.status&&(d.crm.content.reload(),d.crm.sidebar.reload())}).always(function(){e.renderLoading(!1);h=!1})}}function c(a){a?(f.addClass("is-extended"),l.focus(),g=!0):(f.removeClass("is-extended"),g=!1)}var e=this,f=e.$wrapper.find(".js-quick-date-toggle-wrapper"),g=!1,h=!1;if(!f.length)return!1;var k=f.find("form"),l=f.find(".js-date-field");f.on("click",".js-change-date",function(a){a.preventDefault();
c(!0)});f.on("click",".js-cancel-edit-date",function(a){a.preventDefault();c(!1)});f.on("click",".js-save-date",function(a){a.preventDefault();b()});d(document).on("click",a);(function(){var a=f.find(".js-alt-date-field");l.datepicker({altField:a,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0});l.parent().find(".calendar").on("click",function(){l.focus()})})();(function(){function a(a){a?b.addClass("is-active"):b.removeClass("is-active")}var b=f.find(".js-time-toggle"),c=b.find(".js-timepicker");
b.on("click",".js-show-time",function(){a(!0);c.focus()});b.on("click",".js-reset-time",function(){c.val("");a()});f.find(".js-timepicker").timepicker()})()};CRMReminder.prototype.initQuickContentEdit=function(){function a(){if(!k){k=!0;c.renderLoading(!0);var a=f.serializeArray();d.post("?module=reminder&action=save",a,function(a){"ok"===a.status&&(h=!1,g.removeClass("is-changed").blur())}).always(function(){k=!1;c.renderLoading(!1)})}}function b(){g.css("min-height",0);g.css("min-height",g[0].scrollHeight+
"px")}var c=this,e=c.$wrapper.find(".js-quick-content-toggle-wrapper");if(!e.length)return!1;var f=e.find("form"),g=f.find(".js-textarea"),h=!1,k=!1;g.on("keyup",function(a){var c=13===a.keyCode;g.val().length?h||(h=!0,g.addClass("is-changed")):(h=!1,g.removeClass("is-changed"));c&&!a.shiftKey||b()});g.on("keydown",function(b){13!==b.keyCode||b.shiftKey||(b.preventDefault(),h&&a())});g.on("blur",function(){h&&a()});b()};CRMReminder.prototype.renderLoading=function(a){var b=this.$marker,c=b.data("icon");
c||(c=d('<i class="icon16 loading"></i>'),b.prepend(c),b.data("icon",c));a?(b.addClass("is-load"),c.show()):(b.removeClass("is-load"),c.hide())};return CRMReminder}(jQuery),CRMCompletedReminder=function(d){CRMCompletedReminder=function(a){this.$wrapper=a.$wrapper;this.$marker=this.$wrapper.find(".c-marker");this.marker_html=this.$marker.html();this.reminder_id=a.reminder_id;this.initClass()};CRMCompletedReminder.prototype.initClass=function(){this.initQuickContentEdit()};CRMCompletedReminder.prototype.initQuickContentEdit=
function(){function a(){if(!k){k=!0;c.renderLoading(!0);var a=f.serializeArray();d.post("?module=reminder&action=save",a,function(a){"ok"===a.status&&(h=!1,g.removeClass("is-changed").blur())}).always(function(){k=!1;c.renderLoading(!1)})}}function b(){g.css("min-height",0);g.css("min-height",g[0].scrollHeight+"px")}var c=this,e=c.$wrapper.find(".js-quick-content-toggle-wrapper");if(!e.length)return!1;var f=e.find("form"),g=f.find(".js-textarea"),h=!1,k=!1;g.on("keyup",function(a){var c=13===a.keyCode;
g.val().length?h||(h=!0,g.addClass("is-changed")):(h=!1,g.removeClass("is-changed"));c&&!a.shiftKey||b()});g.on("keydown",function(b){13!==b.keyCode||b.shiftKey||(b.preventDefault(),h&&a())});g.on("blur",function(){h&&a()});b()};CRMCompletedReminder.prototype.renderLoading=function(a){var b=this.$marker;a?(b.addClass("is-load"),b.html('<i class="icon16 loading"></i>')):(b.removeClass("is-load"),b.html(this.marker_html))};return CRMCompletedReminder}(jQuery),CRMReminderSettingsDialog=function(d){CRMReminderSettingsDialog=
function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$button=this.$wrapper.find(".js-submit-button");this.$options=this.$wrapper.find(".js-options-list");this.$groups=this.$wrapper.find(".js-group-list");this.$select=this.$wrapper.find(".js-select-list");this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMReminderSettingsDialog.prototype.initClass=function(){var a=this;a.$form.on("change","input",function(){a.toggleButton(!0)});a.$options.on("change","input",function(){var b=
d(this),c=b.val();"checked"===b.attr("checked")&&("groups"===c?a.$groups.show():a.$groups.hide());a.dialog.resize()});a.$form.on("change",".daily-recap",function(){var b=d(this)["0"].checked,c=a.$select,e=d(".crm-reminders-recap-error");b?(c.attr("disabled",!1),e.length&&(d(e).fadeIn(),a.dialog.resize())):(c.attr("disabled",!0),e.length&&(d(e).fadeOut(),a.dialog.resize()))});a.$form.on("change",".js-pop-up-disabled",function(){var b=d(this),c=a.$wrapper.find(".js-pop-up-min");b.is(":checked")?(c.prop("readonly",
!1),c.focus()):c.prop("readonly",!0)});a.initSave()};CRMReminderSettingsDialog.prototype.initSave=function(){function a(){e||(e=!0,d('<i class="icon16 loading" style="vertical-align: middle;margin-left: 10px;"></i>').appendTo(".crm-actions"),d(".js-submit-button").prop("disabled",!0),d.post("?module=reminder&action=settingsSave",c.serializeArray(),function(a){"ok"===a.status&&("my"==b.$options.find(":checked").val()?d.crm.content.load(d.crm.app_url+"reminder/"):(d(".loading").remove(),d('<i class="icon16 yes" style="vertical-align: middle;margin-left: 10px;"></i>').appendTo(".crm-actions"),
setTimeout(function(){b.dialog.close();d.crm.content.reload()},1E3)))},"json").always(function(){b.toggleButton(!1);e=!1}))}var b=this,c=b.$form,e=!1,f=b.$wrapper.find(".js-pop-up-disabled");d(".js-submit-button").on("click",function(){f.is(":checked")?0<parseInt(d(".js-pop-up-min").val())?a():d(".enter-minutes").fadeIn().delay("2000").fadeOut():a()})};CRMReminderSettingsDialog.prototype.toggleButton=function(a){var b=this.$button;a?b.removeClass("green").addClass("yellow"):b.removeClass("yellow").addClass("green")};
return CRMReminderSettingsDialog}(jQuery),CRMReminderSettings=function(d){CRMReminderSettings=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".js-submit-button");this.$options=this.$wrapper.find(".js-options-list");this.$groups=this.$wrapper.find(".js-group-list");this.$select=this.$wrapper.find(".js-select-list");this.$wrapper.data("instance",this);this.initClass()};CRMReminderSettings.prototype.initClass=function(){var a=this;a.$options.on("change","input",function(){var b=
d(this),c=b.val();"checked"===b.attr("checked")&&("groups"===c?a.$groups.show():a.$groups.hide())});a.$wrapper.on("change",".daily-recap",function(){var b=d(this)["0"].checked,c=a.$select,e=d(".crm-reminders-recap-error");b?(c.attr("disabled",!1),e.length&&d(e).fadeIn()):(c.attr("disabled",!0),e.length&&d(e).fadeOut())});a.$wrapper.on("change",".js-pop-up-disabled",function(){var b=d(this),c=a.$wrapper.find(".js-pop-up-min");b.is(":checked")?(c.prop("readonly",!1),c.focus()):c.prop("readonly",!0)})};
CRMReminderSettings.prototype.validateBeforeSave=function(){return this.$wrapper.find(".js-pop-up-disabled").is(":checked")&&0>=parseInt(d(".js-pop-up-min").val())?(d(".enter-minutes").fadeIn().delay("2000").fadeOut(),!1):!0};return CRMReminderSettings}(jQuery);var CRMLogLive=function(d){var a=function(b){a=function(a){this.list_name=a.names.list;this.items_name=a.names.items;this.pagind_name=a.names.paging;this.log=a.log;this.$wrapper=a.$wrapper||!1;this.$list=this.$wrapper.find(this.list_name);this.$window=b(window);this.onLoad=a.onLoad||function(){};this.$paging=this.$wrapper.find(this.pagind_name);this.is_locked=this.xhr=!1;this.addWatcher()};a.prototype.addWatcher=function(){function a(){var e=window&&b.contains(document,c.$paging[0]);e&&d&&window.frameElement&&
(e=b.contains(d.document,window.frameElement));if(e)c.onScroll();else c.$window.off("scroll",a),b(d).off("scroll",a)}var c=this,d=window.parent;c.$window.on("scroll",a);if(d&&window.frameElement)b(d).on("scroll",a)};a.prototype.onScroll=function(){var a=this.$window,c=a.scrollTop(),a=a.height(),d=this.$paging.offset().top;if(window.parent&&window.frameElement)var h=b(window.parent),a=h.height(),c=c+h.scrollTop(),d=d+b(window.frameElement).offset().top;c+a>=d&&!this.is_locked&&(this.is_locked=!0,this.loadNextPage())};
a.prototype.loadNextPage=function(){var a=this,c=a.log.filtersData.slice(0);c.push({name:"max_id",value:a.$paging.data("max-id")});c.push({name:"timestamp",value:a.$list.find(a.items_name).last().data("timestamp")});a.xhr&&a.xhr.abort();a.xhr=b.get("?module=logLive",c,function(c){var d=b("<div id='c-temp-wrapper' />");a.log.$wrapper.after(d);d.html(c);c=d.find(a.list_name+" "+a.items_name);d=d.find(a.pagind_name);a.$list.append(c);a.$paging.after(d);a.$paging.remove();a.$paging=d;a.is_locked=!1;a.onLoad()})};
return a}(jQuery),b=function(a){function c(a,b){var c=a.offsetWidth,d=a.offsetHeight;return{outer_width:c,outer_height:d,inner_width:c-b.left-b.right,inner_height:d-b.top-b.bottom}}function d(b){function c(a){var b=a.split("-");a=parseInt(b[0]);var c=parseInt(b[1])-1,b=parseInt(b[2]);return new Date(a,c,b)}var d=[];b=function(b){function c(a,b){var c=a.split("-"),d=parseInt(c[0]),e=parseInt(c[1])-1,c=parseInt(c[2]),c=new Date((new Date(d,e,c)).getTime()+(b?864E5:-864E5)),d=parseInt(c.getFullYear()),
e=parseInt(c.getMonth())+1,c=parseInt(c.getDate());10>c&&(c="0"+c);10>e&&(e="0"+e);return[d,e,c].join("-")}1===b[0].data.length&&a.each(b,function(a){var d=b[a].data[0],e={value:0,date:c(d.date,!1)},f={value:0,date:c(d.date,!0)};b[a].data=[e,d,f]});return b}(b);for(var e=0;e<b.length;e++){for(var f=b[e].data,g=[],h=0;h<f.length;h++){var k=f[h],t=parseInt(k.value);g.push({date:c(k.date),value:t})}d.push(g)}return d3.layout.stack().offset("zero").values(function(a){return a}).x(function(a){return a.date}).y(function(a){return a.value})(d)}
function g(a,b,c){var d=null;c+=1;a&&c&&(d=(a-b*(c-1))/c,1>d&&(d=1));return d}function h(a,b){for(var c=b[0],d=b[1]||1,c=d-c+(1<d-c?0:1),d=c/(a-1),e=[],f=0;f<a;f++){var g=10<c?Math.round(f*d):parseInt(f*d*10)/10;e.push(g)}return e}b=function(a){this.$wrapper=a.$wrapper;this.$hint=this.$wrapper.find(".js-hint-wrapper");this.node=this.$wrapper.find(".js-chart-wrapper")[0];this.d3node=d3.select(this.node);this.show_class="is-shown";this.charts=a.data;this.data=d(this.charts);this.group_by=a.group_by;
this.locales=a.locales;this.margin={top:14,right:10,bottom:28,left:34};this.area=c(this.node,this.margin);this.column_indent=200<this.data[0].length?2:4;this.column_width=g(this.area.inner_width,this.column_indent,this.data[0].length);this.yAxis=this.xAxis=this.yDomain=this.xDomain=this.y=this.x=this.defs=this.svg=!1;this.initGraph()};b.prototype.initGraph=function(){var b=this,c=b.area;b.initGraphCore();200<b.data[0].length&&b.$wrapper.addClass("is-large");b.svg=b.d3node.append("svg").attr("width",
c.outer_width).attr("height",c.outer_height);b.renderBackground();b.renderCharts();b.renderAxis();setTimeout(function(){function c(){a.contains(document,b.$wrapper[0])?b.update():a(window).off("resize",c)}a(window).on("resize",c)},4)};b.prototype.initGraphCore=function(){var a=this.data,b=this.area,c=this.x=d3.time.scale().range([0,b.inner_width]),b=this.y=d3.scale.linear().range([b.inner_height,0]);this.yDomain=function(){var b=d3.min(a,function(a){return d3.min(a,function(a){return a.value})});
0<b&&(b=0);var c=d3.max(a,function(a){return d3.max(a,function(a){return a.value+a.y0})});return[b,c]}();this.xDomain=function(){var b,c;b=a[0][0].date;c=a[0][a[0].length-1].date;var d=parseInt((a[0][1].date.getTime()-b.getTime())/2);b=new Date(b.getTime()-d);c=new Date(c.getTime()+d);return[b,c]}();c.domain(this.xDomain);b.domain(this.yDomain)};b.prototype.renderAxis=function(){var a=this.x,b=this.y,c=this.svg;this.xAxis=d3.svg.axis().scale(a).orient("bottom").ticks(10);this.yAxis=d3.svg.axis().scale(b).innerTickSize(2).orient("right").tickValues(h(6,
this.yDomain)).tickFormat(function(a){return a+""});a=c.append("g").attr("class","axis");a.append("g").attr("transform","translate(10,"+this.margin.top+")").attr("class","y").call(this.yAxis);a.append("g").attr("class","x").attr("transform","translate("+this.margin.left+","+(this.area.outer_height-this.margin.bottom)+")").call(this.xAxis)};b.prototype.renderBackground=function(){var a=this.area.inner_width,b=this.area.inner_height,c,d=this.svg.append("g").attr("class","background").attr("transform",
"translate("+this.margin.left+","+this.margin.top+")");d.append("rect").attr("width",a).attr("height",b);for(c=0;5>=c;c++){var e=1+(b-2)/5*c;d.append("line").attr("x1",1).attr("x2",a).attr("y1",e).attr("y2",e)}};b.prototype.renderCharts=function(){var a=this,b=a.data,b=a.svg.selectAll(".c-graph-wrapper").data(b);b.enter().append("g").attr("class","c-graph-wrapper").attr("transform","translate("+a.margin.left+","+a.margin.top+")");var c=b.selectAll(".rect").data(function(a){return a});c.enter().append("rect").attr("class",
"rect").style("fill",function(b,c,d){return(b=a.charts[d].color)?b:!1}).on("mouseover",function(b,c,d){a.showHint(d3.event,this,b,a.charts[d])}).on("mousemove",function(){a.moveHint(this)}).on("mouseout",function(){a.hideHint()});c.transition().duration(1E3).attr("x",function(b,c){return a.x(b.date)-a.column_width/2}).attr("y",function(b){return a.y(b.y0)+a.y(b.value)-a.area.inner_height}).attr("height",function(b){return a.area.inner_height-a.y(b.value)}).attr("width",a.column_width);c.exit().remove();
b.exit().remove()};b.prototype.update=function(a){if(!a)return!1;this.data=d(a.chart);this.group_by=a.group_by||"days";this.area=c(this.node,this.margin);this.column_indent=200<this.data[0].length?2:4;this.column_width=g(this.area.inner_width,this.column_indent,this.data[0].length);this.svg.attr("width",this.area.outer_width).attr("height",this.area.outer_height);200<this.data[0].length?this.$wrapper.addClass("is-large"):this.$wrapper.removeClass("is-large");this.initGraphCore();this.yAxis.scale(this.y).tickValues(h(6,
this.yDomain));this.svg.selectAll(".axis .y").transition().duration(600).call(this.yAxis);this.xAxis.scale(this.x);this.svg.selectAll(".axis .x").transition().duration(600).call(this.xAxis);this.renderCharts()};b.prototype.showHint=function(b,c,d,e){var f=this;b=a(c);if(!(0<Math.ceil(b.attr("height"))))return!1;var g=d.date;c=f.$hint.find(".c-date");var h=f.$hint.find(".c-app"),k=f.$hint.find(".c-value"),g=function(a,b){var c=parseInt(a.getMonth());if("months"==b){var d=f.locales.months;d[c]||(d=
"\u042f\u043d\u0432\u0430\u0440\u044c \u0424\u0435\u0432\u0440\u0430\u043b\u044c \u041c\u0430\u0440\u0442 \u0410\u043f\u0440\u0435\u043b\u044c \u041c\u0430\u0439 \u0418\u044e\u043d\u044c \u0418\u044e\u043b\u044c \u0410\u0432\u0433\u0443\u0441\u0442 \u0421\u0435\u043d\u0442\u044f\u0431\u0440\u044c \u041e\u043a\u0442\u044f\u0431\u0440\u044c \u041d\u043e\u044f\u0431\u0440\u044c \u0414\u0435\u043a\u0430\u0431\u0440\u044c".split(" "));c=d[c]}else d=a.getDate(),c+=1,c=(10>d?"0"+d:d)+"."+(10>c?"0"+c:c)+
"."+a.getFullYear();return c}(g,f.group_by);c.text(g);h.text(e.name);k.text(d.value);d=function(b){var c=a(window),d=c.width();c.height();var c=f.$hint.outerWidth(),e=f.$hint.outerHeight(),g=Math.ceil(b.attr("width")),h=Math.ceil(b.attr("height")),k=f.$wrapper.offset();b=b.offset();e={left:b.left-k.left+g+10,top:b.top-k.top+(h<e?h-e-2:2)};d<b.left+10+c&&(e.left=b.left-k.left-g-c);return e}(b);f.$hint.css(d).addClass(f.show_class)};b.prototype.moveHint=function(){};b.prototype.hideHint=function(){this.$hint.removeAttr("style").removeClass(this.show_class)};
return b}(jQuery);CRMLogLive=function(a){this.$wrapper=a.$wrapper;this.$filtersForm=this.$wrapper.find("form.js-filters-form");this.chartData=a.chartData;this.chartParams=a.chartParams;this.locales=a.locales;this.chart=!1;this.filtersData=this.$filtersForm.serializeArray();this.initClass()};CRMLogLive.prototype.initClass=function(){this.initLogList();this.initDateFilter();this.initChart()};CRMLogLive.prototype.initLogList=function(){function b(){e.find(".c-activity-item.is-first").each(function(){var a=
d(this).prev().prev();a.hasClass("is-last")||a.addClass("is-last")})}var e=this.$wrapper.find("#c-activity-section");b();new a({$wrapper:e,names:{list:".c-activity-list",items:"> li",paging:".c-paging-wrapper"},log:this,onLoad:b})};CRMLogLive.prototype.initDateFilter=function(){function a(a){var c=a.data("timeframe"),d=a.data("group")||"days";p.html(a.find("a").html());r.length&&r.removeClass("selected");r=a.addClass("selected");k.hide();setTimeout(function(){k.removeAttr("style")},200);m.val(c);
l.val(d);"custom"!==c?(n.removeClass("is-shown"),b()):n.addClass("is-shown")}function b(){var a=h.serializeArray();a.push({name:"chart",value:1});d.post("?module=logLive",a,function(a){"ok"==a.status&&(a=a.data,a.group_by=l.val(),f.chart.update(a))},"json").always(function(){q=!1})}var f=this,g=f.$wrapper.find(".js-dates-filter"),h=g.find("form"),k=g.find(".js-list"),l=g.find(".js-group-field"),m=g.find(".js-timeframe-field"),p=g.find(".js-link-text"),n=g.find(".js-hidden-part"),q=!1,r=k.find(".selected");
k.on("click",".js-toggle",function(b){b.preventDefault();a(d(this))});h.on("submit",function(a){a.preventDefault();q||(q=!0,b())});(function(){g.find(".js-datepicker").each(function(){var a=d(this),b=g.find("."+a.data("selector"));a.datepicker({altField:b,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0})})})()};CRMLogLive.prototype.initChart=function(){var a=this.$wrapper.find(".js-chart-section");a.length&&this.chartData&&this.chartData.length&&(this.chart=new b({$wrapper:a,data:this.chartData,
group_by:this.chartParams.group_by,locales:this.locales}))};return CRMLogLive}(jQuery),CRMLogLiveItem=function(d){CRMLogLiveItem=function(a){this.$wrapper=a.$wrapper;this.initClass()};CRMLogLiveItem.prototype.initClass=function(){d.crm.renderSVG(this.$wrapper);this.$wrapper.data("logLiveItem",this)};return CRMLogLiveItem}(jQuery);var CRMCallPage=function(d){CRMCallPage=function(a){this.$wrapper=a.$wrapper;this.call_ts=a.call_ts;this.locales=a.locales;this.numbers_assigned=a.numbers_assigned;this.initClass()};CRMCallPage.prototype.initClass=function(){d.wa_push&&d.wa_push.init();d.crm.renderSVG(this.$wrapper);this.initRedirectCall();this.initDeleteCall();this.numbers_assigned&&d.wa_push&&d.wa_push.init();this.initAssociateDeal();this.initBackgroundReload();this.initFinishCallLinks()};CRMCallPage.prototype.initFinishCallLinks=
function(){this.$wrapper.on("click",".js-finish-call",function(a){var b=d(this);a=d.crm.app_url+"?module=call&action=finish";var c=b.closest(".c-call-wrapper"),e=c.data("id");0>=e||b.data("loading")||(b.data("loading",1),b.find(".loading").show(),b.find(".yes-bw").hide(),d.post(a,{id:e},function(a){if("ok"===a.status){a=d("<div>").html(a.data.html);var f=a.find('.c-call-wrapper[data-id="'+e+'"]').find(".c-column-state");c.find(".c-column-state").replaceWith(f);a.remove()}else b.data("loading",0),
b.find(".loading").hide(),b.find(".yes-bw").show()}).error(function(){b.data("loading",0);b.find(".loading").hide();b.find(".yes-bw").show()}))})};CRMCallPage.prototype.initRedirectCall=function(){this.$wrapper.on("click",".js-redirect-call",function(a){a=d(this).parents(".c-call-wrapper").data("id");a=d.crm.app_url+"?module=call&action=redirectDialog&id="+a;var b=d(this);b.prop("disabled",!0).find(".icon16").removeClass("rotate-right").addClass("loading");d.get(a,function(a){new CRMDialog({html:a,
onOpen:function(){b.prop("disabled",!1).find(".icon16").removeClass("loading").addClass("rotate-right")}})})})};CRMCallPage.prototype.initDeleteCall=function(){function a(a){var e=a.closest(".c-call-wrapper"),g=e.data("id"),h=a.data("title");d.crm.confirm.show({title:h,text:b.locales.delete_confirm_text,button:b.locales.delete_confirm_button,onConfirm:function(){if(!c){c=!0;var b={id:g},f=a.find(".delete");f.removeClass("delete").addClass("loading");d.post("?module=call&action=delete",b,function(a){"ok"===
a.status&&e.remove()}).always(function(){f.removeClass("loading").addClass("delete");c=!1})}}})}var b=this,c=!1;b.$wrapper.on("click",".js-delete-call",function(b){b.preventDefault();a(d(this))})};CRMCallPage.prototype.initAssociateDeal=function(){this.$wrapper.find(".js-associate-deal").on("click",function(){var a=d(this).data("dialog-url");d.get(a,function(a){new CRMDialog({html:a})})})};CRMCallPage.prototype.initBackgroundReload=function(){function a(){clearTimeout(f);f=setTimeout(b,1E4)}function b(){var b=
!1,f=c.$wrapper.find("audio");d.each(f,function(a,c){d(c)[0].ended||(b=!0)});if(b)return a(),!1;e||(e=!0,d.post("?module=call&action=ts",{call_ts:c.call_ts},function(b){"ok"==b.status&&d.contains(document,c.$wrapper[0])&&(b.data!==c.call_ts?d.crm.content.reload():a())}).always(function(){e=!1}))}var c=this,e=!1,f=0;a()};return CRMCallPage}(jQuery);var CRMCallAssociateDealDialog=function(d){CRMCallAssociateDealDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$footer=this.$wrapper.find(".js-dialog-footer");this.$submit=this.$form.find(".js-submit");this.$deal_name=this.$form.find(".js-deal-name");this.$deal_funnel=this.$form.find(".js-select-deal-funnel");this.$deal_stage=this.$form.find(".js-select-deal-stage");this.$deal_id=this.$form.find(".js-deal-id");this.dialog=this.$wrapper.data("dialog");this.initClass()};
CRMCallAssociateDealDialog.prototype.initClass=function(){d.crm.renderSVG(this.$wrapper);this.initSelectDeal();this.initSubmit()};CRMCallAssociateDealDialog.prototype.initSelectDeal=function(){var a=this,b=a.$form.find(".js-select-deal .js-visible-link .js-text"),c=a.$form.find(".js-select-funnel"),e=a.$form.find(".js-deals-list"),f=a.$form.find(".js-deal-name-field");a.$form.on("click",".js-create-new-deal",function(){a.$submit.addClass("yellow").removeAttr("disabled");var e=d(this).find(".js-text").html();
a.deal_selected=!0;c.removeClass("hidden");f.removeClass("hidden");a.$deal_name.focus();b.html(e);a.$deal_id.val("0")});a.$form.on("click",".js-deal-item",function(){a.$submit.addClass("yellow").removeAttr("disabled");var g=d(this).find(".js-text").html();a.deal_selected=!0;e.find("li").removeClass("selected");d(this).parent().addClass("selected");b.html(g);c.addClass("hidden");f.addClass("hidden");a.$deal_name.val("");a.$deal_id.val(d(this).data("deal-id"))});e.on("click",function(){e.hide();setTimeout(function(){e.removeAttr("style")},
200)});a.$form.on("change",".js-select-deal-funnel",function(){a.$form.find(".js-select-stage-wrapper").load("?module=deal&action=stagesByFunnel&id="+d(this).val())})};CRMCallAssociateDealDialog.prototype.initSubmit=function(){function a(){var a=d('<i class="icon16 loading" style="vertical-align: middle; margin-left: 6px;"></i>'),c=d.crm.app_url+"?module=call&action=associateDealSave",g=b.$form.serializeArray();b.$submit.prop("disabled",!0);b.$footer.append(a);d.post(c,g,function(c){"ok"===c.status?
d.crm.content.reload():(b.$submit.prop("disabled",!1),a.remove())})}var b=this,c=b.$wrapper.find(".js-deal-value");b.$form.on("submit",function(e){e.preventDefault();if(!b.$deal_id.val())return c.addClass("shake animated").focus(),setTimeout(function(){c.removeClass("shake animated").focus()},500),!1;if(0==b.$deal_id.val()&&!d.trim(b.$deal_name.val()))return b.$deal_name.addClass("shake animated").focus(),setTimeout(function(){b.$deal_name.removeClass("shake animated").focus()},500),!1;a()})};return CRMCallAssociateDealDialog}(jQuery);var CRMCallInitContactDialog=function(d){CRMCallInitContactDialog=function(a){this.$wrapper=a.$wrapper;this.$footer=this.$wrapper.find(".js-dialog-footer");this.$form=this.$wrapper.find("form");this.$call_button=this.$form.find(".js-init-call");this.$content=this.$form.find(".js-content");this.$numbers_list=this.$form.find(".js-numbers-list");this.$plugin_id=this.$form.find(".js-plugin-id");this.dialog=this.$wrapper.data("dialog");this.call_id=0;this.call_ready=a.call_ready;this.locales=a.locales;
this.initClass()};CRMCallInitContactDialog.prototype.initClass=function(){"ready"===this.call_ready?this.initCall():(this.selectExtensionNumber(),this.submit())};CRMCallInitContactDialog.prototype.selectExtensionNumber=function(){var a=this;a.$form.on("click",".js-number-item",function(){var b=d(this).data("plugin-id");a.$plugin_id.val(d.crm.escape(b));a.$call_button.prop("disabled",!1)})};CRMCallInitContactDialog.prototype.submit=function(){var a=this;a.$form.on("submit",function(b){b.preventDefault();
if(!a.$plugin_id.val())return a.$numbers_list.addClass("shake animated"),setTimeout(function(){a.$numbers_list.removeClass("shake animated")},500),!1;a.initCall()})};CRMCallInitContactDialog.prototype.initCall=function(){var a=this,b=d('<i class="icon16 loading" style="vertical-align: middle; margin-left: 6px;"></i>'),c=d.crm.app_url+"?module=call&action=initNew",e=a.$form.serializeArray();a.$call_button.prop("disabled",!0);a.$footer.append(b);d.post(c,e).done(function(b){"ok"===b.status?(a.call_id=
b.data.call_id,a.callChecker()):console.error(b)}).fail(function(){a.dialog.close()}).always(function(){a.$call_button.prop("disabled",!1);b.remove()})};CRMCallInitContactDialog.prototype.callChecker=function(){function a(){d.post(d.crm.app_url+"?module=call&action=checkStatus",{id:c},function(a){try{a.errors&&(clearInterval(k),b.$content.html(h),setTimeout(function(){b.dialog.close();d.crm.content.reload()},3E3),console.log(a.errors.message)),"PENDING"===a.data.status_id?b.$content.html(f):"CONNECTED"===
a.data.status_id?b.$content.html(g):(b.$content.html(h),clearInterval(k),setTimeout(function(){b.dialog.close();d.crm.content.reload()},3E3))}catch(m){clearInterval(k),console.log("Error while updating call status"),console.log(m)}})}var b=this,c=b.call_id,e='<input class="button js-close-dialog" type="submit" value="'+b.locales.Close+'">',f='<div class="c-call-pending">'+b.locales.call_pending+'<i class="icon16 loading" style="vertical-align: middle; margin-left: 6px;"></i></div>',g='<div style="color: #00ff00;">'+
b.locales.call_connected+"</div>",h='<div style="color: #5159c3;">'+b.locales.call_finished+"</div>";b.$content.html(f);b.$footer.html(e);a();var k=setInterval(a,2E3)};return CRMCallInitContactDialog}(jQuery);var CRMCallRedirectDialog=function(d){CRMCallRedirectDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$button=this.$form.find(".js-submit");this.$autocomplete=this.$form.find(".js-autocomplete");this.$other_radio=this.$form.find(".js-other-candidate");this.$number=this.$form.find(".js-number");this.initClass()};CRMCallRedirectDialog.prototype.initClass=function(){this.initAutocomplete();this.initSelectCandidate();this.initSubmit()};CRMCallRedirectDialog.prototype.initAutocomplete=
function(){var a=this,b=a.$form.find(".js-candidate"),c=b.find(".js-delete-candidate");a.$autocomplete.autocomplete({source:d.crm.app_url+"?module=autocomplete&type=user&phonecomplete=true",appendTo:a.$wrapper,minLength:0,focus:function(){return!1},select:function(c,d){a.$number.val(d.item.phone);b.find(".js-label").html(d.item.label);a.$autocomplete.css("display","none");b.removeClass("hidden");return!1}}).data("ui-autocomplete")._renderItem=function(a,b){return d('<li class="ui-menu-item-html"><div>'+
b.value+"</div></li>").appendTo(a)};a.$autocomplete.on("focus",function(){d(this).data("uiAutocomplete").search(d(this).val())});c.on("click",function(){a.$number.val("");b.addClass("hidden");a.$autocomplete.val("").removeAttr("style").focus()})};CRMCallRedirectDialog.prototype.initSelectCandidate=function(){var a=this,b=a.$form.find(".js-other-lbl"),c=a.$form.find(".js-candidate"),e=a.$form.find(".js-number-type");a.$form.on("change",":radio[name='redirect[to]']",function(){a.$other_radio.prop("checked")?
(e.val("external"),a.$number.val(""),a.$autocomplete.removeAttr("style").focus(),b.css("display","none")):(e.val("interior"),a.$number.val(d(this).val()),a.$autocomplete.css("display","none"),c.addClass("hidden"),a.$autocomplete.val(""),b.removeAttr("style"));a.$button.prop("disabled",!1)})};CRMCallRedirectDialog.prototype.initSubmit=function(){var a=this,b=a.$form.find(".js-field-name");a.$form.on("submit",function(c){c.preventDefault();var e=a.$wrapper.find(".js-call-id").val(),f=a.$number.val();
d.trim(f)||(f=d.trim(a.$autocomplete.val()));if(!d.trim(f))return b.addClass("shake animated"),setTimeout(function(){b.removeClass("shake animated")},500),!1;(function(){var b=a.$form.find(".js-number-type").val(),c=a.$wrapper.find(".js-dialog-footer"),k=d('<i class="icon16 loading" style="vertical-align: middle; margin-left: 6px;"></i>');a.$button.prop("disabled",!0);c.append(k);d.post(d.crm.app_url+"?module=call&action=redirect",{call_id:e,number_type:b,number:f},function(a){"ok"===a.status&&(k.removeClass("loading").addClass("yes"),
setTimeout(function(){d.crm.content.reload()},2E3))})})()})};return CRMCallRedirectDialog}(jQuery);var CRMMessageDeleteLinkMixin=function(d){CRMMessageDeleteLinkMixin=function(){};CRMMessageDeleteLinkMixin.prototype.initMessageDeleteLink=function(){function a(){var a=d.crm.app_url+"?module=message&action=delete",e={id:b.message.id},f=d('<i class="icon16 loading" style="vertical-align: middle; margin-left: 12px;"></i>');f.appendTo(b.$button.parent());b.$button.attr("disabled",!0);d.post(a,e,function(a){if("ok"===a.status)d.crm.content.reload();else{console.log("Error saving Responsible contact classification: "+
arguments[2],arguments);var c="Error saving Responsible contact classification: "+arguments[2],c=d('<div class="errormsg" />').text(c);b.$errorsPlace.append(c)}},"json").always(function(){b.$button.attr("disabled",!1);f.remove()})}var b=this;b.$wrapper.find(".js-delete-message").on("click",function(){event.preventDefault();d.crm.confirm.show({title:b.locales.delete_message,text:b.locales.delete_message_text,button:b.locales["delete"],onConfirm:a})})};CRMMessageDeleteLinkMixin.mixInFor=function(a){a.prototype=
d.extend(a.prototype,CRMMessageDeleteLinkMixin.prototype);return a};return CRMMessageDeleteLinkMixin}(jQuery);var CRMMessagesPage=function(d){CRMMessagesPage=function(a){this.$wrapper=a.$wrapper;this.dialog=this.$wrapper.data("dialog")||!1;this.locales=a.locales;this.app_url=a.app_url||d&&d.crm&&d.crm.app_url;this.is_dialog=a.is_dialog||!1;this.is_dialog||(this.page=a.page,this.message_ts=a.message_ts);this.settings=a;this.initClass()};CRMMessagesPage.prototype.initClass=function(){d.crm.renderSVG(this.$wrapper);this.initWriteNewMessage();this.initMessageShowBodyLink();this.initMessagesByGroupLink();this.initSwitchLoader();
this.is_dialog||this.page||this.initBackgroundUpdate();new CRMPageMessagesOperations(this.settings)};CRMMessagesPage.prototype.initWriteNewMessage=function(){this.$wrapper.on("click",".js-write-message",function(){d.get("?module=message&action=writeNewDialog",function(a){new CRMDialog({html:a})})})};CRMMessagesPage.prototype.initMessagesByGroupLink=function(){var a=this,b=a.dialog;a.$wrapper.on("click",".js-message-by-group",function(){var c=d(this).parents("tr.c-message-wrapper"),e=c.data("last-message-id");
b&&b.hide();d.get(d(this).data("dialog-url"),function(f){new CRMDialog({html:f,onOpen:function(b,f){a.initMessageReplyBtn(b,f);a.initMessageForwardBtn(b,f);b.on("click",".c-message-wrapper a",function(a){a.preventDefault()});b.on("click",".c-message-wrapper",function(a){a.preventDefault();var b=d(a.target);a=d(this);var f=a.data("id"),b=b.attr("href");e==f&&c.removeClass("bold");b||(a=a.find(".js-message-show-body"),a.length&&a.trigger("click"))})},onClose:function(){b&&b.show()}})})})};CRMMessagesPage.prototype.initMessageShowBodyLink=
function(){var a=this,b=a.dialog;a.$wrapper.find(".js-message-show-body").on("click","td:not(.c-checkbox)",function(){var c=d(this).parent();d.get(c.data("dialog-url"),function(d){b&&b.hide();new CRMDialog({html:d,onOpen:function(b,d){c.removeClass("bold");a.initMessageReplyBtn(b,d);a.initMessageForwardBtn(b,d)},onClose:function(){b&&b.show()}})})})};CRMMessagesPage.prototype.initMessageReplyBtn=function(a,b){var c=this,e=a.find(".js-dialog-footer"),f=d('<i class="icon16 loading" style="vertical-align: middle; margin-left: 6px;"></i>');
a.on("click",".js-message-reply",function(){var a=d(this).data("message-id");e.append(f);d.post(c.app_url+"?module=message&action=writeReplyDialog",{id:a},function(a){b.hide();new CRMDialog({html:a,onOpen:function(){f.remove()},onClose:function(){f.remove();b.show()}})})})};CRMMessagesPage.prototype.initMessageForwardBtn=function(a,b){var c=this,e=a.find(".js-dialog-footer"),f=d('<i class="icon16 loading" style="vertical-align: middle; margin-left: 6px;"></i>');a.on("click",".js-message-forward",
function(){var a=d(this).data("message-id");e.append(f);d.post(c.app_url+"?module=message&action=writeForwardDialog",{id:a},function(a){b.hide();new CRMDialog({html:a,onOpen:function(){f.remove()},onClose:function(){b.show()}})})})};CRMMessagesPage.prototype.initSwitchLoader=function(){this.$wrapper.on("click",".js-switch-message-view",function(){d(this).find(".icon16").attr("class","icon16 loading")})};CRMMessagesPage.prototype.initBackgroundUpdate=function(){function a(){f||(f=!0,d.contains(document,
c.$wrapper[0])&&d.post("?module=message&action=ts",{message_ts:e},function(f){"ok"===f.status&&(f=f.data!==e,d.contains(document,c.$wrapper[0])&&(f&&!d(".crm-dialog-wrapper:visible").length?b():(clearTimeout(g),g=setTimeout(a,12E4))))},"json").always(function(){f=!1}))}function b(){d.get(d.crm.app_url+"message/?view=all&reload=1",function(a){d.crm.content.$content.html(a)})}var c=this,e=c.message_ts,f=!1,g=0;clearTimeout(g);g=setTimeout(a,12E4)};return CRMMessagesPage}(jQuery),CRMDealMessagesDialog=
function(d){CRMDealMessagesDialog=function(a){this.$wrapper=a.$wrapper;this.initClass()};CRMDealMessagesDialog.prototype.initClass=function(){this.$wrapper.on("click",".c-message-wrapper a",function(a){a.preventDefault()});this.$wrapper.on("click",".c-message-wrapper",function(a){a.preventDefault();a=d(a.target);var b=d(this);a.attr("href")||(a=b.find(".js-message-show-body"),a.length&&a.trigger("click"))})};return CRMDealMessagesDialog}(jQuery),CRMMessageBodyDialog=function(d){CRMMessageBodyDialog=
function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".js-close-dialog");this.contact_id=a.contact_id;this.message=a.message||{};this.locales=a.locales;this.initClass()};CRMMessageBodyDialog.prototype.initClass=function(){this.initSelectDeal();this.initMessageDeleteLink()};CRMMessageBodyDialog.prototype.initSelectDeal=function(){function a(){p.html("<b><i>"+c.locales.deal_empty+"</i></b>");u.val("none");g.val("");f.addClass("c-deal-name-hidden");h.addClass("hidden").removeAttr("title");
m.addClass("c-empty-deal-hidden");n.addClass("hidden");r.find("li").removeClass("selected");k.removeClass("hidden")}function b(){var b=c.$wrapper.find(".js-created-deal"),h=q.find(".js-visible-link .js-text .funnel-state").clone(),l=d.trim(g.val()),m=e.serializeObject();m.message_id=c.message.id;if("none"===u.val())return e.addClass("shake animated"),setTimeout(function(){e.removeClass("shake animated")},500),!1;if(0>=u.val()&&!l)return f.addClass("shake animated"),setTimeout(function(){f.removeClass("shake animated");
g.focus()},500),!1;e.addClass("deal-form-hidden");b.removeClass("hidden");0>=u.val()||(l=k.find(".js-visible-link .js-text"),h=l.find(".funnel-state").clone(),l=l.find("b i").text());b.html(h);b.append(d.crm.escape(l));d.post(d.crm.app_url+"?module=message&action=associateDealSave",m,function(c){if("ok"===c.status&&c.data.deal_url){var d=b.html();b.html('<a href="'+c.data.deal_url+'">'+d+"</a>")}else b.html(""),b.addClass("hidden"),a(),e.removeClass("deal-form-hidden")})}var c=this,e=c.$wrapper.find(".deal-form"),
f=e.find(".js-deal-name"),g=e.find(".js-deal-name-input"),h=e.find(".js-save-deal"),k=e.find(".js-deals-dropdown"),l=e.find(".js-remove-deal"),m=k.find(".js-empty-deal"),p=e.find(".js-select-deal .js-visible-link .js-text"),n=e.find(".js-select-funnel-wrapper"),q=e.find(".js-select-stage-wrapper"),r=e.find(".js-deals-list"),u=e.find(".js-deal-id"),t=c.contact_id;u.val("none");t&&d.get("?module=deal&action=byContact&id="+t,function(a){"ok"===a.status&&(d.each(a.data.deals,function(b,c){r.prepend('<li><a href="javascript:void(0);" class="js-deal-item" data-deal-id="'+
c.id+'"><span class="js-text"><i class="icon16 funnel-state svg-icon" data-color="'+a.data.funnels[c.funnel_id].stages[c.stage_id].color+'"></i><b><i>'+c.name+"</i></b></span></a></li>")}),d.crm.renderSVG(c.$wrapper))},"json");e.on("click",".js-create-new-deal",function(){u.val("0");k.addClass("hidden");f.removeClass("c-deal-name-hidden");h.attr("title",c.locales.deal_create).removeClass("hidden");n.removeClass("hidden");m.removeClass("c-empty-deal-hidden");g.focus()});e.on("click",".js-deal-item",
function(){var a=d(this).find(".js-text").html();p.html(a);u.val(d(this).data("deal-id"));h.attr("title",c.locales.deal_add).removeClass("hidden");n.addClass("hidden");m.removeClass("c-empty-deal-hidden");r.find("li").removeClass("selected");d(this).parent().addClass("selected")});r.on("click",function(){r.hide();setTimeout(function(){r.removeAttr("style")},200)});m.on("click",function(){a()});l.on("click",function(){a()});h.on("click",function(a){a.preventDefault();e.trigger("submit")});e.on("submit",
function(a){a.preventDefault();b()});e.on("change",".js-select-deal-funnel",function(){e.find(".js-select-stage-wrapper").load("?module=deal&action=stagesByFunnel&id="+d(this).val())})};CRMMessageDeleteLinkMixin.mixInFor(CRMMessageBodyDialog);return CRMMessageBodyDialog}(jQuery),CRMMessagesListPage=function(d){CRMMessagesListPage=function(a){this.$wrapper=a.$wrapper;this.page=a.page;this.last_message_id=a.last_message_id;this.settings=a;this.initClass()};CRMMessagesListPage.prototype.initClass=function(){d.crm.renderSVG(this.$wrapper);
this.$wrapper.on("click",".js-associate-deal",function(a){a.preventDefault();a=d(this).data("dialog-url");d.get(a,function(a){new CRMDialog({html:a})})});this.$wrapper.on("click",".js-write-message",function(a){a.preventDefault();d.get(d.crm.app_url+"?module=message&action=writeNewDialog",function(a){new CRMDialog({html:a})})});this.$wrapper.on("click",".js-switch-message-view",function(){d(this).find(".icon16").attr("class","icon16 loading")});this.page||this.initBackgroundUpdate();new CRMPageMessagesOperations(this.settings)};
CRMMessagesListPage.prototype.initBackgroundUpdate=function(){function a(){f||(f=!0,d.contains(document,c.$wrapper[0])&&d.post("?module=message&action=listByConversation",{check:1},function(f){"ok"===f.status&&(f=f.data!==e,d.contains(document,c.$wrapper[0])&&(f&&!d(".crm-dialog-wrapper:visible").length?b():(clearTimeout(g),g=setTimeout(a,12E4))))},"json").always(function(){f=!1}))}function b(){d.get(d.crm.app_url+"message/?view=conversation&reload=1",function(a){d.crm.content.$content.html(a)})}
var c=this,e=c.last_message_id,f=!1,g=0;clearTimeout(g);g=setTimeout(a,12E4)};return CRMMessagesListPage}(jQuery);var CRMMessageConversationPage=function(d){CRMMessageConversationPage=function(a){this.$wrapper=a.$wrapper;this.locales=a.locales;this.conversation_id=a.conversation_id;this.contact_id=a.contact_id;this.funnel_id=a.funnel_id;this.last_message_id=a.last_message_id;this.check_interval=a.check_interval;this.initClass()};CRMMessageConversationPage.prototype.initClass=function(){d.crm.renderSVG(this.$wrapper);this.$wrapper.find(".js-deal-link").length||this.initSelectDeal();this.initDealActions();this.initChangeResponsible();
this.initBackgroundActions();this.initMessageActions();this.initDelete();this.scroll2bottom();this.initStickiesAtSection();this.initSendEmail()};CRMMessageConversationPage.prototype.loadDealListByContact=function(a){a=a||function(){};var b=this.contact_id;0>=b?a({}):d.get("?module=deal&action=byContact&id="+b,"json").always(function(b){b&&"ok"===b.status?a(b.data||{}):a({})})};CRMMessageConversationPage.prototype.initSelectDeal=function(a){function b(a,b){if(!a||0>=a.id)return"";var c=a.id,e=a.name||
"",g="",h="";b&&b.stages&&b.stages[a.stage_id]&&(g=b.stages[a.stage_id].color||"");d.isEmptyObject(b)&&(h='<span class="hint">'+f.locales.funnel_deleted+"</span>");return'<li><a href="javascript:void(0);" class="js-deal-item" data-deal-id="'+c+'"><span class="js-text"><i class="icon16 funnel-state svg-icon" data-color="'+g+'"></i><b><i>'+e+"</i></b></span>"+h+"</a></li>"}function c(){A.html("<b><i>"+f.locales.deal_empty+"</i></b>");y.val("none");p.val("");m.addClass("c-deal-name-hidden");n.addClass("hidden").removeAttr("title");
t.addClass("c-empty-deal-hidden");v.addClass("hidden");w.find("li").removeClass("selected");0<q.data("deals_count")?(q.removeClass("hidden"),r.addClass("hidden")):(q.addClass("hidden"),r.removeClass("hidden"))}function e(){var a=g.find(".js-created-deal"),b=x.find(".js-visible-link .js-text .funnel-state").clone(),e=d.trim(p.val()),h=l.serializeObject();h.conversation_id=f.conversation_id;if("none"===y.val())return l.addClass("shake animated"),setTimeout(function(){l.removeClass("shake animated")},
500),!1;if(0>=y.val()&&!e)return m.addClass("shake animated"),setTimeout(function(){m.removeClass("shake animated");p.focus()},500),!1;l.addClass("deal-form-hidden");a.removeClass("hidden");0>=y.val()||(e=q.find(".js-visible-link .js-text"),b=e.find(".funnel-state").clone(),e=e.find("b i").text());a.html(b);a.append(d.crm.escape(e));d.post(d.crm.app_url+"?module=message&action=conversationAssociateDealSave",h,function(b){"ok"===b.status?d.crm.content.reload():(a.html(""),a.addClass("hidden"),c(),
l.removeClass("deal-form-hidden"))})}var f=this;a=a||{};var g=a.$wrapper||f.$wrapper,h=function(a){a=a||{};var c=a.funnels||{},e=0;d.each(a.deals||{},function(a,d){w.prepend(b(d,c[d.funnel_id]));e++});k.show();q.data("deals_count",e);0<e?(q.removeClass("hidden"),r.addClass("hidden")):(r.removeClass("hidden"),q.addClass("hidden"));d.crm.renderSVG(g)},k=g.find(".js-deal-selector-control-wrapper"),l=k.find(".deal-form"),m=l.find(".js-deal-name"),p=l.find(".js-deal-name-input"),n=l.find(".js-save-deal"),
q=l.find(".js-deals-dropdown"),r=l.find(".js-create-new-deal-link"),u=l.find(".js-remove-deal"),t=q.find(".js-empty-deal"),A=l.find(".js-select-deal .js-visible-link .js-text"),v=l.find(".js-select-funnel-wrapper"),x=l.find(".js-select-stage-wrapper"),w=l.find(".js-deals-list"),y=l.find(".js-deal-id");y.val("none");"undefined"===typeof a.data?f.loadDealListByContact(h):h(a.data);l.on("click",".js-create-new-deal",function(){y.val("0");q.addClass("hidden");r.addClass("hidden");m.removeClass("c-deal-name-hidden");
n.attr("title",f.locales.deal_create).removeClass("hidden");v.removeClass("hidden");t.removeClass("c-empty-deal-hidden");p.focus()});l.on("click",".js-deal-item",function(){var a=d(this).find(".js-text").html();A.html(a);y.val(d(this).data("deal-id"));n.attr("title",f.locales.deal_add).removeClass("hidden");v.addClass("hidden");t.removeClass("c-empty-deal-hidden");w.find("li").removeClass("selected");d(this).parent().addClass("selected")});w.on("click",function(){w.hide();setTimeout(function(){w.removeAttr("style")},
200)});t.on("click",function(){c()});u.on("click",function(){c()});n.on("click",function(a){a.preventDefault();l.trigger("submit")});l.on("submit",function(a){a.preventDefault();e()});l.on("change",".js-select-deal-funnel",function(){l.find(".js-select-stage-wrapper").load("?module=deal&action=stagesByFunnel&id="+d(this).val())});return{submit:function(){l.trigger("submit")}}};CRMMessageConversationPage.prototype.initDealActions=function(){var a=this,b=a.$wrapper.find(".js-conversation-deal");b.on("click",
".js-attach-other-deal",function(b){b.preventDefault();a.loadDealListByContact(function(b){d.get(d.crm.app_url+"?module=messageConversationDeal&action=attachDialog",{id:a.conversation_id},function(c){var e=d(c);new CRMDialog({html:e,onOpen:function(){var c=e.find(".js-conversation-deal"),d=a.initSelectDeal({$wrapper:c,data:b});e.find(".js-save-button").on("click",function(){d.submit()})}})})})});var c=null;b.on("click",".js-detach-deal",function(e){e.preventDefault();e=b.find(".js-deal-link").text();
d.crm.confirm.show({title:a.locales.deal_detach_title,text:a.locales.deal_detach_text.replace(/%s/,e),button:a.locales.deal_detach_confirm_button,onConfirm:function(){c&&c.abort();a.loadDealListByContact(function(e){c=d.post(d.crm.app_url+"?module=messageConversationDeal&action=detach",{id:a.conversation_id}).done(function(c){c&&"ok"===c.status&&(b.html(c.data&&c.data.html),a.initSelectDeal({data:e}))}).always(function(){c=null})})}})})};CRMMessageConversationPage.prototype.initStickiesAtSection=
function(){var a=this,b=function(a){b=function(b){this.$window=a(window);this.$wrapper=b.$wrapper;this.$section=b.$section;this.$wrapperContainer=this.$wrapper.parent();this.type=b.type||"bottom";this.offset={};this.is_fixed=this.$clone=!1;this.initClass()};b.prototype.initClass=function(){function b(){if(a.contains(d[0].document,c.$wrapper[0]))c.onScroll(d.scrollTop());else d.off("scroll",b)}var c=this,d=c.$window,e=0;d.on("resize",function(){clearTimeout(e);e=setTimeout(function(){c.resize()},100)});
d.on("scroll",b);c.$wrapper.on("resize",function(){c.resize()});c.init();c.$wrapper.data("block",c)};b.prototype.init=function(){if(!this.$clone){var b=a("<div />");this.$wrapperContainer.append(b);this.$clone=b}this.$clone.hide();b=this.$wrapper.offset();this.offset={left:b.left,top:b.top,width:this.$wrapper.outerWidth(),height:this.$wrapper.outerHeight()}};b.prototype.resize=function(){switch(this.type){case "top":this.fix2top(!1);break;case "bottom":this.fix2bottom(!1)}var a=this.$wrapper.offset();
this.offset={left:a.left,top:a.top,width:this.$wrapper.outerWidth(),height:this.$wrapper.outerHeight()};this.$window.trigger("scroll")};b.prototype.onScroll=function(a){this.$window.width();var b=this.$window.height();this.offset.top=this.$wrapperContainer.offset().top;switch(this.type){case "top":b=this.$section?a+this.offset.height<this.$section.height()+this.$section.offset().top:!0;this.fix2top(this.offset.top<a&&b);break;case "bottom":this.fix2bottom(this.offset.top&&a+b<this.offset.top+this.offset.height)}};
b.prototype.fix2top=function(a){a?(this.$wrapper.css({left:this.offset.left,width:this.offset.width}).addClass("is-top-fixed"),this.$clone.css({height:this.offset.height}).show()):(this.$wrapper.removeClass("is-top-fixed").removeAttr("style"),this.$clone.removeAttr("style").hide());this.is_fixed=!!a};b.prototype.fix2bottom=function(a){a?(this.$wrapper.css({left:this.offset.left,width:this.offset.width}).addClass("is-bottom-fixed"),this.$clone.css({height:this.offset.height}).show()):(this.$wrapper.removeClass("is-bottom-fixed").removeAttr("style"),
this.$clone.removeAttr("style").hide());this.is_fixed=!!a};return b}(jQuery),c=a.$wrapper.find(".js-reply-wrapper"),e=a.$wrapper.find(".js-conversation-header");(function(){function a(a){a?c.addClass("is-extended").trigger("resize"):h||c.removeClass("is-extended").trigger("resize")}var e=c.find(".js-textarea"),h=!1;e.on("focus",function(){a(!0);d(document).trigger("unmark-new-messages")});e.on("blur",function(){a(!1)});e.on("change paste keyup",function(){var a=d(this).val();h=0<d.trim(a).length});
new b({$wrapper:c,type:"bottom"})})();new b({$wrapper:e,type:"top"});(function(){var b=d('<div class="\u0441-scroll-action to-top to-right"><div class="c-icon to-top"></div></div>'),g=d('<div class="\u0441-scroll-action to-bottom to-right"><div class="c-icon to-bottom"></div></div>');b.appendTo(e);g.appendTo(c);b.on("click",function(){d("html, body").animate({scrollTop:0},500)});g.on("click",function(){a.scroll2bottom(!0,!0)})})()};CRMMessageConversationPage.prototype.initChangeResponsible=function(){function a(a){var c=
"?module=autocomplete&type=user",c=0<e.funnel_id?c+("&funnel_id="+e.funnel_id):c+("&contact_id="+e.contact_id);a.autocomplete({appendTo:a.parent(),source:c,minLength:0,html:!0,focus:function(){return!1},select:function(c,d){b(d.item.id);a.val("");return!1}}).data("ui-autocomplete")._renderItem=function(a,b){var c=d("<li />");c.addClass("ui-menu-item-html").append("<div>"+b.value+"</div>").appendTo(a);b.rights||(c.addClass("is-locked"),c.on("click",function(a){a.preventDefault();a.stopPropagation()}));
return c};a.on("focus",function(){a.data("uiAutocomplete").search(a.val())})}function b(b){f||(f=!0,d.post("?module=message&action=changeConversationUser",{action:"set",id:e.conversation_id,user_contact_id:b},function(b){"ok"===b.status&&(b=d(b.data.html),g.html(b),k.addClass("hidden"),b=g.find(".js-owner-autocomplete"),b.length&&a(b))},"json").always(function(){f=!1}))}function c(){f||(f=!0,d.post("?module=message&action=changeConversationUser",{action:"remove",id:e.conversation_id},function(a){"ok"===
a.status&&(g.html(""),k.removeClass("hidden"),f=!1)},"json").always(function(){f=!1}))}var e=this,f=!1,g=e.$wrapper.find(".js-responsible-wrapper"),h=g.find(".js-owner-autocomplete"),k=e.$wrapper.find(".js-responsible-empty-wrapper"),l=k.find(".js-responsible-empty-autocomplete");g.length&&l.length&&a(l);h.length&&a(h);k.on("click",".js-set-extended, .js-unset-extended",function(){k.toggleClass("is-extended");k.hasClass("is-extended")&&l.focus()});g.on("click",".js-show-combobox",function(){g.find(".c-conversation-member").addClass("is-edit");
g.find(".js-owner-autocomplete").focus()});g.on("click",".js-hide-combobox",function(){g.find(".c-conversation-member").removeClass("is-edit")});g.on("click",".js-remove-owner",function(a){a.preventDefault();a=d.trim(g.find(".c-name").html());d.crm.confirm.show({title:e.locales.remove_owner_title,text:e.locales.remove_owner_text.replace(/%s/,a),button:e.locales.remove_owner_button,onConfirm:function(){c()}})})};CRMMessageConversationPage.prototype.initBackgroundActions=function(){function a(){clearTimeout(g);
g=setTimeout(b,e.check_interval)}function b(){f||(f=!0,d.post("?module=message&action=conversationIdCheck",{id:e.conversation_id},function(b){"ok"===b.status&&(b.data!==e.last_message_id?c().then(function(b){b.length&&e.scroll2bottom(!0,!0);a()}):a())},"json").always(function(){f=!1}))}function c(){var a=d.Deferred();d.get(location.href,function(b){function c(a){function b(){a.removeClass("is-new");a.off("hover",b);c.off("unmark-new-messages",b)}var c=d(document);a.addClass("is-new");a.on("hover",
b);c.on("unmark-new-messages",b);setTimeout(function(){d.contains(document,a[0])&&b()},1E4)}var f=e.last_message_id,g=e.$wrapper.find(".js-messages-list").first();b=d(b).find(".js-messages-list .js-message-wrapper");var h=[];g.length&&(b.each(function(){var a=d(this),b=a.data("id");b>e.last_message_id&&(g.append(a),c(a),h.push({id:b,$message:a}),f=b)}),e.last_message_id=f);a.resolve(h)});return a.promise()}var e=this,f=!1,g=0;a()};CRMMessageConversationPage.prototype.initMessageActions=function(){function a(a){function b(a){if(!c.length)return!1;
a?c.removeClass("rotate-left").addClass("loading"):c.removeClass("loading").addClass("rotate-left")}var c=a.find(".icon16");a=a.closest(".js-message-wrapper").data("id");b(!0);d.post(d.crm.app_url+"?module=message&action=writeReplyDialog",{id:a},function(a){new CRMDialog({html:a})}).always(function(){b(!1)})}function b(a){function b(a){if(!c.length)return!1;a?c.removeClass("rotate-right").addClass("loading"):c.removeClass("loading").addClass("rotate-right")}var c=a.find(".icon16");a=a.closest(".js-message-wrapper").data("id");
b(!0);d.post(d.crm.app_url+"?module=message&action=writeForwardDialog",{id:a},function(a){new CRMDialog({html:a})}).always(function(){b(!1)})}this.$wrapper.on("click",".js-message-reply",function(b){b.preventDefault();a(d(this))});this.$wrapper.on("click",".js-message-forward",function(a){a.preventDefault();b(d(this))})};CRMMessageConversationPage.prototype.initDelete=function(){function a(){c=!0;d.post(d.crm.app_url+"?module=message&action=conversationIdDelete",{id:b.conversation_id},function(a){"ok"===
a.status&&d.crm.content.load(d.crm.app_url+"message/")}).always(function(){c=!1},"json")}var b=this,c=!1;b.$wrapper.on("click",".js-delete-conversation",function(e){e.preventDefault();c||d.crm.confirm.show({title:b.locales.delete_conversation_title,button:b.locales.delete_conversation_button,onConfirm:a})})};CRMMessageConversationPage.prototype.initSendEmail=function(){var a=!1;this.$wrapper.on("click",".js-show-message-dialog",function(b){b.preventDefault();var c=d(this);b=c.data("id");c=c.data("email");
!a&&b&&(a=!0,d.post("?module=message&action=writeNewDialog",{contact_id:b,email:c},function(a){new CRMDialog({html:a})}).always(function(){a=!1}))})};CRMMessageConversationPage.prototype.scroll2bottom=function(a,b){function c(){setTimeout(function(){d.contains(document,f.$wrapper[0])&&k&&e()},10)}function e(){var a=d(document).height();h<a&&(b?d("html, body").animate({scrollTop:a-h},500):g.scrollTop(a))}var f=this,g=d(window),h=g.height(),k=!0;if(a)e();else if(d.crm.is_page_loaded)c();else g.one("scroll",
function(){k=!1}).one("load",c)};return CRMMessageConversationPage}(jQuery),CRMEmailConversationEmailSender=function(d){CRMEmailConversationEmailSender=function(a){this.$wrapper=a.$wrapper;this.$replySection=this.$wrapper.closest(".js-reply-wrapper");this.$form=this.$wrapper.find("form");this.$textarea=this.$wrapper.find(".js-wysiwyg");this.$sender_email_select=this.$wrapper.find(".js-sender-email-select");this.$sender_email=this.$wrapper.find(".js-sender-email");this.file_template_html=a.file_template_html;
this.max_upload_size=a.max_upload_size;this.locales=a.locales;this.hash=a.hash;this.send_action_url=a.send_action_url;this.body=a.body||"";this.deal_id=a.deal_id;this.is_changed=!1;if(!this.send_action_url)throw Error("send_action_url option required");this.initClass();this.filesController=this.getFilesController()};CRMEmailConversationEmailSender.prototype.initClass=function(){this.senderEmailSelect();this.initWYSIWYG();this.initVisiblityWatcher();this.initSave();this.initPersonalSettingsDialog();
this.initEmailCopy()};CRMEmailConversationEmailSender.prototype.initVisiblityWatcher=function(){function a(a){a?b.addClass("is-extended").trigger("resize"):b.removeClass("is-extended").trigger("resize")}var b=this.$replySection;b.find(".js-visible-textarea").on("focus",function(){a(!0)});b.on("click",".js-revert",function(){a(!1)})};CRMEmailConversationEmailSender.prototype.senderEmailSelect=function(){var a=this;a.$wrapper.on("change",a.$sender_email_select,function(b){b.preventDefault();a.$sender_email.val(a.$sender_email_select.val())})};
CRMEmailConversationEmailSender.prototype.getFilesController=function(){function a(a){a.length&&d.each(a,function(a,c){n.push({$file:b(c),file:c})})}function b(a){var b=d(m);b.find(".js-name").text(a.name);l.prepend(b);return b}function c(a){var b=[];d.each(n,function(c,d){a[0]!==d.$file[0]?b.push(d):a.remove()});n=b}var e=this,f=e.$wrapper.find(".js-files-wrapper");if(!f.length)return!1;var g=f.find(".js-drop-area"),h=f.find(".js-drop-text"),k=f.find(".js-drop-field"),l=f.find(".c-upload-list"),
m=e.file_template_html,p=d.crm.app_url+"?module=file&action=uploadTmp",n=[],q=0,r=0;k.on("change",function(b){b.preventDefault();a(this.files)});g.on("drop",function(b){b.preventDefault();a(b.originalEvent.dataTransfer.files)});g.on("dragover",function(a){a.preventDefault();g.addClass("is-hover");h.text(h.data("hover"));clearTimeout(r);r=setTimeout(function(){g.removeClass("is-hover");h.text(h.data("default"))},100)});f.on("click",".js-file-delete",function(a){a.preventDefault();c(d(this).closest(".c-upload-item"))});
return{uploadFiles:function(a,b){function c(b){function c(){var c=new FormData,e=document.cookie.match(/(?:^|; )_csrf=([^;]*)/);(e=e?decodeURIComponent(e[1]):"")&&c.append("_csrf",e);a&&a.length&&d.each(a,function(a,b){b.name&&b.value&&c.append(b.name,b.value)});c.append("file_size",b.file.size);c.append("files",b.file);c.append("file_end",1);d.ajax({xhr:function(){var a=new window.XMLHttpRequest;a.upload.addEventListener("progress",function(a){if(a.lengthComputable){a=parseInt(a.loaded/a.total*100);
var b;b=[247,198,174];for(var c=[174,247,196],d=[],e=0;e<b.length;e++)d.push(b[e]+(c[e]-b[e])/100*a);b="rgb("+d.join(",")+")";h.css("background-color",b).width(a+"%");k.text(a+"%")}},!1);return a},url:p,data:c,cache:!1,contentType:!1,processData:!1,type:"POST",success:function(a){k.text(k.data("success"));setTimeout(function(){d.contains(document,g[0])&&(g.remove(),--q,0>=q&&f())},2E3)}}).always(function(){})}var g=b.$file,h=g.find(".js-bar"),k=g.find(".js-status");g.addClass("is-upload");e.max_upload_size>
b.file.size?c():(k.addClass("errormsg").text(e.locales.file_size),g.find(".c-progress-wrapper").remove(),setTimeout(function(){d.contains(document,g[0])&&(g.remove(),--q,0>=q&&f())},2E3))}var f=b?b:function(){};n.length?(q=n.length,d.each(n,function(a,b){c(b)})):f()}}};CRMEmailConversationEmailSender.prototype.initWYSIWYG=function(){var a=this,b=a.$textarea;d.crm.initWYSIWYG(b,{maxHeight:150,allowedAttr:[["section","data-role"]],callbacks:{change:function(){a.is_changed=!0}}});a.body&&b.redactor("code.set",
a.body)};CRMEmailConversationEmailSender.prototype.initSave=function(){var a=this,b=!1;a.$form.on("submit",function(e){e.preventDefault();if(!b){b=!0;e=a.$form.find(".js-submit-button");var f=d('<i class="icon16 loading" style="vertical-align: baseline; margin: 0 4px; position: relative; top: 3px;"></i>');e.removeClass("blue").attr("disabled",!0);f.insertBefore(e);a.filesController.uploadFiles([{name:"hash",value:a.hash}],c)}});var c=function(){var c=a.send_action_url,f=a.$form.serializeArray();d.post(c,
f,function(a){"ok"===a.status?d.crm.content.reload():alert("error")},"json").always(function(){b=!1})}};CRMEmailConversationEmailSender.prototype.initPersonalSettingsDialog=function(){function a(){c||(c=!0,d.post(d.crm.app_url+"?module=email&action=personalSettingsDialog",{},function(a){new CRMDialog({html:a,options:{onSave:function(a){b.$textarea.redactor("core.editor").find('[data-role="c-email-signature"]').html(a.email_signature||"");b.$wrapper.find(".js-sender-name").text(a.sender_name||"")}}})}).always(function(){c=
!1}))}var b=this,c=!1;b.$wrapper.on("click",".js-show-personal-settings-dialog",function(b){b.preventDefault();a()})};CRMEmailConversationEmailSender.prototype.initEmailCopy=function(){function a(){var a=d.trim(l.val()).split(/[,:;]/);if(a[0].length)return d.each(a,function(a,e){var f=d.trim(e).split(/\s+/),g=!1,h=e=null;d.each(f,function(a,b){d.crm.check.email(b)&&!g&&(e=b.replace(/\<|\>/g,""),g=a)});!1!==g&&f.splice(g,1);h=f.join(" ");e&&h&&c(0,e,h);e&&!h&&b(0,e,e);h&&!e&&(l.addClass("shake animated"),
setTimeout(function(){l.removeClass("shake animated")},500));g=!1;h=e=null}),!1}function b(a,b,c){k.children('[data-email="'+b+'"]').length&&"0"!==a||!b.length||(e.$wrapper.find(".email-copy-input-div").before('<div class="email-copy-user" title="'+d.crm.escape(b)+'" data-contact-id="'+d.crm.escape(a)+'" data-email="'+d.crm.escape(b)+'">'+c+' <a title="'+e.locales.remove_form_cc+'" class="remove-cc js-remove-cc">x</a> <input name="cc['+d.crm.escape(b)+'][email]" type="hidden" value="'+d.crm.escape(b)+
'" /><input name="cc['+d.crm.escape(b)+'][id]" type="hidden" value="'+d.crm.escape(a)+'" /></div>'),e.$wrapper.find(".email-copy-text-collapsed").append('<div class="email-copy-user" title="'+d.crm.escape(b)+'" data-email="'+d.crm.escape(b)+'">'+c+"</div>"));l.val("").focus()}function c(a,b,c){k.children('[data-email="'+b+'"]').length&&"0"!==a||!b.length||(e.$wrapper.find(".email-copy-input-div").before('<div class="email-copy-user" title="'+d.crm.escape(b)+'" data-contact-id="'+a+'" data-email="'+
d.crm.escape(b)+'">'+d.crm.escape(c)+' <a title="'+e.locales.remove_form_cc+'" class="remove-cc js-remove-cc">x</a> <input name="cc['+d.crm.escape(b)+'][email]" type="hidden" value="'+d.crm.escape(b)+'" /><input name="cc['+d.crm.escape(b)+'][id]" type="hidden" value="'+d.crm.escape(a)+'" /><input name="cc['+d.crm.escape(b)+'][name]" type="hidden" value="'+d.crm.escape(c)+'" /></div>'),e.$wrapper.find(".email-copy-text-collapsed").append('<div class="email-copy-user" title="'+d.crm.escape(b)+'" data-email="'+
d.crm.escape(b)+'">'+d.crm.escape(c)+"</div>"));l.val("").focus()}var e=this,f=e.$wrapper.find(".email-copy-wrapper"),g=e.$wrapper.find(".js-email-copy-link-icon"),h=f.find(".email-copy-area"),k=h.find(".email-copy-text"),l=h.find(".email-copy-input"),m=f.find(".deal-participants-area"),p=e.$wrapper.find(".email-copy-wrapper-collapsed");l.autocomplete({source:d.crm.app_url+"?module=autocomplete&emailcomplete=true",appendTo:e.$wrapper,minLength:0,focus:function(){return!1},select:function(a,c){b(c.item.id,
c.item.email,'<i class="icon16 userpic20" style="background-image: url('+c.item.photo_url+');"></i><b>'+c.item.name+"</b>");l.val("");return!1}}).data("ui-autocomplete")._renderItem=function(a,b){return d('<li class="ui-menu-item-html"><div>'+b.value+"</div></li>").appendTo(a)};l.on("focus",function(){l.data("uiAutocomplete").search(l.val())});e.$wrapper.on("click",".js-email-copy-link, .email-copy-text-collapsed",function(a){a.preventDefault();f.toggleClass("email-copy-wrapper-block");f.is(":visible")?
(g.removeClass("rarr").addClass("darr"),l.focus(),p.removeClass("email-copy-wrapper-collapsed-block")):(g.removeClass("darr").addClass("rarr"),e.$wrapper.find(".email-copy-text-collapsed").children().length&&p.addClass("email-copy-wrapper-collapsed-block"));e.$wrapper.closest(".js-reply-wrapper").trigger("resize")});h.on("click",function(){l.focus()});m.on("click",".email-copy-user",function(){var a=d(this).data("cc-contact-id"),c=d(this).data("cc-email"),e=d(this).html();b(a,c,e)});l.on("focusout",
function(b){a()});l.on("keydown",function(b){13==b.keyCode&&(b.preventDefault(),a())});k.on("click",".js-remove-cc",function(a){a.preventDefault();a=d(this).parent(".email-copy-user");var b=a.data("email");a.remove();e.$wrapper.find(".email-copy-text-collapsed").children('[data-email="'+b+'"]').remove()});l.on("keydown",function(a){if(8==a.keyCode&&0==l.val().length){a=e.$wrapper.find(".email-copy-text .email-copy-user:last");var b=a.data("email");a.remove();e.$wrapper.find(".email-copy-text-collapsed").children('[data-email="'+
b+'"]').remove();l.focus()}})};return CRMEmailConversationEmailSender}(jQuery),CRMImConversationSection=function(d){CRMImConversationSection=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$textarea=this.$form.find(".js-textarea");this.send_action_url=a.send_action_url;this.initClass()};CRMImConversationSection.prototype.initClass=function(){this.initSubmit()};CRMImConversationSection.prototype.initSubmit=function(){function a(){e.css("min-height",0);var a=e[0].scrollHeight;
152<a&&(a=152);e.css("min-height",a+2+"px");b.$wrapper.trigger("resize")}var b=this,c=!1,e=b.$textarea;e.on("keydown",function(a){13!==a.keyCode&&10!==a.keyCode||a.ctrlKey||a.metaKey||a.shiftKey||(a.preventDefault(),b.$form.submit())});e.on("keyup",function(b){var c=8===b.keyCode,d=46===b.keyCode;13!==b.keyCode&&10!==b.keyCode||!(b.ctrlKey||b.metaKey||b.shiftKey)?c||d?a():e[0].scrollHeight>e.outerHeight()&&a():(b.shiftKey||(c=e.val(),d=e.prop("selectionStart"),b=c.slice(0,d),c=c.slice(d),e.val(b+
"\n"+c)),a())});b.$form.on("submit",function(a){a.preventDefault();if(!c){c=!0;a=b.send_action_url;var f=b.$form.serializeArray();d.post(a,f,function(a){"ok"===a.status?d.crm.content.reload():(e.addClass("shake animated").focus(),setTimeout(function(){e.removeClass("shake animated").focus()},500),c=!1)}).always(function(){c=!1})}})};return CRMImConversationSection}(jQuery),CRMConversationAssociateDealDialog=function(d){CRMConversationAssociateDealDialog=function(a){this.$wrapper=a.$wrapper;this.$form=
this.$wrapper.find("form");this.$footer=this.$wrapper.find(".js-dialog-footer");this.$submit=this.$form.find(".js-submit");this.$deal_name=this.$form.find(".js-deal-name");this.$deal_funnel=this.$form.find(".js-select-deal-funnel");this.$deal_stage=this.$form.find(".js-select-deal-stage");this.$deal_id=this.$form.find(".js-deal-id");this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMConversationAssociateDealDialog.prototype.initClass=function(){d.crm.renderSVG(this.$wrapper);this.initSelectDeal();
this.initSubmit()};CRMConversationAssociateDealDialog.prototype.initSelectDeal=function(){var a=this,b=a.$form.find(".js-select-deal .js-visible-link .js-text"),c=a.$form.find(".js-select-funnel"),e=a.$form.find(".js-deals-list"),f=a.$form.find(".js-deal-name-field");a.$form.on("click",".js-create-new-deal",function(){a.$submit.addClass("yellow").removeAttr("disabled");var e=d(this).find(".js-text").html();a.deal_selected=!0;c.removeClass("hidden");f.removeClass("hidden");a.$deal_name.focus();b.html(e);
a.$deal_id.val("0")});a.$form.on("click",".js-deal-item",function(){a.$submit.addClass("yellow").removeAttr("disabled");var g=d(this).find(".js-text").html();a.deal_selected=!0;e.find("li").removeClass("selected");d(this).parent().addClass("selected");b.html(g);c.addClass("hidden");f.addClass("hidden");a.$deal_name.val("");a.$deal_id.val(d(this).data("deal-id"))});e.on("click",function(){e.hide();setTimeout(function(){e.removeAttr("style")},200)});a.$form.on("change",".js-select-deal-funnel",function(){a.$form.find(".js-select-stage-wrapper").load("?module=deal&action=stagesByFunnel&id="+
d(this).val())})};CRMConversationAssociateDealDialog.prototype.initSubmit=function(){function a(){var a=d('<i class="icon16 loading" style="vertical-align: middle; margin-left: 6px;"></i>'),e=d.crm.app_url+"?module=message&action=conversationAssociateDealSave",f=b.$form.serializeArray();b.$submit.prop("disabled",!0);b.$footer.append(a);d.post(e,f,function(c){"ok"===c.status?d.crm.content.reload():(b.$submit.prop("disabled",!1),a.remove())})}var b=this;b.$form.on("submit",function(c){c.preventDefault();
if(!b.$deal_id.val())return b.$wrapper.addClass("shake animated"),setTimeout(function(){b.$wrapper.removeClass("shake animated")},500),!1;if(0==b.$deal_id.val()&&!d.trim(b.$deal_name.val()))return b.$deal_name.addClass("shake animated").focus(),setTimeout(function(){b.$deal_name.removeClass("shake animated").focus()},500),!1;a()})};return CRMConversationAssociateDealDialog}(jQuery);var CRMPageMessagesOperations=function(d){CRMPageMessagesOperations=function(a){this.$wrapper=a.$wrapper;this.$bar=this.$wrapper.find(".js-operations-wrapper");this.$list=this.$wrapper.find("#js-messages-table");this.$list_header=this.$list.find(".js-list-header");this.$checkbox_all=this.$wrapper.find(".js-checkbox-all");this.$content=this.$wrapper.find(".js-messages-page");this.page=a.page||1;this.limit=a.limit||30;this.total_count=a.total_count||0;this.total_items_at_page_count=this.getTotalItemsAtPage()||
0;this.view=a.view||"all";this.locales=a.locales||[];this.checked_count=0;this.read_list=[];this.unread_list=[];this.unread_counter=this.read_counter=0;this.deal_list=[];this.deal_counter=0;this.no_deal_list=[];this.no_deal_counter=0;this.is_shown=0<this.checked_count;this.is_checked_all=!1;this.initClass()};CRMPageMessagesOperations.prototype.initClass=function(){this.initCheckboxAll();this.initOperations();this.initItemCheckbox();this.initElasticHeader()};CRMPageMessagesOperations.prototype.initElasticHeader=
function(){function a(){d.contains(document,f[0])?c.scrollTop()>g.top?(f.addClass("is-fixed").css({left:g.left,width:h}),k=!0):(f.removeClass("is-fixed").removeAttr("style"),k=!1):c.off("scroll",a)}function b(){d.contains(document,f[0])?(h=e.outerWidth(),k&&f.width(h)):c.off("resize",b)}var c=d(window),e=this.$wrapper.find(".js-messages-section"),f=this.$bar,g=e.offset(),h=f.outerWidth(),k=!1;c.on("scroll",a).on("resize",b)};CRMPageMessagesOperations.prototype.initCheckboxAll=function(){var a=this;
a.$checkbox_all.click(function(){var b=d(this),c=b.is(":checked");0<a.checked_count?a.checked_count<a.total_items_at_page_count||a.checked_count===a.total_items_at_page_count?a.unselectAll():a.selectAll():(b.prop("checked",c),c?a.selectAll():a.unselectAll());a.formBar();a.showOrHideBar()})};CRMPageMessagesOperations.prototype.initOperations=function(){var a=this;a.$bar.on("click",".crm-operation-link",function(b){b.preventDefault();switch(d(this).data("id")){case "associate":a.associateWithDeal();
break;case "detach":a.detachFromDeals();break;case "read":a.markAsRead();break;case "unread":a.markAsUnread();break;case "delete":a.deleteConversation()}})};CRMPageMessagesOperations.prototype.updateBarCount=function(a,b){a.find(".crm-count").text("("+b+")")};CRMPageMessagesOperations.prototype.showOrHideBar=function(){0<this.checked_count?(this.is_shown||(this.$bar.addClass("is-shown"),this.$list_header.removeClass("is-shown"),this.is_shown=!0),this.formBar()):this.is_shown&&(this.$bar.removeClass("is-shown"),
this.$list_header.addClass("is-shown"),this.is_shown=!1)};CRMPageMessagesOperations.prototype.getSelectedIds=function(){return this.$list.find(".c-checkbox :checkbox:checked").map(function(){return parseInt(d(this).val())}).toArray()};CRMPageMessagesOperations.prototype.getTotalItemsAtPage=function(){return this.page*this.limit>this.total_count?this.total_count%this.limit:this.limit};CRMPageMessagesOperations.prototype.formBar=function(){var a=this.$bar.find('.crm-operation-li[data-id="associate"]'),
b=this.$bar.find('.crm-operation-li[data-id="detach"]'),c=this.$bar.find('.crm-operation-li[data-id="read"]'),d=this.$bar.find('.crm-operation-li[data-id="unread"]'),f=this.$bar.find('.crm-operation-li[data-id="delete"]');0<this.unread_counter?(c.show(),this.updateBarCount(c,this.unread_counter)):c.hide();0<this.read_counter?(d.show(),this.updateBarCount(d,this.read_counter)):d.hide();0<this.no_deal_counter?(a.show(),this.updateBarCount(a,this.no_deal_counter)):a.hide();0<this.deal_counter?(b.show(),
this.updateBarCount(b,this.deal_counter)):b.hide();0<this.checked_count?(f.show(),this.updateBarCount(f,this.checked_count)):f.hide()};CRMPageMessagesOperations.prototype.initItemCheckbox=function(){function a(a){var c=a.find(".js-checkbox").is(":checked");c?a.addClass("is-active"):a.removeClass("is-active");b.is_checked_all?(b.is_checked_all=!1,b.checked_count=b.$list.find(".c-checkbox :checkbox:checked").length):c?b.checked_count+=1:--b.checked_count;b.formBar();b.showOrHideBar()}var b=this;b.$list.on("change",
".js-checkbox",function(c,e){var f=d(this),g=f.closest(".js-message-wrapper");"undefined"!==typeof e&&f.attr("checked",e);b.markAsReadList(g);b.markAsUnreadList(g);b.associateWithDealList(g);b.detachFromDealsList(g);a(g);0<b.checked_count?b.checked_count<b.limit&&b.checked_count!==b.total_items_at_page_count?b.$checkbox_all.prop("indeterminate",!0):b.$checkbox_all.prop("indeterminate",!1).prop("checked",!0):b.$checkbox_all.prop("indeterminate",!1).prop("checked",!1)});b.$list.on("click",".c-checkbox",
function(a){a=d(a.target).is(":checkbox");a||a||(a=d(this).find(".js-checkbox"),a.trigger("change",[!a.is(":checked")]))});b.$list.shiftSelectable({selector:".js-message-wrapper",behavior_type:"vertical",onSelect:function(b,e){var c=d(e.target),c=!(!c.is("a")&&!c.closest("a").length),g=e.extra.is_first,h=e.extra.is_last;c||g||h||(b.find(".js-checkbox").attr("checked",!0),a(b))}})};CRMPageMessagesOperations.prototype.selectAll=function(){this.$list.find(".c-checkbox :checkbox").prop("checked",!0).trigger("change",
[!0]);this.checked_count=this.getSelectedIds().length;this.is_checked_all=!0};CRMPageMessagesOperations.prototype.unselectAll=function(){this.$list.find(".c-checkbox :checkbox").prop("checked",!1).trigger("change",[!1]);this.$checkbox_all.prop("checked",!1);this.checked_count=0;this.is_checked_all=!1};CRMPageMessagesOperations.prototype.associateWithDeal=function(){var a=this.no_deal_list;1===a.length?this.$list.find('tr[data-id="'+a[0]+'"] .js-associate-deal').trigger("click"):d.get("/webasyst/crm/?module=message&action=conversationAssociateDealDialog&conversation_id="+
a[0],function(a){new CRMDialog({html:a})})};CRMPageMessagesOperations.prototype.associateWithDealList=function(a){var b=this,c=a.data("has-deal");a=a.data("id");c||-1!==b.no_deal_list.indexOf(a)||b.no_deal_list.push(a);b.no_deal_list=b.getSelectedIds().filter(function(a){return-1<b.no_deal_list.indexOf(a)});b.no_deal_counter=b.no_deal_list.length};CRMPageMessagesOperations.prototype.detachFromDeals=function(){var a=this,b=a.$wrapper.find(".crm-dialog-wrapper.js-detach-conversation").clone(),c=a.view,
e=a.deal_list,f={message_ids:e},g="detachDeals";"conversation"===c&&(f={conversation_ids:e},g="detachDealsFromConversations");var h=d.crm.app_url+"?module=messageOperation&action="+g,k=function(e,g){new CRMDialog({html:b.show(),onOpen:function(a){a=a.find(".crm-dialog-content");a.find(".js-confirm-text").html(e);a=a.find(".js-check-text").hide();g=d.trim(g);0<g.length&&(a.find(".js-text").text(g),a.show())},onConfirm:function(){d.post(h,f).done(function(b){var e=Object.keys(f)[0];b=b.data[e];b.length&&
(b.forEach(function(b){var e='<a href="javascript:void(0);" class="inline-link small js-associate-deal nowrap" data-dialog-url="'+d.crm.app_url+"?module=message&action=conversationAssociateDealDialog&conversation_id="+b+'"><i class="icon10 add" style="vertical-align: baseline; margin: 0 4px 0 0;"></i><b><i>'+a.locales.associate_with_deal+"</i></b></a>";"all"===c&&(e="");d('tr[data-id="'+b+'"]',a.$list).data("has-deal",0).attr("data-has-deal",0).find(".c-column-deal").html(e);a.no_deal_list.push(b);
a.deal_list=a.deal_list.splice(b,1)}),a.no_deal_counter=a.no_deal_list.length,a.deal_counter=a.deal_list.length,a.formBar())}).fail(function(a){console.error("Detach Deals From Conversations",a)})},onClose:function(a){a.find(".crm-dialog-content").empty()}})};(function(){var a=d.extend({check:1},f,!0);return d.post(h,a)})().done(function(b){k("<h2>"+a.locales.detach_dialog_h2+"</h2>","ok"===b.status&&b.data&&b.data.text||"")})};CRMPageMessagesOperations.prototype.detachFromDealsList=function(a){var b=
this,c=a.data("has-deal");a=a.data("id");c&&-1===b.deal_list.indexOf(a)&&b.deal_list.push(a);b.deal_list=b.getSelectedIds().filter(function(a){return-1<b.deal_list.indexOf(a)});b.deal_counter=b.deal_list.length};CRMPageMessagesOperations.prototype.markAsRead=function(){var a=this,b=d.crm.app_url+"?module=messageOperation&action=markAsRead",c=a.unread_list,e={message_ids:c};"conversation"===a.view&&(e={conversation_ids:c});d.post(b,e).done(function(b){var c=Object.keys(e)[0];b=b.data[c];b.length&&
(b.map(function(b){a.$list.find('tr[data-id="'+b+'"]').removeClass("bold").data("read",1).attr("data-read",1);a.read_list.push(b);a.unread_list=a.unread_list.splice(b,1)}),a.read_counter=a.read_list.length,a.unread_counter=a.unread_list.length,a.formBar())}).fail(function(a){console.error("Mark as read",a)})};CRMPageMessagesOperations.prototype.markAsReadList=function(a){var b=this,c=a.data("id");1===a.data("read")&&-1===b.read_list.indexOf(c)&&b.read_list.push(c);b.read_list=b.getSelectedIds().filter(function(a){return-1<
b.read_list.indexOf(a)});b.read_counter=b.read_list.length};CRMPageMessagesOperations.prototype.markAsUnread=function(){var a=this,b=d.crm.app_url+"?module=messageOperation&action=markAsUnread",c=a.read_list,e={message_ids:c};"conversation"===a.view&&(e={conversation_ids:c});d.post(b,e).done(function(b){var c=Object.keys(e)[0];b=b.data[c];b.length&&(b.map(function(b){a.$list.find('tr[data-id="'+b+'"]').addClass("bold").data("read",0).attr("data-read",0);a.unread_list.push(b);a.read_list=a.read_list.splice(b,
1)}),a.unread_counter=a.unread_list.length,a.read_counter=a.read_list.length,a.formBar())}).fail(function(a){console.error("Mark as unread",a)})};CRMPageMessagesOperations.prototype.markAsUnreadList=function(a){var b=this,c=a.data("id");0===a.data("read")&&-1===b.unread_list.indexOf(c)&&b.unread_list.push(c);b.unread_list=b.getSelectedIds().filter(function(a){return-1<b.unread_list.indexOf(a)});b.unread_counter=b.unread_list.length};CRMPageMessagesOperations.prototype.deleteConversation=function(){var a=
this,b=a.$wrapper.find(".js-delete-conversation").clone(),c=a.view,e=a.getSelectedIds(),f={message_ids:e},g="delete";"conversation"===c&&(f={conversation_ids:e},g="deleteConversations");var h=d.crm.app_url+"?module=messageOperation&action="+g,k=function(c,g){new CRMDialog({html:b.show(),onOpen:function(a){a=a.find(".crm-dialog-content");a.find(".js-confirm-text").html(c);a=a.find(".js-check-text").hide();g=d.trim(g);0<g.length&&(a.find(".js-text").text(g),a.show())},onConfirm:function(){d.post(h,
f).done(function(b){var c=Object.keys(f)[0];b=b.data[c];b.length&&(b.map(function(b){d('tr[data-id="'+b+'"]',a.$list).hide()}),a.checked_count-=e.length,a.total_count-=e.length,a.unselectAll(),a.formBar(),1>a.total_count&&(a.$list.hide().before('<div class="no-messages">'+a.locales.no_messages+"</div>"),a.unselectAll(),a.hideBar()))}).fail(function(a){console.error("Delete messages",a)})},onClose:function(a){a.find(".crm-dialog-content").empty()}})};(function(){var a=d.extend({check:1},f,!0);return d.post(h,
a)})().done(function(b){k("<h2>"+a.locales.delete_dialog_h2+"</h2>","ok"===b.status&&b.data&&b.data.text||"")})};return CRMPageMessagesOperations}(jQuery);var CRMSendEmailDialog=function(d){function a(a){(a=a.data("redactor"))&&"core"in a&&a.core.destroy()}CRMSendEmailDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$textarea=this.$wrapper.find(".js-wysiwyg");this.$sender_email_select=this.$wrapper.find(".js-sender-email-select");this.$sender_email=this.$wrapper.find(".js-sender-email");this.$to_input=this.$wrapper.find(".js-to-input");this.$to_id=this.$wrapper.find(".js-to-id");this.dialog=this.$wrapper.data("dialog");
this.success_html=a.success_html;this.error_html=a.error_html;this.file_template_html=a.file_template_html;this.max_upload_size=a.max_upload_size;this.locales=a.locales;this.hash=a.hash;this.send_action_url=a.send_action_url;this.body=a.body||"";var b=!1;window&&window.parent&&window.parent.$&&window.parent.$.crm?b=window.parent.$.crm:window.$&&window.$.crm&&(b=window.$.crm);this.crm=b;this.action=a.action;this.deal_id=a.deal_id;this.is_admin=a.is_admin;this.app_url=a.crm_app_url||this.crm&&this.crm.app_url;
if(!this.send_action_url)throw Error("send_action_url option required");this.filesController=this.getFilesController();this.initClass()};CRMSendEmailDialog.prototype.initClass=function(){this.initWYSIWYG();this.initSendMessage();this.initPersonalSettingsDialog();this.senderEmailSelect();this.initEmailCopy();"new"==this.action&&(0==this.$to_id.val()&&this.initEmailTo(),this.initSelectDeal(),this.$to_input.focus());"forward"==this.action&&(this.initEmailTo(),this.$to_input.focus(),this.deal_id||this.initSelectDeal());
"reply"!=this.action||this.deal_id||this.initSelectDeal();this.dialog.resize()};CRMSendEmailDialog.prototype.getFilesController=function(){function a(a){a.length&&d.each(a,function(a,b){q.push({$file:c(b),file:b})})}function c(a){var b=d(p);b.find(".js-name").text(a.name);m.prepend(b);f.dialog.resize();return b}function e(a){var b=[];d.each(q,function(c,d){a[0]!==d.$file[0]?b.push(d):a.remove()});q=b}var f=this,g=f.$wrapper.find(".js-files-wrapper");if(!g.length)return!1;var h=g.find(".js-drop-area"),
k=g.find(".js-drop-text"),l=g.find(".js-drop-field"),m=g.find(".c-upload-list"),p=f.file_template_html,n=f.app_url+"?module=file&action=uploadTmp",q=[],r=0,u=0;l.on("change",function(b){b.preventDefault();a(this.files)});h.on("drop",function(b){b.preventDefault();a(b.originalEvent.dataTransfer.files)});h.on("dragover",function(a){a.preventDefault();h.addClass("is-hover");k.text(k.data("hover"));clearTimeout(u);u=setTimeout(function(){h.removeClass("is-hover");k.text(k.data("default"))},100)});g.on("click",
".js-file-delete",function(a){a.preventDefault();e(d(this).closest(".c-upload-item"))});return{uploadFiles:function(a,b){function c(b){function c(){var c=new FormData,f=document.cookie.match(/(?:^|; )_csrf=([^;]*)/);(f=f?decodeURIComponent(f[1]):"")&&c.append("_csrf",f);a&&a.length&&d.each(a,function(a,b){b.name&&b.value&&c.append(b.name,b.value)});c.append("file_size",b.file.size);c.append("files",b.file);c.append("file_end",1);d.ajax({xhr:function(){var a=new window.XMLHttpRequest;a.upload.addEventListener("progress",
function(a){if(a.lengthComputable){a=parseInt(a.loaded/a.total*100);var b;b=[247,198,174];for(var c=[174,247,196],d=[],e=0;e<b.length;e++)d.push(b[e]+(c[e]-b[e])/100*a);b="rgb("+d.join(",")+")";h.css("background-color",b).width(a+"%");k.text(a+"%")}},!1);return a},url:n,data:c,cache:!1,contentType:!1,processData:!1,type:"POST",success:function(a){k.text(k.data("success"));setTimeout(function(){d.contains(document,g[0])&&(g.remove(),--r,0>=r&&e())},2E3)}}).always(function(){})}var g=b.$file,h=g.find(".js-bar"),
k=g.find(".js-status");g.addClass("is-upload");f.max_upload_size>b.file.size?c():(k.addClass("errormsg").text(f.locales.file_size),g.find(".c-progress-wrapper").remove(),setTimeout(function(){d.contains(document,g[0])&&(g.remove(),--r,0>=r&&e())},2E3))}var e=b?b:function(){};q.length?(r=q.length,d.each(q,function(a,b){c(b)})):e()}}};CRMSendEmailDialog.prototype.initWYSIWYG=function(){var b=this,c=b.$textarea,d=0;b.crm.initWYSIWYG(c,{allowedAttr:[["section","data-role"]],callbacks:{change:function(){var a=
b.dialog.$block.height();d&&d===a||(d=a,b.dialog.resize())}}});b.body&&c.redactor("code.set",b.body);var f=b.dialog.onClose;b.dialog.onClose=function(){f(arguments);a(c)}};CRMSendEmailDialog.prototype.initSendMessage=function(){var b=this,c=!1,e=b.$wrapper.find(".js-to-email"),f=b.$to_id,g=b.$wrapper.find(".js-to-new-name");b.$form.on("submit",function(a){a.preventDefault();if(!(0!=f.val()||d.trim(g.val())&&d.trim(e.val())||"new"!=b.action&&"forward"!=b.action))return d(".js-to-input, .js-to-add-name, .js-to-add-email").addClass("shake animated").focus(),
setTimeout(function(){d(".js-to-input, .js-to-add-name, .js-to-add-email").removeClass("shake animated").focus()},500),!1;if(!d.trim(e.val()))return b.$to_input.addClass("shake animated").focus(),setTimeout(function(){b.$to_input.removeClass("shake animated").focus()},500),!1;if(!c){c=!0;a=b.$form.find(".js-submit-button");var k=d('<i class="icon16 loading" style="vertical-align: baseline; margin: 0 4px; position: relative; top: 3px;"></i>');a.removeClass("blue").attr("disabled",!0);k.insertAfter(a);
b.filesController.uploadFiles([{name:"hash",value:b.hash}],h)}});var h=function(){var e=b.send_action_url,f=b.$form.serializeArray(),g=function(a,c){if(!d.isEmptyObject(a)){a=d.extend(!0,{},a);var e=b.locales.send_error_title||"Send error",f=b.locales.send_error_text||"Can't send email message",f=d(b.error_html).find(".js-error-text").text(f).end(),g=a.common;b.is_admin&&(g?(f.find(".js-technical-info-block.js-known-error").show(),f.find(".js-technical-info-text").text(g)):f.find(".js-technical-info-block.js-unknown-error").show());
d.crm.alert.show({title:e,text:f.get(0).outerHTML,button:b.locales.close||"close",button_class:"red",onOpen:function(a){a.find(".js-technical-info-link").one("click",function(){d(this).remove();a.find(".js-technical-info-text").show()})}});delete a.common;d.isEmptyObject(a)||console.log.error(a)}c&&console.log.error(c)};d.post(e,f,"json").done(function(c){if("ok"===c.status){a(b.$textarea);b.$wrapper.find(".crm-dialog-block").html(b.success_html);b.dialog.resize();var e=null,f=b.dialog.onClose;b.dialog.onClose=
function(){f();e&&clearTimeout(e);e=null;b.crm.content.reload()};e=setTimeout(function(){b.dialog.close()},2500)}else b.dialog.close(),d.isEmptyObject(c.errors)?g({common:"Send error"},c):g(c.errors)}).always(function(){c=!1}).fail(function(a){g({},a);b.dialog.close()})}};CRMSendEmailDialog.prototype.initPersonalSettingsDialog=function(){function a(){e||(e=!0,d.post(c.crm.app_url+"?module=email&action=personalSettingsDialog",{},function(a){new CRMDialog({html:a,options:{onSave:function(a){c.$textarea.redactor("core.editor").find('[data-role="c-email-signature"]').html(a.email_signature||
"");c.$wrapper.find(".js-sender-name").text(a.sender_name||"")}}})}).always(function(){e=!1}))}var c=this,e=!1;c.$wrapper.on("click",".js-show-personal-settings-dialog",function(b){b.preventDefault();a()})};CRMSendEmailDialog.prototype.senderEmailSelect=function(){var a=this;a.$wrapper.on("change",a.$sender_email_select,function(b){b.preventDefault();a.$sender_email.val(a.$sender_email_select.val())})};CRMSendEmailDialog.prototype.initEmailTo=function(){function a(){var a=d.trim(h.val()).split(/\s+/),
b=!1;d.each(a,function(a,c){d.crm.check.email(c)&&!b&&(g=c.replace(/\<|\>/g,""),b=a)});!1!==b&&a.splice(b,1);f=a.join(" ");g&&f&&(a='<span class="js-edit-recipient" title="'+e.locales.edit_recipient+'"><b>'+d.crm.escape(f)+'</b> <span style="color: #999;">&lt;'+d.crm.escape(g)+"&gt;</span></span>",c(0,g,a),l.val(d.crm.escape(f)));if(f&&!g)return a='<span class="js-edit-recipient" title="'+e.locales.edit_recipient+'"><b>'+d.crm.escape(f)+'</b></span> <input class="c-to-input js-to-add-email" type="text" autocomplete="off" placeholder="'+
e.locales.type_email+'" style="margin-left: 8px; width: 150px;" />',c(0,null,a),l.val(d.crm.escape(f)),d(".js-to-add-email").focus(),!1;if(g&&!f)return a='<input class="c-to-input js-to-add-name" type="text" autocomplete="off" placeholder="'+e.locales.type_name+'" style="margin-right: 8px; width: 150px;" > <span class="js-edit-recipient" title="'+e.locales.edit_recipient+'" style="color: #999;">&lt;'+d.crm.escape(g)+"&gt;</span>",c(0,g,a),d(".js-to-add-name").focus(),!1}function c(a,b,c){p.prepend('<div class="c-email-to-user js-email-to-user">'+
c+' <a title="'+e.locales.change_recipient+'" class="c-remove-to-email js-remove-to-email">x</a></div>');n.removeClass("hidden");h.addClass("hidden").val("");k.val(b);m.val(a).trigger("change")}var e=this,f=null,g=null,h=e.$to_input,k=e.$wrapper.find(".js-to-email"),l=e.$wrapper.find(".js-to-new-name"),m=e.$to_id,p=e.$wrapper.find(".js-to-name"),n=e.$wrapper.find(".js-deal-field"),q=e.$wrapper.find(".js-select-funnel"),r=e.$wrapper.find(".js-select-deal .js-visible-link .js-text"),u=e.$wrapper.find(".js-deals-list"),
t=e.$wrapper.find(".js-create-new-deal");h.autocomplete({source:d.crm.app_url+"?module=autocomplete&emailcomplete=true",appendTo:e.$wrapper,minLength:0,focus:function(){return!1},select:function(a,b){var d=b.item,e=(d.criteria||{}).email||d.email;c(d.id,e,'<i class="icon16 userpic20" style="background-image: url('+d.photo_url+');"></i> <b>'+d.name+'</b> <span style="color: #999;">&lt;'+e+"&gt;</span>");return!1}}).data("ui-autocomplete")._renderItem=function(a,b){return d('<li class="ui-menu-item-html"><div>'+
b.value+"</div></li>").appendTo(a)};h.on("focus",function(){h.data("uiAutocomplete").search(h.val())});h.on("keydown",function(a){if(13==a.keyCode)return a.preventDefault(),h.blur(),!1});h.on("focusout",function(b){b.preventDefault();a();return!1});p.on("click",".js-remove-to-email",function(){d(this).parent(".js-email-to-user").remove();h.removeClass("hidden").focus();n.addClass("hidden");q.addClass("hidden");u.html(t);r.html("<b><i>"+e.locales.deal_select+"</i></b>");k.val("");l.val("");m.val("").trigger("change");
g=f=null});e.$wrapper.on("click",".js-edit-recipient",function(){var a=[f,g].join(" ");h.val(d.trim(a)).removeClass("hidden").focus();d(".js-email-to-user").remove();g=f=null;k.val("");l.val("")});e.$wrapper.on("keydown",".js-to-add-email",function(a){13==a.keyCode&&(a.preventDefault(),d(this).blur())});e.$wrapper.on("focusout",".js-to-add-email",function(){var a=d(".js-to-add-email"),b=d.trim(a.val());b.length&&!0===d.crm.check.email(b)&&(g=b,k.val(d.crm.escape(b)),a.before(d('<span class="js-edit-recipient" title="'+
e.locales.edit_recipient+'" style="color: #999;"></span>').text("<"+b+">")).remove())});e.$wrapper.on("keydown",".js-to-add-name",function(a){13==a.keyCode&&(a.preventDefault(),d(this).blur())});e.$wrapper.on("focusout",".js-to-add-name",function(){var a=d.trim(d(".js-to-add-name").val());a.length&&(f=a,l.val(d.crm.escape(a)),d(".js-to-add-name:first-child").before(d('<span class="js-edit-recipient" title="'+e.locales.edit_recipient+'"><b></b></span>').text(a)).remove())})};CRMSendEmailDialog.prototype.initEmailCopy=
function(){function a(){var a=d.trim(m.val()).split(/[,:;]/);if(a[0].length)return d.each(a,function(a,b){var f=d.trim(b).split(/\s+/),g=!1,h=b=null;d.each(f,function(a,c){d.crm.check.email(c)&&!g&&(b=c.replace(/\<|\>/g,""),g=a)});!1!==g&&f.splice(g,1);h=f.join(" ");b&&h&&e(0,b,h);b&&!h&&c(0,b,b);h&&!b&&(m.addClass("shake animated"),setTimeout(function(){m.removeClass("shake animated")},500));g=!1;h=b=null}),!1}function c(a,b,c){l.children('[data-email="'+b+'"]').length&&"0"!==a||!b.length||(d(".email-copy-input-div").before('<div class="email-copy-user" title="'+
d.crm.escape(b)+'" data-contact-id="'+d.crm.escape(a)+'" data-email="'+d.crm.escape(b)+'">'+c+' <a title="'+f.locales.remove_form_cc+'" class="remove-cc js-remove-cc">x</a> <input name="cc['+d.crm.escape(b)+'][email]" type="hidden" value="'+d.crm.escape(b)+'" /><input name="cc['+d.crm.escape(b)+'][id]" type="hidden" value="'+d.crm.escape(a)+'" /></div>'),d(".email-copy-text-collapsed").append('<div class="email-copy-user" title="'+d.crm.escape(b)+'" data-email="'+d.crm.escape(b)+'">'+c+"</div>"));
m.val("").focus()}function e(a,b,c){l.children('[data-email="'+b+'"]').length&&"0"!==a||!b.length||(d(".email-copy-input-div").before('<div class="email-copy-user" title="'+d.crm.escape(b)+'" data-contact-id="'+a+'" data-email="'+d.crm.escape(b)+'">'+d.crm.escape(c)+' <a title="'+f.locales.remove_form_cc+'" class="remove-cc js-remove-cc">x</a> <input name="cc['+d.crm.escape(b)+'][email]" type="hidden" value="'+d.crm.escape(b)+'" /><input name="cc['+d.crm.escape(b)+'][id]" type="hidden" value="'+d.crm.escape(a)+
'" /><input name="cc['+d.crm.escape(b)+'][name]" type="hidden" value="'+d.crm.escape(c)+'" /></div>'),d(".email-copy-text-collapsed").append('<div class="email-copy-user" title="'+d.crm.escape(b)+'" data-email="'+d.crm.escape(b)+'">'+d.crm.escape(c)+"</div>"));m.val("").focus()}var f=this,g=f.$wrapper.find(".email-copy-wrapper"),h=f.$wrapper.find(".js-email-copy-link-icon"),k=g.find(".email-copy-area"),l=k.find(".email-copy-text"),m=k.find(".email-copy-input"),p=g.find(".deal-participants-area"),
n=f.$wrapper.find(".email-copy-wrapper-collapsed");m.autocomplete({source:d.crm.app_url+"?module=autocomplete&emailcomplete=true",appendTo:f.$wrapper,minLength:0,focus:function(){return!1},select:function(a,b){var d=b.item;c(d.id,(d.criteria||{}).email||d.email,'<i class="icon16 userpic20" style="background-image: url('+d.photo_url+');"></i><b>'+d.name+"</b>");m.val("");return!1}}).data("ui-autocomplete")._renderItem=function(a,b){return d('<li class="ui-menu-item-html"><div>'+b.value+"</div></li>").appendTo(a)};
m.on("focus",function(){m.data("uiAutocomplete").search(m.val())});f.$wrapper.on("click",".js-email-copy-link, .email-copy-text-collapsed",function(a){a.preventDefault();g.toggleClass("email-copy-wrapper-block");g.is(":visible")?(h.removeClass("rarr").addClass("darr"),m.focus(),n.removeClass("email-copy-wrapper-collapsed-block")):(h.removeClass("darr").addClass("rarr"),d(".email-copy-text-collapsed").children().length&&n.addClass("email-copy-wrapper-collapsed-block"))});k.on("click",function(){m.focus()});
p.on("click",".email-copy-user",function(){var a=d(this).data("cc-contact-id"),b=d(this).data("cc-email"),e=d(this).html();c(a,b,e)});m.on("focusout",function(b){a()});m.on("keydown",function(b){13==b.keyCode&&(b.preventDefault(),a())});l.on("click",".js-remove-cc",function(a){a.preventDefault();a=d(this).parent(".email-copy-user");var b=a.data("email");a.remove();d(".email-copy-text-collapsed").children('[data-email="'+b+'"]').remove()});m.on("keydown",function(a){if(8==a.keyCode&&0==m.val().length){a=
d(".email-copy-text .email-copy-user:last");var b=a.data("email");a.remove();d(".email-copy-text-collapsed").children('[data-email="'+b+'"]').remove();m.focus()}})};CRMSendEmailDialog.prototype.initSelectDeal=function(){function a(){var a=l.val();k.val("none");a&&d.get("?module=deal&action=byContact&id="+a,function(a){"ok"===a.status&&(d.each(a.data.deals,function(b,c){h.prepend('<li><a href="javascript:void(0);" class="js-deal-item" data-deal-id="'+c.id+'"><span class="js-text"><i class="icon16 funnel-state svg-icon" data-color="'+
a.data.funnels[c.funnel_id].stages[c.stage_id].color+'"></i><b><i>'+c.name+"</i></b></span></a></li>")}),d.crm.renderSVG(c.$wrapper))},"json")}var c=this,e=c.$form.find(".js-select-deal .js-visible-link .js-text"),f=c.$form.find(".js-select-funnel"),g=c.$wrapper.find(".js-deal-field"),h=c.$form.find(".js-deals-list"),k=c.$form.find(".js-deal-id"),l=c.$to_id,m=c.$form.find(".js-empty-deal");c.$form.on("click",".js-create-new-deal",function(){var a=d(this).find(".js-text").html();f.removeClass("hidden");
m.removeClass("c-empty-deal-hidden");e.html(a);k.val("0")});m.on("click",function(){d(this).addClass("c-empty-deal-hidden");f.addClass("hidden");h.find("li").removeClass("selected");e.html("<b><i>"+c.locales.deal_empty+"</i></b>");k.val("none")});c.$form.on("click",".js-deal-item",function(){var a=d(this).find(".js-text").html();h.find("li").removeClass("selected");d(this).parent().addClass("selected");e.html(a);m.removeClass("c-empty-deal-hidden");f.addClass("hidden");k.val(d(this).data("deal-id"))});
"reply"==c.action&&a();"new"==c.action&&0<l.val()&&(a(),g.removeClass("hidden"));l.on("change",a);h.on("click",function(){h.hide();setTimeout(function(){h.removeAttr("style")},200)});c.$form.on("change",".js-select-deal-funnel",function(){c.$form.find(".js-select-stage-wrapper").load("?module=deal&action=stagesByFunnel&id="+d(this).val())})};return CRMSendEmailDialog}(jQuery);var CRMSendSmsDialog=function(d){CRMSendSmsDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$textarea=this.$wrapper.find(".js-send-sms-textarea");this.dialog=this.$wrapper.data("dialog");this.success_html=a.success_html;this.error_html=a.error_html;this.hash=a.hash;this.send_action_url=a.send_action_url;var b=!1;window&&window.parent&&window.parent.$&&window.parent.$.crm?b=window.parent.$.crm:window.$&&window.$.crm&&(b=window.$.crm);this.crm=b;this.action=a.action;
this.locales=a.locales||{};this.app_url=a.crm_app_url||this.crm&&this.crm.app_url;if(!this.send_action_url)throw Error("send_action_url option required");this.initClass()};CRMSendSmsDialog.prototype.initClass=function(){this.initSenderSelector();this.initSendMessage();this.dialog.resize()};CRMSendSmsDialog.prototype.initSenderSelector=function(){var a=this.$wrapper,b=a.find(".js-specified-sms-sender");a.find(".js-sms-sender-list").change(function(){"specified"===d(this).val()?b.attr("disabled",!1).show():
b.attr("disabled",!0).hide()})};CRMSendSmsDialog.prototype.initSendMessage=function(){var a=this,b=!1;a.$form.on("submit",function(c){c.preventDefault();if(!b){b=!0;c=a.$form.find(".js-submit-button");var e=d('<i class="icon16 loading" style="vertical-align: baseline; margin: 0 4px; position: relative; top: 3px;"></i>');c.removeClass("blue").attr("disabled",!0);e.insertAfter(c);c=a.send_action_url;var e=a.$form.serializeArray(),f=function(b){var c=a.locales.send_error_title||"Send error",e=a.locales.send_error_text||
"Can't send sms message",e=d(a.error_html).find(".js-error-text").text(e).end();d.crm.alert.show({title:c,text:e.get(0).outerHTML,button_class:"red"});b&&console.error(b)};d.post(c,e,function(b){if("ok"===b.status){a.$wrapper.find(".crm-dialog-block").html(a.success_html);a.dialog.resize();var c=null,d=a.dialog.onClose;a.dialog.onClose=function(){d();c&&clearTimeout(c);c=null;a.crm.content.reload()};c=setTimeout(function(){a.dialog.close()},2500)}else a.dialog.close(),f(b.errors||{})},"json").always(function(){b=
!1}).error(function(b){a.dialog.close();f(b)})}})};return CRMSendSmsDialog}(jQuery);var CRMImSourceMessageDialog=function(d){CRMImSourceMessageDialog=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".js-reply-button");this.dialog=this.$wrapper.data("dialog");this.send_dialog=null;this.message=a.message||{};this.locales=a.locales||{};var b=!1;window&&window.parent&&window.parent.$&&window.parent.$.crm?b=window.parent.$.crm:window.$&&window.$.crm&&(b=window.$.crm);this.crm=b;this.app_url=a.crm_app_url||this.crm&&this.crm.app_url;this.initClass()};CRMImSourceMessageDialog.prototype.initClass=
function(){this.initMessageDeleteLink();this.initMessageReplyBtn()};CRMImSourceMessageDialog.prototype.initMessageReplyBtn=function(){function a(a){f.append(g);d.post(b.app_url+"?module=message&action=writeReplyDialog",{id:b.message.id},function(c){new CRMDialog({html:c,onOpen:function(c,d){b.send_dialog=d;c.find(".js-cancel-dialog").click(function(){b.send_dialog.hide();e.show()});a&&a()},onClose:function(){b.send_dialog=null;b.dialog&&b.dialog.close();b.dialog=null}})})}var b=this,c=b.$wrapper,
e=b.dialog,f=c.find(".js-dialog-footer"),g=d('<i class="icon16 loading" style="vertical-align: middle; margin-left: 6px;"></i>'),h=c.find(".js-reply-button");h.click(function(){h.attr("disabled",!0);var c=function(){g.remove();h.attr("disabled",!1);e.hide()};b.send_dialog?(b.send_dialog.show(),c()):a(function(){c();var a=b.dialog.onClose;b.dialog.onClose=function(){a.apply(this,arguments);b.dialog=null;b.send_dialog&&b.send_dialog.close();b.send_dialog=null}})})};CRMMessageDeleteLinkMixin.mixInFor(CRMImSourceMessageDialog);
return CRMImSourceMessageDialog}(jQuery);var CRMImSourceSendMessageDialog=function(d){CRMImSourceSendMessageDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$button=this.$form.find(":submit");this.dialog=this.$wrapper.data("dialog");this.message=a.message||{};this.locales=a.locales||{};this.success_html=a.success_html||"";var b=!1;window&&window.parent&&window.parent.$&&window.parent.$.crm?b=window.parent.$.crm:window.$&&window.$.crm&&(b=window.$.crm);this.crm=b;this.app_url=a.crm_app_url||this.crm&&
this.crm.app_url;this.send_action_url=a.send_action_url;if(!this.send_action_url)throw Error("send_action_url option required");this.initClass()};CRMImSourceSendMessageDialog.prototype.initClass=function(){this.initSendMessage();this.initErrorCleaner()};CRMImSourceSendMessageDialog.prototype.initErrorCleaner=function(){function a(){b.clearErrors()}var b=this,c=b.$wrapper,d=null;c.on("keydown",":input",function(){d&&clearTimeout(d);d=setTimeout(function(){a()},250)});c.on("change",":input",a)};CRMImSourceSendMessageDialog.prototype.initSendMessage=
function(){var a=this,b=a.$form,c=a.$button;b.on("submit",function(b){function e(b){b&&!d.isEmptyObject(b.errors)?a.showErrors(b.errors):console.error(b?["Server error",b]:"Server error")}b.preventDefault();var g=null,h=d('<i class="icon16 loading" style="vertical-align: baseline; margin: 0 4px; position: relative; top: 3px;"></i>');c.attr("disabled",!0).after(h);g&&g.abort();g=d.post(a.send_action_url,a.$form.serializeArray()).done(function(b){if("ok"!==b.status)e(b);else{a.$wrapper.find(".crm-dialog-block").html(a.success_html);
a.dialog.resize();var c=null,d=a.dialog.onClose;a.dialog.onClose=function(){d();c&&clearTimeout(c);c=null;a.crm.content.reload()};c=setTimeout(function(){a.dialog.close()},2500)}}).fail(e).always(function(){c.attr("disabled",!1);h.remove();g=null})});b.on("click",".js-cancel-dialog",function(){a.$wrapper.css({display:"none"})})};CRMImSourceSendMessageDialog.prototype.showErrors=function(a){var b=this.$wrapper;d.each(a,function(a,d){var c=b.find('[name="'+a+'"]'),e='<em class="errormsg">'+d+"</em>";
c.length?(c.addClass("error"),c.after(e)):b.find(".js-errors-place").append(e)})};CRMImSourceSendMessageDialog.prototype.clearErrors=function(){var a=this.$wrapper;a.find(".error").removeClass("error");a.find(".errormsg").remove();a.find(".js-errors-place").empty()};return CRMImSourceSendMessageDialog}(jQuery);var CRMContactPage=function(d){CRMContactPage=function(a){this.$wrapper=a.$wrapper;this.$tabsW=this.$wrapper.find(".t-profile-tabs");this.photo_dialog_url=a.photo_dialog_url;this.locales=a.locales;this.contact_id=a.contact_id||!1;this.editable=a.editable||!1;this.initClass()};CRMContactPage.prototype.initClass=function(){this.initTabChange();this.initAddCompanyContactLink();this.initResponsibleLink();this.initClassifyAccessLink();this.initChangePhotoLink();this.initTopInfoFields();this.initEmployee();
this.initAssignTags();this.initSegments();this.initInfoTab();this.editable&&(this.initEditLink(),this.initDeleteLink(),this.initEditableName());this.initRemoveFiles();this.initFixedHeader();this.editInterception();this.deleteInterception();this.initMessage();this.initCall()};CRMContactPage.prototype.editInterception=function(){var a=this,b=location.pathname.replace(d.crm.app_url,"").split("/");d(window).load(function(){0<=b.indexOf("edit")&&a.$wrapper.find(".profile-header-links .js-edit-link").trigger("click")})};
CRMContactPage.prototype.deleteInterception=function(){var a=this,b=location.pathname.replace(d.crm.app_url,"").split("/");d(window).load(function(){0<=b.indexOf("delete")&&a.$wrapper.find(".profile-header-links .js-delete-link").trigger("click")})};CRMContactPage.prototype.initTopInfoFields=function(){var a=this.$wrapper.find(".js-info-list");this.$wrapper.on("click",".js-info-toggle",function(b){b.preventDefault();d(this).toggleClass("is-active");a.slideToggle()})};CRMContactPage.prototype.initChangePhotoLink=
function(){var a=this;a.$wrapper.find(".photo-change-link a").click(function(){d.get(a.photo_dialog_url,function(b){(new CRMDialog({html:b})).$wrapper.on("photo_updated photo_deleted",function(b,d){a.$wrapper.find(".c-userpic").attr("src",d.url)})},"html")})};CRMContactPage.prototype.initTabChange=function(){var a=window.history&&window.history.pushState;this.$wrapper.find(".t-profile-tabs").on("click",".t-tab a",function(b){b.preventDefault();if(a){b=d(this).data("tab-id");var c=window.location.href.match(/^.*\/(id|contact)\/[^\/]+/);
c&&b&&(b=c[0]+"/"+b+"/",history.replaceState({reload:!0,content_uri:b},"",b))}})};CRMContactPage.prototype.initEditLink=function(){var a=this;a.$wrapper.find(".profile-header-links .edit-link").on("click",function(){var b=a.$wrapper.find('.t-tab a[data-tab-id="info"]').closest(".t-tab");d("html, body").animate({scrollTop:b.offset().top},500);a.$wrapper.find(".t-profile-tabs").data("tabs_controller").switchToTab("info",function(a){return"function"===typeof a[0].contentWindow.$.wa.contactEditor.switchMode}).then(function(a){a[0].contentWindow.$.wa.contactEditor.switchMode("edit")})});
var b=a.$wrapper.find(".t-profile-tabs-iframes");b.on("contact_saved",function(c,e){d.crm.content.reload();b.children().hide();a.$wrapper.find(".t-profile-tabs").data("tabs_controller").showTabHtml("__internal",'<div class="block double-padded"><i class="icon16 loading"></i></div>')})};CRMContactPage.prototype.initInfoTab=function(){var a=null;this.$wrapper.find('.t-profile-tabs .t-tab[data-tab-id="info"] a').on("tab_content_updated",function(){a&&clearInterval(a);a=setInterval(function(){var b=d("#c-profile-page .t-profile-tabs-iframes iframe").filter(function(){return"info"==
d(this).data("tab-id")});try{if(!b[0].contentWindow.$.wa.contactEditor)return}catch(g){return}a&&clearInterval(a);a=null;var c=d('script[src*="wa-apps/crm"]:first').attr("src").match(/^(.*\/wa-apps\/crm\/)[^\?]*(\?.*)/),e=c[1],f=c[2];b[0].contentWindow.$("head").append('<link href="'+e+"js/jquery/jquery-ui.css"+f+'" rel="stylesheet" type="text/css">');["js/jquery/jquery-ui.min.js","js/crm.autocomplete.js","js/contact.info.js"].forEach(function(a){b[0].contentWindow.$("head").append('<script src="'+
e+a+f+'">\x3c/script>')})},100)})};CRMContactPage.prototype.initAddCompanyContactLink=function(){this.$wrapper.find(".js-add-company-contact").on("click",function(){d.get(d(this).data("dialog-url"),function(a){new CRMDialog({html:a})})})};CRMContactPage.prototype.initResponsibleLink=function(){this.$wrapper.find(".profile-header-links .responsible-link").on("click",function(){d.get(d(this).data("dialog-url"),function(a){new CRMDialog({remain_after_load:!0,html:a})})})};CRMContactPage.prototype.initDeleteLink=
function(){var a=this.$wrapper,b=a.find(".crm-delete-link"),c=this.contact_id,e=d.crm.app_url+"?module=contactOperation&action=delete",f=a.find(".crm-contact-operation-delete-checking").clone();b.click(function(a){a.preventDefault();new CRMDialog({html:f.show(),onOpen:function(a){var b=this;a.find(".crm-cancel").click(function(){b.close()});d.get(e,{contact_ids:[c],is_contact_page:1},function(a){new CRMDialog({html:a,onOpen:function(){b.close()}})})}})})};CRMContactPage.prototype.initClassifyAccessLink=
function(){this.$wrapper.find(".profile-header-links .classify-access-link").on("click",function(){d.get(d(this).data("dialog-url"),function(a){new CRMDialog({remain_after_load:!0,html:a})})})};CRMContactPage.prototype.initEmployee=function(){var a=this,b=!1;a.$wrapper.on("click",".js-view-employees",function(b){b.preventDefault();a.$tabsW.length&&d("html, body").scrollTop(a.$tabsW.offset().top)});a.$wrapper.on("click",".js-add-employee",function(c){c.preventDefault();c=d.crm.app_url+"?module=contact&action=addEmployee";
var e={company_contact_id:a.contact_id};b&&b.abort();b=d.post(c,e,function(a){new CRMDialog({html:a})})})};CRMContactPage.prototype.initAssignTags=function(){var a=this.$wrapper.find(".crm-contact-assign-tags"),b=d.crm.app_url+"?module=contactOperation&action=assignTags&is_assign=1",c=parseInt(this.contact_id)||0;a.click(function(a){a.preventDefault();d.get(b,{contact_ids:[c]},function(a){new CRMDialog({html:a})})})};CRMContactPage.prototype.initSegments=function(){function a(a){var c=b.$wrapper.find(".js-segment-list"),
e=c.find("a").length;a.length||a.push({id:!1,name:b.locales.no_segments});d.each(a,function(a,b){var f="javascript:void(0);",g="",h='<span class="hint">'+b.name+"</span>";b.id&&(f=d.crm.app_url+"contact/segment/"+b.id+"/",g='<i class="icon16 '+(b.icon?b.icon:"folder-dynamic")+'"></i>',h="<span>"+b.name+"</span>");f='<a href="'+f+'">'+g+h+"</a>";e&&(f=","+f);c.append(f);e=!0})}var b=this,c=b.$wrapper.find(".crm-contact-assign-segments"),e=d.crm.app_url+"?module=contactOperation&action=addToSegments&is_assign=1",
f=parseInt(b.contact_id)||0;c.click(function(a){a.preventDefault();d.get(e,{contact_ids:[f]},function(a){new CRMDialog({html:a,onOpen:function(a){new CRMContactsOperationAddToSegments({$wrapper:a,context:{contact_ids:[f]},is_assign:1})}})})});var g=!1;b.$wrapper.on("click",".js-show-dynamic-segments",function(c){c.preventDefault();var e=d(this);e.find(".icon16").removeClass("folder-dynamic").addClass("loading");g&&g.abort();g=d.post("?module=contact&action=segmentSearch",{id:b.contact_id},function(b){"ok"==
b.status&&(a(b.data.segments),e.remove())}).always(function(){g=!1})})};CRMContactPage.prototype.initEditableName=function(){var a=this.$wrapper.find(".js-name-editable").first();if(!(0>=a.length)){var b=this.contact_id;new CrmEditable({$wrapper:a,saveChanged:!0,saveNonempty:!0,placeholder:a.data("editable-placeholder"),onSave:function(a){if(!a.isLoading())if(a.isChanged()&&d.trim(a.getText())){a.loading();var c=a.getText();d.post(d.crm.app_url+"?module=contact&action=profileSave",{data:JSON.stringify({name:c}),
id:b}).always(function(){a.setText(c);a.loading(!1).hide();d.crm.content.reload()})}else a.hide()}})}};CRMContactPage.prototype.initRemoveFiles=function(){function a(a,b){d.post("?module=file&action=delete",{id:a},function(a){"ok"==a.status?b.remove():console&&console.log&&console.log("File Remove Error")})}var b=this;b.$wrapper.find(".js-files-list").on("click",".js-remove-file",function(c){c.preventDefault();var e=d(this).closest(".c-file");c=e.find(".c-name").text();var f=parseInt(e.data("id"));
0<f?d.crm.confirm.show({title:b.locales.remove_file_title,text:b.locales.remove_file_text.replace(/%s/,c),button:b.locales.remove_file_button,onConfirm:function(){a(f,e)}}):console&&console.log&&console.log("File ID is empty")})};CRMContactPage.prototype.initFixedHeader=function(){function a(){if(d.contains(document,e[0])){var k=b.scrollTop();k>f.top+70?(e.css({left:f.left,width:c.outerWidth()+"px"}).addClass("is-fixed"),k>f.top+c.outerHeight()-e.outerHeight()?e.removeClass("is-hover").css("background",
g):(k="linear-gradient(to bottom, "+g+" 0%, "+g+" 70%, rgba("+h.join(",")+") 100%)",e.addClass("is-hover").css("background",k)),c.addClass("is-over")):(e.removeAttr("style").removeClass("is-fixed"),c.removeClass("is-over"))}else b.off("scroll",a)}var b=d(window),c=this.$wrapper.find(".js-profile"),e=this.$wrapper.find(".js-short-profile"),f=c.offset(),g=c.css("background-color"),h=g.replace("rgba(","").replace("rgb(","").replace(")","").split(","),h=d.map(h,function(a){return parseInt(a)});3>=h.length?
h.push(0):h[3]=0;e.on("click",".js-short-responsible-link",function(){c.find(".profile-header-links .js-responsible-link").trigger("click")});e.on("click",".js-short-access-link",function(){c.find(".profile-header-links .js-access-link").trigger("click")});e.on("click",".js-short-edit-link",function(){c.find(".profile-header-links .js-edit-link").trigger("click")});e.on("click",".js-short-delete-link",function(){c.find(".profile-header-links .js-delete-link").trigger("click")});b.on("scroll",a)};
CRMContactPage.prototype.initMessage=function(){this.initSendEmail();this.initSendSMS()};CRMContactPage.prototype.initSendEmail=function(){var a=!1;this.$wrapper.on("click",".js-show-message-dialog",function(b){b.preventDefault();var c=d(this);b=c.data("id");c=c.data("email");!a&&b&&(a=!0,d.post("?module=message&action=writeNewDialog",{contact_id:b,email:c},function(a){new CRMDialog({html:a})}).always(function(){a=!1}))})};CRMContactPage.prototype.initSendSMS=function(){var a=!1;this.$wrapper.on("click",
".js-show-send-sms-dialog",function(b){b.preventDefault();var c=d(this);b=c.data("id");c=c.data("phone");!a&&b&&(a=!0,d.get("?module=message&action=writeSMSNewDialog",{contact_id:b,phone:c},function(a){new CRMDialog({html:a})}).always(function(){a=!1}))})};CRMContactPage.prototype.initCall=function(){var a=!1;this.$wrapper.on("click",".js-show-call-dialog",function(b){b.preventDefault();var c=d(this);b=c.data("id");c=c.data("phone");!a&&b&&c&&(a=!0,d.post("?module=call&action=initContactDialog",{contact_id:b,
phone:c},function(a){new CRMDialog({remain_after_load:!0,html:a})}).always(function(){a=!1}))})};return CRMContactPage}(jQuery),CRMNewContactPage=function(d){CRMNewContactPage=function(a){this.$wrapper=a.$wrapper;this.$contactSection=this.$wrapper.find(".js-contact-section");this.$accessSection=this.$wrapper.find(".js-access-section");this.$segmentsSection=this.$wrapper.find(".js-segments-section");this.$dealSection=this.$wrapper.find(".js-deal-section");this.$errorsSection=this.$wrapper.find(".js-errors-section");
this.$extendedFieldsW=this.$wrapper.find(".js-contact-extended-fields");this.call_id=a.call_id;this.funnels=a.funnels;this.locales=a.locales;this.contact_data=a.contact_data;this.stage_template_html=a.stage_template_html;this.extended_fields=a.extended_fields||{};this.is_extended=a.is_extended||!1;this.create_deal=this.selected_segments=!1;this.initClass()};CRMNewContactPage.prototype.initClass=function(){d.crm.renderSVG(this.$wrapper);this.contact_data&&this.setContactData(this.contact_data);this.initContactToggle();
this.initAccessToggle();this.initSegmentsToggle();this.initDealToggle();this.initDealSection();this.$extendedFieldsW.length&&this.initExtendedFields();this.initCreate();this.initHeaderActions();this.initWYSIWYG();this.initContactUpdateDialog()};CRMNewContactPage.prototype.initContactToggle=function(){var a=this;a.$contactSection.on("click",".js-extended-toggle",function(b){b.preventDefault();a.$contactSection.hasClass("is-extended")?(a.$contactSection.removeClass("is-extended"),a.is_extended=!1):
(a.$contactSection.addClass("is-extended"),a.is_extended=!0)})};CRMNewContactPage.prototype.initAccessToggle=function(){var a=this,b=a.$accessSection.find(".js-ibutton");b.iButton({labelOn:"",labelOff:"",classContainer:"c-ibutton ibutton-container mini"});b.on("change",function(){"checked"===b.attr("checked")?(a.$accessSection.addClass("is-extended"),a.selected_access=!0):(a.$accessSection.removeClass("is-extended"),a.selected_access=!1)})};CRMNewContactPage.prototype.initSegmentsToggle=function(){var a=
this,b=a.$segmentsSection.find(".js-ibutton");b.iButton({labelOn:"",labelOff:"",classContainer:"c-ibutton ibutton-container mini"});b.on("change",function(){"checked"===b.attr("checked")?(a.$segmentsSection.addClass("is-extended"),a.selected_segments=!0):(a.$segmentsSection.removeClass("is-extended"),a.selected_segments=!1)})};CRMNewContactPage.prototype.initDealToggle=function(){var a=this,b=a.$dealSection.find(".js-ibutton");b.iButton({labelOn:"",labelOff:"",classContainer:"c-ibutton ibutton-container mini"});
b.on("change",function(){"checked"===b.attr("checked")?(a.$dealSection.addClass("is-extended"),a.create_deal=!0):(a.$dealSection.removeClass("is-extended"),a.create_deal=!1)})};CRMNewContactPage.prototype.initDealSection=function(){var a=this,b=a.$wrapper.find(".js-funnels-list");(function(){var c=b.find(".js-visible-link"),e=b.find(".js-field"),f=b.find(".menu-v");f.on("click","a",function(){var g=d(this);c.find(".js-text").html(g.html());f.find(".selected").removeClass("selected");g.closest("li").addClass("selected");
f.hide();setTimeout(function(){f.removeAttr("style")},200);g=g.data("id");e.val(g).trigger("change");(g=a.funnels[g]||!1)&&b.trigger("changeFunnel",g)});d.crm.renderSVG(b)})();(function(){function b(b){k.html("");d.each(b,function(b,c){var e=a.stage_template_html,f=d("<div />").text(c.name).html(),e=e.replace("%id%",c.id).replace("%color%",c.color).replace("%name%",f),e=d(e);k.append(e)});d.crm.renderSVG(f);k.find("li:first-child a").trigger("click")}var e=a.$wrapper.find(".js-funnels-list"),f=a.$wrapper.find(".js-funnel-stages-list"),
g=f.find(".js-visible-link"),h=f.find(".js-field"),k=f.find(".menu-v");k.on("click","a",function(){var a=d(this);g.find(".js-text").html(a.html());k.find(".selected").removeClass("selected");a.closest("li").addClass("selected");k.hide();setTimeout(function(){k.removeAttr("style")},200);a=a.data("id");h.val(a)});e.on("changeFunnel",function(a,c){b(c.stages)})})();(function(){function b(){var a=d.datepicker._defaults.dateFormat,b=!1;try{d.datepicker.parseDate(a,f.val()),b=!0}catch(l){}b?(f.data("last-correct-value",
f.val()),g.data("last-correct-value",g.val())):(f.val(f.data("last-correct-value")||""),g.val(g.data("last-correct-value")||""))}var e=a.$wrapper.find(".js-datepicker-wrapper"),f=e.find(".js-datepicker"),g=e.find('[name="deal[expected_date]"]');f.datepicker({altField:g,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,onSelect:b});f.on("blur",b);f.on("keydown keypress keyup",function(a){13===a.which&&a.preventDefault()});e.on("click",".js-icon",function(){f.focus()})})();(function(){var b=a.$wrapper.find(".js-contact-block"),
e=b.find(".js-view-toggle"),f=e.find(".is-active");e.on("click",".c-toggle",function(c){c.preventDefault();c=d(this);var e=c.data("id");if(c.hasClass("is-active"))return!1;a.contact_mode=e;f.length&&f.removeClass("is-active");c.addClass("is-active");f=c;b.find(".c-hidden.is-active").removeClass("is-active");b.find(".c-hidden-"+e).addClass("is-active")})})()};CRMNewContactPage.prototype.initCreate=function(){function a(){function a(){var a=e.$wrapper.find(".js-option-field:checked"),b=e.$wrapper.find(".js-vault-toggle"),
c=e.$wrapper.find(".js-owners-list");a.length&&(a=a.val(),"vaults"===a?(b=b.find(".js-field").val(),m.data.push({name:"vault_id",value:b})):"owners"===a&&(b=c.find(".c-owner"),b.length||m.errors.push({name:"owner[autocomplete]"}),b.each(function(){var a=d(this).data("id");0<a&&m.data.push({name:"owners[]",value:a})})))}function b(){var a=e.$segmentsSection.find("form").serializeArray();d.each(a,function(a,b){m.data.push(b)})}function c(){var a=e.$dealSection.find("form").serializeArray(),b=!0;d.each(a,
function(a,c){m.data.push(c);0<d.trim(c.value).length&&"deal[name]"===c.name&&(b=!1)});b&&m.errors.push({name:"deal[name]",value:e.locales.empty_deal_name})}function f(){var a=e.$extendedFieldsW.data("getFormData")();d.each(a.data,function(a,b){m.data.push(b)});d.each(a.errors,function(a,b){m.errors.push(b)})}var m={data:[],errors:[]};(function(){var a=e.$contactSection.find("form.c-general-form"),b=a.find(".js-phone-list"),c=a.find(".js-email-list");b.find("li .js-value, li .js-ext").removeAttr("name");
c.find("li .js-value, li .js-ext").removeAttr("name");var a=a.serializeArray(),f=["contact[firstname]","contact[middlename]","contact[lastname]","contact[name]"],g=!0;d.each(a,function(a,b){b.value=d.trim(b.value);m.data.push(b);0<d.trim(b.value).length&&0<=f.indexOf(b.name)&&(g=!1)});g&&(a=e.$contactSection.find('[name="contact[firstname]"]'),a.length?m.errors.push({name:"contact[firstname]",value:e.locales.empty_contact_name}):(a=e.$contactSection.find('[name="contact[name]"]'),a.length&&m.errors.push({name:"contact[name]",
value:e.locales.empty_contact_name})));b.find("li").each(function(a){var b=d(this),c=b.find(".js-value"),b=b.find(".js-ext"),e=c.val(),f=b.val();if(e){var g="contact[phone]["+a+"][value]";c.attr("name",g);m.data.push({name:g,value:e});a="contact[phone]["+a+"][ext]";b.attr("name",a);m.data.push({name:a,value:f})}});c.find("li").each(function(a){var b=d(this),c=b.find(".js-value"),b=b.find(".js-ext"),e=c.val(),f=b.val();if(e){var g="contact[email]["+a+"][value]";c.attr("name",g);m.data.push({name:g,
value:e});a="contact[email]["+a+"][ext]";b.attr("name",a);m.data.push({name:a,value:f})}})})();e.$extendedFieldsW.length&&e.is_extended&&f();e.selected_access&&a();e.selected_segments&&b();e.create_deal&&c();return m}function b(a,b){b=b?b:[];a&&(b=a);d.each(b,function(a,b){var c=b.value,f=e.$wrapper.find(':input[name="'+b.name+'"]'),g=d("<div />").addClass("errormsg").text(c);f.length?f.hasClass("error")||(f.parent().append(g),f.addClass("error").one("focus click change",function(){f.removeClass("error");
g.remove()})):e.$errorsSection.append(g)})}function c(a){f||(f=!0,d.post("?module=contact&action=newSave",a,function(a){"ok"===a.status?d.crm.content.load(d.crm.app_url+"contact/"+a.data.contact.id+"/"):b(a.errors)},"json").always(function(){f=!1}))}var e=this,f=!1;e.$wrapper.on("click",".js-submit-form",function(d){d.preventDefault();e.$errorsSection.html("");d=a();d.errors.length?b(!1,d.errors):c(d.data)})};CRMNewContactPage.prototype.initExtendedFields=function(){function a(a){a=a||{};var c=b.$wrapper,
e="c-conditional-field-"+(""+Math.random()).slice(2),f=a.input_name;a.parent_field=a.parent_field||"";a.parent_options=a.parent_options||{};a.index=a.index||0;if(a.parent_field&&!d.isEmptyObject(a.parent_options)){var l=a.parent_field.split(":");if(!(1>=l.length)){var l='[name="contact['+l[0]+"]["+a.index+"]["+l[1]+']"]',m=c.find(l);if(!(0>=m.length)){a.show_empty_option=a.required;var p=a.parent_options,n,q=c.find(':input[name="'+f+'"]').first();if(!(0>=q.length)){q.is("input")?n=q.next():(n=q,q=
n.prev());var r=function(){q[0].hasAttribute("name")||(q.attr("name",n.attr("name")),n[0].removeAttribute("name"));q.show().val("");n.hide()},c=function(){var b;b=q.is(":visible")?q.val():n.val();var c=d(this).val().toLowerCase();a.hide_unmatched&&q.closest(".field").show();if(p&&p[c]){c=p[c];q.hide();n.show().children().remove();a.show_empty_option&&n.append(d('<option value=""></option>'));for(var e=0;e<c.length;e++)n.append(d("<option></option>").attr("value",c[e]).text(c[e]));n.val(b);q[0].hasAttribute("name")&&
(n.attr("name",q.attr("name")),q[0].removeAttribute("name"))}else a.hide_unmatched?(r(),q.val(""),q.closest(".field").hide()):q.is(":visible")||(r(),q.val(b))};c.call(m);f=m.closest(".field");f.length?(f.off("."+e),f.on("change."+e,l,c)):(m.off("."+e),m.on("change."+e,c))}}}}}var b=this,c=b.$extendedFieldsW,e=c.find("form");(function(){var a=c.find(".js-dynamic-field-wrapper");a.each(function(){var a=d(this),b=a.find(".js-list"),c=b.find(".c-item")[0].outerHTML;a.on("click",".js-add",function(){b.append(c)});
a.on("click",".js-remove",function(){d(this).closest(".c-item").remove()});b.on("change",".js-ext-toggle",function(){var a=d(this),b=a.closest(".c-item").find(".js-ext-field");"custom"===a.val()?b.attr("disabled",!1).show():b.attr("disabled",!0).hide()})});c.on("prepareSave",function(){a.each(function(){d(this).find(".js-list").find(".c-item").each(function(a){d(this).find("[data-name-pattern]").each(function(){var b=d(this),c=b.data("name-pattern");c&&(c=c.replace("%index%",a),b.attr("name",c))})})})})})();
(function(){function e(e){function f(){l.each(function(){d(this).find(".js-address-wrapper").each(function(b){d(this).find("[data-name-pattern]").each(function(){var c=d(this),e=c.data("name-pattern");if(e&&(e=e.replace("%index%",b),c.attr("name",e),c.is("input"))){var f=c.closest(".js-custom-sub-field-line");f.is('[data-type="Conditional"]')&&(c=f.data("field-id"),f=f.data("subfield-id"),(c=g[c].fields[f])&&a(d.extend(c,{input_name:e,index:b})))}})})})}(function(){e.find(".js-custom-sub-field-line").each(function(){var a=
d(this),b=a.data("name-pattern");a.find(":input").each(function(){var a=d(this);a.attr("data-name-pattern",b);a.removeAttr("name")})});e.find('.js-custom-sub-field-line[data-type="Select"]').each(function(){var a=d(this);a.data("sub-type")||a.find("select").find('option[value=""]').text(a.data("label")+"...")});e.find('.js-custom-sub-field-line[data-type="Checkbox"]').each(function(){var a=d(this),b=a.find(":checkbox");b.wrap("<label>");b=b.parent();b.append("<span>");b.find("span").append(" "+a.data("label"))})})();
var g=b.extended_fields||{},l=e.find(".js-address-list"),m=e.find(".js-address-wrapper")[0].outerHTML;c.on("prepareSave",f);f();e.on("click",".js-add",function(){l.append(m);f()});e.on("click",".js-remove",function(){d(this).closest(".js-address-wrapper").remove()});e.on("click",".js-clear-selected-radio-value",function(){d(this).closest(".js-custom-sub-field-line").find(":radio:checked").attr("checked",!1)});e.on("change",".js-ext-toggle",function(){var a=d(this),b=a.closest(".js-address-wrapper").find(".js-ext-field");
"custom"===a.val()?b.attr("disabled",!1).show():b.attr("disabled",!0).hide()});e.on("change",".js-country-toggle",function(){function a(){k&&k.abort();k=d.post(d.crm.backend_url+"?module=profile&action=regions",{country:h},function(a){"ok"===a.status&&(d.isEmptyObject(a.data.options)?b(!1):b(a.data))}).always(function(){k=!1})}function b(a){f.html("");g.val("");a&&Object.keys(a).length?(f.attr("disabled",!1).show(),g.attr("disabled",!0).hide(),d.each(a.oOrder,function(b,c){var d=a.options[c];d&&f.append('<option value="'+
c+'">'+d+"</option>")})):(f.attr("disabled",!0).hide(),g.attr("disabled",!1).show())}var c=d(this),e=c.closest(".js-address-wrapper"),f=e.find(".js-region-select"),g=e.find(".js-region-field"),h=c.val(),k=!1;h?a(h):b(!1)})}c.find(".js-address-section").each(function(){e(d(this))})})();(function(){var a=c.find(".js-bank-section");if(!a.length)return!1;var b=a.find(".js-bank-list"),e=a.find(".js-bank-wrapper")[0].outerHTML;a.on("click",".js-add",function(){b.append(e)});b.on("click",".js-remove",function(){d(this).closest(".js-bank-wrapper").remove()});
a.on("change",".js-ext-toggle",function(){var a=d(this),b=a.closest(".js-bank-wrapper").find(".js-ext-field");"custom"===a.val()?b.attr("disabled",!1).show():b.attr("disabled",!0).hide()});c.on("prepareSave",function(){b.each(function(){d(this).find(".js-bank-wrapper").each(function(a){d(this).find("[data-name-pattern]").each(function(){var b=d(this),c=b.data("name-pattern");c&&(c=c.replace("%index%",a),b.attr("name",c))})})})})})();(function(){c.find(".js-datepicker input:text").each(function(){function a(){try{d.datepicker.parseDate(d.datepicker._defaults.dateFormat,
b.val()),b.data("last-correct-value",b.val()),c.data("last-correct-value",c.val())}catch(k){b.val(b.data("last-correct-value")||""),c.val(c.data("last-correct-value")||"")}}var b=d(this),c=b.siblings('input[type="hidden"]');b.datepicker({altField:c,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,onSelect:a});b.on("blur",a);b.on("keydown keypress keyup",function(a){13===a.which&&a.preventDefault()})})})();c.data("getFormData",function(){c.trigger("prepareSave");var a=e.serializeArray(),b={data:[],
errors:[]};d.each(a,function(a,c){b.data.push(c)});return b})};CRMNewContactPage.prototype.setContactData=function(a){var b=this;d.each(a,function(a,e){if("string"===typeof e||"number"===typeof e){var c=b.$wrapper.find('[name="contact['+a+']"]');c.length&&c.val(e).trigger("change")}else"phone"===a&&d.each(e,function(a,b){var c={number:b.value,ext:b.ext};d(document).trigger("addContactPhone",c)}),"email"===a&&d.each(e,function(a,b){var c={name:b.value,ext:b.ext};d(document).trigger("addContactEmail",
c)})})};CRMNewContactPage.prototype.initHeaderActions=function(){function a(){b||(b=!0,d.post("?module=contact&action=createSettings",{},function(a){new CRMDialog({html:a})}).always(function(){b=!1}))}var b=!1;this.$wrapper.on("click",".js-show-personal-settings-dialog",function(b){b.preventDefault();a()})};CRMNewContactPage.prototype.initWYSIWYG=function(){var a=this.$wrapper.find(".js-wysiwyg");if(!a.length)return!1;a.each(function(){var a=d(this);d.crm.initWYSIWYG(a,{keydownCallback:function(a){}})})};
CRMNewContactPage.prototype.initContactUpdateDialog=function(){function a(){c||(c=!0,d.post(d.crm.app_url+"?module=contact&action=updateDialog",{call_id:b.call_id},function(a){new CRMDialog({html:a})}).always(function(){c=!1}))}var b=this,c=!1;b.$wrapper.on("click",".js-show-update-dialog",function(b){b.preventDefault();a()})};return CRMNewContactPage}(jQuery),CRMContactAccessDialogNew=function(d){CRMContactAccessDialogNew=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");
this.$optionsList=this.$wrapper.find(".js-options-list");this.$vaultsToggle=this.$wrapper.find(".js-vault-toggle");this.$ownersList=this.$wrapper.find(".js-owners-list");this.$submitButton=this.$wrapper.find(".js-save");this.$errorsPlace=this.$wrapper.find(".js-errors-place");this.dialog=this.$wrapper.data("dialog");this.owner_template_html=a.owner_template_html;this.contact_id=a.contact_id;this.owners=a.owners;this.locales=a.locales;this.initClass()};CRMContactAccessDialogNew.prototype.initClass=
function(){this.initChangeOptions();this.initAutocomplete();this.initVaultToggle()};CRMContactAccessDialogNew.prototype.initChangeOptions=function(){var a=this.$optionsList.find(".c-option.is-active");this.$optionsList.on("change",".js-option-field",function(){var b=d(this),c=b.closest(".c-option");"checked"===b.attr("checked")&&(a.length&&a.removeClass("is-active"),a=c.addClass("is-active"))})};CRMContactAccessDialogNew.prototype.initAutocomplete=function(){function a(a){a.addClass("highlighted");
setTimeout(function(){a.removeClass("highlighted")},2E3)}function b(a){return d("<div></div>").text(a).html()}var c=this,e=c.$ownersList.find(".js-autocomplete");e.autocomplete({source:d.crm.app_url+"?module=autocomplete&type=user",appendTo:c.$wrapper,minLength:0,focus:function(){return!1},select:function(f,g){var h;h=c.$ownersList.find('.c-owner[data-id="'+g.item.id+'"]');h=h.length?h:void 0;if(!h){h=g.item;var k=c.owner_template_html,k=k.replace(/%id%/,h.id).replace("%name%",b(h.name)).replace("%photo_url%",
h.photo_url);h=d(k);c.$ownersList.append(h)}a(h);e.val("");return!1}}).data("ui-autocomplete")._renderItem=function(a,b){return d('<li class="ui-menu-item-html"><div>'+b.value+"</div></li>").appendTo(a)};e.on("focus",function(){e.data("uiAutocomplete").search(e.val())});c.$ownersList.on("click",".js-delete-owner",function(){d(this).closest(".c-owner").remove()})};CRMContactAccessDialogNew.prototype.initVaultToggle=function(){var a=this.$vaultsToggle,b=a.find(".js-visible-link"),c=a.find(".js-field"),
e=a.find(".menu-v");e.on("click","a",function(){var a=d(this);b.find(".js-text").html(a.html());e.find(".selected").removeClass("selected");a.closest("li").addClass("selected");e.hide();setTimeout(function(){e.removeAttr("style")},200);a=a.data("id");c.val(a)});d.crm.renderSVG(a)};return CRMContactAccessDialogNew}(jQuery),CRMContactResponsibleDialog=function(d){CRMContactResponsibleDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$responsibleList=this.$wrapper.find(".js-responsible-list");
this.$submitButton=this.$wrapper.find(".js-save");this.dialog=this.$wrapper.data("dialog");this.locales=a.locales;this.responsible_template_html=a.responsible_template_html;this.initClass()};CRMContactResponsibleDialog.prototype.initClass=function(){var a=this;a.$wrapper.on("change","input",function(){a.toggleButton(!0)});a.initSubmit();a.initClearResponsible();a.initAutocomplete()};CRMContactResponsibleDialog.prototype.initSubmit=function(){function a(){if(!e){e=!0;var a=d.crm.app_url+"?module=contact&action=responsibleSave",
g=b();if(!g)return e=!1;var h=d('<i class="icon16 loading" style="vertical-align: middle; margin: 0;"></i>');h.appendTo(c.$submitButton.parent());c.$submitButton.attr("disabled",!0);d.post(a,g,function(a){"ok"===a.data.result?d.crm.content.reload().then(function(){c.dialog.close()}):"no_vault_access"===a.data.result&&(d(".no-access-error").html(a.data.message),setTimeout(function(){c.dialog.close()},5E3))},"json").always(function(){c.$submitButton.attr("disabled",!1);c.toggleButton(!1);h.remove();
e=!1})}}function b(){var a=d("#contact_id").val(),b=d("#responsible_id").val();return{contact_id:a,responsible_id:b}}var c=this,e=!1;c.$form.on("submit",function(b){b.preventDefault();a()})};CRMContactResponsibleDialog.prototype.initClearResponsible=function(){function a(){var a=d.crm.app_url+"?module=contact&action=responsibleSave",f={contact_id:d("#contact_id").attr("value"),responsible_id:0},g=d('<i class="icon16 loading" style="vertical-align: middle; margin: 0;"></i>');g.appendTo(c.$submitButton.parent());
c.$submitButton.attr("disabled",!0);d.post(a,f,function(a){"ok"===a.status?d.crm.content.reload().then(function(){c.dialog.close()}):(console.log("Error saving Responsible contact classification: "+arguments[2],arguments),b("Error saving Responsible contact classification: "+arguments[2]))},"json").always(function(){c.$submitButton.attr("disabled",!1);c.toggleButton(!1);g.remove()})}function b(a){a=d('<div class="errormsg" />').text(a);c.$errorsPlace.append(a)}var c=this;c.$wrapper.on("click",".js-clear-responsible",
function(b){b.preventDefault();d.crm.confirm.show({title:c.locales.clear_responsible_title,text:c.locales.clear_responsible_text,button:c.locales.clear_responsible_button,onConfirm:a})})};CRMContactResponsibleDialog.prototype.initAutocomplete=function(){function a(a){return d("<div></div>").text(a).html()}function b(a){a.addClass("highlighted");setTimeout(function(){a.removeClass("highlighted")},2E3)}var c=this,e=d("#contact_id").val(),f=c.$responsibleList.find(".js-autocomplete");f.autocomplete({source:d.crm.app_url+
"?module=autocomplete&type=user&contact_id="+e,appendTo:c.$wrapper,minLength:0,focus:function(){return!1},select:function(e,h){var g;g=c.$responsibleList.find('.c-responsible[data-id="'+h.item.id+'"]');g=g.length?g:void 0;if(!g){g=h.item;var l=c.responsible_template_html,l=l.replace(/%id%/,g.id).replace("%name%",a(g.name)).replace("%photo_url%",g.photo_url);d("#responsible_id").val(g.id);g=d(l);c.$responsibleList.append(g);d(".js-input").css("display","none");c.$submitButton.attr("disabled",!1);c.toggleButton(!0)}b(g);
c.toggleButton(!0);f.val("");return!1}}).data("ui-autocomplete")._renderItem=function(a,b){var c=d("<li />");c.addClass("ui-menu-item-html").append("<div>"+b.value+"</div>").appendTo(a);b.rights||(c.addClass("is-locked"),c.on("click",function(a){a.preventDefault();a.stopPropagation()}));return c};f.on("focus",function(){f.data("uiAutocomplete").search(f.val())});c.$responsibleList.on("click",".js-delete-responsible",function(){d(this).closest(".c-responsible").remove();d("#responsible_id").val("");
d(".js-input").css("display","");d(".js-autocomplete").focus();c.$submitButton.attr("disabled",!0);c.toggleButton(!0)})};CRMContactResponsibleDialog.prototype.toggleButton=function(a){var b=this.$submitButton;a?b.removeClass("green").addClass("yellow"):b.removeClass("yellow").addClass("green")};return CRMContactResponsibleDialog}(jQuery),CRMContactAccessDialog=function(d){CRMContactAccessDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$optionsList=this.$wrapper.find(".js-options-list");
this.$vaultsToggle=this.$wrapper.find(".js-vault-toggle");this.$ownersList=this.$wrapper.find(".js-owners-list");this.$submitButton=this.$wrapper.find(".js-save");this.$errorsPlace=this.$wrapper.find(".js-errors-place");this.dialog=this.$wrapper.data("dialog");this.owner_template_html=a.owner_template_html;this.contact_id=a.contact_id;this.owners=a.owners;this.locales=a.locales;this.initClass()};CRMContactAccessDialog.prototype.initClass=function(){var a=this;a.$wrapper.on("change","input",function(){a.toggleButton(!0)});
a.initChangeOptions();a.initSubmit();a.initAutocomplete();a.initVaultToggle()};CRMContactAccessDialog.prototype.initSubmit=function(){function a(){if(!f){f=!0;e.$errorsPlace.html("");var a=d.crm.app_url+"?module=contact&action=accessSave",h=b();if(!h)return f=!1;var k=d('<i class="icon16 loading" style="vertical-align: middle; margin: 0;"></i>');k.appendTo(e.$submitButton.parent());e.$submitButton.attr("disabled",!0);d.post(a,h,function(a){"ok"===a.status?d.crm.content.reload().then(function(){e.dialog.close()}):
(console.log("Error saving contact access classification: "+arguments[2],arguments),c("Error saving contact access classification: "+arguments[2]))},"json").always(function(){e.$submitButton.attr("disabled",!1);k.remove();e.toggleButton(!1);f=!1})}}function b(){var a=[],b=e.$wrapper.find(".js-option-field:checked");if(b.length){b=b.val();if("vaults"===b){var f=e.$vaultsToggle.find(".js-field").val();a.push({name:"vault_id",value:f})}if("owners"===b){f=e.$ownersList.find(".c-owner");if(!f.length)return c(e.locales.empty_owner),
!1;f.each(function(){var b=d(this).data("id");0<b&&a.push({name:"owners[]",value:b})})}"all"===b&&a.push({name:"vault_id",value:"0"});b=e.$wrapper.find(".js-employees-field");b.length&&"checked"===b.attr("checked")&&a.push({name:"employees",value:"on"});a.push({name:"contact_id",value:e.contact_id})}return a}function c(a){a=d('<div class="errormsg" />').text(a);e.$errorsPlace.append(a)}var e=this,f=!1;e.$form.on("submit",function(b){b.preventDefault();a()})};CRMContactAccessDialog.prototype.initChangeOptions=
function(){var a=this,b=a.$optionsList.find(".c-option.is-active");a.$optionsList.on("change",".js-option-field",function(){var c=d(this),e=c.closest(".c-option");"checked"===c.attr("checked")&&(b.length&&b.removeClass("is-active"),b=e.addClass("is-active"));a.dialog.resize()})};CRMContactAccessDialog.prototype.initAutocomplete=function(){function a(a){a.addClass("highlighted");setTimeout(function(){a.removeClass("highlighted")},2E3)}function b(a){return d("<div></div>").text(a).html()}var c=this,
e=c.$ownersList.find(".js-autocomplete");e.autocomplete({source:d.crm.app_url+"?module=autocomplete&type=user",appendTo:c.$wrapper,minLength:0,focus:function(){return!1},select:function(f,g){var h;h=c.$ownersList.find('.c-owner[data-id="'+g.item.id+'"]');h=h.length?h:void 0;if(!h){h=g.item;var k=c.owner_template_html,k=k.replace(/%id%/g,h.id).replace("%name%",b(h.name)).replace("%photo_url%",h.photo_url);h=d(k);c.$ownersList.append(h);c.dialog.resize()}a(h);c.toggleButton(!0);e.val("");return!1}}).data("ui-autocomplete")._renderItem=
function(a,b){return d('<li class="ui-menu-item-html"><div>'+b.value+"</div></li>").appendTo(a)};e.on("focus",function(){e.data("uiAutocomplete").search(e.val())});c.$ownersList.on("click",".js-delete-owner",function(){d(this).closest(".c-owner").remove();c.toggleButton(!0)})};CRMContactAccessDialog.prototype.toggleButton=function(a){var b=this.$submitButton;a?b.removeClass("green").addClass("yellow"):b.removeClass("yellow").addClass("green")};CRMContactAccessDialog.prototype.initVaultToggle=function(){var a=
this.$vaultsToggle,b=a.find(".js-visible-link"),c=a.find(".js-field"),e=a.find(".menu-v");e.on("click","a",function(){var a=d(this);b.find(".js-text").html(a.html());e.find(".selected").removeClass("selected");a.closest("li").addClass("selected");e.hide();setTimeout(function(){e.removeAttr("style")},200);a=a.data("id");c.val(a)});d.crm.renderSVG(a)};return CRMContactAccessDialog}(jQuery),CRMContactCreateSettings=function(d){CRMContactCreateSettings=function(a){this.$wrapper=a.$wrapper;this.$form=
this.$wrapper.find("form");this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMContactCreateSettings.prototype.initClass=function(){this.initSave()};CRMContactCreateSettings.prototype.initSave=function(){function a(){var a={data:[],errors:[]},b=e.serializeArray();d.each(b,function(b,c){a.data.push(c)});return a}function b(a){f||(f=!0,d.post("?module=contact&action=createSettingsSave",a,function(a){"ok"===a.status?c.dialog.close():(a=(a=a.errors)?a:[],console.log(a))},"json").always(function(){f=
!1}))}var c=this,e=c.$form,f=!1;e.on("submit",function(c){c.preventDefault();c=a();c.errors.length?(c=(c=c.errors)?c:[],console.log(c)):b(c.data)})};return CRMContactCreateSettings}(jQuery),CRMContactAddEmployeeDialog=function(d){CRMContactAddEmployeeDialog=function(a){this.$wrapper=a.$wrapper;this.contact_id=a.contact_id;this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMContactAddEmployeeDialog.prototype.initClass=function(){this.initAddEmployee()};CRMContactAddEmployeeDialog.prototype.initAddEmployee=
function(){function a(a){function b(a){var b=d('<div class="line errormsg" />').html(a);f.append(b);c.$form.one("submit",function(){b.remove()})}if(a[0])d.each(a,function(a,c){b(c.value)});else{var e=Object.keys(a);d.each(e,function(c,d){b(a[d])})}}function b(b){g||(g=!0,d.post("?module=contact&action=addEmployeeSave",b,function(b){"ok"===b.status?(d.crm.content.reload(),c.dialog.close()):b.errors&&a(b.errors)}).always(function(){g=!1}))}var c=this,e=c.$wrapper.find("#c-contact-add-employee-form"),
f=c.$wrapper.find(".js-errors-place"),g=!1;e.on("submit",function(c){var d;c.preventDefault();c=e.serializeArray();d=[];d.length?a(d):b(c)})};return CRMContactAddEmployeeDialog}(jQuery),CRMContactUpdateDialog=function(d){CRMContactUpdateDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$footer=this.$wrapper.find(".js-dialog-footer");this.$submitButton=this.$wrapper.find(".js-submit-button");this.initClass()};CRMContactUpdateDialog.prototype.initClass=function(){this.initAutocomplete();
this.initSubmit()};CRMContactUpdateDialog.prototype.initAutocomplete=function(){var a=this,b=a.$wrapper.find(".js-autocomplete-wrapper"),c=b.find(".js-autocomplete"),e=b.find(".js-field");c.autocomplete({appendTo:b,source:d.crm.app_url+"?module=autocomplete",minLength:2,html:!0,focus:function(){return!1},select:function(a,b){var f=d("<div />").text(b.item.name).text();c.val(f).blur();e.val(b.item.id).trigger("change");return!1}}).data("ui-autocomplete")._renderItem=function(a,b){return d("<li />").addClass("ui-menu-item-html").append("<div>"+
b.value+"</div>").appendTo(a)};e.on("change",function(){a.$submitButton.attr("disabled",!1)})};CRMContactUpdateDialog.prototype.initSubmit=function(){function a(){var a={data:[],errors:[]},b=e.serializeArray();d.each(b,function(b,c){a.data.push(c)});return a}function b(a){a=a?a:[];d.each(a,function(a,b){var c=b.value,g=e.find('[name="'+b.name+'"]'),h=d("<span />").addClass("errormsg").text(c);g.length?g.hasClass("error")||(g.parent().append(h),g.addClass("error").one("focus click",function(){g.removeClass("error");
h.remove()})):(f.append(h),e.one("submit",function(){h.remove()}))})}function c(a){g||(g=!0,d.post("?module=contact&action=update",a,function(a){"ok"===a.status?d.crm.content.load(d.crm.app_url+"contact/"+a.data.id+"/"):b(a.errors)},"json").always(function(){g=!1}))}var e=this.$form,f=this.$wrapper.find(".js-errors-place"),g=!1;e.on("submit",function(d){d.preventDefault();d=a();d.errors.length?b(d.errors):c(d.data)})};return CRMContactUpdateDialog}(jQuery),CRMContactAddCompanyContactDialog=function(d){CRMContactAddCompanyContactDialog=
function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$company_value=this.$wrapper.find(".js-company-value");this.$submit=this.$wrapper.find(".js-submit");this.$footer=this.$wrapper.find(".js-dialog-footer");this.$company_id_input=this.$wrapper.find(".js-company-id");this.$company_name_input=this.$wrapper.find(".js-autocomplete-company");this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMContactAddCompanyContactDialog.prototype.initClass=function(){var a=this;
a.$form.on("click",".js-company-item",function(){a.$submit.prop("disabled",!1)});a.initAutoComplete();a.initSubmit()};CRMContactAddCompanyContactDialog.prototype.initAutoComplete=function(){var a=this,b=a.$wrapper.find(".js-selected-company"),c=a.$wrapper.find(".js-change-company"),e=a.$wrapper.find(".js-label-new-company");a.$company_name_input.autocomplete({source:function(a,b){d.post("?module=autocomplete&type=company",a,function(c){d.isEmptyObject(c)&&a.term?e.css({color:"#999"}):e.css({color:"#FFF"});
b(c)},"json")},minLength:0,focus:function(){return!1},select:function(c,e){a.$company_id_input.val(e.item.id);b.html('<i class="icon16 userpic20" style="background-image: url('+e.item.photo_url+');"></i>').append(d("<span />").text(e.item.name)).removeClass("hidden");a.$company_name_input.addClass("hidden");return!1}}).data("ui-autocomplete")._renderItem=function(a,b){return d("<li />").addClass("ui-menu-item-html").append("<div>"+b.value+"</div>").appendTo(a)};a.$company_name_input.on("focus",function(){a.$company_name_input.data("uiAutocomplete").search(a.company_name)});
c.on("click",function(){a.$company_id_input.val(0);b.html("").addClass("hidden");a.$company_name_input.removeClass("hidden").focus()})};CRMContactAddCompanyContactDialog.prototype.initSubmit=function(){function a(){var a=d('<i class="icon16 loading" style="vertical-align: middle; margin-left: 6px;"></i>'),e=d.crm.app_url+"?module=contact&action=addCompanyContactSave",f=b.$form.serializeArray();b.$submit.prop("disabled",!0);b.$footer.append(a);d.post(e,f,function(c){"ok"===c.status?d.crm.content.reload():
(b.$submit.prop("disabled",!1),a.remove())})}var b=this;b.$form.on("submit",function(c){c.preventDefault();c=b.$company_id_input.val();var e=b.$company_name_input.val();if(0==c&&!d.trim(e))return b.$company_value.addClass("shake animated"),b.$company_name_input.focus(),setTimeout(function(){b.$company_value.removeClass("shake animated");b.$company_name_input.focus()},500),!1;a()})};return CRMContactAddCompanyContactDialog}(jQuery);var CRMContactsPage=function(d){CRMContactsPage=function(a){this.$wrapper=a.$wrapper;this.$content=this.$wrapper.find("#js-content-block");this.is_admin=a.is_admin;this.context=a.context||{};this.view=a.view||"thumbs";this.total_count=a.total_count||0;this.page_count=a.page_count||0;this.locales=a.locales;this.sidebar=this.$wrapper.find(".c-contacts-sidebar").data("sidebar_controller");this.initClass()};CRMContactsPage.prototype.initClass=function(){this.initElastic();"segment"===this.context.type&&
this.initEditableName(d.crm.app_url+"?module=contactSegment&action=save&is_rename=1",this.context);"list"===this.view&&(this.initContactsColumnsSection(),this.initContactsTable());"thumbs"===this.view&&this.initContactsThumbs();this.initOperationsMenu();"segment"===this.context.type?this.initSegmentContext():"search"===this.context.type&&this.initCreateFilterLink();this.$wrapper.on("click",".pager a",function(){d(this).replaceWith('<i class="icon16 loading"></i>');d(document).one("wa_loaded",function(){d("html, body").scrollTop(0)})});
this.initTableSlider();this.initHoverNames();this.initDroppable()};CRMContactsPage.prototype.initEditableName=function(a,b){var c=this.$wrapper.find(".js-name-editable").first();if(!(0>=c.length)){var e=this,f=!1,g=null;new CrmEditable({$wrapper:c,onSave:function(c){var h=c.$field.val();h.length&&c.text!==h?(g&&g.abort(),h={id:b.info.id,name:h},c.$field.attr("disabled",!0),f||(f=d('<i class="icon16 loading"></i>').css("margin","0 0 0 4px").insertAfter(c.$field)),g=d.post(a,h,function(a){a&&a.data&&
a.data.segment&&(c.text=a.data.segment.name,c.$wrapper.text(a.data.segment.name),e.sidebar.updateItem(b,{name:a.data.segment.name}))},"json").always(function(){c.$field.attr("disabled",!1);c.toggle("hide");f.length&&(f.remove(),f=!1)})):(h.length||c.$field.val(c.text),c.toggle("hide"))}})}};CRMContactsPage.prototype.initElastic=function(){var a=this.$wrapper,b=this.$wrapper.find("#js-aside-block"),c=this.$content;new CRMElasticBlock({$wrapper:a,$aside:b,$content:c});new CRMElasticBlock({$wrapper:a,
$content:b,$aside:c})};CRMContactsPage.prototype.initContactsColumnsSection=function(){function a(b){if(d.contains(document,e[0])){var f=e.hasClass("is-active");b=d.contains(e[0],b.target);f&&!b&&c()}else d(document).off("click",a)}function b(a){a.preventDefault();h||(h=!0,a=d.crm.app_url+"?module=contact&action=columns",f.html(g),c(!0),d.post(a,{},function(a){f.html(a)}).always(function(){h=!1}))}function c(a){a?e.addClass("is-active"):e.removeClass("is-active")}var e=this.$wrapper.find(".js-contacts-columns-section"),
f=e.find(".js-load-here"),g=f.html(),h=!1;e.on("click",".js-show-contact-columns-dialog",function(a){e.hasClass("is-active")?c(!1):b(a)});d(document).on("click",a);e.on("close",function(){c(!1)})};CRMContactsPage.prototype.initContactsTable=function(){var a=this;(function(){a.$wrapper.find(".js-width-toggle-wrapper").each(function(){var a=d(this),c=a.data("fullColumnId");a.on("click",".js-set-width",function(){var a=d(this).data("id");d.post(d.crm.app_url+"?module=contactColumns&action=saveWidth",
{width:a,full_column_id:c},function(){d.crm.content.reload()})})})})()};CRMContactsPage.prototype.initContactsThumbs=function(){};CRMContactsPage.prototype.initOperationsMenu=function(){new CRMContactsOperations({$wrapper:this.$wrapper,total_count:this.total_count,page_count:this.page_count,context:this.context,sidebar:this.sidebar,is_admin:this.is_admin,view:this.view})};CRMContactsPage.prototype.initSegmentContext=function(){var a=this.$wrapper;this.initSegmentLinks();this.sidebar.updateItem(this.context,
{count:this.context.info.count});var b=d.crm.storage.get("crm/create/category")||{},c=+new Date;d.crm.storage.del("crm/create/category");"category"===this.context.info.type&&(a=a.find(".js-segment-add-contacts"),b.id==this.context.info.id&&3E4>=c-b.timestamp&&a.click())};CRMContactsPage.prototype.initSegmentLinks=function(){function a(a){a.preventDefault();f&&f.abort();f=d.post(d.crm.app_url+"?module=contactSegment&action=addContacts",{id:b.context.info.id},function(a){new CRMDialog({html:a})}).always(function(){f=
!1})}var b=this,c=b.$wrapper.find(".js-segment-actions-list"),e=!1,f=!1;c.on("click",".js-show-edit-dialog",function(a){a.preventDefault();f&&f.abort();f=d.post(d.crm.app_url+"?module=contactSegment&action=edit",{id:b.context.info.id},function(a){new CRMDialog({html:a})}).always(function(){f=!1})});c.on("click",".js-show-archive-dialog",function(a){a.preventDefault();if(!e){e=!0;var c=d(this).closest(".crm-segment-archive-li"),f=c.hasClass("archived");c.removeClass("archived not-archived").addClass("loading");
d.post(d.crm.app_url+"?module=contactSegment&action=archive",{id:b.context.info.id,archive:f?0:1},function(){c.addClass(f?"not-archived":"archived")}).always(function(){c.removeClass("loading");e=!1})}});c.on("click",".js-show-delete-confirm",function(){function a(){d.post(d.crm.app_url+"?module=contactSegment&action=delete",{id:b.context.info.id},function(a){"ok"===a.status&&d.crm.content.load(d.crm.app_url+"contact/")}).always(function(){e=!1})}e||(e=!0,d.crm.confirm.show({title:b.locales.delete_segment_title,
text:b.locales.delete_segment_text,button:b.locales.delete_segment_button,onConfirm:a}))});c.on("click","a",function(){c.hide();setTimeout(function(){c.removeAttr("style")},200)});if("category"===b.context.info.type)c.on("click",".js-segment-add-contacts",a)};CRMContactsPage.prototype.initCreateFilterLink=function(){var a=this.$wrapper;a.find(".crm-create-filter-link").click(function(b){b.preventDefault();var c=d(this).data("hash");b=d.crm.app_url+"?module=contactSegment&action=edit";c={type:"search",
hash:c,name:a.find(".crm-contact-list-name").text()};d.get(b,c).done(function(a){new CRMDialog({html:a})})})};CRMContactsPage.prototype.initTableSlider=function(){function a(){d.contains(document,g[0])?(q=g.outerWidth(),r=h.outerWidth(),b(),u&&(u=!1,t=0,e(t))):d(window).off("resize",a)}function b(){if(r>q){var a=t+q>=r,b=t+q<r;0<t?a?(p.addClass("is-active"),n.removeClass("is-active")):b&&(p.addClass("is-active"),n.addClass("is-active")):(p.removeClass("is-active"),n.addClass("is-active"))}else p.removeClass("is-active"),
n.removeClass("is-active")}function c(a){var c=q/3;a?(a=t+c,a>r-q&&(a=r-q)):(a=t-c,0>a&&(a=0));t=a;u=!0;e(a);b()}function e(a){var b="-"+a+"px";h.data("isLeftSet",0<a);h.css({"-webkit-transform":"translate("+b+",0)",transform:"translate("+b+",0)"});l.css({"-webkit-transform":"translate("+b+",0)",transform:"translate("+b+",0)"})}var f=this,g=f.$wrapper.find(".js-contacts-section");if(!g.length)return!1;var h=g.find(".js-slider-body"),k=g.find(".js-header-table-wrapper"),l=k.find(".js-header-table"),
m=g.find(".js-arrows-wrapper"),p=m.find(".js-arrow-left"),n=m.find(".js-arrow-right"),q=g.outerWidth(),r=h.outerWidth(),u=!1,t=0;b();(function(){function a(){if(d.contains(document,c[0])){var h=b.scrollTop()>e.top,l=f.$content.height()>b.height();h&&l?(k.css({left:e.left}).width(g.outerWidth()).addClass("is-fixed"),c.addClass("is-fixed")):(k.removeAttr("style").removeClass("is-fixed"),c.removeClass("is-fixed"))}else b.off("scroll",a)}var b=d(window),c=m,e=g.offset();b.on("scroll",a)})();p.on("click",
function(){c(!1)});n.on("click",function(){c(!0)});d(window).on("resize",a)};CRMContactsPage.prototype.initHoverNames=function(){function a(){g=setTimeout(function(){c.removeClass("is-shown").html("")},500)}var b=this.$wrapper.find(".js-contacts-section");if(!b.length)return!1;var c=b.find(".c-hint-wrapper"),e=this.$wrapper.find(".js-contacts-table"),f=e.offset(),g=0;e.on("mouseenter","tr",function(){var a=d(this);if(e.data("isLeftSet")){clearTimeout(g);var b=a.find(".c-name").html(),a=a.find("td:first").offset();
c.html(b).css({top:a.top+10-(f.top-28),left:10}).addClass("is-shown")}});e.on("mouseleave","tr",function(){a()});c.on("mouseenter",function(){clearTimeout(g)});c.on("mouseleave",a)};CRMContactsPage.prototype.initDroppable=function(){function a(a,e){d.post(d.crm.app_url+"?module=contactSegment&action=addContactsSave",{id:a,contact_id:e},"json").done(function(c){"ok"===c.status&&c.data.segment&&b.sidebar.updateItem({type:"segment",info:{id:a}},{count:c.data.segment.count})})}var b=this;b.$wrapper.find(".js-sidebar").find(".js-segment-droparea").each(function(){var b=
d(this);b.droppable({tolerance:"pointer",hoverClass:"is-hovered",over:function(a,c){c.draggable.hasClass("ui-draggable")||b.removeClass("is-hovered")},drop:function(b,c){var e=d(this).data("id"),f=[],k=c.helper.data("user-id"),l=""+c.helper.data("user-ids");k?f.push(k):l&&(0<l.indexOf(",")?f=l.split(","):f.push(l));0<e&&0<f.length&&a(e,f)}})})};return CRMContactsPage}(jQuery),CRMContactsColumnsDialog=function(d){CRMContactsColumnsDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");
this.$activeList=this.$wrapper.find(".js-active-list");this.$unactiveList=this.$wrapper.find(".js-unactive-list");this.initClass()};CRMContactsColumnsDialog.prototype.initClass=function(){this.initSubmit();this.initSort();this.initComboList();this.$wrapper.on("click",".js-close-dialog",function(){d(this).closest(".js-contacts-columns-section").trigger("close")})};CRMContactsColumnsDialog.prototype.initSubmit=function(){function a(){if(!e){e=!0;var a=d.crm.app_url+"?module=contactColumns&action=save",
c=b();d.post(a,c,function(a){"ok"===a.status?d.crm.content.reload():alert("Error")}).always(function(){e=!1})}}function b(){var a=c.serializeArray();d.each(a,function(a,b){b.value=a+1});return a}var c=this.$form,e=!1;c.on("submit",function(b){b.preventDefault();a()})};CRMContactsColumnsDialog.prototype.initSort=function(){this.$activeList.sortable({distance:10,handle:".c-toggle",helper:"clone",items:".js-item",axis:"y"})};CRMContactsColumnsDialog.prototype.initComboList=function(){var a=this;a.$activeList.on("change",
".c-field",function(){var b=d(this),c=b.closest(".js-item");"checked"===b.attr("checked")?c.appendTo(a.$activeList):c.appendTo(a.$unactiveList)});a.$unactiveList.on("change",".c-field",function(){var b=d(this),c=b.closest(".js-item");"checked"===b.attr("checked")?c.appendTo(a.$activeList):c.appendTo(a.$unactiveList)})};return CRMContactsColumnsDialog}(jQuery),CRMThumbContact=function(d){CRMThumbContact=function(a){this.$wrapper=a.$wrapper;this.user_id=this.$wrapper.data("user-id");this.can_be_drag=
a.can_be_drag;this.initClass()};CRMThumbContact.prototype.initClass=function(){this.can_be_drag&&this.initDraggable()};CRMThumbContact.prototype.initDraggable=function(){var a=d("#c-contacts-sidebar .js-segment-droparea");this.$wrapper.draggable({handle:".js-userpic",delay:200,cursorAt:{top:0,left:0},helper:function(){var a=d("#c-users-list .js-move-user.is-active").map(function(){return d(this).data("user-id")}).toArray();return 1<a.length?'<div id="c-users-helper" data-user-ids="'+a.join(",")+'"><span class="indicator red">'+
a.length+"</span></div>":d(this).clone().addClass("is-clone")},start:function(){a.length&&a.addClass("c-drop-here")},stop:function(b,c){var d=c.helper,f=d.clone();f.insertAfter(d).fadeOut(270);setTimeout(function(){f.remove()},300);a.length&&a.removeClass("c-drop-here")}})};return CRMThumbContact}(jQuery),CRMTableContact=function(d){CRMTableContact=function(a){this.$wrapper=a.$wrapper;this.user_id=this.$wrapper.data("user-id");this.can_be_drag=a.can_be_drag;this.initClass()};CRMTableContact.prototype.initClass=
function(){this.can_be_drag&&this.initDraggable()};CRMTableContact.prototype.initDraggable=function(){var a=this,b=d("#c-contacts-sidebar .js-segment-droparea"),c=d(".js-contacts-table .js-move-user");a.$wrapper.draggable({helper:function(){var b=[],f="";c.filter(".is-active").each(function(){var a=d(this).data("user-id");a&&b.push(a)});1>=b.length?(b.push(a.user_id),f=a.$wrapper.find(".userpic")[0].outerHTML,f='<div id="c-users-helper" data-user-ids="'+b.join(",")+'">'+f+"</div>"):f='<div id="c-users-helper" data-user-ids="'+
b.join(",")+'"><span class="indicator red">'+b.length+"</span></div>";return f},appendTo:"body",delay:200,cursorAt:{top:0,left:0},start:function(a,c){c.helper.addClass("is-clone");b.length&&b.addClass("c-drop-here")},stop:function(a,c){var d=c.helper,e=d.clone();e.insertAfter(d).fadeOut(270);setTimeout(function(){e.remove()},300);b.length&&b.removeClass("c-drop-here")}})};return CRMTableContact}(jQuery);var CRMContactsSidebar=function(d){CRMContactsSidebar=function(a){this.$wrapper=a.$wrapper;this.$segmentsLists=this.$wrapper.find(".c-segment-list");this.$add_new_segment_link=this.$wrapper.find(".c-create-new-segment");this.is_admin=a.is_admin;this.initClass()};CRMContactsSidebar.prototype.initClass=function(){this.initSortable();this.initAddLink();this.initAddNewSegmentLink();this.initHighlight();this.initSelectedLink();this.initArchivedToggles();this.initScrollTopOnClick()};CRMContactsSidebar.prototype.initSortable=
function(){function a(a){return a.find("> li").map(function(){var a=parseInt(d(this).data("id"),10);return 0<a?a:!1}).toArray()}function b(a,b){g&&(g.abort(),g=!1);g=d.post(a,b,function(){g=!1})}var c=this,e=d.crm.app_url+"?module=contact&action=sortSave",f,g=!1;c.$segmentsLists.each(function(){var g=d(this),k=g.data("shared")?1:0;!c.is_admin&&k||g.sortable({distance:10,items:"> li:not(.sort-disabled)",axis:"y",delay:200,tolerance:"pointer",start:function(a,b){f=b.item.index()},stop:function(c,d){d.item.removeAttr("style");
if(f!=d.item.index()){var h=a(g);b(e,{segments:h,shared:k})}}})})};CRMContactsSidebar.prototype.initAddLink=function(){var a=!1,b=this.$wrapper.find(".js-add-link"),c=b.find(".icon16"),e=c.attr("class");b.on("click",function(){if(!a){a=!0;var b=d.crm.app_url+"?module=contact&action=add";c.attr("class","icon16 loading");d.post(b,{},function(a){new CRMDialog({html:a})}).always(function(){a=!1;c.attr("class",e)})}})};CRMContactsSidebar.prototype.initAddNewSegmentLink=function(){var a=this.$add_new_segment_link;
a.click(function(b){b.preventDefault();d.get(d.crm.app_url+"?module=contactSegment&action=edit").done(function(a){new CRMDialog({html:a})}).always(function(){a.find(".icon16").hide()})})};CRMContactsSidebar.prototype.updateItem=function(a,b){if("segment"===a.type){var c=this.$segmentsLists.find('li[data-id="'+a.info.id+'"]');c.length&&(void 0!==b.name&&c.find(".name").text(b.name||""),void 0!==b.count&&c.find(".count").text(b.count||""))}};CRMContactsSidebar.prototype.initHighlight=function(a,b){var c=
d(".all-contacts-link");this.$wrapper.find('a[href^="'+d.crm.app_url+'"]').each(function(a,b){if(location.pathname==b.pathname){var e=d(b),f=e.closest("li");f.length||(f=e);c.removeClass("selected");f.addClass("selected");return!1}c.addClass("selected")})};CRMContactsSidebar.prototype.initSelectedLink=function(){var a=this;sessionStorage.getItem("selected_contacts")||sessionStorage.setItem("selected_contacts","[]");var b=this.$wrapper.find(".js-selected-contacts"),c=b.find(".count"),e=sessionStorage.getItem("selected_contacts");
if(e=JSON.parse(e).length)c.text(e),b.removeClass("js-selected-contacts-hidden");b.on("click",function(b){b.preventDefault();b=d.crm.app_url+"?module=contact&action=selected";var c=sessionStorage.getItem("selected_contacts");d.post(b,{selected_ids:c},function(b){b&&(history.pushState(null,null,d.crm.app_url+"contact/selected/"),d(document).find("#c-content-block").html(b),a.initHighlight())})})};CRMContactsSidebar.prototype.initArchivedToggles=function(){this.$segmentsLists.find(".c-archived-section").each(function(){function a(a){a?
b.addClass("is-shown"):b.removeClass("is-shown")}var b=d(this);b.on("click",".js-show-list",function(){a(!0)});b.on("click",".js-hide-list",function(){a(!1)})})};CRMContactsSidebar.prototype.initScrollTopOnClick=function(){this.$wrapper.on("click","a:not(.js-add-link)",function(){var a=d(this),b=!a.hasClass("js-stop-scroll");a.find(".icon16").attr("class","icon16 loading").attr("style","");b&&d(window).scrollTop(0)})};return CRMContactsSidebar}(jQuery);
CRMContactsSidebar.initCollapsibleSidebar=function(){$.each(["mylists-my","tags","vaults","responsibles","admin"],function(){1==localStorage.getItem("collapsible_sidebar_"+this)&&($("#collapsible-"+this).find(".collapsible").css({display:"none"}),$("#collapsible-"+this).find(".icon16").removeClass("darr").addClass("rarr"))});$(".c-contacts-sidebar").on("click",".collapse-handler",function(){var d=$(this).parents(".block").data("block"),a=$(this).parents(".block"),b=$(a).find(".icon16"),a=$(a).find(".collapsible");
a.is(":visible")?($(a).css({display:"none"}),$(b).removeClass("darr").addClass("rarr"),localStorage.setItem("collapsible_sidebar_"+d,1)):($(a).css({display:""}),$(b).removeClass("rarr").addClass("darr"),localStorage.setItem("collapsible_sidebar_"+d,0))})};var CRMContactsOperations=function(d){CRMContactsOperations=function(a){this.$wrapper=a.$wrapper;this.$bar=this.$wrapper.find(".js-operations-wrapper");this.$list=this.$wrapper.find(".js-contacts-list");this.$list_header=this.$list.find(".c-list-header");this.$checkbox_all=this.$wrapper.find(".js-checkbox-all");this.$content=this.$wrapper.find("#js-content-block");this.$selected_link=this.$wrapper.find(".js-selected-contacts");this.$selected_count=this.$selected_link.find(".count");this.$remove_from_selected_list=
this.$bar.find('[data-id="remove_from_selected_list"]');this.page=a.page||1;this.limit=a.limit||30;this.total_items_at_page_count=this.getTotalItemsAtPage()||0;this.total_count=a.total_count||0;this.page_count=a.page_count||0;this.context=a.context||{};this.selected_page=d(document).find("#contact_selected_page").length;this.is_category_segment="segment"===this.context.type&&this.context.info&&"category"===this.context.info.type;this.view=a.view||"";this.sidebar=a.sidebar||null;this.checked_count=
0;this.is_shown=0<this.checked_count;this.is_checked_all=!1;this.initClass()};CRMContactsOperations.prototype.initClass=function(){this.initCheckboxAll();this.initOperations();this.initItemCheckbox();this.initElasticHeader();0<this.selected_page&&this.$remove_from_selected_list.show()};CRMContactsOperations.prototype.initCheckboxAll=function(){var a=this;a.$checkbox_all.click(function(){var b=d(this),c=b.is(":checked");0<a.checked_count?a.unselectAll():(b.prop("checked",c),c?a.selectAll():a.unselectAll());
a.formBar();a.showOrHideBar()})};CRMContactsOperations.prototype.initOperations=function(){var a=this;a.$bar.on("click",".crm-operation-link",function(b){b.preventDefault();switch(d(this).data("id")){case "add_to_segments":a.addToSegmentsOperation();break;case "export":a.exportOperation();break;case "merge":a.mergeOperation();break;case "delete":a.deleteOperation();break;case "exclude_from_list":a.excludeFromListOperation();break;case "assign_tags":a.assignTagsOperation();break;case "assign_responsible":a.assignResponsibleOperation();
break;case "remove_from_selected_list":a.removeFromSelectedListOperation()}})};CRMContactsOperations.prototype.showBar=function(){this.is_shown||(this.$bar.addClass("is-shown"),this.$list_header.removeClass("is-shown"),this.is_shown=!0)};CRMContactsOperations.prototype.hideBar=function(){this.is_shown&&(this.$bar.removeClass("is-shown"),this.$list_header.addClass("is-shown"),this.is_shown=!1)};CRMContactsOperations.prototype.updateBarCount=function(){this.$bar.find(".crm-count").text("("+this.checked_count+
")")};CRMContactsOperations.prototype.showOrHideBar=function(){0<this.checked_count?(this.showBar(),this.updateBarCount()):this.hideBar()};CRMContactsOperations.prototype.getSelectedContactList=function(){var a=sessionStorage.getItem("selected_contacts");return a?JSON.parse(a):null};CRMContactsOperations.prototype.setSelectedContacts=function(){this.getSelectedContactList()||sessionStorage.setItem("selected_contacts","[]");if(!(0<this.selected_page)){var a=this.getSelectedContactList(),b=this.getSelectedContactIds();
d.each(b,function(b,e){0>d.inArray(e,a)&&(a[a.length]=e)});sessionStorage.setItem("selected_contacts",JSON.stringify(a));this.showOrHideSelectedLink()}};CRMContactsOperations.prototype.delSelectedContact=function(a){var b=this.getSelectedContactList();a=b.indexOf(a);b.splice(a,1);sessionStorage.setItem("selected_contacts",JSON.stringify(b));this.showOrHideSelectedLink()};CRMContactsOperations.prototype.updateSelectedCount=function(){var a=this.getSelectedContactList().length;this.$selected_count.text(a)};
CRMContactsOperations.prototype.showOrHideSelectedLink=function(){this.updateSelectedCount();this.getSelectedContactList().length?this.showSelectedLink():this.hideSelectedLink()};CRMContactsOperations.prototype.showSelectedLink=function(){this.$selected_link.removeClass("js-selected-contacts-hidden")};CRMContactsOperations.prototype.hideSelectedLink=function(){this.$selected_link.addClass("js-selected-contacts-hidden")};CRMContactsOperations.prototype.getSelectedContactIds=function(){return this.$list.find(".c-checkbox :checkbox:checked").map(function(){return d(this).val()}).toArray()};
CRMContactsOperations.prototype.getTotalItemsAtPage=function(){return this.page*this.limit>this.total_count?this.total_count%this.limit:this.limit};CRMContactsOperations.prototype.formBar=function(){var a=this.$bar.find('.crm-operation-li[data-id="merge"]'),b=this.$bar.find('.crm-operation-li[data-id="delete"]'),c=this.$bar.find('.crm-operation-li[data-id="assign_responsible"]'),d=this.$bar.find('.crm-operation-li[data-id="exclude_from_list"]');1>=this.checked_count||this.checked_count>this.page_count?
a.hide():a.show();this.checked_count>this.page_count?b.hide():b.show();this.checked_count>this.page_count?c.hide():c.show();this.is_category_segment&&this.context.can_edit?d.show():d.hide()};CRMContactsOperations.prototype.initItemCheckbox=function(){function a(a){var c=a.find(".js-checkbox"),d=c.is(":checked"),c=c.val();d?a.addClass("is-active"):a.removeClass("is-active");b.is_checked_all?(b.is_checked_all=!1,b.checked_count=b.$list.find(".c-checkbox :checkbox:checked").length):d?b.checked_count+=
1:--b.checked_count;b.formBar();b.showOrHideBar();b.showOrHideSelectedLink();0<b.selected_page||(d?b.setSelectedContacts():b.delSelectedContact(c))}var b=this;b.$list.on("change",".js-checkbox",function(c,e){var f=d(this),g=f.closest(".js-contact-wrapper");"undefined"!==typeof e&&f.attr("checked",e);a(g);0<b.checked_count?b.checked_count<b.limit&&b.checked_count!==b.total_items_at_page_count?b.$checkbox_all.prop("indeterminate",!0):b.$checkbox_all.prop("indeterminate",!1).prop("checked",!0):b.$checkbox_all.prop("indeterminate",
!1).prop("checked",!1)});b.$list.on("click",".js-contact-wrapper",function(a){var b=d(a.target);a=!(!b.is("a")&&!b.closest("a").length);b=b.is(":checkbox");a||(a=d(this),b||(a=a.find(".js-checkbox"),a.trigger("change",[!a.is(":checked")])))});b.$list.shiftSelectable({selector:".js-contact-wrapper",behavior_type:"thumbs"===b.view?"mixed":"vertical",onSelect:function(b,e){var c=d(e.target),c=!(!c.is("a")&&!c.closest("a").length),g=e.extra.is_first,h=e.extra.is_last;c||g||h||(b.find(".js-checkbox").attr("checked",
!0),a(b))}})};CRMContactsOperations.prototype.removeFromSelectedListOperation=function(){var a=this,b=a.$list.find(".c-checkbox :checkbox:checked");d.each(b,function(){a.delSelectedContact(this.value);d(this).parents(".js-contact-wrapper").remove()});a.$checkbox_all.prop("checked",!1);a.checked_count=0;a.is_checked_all=!1;a.showOrHideBar();a.getSelectedContactList().length||(b=a.$wrapper.find(".js-header-table-wrapper"),a.$wrapper.find(".c-no-contacts").removeClass("hidden"),b.remove())};CRMContactsOperations.prototype.selectAll=
function(){this.$list.find(".c-checkbox :checkbox").prop("checked",!0).trigger("change",[!0]);this.checked_count=this.total_count;this.is_checked_all=!0;this.setSelectedContacts()};CRMContactsOperations.prototype.unselectAll=function(){this.$list.find(".c-checkbox :checkbox").prop("checked",!1).trigger("change",[!1]);this.$checkbox_all.prop("checked",!1);this.checked_count=0;this.is_checked_all=!1};CRMContactsOperations.prototype.getSelectedContext=function(){var a=d.extend({total_count:this.total_count,
page_count:this.page_count,checked_count:this.checked_count,is_checked_all:this.is_checked_all?1:0,contact_ids:null},this.context);a.is_checked_all||(a.contact_ids=this.getSelectedContactIds());return a};CRMContactsOperations.prototype.addToSegmentsOperation=function(){var a=this;d.get(d.crm.app_url+"?module=contactOperation&action=addToSegments",function(b){new CRMDialog({html:b,onOpen:function(b){new CRMContactsOperationAddToSegments({$wrapper:b,context:a.getSelectedContext(),sidebar:a.sidebar})}})})};
CRMContactsOperations.prototype.exportOperation=function(){var a=this,b=d.crm.app_url+"?module=contactOperation&action=export",c=a.getSelectedContext().checked_count;d.get(b,{checked_count:c},function(b){new CRMDialog({html:b,onOpen:function(b){new CRMContactsOperationExport({$wrapper:b,context:a.getSelectedContext()})}})})};CRMContactsOperations.prototype.mergeOperation=function(){if(!(1>=this.checked_count||this.checked_count>this.page_count)){var a=this.getSelectedContactIds().join(",");d.crm.content.load(d.crm.app_url+
"contact/merge/?ids="+a)}};CRMContactsOperations.prototype.deleteOperation=function(){if(!(this.checked_count>this.page_count)){var a=d.crm.app_url+"?module=contactOperation&action=delete",b=this.$wrapper,c=this.getSelectedContext(),b=b.find(".crm-contact-operation-delete-checking").clone();new CRMDialog({html:b.show(),onOpen:function(b){var e=this;b.find(".crm-cancel").click(function(){e.close()});d.get(a,c,function(a){new CRMDialog({html:a,onOpen:function(){e.close()}})})}})}};CRMContactsOperations.prototype.excludeFromListOperation=
function(){var a=this;if(a.is_category_segment){var b=d.crm.app_url+"?module=contactOperation&action=excludeFromSegment",c=a.getSelectedContext();d.get(b,{id:a.context.info.id,checked_count:c.checked_count},function(b){new CRMDialog({html:b,onOpen:function(b){new CRMContactsOperationExcludeFromSegment({$wrapper:b,segment:a.context.info,context:a.getSelectedContext(),sidebar:a.sidebar})}})})}};CRMContactsOperations.prototype.assignTagsOperation=function(){var a=d.crm.app_url+"?module=contactOperation&action=assignTags",
b=d.extend({},this.getSelectedContext(),!0);b.is_checked_all||1!=b.checked_count||(a+="&is_assign=1");d.post(a,b,function(a){new CRMDialog({html:a})})};CRMContactsOperations.prototype.assignResponsibleOperation=function(){var a=d.crm.app_url+"?module=contactOperation&action=assignResponsible",b=d.extend({},this.getSelectedContext(),!0);d.post(a,b,function(a){new CRMDialog({html:a})})};CRMContactsOperations.prototype.initElasticHeader=function(){function a(){if(d.contains(document,g[0])){var b=e.scrollTop()>
h.top,f=c.$content.height()>e.height();b&&f?(g.addClass("is-fixed").css({left:h.left,width:k}),l=!0):(g.removeClass("is-fixed").removeAttr("style"),l=!1)}else e.off("scroll",a)}function b(){d.contains(document,g[0])?(k=f.outerWidth(),l&&g.width(k)):e.off("resize",b)}var c=this,e=d(window),f=c.$wrapper.find(".js-contacts-section"),g=c.$bar,h=f.offset(),k=g.outerWidth(),l=!1;e.on("scroll",a).on("resize",b)};return CRMContactsOperations}(jQuery);var CRMContactsOperationAddToSegments=function(d){CRMContactsOperationAddToSegments=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".js-save");this.$add_new_link=this.$wrapper.find(".crm-add-new-segment-link");this.context=a.context||{};this.dialog=this.$wrapper.data("dialog");this.url=d.crm.app_url+"?module=contactOperation&action=addToSegments";this.is_assign=a.is_assign?1:0;this.onSave=a.onSave||null;this.sidebar=a.sidebar||null;this.initClass()};CRMContactsOperationAddToSegments.prototype.initClass=
function(){this.is_assign||this.initButton();this.initSave();this.initAddNewLink()};CRMContactsOperationAddToSegments.prototype.initButton=function(){var a=this,b=function(){0<a.$wrapper.find('[name="segment[]"]:checked').length?a.$button.attr("disabled",!1):a.$button.attr("disabled",!0)};a.$wrapper.on("click",'[name="segment[]"]',b);b()};CRMContactsOperationAddToSegments.prototype.initSave=function(){var a=this,b=a.$button,c=a.$wrapper.find(".crm-loading"),e=d.crm.app_url+"?module=contactOperation&action=addToSegmentsProcess",
f=[],g=d.extend({},a.context,!0);g.is_assign=a.is_assign?1:0;var h=function(e){c.hide();b.attr("disabled",!1);a.sidebar&&d.each(e.segments||{},function(b,c){a.sidebar.updateItem({type:"segment",info:{id:c.id}},c)});g.is_assign?d.crm.content.reload():1==f.length?d.crm.content.load(d.crm.app_url+"contact/segment/"+f[0]+"/"):d.crm.content.load(d.crm.app_url)},k=function(a){a=d.extend({offset:a||0},g);d.post(e,a).done(function(a){"ok"==a.status&&(a.data.done?h(a.data):k(a.data.offset||0))})};b.click(function(e){e.preventDefault();
c.show();b.attr("disabled",!0);f=a.$wrapper.find('[name="segment[]"]:checked').map(function(){return d(this).val()}).toArray();g=d.extend({segment_ids:f},g);a.onSave&&!1===a.onSave(g,a.$wrapper)||k()})};CRMContactsOperationAddToSegments.prototype.reloadDialog=function(a){var b=this;d.get(b.url,function(c){b.dialog=new CRMDialog({html:c,onOpen:function(c){a&&a(c);new CRMContactsOperationAddToSegments({$wrapper:c,context:b.context,sidebar:b.sidebar,onSave:b.onSave})}})})};CRMContactsOperationAddToSegments.prototype.initAddNewLink=
function(){var a=this;a.$add_new_link.click(function(b){b.preventDefault();a.$wrapper.find(".crm-add-new-segment-loading").show();d.get(d.crm.app_url+"?module=contactSegment&action=edit").done(function(b){a.dialog.close();var c=new CRMDialog({html:b,onOpen:function(b){b.find(".js-close-dialog").hide();b.find(".crm-cancel-link").show().click(function(){b.find(".crm-cancel-loading").show();a.reloadDialog(function(){c.close()})})},options:{afterSave:function(b){a.reloadDialog(function(a){c.close();b.data.segment&&
a.find('input[name="segment[]"][value="'+b.data.segment.id+'"]').prop("checked",!0)});return!1}}})})})};return CRMContactsOperationAddToSegments}(jQuery);var CRMContactsOperationExcludeFromSegment=function(d){CRMContactsOperationExcludeFromSegment=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".js-save");this.$add_new_link=this.$wrapper.find(".crm-add-new-segment-link");this.context=a.context||{};this.segment=a.segment||{};this.dialog=this.$wrapper.data("dialog");this.sidebar=a.sidebar||null;this.initClass()};CRMContactsOperationExcludeFromSegment.prototype.initClass=function(){this.initStartExclude()};CRMContactsOperationExcludeFromSegment.prototype.initStartExclude=
function(){var a=this,b=a.$button,c=d.crm.app_url+"?module=contactOperation&action=excludeFromSegmentProcess",e=a.$wrapper.find(".crm-loading"),f=d.extend({},a.context);f.segment_id=a.segment.id;var g=function(h,k){var l=d.extend({offset:h||0,process_count:k||0},f);d.post(c,l).done(function(c){"ok"==c.status&&(c.data.done?(c=c.data,e.hide(),b.attr("disabled",!1),a.segment=c.segment,a.sidebar.updateItem({type:"segment",info:{id:a.segment.id}},a.segment),a.dialog.close(),d.crm.content.load(d.crm.app_url+
"contact/segment/"+a.segment.id+"/")):g(c.data.offset,c.data.process_count))})};b.click(function(a){a.preventDefault();e.show();b.attr("disabled",!0);g()})};return CRMContactsOperationExcludeFromSegment}(jQuery);var CRMContactsOperationExport=function(d){CRMContactsOperationExport=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".js-save");this.$cancel=this.$wrapper.find(".crm-js-cancel");this.$download_file_form=this.$wrapper.find(".crm-download-file-form");this.context=a.context||{};this.url=d.crm.app_url+"?module=contactOperationExport&action=process";this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMContactsOperationExport.prototype.initClass=function(){this.initStartExport()};
CRMContactsOperationExport.prototype.initStartExport=function(){var a=this,b=a.$button,c=a.$cancel,d=null;b.click(function(c){c.preventDefault();b.attr("disabled",!0);d=a.process()});c.click(function(a){a.preventDefault();d&&d.cancel()})};CRMContactsOperationExport.prototype.process=function(){var a=this,b=a.url,c=a.$wrapper,e=null,f=null,g=0,h=d.extend({},a.context,!0);h.separator=c.find("[name=separator]").val();h.encoding=c.find("[name=encoding]").val();h.export_fields_name=c.find("[name=export_fields_name]").is(":checked")?
1:0;h.not_export_empty_columns=c.find("[name=not_export_empty_columns]").is(":checked")?1:0;var k=function(){f&&clearTimeout(f);f=setTimeout(k,3200);!e||2<=g||(h.processId=e,d.post(b,h,function(b){g--;e&&b.ready&&(b=e)&&(f&&clearTimeout(f),e=f=null,a.$download_file_form.attr("action",d.crm.app_url+"?module=contactOperationExport&action=process&processId="+b).appendTo("body").submit(function(){setTimeout(function(){a.$download_file_form.appendTo(a.$wrapper.find(".crm-dialog-content"));a.dialog.close()},
200)}).submit())},"json"),g++)};a.$wrapper.find(".crm-start-block").hide();a.$wrapper.find(".crm-process-block").show();d.post(b,h,function(a){a.processId||alert("Error processing request.");e=a.processId;k()},"json");return{cancel:function(){f&&clearTimeout(f);d.post(b,{processId:e,ready:1})}}};return CRMContactsOperationExport}(jQuery);var CRMContactsOperationAssignTags=function(d){CRMContactsOperationAssignTags=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".js-save");this.$input=this.$wrapper.find(".crm-tags-input");this.context=a.context||{};this.dialog=this.$wrapper.data("dialog");this.default_text=this.$input.attr("placeholder");this.is_assign=a.is_assign||!1;this.initClass()};CRMContactsOperationAssignTags.prototype.initClass=function(){this.initTagsInput();this.initPopularTags();this.initSave()};CRMContactsOperationAssignTags.prototype.initTagsInput=
function(){var a=d.crm.app_url+"?module=contact&action=tags";this.$input.tagsInput({defaultText:this.default_text,width:this.$wrapper.find(".crm-dialog-content").width()-16,autocomplete_url:"",autocomplete:{html:!0,source:function(b,c){d.getJSON(a,{term:b.term},function(a){"ok"===a.status?c(a.data.tags||[]):c([])})}}})};CRMContactsOperationAssignTags.prototype.initPopularTags=function(){var a=this.$input;this.$wrapper.find(".crm-popular-tags").find(".crm-popular-tag-item-link").click(function(){var b=
d(this),b=d.trim(b.text());a.removeTag(b);a.addTag(b)})};CRMContactsOperationAssignTags.prototype.initSave=function(){var a=this,b=a.$button,c=a.$input,e=d.crm.app_url+"?module=contactOperation&action=assignTagsProcess",f=d.extend({},a.context,!0),g=a.$wrapper.find(".crm-loading");b.click(function(h){h.preventDefault();g.show();b.attr("disabled",!0);h=d("#"+c.attr("id")+"_tag");(h=d.trim(h.val()))&&h!==a.default_text&&c.addTag(h);f.tags=d.trim(c.val());f.is_assign=a.is_assign?1:0;var k=function(a){a=
d.extend({offset:a||0},f);d.post(e,a).done(function(a){"ok"==a.status&&(a.data.done?(g.hide(),b.attr("disabled",!1),d.crm.content.reload()):k(a.data.offset||0))})};k()})};return CRMContactsOperationAssignTags}(jQuery);var CRMContactsOperationAssignResponsible=function(d){CRMContactsOperationAssignResponsible=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$responsibleList=this.$wrapper.find(".js-responsible-list");this.$submitButton=this.$wrapper.find(".js-save");this.$close_dialog=a.Close_dialog;this.$errorh1=a.Error_h1;this.dialog=this.$wrapper.data("dialog");this.responsible_template_html=a.responsible_template_html;this.initClass()};CRMContactsOperationAssignResponsible.prototype.initClass=
function(){var a=this;a.$wrapper.on("change","input",function(){a.toggleButton(!0)});a.initSubmit();a.initAutocomplete()};CRMContactsOperationAssignResponsible.prototype.initSubmit=function(){function a(){if(!e){e=!0;var a=d.crm.app_url+"?module=contactOperation&action=assignResponsibleProcess",g=b();if(!g)return e=!1;var h=d('<i class="icon16 loading" style="vertical-align: middle; margin: 0;"></i>');h.appendTo(c.$submitButton.parent());c.$submitButton.attr("disabled",!0);var k=d("#responsible_id").val(),
l=k?d.crm.app_url+"contact/responsible/"+k+"/":d.crm.app_url+"contact/";d.post(a,g,function(a){"ok"===a.data.result?d.crm.content.reload().then(function(){c.dialog.close();d.crm.content.load(l)}):"no_vault_access"===a.data.result&&(d(".crm-dialog-header h1").html(c.$errorh1),d(".crm-dialog-content p, .js-responsible-list").html(""),d(".crm-dialog-footer").html('<a class="button js-close-dialog" href="javascript:void(0);">'+c.$close_dialog+"</a>"),d(".no-access-error").html(a.data.message),d.each(a.data.users,
function(a,b){d(".no-access-users").append('<a href="'+b.id+'" style="display: block; margin-top: 10px;"><i class="icon16 userpic20" style="background-image: url('+b.photo+');"></i><span>'+b.name+"</span></a>")}))},"json").always(function(){c.$submitButton.attr("disabled",!1);c.toggleButton(!1);h.remove();e=!1})}}function b(){var a=d("#responsible_id").val();return{contact_ids:d("#contact_ids").val(),responsible_id:a}}var c=this,e=!1;c.$form.on("submit",function(b){b.preventDefault();a()})};CRMContactsOperationAssignResponsible.prototype.initAutocomplete=
function(){function a(a){return d("<div></div>").text(a).html()}function b(a){a.addClass("highlighted");setTimeout(function(){a.removeClass("highlighted")},2E3)}var c=this,e=c.$responsibleList.find(".js-autocomplete");e.autocomplete({source:d.crm.app_url+"?module=autocomplete&type=user",appendTo:c.$wrapper,minLength:0,focus:function(){return!1},select:function(f,g){var h;h=c.$responsibleList.find('.c-responsible[data-id="'+g.item.id+'"]');h=h.length?h:void 0;if(!h){h=g.item;var k=c.responsible_template_html,
k=k.replace(/%id%/,h.id).replace("%name%",a(h.name)).replace("%photo_url%",h.photo_url);d("#responsible_id").val(h.id);h=d(k);c.$responsibleList.append(h);d(".js-input").css("display","none");c.$submitButton.attr("disabled",!1);c.toggleButton(!0)}b(h);c.toggleButton(!0);e.val("");return!1}}).data("ui-autocomplete")._renderItem=function(a,b){return d('<li class="ui-menu-item-html"><div>'+b.value+"</div></li>").appendTo(a)};e.on("focus",function(){e.data("uiAutocomplete").search(e.val())});c.$responsibleList.on("click",
".js-delete-responsible",function(){d(this).closest(".c-responsible").remove();d("#responsible_id").val("");d(".js-input").css("display","");d(".js-autocomplete").focus();c.$submitButton.attr("disabled",!0);c.toggleButton(!0)})};CRMContactsOperationAssignResponsible.prototype.toggleButton=function(a){var b=this.$submitButton;a?b.removeClass("green").addClass("yellow"):b.removeClass("yellow").addClass("green")};return CRMContactsOperationAssignResponsible}(jQuery);var CRMContactsOperationDelete=function(d){CRMContactsOperationDelete=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".crm-delete");this.context=a.context||{};this.dialog=this.$wrapper.data("dialog");this.is_contact_page=a.is_contact_page||0;this.initClass()};CRMContactsOperationDelete.prototype.initClass=function(){this.initStartDelete()};CRMContactsOperationDelete.prototype.initStartDelete=function(){var a=this,b=a.$button,c=d(".crm-loading",a.$wrapper),e=d.crm.app_url+"?module=contactOperation&action=deleteProcess",
f=d.extend({},a.context,!0);b.click(function(g){g.preventDefault();c.show();b.attr("disabled",!0);d.post(e,f).done(function(b){a.dialog.close();"ok"===b.status&&(a.is_contact_page?d.crm.content.load(d.crm.app_url+"contact/"):d.crm.content.reload(),d.crm.sidebar.reload())}).always(function(){c.hide();b.attr("disabled",!1)})})};return CRMContactsOperationDelete}(jQuery);var CRMContactSegmentEdit=function(d){CRMContactSegmentEdit=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$button=this.$form.find(":submit");this.$icons_block=this.$wrapper.find(".crm-icons-block");this.$icon_input=this.$wrapper.find("[name=icon]");this.segment=a.segment||{};this.messages=a.messages||{};this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMContactSegmentEdit.prototype.initClass=function(){this.initIcons();this.initSubmit();this.bindEvents();
0<this.segment.id&&this.initDeleteLink()};CRMContactSegmentEdit.prototype.initIcons=function(){var a=this;a.$icons_block.on("click","li a",function(b){b.preventDefault();b=d(this).closest("li");var c=b.data("icon");a.$icons_block.find("li.selected").removeClass("selected");a.$icon_input.val(c);b.addClass("selected");a.clearValidateErrors()})};CRMContactSegmentEdit.prototype.bindEvents=function(){var a=this,b=a.$form,c=null;b.on("change",":input",function(){a.clearValidateErrors()});b.on("keyup",":input",
function(){c&&clearTimeout(c);c=setTimeout(function(){a.clearValidateErrors()},200)})};CRMContactSegmentEdit.prototype.showValidateErrors=function(a){var b=this.$form;d.each(a||{},function(a,d){b.find(':input[name="'+a+'"]').addClass("error").after('<em class="errormsg">'+d+"</em>")})};CRMContactSegmentEdit.prototype.clearValidateErrors=function(){var a=this.$form;a.find(".error").removeClass("error");a.find(".errormsg").remove()};CRMContactSegmentEdit.prototype.initSubmit=function(){var a=this,b=
a.$form,c=b.find(".crm-loading"),e=a.$button;b.submit(function(f){f.preventDefault();a.clearValidateErrors();e.attr("disabled",!0);c.show();d.post(b.attr("action"),b.serialize()).done(function(b){if("ok"!==b.status)e.attr("disabled",!1),c.hide(),a.showValidateErrors(b.errors||{});else if(!a.dialog.options.afterSave||!1!==a.dialog.options.afterSave(b))a:if(b.data.segment){var f="search"==a.segment.type,g="category"===b.data.segment.type?"category":"search",l=b.data.segment.id;if(0>=a.segment.id){if("search"===
g&&!f){d.crm.content.load(d.crm.app_url+"contact/search/segment/"+b.data.segment.id+"/");break a}d.crm.storage.set("crm/create/category",{id:l,timestamp:+new Date})}d.crm.content.load(d.crm.app_url+"contact/segment/"+b.data.segment.id+"/")}})})};CRMContactSegmentEdit.prototype.initDeleteLink=function(){var a=this,b=a.$wrapper.find(".crm-delete-link"),c=null,e=d.crm.app_url+"?module=dialogConfirm",f=null,g=d.crm.app_url+"?module=contactSegment&action=delete";b.click(function(b){b.preventDefault();
c&&c.abort();c=d.post(e,{title:a.messages.delete_confirm_title,text:a.messages.delete_confirm_text,ok_button:a.messages.delete_button}).done(function(b){a.dialog.close();new CRMDialog({html:b,onConfirm:function(){f&&f.abort();f=d.post(g,{id:a.segment.id}).done(function(a){"ok"===a.status&&d.crm.content.load(d.crm.app_url+"contact/")}).always(function(){f=null});return!1}})}).always(function(){c=null})})};return CRMContactSegmentEdit}(jQuery);var CRMContactSegmentAddContacts=function(d){CRMContactSegmentAddContacts=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$button=this.$form.find(".js-submit-button");this.$find_contact=this.$wrapper.find(".js-find-contact");this.$contact_list=this.$wrapper.find(".c-contact-list");this.segment=a.segment||{};this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMContactSegmentAddContacts.prototype.initClass=function(){this.initAutocomplete();this.initDeleteLinks();
this.initSubmit()};CRMContactSegmentAddContacts.prototype.initAutocomplete=function(){var a=this.$find_contact,b=this.$contact_list,c=b.find(".is-template");a.autocomplete({source:"?module=autocomplete",minLength:2,focus:function(){return!1},select:function(d,f){var e=c.clone().removeClass("is-template");e.find(".c-contact-id").val(f.item.id);e.find(".c-contact-name").text(f.item.name);e.find(".c-contact-icon").css("backgroundImage","url("+f.item.photo_url+")");b.append(e.show());a.val("");return!1}}).data("ui-autocomplete")._renderItem=
function(a,b){return d("<li />").addClass("ui-menu-item-html").append("<div>"+b.value+"</div>").appendTo(a)}};CRMContactSegmentAddContacts.prototype.initDeleteLinks=function(){this.$wrapper.on("click",".c-contact-delete-link",function(a){a.preventDefault();d(this).closest(".c-contact-item").remove()})};CRMContactSegmentAddContacts.prototype.initSubmit=function(){var a=this,b=a.$form,c=a.$button,e=b.find(".c-loading");b.submit(function(f){f.preventDefault();e.show();c.prop("disabled",!0);d.post(b.attr("action"),
b.serialize()).done(function(b){"ok"==b.status&&d.crm.content.load(d.crm.app_url+"contact/segment/"+a.segment.id+"/")}).always(function(){e.hide();c.prop("disabled",!1);a.dialog.close()})})};return CRMContactSegmentAddContacts}(jQuery);var CRMContactEditForm=function(d){CRMContactEditForm=function(a){this.$wrapper=a.$wrapper;this.$phoneList=this.$wrapper.find(".js-phone-list");this.$emailList=this.$wrapper.find(".js-email-list");this.phone_template_html=a.phone_template_html;this.email_template_html=a.email_template_html;this.initClass()};CRMContactEditForm.prototype.initClass=function(){this.initAddPhone();this.initAddEmail();this.initCompanyAutocomplete()};CRMContactEditForm.prototype.initAddPhone=function(){function a(a,f){a.preventDefault();
var e=d(b.phone_template_html);f&&(e.find(".js-value").val(f.number).trigger("change"),e.find(".js-ext").val(f.ext).trigger("change"));c.append(e)}var b=this,c=b.$phoneList;b.$wrapper.on("click",".js-add-phone",a);b.$wrapper.on("click",".js-remove-phone",function(a){a.preventDefault();d(this).closest("li").remove()});d(document).on("addContactPhone",function(b,c){a(b,c)})};CRMContactEditForm.prototype.initAddEmail=function(){function a(a,f){a.preventDefault();var e=d(b.email_template_html);f&&(e.find(".js-value").val(f.name).trigger("change"),
e.find(".js-ext").val(f.ext).trigger("change"));c.append(e)}var b=this,c=b.$emailList;b.$wrapper.on("click",".js-add-email",a);b.$wrapper.on("click",".js-remove-email",function(a){a.preventDefault();d(this).closest("li").remove()});d(document).on("addContactEmail",function(b,c){a(b,c)})};CRMContactEditForm.prototype.initCompanyAutocomplete=function(){var a=this.$wrapper.find('[name="contact[company]"]'),b=this.$wrapper.find('[name="contact[company_contact_id]"]');a.length&&(a.autocomplete({appendTo:this.$wrapper,
source:"?module=autocomplete&type=company",minLength:2,focus:function(){return!1},select:function(c,e){var f=d("<div />").text(e.item.name).text();a.val(f);b.val(0<e.item.id?e.item.id:"");return!1},search:function(){b.val("")}}).data("ui-autocomplete")._renderItem=function(a,b){return d("<li />").addClass("ui-menu-item-html").append("<div>"+b.value+"</div>").appendTo(a)})};return CRMContactEditForm}(jQuery),CRMContactAddDialog=function(d){CRMContactAddDialog=function(a){this.$wrapper=a.$wrapper;this.contact_id=
a.contact_id;this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMContactAddDialog.prototype.initClass=function(){this.$wrapper.find(".js-focus-field").focus();this.initToggle();this.initContactForm();this.initCompanyForm()};CRMContactAddDialog.prototype.initToggle=function(){var a=this,b=a.$wrapper.find(".js-content-toggle-wrapper"),c=b.find(".js-ibutton"),d=a.$wrapper.find(".js-toggle-content.is-selected");c.iButton({labelOn:"",labelOff:"",classContainer:"c-ibutton ibutton-container mini"});
c.on("change",function(){var e="checked"===c.attr("checked"),g=a.$wrapper.find('.js-toggle-content[data-content="'+(e?"company":"contact")+'"]');e?b.addClass("is-on"):b.removeClass("is-on");d.length&&d.removeClass("is-selected");g.length&&(d=g.addClass("is-selected"));a.dialog.resize()})};CRMContactAddDialog.prototype.initContactForm=function(){function a(){var a=c.find(".js-phone-list"),b=c.find(".js-email-list");a.find("li .js-value, li .js-ext").removeAttr("name");b.find("li .js-value, li .js-ext").removeAttr("name");
var h=e.serializeArray(),k={data:[],errors:[]},l=["contact[firstname]","contact[middlename]","contact[lastname]","contact[name]"],m=!0;d.each(h,function(a,b){k.data.push({name:b.name,value:b.value});0<d.trim(b.value).length&&0<=l.indexOf(b.name)&&(m=!1)});m&&(k.errors.push({name:"contact[firstname]",value:"Name is empty"}),k.errors.push({name:"contact[name]",value:"Name is empty"}));a.find("li").each(function(a){var b=d(this),c=b.find(".js-value"),b=b.find(".js-ext"),e=c.val(),f=b.val();if(e){var g=
"contact[phone]["+a+"][value]";c.attr("name",g);k.data.push({name:g,value:e});a="contact[phone]["+a+"][ext]";b.attr("name",a);k.data.push({name:a,value:f})}});b.find("li").each(function(a){var b=d(this),c=b.find(".js-value"),b=b.find(".js-ext"),e=c.val(),f=b.val();if(e){var g="contact[email]["+a+"][value]";c.attr("name",g);k.data.push({name:g,value:e});a="contact[email]["+a+"][ext]";b.attr("name",a);k.data.push({name:a,value:f})}});return k}var b=this,c=b.$wrapper.find('.js-toggle-content[data-content="contact"]'),
e=c.find("form");(function(){function c(a){d.post(b.contact_id?"?module=deal&action=contactUpdate":"?module=contact&action=save",a,function(a){"ok"==a.status?(b.dialog.close(),d.crm.content.load(d.crm.app_url+"contact/"+a.data.contact.id+"/")):a.errors&&g(a.errors)},"json").always(function(){k=!1})}function g(a){a=a?a:[];d.each(a,function(a,b){var c=b.name,f=b.value;"name"===c&&(c="contact[firstname]");var g=e.find('[name="'+c+'"]'),k=d("<span />").addClass("errormsg").text(f);g.length?g.hasClass("error")||
(g.parent().append(k),g.addClass("error").one("focus click",function(){g.removeClass("error");k.remove()})):(h.append(k),e.one("submit",function(){k.remove()}))})}var h=b.$wrapper.find(".js-errors-place"),k=!1;e.on("submit",function(b){b.preventDefault();k||(k=!0,b=a(),b.errors.length?(g(b.errors),k=!1):c(b.data))})})();(function(){c.on("click",".js-extended-form",function(){var b=a(),c=[];c.push("extended=true");d.each(b.data,function(a,b){var e=d.trim(b.value);e&&c.push(b.name+"="+e)});b=d.crm.app_url+
"contact/new/?"+c.join("&");d.crm.content.load(b)})})();a()};CRMContactAddDialog.prototype.initCompanyForm=function(){function a(){var a=c.find(".js-phone-list"),b=c.find(".js-email-list");a.find("li .js-value, li .js-ext").removeAttr("name");b.find("li .js-value, li .js-ext").removeAttr("name");var h=e.serializeArray(),k={data:[],errors:[]},l=["contact[firstname]","contact[middlename]","contact[lastname]","contact[name]"],m=!0;d.each(h,function(a,b){k.data.push({name:b.name,value:b.value});0<d.trim(b.value).length&&
0<=l.indexOf(b.name)&&(m=!1)});m&&(k.errors.push({name:"contact[firstname]",value:"Name is empty"}),k.errors.push({name:"contact[name]",value:"Name is empty"}));a.find("li").each(function(a){var b=d(this),c=b.find(".js-value"),b=b.find(".js-ext"),e=c.val(),f=b.val();if(e){var g="contact[phone]["+a+"][value]";c.attr("name",g);k.data.push({name:g,value:e});a="contact[phone]["+a+"][ext]";b.attr("name",a);k.data.push({name:a,value:f})}});b.find("li").each(function(a){var b=d(this),c=b.find(".js-value"),
b=b.find(".js-ext"),e=c.val(),f=b.val();if(e){var g="contact[email]["+a+"][value]";c.attr("name",g);k.data.push({name:g,value:e});a="contact[email]["+a+"][ext]";b.attr("name",a);k.data.push({name:a,value:f})}});return k}var b=this,c=b.$wrapper.find('.js-toggle-content[data-content="company"]'),e=c.find("form");(function(){function a(){var a={data:[],errors:[]},b=e.serializeArray();d.each(b,function(b,c){c.value=d.trim(c.value);"contact[company]"===c.name&&a.data.push({name:"contact[name]",value:c.value});
a.data.push(c)});b=c.find(".js-phone-list");b.find("li .js-value, li .js-ext").removeAttr("name");b.find("li").each(function(b){var c=d(this),e=c.find(".js-value"),c=c.find(".js-ext"),f=e.val(),g=c.val();if(f){var h="contact[phone]["+b+"][value]";e.attr("name",h);a.data.push({name:h,value:f});b="contact[phone]["+b+"][ext]";c.attr("name",b);a.data.push({name:b,value:g})}});b=c.find(".js-email-list");b.find("li .js-value, li .js-ext").removeAttr("name");b.find("li").each(function(b){var c=d(this),e=
c.find(".js-value"),c=c.find(".js-ext"),f=e.val(),g=c.val();if(f){var h="contact[email]["+b+"][value]";e.attr("name",h);a.data.push({name:h,value:f});b="contact[email]["+b+"][ext]";c.attr("name",b);a.data.push({name:b,value:g})}});a.data.push({name:"contact[is_company]",value:1});return a}function g(a){a=a?a:[];d.each(a,function(a,b){var f=b.name,g=b.value,h=c.find('[name="'+f+'"]');"contact[firstname]"!==f||h.is(":visible")||(h=c.find(".js-contact-autocomplete"));var k=d("<span class='c-error' />").addClass("errormsg").text(g);
h.length&&!h.hasClass("error")?(h.parent().append(k),h.addClass("error").one("focus click change",function(){h.removeClass("error");k.remove()})):(l.append(k),e.one("submit",function(){remove(k)}))})}function h(a){k||(k=!0,d.post(b.contact_id?"?module=deal&action=contactUpdate":"?module=contact&action=save",a,function(a){"ok"===a.status?(b.dialog.close(),d.crm.content.load(d.crm.app_url+"contact/"+a.data.contact.id+"/")):a.errors&&g(a.errors)},"json").always(function(){k=!1}))}var k=!1,l=c.find(".js-errors-place");
e.on("submit",function(b){b.preventDefault();b=a();b.errors.length?g(errors):h(b.data)})})();(function(){c.on("click",".js-extended-form",function(){var b=a(),c=[];c.push("extended=true");c.push("type=company");d.each(b.data,function(a,b){var e=d.trim(b.value);e&&c.push(b.name+"="+e)});b=d.crm.app_url+"contact/new/?"+c.join("&");d.crm.content.load(b)})})()};return CRMContactAddDialog}(jQuery),CRMDealParticipantAdd=function(d){CRMDealParticipantAdd=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");
this.$content=this.$wrapper.find(".crm-dialog-content");this.dialog=this.$wrapper.data("dialog");this.deal_id=a.deal_id;this.initClass()};CRMDealParticipantAdd.prototype.initClass=function(){var a=this.$wrapper.find(".js-contact-autocomplete");a.length&&a.focus();this.initAddParticipant()};CRMDealParticipantAdd.prototype.initAddParticipant=function(){function a(a){function b(a){var b=d('<div class="line errormsg" />').html(a);c.$content.append(b);c.$form.one("submit",function(){b.remove()})}if(a[0])d.each(a,
function(a,c){b(c.value)});else{var e=Object.keys(a);d.each(e,function(c,d){b(a[d])})}}function b(b){e||(e=!0,d.post("?module=deal&action=addParticipantSave",b,function(b){"ok"==b.status?(c.dialog.options.onAdd(b.data.html),c.dialog.close()):b.errors&&a(b.errors)}).always(function(){e=!1}))}var c=this,e=!1;c.$form.on("submit",function(d){var e;d.preventDefault();d=c.$form.serializeArray();e=[];e.length?a(e):b(d)})};return CRMDealParticipantAdd}(jQuery),CRMContactAddForm=function(d){CRMContactAddForm=
function(a){this.$wrapper=a.$wrapper;this.$toggleW=this.$wrapper.find(".js-contact-view-toggle");this.initClass()};CRMContactAddForm.prototype.initClass=function(){this.initToggle();this.initContactAutocomplete();this.initCompanyAutocomplete()};CRMContactAddForm.prototype.initContactAutocomplete=function(){function a(a){if(0<a.id)e.val(a.name),g.val(a.id),b(a.data);else if(0>a.id){g.val("");c.$toggleW.find(".js-show-fio").trigger("click",!0);f.val("");var d=0<=a.name.indexOf("@"),h=!!a.name.match(/^\+?\d/);
d?c.$wrapper.find(".js-email-field").val(a.name).trigger("change"):h?c.$wrapper.find(".js-phone-field").val(a.name).trigger("change"):c.$wrapper.find(".js-firstname,.js-name").val(a.name).trigger("change")}}function b(a){d.each(h,function(b,e){var f=a[e],g="phone"===e||"email"===e,h;if(g){f="";for(h=(a[e]||[]).reverse();""==f&&0<h.length;)f=h.pop();d.isPlainObject(f)&&(f=f.value)}f=d.trim(f||"");""!=f&&(g=g?c.$wrapper.find('[name="contact['+e+'][0][value]"]'):c.$wrapper.find('[name="contact['+e+']"]'),
g.val(f))});f.attr("disabled",!0)}var c=this,e=c.$wrapper.find(".js-contact-autocomplete"),f=c.$wrapper.find(".js-field"),g=c.$wrapper.find(".js-contact-id-field"),h=["firstname","company","jobtitle","phone","email"],k="?module=autocomplete&add_new=true&join="+h.join(","),l=!1;e.autocomplete({appendTo:c.$wrapper,source:k,minLength:2,html:!0,focus:function(){return!1},select:function(b,c){l=!0;a(c.item);e.blur();return!1},search:function(){g.val("")},open:function(){l=!1},change:function(){l||a({id:-1,
name:e.val()})}}).data("ui-autocomplete")._renderItem=function(a,b){return d("<li />").addClass("ui-menu-item-html").append("<div>"+b.value+"</div>").appendTo(a)};e.on("keydown",function(a){13!==a.keyCode&&(f.attr("disabled",!1),f.val(""))})};CRMContactAddForm.prototype.initCompanyAutocomplete=function(){var a=this.$wrapper.find(".js-company-autocomplete"),b=this.$wrapper.find(".js-company-id-field");if(!a.length||!b.length)return!1;a.autocomplete({appendTo:this.$wrapper,source:"?module=autocomplete&type=company",
minLength:2,html:!0,focus:function(){return!1},select:function(c,d){a.val(d.item.name);b.val(d.item.id);return!1},search:function(){b.val("")}}).data("ui-autocomplete")._renderItem=function(a,b){return d("<li />").addClass("ui-menu-item-html").append("<div>"+b.value+"</div>").appendTo(a)}};CRMContactAddForm.prototype.initToggle=function(){var a=this,b=a.$toggleW,c=b.find(".is-active"),e=a.$wrapper.find(".js-action-field"),f=a.$wrapper.find(".js-field"),g=a.$wrapper.find(".js-fio"),h=a.$wrapper.find(".js-combo-name");
b.on("click",".c-toggle",function(b,l){b.preventDefault();l=!l;var k=d(this),p=k.data("mode");if(k.hasClass("is-active"))return!1;c.length&&c.removeClass("is-active");k.addClass("is-active");c=k;l&&a.$wrapper.find("input").val("").trigger("change");"fio"===p?(g.show(),h.hide(),e.val("new"),f.attr("disabled",!1)):(g.hide(),h.show(),e.val("search"));d(document).trigger("toggleChanged");d(document).trigger("resizeDialog")})};return CRMContactAddForm}(jQuery),CRMCompanyAddForm=function(d){CRMCompanyAddForm=
function(a){this.$wrapper=a.$wrapper;this.phone_template_html=a.phone_template_html;this.email_template_html=a.email_template_html;this.initClass()};CRMCompanyAddForm.prototype.initClass=function(){this.initAddPhone();this.initAddEmail()};CRMCompanyAddForm.prototype.initAddPhone=function(){var a=this,b=a.$wrapper.find(".js-phone-list");a.$wrapper.on("click",".js-add-phone",function(c){c.preventDefault();c=d(a.phone_template_html);b.append(c)});a.$wrapper.on("click",".js-remove-phone",function(a){a.preventDefault();
d(this).closest("li").remove()})};CRMCompanyAddForm.prototype.initAddEmail=function(){function a(a,f){a.preventDefault();var e=d(b.email_template_html);f&&(e.find(".js-value").val(f.name).trigger("change"),e.find(".js-ext").val(f.ext).trigger("change"));c.append(e)}var b=this,c=b.$wrapper.find(".js-email-list");b.$wrapper.on("click",".js-add-email",a);b.$wrapper.on("click",".js-remove-email",function(a){a.preventDefault();d(this).closest("li").remove()});d(document).on("addContactEmail",function(b,
c){a(b,c)})};return CRMCompanyAddForm}(jQuery);var CRMContactImportPage=function(d){CRMContactImportPage=function(a){this.$wrapper=a.$wrapper;this.$iframe=this.$wrapper.find("iframe");this.initClass()};CRMContactImportPage.prototype.initClass=function(){this.initViewToggle();this.initSubmit()};CRMContactImportPage.prototype.initSubmit=function(){function a(a){a.on("change keydown","input, select, textarea",function(){a.find("input:submit").attr("disabled",!1)});a.on("submit",function(){a.find(".loading").show();e=!0})}var b=this,c=b.$iframe,e=
!1;b.$wrapper.find("form").each(function(){a(d(this))});c.on("load",function(){if(!e)return!1;var a=d(this).contents().find("body").html(),c=null;try{c=JSON.parse(a)}catch(h){}c&&c.errors?(b.$wrapper.find(".loading").hide(),alert(c.errors)):d.crm.content.load(d.crm.app_url+"contact/import/upload/")})};CRMContactImportPage.prototype.initViewToggle=function(){var a=this,b=a.$wrapper.find(".js-view-toggle"),c=b.find(".is-active");b.on("click",".c-toggle",function(b){b.preventDefault();b=d(this);var e=
b.data("content");if(b.hasClass("is-active"))return!1;c.length&&c.removeClass("is-active");b.addClass("is-active");c=b;a.$wrapper.find(".js-toggle-content.is-active").removeClass("is-active");b=a.$wrapper.find('.js-toggle-content[data-content="'+e+'"]');b.length&&b.addClass("is-active")})};return CRMContactImportPage}(jQuery);var crmContactImportUpload=function(d){var a=function(a){var c=a.$wrapper,f=c.find("form"),g=c.find(".crm-import-upload-table"),h=c.find(".crm-import-upload-button"),k=c.find(".crm-total-count-column .crm-count");this.$wrapper=c;this.$form=f;var l=a.fieldInfo,m=/[\s~!@#\$%\^&\*\(\)_\+\|\\=\-`\{\}:"<>\?\[\];',\.\/]+/g,p=function(a,b){a+=1;b?(g.find("td:nth-child("+a+")").addClass("crm-highlight-cell"),h.attr("disabled",!1)):g.find("td:nth-child("+a+")").removeClass("crm-highlight-cell")};d("select",
g).each(function(a){d(this).change(function(){p(a,d(this).val())})});var n=function(){d(this).is(":checked")?(g.find("tbody tr:first").removeClass("crm-ignored-row"),k.html((parseInt(k.html(),10)||0)+1)):(g.find("tbody tr:first").addClass("crm-ignored-row"),k.html(parseInt(k.html(),10)-1||""))};d("input[name='first_line']",f).change(n);var q=!1,r=g.find("select");g.find("tbody tr:first-child td").each(function(a,b){var c=null,e=0,f=!1,g=d(b).text().toLowerCase().replace(m,""),h;for(h in l){var k=
l[h],n=!1,t=0,u=!1;h.length>e&&!f&&0==g.indexOf(h)&&(t=h.length,n=!0);var C=k.name.toLowerCase().replace(m,"");C&&C.length>e&&0==g.indexOf(C)&&(t=C.length,u=n=!0);if(n){C=n=null;if(k.fields){for(var z in k.fields){if(0<=g.indexOf(z)){n=z;t+=z.length;break}if(0<=g.indexOf(k.fields[z].name.toLowerCase().replace(m,""))){n=z;t+=k.fields[z].name.length;break}}if(!n)continue}if(k.ext)for(var B in k.ext){if(0<=g.indexOf(B)){C=B;break}if(0<=g.indexOf(k.ext[B].toLowerCase().replace(m,""))){C=B;break}}c=h+
(n?":"+n:"")+(C?"."+C:"");e=t;f=u}}c&&e&&(r.eq(a).val(c),p(a,!0),q=!0)});q&&n.call(f.find("input[name='first_line']").attr("checked",!1));this.initCreateDealsSettings();this.initAddToSegments();f.submit(function(e){e.preventDefault();e=c.find(".crm-warning-require-primary-fields").hide();var h=!1;g.find("select").each(function(){var a=d(this).val();if("firstname"==a||"lastname"==a||"company"==a||"email"==a.substr(0,5))return h=!0,!1});h?(c.find(".crm-loading").show(),(new b({$wrapper:c,need_validation:f.find("[name=validate]").is(":checked"),
messages:a.messages||{}})).run()):e.show()})};a.prototype.initCreateDealsSettings=function(){var a=this.$form,b=a.find('[name="create_deals"]'),f=a.find(".crm-deals-settings-wrapper"),g=a.find('[name="deal_funnel_id"]'),h=a.find('[name="deal_stage_id"]');b.click(function(){d(this).is(":checked")?f.show():f.hide()});g.change(function(){h.load("?module=contactImportUpload&action=stagesByFunnel&id="+d(this).val())})};a.prototype.initAddToSegments=function(){var a=this.$form;a.find('[name="add_to_segments"]').click(function(){d(this).is(":checked")?
d.get(d.crm.app_url+"?module=contactOperation&action=AddToSegments",function(b){new CRMDialog({html:b,onOpen:function(b){new CRMContactsOperationAddToSegments({$wrapper:b,onSave:function(b,c){for(var e=c.data("dialog"),f=[],g=[],h=d(".c-segment-item",c),n=0;n<b.segment_ids.length;n+=1){var q=b.segment_ids[n],r=h.filter('[data-id="'+q+'"]');f.push(r.find(".c-name").text());g.push('<input type="hidden" name="segment_id[]" value="'+q+'">')}f="<span>"+f.join(",")+"</span>";g=g.join(" ");d(".c-add-to-segments-names",
a).html(f+g);e.close();return!1}})}})}):d(".c-add-to-segments-names",a).html("")})};var b=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.processId=null;this.$loading=this.$wrapper.find(".crm-loading");this.timer=null;this.messages=a.messages||{};this.url=d.crm.app_url+"?module=contact&action=importProcess"+(a.need_validation?"&need_validation=1":"");this.$progress_bar_dialog=this.$wrapper.find(".crm-import-progressbar-dialog");this.$progress_bar=this.$progress_bar_dialog.find(".crm-progressbar")};
b.prototype.run=function(){var a=this,b=function(){d.get(a.url,{processid:a.processId,t:Math.random()},function(c){a.timer&&clearTimeout(a.timer);a.timer=null;var e=a.$progress_bar.find(".ui-progressbar-value");e.stop();e.clearQueue();c.ready?(a.processId=null,e.animate({width:"100%"},{duration:500,complete:function(){d.post(a.url,{processid:a.processId,file:1},"json");0<c.rowsRejected?0>=c.rowsAdded?alert(a.messages.no_imported):alert(a.messages.some_imported):alert(a.messages.all_imported);location.href=
0<c.rowsAdded?d.crm.app_url+"contact/import/result/"+c.timeStart+"/":d.crm.app_url+"contact/import/"},queue:!1})):(e.animate({width:""+Math.round(100*c.done/c.total)+"%"},{duration:500,queue:!1}),a.timer=setTimeout(b,3E3+400*(Math.random()-.5)))},"json")};d.post(a.url,a.$form.serializeArray(),function(c){a.processId=c.processId;a.processId&&(a.$progress_bar_dialog.show(),a.$progress_bar.progressbar({value:0}),b())},"json")};return a}(jQuery);var CRMContactsMergePage=function(d){CRMContactsMergePage=function(a){this.$wrapper=a.$wrapper;this.$table=this.$wrapper.find(".js-duplicates-table");this.$form=this.$wrapper.find("form");this.$merge_field=this.$wrapper.find(".crm-search-duplicates-by-field");this.$auto_merge_link=this.$wrapper.find(".crm-auto-merge-duplicates-link");this.$auto_merge_start_button=this.$wrapper.find(".crm-auto-merge-duplicates-start");this.$auto_merge_pause_button=this.$wrapper.find(".crm-auto-merge-duplicates-break");
this.$auto_merge_resume_button=this.$wrapper.find(".crm-auto-merge-duplicates-resume");this.is_admin=a.is_admin;this.groups_count=a.groups_count;this.messages=a.messages;this.initClass()};CRMContactsMergePage.prototype.initClass=function(){this.initSubmit();this.initMergeLinks();this.initAutoMerge()};CRMContactsMergePage.prototype.initSubmit=function(){var a=this;a.$form.submit(function(b){b.preventDefault();b=a.$merge_field.val();location.href=d.crm.app_url+"contact/merge/duplicates/?field="+b})};
CRMContactsMergePage.prototype.initMergeLinks=function(){var a=this.$wrapper,b=!1;a.on("click",".js-merge-button",function(c){c.preventDefault();var e=d(this),f=e.parent().find(".loading").css("opacity",1),g=a.find(".crm-search-duplicates-by-field").val();b||(b=!0,c=d.crm.app_url+"?module=contact&action=mergeDuplicatesGetContacts",e={field:g,value:e.attr("data-field-value")},d.post(c,e,function(a){"ok"==a.status&&a.data.contacts&&(d.crm.storage.set("crm/merge/field",g),a=d.crm.app_url+"contact/merge/?ids="+
a.data.contacts.join(","),d.crm.content.load(a))},"json").always(function(){f.css("opacity",0);b=!1}))})};CRMContactsMergePage.prototype.initAutoMerge=function(){var a=this,b=a.$wrapper,c=a.$merge_field,e=a.$wrapper.find(".crm-auto-merge-duplicates-start-text"),f=a.$wrapper.find(".crm-auto-merge-duplicates-progress"),g=a.$table,h=a.$auto_merge_start_button,k=a.$auto_merge_pause_button,l=a.$auto_merge_resume_button,m=null,p=!1;a.$auto_merge_link.click(function(a){a.preventDefault();e.show();h.show()});
var n=function(b,c){var d=a.messages.progress,e=Math.round(1E3*parseFloat(b/c))/10,d=d.replace(":percentage:",e||0).replace(":count:",b).replace(":total_count:",c);f.find(".crm-text").text(d)},q=function(){var e=c.val(),q=0,t=a.groups_count;k.show();h.hide();l.hide();f.show();b.find(".pager").hide();var A=function(){var a=b.find(".crm-merge.crm-js-partial").length;d.get(d.crm.app_url+"?module=contact&action=mergeDuplicates",{offset:a,field:e,no_js:1}).done(function(a){if(a){a=d("<div>").html(a);var b=
a.find(".crm-duplicates-table tbody").find(".crm-mergeduplicates-row");b.length?(g.find("tbody").append(b),y()):D();a.remove()}else D()})},v=function(a){var b=d.crm.app_url+"?module=contact&action=mergeDuplicatesGetContacts";a.attr("data-field-value");d.get(b,{field:e,value:a.attr("data-field-value"),master_slaves:1},function(b){b&&"ok"===b.status&&!d.isEmptyObject(b.data)?x(a,b.data):(a.addClass("crm-finished"),m.resolve())},"json").fail(function(){m.resolve()})},x=function(b,c){crmContactMerger.merge({master_id:c.master,
slave_ids:c.slaves,onDone:function(c){if(c.result&&c.result.total_count===c.result.merged_count){var e=d.crm.app_url+"contact/"+c.master.id+"/";b.closest("tr").find("td:not(:first)").css({textDecoration:"line-through"}).end().find("td:first").html('<a href="'+e+'" target="_blank">'+d.crm.encodeHTML(c.master.name)+"</a>")}else b.addClass("crm-partial");c=c.message||a.messages.done||"Done";b.closest("td").css({textDecoration:""}).html('<span class="float-right" style="margin-right: 10px;">'+c+"</span>").append(b.hide().addClass("crm-finished"));
m.resolve()},onError:function(){m.resolve()}})},w=function(){p?setTimeout(w,1E3):y()},y=function(){var a=b.find(".crm-merge:not(.crm-finished):first");a.length?(a.parent().find(".crm-loading").css("opacity",1),m=new d.Deferred,m.fail(function(){k.hide();l.show()}),m.done(function(){q+=1;n(q,t);p?w():y()}),v(a)):q<t?A():D()},D=function(){h.hide();l.hide();k.hide();f.hide();a.$wrapper.find(".crm-attention-message").hide();a.$wrapper.find(".crm-done-message").show()};y()};h.click(function(a){a.preventDefault();
q()});l.click(function(a){a.preventDefault();k.show();l.hide();p=!1});k.click(function(a){a.preventDefault();p=!0;k.hide();l.show()});n(0,a.groups_count)};return CRMContactsMergePage}(jQuery);var crmContactMerge=function(d){var a=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".crm-merge-submit");this.slave_ids=a.slave_ids||[];this.messages=a.messages||{};this.is_admin=a.is_admin;this.initClass()};a.prototype.initClass=function(){this.initSelectors();this.initMergeButton();this.$wrapper.on("click",".crm-contact-row-wrapper",function(a){var b=d(this).find(".crm-selector");b[0]!==a.target&&b.click()})};a.prototype.initSelectors=function(){var a=this;a.$wrapper.on("click",
".crm-selector",function(b){var c=d(this).closest(".crm-contact-row-wrapper"),f=c.find(".crm-contact-row");b=a.$wrapper.find(".crm-merge-description");a.$wrapper.find(".crm-js-hide-when-not-selected").hide();a.$wrapper.find(".crm-selected").removeClass("crm-selected");f.addClass("crm-selected");f.find(".crm-js-hide-when-not-selected").show();c=c.find(".crm-merge-description-for-master").html();b.html(c);b.find(".crm-js-not-allowed-as-master").length?a.$button.prop("disabled",!0):a.$button.prop("disabled",
!1)})};a.prototype.initMergeButton=function(){var a=this,c=a.slave_ids,e=a.$wrapper.find(".crm-loading");a.$button.click(function(b){b.preventDefault();var f=a.$wrapper.find(".crm-selector:checked").val();f?0<=c.indexOf(f)&&1===c.length?alert(a.messages.choose_master):(a.$button.attr("disabled",!0),e.show(),crmContactMerger.merge({master_id:f,slave_ids:c,onDone:function(){d.crm.storage.del("crm/merge/field");d.crm.content.load(d.crm.app_url+"contact/"+f+"/")},onError:function(){a.$button.attr("disabled",
!1);e.hide()}})):alert(a.messages.choose_master)})};return a}(jQuery);var crmContactMerger=function(d){var a=function(a){this.master_id=a.master_id||0;this.slave_ids=a.slave_ids||[];this.url=d.crm.app_url+"?module=contact&action=mergeRun";this.processId=this.timer=null;this.onDone=a.onDone||function(){};this.onError=a.onError||function(){throw Error("Error processing request.");}};a.prototype.process=function(){var a=this,c=a.url,e=0,f={};f.master_id=a.master_id;f.slave_ids=a.slave_ids;var g=function(){a.timer&&clearTimeout(a.timer);a.timer=setTimeout(g,3200);!a.processId||
2<=e||(f.processId=a.processId,d.post(c,f,null,"json").done(function(b){e--;a.processId&&b.ready&&a.processId&&(a.timer&&clearTimeout(a.timer),a.timer=null,a.processId=null,a.onDone(b))}).fail(a.onError),e++)};d.post(c,f,null,"json").done(function(b){if(!b.processId)a.onError();a.processId=b.processId;g()}).fail(a.onError);return this};a.prototype.cancel=function(){this.timer&&clearTimeout(this.timer);d.post(this.url,{processId:this.processId,ready:1});return this};a.merge=function(b){return(new a(b)).process()};
return a}(jQuery);var CRMReportPage=function(d){CRMReportPage=function(a){this.$wrapper=a.$wrapper;this.funnel_id=a.funnel_id;this.funnel_color=a.funnel_color;this.group_by=a.group_by;this.locales=a.locales;this.chartsData=a.chartsData;this.stages_data=a.stages_data;this.initClass()};CRMReportPage.prototype.initClass=function(){this.initSVG();"undefined"!==typeof d3&&(this.chartsData&&this.initChart(),this.stages_data&&this.initStageCharts(this.stages_data));this.initDateFilter()};CRMReportPage.prototype.initDateFilter=
function(){var a=this.$wrapper.find(".js-dates-filter"),b=a.find("form"),c=a.find(".js-list");a.find(".js-timeframe-field");var e=a.find(".js-link-text"),f=a.find(".js-hidden-part"),g=!1,h=c.find(".selected");c.on("click",".js-toggle",function(a){a.preventDefault();a=d(this);var b=a.data("timeframe");e.html(a.find("a").html());h.length&&h.removeClass("selected");h=a.addClass("selected");"custom"!==b?f.removeClass("is-shown"):f.addClass("is-shown")});b.on("submit",function(a){a.preventDefault();g||
(g=!0,a=b.serialize(),d.crm.content.load(d.crm.app_url+"report/?"+a))});(function(){a.find(".js-datepicker").each(function(){var b=d(this),c=a.find("."+b.data("selector"));b.datepicker({altField:c,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0})})})()};CRMReportPage.prototype.initSVG=function(){if("object"!==typeof d3)return!1;var a=function(b,c){function d(a){var b=a.$wrapper;a=a.start/100;var c={};c.width=b.outerWidth();c.height=b.outerHeight();c.inner_width=parseInt(c.width*a);c.inner_height=
c.height;c.top=c.height-c.inner_height;c.left=parseInt((c.width-c.inner_width)/2);return c}function f(a){var b=[],c=parseInt((a.start-a.end)/200*a.area.width);b.push("0,0");b.push(a.area.inner_width+",0");b.push(a.area.inner_width-c+","+a.area.height);b.push(c+","+a.area.height);return b.join(" ")}a=function(a){this.$wrapper=a.$wrapper;this.svg=c.select(this.$wrapper[0]).append("svg");this.start=parseInt(this.$wrapper.data("start"));this.end=parseInt(this.$wrapper.data("end"));this.color=this.$wrapper.data("color");
this.polygon=!1;this.area=d(this);this.initClass()};a.prototype.initClass=function(){function a(){b.contains(document,c.$wrapper[0])?c.refresh():b(window).off("resize",a)}var c=this;c.svg.attr("width",c.area.width).attr("height",c.area.height);c.renderRectangle();c.$wrapper.data("svg",c);b(window).on("resize",a)};a.prototype.renderRectangle=function(){var a=this.svg.append("g"),b=f(this);this.polygon=a.append("polygon").attr("points",b).attr("transform","translate("+this.area.left+","+this.area.top+
")").style("fill",this.color)};a.prototype.refresh=function(){this.area=d(this);this.svg.attr("width",this.area.width).attr("height",this.area.height);this.polygon.attr("points",f(this)).attr("transform","translate("+this.area.left+","+this.area.top+")")};return a}(jQuery,d3);this.$wrapper.find(".js-svg-bar").each(function(){var b=d(this);new a({$wrapper:b})})};CRMReportPage.prototype.initChart=function(){function a(a,b){function c(a,b,c){var d=a.date.split("-");a=parseInt(d[0]);var e=parseInt(d[1]),
d=parseInt(d[2]);a=[a,e,d];"years"===c?(c=a.slice(),c[0]+=b?1:-1):"months"===c?(c=a.slice(),c[1]+=b?1:-1):(c=a.slice(),c[2]+=b?1:-1);c[1]=(10>c[1]?"0":"")+c[1];c[2]=(10>c[2]?"0":"")+c[2];return{date:c.join("-"),value:0}}d.each(a,function(d){d=a[d];if(1===d.data.length){var e=d.data[0],f=c(e,!1,b),g=c(e,!0,b);console.log(e);console.log(f);console.log(g);e=[f].concat(d.data);e.push(g);d.data=e;console.log(d.data)}});return a}var b=this.$wrapper.find(".js-graph-section");if(!b.length)return!1;var c=
function(a){function b(a){function b(a){var b=a.split("-");a=parseInt(b[0]);var c=parseInt(b[1])-1,b=parseInt(b[2]);return new Date(a,c,b)}for(var c=[],d=0;d<a.length;d++){for(var e=a[d].data,f=[],g=0;g<e.length;g++){var h=e[g],k=parseInt(h.value);f.push({date:b(h.date),value:k})}c.push(f)}return d3.layout.stack().offset("zero").values(function(a){return a}).x(function(a){return a.date}).y(function(a){return a.value})(c)}function d(a,b){for(var c=(b[1]||1)-b[0]+1,d=c/(a-1),e=[],f=0;f<a;f++){var g=
10<c?Math.round(f*d):parseInt(f*d*10)/10;e.push(g)}return e}function e(b,c){var d=a(window),e=d.width();d.height();var d=c.$hint.outerWidth(),f=c.$hint.outerHeight(),g=c.$wrapper.offset(),h=b.pageX,f={left:h-g.left+10,top:b.pageY-g.top+(0<f?0-f-2:2)};e<f.left+d&&(f.left=h-(d+10));return f}c=function(a){this.$wrapper=a.$wrapper;this.$hint=this.$wrapper.find(".c-hint-wrapper");this.node=this.$wrapper.find(".js-graph")[0];this.d3node=d3.select(this.node);this.show_class="is-shown";this.charts=a.data;
this.data=b(this.charts);this.color=a.color;this.group_by=a.group_by;this.locales=a.locales;this.margin={top:14,right:10,bottom:20,left:34};var c=this.node;a=this.margin;var d=c.offsetWidth,c=c.offsetHeight;this.area={outer_width:d,outer_height:c,inner_width:d-a.left-a.right,inner_height:c-a.top-a.bottom};this.column_indent=4;a=this.area.inner_width;d=this.data[0].length;c=null;d+=1;a&&d&&(c=(a-this.column_indent*(d-1))/d,0>c&&(c=0));this.column_width=c;this.axisIndent=2;this.yDomain=this.xDomain=
this.svgArea=this.svgLine=this.y=this.x=this.defs=this.svg=!1;this.initGraph()};c.prototype.initGraph=function(){var b=this,c=b.area;b.initGraphCore();b.svg=b.d3node.append("svg").attr("width",c.outer_width).attr("height",c.outer_height);b.renderBackground();a.each(b.data,function(a,c){var d=b.data.length-1-a;b.renderChart(b.data[d],b.charts[d])});b.renderAxis()};c.prototype.initGraphCore=function(){var a=this,b=a.data,c=a.area,d=a.x=d3.time.scale().range([0,c.inner_width]),e=a.y=d3.scale.linear().range([c.inner_height,
0]);a.yDomain=function(){var a=d3.min(b,function(a){return d3.min(a,function(a){return a.value})});0<a&&(a=0);var c=d3.max(b,function(a){return d3.max(a,function(a){return a.value+a.y0})});return[a,c]}();a.xDomain=function(){var a,c;a=b[0][0].date;c=b[0][b[0].length-1].date;var d=.05*(c.getTime()-a.getTime());a=new Date(a.getTime()-d);c=new Date(c.getTime()+d);return[a,c]}();d.domain(a.xDomain);e.domain(a.yDomain);a.svgArea=d3.svg.area().interpolate("monotone").x(function(a){return d(a.date)}).y(function(b){return e(b.value+
b.y0)-a.axisIndent}).y0(function(a){return e(0)});a.svgLine=d3.svg.line().interpolate("monotone").x(function(a){return d(a.date)}).y(function(b){return e(b.value+b.y0)-a.axisIndent})};c.prototype.renderAxis=function(){var a=this.x,b=this.y,c=this.svg,a=d3.svg.axis().scale(a).orient("bottom").ticks(10),b=d3.svg.axis().scale(b).innerTickSize(2).orient("right").tickValues(d(6,this.yDomain)).tickFormat(function(a){return a+""}),c=c.append("g").attr("class","axis");c.append("g").attr("transform","translate(10,"+
this.margin.top+")").attr("class","y").call(b);c.append("g").attr("class","x").attr("transform","translate("+this.margin.left+","+(this.area.outer_height-this.margin.bottom)+")").call(a)};c.prototype.renderBackground=function(){var a=this.area.inner_width,b=this.area.inner_height,c,d=this.svg.append("g").attr("class","background").attr("transform","translate("+this.margin.left+","+this.margin.top+")");d.append("rect").attr("width",a).attr("height",b);for(c=0;5>=c;c++){var e=1+(b-2)/5*c;d.append("line").attr("x1",
1).attr("x2",a).attr("y1",e).attr("y2",e)}};c.prototype.renderChart=function(a,b){var c=this,d=b.color;c.svg.append("g").attr("class","c-graph-wrapper").attr("transform","translate("+c.margin.left+","+c.margin.top+")").datum(a).append("path").style("stroke",function(){return 1<c.charts.length?"":c.color}).style("fill",function(){return d?d:c.color}).attr("class","area").attr("d",c.svgArea(a)).on("mouseover",function(a){c.showHint(d3.event,this,b)}).on("mousemove",function(){c.moveHint(this)}).on("mouseout",
function(){c.hideHint()})};c.prototype.update=function(a){this.data=b(this.charts,a);this.initGraphCore();a=d3.svg.axis().scale(this.y).innerTickSize(2).orient("right").tickValues(d(6,this.yDomain)).tickFormat(function(a){return a+""});this.svg.selectAll(".axis .y").call(a);this.renderCharts()};c.prototype.showHint=function(a,b,c){b=this.$hint.find(".js-name");this.$hint.find(".js-date");this.$hint.find(".js-value");c.name&&(b.text(c.name),a=e(a,this),this.$hint.css(a).addClass(this.show_class))};
c.prototype.moveHint=function(){if(this.$hint.hasClass(this.show_class)){var a=e(event,this);this.$hint.css(a)}};c.prototype.hideHint=function(){this.$hint.removeAttr("style").removeClass(this.show_class)};return c}(jQuery),e=function(a){function b(a){function b(a){var b=a.split("-");a=parseInt(b[0]);var c=parseInt(b[1])-1,b=parseInt(b[2]);return new Date(a,c,b)}for(var c=[],d=0;d<a.length;d++){for(var e=a[d].data,f=[],g=0;g<e.length;g++){var h=e[g],k=parseInt(h.value);f.push({date:b(h.date),value:k})}c.push(f)}return d3.layout.stack().offset("zero").values(function(a){return a}).x(function(a){return a.date}).y(function(a){return a.value})(c)}
function c(a,b){for(var c=b[0],d=b[1]||1,c=0<d-c?d-c:1,d=c/(a-1),e=[],f=0;f<a;f++){var g=10<c?Math.round(f*d):parseInt(f*d*10)/10,g=0<parseInt(g)?parseInt(g):1;e.push(g)}return e}e=function(a){this.$wrapper=a.$wrapper;this.$hint=this.$wrapper.find(".c-hint-wrapper");this.node=this.$wrapper.find(".js-graph")[0];this.d3node=d3.select(this.node);this.show_class="is-shown";this.charts=a.data;this.data=b(this.charts);this.color=a.color;this.group_by=a.group_by;this.locales=a.locales;this.margin={top:8,
right:10,bottom:4,left:34};var c=this.node;a=this.margin;var d=c.offsetWidth,c=c.offsetHeight;this.area={outer_width:d,outer_height:c,inner_width:d-a.left-a.right,inner_height:c-a.top-a.bottom};this.column_indent=200<this.data[0].length?2:4;a=this.area.inner_width;d=this.data[0].length;c=null;d+=1;a&&d&&(c=(a-this.column_indent*(d-1))/d,1>c?c=1:20<c&&(c=20));this.column_width=c;this.yDomain=this.xDomain=this.y=this.x=this.defs=this.svg=!1;this.initGraph()};e.prototype.initGraph=function(){var a=this.area;
this.initGraphCore();200<this.data[0].length?this.$wrapper.addClass("is-large"):this.$wrapper.removeClass("is-large");this.svg=this.d3node.append("svg").attr("width",a.outer_width).attr("height",a.outer_height);this.renderBackground();this.renderCharts();this.renderAxis()};e.prototype.initGraphCore=function(){var a=this.data,b=this.area,c=this.x=d3.time.scale().range([0,b.inner_width]),b=this.y=d3.scale.linear().range([0,b.inner_height]);this.yDomain=function(){var b=d3.min(a,function(a){return d3.min(a,
function(a){return a.value})});0<b&&(b=0);var c=d3.max(a,function(a){return d3.max(a,function(a){return a.value+a.y0})});return[b,c]}();this.xDomain=function(){var b,c;b=a[0][0].date;c=a[0][a[0].length-1].date;var d=.05*(c.getTime()-b.getTime());b=new Date(b.getTime()-d);c=new Date(c.getTime()+d);return[b,c]}();c.domain(this.xDomain);b.domain(this.yDomain)};e.prototype.renderAxis=function(){var a=this.x,b=this.y,d=this.svg;d3.svg.axis().scale(a).orient("bottom").ticks(10);a=d3.svg.axis().scale(b).innerTickSize(2).orient("right").tickValues(c(6,
this.yDomain)).tickFormat(function(a){return a+""});d.append("g").attr("class","axis").append("g").attr("transform","translate(10,"+this.margin.top+")").attr("class","y").call(a)};e.prototype.renderBackground=function(){var a=this.area.inner_width,b=this.area.inner_height,c,d=this.svg.append("g").attr("class","background").attr("transform","translate("+this.margin.left+","+this.margin.top+")");d.append("rect").attr("width",a).attr("height",b);for(c=0;5>=c;c++){var e=1+(b-2)/5*c;d.append("line").attr("x1",
1).attr("x2",a).attr("y1",e).attr("y2",e)}};e.prototype.renderCharts=function(){var b=this,c=b.data,c=b.svg.selectAll(".c-graph-wrapper").data(c);c.enter().append("g").attr("class","c-graph-wrapper").attr("transform","translate("+b.margin.left+","+b.margin.top+")");var d=c.selectAll(".rect").data(function(a){return a}),e=!1;if(b.color){var f=a.crm.color(b.color).rgb;f.push(.5);e="rgba("+f.join(",")+")"}d.enter().append("rect").attr("class","rect").on("mouseover",function(a,c,d){b.showHint(d3.event,
this,a,b.charts[d])}).on("mousemove",function(){b.moveHint(this)}).on("mouseout",function(){b.hideHint()});d.transition().duration(1E3).attr("x",function(a,c){return b.x(a.date)-b.column_width/2}).attr("y",function(a){return b.y(a.y0)}).attr("height",function(a){return b.y(a.value)}).style("stroke",function(a,c,d){return b.charts[d].color?"":b.color}).style("fill",function(a,c,d){a=b.charts[d];return a.color?a.color:e}).attr("width",b.column_width);d.exit().remove();c.exit().remove()};e.prototype.update=
function(a){this.data=b(this.charts,a);this.column_indent=200<this.data[0].length?2:4;200<this.data[0].length?this.$wrapper.addClass("is-large"):this.$wrapper.removeClass("is-large");this.initGraphCore();a=d3.svg.axis().scale(this.y).innerTickSize(2).orient("right").tickValues(c(6,this.yDomain)).tickFormat(function(a){return a+""});this.svg.selectAll(".axis .y").call(a);this.renderCharts()};e.prototype.showHint=function(b,c,d,e){var f=this;b=a(c);if(!(0<Math.ceil(b.attr("height"))))return!1;var g=
d.date;c=f.$hint.find(".js-name");var h=f.$hint.find(".js-date"),k=f.$hint.find(".js-value"),g=function(a,b){var c=parseInt(a.getMonth());if("months"==b){var d=f.locales.months;d[c]||(d="\u042f\u043d\u0432\u0430\u0440\u044c \u0424\u0435\u0432\u0440\u0430\u043b\u044c \u041c\u0430\u0440\u0442 \u0410\u043f\u0440\u0435\u043b\u044c \u041c\u0430\u0439 \u0418\u044e\u043d\u044c \u0418\u044e\u043b\u044c \u0410\u0432\u0433\u0443\u0441\u0442 \u0421\u0435\u043d\u0442\u044f\u0431\u0440\u044c \u041e\u043a\u0442\u044f\u0431\u0440\u044c \u041d\u043e\u044f\u0431\u0440\u044c \u0414\u0435\u043a\u0430\u0431\u0440\u044c".split(" "));
c=d[c]}else d=a.getDate(),c+=1,c=(10>d?"0"+d:d)+"."+(10>c?"0"+c:c)+"."+a.getFullYear();return c}(g,f.group_by);e.name?c.text(e.name+": ").show():c.hide();h.text(g);k.text(d.value);d=function(b){var c=a(window),d=c.width();c.height();var c=f.$hint.outerWidth(),e=f.$hint.outerHeight(),g=Math.ceil(b.attr("width")),h=Math.ceil(b.attr("height")),k=f.$wrapper.offset();b=b.offset();e={left:b.left-k.left+g+10,top:b.top-k.top+(h<e?h-e-2:2)};d<e.left+c&&(e.left=b.left-(c+10));return e}(b);f.$hint.css(d).addClass(f.show_class)};
e.prototype.moveHint=function(){};e.prototype.hideHint=function(){this.$hint.removeAttr("style").removeClass(this.show_class)};return e}(jQuery);new c({$wrapper:b.find(".js-sum-graph"),data:a(this.chartsData.sum,this.group_by),color:this.funnel_color,group_by:this.group_by,locales:this.locales});new e({$wrapper:b.find(".js-amount-graph"),data:a(this.chartsData.qty,this.group_by),color:this.funnel_color,group_by:this.group_by,locales:this.locales})};CRMReportPage.prototype.initStageCharts=function(a){var b=
this.$wrapper.find(".js-stage-graph-section"),c=a.stages;if(!b.length||!c.length)return!1;var d=[0,2*c.length],f=function(a){f=function(a){this.$wrapper=a.$wrapper;this.$hint=this.$wrapper.find(".c-hint-wrapper");this.node=this.$wrapper.find(".js-graph")[0];this.d3node=d3.select(this.node);this.show_class="is-shown";console.log(a.data);for(var b=a.data,c=0;c<b.length;c++){var d=b[c];1!==c||d.color||(d.color="#e07d6e")}b=this.charts=b;c=[];for(d=0;d<b.length;d++){for(var e=b[d].data,f=[],g=0;g<e.length;g++){var h=
parseInt(e[g].value);f.push({index:1+2*g,value:h})}c.push(f)}this.data=c;this.color=a.color;this.group_by=a.group_by;this.locales=a.locales;this.margin={top:20,right:0,bottom:0,left:0};c=this.node;a=this.margin;b=c.offsetWidth;c=c.offsetHeight;this.area={outer_width:b,outer_height:c,inner_width:b-a.left-a.right,inner_height:c-a.top-a.bottom};this.column_indent=8;a=this.area.inner_width;b=this.data[0].length;c=null;a&&b&&(c=(a-this.column_indent*(b-1))/b,1>c&&(c=1));this.column_width=c;this.yDomain=
this.xDomain=this.y=this.x=this.defs=this.svg=!1;this.initGraph()};f.prototype.initGraph=function(){var a=this.area;this.initGraphCore();this.svg=this.d3node.append("svg").attr("width",a.outer_width).attr("height",a.outer_height);this.renderCharts()};f.prototype.initGraphCore=function(){var a=this.data,b=this.area,c=this.x=d3.scale.linear().range([0,b.inner_width]),b=this.y=d3.scale.linear().range([0,b.inner_height]);this.yDomain=function(){var b=d3.min(a,function(a){return d3.min(a,function(a){return a.value})});
0<b&&(b=0);var c=d3.max(a,function(a){return d3.max(a,function(a){return a.value})});return[b,c]}();this.xDomain=d;c.domain(this.xDomain);b.domain(this.yDomain)};f.prototype.renderCharts=function(){var a=this,b=a.data,b=a.svg.selectAll(".c-graph-wrapper").data(b);b.enter().append("g").attr("class","c-graph-wrapper").attr("transform","translate("+a.margin.left+","+a.margin.top+")");var c=b.selectAll(".rect").data(function(a){return a});c.enter().append("rect").attr("class","rect");c.transition().duration(1E3).attr("x",
function(b,c){return a.x(b.index)-a.column_width/2}).attr("y",function(b){return a.area.inner_height-a.y(b.value)}).attr("height",function(b){return a.y(b.value)}).style("stroke",function(b,c,d){return a.charts[d].color?"":a.color}).style("fill",function(b,c,d){b=a.charts[d];return b.color?b.color:a.color}).attr("width",a.column_width);var d=b.selectAll(".base-text").data(function(a){return a});d.enter().append("text").attr("class","base-text");d.transition().duration(1E3).attr("text-anchor","middle").attr("x",
function(b){return a.x(b.index)}).attr("y",function(b){return a.area.inner_height-10}).text(function(b,c,d){b="";if(c=a.charts[d].data[c])b=c.base_text;return b});var e=b.selectAll(".over-text").data(function(a){return a});e.enter().append("text").attr("class","base-text");e.transition().duration(1E3).attr("text-anchor","middle").attr("x",function(b){return a.x(b.index)}).attr("y",function(b){return a.area.inner_height-a.y(b.value)-6}).style("fill",function(a,b,c){return 1===c?"#cc270e":""}).text(function(b,
c,d){b="";if(c=a.charts[d].data[c])b=c.over_text;return b});d.exit().remove();e.exit().remove();c.exit().remove();b.exit().remove()};return f}(jQuery),g=function(a){function b(a){for(var b=[],c=0;c<a.length;c++){for(var d=a[c].data,e=[],f=0;f<d.length;f++){var g=parseInt(d[f].value);e.push({index:1+2*f,value:g})}b.push(e)}return d3.layout.stack().offset("zero").values(function(a){return a}).x(function(a){return a.index}).y(function(a){return a.value})(b)}g=function(a){this.$wrapper=a.$wrapper;this.$hint=
this.$wrapper.find(".c-hint-wrapper");this.node=this.$wrapper.find(".js-graph")[0];this.d3node=d3.select(this.node);this.show_class="is-shown";this.charts=a.data;this.data=b(this.charts);this.color=a.color;this.group_by=a.group_by;this.locales=a.locales;this.margin={top:0,right:0,bottom:20,left:0};var c=this.node;a=this.margin;var d=c.offsetWidth,c=c.offsetHeight;this.area={outer_width:d,outer_height:c,inner_width:d-a.left-a.right,inner_height:c-a.top-a.bottom};this.column_indent=8;a=this.area.inner_width;
d=this.data[0].length;c=null;a&&d&&(c=(a-this.column_indent*(d-1))/d,1>c&&(c=1));this.column_width=c;this.yDomain=this.xDomain=this.y=this.x=this.defs=this.svg=!1;this.initGraph()};g.prototype.initGraph=function(){var a=this.area;this.initGraphCore();this.svg=this.d3node.append("svg").attr("width",a.outer_width).attr("height",a.outer_height);this.renderCharts()};g.prototype.initGraphCore=function(){var a=this.data,b=this.area,c=this.x=d3.scale.linear().range([0,b.inner_width]),b=this.y=d3.scale.linear().range([0,
b.inner_height]);this.yDomain=function(){var b=d3.min(a,function(a){return d3.min(a,function(a){return a.value})});0<b&&(b=0);var c=d3.max(a,function(a){return d3.max(a,function(a){return a.value+a.y0})});return[b,c]}();this.xDomain=d;c.domain(this.xDomain);b.domain(this.yDomain)};g.prototype.renderCharts=function(){var a=this,b=a.data,b=a.svg.selectAll(".c-graph-wrapper").data(b);b.enter().append("g").attr("class","c-graph-wrapper").attr("transform","translate("+a.margin.left+","+a.margin.top+")");
var c=b.selectAll(".rect").data(function(a){return a});c.enter().append("rect").attr("class","rect");c.transition().duration(1E3).attr("x",function(b,c){return a.x(b.index)-a.column_width/2}).attr("y",function(b){return a.y(b.y0)}).attr("height",function(b){return a.y(b.value)}).style("stroke",function(b,c,d){return a.charts[d].color?"":a.color}).style("fill",function(b,c,d){b=a.charts[d];return b.color?b.color:a.color}).attr("width",a.column_width);var d=b.selectAll(".base-text").data(function(a){return a});
d.enter().append("text").attr("class","base-text").text(function(b,c,d){b="";if(c=a.charts[d].data[c])b=c.base_text;return b}).append("tspan").style("fill","#cc270e").text(function(b,c,d){b="";(c=a.charts[d].data[c])&&c.sub_text&&(b=" ("+c.sub_text+")");return b});d.transition().duration(1E3).attr("text-anchor","middle").attr("x",function(b){return a.x(b.index)}).attr("y",16);var e=b.selectAll(".over-text").data(function(a){return a});e.enter().append("text").attr("class","over-text");e.transition().duration(1E3).attr("text-anchor",
"middle").attr("x",function(b){return a.x(b.index)}).attr("y",function(b){b=a.y(b.y0)+a.y(b.value)+16;34>b&&(b=34);return b}).text(function(b,c,d){b="";if(c=a.charts[d].data[c])b=c.over_text;return b});d.exit().remove();e.exit().remove();c.exit().remove();b.exit().remove()};return g}(jQuery),c=b.find(".js-graph-wrapper-1");c.length&&new f({$wrapper:c,data:a.charts[0],color:"#d0d0d0",group_by:this.group_by,locales:this.locales});b=b.find(".js-graph-wrapper-2");b.length&&new g({$wrapper:b,data:[a.charts[1]],
color:"#b0b0b0",group_by:this.group_by,locales:this.locales})};return CRMReportPage}(jQuery);(function(d){d.crm=d.crm||{};d.crm.search={state:null,url:d.crm.app_url+"?module=contactSearch",serialize:function(a,b,c,e){var f={},g=a.serializeArray();a=0;for(var h=g.length;a<h;a+=1){var k=(g[a].value||"").trim();try{k=JSON.parse(k)}catch(A){}var l=g[a].name;if(!(!l||!k||d.isPlainObject(k)&&d.isEmptyObject(k)||b&&0!==l.indexOf(b)||void 0!==c&&-1===l.indexOf("["+c+"]"))){var m=""+(d.isPlainObject(k)?k.val:k);if(m=d.trim(m)){for(var k=d.isPlainObject(k)?k.op||"=":"=",m=m.replace(/\//g,"\\/").replace(/&/,
"\\&"),l=l.split("."),p=f,n=0,q=l.length-1;n<q;n+=1){var r=(l[n]||"").trim();if("undefined"===typeof p[r]||"object"!==typeof p[r])p[r]={};p=p[r]}r=l[l.length-1];d.isArray(p[r])?p[r].push({val:m,op:k}):d.isPlainObject(p[r])||(p[r]=[{val:m,op:k}])}}}var u=function(a,b,c){if(d.isPlainObject(a))for(var e in a)a.hasOwnProperty(e)&&u(a[e],b,c?c+"."+e:e);else"undefined"!==typeof a&&(b[c]=a)};b={};u(f,b,"");var f=[],t;for(t in b)if(b.hasOwnProperty(t))if(d.isArray(b[t])&&1<b[t].length)for(a=0,h=b[t].length;a<
h;a+=1)m=b[t][a].val,e||(m=this.encodeURIComponent(b[t][a].val)),f.push(t+"["+a+"]"+b[t][a].op+m);else m=b[t][0].val,e||(m=this.encodeURIComponent(b[t][0].val)),f.push(t+b[t][0].op+m);return f.join("&")},encodeURIComponent:function(a){a=encodeURIComponent(a);return a=a.replace(RegExp("%2F","g"),"%252F").replace(RegExp("%5C","g"),"%255C")},indexBlocks:function(a){var b={},c=d('#c-search-block .js-field[data-multiple="1"]');a&&(c=c.filter('[data-id="'+a+'"]'));c.each(function(){var a=d(this),c=a.data("id"),
g=void 0!==b[c]?++b[c]:b[c]=0;a.attr("data-index",g);a.data("index",g);a.find(":input").each(function(){var a=d(this),b=a.attr("name").replace(/\[\d+\]/,"").replace(c,c+"["+g+"]");a.attr("name",b)})})}}})(jQuery);(function(d){d.widget("custom.combobox",{_create:function(){this.element.data("custom.combobox.inited")||(this.wrapper=d("<div style='position:relative;'>").addClass("custom-combobox").insertAfter(this.element),this.element.hide(),this._createAutocomplete(),this._createShowAllButton(),this.element.data("custom.combobox.inited",1))},_createAutocomplete:function(){this.ns=this.element.attr("name")||"element-"+(""+Math.random()).slice(2);_other_version_=!0;if(this.element.is("select")){var a=this.element.children(":selected"),
b=a.val()?a.text():"";this.h=24;var c=this;this.input=d("<input type='search'>").appendTo(this.wrapper).val(b).attr("title","").addClass("custom-combobox-input ui-widget");this.element.data("autocomplete")||this.element.data("readonly")?(this.input.autocomplete({delay:200,minLength:0,html:!0,source:d.proxy(this,"_source"),item_clz:"crm-search-ui-autocomplete-item"}),this.ul=d(this.input).autocomplete("widget")):this.ul=d();this.offset=this.limit=this.element.data("limit");this.count=this.element.data("count");
this.wrapper.width(this.input.width()+30);this.ul.css({overflowY:"auto",overflowX:"hidden",maxHeight:10*this.h});this.element.attr("disabled")&&this.input.attr("disabled",!0);this.options.css&&this.input.css(this.options.css);this.element.find("option.cond").remove();this.element.data("readonly")&&this.input.attr("readonly",!0).addClass("readonly").css({cursor:"pointer"}).click(function(){d(this).autocomplete("widget").is(":visible")?d(this).autocomplete("close"):c._showSelectItems();return!1});this.hidden=
d("<input type='hidden'>").appendTo(this.wrapper);this.label=!1!==this.options.label?d('<span class="c-label"></span>').css({left:"-20px",position:"absolute"}).prependTo(this.wrapper):d();this.element.attr("name","");this.element.data("readonly")&&this.label.hide();this.element.attr("disabled")&&this.input.attr("disabled",!0);"*="===a.data("op")&&this.label.text("\u2248");if(a.val()&&!a.hasClass("value"))a.data("period")?(this.element.data("value",""),a=a.val().split("--"),this._updatePeriodInput((a[0]||
"").trim(),(a[1]||"").trim())):(this.element.data("value",""),"value"===this.element.data("pass")?this.hidden.attr("name",this.ns).val(a.val()):this.hidden.attr("name",this.ns+"."+a.val()).val("1"),this.input.val(a.text()),this.label.text("=")),this._removeIcon();else if(a.hasClass("value")||a.text()){this.element.val("");var b=a.hasClass("value")?a.val()||a.text():a.text(),e=a.hasClass("value")?a.text():b;"*="===a.data("op")?this.element.data("readonly")?this.hidden.attr("name",this.ns).val(b):this.hidden.attr("name",
this.ns).val(JSON.stringify({op:"*=",val:b})):this.hidden.attr("name",this.ns).val(b);this.input.val(e);a.data("icon")&&this._addIcon(a.data("icon"))}else this.hidden.attr("name",this.ns);this.input.bind("autocompleteselect",function(a,b){b.item.option&&(b.item.option.selected=!0,d(this).trigger("select",a,{item:b.item.option}));if(b.item.option&&!d(b.item.option).hasClass("value"))if(d(b.item.option).data("period")){var e=c._showPeriodDialog();e.bind("select",function(a,b,d){c._updatePeriodInput(b,
d);c._removeIcon()});e.bind("cancel",function(){c.input.val("");c.hidden.attr("name",c.ns).val("");c.label.text("")})}else(e=d(b.item.option).val())?"value"===c.element.data("pass")?c.hidden.attr("name",c.ns).val(e):c.hidden.attr("name",c.ns+"."+e).val("1"):c.hidden.attr("name",c.ns).val(""),c.input.val(d(b.item.option).text()),c.label.text("="),c._removeIcon();else{var e=b.item.value,f=b.item.text||b.item.name;b.item.option&&(e=d(b.item.option).val());c.hidden.attr("name",c.ns).val(e);c.input.val(f);
c.label.text("=");b.item.icon?c._addIcon(b.item.icon):c._removeIcon()}c.element.trigger("change");c.element.data("readonly")&&setTimeout(function(){c.input.blur()});"function"===typeof c.options.select&&c.options.select.apply(this,[a,b]);return!1}).bind("autocompletechange",function(a,b){c._removeIfInvalid.call(c,a,b)});var f="";this.element.data("readonly")||(this.input.bind("keydown",function(){f=d(this).val()}),this.input.bind("keyup",function(){var a=d(this).val();f!==a&&(c._removeIcon(),a?(c.label.text("\u2248"),
c.hidden.attr("name",c.ns).val(JSON.stringify({val:a,op:"*="}))):(c.label.text(""),c.hidden.attr("name",c.ns).val("")));"function"===typeof c.options.keyup&&c.options.keyup.apply(this,[a,f]);f=a}));this.input.bind("keyup",function(a){13==a.keyCode&&!d(this).data("hold")&&d(this).val().trim()&&d(this).trigger("enter")});this.input.bind("search",function(){d(this).val()||(c._removeIcon(),c.hidden.attr("name",c.ns).val(""),c.label.text(""),c.ul.is(":visible")&&d(this).autocomplete("search",""),"function"===
typeof c.options.clear&&c.options.clear.apply(this))});this.input.bind("autocompleteopen",function(a,b){var e=c.input.width();c.ul.find("li.ui-menu-item").each(function(){var a=d(this),b=a.find(".count"),c=a.find(".crm-text");b.insertBefore(c);c.width(Math.max(e-b.outerWidth(!0)-30,0)).data("sep")&&a.css({borderTop:"1px solid #ccc"})});c.ul.width(e)});_other_version_||(this.input.bind("autocompleteopen",function(a,b){c.ul.width(c.input.outerWidth(!0)-5);if(void 0!==c.offset&&void 0!==c.count)if(c.offset<
c.count){c.height=c.ul.height();c.ul.unbind("scroll."+c.ns).bind("scroll."+c.ns,function(){var a=d(this).find(".dummy-end");a.length?d(this).scrollTop()+c.height>=a.position().top&&c.input.trigger("autocompleteload"):c.ul.unbind("scroll."+c.ns)});var e=c.ul.find(".ui-menu-item:first").height();d('<li class="dummy-end ignore-hover" role="menuitem"><a class="ui-corner-all" style="padding: .2em .4em; line-height: 1.5; display: block;"></a></li>').height(e).appendTo(c.ul);c.ul.css({overflowY:"scroll",
overflowX:"hidden",height:c.height})}else c.ul.unbind("scroll."+c.ns),c.ul.css({overflowY:"",overflowX:""});c.ul.find(".sep").closest("li").addClass("ignore-hover");var f=c.ul.width(),g="scroll"===c.ul.css("overflowY");c.ul.find("li.ui-menu-item").each(function(){var a=d(this);a.find(".sep").length?a.find(".sep").width(g?f-25:f-10):a.find(".crm-text").width(Math.max(f-a.find(".count").outerWidth(!0)-30,0))})}),this.input.bind("autocompleteload",function(a){!c.loading&&c.offset<c.count&&(c.loading=
!0,c.input.addClass("ui-autocomplete-loading"),d.get(c.options.url,{id:c.ns,offset:c.offset,limit:c.limit,term:c.input.val()},function(a){if("ok"===a.status){var b=a.data.values,e=[];c.ul.find(".ui-menu-item").each(function(){e.push(d(this).data("item.autocomplete"))});for(var f=0;f<b.length;f+=1)e.push(c._formItem(b[f]));c.count=a.data.count;c.response(e);c.offset+=b.length;c.offset>=c.count&&c.ul.find(".dummy-end").remove()}c.loading=!1;c.input.removeClass("ui-autocomplete-loading")},"json"))}));
this.input.bind("autocompletefocus",function(a,b){d(this).val(b.item.name);d(this).data("hold",1);return!1});this.input.bind("autocompleteclose",function(a,b){if(13===a.keyCode){var c=d(this);setTimeout(function(){c.data("hold",0)},200)}else d(this).data("hold",0)});this.input.focus(function(){c.arrow.show()}).blur(function(){c.wrapper.data("mouserover")||c.arrow.hide()});this.wrapper.mouseover(function(){d(this).data("mouserover",1);c.arrow.show()}).mouseout(function(){d(this).data("mouserover",
0);c.input.is(":focus")||c.arrow.hide()})}},_createShowAllButton:function(){var a=this.input,b=this.hidden,c=this.ns,e=this.element,f=this;e.find("option").length?(this.arrow=d("<a href='javascript:void(0);' style='margin: -2px 0 0 -20px;'><i class='icon16 darr'></i></a>").attr("tabIndex",-1).appendTo(this.wrapper).removeClass("ui-corner-all").addClass("custom-combobox-toggle ui-corner-right").mousedown(function(){a.focus();b.attr("name",c);f.ul.is(":hidden")?f._showSelectItems():a.autocomplete("search",
"");return!1}).hide(),e.data("readonly")&&this.wrapper.find(".icon16").css({backgroundColor:"white"}).parent().css({})):this.arrow=d()},_addIcon:function(a){this.input.after('<img class="flag" style="position: absolute; top: 3px; right: 41px; padding: 2px; background: white;" src="'+a+'"/>')},_removeIcon:function(){this.input.nextAll(".flag").remove()},_formItem:function(a,b){var c=a.label;!b||a.value||a.name||(c='<span style="visibility: hidden">empty</span>');_other_version_||(c=d.wa.encodeHTML(a.name));
c='<span class="crm-text" data-sep="'+(a.sep?1:0)+'">'+c;a.icon&&(c+=' <img src="'+a.icon+'" />');c+="</span>";d.isNumeric(a.count)&&(c+='<span class="count" style="margin-top: 2px;">'+a.count+"</span>");a.label=c;a.value||(a.value=a.name);return a},_showSelectItems:function(){var a=this,b=null,c=a.element.data("readonly"),e=!1;a.input.autocomplete("search","");b=this.response;b(this.element.children("option").map(function(){var b=d(this);if(b.hasClass("sep"))e=!0;else return b=a._formItem({icon:b.data("icon"),
count:b.data("count"),label:b.html(),name:b.text(),value:this.value,sep:e,option:this},c),e=!1,b}).toArray())},_source:function(a,b){var c=new RegExp(d.ui.autocomplete.escapeRegex(a.term),"i"),e=this;e.response=b;if(_other_version_&&!a.term)b([]);else{var f=function(a,c){_other_version_&&(a.highlight=1);d.get(e.options.url,a,function(a){var c=[],f=0;a&&"ok"===a.status&&(d.isArray(a.data.values)&&a.data.values.length&&(c=a.data.values),a.data.count&&(f=a.data.count));a=0;for(var g=c.length;a<g;a+=
1)c[a]=e._formItem(d.extend(c[a],{option:null}));e.offset=c.length;e.count=f;b(c)},"json")};if(_other_version_)a.term?f({term:a.term,id:this.ns}):b(this.element.children("option").map(function(){var b=d(this),e=b.html();if(b.hasClass("sep"))return d.extend({},sep,{option:this});if(this.value&&(!a.term||c.test(e))){var f=e;b.data("icon")&&(f+=' <img src="'+b.data("icon")+'" />');d.isNumeric(b.data("count"))&&(f+='<span class="count">'+b.data("count")+"</span>");return{label:f,text:e,value:this.value,
option:this}}}).toArray());else if(a.term&&this.element.data("autocomplete"))f({term:a.term,id:this.ns},function(a){e.ul.height(e.h*a.length);return a});else{var g=this.element.children("option").map(function(){var b=d(this),e=b.html();if(b.hasClass("sep"))return d.extend({},sep,{option:this});if(this.value&&(!a.term||c.test(e))){var f=e;b.data("icon")&&(f+=' <img src="'+b.data("icon")+'" />');d.isNumeric(b.data("count"))&&(f+='<span class="count">'+b.data("count")+"</span>");return{label:f,text:e,
value:this.value,option:this}}}).toArray();this.element.data("autocomplete")?f({term:"",id:this.ns},function(a){a.length&&g[g.length-1]&&!d(g[g.length-1].option).hasClass("sep")&&g.push(sep);g=g.concat(a);e.ul.height(e.h*g.length);return g}):b(g)}}},_removeIfInvalid:function(a,b){if(!b.item){var c=this.input,e=c.val().toLowerCase(),f=!1;this.element.children("option").each(function(){if(d(this).text().toLowerCase()===e)return this.selected=f=!0,!1});if(!f){var g=c.data("uiAutocomplete");g||(g=c.date("autocomplete"));
g&&(g.term="")}}},_updatePeriodInput:function(a,b){this.label.text("");this.hidden.attr("name",this.ns+".period").val("");var c=d.datepicker.formatDate("dd.mm.yy",new Date(a)),e=d.datepicker.formatDate("dd.mm.yy",new Date(b));a&&b?(this.hidden.val([d.datepicker.formatDate("yy-mm-dd",new Date(a)),d.datepicker.formatDate("yy-mm-dd",new Date(b))].join("--")),this.input.val(c===e?c:c+"\u2013"+e),this.label.text("=")):a?(this.hidden.val(JSON.stringify({val:d.datepicker.formatDate("yy-mm-dd",new Date(a)),
op:">="})),this.input.val(c),this.label.text(">=")):b&&(this.hidden.val(JSON.stringify({val:d.datepicker.formatDate("yy-mm-dd",new Date(b)),op:"<="})),this.label.text("<="))},_renderItem:function(a,b){return d("<li class='crm-search-ui-menu-item'>").append(d("<div>").text(b.label)).appendTo(a)},_showPeriodDialog:function(){d("#c-combobox-dialog").remove();return d('<div id="c-combobox-dialog"></div>').appendTo("body").periodDialog()},_destroy:function(){this.wrapper.remove();this.element.show()}})})(jQuery);(function(d){d.fn.periodDialog=function(a,b){function c(a){var b=g().find(".datepicker.start"),b=new Date(b.datepicker("getDate"));return d.datepicker.formatDate(a,b)}function e(a){var b=g().find(".datepicker.end"),b=new Date(b.datepicker("getDate"));return d.datepicker.formatDate(a,b)}function f(a,b,c){return d.datepicker.formatDate(a,new Date(b),c)}function g(){return this.data("$dialog")}if(!this.length)return this;if("getStartDate"===a)return c();if("getEndDate"===a)return e();if("formatDate"===
a)return f.apply(this,Array.prototype.slice.call(arguments,1));var h={};"object"===typeof a&&(this.data("periodDialogOptions",d.extend({start_datetime:null,end_datetime:null},a)),h=this.data("periodDialogOptions"));return function(){var a=d(".crm-dialog-search-period-wrapper.is-template").clone(),b="crm-dialog-search-period-wrapper-"+(Math.random()+"").slice(2);d(".crm-dialog-search-period-wrapper:not(.is-template)").remove();a.removeClass("is-template");a.attr("id",b);a.appendTo("body");a.show();
new CRMDialog({html:a,onOpen:function(a,b){a.find(".datepicker").datepicker();h.start_datetime&&a.find(".datepicker.start").datepicker("setDate",d.datepicker.parseDate("yy-mm-dd",h.start_datetime));h.end_datetime&&a.find(".datepicker.end").datepicker("setDate",d.datepicker.parseDate("yy-mm-dd",h.end_datetime));var c=a.find(".js-apply-action"),e=a.find(".js-cancel-action");c.click(function(c){c.preventDefault();c=a.find(".start").datepicker("getDate");var d=a.find(".end").datepicker("getDate");a.trigger("select",
[c,d]);b.close()});e.click(function(c){c.preventDefault();a.trigger("cancel");b.close()})}});this.data("$dialog",d("#"+b));return this.data("$dialog")}.call(this)}})(jQuery);var CRMSettings=function(d){CRMSettings=function(a){this.$wrapper=a.$wrapper;this.$sidebar=a.$sidebar;this.$activeMenuItem=!1;this.initClass()};CRMSettings.prototype.initClass=function(){this.initMenu()};CRMSettings.prototype.initMenu=function(){function a(a){if(e.length&&e[0]==a[0])return!1;e.length&&e.removeClass("selected");a.addClass("selected");e=a}function b(b){var e;b&&(e=c.find('a[href="'+b+'"]:first'));if(e&&e.length)a(e.closest("li"));else{b=c.find("a[href^='"+d.crm.app_url+"']");var f=
location.pathname,k=0,l=0;b.each(function(a){var b=d(this).attr("href"),c=b.length;0<=f.indexOf(b)&&c>k&&(k=c,l=a)});if(l||0===l)e=b.eq(l),a(e.closest("li"))}}var c=this.$sidebar,e=c.find("li.selected:first")||!1;e.length||b();c.on("click","li > a",function(){var b=d(this),c=b.attr("href");c&&"javascript:"!=c.substr(0,11)&&!b.hasClass("js-no-highlight")&&(a(b.closest("li")),d.crm.title.set(b.text()))})};return CRMSettings}(jQuery);var CRMSettingsCompanies=function(d){CRMSettingsCompanies=function(a){this.$wrapper=a.$wrapper;this.$footer=this.$wrapper.find(".js-footer-actions");this.$company=this.$wrapper.find(".c-company-section");this.$taxList=this.$company.find(".c-options-list");this.$logoWrapper=this.$wrapper.find(".js-logo-section");this.$submitButton=this.$wrapper.find(".js-submit-button");this.locales=a.locales;this.company_id=a.company_id;this.tax_option_template=a.tax_option_template;this.empty_class="is-empty";this.start_left=
0;this.logo=!1;this.files=[];this.initClass()};CRMSettingsCompanies.prototype.initClass=function(){var a=this;a.initTabs();a.initTaxActions();a.initLogoChange();a.initSubmit();a.initDeleteCompany();a.initTemplatesSection();a.$wrapper.on("change","input, select, textarea",function(){a.toggleButton(!0)})};CRMSettingsCompanies.prototype.initTabs=function(){var a=this.$wrapper.find(".c-tabs-wrapper"),b=this.$wrapper.find(".c-companies-wrapper"),c=b.find(".c-companies-list"),e=c.find(".c-company.selected");
(function(){function c(){d.contains(document,a[0])?e():h.off("resize",c)}function e(){var c=a.width()-k-10;b.css("max-width",c+"px")}var h=d(window),k=a.find(".c-add-wrapper").outerWidth(!0);e();h.on("resize",c)})();d.crm.tabSlider({$wrapper:b,$slider:c,$activeSlide:e.length?e:!1});(function(){var a=!1;c.sortable({distance:10,items:"> li",axis:"x",start:function(a,b){},stop:function(){var b={ids:function(){var a=[];c.find(".c-company").each(function(){a.push(d(this).data("id"))});return a.join(",")}()};
a&&a.abort();a=d.post("?module=settings&action=companiesSortSave",b,function(a){}).always(function(){a=!1})}})})()};CRMSettingsCompanies.prototype.initTaxActions=function(){var a=this,b=a.$company.find(".js-tax-name"),c=a.$taxList;a.$company.on("click",".js-delete-option",function(c){c.preventDefault();d(this).closest("li").remove();b.find("li").length||b.attr("required",!1);a.toggleButton(!0)});a.$company.on("click",".js-add-option",function(e){e.preventDefault();d(a.tax_option_template).appendTo(c);
b.attr("required",!0);a.toggleButton(!0)});(function(){c.sortable({handler:".js-sort-toggle",helper:"clone",distance:10,items:"> li",axis:"y",start:function(a,b){},stop:function(a,b){}})})()};CRMSettingsCompanies.prototype.initLogoChange=function(){function a(a){a=a[0];if(a.type.match(/^image\/(png|jpe?g|gif)$/)){var c=new FileReader;c.onload=function(a){k.attr("src",a.target.result);b.$logoWrapper.removeClass(b.empty_class)};c.readAsDataURL(a);b.logo=a}}var b=this,c=!1,e=!1,f=b.$logoWrapper,g=f.find(".js-drop-area"),
h=g.find(".js-field"),k=f.find(".js-image");g.on("drop",function(c){c.stopPropagation();c=c.originalEvent.dataTransfer.files;c.length&&(a(c),b.toggleButton(!0))});h.on("change",function(){var c=this.files;c.length&&(a(c),b.toggleButton(!0))});f.on("click",".js-delete-logo",function(a){a.preventDefault();k.attr("src","");if(a=h.attr("name")){var c=d('<input type="hidden" />').attr("name",a).val("delete");h.attr("name","").data("name",a).after(c)}f.addClass(b.empty_class);b.logo=!1;b.toggleButton(!0)});
d(document).on("myDragEnter",function(){d.contains(document,g[0])?g.addClass("is-highlighted"):d(document).off("myDragEnter",watcher)});d(document).on("myDragLeave",function(){d.contains(document,g[0])?g.removeClass("is-highlighted"):d(document).off("myDragLeave",watcher)});g.on("dragover",function(a){a.preventDefault();c?clearTimeout(c):e||(e=!0,g.addClass("is-hover"));c=setTimeout(function(){c=null;e=!1;g.removeClass("is-hover")},100)})};CRMSettingsCompanies.prototype.initSubmit=function(){var a=
this,b=a.$wrapper.find(".js-form"),c=a.$wrapper.find(".js-errors-place"),e=a.$taxList,f=!1;b.on("submit",function(g){function h(){e.find(".c-tax-option").each(function(a){var b=d(this),c=b.find(".js-type"),b=b.find(".js-percent");c.attr("name","company[tax_options]["+a+"][tax_type]");b.attr("name","company[tax_options]["+a+"][tax_percent]")});return b.serializeArray()}function k(e){e=e?e:[];d.each(e,function(e,f){var g=f.name,h=f.value,k=a.$wrapper.find('[name="'+g+'"]');"contact[firstname]"!==g||
k.is(":visible")||(k=a.$wrapper.find(".js-contact-autocomplete"));var l=d("<span class='c-error' />").addClass("errormsg").text(h);k.length&&!k.hasClass("error")?(k.parent().append(l),k.addClass("error").one("focus click change",function(){k.removeClass("error");l.remove()})):(c.append(l),b.one("submit",function(){remove(l)}))})}g.preventDefault();if(!f){f=!0;g=function(b){var c=new FormData;d.each(b,function(a,b){c.append(b.name,b.value)});d.each(a.files,function(a,b){c.append("images["+b.code+"]",
b.file)});a.logo&&c.append("logo",a.logo);(b=(b=document.cookie.match(/(?:^|; )_csrf=([^;]*)/))?decodeURIComponent(b[1]):"")&&c.append("_csrf",b);return c}(h());var l=d(a.locales.loading);l.insertAfter(a.$submitButton);d.ajax({url:"?module=settings&action=companiesSave",data:g,dataType:"json",processData:!1,contentType:!1,type:"POST",success:function(b){"ok"===b.status?(d(a.locales.saved_html).insertAfter(a.$submitButton),a.company_id?d.crm.content.reload():d.crm.content.load(d.crm.app_url+"settings/companies/"+
b.data.id+"/")):b.errors&&k(b.errors)}}).always(function(){l.remove();f=!1})}});b.on("keydown keypress keyup","input",function(a){13===a.keyCode&&a.preventDefault()})};CRMSettingsCompanies.prototype.initDeleteCompany=function(){var a=this,b=!1;a.$wrapper.on("click",".js-company-delete",function(c){c.preventDefault();b||(b=!0,d.post("?module=settings&action=companyDeleteDialog",{id:a.company_id},function(a){new CRMDialog({html:a,options:{onDelete:function(){d.crm.content.load(d.crm.app_url+"settings/companies/")}}})}).always(function(){b=
!1}))})};CRMSettingsCompanies.prototype.toggleButton=function(a){var b=this.$submitButton,c=this.$footer.find(".js-edit-actions");a?(b.addClass("yellow").removeClass("green"),c.show()):(b.removeClass("yellow").addClass("green"),c.hide())};CRMSettingsCompanies.prototype.initTemplatesSection=function(){function a(a,e){h&&h.abort();h=d.post("?module=settings&action=companiesRenderParams",{company_id:e,template_id:a},function(a){g.html(a);g.find(".c-color-section").each(function(){b(d(this))});g.find(".js-image-section").each(function(){c(d(this))})}).always(function(){h=
!1})}function b(a){var b=a.find(".c-colors"),c=a.find(".js-color-field"),e=b.find(".is-active"),f=function(a){f=function(a){this.$wrapper=a.$wrapper;this.$field=c;this.$icon=this.$wrapper.find(".js-toggle");this.$colorPicker=this.$wrapper.find(".js-color-picker");this.farbtastic=this.is_opened=!1;this.initClass()};f.prototype.initClass=function(){function b(){e.length&&(e.removeClass("is-active"),e=!1)}function c(b){a.contains(document,d.$wrapper[0])?27===b.keyCode&&d.is_opened&&d.displayToggle(!1):
a(document).off("keyup",c)}var d=this;d.farbtastic=a.farbtastic(d.$colorPicker,function(a){d.$field.val()!==a&&(b(),d.$field.val(a).change())});d.$wrapper.data("colorPicker",d);d.$field.on("change keyup",function(){var b=a(this).val();d.$icon.css("background-color",b);d.farbtastic.setColor(b)});d.$icon.on("click",function(a){a.preventDefault();d.displayToggle(!d.is_opened)});d.$field.on("focus",function(){d.is_opened||d.displayToggle(!0)});d.$field.on("keyup",b);a(document).on("keyup",c)};f.prototype.displayToggle=
function(a){a?(this.$wrapper.removeClass("is-hidden"),this.is_opened=!0):(this.$wrapper.addClass("is-hidden"),this.is_opened=!1)};return f}(jQuery),g=new f({$wrapper:a.find(".js-toggle-wrapper").first()});b.on("click",".js-set-color",function(a){a.preventDefault();a=d(this);e.length&&e.removeClass("is-active");a.addClass("is-active");e=a;a=a.data("color");c.val(a).change();g.is_opened&&g.displayToggle(!1)});c.trigger("change")}function c(a){function b(b){b=b[0];if(b.type.match(/^image\/(png|jpe?g|gif)$/)){var d=
new FileReader;d.onload=function(b){u.attr("src",b.target.result);a.removeClass(e.empty_class)};d.readAsDataURL(b);b={code:a.data("code"),type:"param_image",file:b};e.files.push(b);c();a.data("file",b)}}function c(){var b=a.data("file");b&&(b=e.files.indexOf(b),e.files.splice(b,1),a.data("file",!1))}var f=!1,g=!1,h=a.find(".js-drop-area"),k=h.find(".js-field"),u=a.find(".js-image");h.on("drop",function(a){a.stopPropagation();a=a.originalEvent.dataTransfer.files;a.length&&(b(a),e.toggleButton(!0))});
k.on("change",function(){var a=this.files;a.length&&(b(a),e.toggleButton(!0))});a.on("click",".js-delete-image",function(b){b.preventDefault();u.attr("src","");if(b=k.attr("name")){var f=d('<input type="hidden" />').attr("name",b).val("delete");k.attr("name","").data("name",b).after(f)}a.addClass(e.empty_class);c();e.toggleButton(!0)});d(document).on("myDragEnter",function(){d.contains(document,h[0])?h.addClass("is-highlighted"):d(document).off("myDragEnter",watcher)});d(document).on("myDragLeave",
function(){d.contains(document,h[0])?h.removeClass("is-highlighted"):d(document).off("myDragLeave",watcher)});h.on("dragover",function(a){a.preventDefault();f?clearTimeout(f):g||(g=!0,h.addClass("is-hover"));f=setTimeout(function(){f=null;g=!1;h.removeClass("is-hover")},100)})}var e=this,f=e.$wrapper.find(".c-templates-section"),g=f.find(".js-template-options-wrapper"),h=!1;(function(){var b=f.find(".js-template-wrapper.is-active");f.on("click",".js-template-wrapper",function(c){c.preventDefault();
c=d(this);if(!c.hasClass("is-active")){var f=c.data("id");c.find(".js-field").attr("checked",!0).trigger("change");b.length&&b.removeClass("is-active");b=c.addClass("is-active");a(f,e.company_id)}})})();(function(){var a=function(b){a=function(a){this.$wrapper=a.$wrapper;this.$slider=a.$slider;this.$activeSlide=a.$activeSlide||!1;this.type_class=!1;this.left=0;this.slider_w=this.wrapper_w=!1;this.initClass()};a.prototype.initClass=function(){function a(){b.contains(document,c.$wrapper[0])?c.wrapper_w!==
c.$wrapper.outerWidth()&&c.reset():d.off("resize",a)}var c=this,d=b(window);c.detectSliderWidth();c.initStartPosition();d.on("resize",a);c.$wrapper.on("click",".c-slider-arrow",function(a){a.preventDefault();a=b(this);a.hasClass("left")&&c.moveSlider(!1);a.hasClass("right")&&c.moveSlider(!0)})};a.prototype.initStartPosition=function(){var a=0;if(this.$activeSlide.length){var b=this.$activeSlide.outerWidth(),c=Math.floor(Math.abs(this.$wrapper.offset().left-this.$activeSlide.offset().left));c+b>this.wrapper_w&&
(a=c-40)}a?(this.start_left=a,this.moveSlider(!0,a)):this.showArrows()};a.prototype.detectSliderWidth=function(){this.wrapper_w=this.$wrapper.outerWidth();this.slider_w=this.$slider.outerWidth()};a.prototype.showArrows=function(){function a(a){b.type_class&&b.$wrapper.removeClass(b.type_class);a&&(b.$wrapper.addClass(a),b.type_class=a)}var b=this;0<=b.left?b.wrapper_w<b.slider_w?a("type-1"):a():b.wrapper_w<b.slider_w-Math.abs(b.left)?a("type-2"):a("type-3")};a.prototype.setLeft=function(a){0<Math.abs(a)||
(a=0);this.$slider.css({"-webkit-transform":"translate("+(a?a+"px":0)+", 0)",transform:"translate("+(a?a+"px":0)+", 0)"});this.left=a};a.prototype.moveSlider=function(a,b){var c=b?b:parseInt(this.wrapper_w/2),d=this.slider_w-this.wrapper_w,e=0;0<d&&(e=Math.abs(this.left)+(a?c:-c),e>d?e=d:0>e&&(e=0));this.setLeft(-e);this.showArrows()};a.prototype.reset=function(){this.setLeft(0);this.detectSliderWidth();this.showArrows()};return a}(d);new a({$wrapper:f.find(".c-templates-slider"),$slider:f.find(".c-templates-list")})})();
f.find(".c-color-section").each(function(){b(d(this))});f.find(".js-image-section").each(function(){c(d(this))})};return CRMSettingsCompanies}(jQuery),CRMCompanyDeleteDialog=function(d){CRMCompanyDeleteDialog=function(a){this.$wrapper=a.$wrapper;this.company_id=a.company_id;this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMCompanyDeleteDialog.prototype.initClass=function(){this.initDelete()};CRMCompanyDeleteDialog.prototype.initDelete=function(){function a(){var a={data:[],errors:[]},
b=f.serializeArray();d.each(b,function(b,c){a.data.push(c)});return a}function b(a,b){b=b?b:[];if(a){var c=Object.keys(a);d.each(c,function(c,d){b.push({name:d,value:a[d]})})}d.each(b,function(a,b){var c=b.value,f=e.$form.find('[name="'+b.name+'"]');if(f.length&&!f.hasClass("error")){var g=d("<span />").addClass("errormsg").text(c);e.$wrapper.append(g);f.addClass("error").one("focus click change",function(){f.removeClass("error");g.remove()})}})}function c(a){g||(g=!0,d.post("?module=settings&action=companyDelete",
a,function(a){"ok"===a.status?d.crm.content.load(d.crm.app_url+"settings/companies/"):b(a.errors)},"json").always(function(){g=!1}))}var e=this,f=e.$wrapper.find("form"),g=!1;f.on("submit",function(d){d.preventDefault();d=a();d.errors.length?b(!1,d.errors):c(d.data)})};return CRMCompanyDeleteDialog}(jQuery);var CRMSettingsCurrencies=function(d){CRMSettingsCurrencies=function(a){this.$wrapper=a.$wrapper;this.$currenciesList=this.$wrapper.find(".js-currencies-list");this.$currencySelect=this.$wrapper.find(".js-add-currency");this.currencies_is_locked=a.currencies_is_locked;this.currency_template_html=a.currency_template_html;this.copy_shop_currencies_dialog_html=a.copy_shop_currencies_dialog_html;this.locales=a.locales;this.currencies=a.currencies;this.initClass()};CRMSettingsCurrencies.prototype.initClass=
function(){this.currencies_is_locked||(this.initCurrencyAdd(),this.initCurrencyRemove(),this.initCurrenciesSort(),this.initChangePrimary(),this.initCurrencyEdit());this.initShopToggle()};CRMSettingsCurrencies.prototype.initCurrencyAdd=function(){function a(a,e){a=a.toLowerCase();b.$currencySelect.find("option").each(function(){var b=d(this);b.attr("value").toLowerCase()===a&&b.attr("disabled",!!e)})}var b=this;b.$currencySelect.on("change",function(){var a=d(this),e=a.val(),f=b.currencies[e],g=f.title,
f=f.sign;a.attr("disabled",!0);a=d(b.currency_template_html);a.data("code",e);a.find(".js-name").text(g);a.find(".js-current-code").text(e);a.find(".js-sign").text(f);a.find(".js-save-currency").addClass("js-save-new");a.addClass("is-edit");b.$currenciesList.append(a);a.find(".c-rate").select()}).on("removeCurrency",function(b,d){a(d)})};CRMSettingsCurrencies.prototype.initCurrencyRemove=function(){var a=this,b=!1;a.$wrapper.on("click",".js-remove-currency",function(c){function e(){b||(b=!0,d.post("?module=settings&action=currenciesDelete",
{code:h},function(b){"ok"==b.status&&(a.$currencySelect.trigger("removeCurrency",h),f.remove())}).always(function(){b=!1}))}c.preventDefault();var f=d(this).closest(".c-currency"),g=f.data("title"),h=f.data("code");if(!h)return!1;(function(){if(!b){b=!0;var c={title:a.locales.confirm_delete_title.replace("%currency_name",g),text:a.locales.confirm_delete_text,ok_button:a.locales.confirm_delete_button};d.post("?module=dialogConfirm",c,function(a){new CRMDialog({html:a,onConfirm:function(){e()}})}).always(function(){b=
!1})}})()})};CRMSettingsCurrencies.prototype.initCurrenciesSort=function(){function a(){var a=[];b.$currenciesList.find(".c-currency").each(function(){var b=d(this).data("code");b&&a.push(b)});return a}var b=this,c=!1;b.$currenciesList.sortable({distance:10,handle:".js-sort-toggle",helper:"clone",items:"> .c-currency",axis:"y",stop:function(){c&&c.abort();var b={codes:a()};c=d.post("?module=settings&action=currenciesSort",b,function(a){}).always(function(){c=!1})}})};CRMSettingsCurrencies.prototype.initShopToggle=
function(){function a(){"checked"===g.attr("checked")?k?d.crm.confirm.show({title:f.locales.confirm_shop_title,text:f.locales.confirm_shop_text,button:f.locales.confirm_shop_button,onConfirm:function(){e(!0)},onCancel:b}):c():e(!1)}function b(){h||(h=!0,g.iButton("toggle",!1),h=!1)}function c(){var a=(new CRMDialog({html:f.copy_shop_currencies_dialog_html})).$wrapper.find("form");a.on("submit",function(b){b.preventDefault();h||(h=!0,g.attr("disabled",!0),b=a.serializeArray(),d.post("?module=settings&action=currenciesShopCopy",
b,function(){d.crm.content.reload()}).always(function(){g.iButton("disable");h=!1}))});a.on("click",".js-cancel-button",b)}function e(a){h||(h=!0,g.attr("disabled",!0),d.post("?module=settings&action=currenciesShopCopy",a?{}:{disable:1},function(a){d.crm.content.reload()}).always(function(){g.iButton("disable");h=!1}))}var f=this,g=f.$wrapper.find(".js-shop-currency-toggle"),h=!1;if(!g.length)return!1;var k=g.data("use-shop")||!1;g.on("change",function(){h||a()});g.iButton({labelOn:"",labelOff:"",
classContainer:"c-ibutton ibutton-container mini"})};CRMSettingsCurrencies.prototype.initChangePrimary=function(){function a(){b||(b=!0,d.post("?module=settings&action=currenciesPrimary",{},function(a){new CRMDialog({html:a,options:{onChange:function(a){d.crm.content.reload()}}})}).always(function(){b=!1}))}var b=!1;this.$wrapper.on("click",".js-change-primary",function(b){b.preventDefault();a()})};CRMSettingsCurrencies.prototype.initCurrencyEdit=function(){var a=this.$currencySelect;this.$wrapper.on("click",
".js-edit-currency",function(a){a.preventDefault();d(this).closest(".c-currency").addClass("is-edit")});this.$wrapper.on("click",".js-save-currency",function(b){function c(a){a=a?a:[];d.each(a,function(a,b){var c=b.value,f=e.find('[name="'+b.name+'"]'),g=d("<span />").addClass("errormsg").text(c);f.length&&!f.hasClass("error")&&(f.closest("div").append(g),f.addClass("error").one("focus click",function(){f.removeClass("error");g.remove()}))})}b.preventDefault();var e=d(this).closest(".c-currency"),
f=!1;b="?module=settings&action=currenciesSave";0<e.find(".js-save-new").length&&(b="?module=settings&action=currenciesAdd");if(!f){var f=!0,g=e.find(".js-rate"),h=g.val(),h=h.replace(",",".");String(h).split(".");if(!(0<h)||9999999<h)return g.addClass("error").one("click",function(){g.removeClass("error")}),f=!1;var k={code:e.data("code"),rate:h};d.post(b,k,function(a){"ok"===a.status?e.toggleClass("is-edit").find(".js-rate-text").text(h):a.errors&&c(a.errors)}).always(function(){f=!1;a.attr("disabled",
!1);a.find(":selected").attr("disabled",!0);a.prop("selectedIndex",0)})}});this.$wrapper.on("click",".js-cancel",function(b){b.preventDefault();b=d(this).closest(".c-currency");0<b.find(".js-save-new").length?(b.remove(),a.attr("disabled",!1),a.prop("selectedIndex",0)):b.removeClass("is-edit")});this.$wrapper.on("keyup",".js-rate",function(a){13===a.keyCode&&d(this).closest(".c-currency").find(".js-save-currency").trigger("click")})};return CRMSettingsCurrencies}(jQuery),CRMSettingsCurrenciesPrimary=
function(d){CRMSettingsCurrenciesPrimary=function(a){this.$wrapper=a.$wrapper;this.$toggle=this.$wrapper.find(".js-currencies-toggle");this.dialog=this.$wrapper.data("dialog");this.currency_code=a.currency_code;this.initClass()};CRMSettingsCurrenciesPrimary.prototype.initClass=function(){var a=this,b=!1;a.$wrapper.on("click",".js-change-currency",function(c){c.preventDefault();var e=a.$toggle.val();e!==a.currency_code?b||(b=!0,d.post("?module=settings&action=currenciesPrimarySave",{code:e},function(b){"ok"==
b.status&&(a.dialog.options.onChange(e),a.dialog.close())}).always(function(){b=!1})):a.dialog.close()})};return CRMSettingsCurrenciesPrimary}(jQuery);var CRMSettingsFunnel=function(d){CRMSettingsFunnel=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$stagesSection=this.$wrapper.find(".c-stages-section");this.$stages=this.$stagesSection.find(".c-stages-list");this.funnel_id=a.funnel_id;this.stage_html=a.stage_html;this.locales=a.locales;this.initClass()};CRMSettingsFunnel.prototype.initClass=function(){var a=this;a.initSave();a.initDelete();a.initColorSection();a.initStagesSection();a.initNoAccessList();a.$form.on("input",
function(){a.toggleButton(!0)})};CRMSettingsFunnel.prototype.initColorSection=function(){function a(a){var e=g.find(".c-stage .c-ornament .svg-icon"),f=e.length;if(4===a.length||7===a.length){var h=(new d.crm.color(a)).getRange();b.val(h[0]);c.val(h[1]);e.each(function(a){a=h.getColor(Math.floor(100*(a+1)/f));var b=d(this),c=b.find("svg");c.length?c.find("polygon").css("fill",a):b.data("color",a)})}}var b=this.$wrapper.find(".js-start-color-field"),c=this.$wrapper.find(".js-end-color-field"),e=this.$wrapper.find(".c-color-section .c-colors"),
f=this.$wrapper.find(".c-color-section .js-color-field"),g=this.$wrapper.find(".c-color-section .c-stages"),h=e.find(".is-active"),k=function(a){k=function(a){this.$wrapper=a.$wrapper;this.$field=f;this.$icon=this.$wrapper.find(".js-toggle");this.$colorPicker=this.$wrapper.find(".js-color-picker");this.farbtastic=this.is_opened=!1;this.initClass()};k.prototype.initClass=function(){function b(){h.length&&(h.removeClass("is-active"),h=!1)}var c=this;c.farbtastic=a.farbtastic(c.$colorPicker,function(a){c.$field.val()!==
a&&(b(),c.$field.val(a).change())});c.$wrapper.data("colorPicker",c);c.$field.on("change keyup",function(){var b=a(this).val();c.$icon.css("background-color",b);c.farbtastic.setColor(b)});c.$icon.on("click",function(a){a.preventDefault();c.displayToggle(!c.is_opened)});c.$field.on("click",function(){c.displayToggle(!c.is_opened)});c.$field.on("keyup",b)};k.prototype.displayToggle=function(a){a?(this.$wrapper.removeClass("is-hidden"),this.is_opened=!0):(this.$wrapper.addClass("is-hidden"),this.is_opened=
!1)};return k}(jQuery);e.on("click",".js-set-color",function(a){a.preventDefault();a=d(this);h.length&&h.removeClass("is-active");a.addClass("is-active");h=a;a=a.data("color");f.val(a).change()});f.on("change",function(){a(f.val())});new k({$wrapper:this.$wrapper.find(".js-toggle-wrapper").first()});f.change();d.crm.renderSVG(this.$wrapper)};CRMSettingsFunnel.prototype.initStagesSection=function(){function a(a){function c(a){function c(){var a=parseInt(f.val()),b=parseInt(h.val()),c="";0<a&&0<b&&
(c=a*b);g.val(c)}function e(c){c?(a.addClass("is-extended"),f.focus()):(a.removeClass("is-extended"),f.val(""),g.val(""),b.toggleButton(!0))}var f=a.find(".js-visible-time-field"),g=a.find(".js-hidden-time-field"),h=a.find(".js-time-period-select");a.on("click",".js-show-time",function(){e(!0)});a.on("click",".js-remove-limit",function(){e(!1)});f.on("change",c);h.on("change",c);f.on("keyup",function(){var a=d(this),b=a.val(),b=parseInt(b.replace(",","").replace(".",""));isNaN(b)?a.val(""):b?a.val(b):
a.val("")});(function(){var a=g.val();a&&0<parseInt(a)&&(0===parseInt(a)%24?(h.val("24"),f.val(parseInt(a)/24)):h.val("1"))})()}a.find(".js-time-limit-wrapper").each(function(){c(d(this))})}var b=this,c=b.$stagesSection,e=b.$stages;e.on("click",".js-delete-stage",function(a){a.preventDefault();1<b.$stages.find("li").length&&d(this).closest(".c-stage").remove();b.toggleButton(!0)});e.on("keydown keypress keyup","input",function(a){13===a.keyCode&&a.preventDefault()});c.on("click",".js-add-stage",function(c){c.preventDefault();
c=d(b.stage_html);b.$stages.append(c);a(c);b.toggleButton(!0)});e.sortable({distance:10,handle:".js-sort-toggle",helper:"clone",items:"> li",axis:"y",start:function(a,b){},stop:function(a,c){b.toggleButton(!0)}});a(e)};CRMSettingsFunnel.prototype.initSave=function(){function a(){var a=c.$form.serializeArray();c.$stages.find("li").each(function(b){var c=d(this),e=c.data("id");a.push({name:"stages["+b+"][name]",value:c.find(".js-name-field").val()});e&&a.push({name:"stages["+b+"][id]",value:e})});return a}
function b(a){f.removeClass("yes").removeClass("no").addClass("loading").show();d.post("?module=settings&action=funnelSave",a,function(a){"ok"===a.status?(f.removeClass("loading").addClass("yes").show(),d.crm.content.load(d.crm.app_url+"settings/funnels/"+a.data.id+"/")):f.hide()},"json").always(function(){e=!1})}var c=this,e=!1,f=c.$wrapper.find(".js-loading");c.$form.on("submit",function(c){c.preventDefault();!e&&(c=a())&&(e=!0,b(c))})};CRMSettingsFunnel.prototype.initDelete=function(){function a(){var a=
{id:b.funnel_id};c||(c=!0,d.post("?module=settings&action=funnelDelete",a,function(a){d.crm.content.load(d.crm.app_url+"settings/funnels/")},"json").always(function(){c=!1}))}var b=this,c=!1;b.$wrapper.on("click",".js-delete-funnel",function(c){c.preventDefault();d.crm.confirm.show({title:b.locales.delete_confirm_title,text:b.locales.delete_confirm_text,button:b.locales.delete_confirm_button,onConfirm:a})})};CRMSettingsFunnel.prototype.toggleButton=function(a){var b=this.$wrapper.find(".js-funnel-save-button"),
c=this.$wrapper.find(".js-hidden-actions");a?(b.removeClass("green").addClass("yellow"),c.show()):(b.removeClass("yellow").addClass("green"),c.hide())};CRMSettingsFunnel.prototype.initNoAccessList=function(){var a=this.$wrapper.find(".js-no-access-wrapper");a.on("click",".js-show-access-list",function(b){b.preventDefault();a.addClass("is-active")});a.on("click",".js-hide-access-list",function(b){b.preventDefault();a.removeClass("is-active")})};return CRMSettingsFunnel}(jQuery);var CRMSettingsFunnels=function(d){CRMSettingsFunnels=function(a){this.$wrapper=a.$wrapper;this.initClass()};CRMSettingsFunnels.prototype.initClass=function(){this.initTabs()};CRMSettingsFunnels.prototype.initTabs=function(){var a=this.$wrapper.find(".js-funnels-tabs"),b=this.$wrapper.find(".c-funnels-wrapper"),c=b.find(".c-funnels-list"),e=c.find(".c-funnel.selected");(function(){function c(){d.contains(document,a[0])?e():h.off("resize",c)}function e(){var c=a.width()-k-10;b.css("max-width",c+"px")}
var h=d(window),k=a.find(".c-add-wrapper").outerWidth(!0);e();h.on("resize",c)})();d.crm.tabSlider({$wrapper:b,$slider:c,$activeSlide:e.length?e:!1});(function(){var a=!1;c.sortable({distance:10,items:"> li",axis:"x",stop:function(){var b={ids:function(){var a=[];c.find(".c-funnel").each(function(){a.push(d(this).data("id"))});return a.join(",")}()};a&&a.abort();a=d.post("?module=settings&action=funnelsSortSave",b,function(a){}).always(function(){a=!1})}})})()};return CRMSettingsFunnels}(jQuery);var crmSettingsField=function(d){var a=function(a){this.$wrapper=a.$wrapper;this.initClass()};a.prototype.initClass=function(){this.initSortable();this.bindEvents()};a.prototype.initSortable=function(){function a(a){return a.find(".field").map(function(){return d.trim(d(this).data("id"))||""}).toArray()}function c(a,b){g&&(g.abort(),g=null);return d.post(a,b,function(){g=null})}var e=d.crm.app_url+"?module=settings&action=fieldSaveSort",f,g=!1,h=this.$wrapper.find(".crm-other-fields");h.sortable({handle:".sort",
items:".field",axis:"y",tolerance:"pointer",delay:200,start:function(a,b){f=b.item.index()},stop:function(b,d){if(f!=d.item.index()){var g=a(h);c(e,{fields:g})}}})};a.prototype.bindEvents=function(){var a=d.crm.app_url+"?module=settings&action=fieldEdit",c=null;this.$wrapper.on("click",".crm-edit-field-link",function(){var b=d(this);c&&(c.abort(),c=null);c=d.post(a,{id:b.data("id")||null},function(a){new CRMDialog({html:a})})})};return a}(jQuery);var crmSettingsFieldEdit=function(d){var a=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.dialog=this.$wrapper.data("dialog");this.field=a.field||null;this.locales=a.locales;this.initClass()};a.prototype.initClass=function(){this.bindEvents();this.editSubFields();this.field||this.initIDAutoFiller()};a.prototype.bindEvents=function(){var a=this.$form;a.on("change",".crm-field-type-select",function(){var b=d(this).val(),e=a.find(".crm-values-textarea-wrapper").hide();
"Select"!==b&&"Radio"!==b||e.show()});a.on("click",".crm-add-name-another-language",function(){var b=d(this),e=b.data("id"),f=b.data("nameRegion"),g=a.find(".crm-local-input-wrapper");g.clone().find("input").attr("name","name["+e+"]").val("").attr("disabled",!1).attr("data-main-locale","").attr("data-error-id",e).removeClass("error").end().find(".crm-name-region").text(f).end().find(".errormsg").text("").end().insertAfter(g);b.hide();0>=a.find(".crm-add-name-another-language:not(:hidden)").length&&
a.find(".crm-add-name-another-language-wrapper").hide()});this.initSubmit();this.field&&(this.field.editable?this.initDeleteLink():this.initDisableLink())};a.prototype.initSubmit=function(){var a=this,c=null;a.$form.submit(function(b){b.preventDefault();c&&(c.abort(),c=null);c=a.save()})};a.prototype.initDeleteLink=function(){var a=this,c=d.crm.app_url+"?module=settings&action=fieldDeleteConfirm";a.$wrapper.on("click",".crm-field-delete",function(b){b.preventDefault();d.post(c,{id:a.field.id},function(b){new CRMDialog({html:b,
options:{edit_dialog:a.dialog},onOpen:function(){a.dialog.$wrapper.hide()}})})})};a.prototype.initDisableLink=function(){var a=this,c=a.$form,e=null;c.on("click",".crm-field-enable,.crm-field-disable",function(b){b.preventDefault();e&&(e.abort(),e=null);b={enable:d(this).hasClass("crm-field-enable")};e=d.post(c.attr("action"),b,function(b){"ok"==b.status&&(a.dialog.close(),location.href=d.crm.app_url+"settings/field/")})})};a.prototype.save=function(){var a=this,c=a.$form,e=d(".crm-dialog-edit-field-wrapper").find(".js-save"),
f=d('<i class="icon16 loading" style="vertical-align: middle;margin-left: 10px;"></i>');d(".loading").remove();e.prop("disabled",!0);var g=!0;c.find(".errormsg").text("");c.find(".error").removeClass("error");d('[name$="[localized_names]"]').each(function(){var b=d(this);!b.val()&&0>=b.parents(".template").length&&b.closest("tr").find('[name$="[_disabled]"]:checked').length&&(g=!1,b.addClass("error").parent().append(d('<em class="errormsg"></em>').text(a.locales.field_is_required)))});if(!g)return e.attr("disabled",
!1),!1;f.appendTo(e.parent());return d.post(c.attr("action"),c.serialize(),function(b){if("ok"==b.status){d(".loading").remove();var f=d('<i class="icon16 yes" style="vertical-align: middle;margin-left: 10px;"></i>');d.crm.content.reload();f.appendTo(e.parent());setTimeout(function(){a.dialog.close()},1E3)}if("ok"!==b.status&&b.errors){e.removeProp("disabled");d(".loading").remove();for(var f=0,g=b.errors.length;f<g;f+=1){var h=b.errors[f];if("string"===typeof h)c.find(".errormsg.crm-common-errors").append(h);
else if("object"===typeof h)for(var p in h)if(h.hasOwnProperty(p)){var n=c.find('[data-error-id="'+p+'"]');n.addClass("error");n.nextAll(".errormsg:first").text(h[p]);c.one("input, keydown",".error",function(){d(this).removeClass("error").nextAll(".errormsg:first").empty()})}}c.find("[type=submit]").attr("disabled",!1)}})};a.prototype.initIDAutoFiller=function(){var a,c=this.$form,e=c.find('input[name^="name["][data-main-locale]'),f=c.find('input[name="id_val"]'),g=null;f.on("keydown.check_edited",
function(){var a=d(this);a.data("val",a.val())}).on("keyup.check_edited",function(){var a=d(this);a.val()&&a.val()!=a.data("value")&&(a.off(".check_edited"),a.data("edited",1))});if(!f.prop("disabled")&&!f.data("edited"))c.on("keydown.crm-id-auto-filler",'input[name^="name["]',function(){var b=d(this),k=c.find('[type="submit"]'),l=f.next(".loading");if(b.data("main-locale")||!e.val())f.prop("disabled")||f.data("edited")?c.off(".crm-id-auto-filler"):(k.prop("disabled",!0),l=l.length?l:d('<i class="icon16 loading"></i>'),
l.insertAfter(f),a&&clearTimeout(a),a=setTimeout(function(){var b=function(){g&&(g.abort(),g=null);a&&clearTimeout(a);k.prop("disabled",!1);l.remove()};f.data("edited")?b():g=d.post(d.crm.app_url+"?module=settings&action=fieldTransliterate",c.find('input[name^="name["]').serialize(),function(a){b();"ok"!==a.status||f.data("edited")||f.val(a.data)},"json")},300))})};a.prototype.editSubFields=function(){function a(a){var b=d(".crm-dialog-edit-field-wrapper").find(".js-save");a?(b.removeClass("green").addClass("yellow"),
b.removeAttr("disabled")):b.removeClass("yellow").addClass("green")}var c=this,e=d(".crm-dialog-edit-field-wrapper"),f=e.find(".subfields-list > .ui-sortable"),g=1;f.sortable({items:".field-row",handle:".js-subfield-sort",axis:"y",update:function(b){a(!0)}});f.on("click","a.js-add-subfield",function(){var b=f.find(".field-row.template"),b=b.clone().insertBefore(b).removeClass("template").removeClass("hidden");c.dialog.resize();var e="__"+g;g++;b.find("[name]").each(function(){var a=d(this);a.attr("name",
a.attr("name").replace(/%FID%/g,e))});b.data("fieldId",e);b.find("select.type-selector").change();a(!0);return!1});e.on("click",".edit",function(){d(this).parents("tr").addClass("editor-on").removeClass("editor-off");a(!0);return!1});e.on("click",".js-delete-subfield",function(){var b=d(this).closest("tr");if(b.hasClass("just-added"))return b.remove(),!1;d.crm.confirm.show({title:c.locales.delete_subfield_title,text:c.locales.delete_subfield_text,button:c.locales.delete_subfield_button,onConfirm:function(){b.addClass("editor-off").removeClass("editor-on");
var c=b.find('input:hidden[name$="[_disabled]"]').attr("name").replace("[_disabled]","[_deleted]");d(".js-field-form-edit").append(d('<input type="hidden" name="" value="1">').attr("name",c));b.children().children(":not(label)").remove();b.find("label").addClass("gray").addClass("strike");a(!0)}})});f.on("click","a.add-item",function(){c.dialog.resize()});e.on("change","select.type-selector",function(){var b=d(this),c=b.closest("tr"),e=c.closest("table"),f=c.find(".field-advanced-settings").html('<i class="icon16 loading"></i>');
d.post(d.crm.app_url+"?module=settings&action=fieldEditor",{ftype:b.val(),fid:c.data("fieldId"),parent:e.data("fieldParent")||"",prefix:e.data("fieldPrefix")},function(b){f.html(b);a(!0)})});e.on("change",":checkbox, .name-input",function(){a(!0)})};return a}(jQuery);var crmSettingsFieldEditSubfieldValues=function(d){var a=function(a){this.$wrapper=d(".subfields-list");this.$hidden=a.hidden;this.$dialog_link=a.dialog_link;this.dialog_url=a.dialog_url;this.locales=a.locales;this.initClass()};a.prototype.initClass=function(){this.initValuesLink()};a.prototype.initValuesLink=function(){var a=this;a.$wrapper.find(a.$dialog_link).on("click",function(){d.get(a.dialog_url,function(b){new CRMDialog({html:b,onOpen:function(b,c){a.editValues(b,c);a.initSubmit(b,c)}})})})};
a.prototype.editValues=function(a,e){var c=a.find("form");a.on("click",".s-add-rule",function(){var c=a.find(".s-new-rule");if(c.length){var d=c.clone();d.removeClass("s-new-rule").show().insertBefore(c);d.find('input[name^="parent"]').attr("disabled",!1);d.find(".s-add-value").click();b(a);d=parseInt(c.find('input[name="parent[]"]').val(),10)+1||1;c.find('input[name="parent[]"]').val(d);c.find('input[name^="parent_value"]').attr("name","parent_value["+d+"]");c.find('input[name^="value"]').attr("name",
"value["+d+"][0]");e.resize()}return!1});a.on("click",".s-add-value",function(){var a=d(this).parents("table:first").find(".s-new-value");if(a.length){var b=a.clone();b.addClass("sortable").removeClass("s-new-value").show().insertBefore(a);b.find("input").attr("disabled",!1);var b=a.find("input:first").attr("name"),c=b.lastIndexOf("["),f=(parseInt(b.substr(c+1),10)||0)-1,b=b.substr(0,c)+"["+f+"]";a.find("input:first").attr("name",b)}e.resize();return!1});a.on("click",".s-delete-value",function(){var a=
d(this),b=a.attr("data-id"),a=a.parents("tr:first"),f=a.parents("table:first");b&&c.append('<input type="hidden" name="delete[]" value="'+b+'">');a.remove();f.find("tr.sortable:first").length||f.parents("div.field:first").remove();e.resize();return!1});b(a);this.$hidden.val()?a.find("select.otherwise-options").val("hide"):a.find("select.otherwise-options").val("input")};a.prototype.initSubmit=function(a,b){var c=this,e=a.find("form"),h=a.find(".js-save-values"),k=d('<i class="icon16 loading" style="vertical-align: middle;margin-left: 10px;"></i>'),
l=d('<i class="icon16 yes" style="vertical-align: middle;margin-left: 10px;"></i>');e.submit(function(f){f.preventDefault();h.prop("disabled",!0);d(".loading").remove();k.appendTo(h.parent());var g=!0;a.find(".errormsg").remove();a.find(".error").removeClass("error");a.find('[name^="parent_value["]:not(:disabled)').each(function(){this.value||(g=!1,d(this).addClass("error").after(d('<em class="errormsg"></em>').text(c.locales.field_is_required)))});a.find('[name^="value["]:not(:disabled)').each(function(){this.value||
(g=!1,d(this).addClass("error").after(d('<em class="errormsg"></em>').text(c.locales.field_is_required)))});if(!g)return d("#s-field-values").closest(".dialog").find(".dialog-buttons :submit").attr("disabled",!1),!1;"input"==a.find("select.otherwise-options").val()?c.$hidden.val(""):c.$hidden.val("1").closest("td").find('input:checkbox[name$="[required]"]').attr("checked",!1);d.post(e.attr("action"),e.serialize()).done(function(a){d(".loading").remove();l.appendTo(h.parent());"ok"==a.status&&(c.$dialog_link.parents(".field-advanced-settings").find(".show-when-modified").show(),
c.$dialog_link.parents(".field-advanced-settings").find(".hide-when-modified").hide(),setTimeout(function(){b.close()},1E3))})})};var b=function(a,b){a.find(".value table>tbody").sortable({distance:5,helper:"clone",items:"tr.sortable",opacity:.75,axis:"y",tolerance:"pointer"})};return a}(jQuery);var crmSettingsFieldDeleteConfirm=function(d){var a=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.dialog=this.$wrapper.data("dialog");this.edit_dialog=this.dialog.options.edit_dialog;this.initClass()};a.prototype.initClass=function(){this.bindEvents()};a.prototype.bindEvents=function(){var a=this,c=a.$form;a.$form.find(".crm-cancel").click(function(){a.dialog.close();a.edit_dialog.$wrapper.show()});c.submit(function(b){b.preventDefault();a.save()})};a.prototype.save=
function(){var a=this,c=a.$form;d.post(c.attr("action"),c.serialize(),function(){a.dialog.close();a.edit_dialog.close();location.href=d.crm.app_url+"settings/field/"})};return a}(jQuery);var CRMSettingsSources=function(d){CRMSettingsSources=function(a){this.$wrapper=a.$wrapper;this.messages=a.messages||{};this.messages.enable=this.messages.enable||"";this.messages.disable=this.messages.disable||"";this.source_type=a.source_type;this.initClass()};CRMSettingsSources.prototype.initClass=function(){d.crm.renderSVG(this.$wrapper);this.initTabs();this.initWebFormLinks();this.initDisableLinks()};CRMSettingsSources.prototype.initTabs=function(){var a=this.$wrapper,b=function(b){var c=a.find('.c-tab[data-type="'+
b+'"]'),e=a.find('.c-tab-content[data-type="'+b+'"]');a.find(".c-tab.selected").removeClass("selected");a.find(".c-tab-content").hide();c.addClass("selected");e.show();d.crm.storage.set("crm/settings/source_tab",b)},c=d.crm.storage.get("crm/settings/source_tab");c||(c="email");this.source_type&&(c=this.source_type);b(c);a.on("click",".c-tab-link",function(a){a.preventDefault();b(d(this).closest(".c-tab").data("type"))})};CRMSettingsSources.prototype.initWebFormLinks=function(){this.$wrapper.on("click",
".js-c-web-form-link",function(){d.crm.storage.set("crm/settings/web_form_referrer","settings/sources")})};CRMSettingsSources.prototype.initDisableLinks=function(){var a=this,b=null,c=d.crm.app_url+"?module=settingsSource&action=disable";a.$wrapper.on("click",".js-c-disable-link",function(e){e.preventDefault();var f=d(this),g=f.closest(".c-source");e=g.data("id");var h=g.hasClass("c-is-disabled"),k=g.find(".c-loading");b&&b.abort();k.show();b=d.post(c,{id:e,disabled:h?0:1}).done(function(b){"ok"===
b.status&&(b.data.disabled?(f.text(a.messages.enable),g.addClass("c-is-disabled")):(f.text(a.messages.disable),g.removeClass("c-is-disabled")))}).always(function(){b=null;k.hide()})})};CRMSettingsSources.deleteSource=function(a,b){var c=b.messages||{};d.crm.confirm.show({title:c.delete_confirm_title,text:c.delete_confirm_text,button:c.delete_confirm_button,onConfirm:function(){var b=d.crm.app_url+"?module=settings&action=sourceDelete",c=this.$wrapper.find(".crm-loading").show(),g=this.$wrapper.find(".js-confirm-dialog").attr("disabled",
!0);d.post(b,{id:a}).always(function(){d.crm.content.load(d.crm.app_url+"settings/sources/");c.hide();g.attr("disabled",!1)});return!1}})};return CRMSettingsSources}(jQuery);var CRMSettingsSourceEmail=function(d){CRMSettingsSourceEmail=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$button=this.$form.find("[type=submit]");this.source=a.source||{};this.messages=a.messages||{};this.changed=!1;this.submit_xhr=null;this.initClass()};CRMSettingsSourceEmail.prototype.initClass=function(){this.initBlockToggles();this.initStickyButton();this.initSubmit();this.initSecureCheckboxes();this.initChangeListeners();this.initIButton();0<this.source.id&&
this.initDeleteLink();this.initBlocks()};CRMSettingsSourceEmail.prototype.initSecureCheckboxes=function(){var a=this.$form.find(".c-secure-checkbox");a.click(function(){var b=d(this);b.is(":checked")&&a.not(b).attr("checked",!1)})};CRMSettingsSourceEmail.prototype.initChangeListeners=function(){var a=this,b=a.$form;b.on("change","input,textarea,select",function(c){a.setFormChanged();c.isTrigger||CRMSettingsSourceEmail.clearValidateErrors(b)});b.on("keyup","input:text,input:password,textarea",function(c){a.setFormChanged();
c.isTrigger||CRMSettingsSourceEmail.clearValidateErrors(b)})};CRMSettingsSourceEmail.prototype.initBlockToggles=function(){this.$wrapper.find(".js-crm-block-toggle").change(function(){var a=d(this),b=a.closest(".field").find(".js-crm-block");a.is(":checked")?b.show():b.hide()}).trigger("change");this.initDealCreateToggle()};CRMSettingsSourceEmail.prototype.initDealCreateToggle=function(){var a=this.$wrapper;a.find(".crm-source-settings-block-create_deal").on("toggled",function(b,c){var d=a.find(".js-responsible-section").data("block_object");
c?d.reload({}):d.reload({funnel_id:0})})};CRMSettingsSourceEmail.prototype.initStickyButton=function(){this.$wrapper.find(".crm-form-buttons").sticky({fixed_css:{bottom:0,"z-index":100},fixed_class:"sticky-bottom-shadow",showFixed:function(a){a.element.css("min-height",a.element.height());a.fixed_clone.empty().append(a.element.children())},hideFixed:function(a){a.fixed_clone.children().appendTo(a.element)},updateFixed:function(a,b){this.width(a.element.width())}})};CRMSettingsSourceEmail.prototype.setFormChanged=
function(a){(a=void 0!==a?a:!0)?this.$button.removeClass("green").addClass("yellow"):this.$button.removeClass("yellow").addClass("green");this.changed=a};CRMSettingsSourceEmail.prototype.clearValidateErrors=function(){var a=this.$form;a.find(".error").removeClass("error");a.find(".crm-errors-block").remove()};CRMSettingsSourceEmail.prototype.initSubmit=function(){var a=this,b=a.$form,c=a.$wrapper.find(".crm-form-buttons").find(".crm-loading"),e=a.$button,f=b.find(".crm-success-status"),g=d.crm.app_url+
"?module=settingsSource&action=save";CRMSettingsSourceEmail.clearValidateErrors(b);b.submit(function(h){function k(){CRMSettingsSourceEmail.showValidateErrors(b,{"":a.messages.connection_failed})}function l(){c.hide();e.prop("disabled",!1);a.submit_xhr=null}h.preventDefault();h=b.serializeArray();h.push({name:"id",value:0<a.source.id?a.source.id:a.source.provider});c.show();e.prop("disabled",!0);a.submit_xhr&&a.submit_xhr.abort();a.submit_xhr=d.post(g,h,null,"json").done(function(c){c?"ok"!=c.status?
CRMSettingsSourceEmail.showValidateErrors(b,c.errors||{}):(a.setFormChanged(!1),f.show().fadeOut(500,function(){c.data.source?d.crm.content.load(d.crm.app_url+"settings/sources/"+c.data.source.id+"/"):d.crm.content.reload()})):(l(),k())}).fail(k).always(l)})};CRMSettingsSourceEmail.prototype.initDeleteLink=function(){var a=this;a.$wrapper.find(".crm-delete-source-link").click(function(b){b.preventDefault();CRMSettingsSources.deleteSource(a.source.id,{messages:a.messages})})};CRMSettingsSourceEmail.prototype.initIButton=
function(){this.$wrapper.find(".js-ibutton").each(function(){var a=d(this);!a.data("iButton")&&a.iButton({labelOn:"",labelOff:"",classContainer:"c-ibutton ibutton-container mini"})})};CRMSettingsSourceEmail.prototype.initBlocks=function(){var a=this.$wrapper,b=a.find(".js-deal-section"),a=a.find(".js-responsible-section"),b=b.data("block_object"),a=a.data("block_object");b.setResponsibleBlock(a)};CRMSettingsSourceEmail.clearValidateErrors=function(a){a.find(".error").removeClass("error");a.find(".crm-errors-block").remove()};
CRMSettingsSourceEmail.showValidateErrors=function(a,b){var c={};d.each(b||{},function(a,b){"params"===a?d.each(b,function(a,b){c["source[params]["+a+"]"]=d.isArray(b)?b:[b]}):c[a?"source["+a+"]":""]=d.isArray(b)?b:[b]});CRMSettingsSourceEmail.clearValidateErrors(a);d.each(c,function(b,c){var e=d('<div class="crm-errors-block"></div>'),f=b?a.find('[name="'+b+'"]'):d();f.addClass("error");d.each(c,function(a,b){e.append('<em class="errormsg">'+b+"</em>")});f.length?f.after(e):a.find(".crm-common-errors-block").append(e)})};
return CRMSettingsSourceEmail}(jQuery);var CRMSettingsSourceEmailConnectionTestBlock=function(d){CRMSettingsSourceEmailConnectionTestBlock=function(a){this.$wrapper=a.$wrapper;this.source=a.source||{};this.url=a.url||d.crm.app_url+"?module=settingsSource&action=testConnection";this.initClass()};CRMSettingsSourceEmailConnectionTestBlock.prototype.initClass=function(){var a=this,b=a.$wrapper,c=b.find(".c-test-connection-button-block"),e=c.find(".c-loading"),f=c.find(".c-test-connection-success-message"),g=c.find(".c-test-connection-fail-message"),
h=null,k=b.find(".js-connection-settings-input"),l=b.find(".js-connection-settings-checkbox"),m=b.find(".c-test-connection-button"),p=function(){var c=a.url;h&&h.abort();f.hide();g.hide();e.show();k.attr("disabled",!0);var m=function(){g.show()};d.post(c,function(){var b=function(a){return{name:d.trim(a.attr("name")).match(/^source\[params\]\[(.+)\]$/)[1],value:a.val()}},c=[];k.each(function(){c.push(b(d(this)))});l.each(function(){var a=d(this);a.is(":checked")&&c.push(b(a))});0<a.source.id?c.push({name:"id",
value:a.source.id}):c.push({name:"id",value:a.source.provider});return c}(),null,"json").done(function(a){a&&"ok"==a.status?f.show():(m(),CRMSettingsSourceEmail.showValidateErrors(b,a.errors||{}))}).fail(m).always(function(){h=null;k.attr("disabled",!1);e.hide()})};(function(){var b=k.length,e=function(){var c=0;k.each(function(){0<d.trim(d(this).val()).length&&(c+=1)});return 0>=a.source.id?c==b:c==b-1},h=function(){var a=[];k.each(function(){a.push(d.trim(d(this).val()))});l.each(function(){a.push(d(this).is(":checked")?
"1":"0")});return a.join("@")},p=h(),t=function(){var a=h(),b=a!==p;p=a;return b},A=function(){c.show();m.show();f.hide();g.hide()},v=function(){e()?t()&&A():c.hide()},x=null;k.on("change",v).on("keydown",function(){x&&clearTimeout(x);x=setTimeout(function(){v()},250)});l.on("change",function(){t()&&A()})})();(function(){m.click(function(a){a.preventDefault();p()})})()};return CRMSettingsSourceEmailConnectionTestBlock}(jQuery);var CRMSettingsSourceIm=function(d){CRMSettingsSourceIm=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$button=this.$form.find("[type=submit]");this.source=a.source||{};this.messages=a.messages||{};this.changed=!1;this.submit_xhr=null;this.initClass()};CRMSettingsSourceIm.prototype.initClass=function(){this.initBlockToggles();this.initStickyButton();this.initSubmit();this.initChangeListeners();this.initIButton();0<this.source.id&&this.initDeleteLink()};CRMSettingsSourceIm.prototype.initChangeListeners=
function(){var a=this,b=a.$form;b.on("change","input,textarea,select",function(c){a.setFormChanged();c.isTrigger||CRMSettingsSourceIm.clearValidateErrors(b)});b.on("keyup","input:text,input:password,textarea",function(c){a.setFormChanged();c.isTrigger||CRMSettingsSourceIm.clearValidateErrors(b)})};CRMSettingsSourceIm.prototype.initBlockToggles=function(){this.$wrapper.find(".js-crm-block-toggle").change(function(){var a=d(this),b=a.closest(".field").find(".js-crm-block");a.is(":checked")?b.show():
b.hide()}).trigger("change");this.initDealCreateToggle()};CRMSettingsSourceIm.prototype.initDealCreateToggle=function(){var a=this.$wrapper;a.find(".crm-source-settings-block-create_deal").on("toggled",function(b,c){var d=a.find(".js-responsible-section").data("block_object");c?d.reload({}):d.reload({funnel_id:0})})};CRMSettingsSourceIm.prototype.initStickyButton=function(){this.$wrapper.find(".crm-form-buttons").sticky({fixed_css:{bottom:0,"z-index":100},fixed_class:"sticky-bottom-shadow",showFixed:function(a){a.element.css("min-height",
a.element.height());a.fixed_clone.empty().append(a.element.children())},hideFixed:function(a){a.fixed_clone.children().appendTo(a.element)},updateFixed:function(a,b){this.width(a.element.width())}})};CRMSettingsSourceIm.prototype.setFormChanged=function(a){(a=void 0!==a?a:!0)?this.$button.removeClass("green").addClass("yellow"):this.$button.removeClass("yellow").addClass("green");this.changed=a};CRMSettingsSourceIm.prototype.clearValidateErrors=function(){var a=this.$form;a.find(".error").removeClass("error");
a.find(".crm-errors-block").remove()};CRMSettingsSourceIm.prototype.initSubmit=function(){var a=this,b=a.$form,c=a.$wrapper.find(".crm-form-buttons").find(".crm-loading"),e=a.$button,f=b.find(".crm-success-status"),g=d.crm.app_url+"?module=settingsSource&action=save";CRMSettingsSourceIm.clearValidateErrors(b);b.submit(function(h){h.preventDefault();h=b.serializeArray();h.push({name:"id",value:0<a.source.id?a.source.id:a.source.provider});c.show();e.prop("disabled",!0);a.submit_xhr&&a.submit_xhr.abort();
a.submit_xhr=d.post(g,h,null,"json").done(function(c){"ok"===c.status?(a.setFormChanged(!1),f.show().fadeOut(500,function(){c.data.source?d.crm.content.load(d.crm.app_url+"settings/sources/"+c.data.source.id+"/"):d.crm.content.reload()})):CRMSettingsSourceIm.showValidateErrors(b,c.errors||{})}).always(function(){c.hide();e.prop("disabled",!1);a.submit_xhr=null})})};CRMSettingsSourceIm.prototype.initDeleteLink=function(){var a=this;a.$wrapper.find(".crm-delete-source-link").click(function(b){b.preventDefault();
CRMSettingsSources.deleteSource(a.source.id,{messages:a.messages})})};CRMSettingsSourceIm.prototype.initIButton=function(){this.$wrapper.find(".js-ibutton").each(function(){var a=d(this);!a.data("iButton")&&a.iButton({labelOn:"",labelOff:"",classContainer:"c-ibutton ibutton-container mini"})})};CRMSettingsSourceIm.clearValidateErrors=function(a){a.find(".error").removeClass("error");a.find(".crm-errors-block").remove()};CRMSettingsSourceIm.showValidateErrors=function(a,b){var c={};d.each(b||{},function(a,
b){"params"===a?d.each(b,function(a,b){c["source[params]["+a+"]"]=d.isArray(b)?b:[b]}):c[a?"source["+a+"]":""]=d.isArray(b)?b:[b]});CRMSettingsSourceIm.clearValidateErrors(a);d.each(c,function(b,c){var e=d('<div class="crm-errors-block"></div>'),f=b?a.find('[name="'+b+'"]'):d();f.addClass("error");d.each(c,function(a,b){e.append('<em class="errormsg">'+b+"</em>")});f.length?f.after(e):a.find(".crm-common-errors-block").append(e)})};return CRMSettingsSourceIm}(jQuery);var CRMSettingsSourceWithContactBlock=function(d){CRMSettingsSourceWithContactBlock=function(a){this.$wrapper=a.$wrapper;this.segments_list_stages=a.segments_list_stages||{};this.init()};CRMSettingsSourceWithContactBlock.prototype.init=function(){this.initAddToSegments()};CRMSettingsSourceWithContactBlock.prototype.initAddToSegments=function(){var a=this.$wrapper,b=this.segments_list_stages,c=a.find(".c-segments-ul-fold-link"),d=a.find(".c-segments-ul");c.click(function(){var a=c.data("state"),a=
"fold"===a?"unfold":"fold",e=(b[a]||{}).link_text||"";c.data("state",a).find(".c-link-text").text(e);"fold"===a?d.slideUp():d.slideDown()})};return CRMSettingsSourceWithContactBlock}(jQuery);var CRMSettingsSourceCreateDealBlock=function(d){CRMSettingsSourceCreateDealBlock=function(a){this.$wrapper=a.$wrapper;this.$funnel=this.$wrapper.find(".js-funnel-id");this.$stage=this.$wrapper.find(".js-stage-id");this.url=d.crm.app_url+"?module=settingsSourceBlock&action=createDeal";this.source=a.source||{};this.ns="."+d.trim(this.$wrapper.attr("id"));this.id=a.id;this.namespace=a.namespace||"";this.class_id=a.class_id||"";this.responsible_block=null;this.initClass();this.$wrapper.data("block_object",
this)};CRMSettingsSourceCreateDealBlock.prototype.setResponsibleBlock=function(a){this.responsible_block=a};CRMSettingsSourceCreateDealBlock.prototype.initClass=function(){var a=this;a.$funnel.on("change"+a.ns,function(){var b=a.$stage.closest("li"),c=b.find(".js-visible-link .js-text");b.find(".menu-v.with-icons").remove();c.find(".funnel-state").remove();c.prepend('<i class="icon16 loading">');a.reload()});a.initFunnelsSelect();a.initStagesSelect()};CRMSettingsSourceCreateDealBlock.prototype.initFunnelsSelect=
function(){var a=this.$wrapper.find(".js-funnels-list"),b=a.find(".js-visible-link"),c=a.find(".js-field"),e=a.find(".menu-v");e.on("click","a",function(){var a=d(this);b.find(".js-text").html(a.html());e.find(".selected").removeClass("selected");a.closest("li").addClass("selected");e.hide();setTimeout(function(){e.removeAttr("style")},200);a=a.data("id");c.val(a).trigger("change")});d.crm.renderSVG(a)};CRMSettingsSourceCreateDealBlock.prototype.initStagesSelect=function(){var a=this.$wrapper.find(".js-stages-list"),
b=a.find(".js-visible-link"),c=a.find(".js-field"),e=a.find(".menu-v");e.on("click","a",function(){var a=d(this);b.find(".js-text").html(a.html());e.find(".selected").removeClass("selected");a.closest("li").addClass("selected");e.hide();setTimeout(function(){e.removeAttr("style")},200);a=a.data("id");c.val(a).trigger("change")});d.crm.renderSVG(a)};CRMSettingsSourceCreateDealBlock.prototype.reload=function(){var a=this,b=a.$stage,c=a.url,e=a.responsible_block,b={id:a.id,funnel_id:a.$funnel.val(),
stage_id:b.val(),namespace:a.namespace},f=d.Deferred(),g=d.Deferred();d.when(f,g).done(function(a,b){b&&a.setResponsibleBlock(b)});d.get(c,b,function(b){b=d("<div>").html(b);var c=b.find("."+a.class_id);a.$wrapper.replaceWith(c);f.resolve(c.data("block_object"));a.destroy();b.remove()});e?e.reload({funnel_id:b.funnel_id},function(a){g.resolve(a)}):g.resolve()};CRMSettingsSourceCreateDealBlock.prototype.destroy=function(){var a=this;a.$funnel.off(a.ns);a.$wrapper.removeData("block_object");d.each(a,
function(b){delete a[b]})};return CRMSettingsSourceCreateDealBlock}(jQuery);var CRMSettingsSourceResponsibleBlock=function(d){CRMSettingsSourceResponsibleBlock=function(a){this.$wrapper=a.$wrapper;this.$group=this.$wrapper.find(".crm-group-id");this.$user=this.$wrapper.find(".crm-user");this.$user_id=this.$wrapper.find(".crm-responsible-contact_id");this.$user_info=this.$wrapper.find(".crm-user-info-block");this.$user_delete_link=this.$user_info.find(".crm-delete-link");this.url=d.crm.app_url+"?module=settingsSourceBlock&action=responsible";this.ns="."+d.trim(this.$wrapper.attr("id"));
this.source=a.source||{};this.funnel_id=this.source.funnel_id;this.namespace=a.namespace||"";this.class_id=a.class_id||"";this.initClass();this.$wrapper.data("block_object",this)};CRMSettingsSourceResponsibleBlock.prototype.initClass=function(){var a=this,b=a.$wrapper,c=a.$group,e=a.$user,f=a.$user_id,g=a.$user_delete_link,h=a.$user_info,k=f.val(),l=function(){e.show().attr("disabled",!1).attr("required",!0)},m=function(){e.hide().attr("disabled",!0).attr("required",!1)};c.on("change"+a.ns,function(){var a=
d(this);f.val("");"personally"===a.val()?l():(m(),h.hide());0<a.val()&&f.val(-a.val());k!=f.val()&&(b.trigger("changeResponsibleUser",[k,f.val()]),k=f.val())});g.on("click"+a.ns,function(a){a.preventDefault();f.val("");l();h.hide()});e.autocomplete({source:d.crm.app_url+"?module=autocomplete&type=user&funnel_id="+a.funnel_id,minLength:0,html:!0,focus:function(){return!1},select:function(a,c){e.val("");if(0>=c.item.rights)return!1;m();h.show();h.find(".crm-user-icon").css("background-image","url("+
c.item.photo_url+")");h.find(".crm-user-name").text(c.item.name).attr("title",c.item.name);f.val(c.item.id);k!=f.val()&&(b.trigger("changeResponsibleUser",[k,f.val()]),k=f.val());return!1}}).data("ui-autocomplete")._renderItem=function(b,c){var e=d("<li />");e.addClass("ui-menu-item-html").append("<div>"+c.value+"</div>").appendTo(b);0<a.funnel_id&&!c.rights&&(e.addClass("is-locked"),e.on("click"+a.ns,function(a){a.preventDefault();a.stopPropagation()}));return e};e.on("focus"+a.ns,function(){e.data("uiAutocomplete").search(e.val())})};
CRMSettingsSourceResponsibleBlock.prototype.reload=function(a,b){var c=this,e=this.$user_info,f=d('<i class="icon16 loading"></i>'),g=c.url;e.is(":visible")&&(c.$user_delete_link.hide(),f.css({marginTop:"-16px",marginRight:"-16px","float":"right"}));e.after(f);a=a||{};a.namespace=c.namespace;"undefined"===typeof a.funnel_id&&(a.funnel_id=c.funnel_id);a.responsible_contact_id=c.$user_id.val();a.group_id=c.$group.val();f.show();d.get(g,a,function(a){a=d("<div>").html(a);var e=a.find("."+c.class_id);
c.$wrapper.replaceWith(e);e=e.data("block_object");b&&b(e);a.remove();c.destroy()})};CRMSettingsSourceResponsibleBlock.prototype.destroy=function(){var a=this;a.$user_delete_link.off(a.ns);a.$group.off(a.ns);a.$wrapper.removeData("block_object");a.$user.data("ui-autocomplete")&&(a.$user.autocomplete("destroy"),a.$user.removeData("ui-autocomplete"));d.each(a,function(b){delete a[b]})};return CRMSettingsSourceResponsibleBlock}(jQuery);var CRMSettingsForms=function(d){CRMSettingsForms=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$button=this.$form.find("[type=submit]");this.submit_xhr=null;this.initClass()};CRMSettingsForms.prototype.initClass=function(){d.crm.renderSVG(this.$wrapper)};return CRMSettingsForms}(jQuery);var crmSettingsForm=function(d){crmSettingsForm=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find(".crm-form-settings-form");this.$form_fields=this.$wrapper.find(".crm-form-fields");this.$form_available_fields=this.$wrapper.find(".crm-available-fields");this.$confirmation_checkbox=this.$wrapper.find(".crm-confirmation-checkbox");this.$confirmation_enable_text=this.$wrapper.find(".crm-confirmation-enable-text");this.$email_confirm_block=this.$wrapper.find(".crm-form-email-confirm-block");
this.$create_deal_block_wrapper=this.$wrapper.find(".crm-form-settings-block-form_create_deal");this.$button=this.$form.find("[type=submit]");this.$delete_link=this.$wrapper.find(".crm-delete-form-link");this.$copy=this.$wrapper.find(".js-copy.icon16");this.$iframe_textarea=this.$wrapper.find(".crm-iframe-code");this.$available_deal_related_field=this.$form_available_fields.find('.crm-form-field[data-form-field-type="deal"]').add(this.$form_available_fields.find('.crm-form-field[data-id="!deal_description"]')).add(this.$form_available_fields.find('.crm-form-field[data-id="!deal_attachments"]'));
this.$edit_dialog_template=this.$wrapper.find('.crm-settings-form-edit-field-wrapper[data-template="1"]');this.$paragraph_edit_dialog_template=this.$wrapper.find('.crm-settings-form-paragraph-edit-wrapper[data-template="1"]');this.$agreement_checkbox_edit_dialog_tempalte=this.$wrapper.find('.c-settings-form-agreement-checkbox-edit-wrapper[data-template="1"]');this.referrer=d.crm.storage.get("crm/settings/web_form_referrer");d.crm.storage.del("crm/settings/web_form_referrer");this.form=a.form||{};
this.form.params=this.form.params||{};this.form.params.fields=this.form.params.fields||{};this.available_fields=a.available_fields||{};this.lang=a.lang;this.messages=a.messages||{};a=a.default_checked_fields||[];if(0>=this.form.id&&"settings/sources"===this.referrer){var b=a.indexOf("password");0<=b?a[b]="!deal_description":a.push("!deal_description")}this.default_checked_fields=a;this.changed=!1;this.submit_xhr=null;this.initClass()};crmSettingsForm.prototype.initClass=function(){this.initDealCreateCheckbox();
this.renderDealDescription();this.bindEvents();this.initAddNewFieldLink();this.initAvailableFields();this.initDeleteFieldLinks();this.initPreviewButton();this.initFormWidthInput();this.initStickyButton();this.initFields();this.initSubmit();this.initDeleteLink();this.initSortable();this.initIButtons();this.initTextEditor();this.initCopySmartyHelper();this.initIframeTextarea();this.initMessagesBlock();this.initCancelLink();this.initBlocks()};crmSettingsForm.prototype.renderDealDescription=function(a){var b=
this.$form_fields.find('[data-id="!deal_description"]').find("textarea");a||(a=this.getField("!deal_description"));!a||0>=a.checked||!b.length||(a.redactor?b.data("redactor")?(a=b.redactor("core.editor"))&&0<a.length&&a[0].attr("placeholder",b.attr("placeholder")):d.crm.initWYSIWYG(b,{focus:!1,buttons:["bold","italic","underline","link"],plugins:[],maxHeight:100,minHeight:100}):(b.data("redactor")&&b.redactor("core.destroy"),b.show()))};crmSettingsForm.prototype.bindEvents=function(){var a=this;a.$confirmation_checkbox.on("change",
function(){d(this).is(":checked")?a.$email_confirm_block.slideDown(200):a.$email_confirm_block.slideUp(200)});a.$form.on("change","input,textarea,select",function(b){a.setFormChanged();b.isTrigger||a.clearValidateErrors()});a.$form.on("keyup","input:text,textarea",function(b){a.setFormChanged();b.isTrigger||a.clearValidateErrors()});a.$form.find(".crm-iframe-code-block-toggle").click(function(){a.$iframe_textarea.toggle()})};crmSettingsForm.prototype.initDealCreateCheckbox=function(){var a=this,b=
a.referrer,c=function(b){var c=a.$wrapper.find(".js-responsible-section").data("block_object");b?(a.$available_deal_related_field.removeClass("crm-disabled"),a.$wrapper.find(".js-hint-about-deal-fields").hide(),a.$wrapper.find(".js-hint-about-deal-fields").next().addClass("crm-top-bordered"),c.reload({})):(a.$available_deal_related_field.each(function(){var b=d(this).data("id");a.getFormField(b).find(".crm-delete-field-link").trigger("click")}),a.$available_deal_related_field.addClass("crm-disabled"),
a.$wrapper.find(".js-hint-about-deal-fields").show(),a.$wrapper.find(".js-hint-about-deal-fields").next().removeClass("crm-top-bordered"),c.reload({funnel_id:0}))};a.$create_deal_block_wrapper.on("toggled",function(a,b){c(b,!0)});0>=a.form.id&&"settings/sources"===b&&(a.$create_deal_block_wrapper.find(":checkbox").attr("checked",!0).trigger("change"),c(!0,!1))};crmSettingsForm.prototype.setFormChanged=function(a){(a=void 0!==a?a:!0)?this.$button.removeClass("green").addClass("yellow"):this.$button.removeClass("yellow").addClass("green");
this.changed=a};crmSettingsForm.prototype.initPreviewButton=function(){var a=this.$wrapper,b=a.find(".crm-form-preview-submit-button-caption-input"),c=a.find(".crm-form-preview-submit-button"),d=function(a){a?(b.show(),c.hide(),b.val(c.val())):(b.hide(),c.show())};c.click(function(){d(!0)});b.blur(function(){c.val(b.val());d(!1)}).keyup(function(a){a.preventDefault();13==a.keyCode?(c.val(b.val()),d(!1)):27==a.keyCode&&d(!1)})};crmSettingsForm.prototype.initFormWidthInput=function(){var a=this.$wrapper,
b=a.find(".crm-form-width-input"),c=a.find(".crm-form-preview-block");b.keyup(function(a){13==a.keyCode&&(b.val(Math.max(Math.min(parseInt(b.val(),10)||0,600),200)),c.width(b.val()))})};crmSettingsForm.prototype.initStickyButton=function(){this.$wrapper.find(".crm-form-buttons").sticky({fixed_css:{bottom:0,"z-index":100},fixed_class:"sticky-bottom-shadow",showFixed:function(a){a.element.css("min-height",a.element.height());a.fixed_clone.empty().append(a.element.children())},hideFixed:function(a){a.fixed_clone.children().appendTo(a.element)},
updateFixed:function(a,b){this.width(a.element.width())}})};crmSettingsForm.prototype.initTextEditor=function(){var a=this,b=a.$form.find('[name="form[params][confirm_mail_body]"]');b.waEditor({focus:!1,buttons:["formatting","bold","italic","link"],plugins:["fontcolor","fontsize","fontfamily"],callbacks:{keydown:function(a){},change:function(){b.waEditor("sync");a.setFormChanged()}},lang:a.lang})};crmSettingsForm.prototype.initMessagesBlock=function(){var a=this,b=a.$wrapper,c=b.find(".c-settings-messages-block"),
b=b.find(".js-deal-section");a.renderToVariantSelectors();c.on("loadEditor",function(){a.renderToVariantSelectors()});b.on("changeResponsibleUser",function(){a.renderToVariantSelectors()})};crmSettingsForm.prototype.renderToVariantSelectors=function(){var a=this.$wrapper.find(".c-settings-messages-block"),b=this.getField("email"),c=b&&0<b.checked,e=function(a,b){var c=a.closest("label");b?(a.data("checked",a.is(":checked")),a.prop("disabled",!0).prop("checked",!1)):a.prop("disabled",!1).prop("checked",
a.data("checked"));a.is(":checked")?c.addClass("bold"):c.removeClass("bold")};a.find(".c-message-to-selector").each(function(){var a=d(this),b=a.find(".c-label"),a=a.find(".c-message-to-variants-list"),h=a.find(':checkbox[data-id="client"]');e(h,!c);var k=[];a.find(":checkbox:checked:not(:disabled)").each(function(){var a=d(this).closest("li");k.push(a.find(".c-variant-name-text").text())});k=0<k.length?k.join(", "):b.data("initial_text");b.text(k)})};crmSettingsForm.prototype.getField=function(a,
b){var c=this.form.params.fields,d=c.length,f=null;b="undefined"===typeof b?1:parseInt(b,10)||0;if(0>=b)return null;for(var g=0;g<d;g+=1)if(c[g].id==a&&c[g].checked==b){f=c[g];break}if(!f)return f;f.required=f.required||"";f.captionplace=f.captionplace||"left";f.caption=f.caption||"string"===typeof f.caption?f.caption:f.name;f.placeholder=f.placeholder||"";return f};crmSettingsForm.prototype.getAvailableField=function(a){if(this.available_fields[a]){a=d.extend({},this.available_fields[a]);if("!horizontal_rule"===
a.id||"!paragraph"===a.id)a.captionplace="none";return a}return null};crmSettingsForm.prototype.updateAvailableField=function(a,b){this.available_fields[a]&&d.extend(this.available_fields[a],b)};crmSettingsForm.prototype.addField=function(a,b,c){b=parseInt(b,10)||0;0>=b||!c||(this.deleteField(a,b),c=d.extend({},c,{id:a,checked:b}),this.form.params.fields.push(c))};crmSettingsForm.prototype.deleteField=function(a,b){var c=this.form.params.fields,d=c.length;b=parseInt(b,10)||0;for(var f=[],g=0;g<d;g+=
1)c[g].id==a&&c[g].checked==b||f.push(c[g]);b=0;d=f.length;for(g=0;g<d;g+=1)f[g].id==a&&(b+=1,f[g].checked=b);this.form.params.fields=f};crmSettingsForm.prototype.updateField=function(a,b,c){0>=b||(b=this.getField(a,b),b=d.extend(b,c),this.form.params.fields[a]=b,this.setFormChanged())};crmSettingsForm.prototype.renderField=function(a,b){var c=this.getField(a,b),d=this.$form_fields.find('.crm-form-field:not(.crm-form-field-template)[data-id="'+a+'"][data-checked="'+b+'"]');c?(d.length||(d=this.$form_fields.find('.crm-form-field-template.crm-form-field-template[data-id="'+
a+'"]').clone(),d.removeClass("crm-form-field-template"),d.attr("data-checked",b),d.insertBefore(this.$form_fields.find(".crm-form-field-template:first")),d.show()),"!paragraph"===c.id?d.find(".crm-paragraph").html(c.text||""):(d.find(".crm-caption").html("<label>"+function(a){return a&&(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}(c.caption)+(c.required&&"!captcha"!==c.id?" *":"")+"</label>"),d.removeClass("crm-caption-style-none crm-caption-style-above").addClass("crm-caption-style-"+
c.captionplace),d.find(":input:eq(0)").prop("placeholder",c.placeholder||""),"password"===c.id&&d.find(":input:eq(1)").prop("placeholder",c.placeholder_confirm||""),"!deal_description"===c.id&&this.renderDealDescription(c))):d.remove()};crmSettingsForm.prototype.initFields=function(){var a=this;a.$form_fields.on("click",".crm-caption-col, .crm-input-col",function(b){a.editField(d(this).closest(".crm-form-field"))})};crmSettingsForm.prototype.editField=function(a){var b=a.data("id");a=a.data("checked");
if("!horizontal_rule"!==b){var c={html:"",id:b,checked:a,settingsForm:this};a="!agreement_checkbox"===b?this.$agreement_checkbox_edit_dialog_tempalte.clone():"!paragraph"===b?this.$paragraph_edit_dialog_template.clone():this.$edit_dialog_template.clone();a.removeAttr("data-template").attr("id","crm-settings-dialog-wrapper-"+b);a.appendTo("body");a.show();c.html=a;"!agreement_checkbox"===b?new crmSettingsFormAgreementCheckboxEditDialog(c):"!paragraph"===b?new crmSettingsFormParagraphEditDialog(c):
new crmSettingsFormFieldEditDialog(c)}};crmSettingsForm.prototype.initSubmit=function(){var a=this,b=a.$form,c=b.find(".crm-loading"),e=b.find(".crm-success-status");b.on("keypress","input",function(a){13==a.keyCode&&a.preventDefault()});b.submit(function(f){f.preventDefault();f=b.serializeArray();var g=[];d.each(a.form.params.fields,function(a,b){if(0<b.checked){var c=g.length;d.each(b,function(b,d){"html"!==b&&(g[c]=g[a]||{},g[c][b]=d)})}});f.push({name:"form[params][fields]",value:JSON.stringify(g)});
a.clearValidateErrors();c.show();a.$button.prop("disabled",!0);a.submit_xhr&&a.submit_xhr.abort();a.submit_xhr=d.post(b.attr("action"),f).done(function(b){"ok"!==b.status?a.showValidateErrors(b.errors||{}):(a.setFormChanged(!1),e.show().fadeOut(500),d.crm.content.load(d.crm.app_url+"settings/form/"+b.data.form.id))}).error(function(){a.showValidateErrors({"":a.messages.unknown_server_error})}).always(function(){c.hide();a.$button.prop("disabled",!1)})})};crmSettingsForm.prototype.clearValidateErrors=
function(){var a=this.$form;a.find(".error").removeClass("error");a.find(".crm-errors-block").remove()};crmSettingsForm.prototype.showValidateErrors=function(a){var b=this.$form,c={};d.each(a||{},function(a,b){"params"===a?d.each(b,function(a,b){c["form[params]["+a+"]"]=d.isArray(b)?b:[b]}):c[a?"form["+a+"]":""]=d.isArray(b)?b:[b]});this.clearValidateErrors();d.each(c,function(a,c){var e=d('<div class="crm-errors-block"></div>'),f=a?b.find('[name="'+a+'"]'):d();f.addClass("error");d.each(c,function(a,
b){e.append('<em class="errormsg">'+b+"</em>")});f.length?f.after(e):b.find(".crm-common-errors-block").append(e)})};crmSettingsForm.prototype.initDeleteLink=function(){var a=this;a.$delete_link.click(function(b){b.preventDefault();confirm(a.messages.confirm_delete)&&d.post(d.crm.app_url+"?module=settings&action=formDelete",{id:a.form.id},function(){d.crm.content.load(d.crm.app_url+"settings/form")})})};crmSettingsForm.prototype.initSortable=function(){var a=this;a.$form_fields.sortable({distance:5,
helper:"clone",items:".crm-form-field:not(:hidden)",opacity:.75,handle:".sort",tolerance:"pointer",containment:a.$form_fields,update:function(){for(var b=a.form.params.fields,c=b.length,e={},f=[],g=a.$form_fields.find(".crm-form-field:not(.crm-form-field-template)"),h=0;h<c;h+=1)e[b[h].id+"-"+b[h].checked]=h;g.each(function(){var a=d(this),c=a.data("id"),a=a.data("checked");f.push(b[e[c+"-"+a]])});a.form.params.fields=f;a.setFormChanged()}})};crmSettingsForm.prototype.initDeleteFieldLinks=function(){var a=
this;a.$wrapper.on("click",".crm-delete-field-link",function(){var b=d(this).closest(".crm-form-field");a.deleteFormField(b)})};crmSettingsForm.prototype.deleteFormField=function(a){if(!(0>=a.length)){var b=a.data("id"),c=a.data("checked"),d=this.getAvailableField(b);this.$form_available_fields.find('.crm-form-field[data-id="'+b+'"]').removeClass("crm-disabled");this.deleteField(b,c);a.remove();d&&this.updateAvailableField(b,{checked:d.checked-1});"email"===b&&(this.disableIButton(this.$confirmation_checkbox).attr("checked",
!1).trigger("change"),this.$confirmation_enable_text.show(),this.$form_available_fields.find('.crm-form-field[data-id="password"]').addClass("crm-disabled"),a=this.getFormField("password"),this.deleteFormField(a),this.renderToVariantSelectors());this.setFormChanged()}};crmSettingsForm.prototype.getFormField=function(a,b){for(var c='.%clz%[data-id="%id%"]%extra%:not(.%not_clz%)',d=[["%clz%","crm-form-field"],["%id%",a],["%extra%",void 0!==b?'[data-id="'+b+'"]':""],["%not_clz%","crm-form-field-template"]],
f=0,g=d.length;f<g;f+=1)c=c.replace(d[f][0],d[f][1]);return this.$form_fields.find(c)};crmSettingsForm.prototype.initAvailableFields=function(){var a=this,b=a.default_checked_fields,c=a.$form_available_fields;c.on("click",".crm-form-field:not(.crm-disabled)",function(b){a.addFormField(d(this))});0>=a.form.id&&0<b.length&&d.each(b,function(b,d){var e=c.find('.crm-form-field[data-id="'+d+'"]:not(.crm-disabled)');a.addFormField(e)})};crmSettingsForm.prototype.addFormField=function(a){if(!(0>=a.length)){var b=
a.data("id"),c=this.getAvailableField(b);this.$form_available_fields.hide();var d=c.checked+1;c.is_multi||a.addClass("crm-disabled");this.getField(c.id,d)||this.addField(b,d,c);this.updateAvailableField(b,{checked:d});"email"===b&&(this.$confirmation_enable_text.hide(),this.enableIButton(this.$confirmation_checkbox),(a=this.getAvailableField("password"))&&0>=a.checked&&this.$form_available_fields.find('.crm-form-field[data-id="password"]').removeClass("crm-disabled"));this.renderField(b,d);"!paragraph"==
b&&(b=this.$form_fields.find('.crm-form-field[data-id="'+b+'"][data-checked="'+d+'"]'),this.editField(b));this.setFormChanged();this.renderToVariantSelectors()}};crmSettingsForm.prototype.initAddNewFieldLink=function(){function a(b){d.contains(document,c[0])?27===b.keyCode&&c.is(":visible")&&c.hide():d(document).off("keypress",a)}function b(a){if(d.contains(document,c[0])){var e=d.contains(c[0],a.target);a=c[0]===a.target;!c.is(":visible")||a||e||c.hide()}else d(document).off("keypress",b)}var c=
this.$form_available_fields;this.$wrapper.on("click",".crm-add-new-field-link",function(a){a.stopPropagation();c.toggle()});d(document).on("keydown",a).on("click",b)};crmSettingsForm.prototype.initIButtons=function(){var a=this;a.$wrapper.find(".js-ibutton").each(function(){a.initIButton(d(this))})};crmSettingsForm.prototype.initIButton=function(a){return a.data("iButtonInit")?a:a.iButton({labelOn:"",labelOff:"",classContainer:"c-ibutton ibutton-container mini"}).data("iButtonInit",1)};crmSettingsForm.prototype.disableIButton=
function(a){return this.initIButton(a).iButton("disable",!0)};crmSettingsForm.prototype.enableIButton=function(a){return this.initIButton(a).iButton("disable",!1)};crmSettingsForm.prototype.initCopySmartyHelper=function(){this.$copy.on("click",function(){var a=d(this),b=a.data("content"),c=d("<input>");d("body").append(c);c.val(b).select();document.execCommand("copy");c.remove();a.removeClass("stack").addClass("yes");setTimeout(function(){a.removeClass("yes").addClass("stack")},2E3)})};crmSettingsForm.prototype.initIframeTextarea=
function(){var a=this;a.$iframe_textarea.click(function(){a.$iframe_textarea.select()})};crmSettingsForm.prototype.initCancelLink=function(){var a=this.referrer;this.$wrapper.on("click",".js-c-cancel-link",function(b){b.preventDefault();"settings/sources"==a?(d.crm.storage.set("crm/settings/source_tab","form"),d.crm.content.load(d.crm.app_url+"settings/sources/")):d.crm.content.load(d.crm.app_url+"settings/form/")})};crmSettingsForm.prototype.initBlocks=function(){var a=this.$wrapper,b=a.find(".js-deal-section"),
a=a.find(".js-responsible-section"),b=b.data("block_object"),a=a.data("block_object");b.setResponsibleBlock(a)};return crmSettingsForm}(jQuery);var crmSettingsFormFieldEditDialog=function(d){var a=function(a){var b=this,d=a.onClose;a.onClose=function(a,b){d&&d(a,b)};var f=a.onOpen;a.onOpen=function(c,d){f&&f(c,d);b.$wrapper=c;b.$form=b.$wrapper.find("form");b.$button=b.$form.find("[type=submit]");b.id=a.id;b.checked=a.checked;b.settingsForm=a.settingsForm;b.dialog=d;b.initClass()};new CRMDialog(a)};a.prototype.initClass=function(){var a=this.dialog.$block,c=this.settingsForm.getField(this.id,this.checked);d.each(c,function(b,e){if("id"===
b)d(".crm-field-id",a).find(".value").text(c.name+" (ID="+e+")");else if("name"!==b){var f=d(".crm-field-"+b,a).find(".value").find(":input");f.is(":checkbox")?f.prop("checked",!!e):f.is(":radio")?f.filter('[value="'+e+'"]').prop("checked",!0):f.val(e)}});var e=function(b){d(".crm-field-"+b,a).hide().find(":input").attr("disabled",!0)},f=function(b){d(".crm-field-"+b,a).show().find(":input").attr("disabled",!1)};"Checkbox"!==c.type?f("captionplace"):e("captionplace");c.placeholder_need?f("placeholder"):
e("placeholder");c.placeholder_need&&"password"===c.id?f("placeholder_confirm"):e("placeholder_confirm");c.required_always?e("required"):f("required");"!deal_description"==c.id?f("redactor"):e("redactor");this.bindEvents()};a.prototype.bindEvents=function(){var a=this,c=a.$form,e=a.settingsForm.getField(a.id,a.checked);c.submit(function(b){b.preventDefault();c.find(":input[name*=params]:not(:disabled)").each(function(){var a=d(this),b=a.attr("name").replace("params[","").replace("]",""),c=a.val();
a.is(":checkbox")?e[b]=a.is(":checked")?!0:!1:a.is(":radio")?a.is(":checked")&&(e[b]=c):e[b]=c});a.settingsForm.updateField(a.id,a.checked,e);a.settingsForm.renderField(a.id,a.checked);a.dialog.close()});a.$form.on("change","input,textarea,select",function(){a.setFormChanged()});a.$form.on("keyup","input:text,textarea",function(){a.setFormChanged()})};a.prototype.setFormChanged=function(){this.$button.removeClass("green").addClass("yellow")};return a}(jQuery);var crmSettingsFormParagraphEditDialog=function(d){var a=function(a){var b=this,e=a.onClose;a.onClose=function(a,b){e&&e(a,b);d(".redactor-dropdown").remove()};var f=a.onOpen;a.onOpen=function(c,d){f&&f(c,d);b.$wrapper=c;b.$textarea=b.$wrapper.find(".crm-paragraph-textarea");b.$button=b.$wrapper.find("[type=button]");b.id=a.id;b.checked=a.checked;b.settingsForm=a.settingsForm;b.dialog=d;b.initClass()};new CRMDialog(a)};a.prototype.initClass=function(){var a=this.$textarea,c=this.settingsForm.getField(this.id,
this.checked);a.val(c&&c.text||"");this.initWYSIWYG();this.initSaveButton()};a.prototype.initWYSIWYG=function(){var a=this,c=a.$textarea,e=a.settingsForm.getField(a.id,a.checked);d.crm.initWYSIWYG(c,{focus:!0,changeCallback:function(){a.setFormChanged()}});c.val(e.text||"");c.redactor("code.set",e.text||"")};a.prototype.initSaveButton=function(){var a=this,c=a.$textarea;a.$button.click(function(b){b.preventDefault();a.settingsForm.updateField(a.id,a.checked,{text:c.val()});a.settingsForm.renderField(a.id,
a.checked);a.dialog.close()})};a.prototype.setFormChanged=function(){this.$button.removeClass("green").addClass("yellow")};return a}(jQuery);var crmSettingsFormAgreementCheckboxEditDialog=function(d){d=function(a){var b=this,c=a.onOpen;a.onOpen=function(d,f){c&&c(d,f);b.$wrapper=d;b.$html_label=b.$wrapper.find(".c-html-label-textarea-wrapper textarea");b.$field_id=b.$wrapper.find(".c-field-id .value");b.$checked_by_default=b.$wrapper.find(".c-field-checked-by-default :checkbox");b.$button=b.$wrapper.find("[type=button]");b.id=a.id;b.checked=a.checked;b.settingsForm=a.settingsForm;b.dialog=f;b.initClass()};new CRMDialog(a)};d.prototype.initClass=
function(){var a=this.getField();this.$field_id.text(a.name+" (ID="+a.id+")");this.initHtmlLabel();this.initDefaultChecked();this.initSaveButton()};d.prototype.initHtmlLabel=function(){var a=this,b=a.$html_label,c=a.getField(),d=function(){a.setFormChanged()};b.val(c.html_label);var f=null;b.on("keyup",function(){f&&clearTimeout(f);f=setTimeout(function(){d()},300)});b.on("change",d)};d.prototype.initDefaultChecked=function(){var a=this,b=a.getField(),c=a.$checked_by_default;c.attr("checked",!!b.default_checked);
c.on("change",function(){a.setFormChanged()})};d.prototype.getField=function(){var a=this.settingsForm.getField(this.id,this.checked);a.name=a.name||"";a.id=a.id||"";a.html_label=a.html_label||"";a.default_checked=a.default_checked&&"0"!==a.default_checked?1:0;a.html_label_default_href_placeholder=a.html_label_default_href_placeholder||"";return a};d.prototype.initSaveButton=function(){var a=this,b=a.$html_label,c=a.$checked_by_default;a.$button.click(function(d){d.preventDefault();d={html_label:b.val(),
default_checked:c.is(":checked")?1:0};a.settingsForm.updateField(a.id,a.checked,d);a.renderField();a.dialog.close()})};d.prototype.renderField=function(){var a=this.id,b=this.checked,c=this.getField(a,b),d=this.settingsForm.$form_fields,f=d.find('.crm-form-field:not(.crm-form-field-template)[data-id="'+a+'"][data-checked="'+b+'"]');c?(f.length||(f=d.find('.crm-form-field-template.crm-form-field-template[data-id="'+a+'"]').clone(),f.removeClass("crm-form-field-template"),f.attr("data-checked",b),f.insertBefore(d.find(".crm-form-field-template:first")),
f.show()),a=c.html_label,a=a.replace(c.html_label_default_href_placeholder,"javascript:void(0)"),f.find(".c-agreement-checkbox-html-label").html(a),f.find(":checkbox").attr("checked",!!c.default_checked)):f.remove()};d.prototype.setFormChanged=function(){this.$button.removeClass("green").addClass("yellow")};return d}(jQuery);var CRMSettingsGeneral=function(d){CRMSettingsGeneral=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.initClass()};CRMSettingsGeneral.prototype.initClass=function(){this.initStickyButton();this.initFooterToggle();this.initSubmit()};CRMSettingsGeneral.prototype.initStickyButton=function(){var a=d("#wa-app"),b=a.height(),a=(a.offset()||{}).top,c=d(window).height();b+a<c||this.$wrapper.find(".crm-form-buttons").sticky({fixed_css:{bottom:0,"z-index":9},fixed_class:"sticky-bottom-shadow",
showFixed:function(a){a.element.css("min-height",a.element.height());a.fixed_clone.empty().append(a.element.children())},hideFixed:function(a){a.fixed_clone.children().appendTo(a.element)},updateFixed:function(a,b){this.width(a.element.width())}})};CRMSettingsGeneral.prototype.initSubmit=function(){var a=this.$wrapper.find(".c-reminder-settings-wrapper").data("instance"),b=this.$form,c=b.find(".crm-loading");b.submit(function(e){e.preventDefault();c.show();a&&!1===a.validateBeforeSave()?c.hide():
d.post(b.attr("action"),b.serialize(),function(a){"ok"===a.status&&d.crm.content.reload()}).always(function(){b.find(".crm-loading").hide()})})};CRMSettingsGeneral.prototype.initFooterToggle=function(){var a=this.$wrapper.find(".js-footer-actions"),b=a.find(".js-submit-button");this.$wrapper.on("change keydown","input, textarea, select",function(){b.removeClass("green").addClass("yellow");a.addClass("is-changed")})};return CRMSettingsGeneral}(jQuery);var CRMNotificationEdit=function(d){CRMNotificationEdit=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$footer=this.$wrapper.find(".js-footer-actions");this.messages=a.messages||{};this.messages.enable=this.messages.enable||"";this.messages.disable=this.messages.disable||"";this.$name=this.$wrapper.find(".js-notification-name");this.$subject=this.$wrapper.find(".js-notification-subject");this.$emailBody=this.$wrapper.find(".js-email-body");this.$smsBody=this.$wrapper.find(".js-sms-body");
this.$recipient=this.$wrapper.find(".js-recipient-list");this.$sender=this.$wrapper.find(".js-sender-list");this.$sender_block=this.$wrapper.find(".js-senders-block");this.$sms_sender=this.$wrapper.find(".js-sms-sender-list");this.$sms_sender_block=this.$wrapper.find(".js-sms-senders-block");this.notifications=a.notifications;this.locales=a.locales;this.notification_id=(this.notification=a.notification||{},this.notification.id);this.notification_event=this.notification&&this.notification.event;this.site_app_url=
a.site_app_url;this.recipients=a.recipients;this.sender=a.sender.split("|",2);this.user_data=a.user_data;this.dialog_template=a.dialog_template;this.success_html=a.success_html;this.transport="";this.initClass()};CRMNotificationEdit.prototype.initClass=function(){0>=this.notification.id&&this.initTransport();this.initRecipient();this.initBody();this.notification_id||this.initChangeEvent();this.initSubmit();this.initDelete();this.initFooterActions();this.initHelp();this.initSender();this.initSendTest()};
CRMNotificationEdit.prototype.initSendTest=function(){var a=this,b=!1,c=null;a.$wrapper.on("click",".js-send-test",function(e){e.preventDefault();d(document).trigger("updateEditorTextarea");d.crm.confirm.show({title:a.locales.send_confirm_title,text:function(){var b=d(a.dialog_template);c="sms"==a.$wrapper.find(".js-transport-toggle").filter(":checked").first().val()?a.user_data.phone:a.user_data.email;b.find(".js-user-contact").attr("value",c);return b["0"].outerHTML}(),button:a.locales.send_confirm_button,
onConfirm:function(c){if(!b){b=!0;var e=a.$form.serializeArray();e.push({name:"data[contact]",value:c.$block.find(".js-user-contact").val()});d.post("?module=settingsNotifications&action=SendTest",e,function(b){"ok"===b.status&&(c.$wrapper.find(".crm-dialog-block").html(a.success_html),c.resize(),setTimeout(function(){d.contains(document,c.$wrapper[0])&&c.close()},1E4))},"json").always(function(){b=!1})}return!1}})})};CRMNotificationEdit.prototype.initSender=function(){function a(){return k&&0<k.id?
k.transport||"email":l.filter(":checked").first().val()}function b(){"email"===a()?(c("specified"===h.$sender.val()),g()):(f("specified"===h.$sms_sender.val()),d())}function c(a){var b=h.$sender_block.find(".js-specified-sender-name"),c=h.$sender_block.find(".js-specified-sender-email");h.$sender_block.show();h.$sender.attr("disabled",!1);a?(b.attr("disabled",!1).show(),c.attr("disabled",!1).show(),"system"!==h.sender[0]&&(c.val(h.sender[0]),b.val(h.sender[1]))):(b.attr("disabled",!0).hide(),c.attr("disabled",
!0).hide())}function d(){h.$sender_block.hide();h.$sender.attr("disabled",!0);h.$sender_block.find(".js-specified-sender-name").attr("disabled",!0).hide();h.$sender_block.find(".js-specified-sender-email").attr("disabled",!0).hide()}function f(a){var b=h.$sms_sender_block.find(".js-specified-sms-sender");h.$sms_sender_block.show();h.$sms_sender.attr("disabled",!1);a?(b.attr("disabled",!1).show(),"system"!==h.sender[0]&&b.val(h.sender[0])):b.attr("disabled",!0).hide()}function g(){h.$sms_sender_block.hide();
h.$sms_sender.attr("disabled",!0);h.$sms_sender_block.find(".js-specified-sms-sender").attr("disabled",!0).hide()}var h=this,k=h.notification,l=h.$wrapper.find(".js-transport-toggle");"email"===a()?(c(),g()):(f(),d());l.on("change",b);h.$sender.on("change",b);h.$sms_sender.on("change",b)};CRMNotificationEdit.prototype.initRecipient=function(){function a(){b(c.$recipient.val())}function b(a){var b=h.filter(":checked").first().val();!b&&0<c.notification.id&&(b=c.notification.transport);b=c.$wrapper.find('.c-recipient-content[data-id="'+
b+'"]');c.$wrapper.find(".c-recipient-content").hide().attr("disabled",!0);"other"===a?(b.show(),b.attr("disabled",!1)):b.hide()}var c=this,d=c.notification.recipient,f=c.recipients,g=c.$recipient,h=c.$wrapper.find(".js-transport-toggle");g.on("change",a);h.on("change",a);f[d]||(c.$recipient.val("other"),b("other"),c.$wrapper.find('.c-recipient-content[data-id="'+h.filter(":checked").first().val()+'"]').val(d))};CRMNotificationEdit.prototype.initChangeEvent=function(){var a=this,b=a.$wrapper.find(".js-event-toggle"),
c=a.$wrapper.find(".js-event-company"),e=a.$wrapper.find(".js-fields-group");b.on("change",function(){var b=d.trim(d(this).val());a.notification_event=b;var g=a.notifications[b];g&&(a.$name.val(g.name),a.$subject.val(g.subject),a.$emailBody.val(g.body).trigger("editorDataUpdated"),a.$smsBody.val(g.sms).trigger("editorDataUpdated"),g.recipient?a.$recipient.val(g.recipient):a.$recipient.val("client"));"invoice."===b.substr(0,8)?c.removeAttr("disabled").show():c.attr("disabled",!0).hide();e.show()})};
CRMNotificationEdit.prototype.initTransport=function(){function a(a){a=a.val();b.transport=a;a=b.$wrapper.find('.c-transport-content[data-id="'+a+'"]');e?(e.removeClass("is-active"),e.find("input, textarea").attr("disabled",!0)):b.$wrapper.find(".c-transport-content").find("input, textarea").attr("disabled",!0);a.find("input, textarea").attr("disabled",!1);e=a.addClass("is-active")}var b=this,c=b.$wrapper.find(".js-transport-toggle"),e=!1;a(c.filter(":checked").first());c.on("change",function(){a(d(this));
b.$emailBody.trigger("editorDataUpdated");b.$smsBody.trigger("editorDataUpdated")})};CRMNotificationEdit.prototype.initBody=function(){this.$wrapper.find(".js-redactor-wrapper").each(function(a){var b=d(this),c=b.find("textarea"),e=d('<div class="js-redactor" />'),f="js-textarea-"+a;a="js-redactor-"+a;e.attr("id",a).appendTo(b);c.attr("id",f);waEditorAceInit({id:f,ace_editor_container:a});"undefined"!==typeof wa_editor&&e.data("wa_editor",wa_editor);c.data("wa_editor",e.data("wa_editor"));c.on("editorDataUpdated",
function(){var a=e.data("wa_editor");a&&a.getSession().setValue(c.val())});d(document).on("updateEditorTextarea",function(){var a=e.data("wa_editor");a&&(a=a.getValue(),c.val(a).trigger("change"))})})};CRMNotificationEdit.prototype.initSubmit=function(){function a(){var a={data:[],errors:[]},b=f.serializeArray();d.each(b,function(b,c){a.data.push(c)});return a}function b(a,b){b=b?b:[];if(a){var c=Object.keys(a);d.each(c,function(c,d){b.push({name:d,value:a[d]})})}d.each(b,function(a,b){var c=b.value,
f=e.$form.find('[name="'+b.name+'"]');if(f.length&&!f.hasClass("error")){var g=d("<span />").addClass("errormsg").text(c);e.$wrapper.append(g);f.addClass("error").one("focus click change",function(){f.removeClass("error");g.remove()})}})}function c(a){if(!g){g=!0;var c=d(e.locales.saving);e.$footer.append(c);d.post("?module=settings&action=notificationsEditSave",a,"json").done(function(a){if("ok"!==a.status)b(a.errors||{});else if(0>=e.notification_id)d.crm.content.load(d.crm.app_url+"settings/notifications/edit/"+
a.data.notification.id+"/");else{var c=d(e.locales.saved);e.$footer.append(c);setTimeout(function(){d.contains(document,c[0])&&c.remove()},2E3);d(document).trigger("formIsSaved")}}).always(function(){c.remove();g=!1})}}var e=this,f=e.$form,g=!1;f.on("submit",function(e){e.preventDefault();d(document).trigger("updateEditorTextarea");e=a();e.errors.length?b(!1,e.errors):c(e.data)})};CRMNotificationEdit.prototype.initDelete=function(){var a=this,b=!1;a.$wrapper.on("click",".js-remove-notification",function(c){c.preventDefault();
d.crm.confirm.show({title:a.locales.delete_confirm_title,text:a.locales.delete_confirm_text,button:a.locales.delete_confirm_button,onConfirm:function(c){b||(b=!0,d.post("?module=settings&action=notificationsDelete",{id:a.notification_id},function(a){"ok"===a.status&&d.crm.content.load(d.crm.app_url+"settings/notifications/")}).always(function(){b=!1;c.close()}));return!1}})})};CRMNotificationEdit.prototype.initFooterActions=function(){function a(a){a?b.removeClass("yellow").addClass("green"):b.removeClass("green").addClass("yellow")}
var b=this.$footer.find(".js-submit-button");this.$wrapper.on("change","input, textarea, select",function(){a()});d(document).on("formIsSaved",function(){a(!0)})};CRMNotificationEdit.prototype.initHelp=function(){var a=this,b=a.$wrapper,c=d(document),e=d("#wa-editor-help"),f=d("#wa-editor-help-link"),g=function(a){0>=c.find(b).length?c.off("click",g):(a=d(a.target),!a.is(e)&&0>=e.find(a).length&&e.hide())};c.on("click",g);f.on("click",function(){if(e.is(":visible"))return e.hide(),!1;if(e.data("loaded."+
a.notification_event))return e.show(),!1;e.load(a.site_app_url+"?module=pages&action=help","app=crm&file=notification."+a.notification_event,function(){e.find("#wa-help-wa").remove();e.find("#wa-help-wa-content").remove();e.show();e.find("ul>li.no-tab>p.bold").hide();e.data("loaded",!0)});return!1});e.on("click","div.fields a.inline-link",function(b){b.preventDefault();b=d(this).find("i");var c=a.$emailBody;"sms"===a.transport&&(c=a.$smsBody);(c=c.data("wa_editor"))&&c.insert(d.trim(b.text()))})};
return CRMNotificationEdit}(jQuery),CRMNotificationStatus=function(d){CRMNotificationStatus=function(a){this.$wrapper=a.$wrapper;this.messages=a.messages||{};this.messages.enable=this.messages.enable||"";this.messages.disable=this.messages.disable||"";this.notifications=a.notifications;this.initDisableLinks()};CRMNotificationStatus.prototype.initDisableLinks=function(){var a=this,b=null,c=d.crm.app_url+"?module=settingsNotifications&action=status";a.$wrapper.on("click",".js-c-disable-link",function(e){e.preventDefault();
var f=d(this),g=f.closest(".c-notification");e=g.data("id");var h=g.hasClass("c-is-disabled"),k=g.find(".c-loading");b&&b.abort();k.show();b=d.post(c,{id:e,status:h?0:1}).done(function(b){"ok"===b.status&&(0<b.data.notification.status?(f.text(a.messages.disable),g.removeClass("c-is-disabled")):(f.text(a.messages.enable),g.addClass("c-is-disabled")))}).always(function(){b=null;k.hide()})})};return CRMNotificationStatus}(jQuery);var CRMSettingsPayments=function(d){CRMSettingsPayments=function(a){this.$wrapper=a.$wrapper;this.$pluginsDropdown=this.$wrapper.find(".js-plugins-dropdown");this.$table=this.$wrapper.find(".js-payments-table");this.company_id=a.company_id;this.locales=a.locales;this.initClass()};CRMSettingsPayments.prototype.initClass=function(){this.initTabs();this.initDelete();this.initSortable();var a=this.$wrapper.find(".c-payments-list");(new MutationObserver(function(b){a.trigger("refresh")})).observe(a[0],
{childList:!0,attributes:!0,subtree:!0})};CRMSettingsPayments.prototype.initTabs=function(){var a=this.$wrapper.find(".c-tabs-wrapper"),b=this.$wrapper.find(".c-companies-wrapper"),c=b.find(".c-companies-list"),e=c.find(".c-company.selected");(function(){function c(){d.contains(document,a[0])?e():h.off("resize refresh",c)}function e(){var c=a.width()-k-10;b.css("max-width",c+"px")}var h=d(window),k=a.find(".c-add-wrapper").outerWidth(!0);e();h.on("resize refresh",c)})();d.crm.tabSlider({$wrapper:b,
$slider:c,$activeSlide:e.length?e:!1})};CRMSettingsPayments.prototype.initDelete=function(){var a=this,b=!1;a.$wrapper.on("click",".js-delete-payment",function(c){c.preventDefault();c=d(this);var e=c.closest("tr"),f=c.data("payment-id"),g=c.data("plugin");(function(){d.crm.confirm.show({title:a.locales.confirm_delete_title.replace("%payment",e.find(".js-name").text()),text:a.locales.confirm_delete_text,button:a.locales.confirm_delete_button,onConfirm:function(){b||(b=!0,d.post("?module=settings&action=paymentDelete",
{id:f,company_id:a.company_id},function(b){"ok"==b.status&&(e.remove(),b=a.$pluginsDropdown.find('li[data-plugin="'+g+'"]'),b.length&&b.show())}).always(function(){b=!1}))}})})()})};CRMSettingsPayments.prototype.initSortable=function(){var a=this,b=!1;a.$table.sortable({distance:10,handle:".js-sort-toggle",helper:"clone",items:"tr",axis:"y",stop:function(){var c={ids:function(){var b=[];a.$table.find("tr").each(function(){b.push(d(this).data("id"))});return b}(),company_id:a.company_id};b&&b.abort();
b=d.post("?module=settings&action=paymentSort",c,function(a){}).always(function(){b=!1})}})};return CRMSettingsPayments}(jQuery),CRMPaymentEdit=function(d){CRMPaymentEdit=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$footer=this.$wrapper.find(".js-footer");this.instance_id=a.instance_id;this.company_id=a.company_id;this.locales=a.locales;this.initClass()};CRMPaymentEdit.prototype.initClass=function(){this.initSubmit();this.initDelete()};CRMPaymentEdit.prototype.initSubmit=
function(){function a(a){if(!e){e=!0;var b=d(c.locales.saving);c.$footer.append(b);d.post("?module=settings&action=paymentSave",a,function(a){if("ok"==a.status)if(b.remove(),c.instance_id){var e=d(c.locales.saved);c.$footer.append(e);setTimeout(function(){d.contains(document,e[0])&&e.remove()},2E3)}else d.crm.content.load(d.crm.app_url+"settings/payment/?company="+c.company_id)}).always(function(){e=!1})}}function b(a,b){a=a?a:[];if(b){var e=Object.keys(b);d.each(e,function(c,d){a.push({name:d,value:b[d]})})}d.each(a,
function(a,b){var e=b.value,f=c.$wrapper.find('[name="'+b.name+'"]');if(f.length&&!f.hasClass("error")){var g=d("<span />").addClass("errormsg").text(e);g.insertAfter(f);f.addClass("error").one("focus click",function(){f.removeClass("error");g.remove()})}})}var c=this,e=!1,f=c.$form;f.on("submit",function(c){var d;c.preventDefault();c=f.serializeArray();d=[];d.length?b(d):a(c)})};CRMPaymentEdit.prototype.initDelete=function(){var a=this,b=!1;a.$wrapper.on("click",".js-delete-payment",function(c){function e(){b||
(b=!0,d.post("?module=settings&action=paymentDelete",{id:a.instance_id,company_id:a.company_id},function(b){"ok"==b.status&&d.crm.content.load(d.crm.app_url+"settings/payment/?company="+a.company_id)}).always(function(){b=!1}))}c.preventDefault();(function(){b||(b=!0,d.post("?module=dialogConfirm",{title:a.locales.confirm_delete_title,text:a.locales.confirm_delete_text,ok_button:a.locales.confirm_delete_button},function(a){new CRMDialog({html:a,onConfirm:function(){e()}})}).always(function(){b=!1}))})()})};
return CRMPaymentEdit}(jQuery);var CRMReasonsPage=function(d){CRMReasonsPage=function(a){this.$wrapper=a.$wrapper;this.$reasonsList=this.$wrapper.find(".js-reasons-list");this.$footer=this.$wrapper.find(".js-footer-actions");this.$form=this.$wrapper.find("form");this.$freeField=this.$wrapper.find(".js-free-field");this.$submitButton=this.$wrapper.find(".js-submit-button");this.$hiddenActions=this.$footer.find(".js-hidden-actions");this.reason_template_html=a.reason_template_html;this.locales=a.locales;this.is_changed=!1;this.initClass()};
CRMReasonsPage.prototype.initClass=function(){var a=this;a.initSortable();a.initAddReason();a.initRemoveReason();a.initSubmit();a.$form.on("change","input",function(){a.toggleButton(!0)})};CRMReasonsPage.prototype.initSortable=function(){var a=this;a.$reasonsList.sortable({distance:10,handle:".js-sort-toggle",helper:"clone",items:"> li",axis:"y",change:function(){a.toggleButton(!0)}})};CRMReasonsPage.prototype.initRemoveReason=function(){var a=this;a.$wrapper.on("click",".js-delete-reason",function(b){b.preventDefault();
d(this).closest(".c-reason").remove();a.$reasonsList.find(".c-reason").length||a.$freeField.attr("checked",!0).attr("disabled",!0);a.toggleButton(!0)})};CRMReasonsPage.prototype.initAddReason=function(){var a=this;a.$wrapper.on("click",".js-add-reason",function(b){b.preventDefault();b=d(a.reason_template_html);a.$reasonsList.append(b);a.$freeField.attr("disabled",!1);a.toggleButton(!0)})};CRMReasonsPage.prototype.initSubmit=function(){function a(a){if(!e){e=!0;var f=d(c.locales.saving);c.$footer.append(f);
a=b(a);d.post("?module=settings&action=lostReasonsSave",a,function(a){if("ok"==a.status){f.remove();var b=d(c.locales.saved);c.$footer.append(b);c.toggleButton(!1);setTimeout(function(){d.contains(document,b[0])&&b.remove()},2E3)}}).always(function(){e=!1})}}function b(a){var b=a.serializeArray();c.$freeField.is(":disabled")&&(c.$freeField.attr("disabled",!1),b=a.serializeArray(),c.$freeField.attr("disabled",!0));(function(a){c.$reasonsList.find(".c-reason").each(function(b){var c=d(this),e=c.data("id");
if(c=c.find(".js-name-field").val())e&&a.push({name:"reasons["+b+"][id]",value:e}),a.push({name:"reasons["+b+"][name]",value:c})})})(b);return b}var c=this,e=!1;c.$form.on("submit",function(b){b.preventDefault();a(d(this))})};CRMReasonsPage.prototype.toggleButton=function(a){var b=this.$submitButton,c=this.$hiddenActions;a?(b.removeClass("green").addClass("yellow"),c.show()):(b.removeClass("yellow").addClass("green"),c.hide())};return CRMReasonsPage}(jQuery);var CRMSettingsRegions=function(d){var a=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$table=this.$form.find("table");a.title=a.title||"";a.title&&d.crm.title.set(a.title);this.country_iso3letter=a.country_iso3letter;this.messages=a.messages;this.initClass()};a.prototype.initClass=function(){this.initDeleteLinks();this.initFavorite();this.initAddLink();this.initSelector();this.initSubmit()};a.prototype.initDeleteLinks=function(){var a=this.$table;a.on("click",".delete",
function(){var b=d(this).parents("tr"),e=b.find('[name="region_names[]"]').attr("rel");if(e){var f=a.find("tr.template-deleted").clone().removeClass("hidden").removeClass("template-deleted");f.find(".insert-name-here").text(e);b.after(f).remove()}else b.remove(),0>=a.find("tbody tr:not(.white):visible").length&&a.find(".empty-stub").show()})};a.prototype.initFavorite=function(){var a=this,c=a.$form;a.$table.on("click",".fav",function(){var b=d(this).toggleClass("star").toggleClass("star-empty"),f=
b.hasClass("star")?"1":"";b.siblings("input:hidden").val(f);0>=b.parents(".just-added").length&&d.post(c.attr("action"),{fav:1,country:a.country_iso3letter,region:b.parents("tr").data("origCode"),fav_sort:f})});d("#favorite-country").click(function(){var b=d(this).toggleClass("star").toggleClass("star-empty"),f=b.hasClass("star")?"1":"";b.siblings('[name="country_fav"]').val(f);d.post(c.attr("action"),{fav:1,country:a.country_iso3letter,fav_sort:f})})};a.prototype.initAddLink=function(){var a=this.$table;
d("#add-region-link").click(function(){var b=a.find("tr.template-new").clone().removeClass("hidden").removeClass("template-new");d(this).parents("tr").before(b);b.siblings(".empty-stub").hide()})};a.prototype.initSelector=function(){var a=this,c=a.$form,e=c.find("select"),f=function(){return c.serialize().replace(/region_favs%5B%5D=[^&]*&/g,"").replace(/country_fav=[^&]*&/g,"")},g=f();e.change(function(){if(g!==f()&&!confirm(a.messages.confirm_region_not_saved))return e.val(a.country_iso3letter),
!1;var b=e.val();e.attr("disabled",!0);d("#c-settings-content").load(d.crm.app_url+"?module=settings&action=regions&country="+b)})};a.prototype.initSubmit=function(){var a=this,c=a.$form;c.submit(function(b){b.preventDefault();var e=!1;c.find(".zebra input:visible").each(function(){var a=d(this),b=a.val();b&&"0"!=b||(a.addClass("error").one("focus",function(){a.removeClass("error")}),e=!0)});e||(c.find(":submit").attr("disabled",!0),d.post(c.attr("action"),c.serialize(),function(b){d("#c-settings-content").html(b);
setTimeout(function(){var b=d('<span><i class="icon16 country yes"></i> '+a.messages.saved+"</span>");d("#regions-form :submit").after(b);b.fadeOut(1500,function(){d(this).remove()})},0)}))})};return a}(jQuery);var CRMSettingsVaults=function(d){CRMSettingsVaults=function(a){this.$wrapper=a.$wrapper;this.$list=this.$wrapper.find(".js-vaults-list");this.locales=a.locales;this.vault_template_html=a.vault_template_html;this.initClass()};CRMSettingsVaults.prototype.initClass=function(){this.initEdit();this.initSort()};CRMSettingsVaults.prototype.initEdit=function(){function a(a,f){c&&c.abort();c=d.post("?module=settings&action=vaultDialog",{id:a?a:""},function(a){new CRMDialog({html:a,options:{onSave:function(a,
c,e){f&&f.length||(f=d(b.vault_template_html),f.data("id",a).appendTo(b.$list));f.find(".js-name").text(c);f.find(".js-color").css("background",e)},onDelete:function(){f.remove()}}})}).always(function(){c=!1})}var b=this,c=!1;b.$wrapper.on("click",".js-vault-edit",function(){var b=d(this).closest(".c-vault-item"),c=b.data("id");a(c,b)});b.$wrapper.on("click",".js-vault-add",function(){a()})};CRMSettingsVaults.prototype.initSort=function(){function a(){var a=[];b.$list.find(".c-vault-item").each(function(){var b=
d(this).data("id");b&&a.push(b)});return a}var b=this,c=!1;b.$list.sortable({distance:10,handle:".js-sort-toggle",helper:"clone",items:"> .c-vault-item",axis:"y",stop:function(e,f){var g=d(f.item);c&&c.abort();var h={vaults:a()},k=d(b.locales.saving);k.appendTo(g);c=d.post("?module=settings&action=vaultsSave",h,function(a){if("ok"==a.status){var c=d(b.locales.saved);c.appendTo(g);setTimeout(function(){d.contains(document,c[0])&&c.remove()},2E3)}}).always(function(){k.remove();c=!1})}})};return CRMSettingsVaults}(jQuery),
CRMVaultEdit=function(d){CRMVaultEdit=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.locales=a.locales;this.count=a.count;this.vault_id=a.vault_id;this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMVaultEdit.prototype.initClass=function(){this.initDelete();this.initSave();this.initColorPicker();this.initNoAccessList()};CRMVaultEdit.prototype.initDelete=function(){function a(a,b){d.post("?module=settings&action=vaultDialogDelete",{id:a},function(a){"ok"===
a.status&&b&&"function"===typeof b&&b()})}var b=this;b.$wrapper.on("click",".js-vault-delete",function(c){c.preventDefault();var e=b.vault_id;d.crm.confirm.show({title:b.locales.confirm_delete_title,text:b.locales.confirm_delete_text,button:b.locales.confirm_delete_button,onConfirm:function(){a(e,function(){b.dialog.options.onDelete();b.dialog.close()})}})})};CRMVaultEdit.prototype.initSave=function(){function a(){var a={data:[],errors:[]},b=f.serializeArray();d.each(b,function(b,c){"data[name]"===
c.name&&(h=c.value);"data[color]"===c.name&&(k=c.value);a.data.push(c)});return a}function b(a,b){b=b?b:[];if(a){var c=Object.keys(a);d.each(c,function(c,d){b.push({name:d,value:a[d]})})}d.each(b,function(a,b){var c=b.value,f=e.$form.find('[name="'+b.name+'"]');if(f.length&&!f.hasClass("error")){var g=d("<span />").addClass("errormsg").text(c);e.$wrapper.append(g);f.addClass("error").one("focus click change",function(){f.removeClass("error");g.remove()})}})}function c(a){g||(g=!0,d.post("?module=settings&action=vaultDialogSave",
a,function(a){"ok"===a.status?(console.log(e.dialog),e.dialog.options.onSave(a.data.id,h,k),e.dialog.close()):a.errors&&b(a.errors)},"json").always(function(){g=!1}))}var e=this,f=e.$form,g=!1,h="",k="#aaa";f.on("submit",function(d){d.preventDefault();d=a();d.errors.length?b(!1,d.errors):c(d.data)})};CRMVaultEdit.prototype.initColorPicker=function(){var a=function(b){a=function(a){this.$wrapper=a.$wrapper;this.$field=a.$field;this.$icon=a.$icon;this.$colorPicker=a.$colorPicker;this.farbtastic=this.is_opened=
!1;this.initClass()};a.prototype.initClass=function(){var a=this;a.farbtastic=b.farbtastic(a.$colorPicker,function(b){a.$field.val(b).change()});a.$wrapper.data("colorPicker",a);a.bindEvents()};a.prototype.bindEvents=function(){var a=this;a.$icon.on("click",function(b){b.preventDefault();b.stopPropagation();a.displayToggle(!a.is_opened)});a.$colorPicker.on("click",function(a){a.stopPropagation()});a.$field.on("click",function(a){a.stopPropagation()});a.$field.on("focus",function(){a.is_opened||a.displayToggle(!0)});
a.$field.on("change keyup",function(){var c=b(this).val();a.$icon.css("background-color",c);a.farbtastic.setColor(c)});b(document).on("click",function(){a.displayToggle(!1)});b(document).on("colorPickerIsOpened",function(){a.is_opened&&a.displayToggle(!1)})};a.prototype.displayToggle=function(a){var c=this.$colorPicker;a?(b(document).trigger("colorPickerIsOpened",this),c.addClass("is-shown"),this.is_opened=!0):(b(document).trigger("colorPickerIsClosed",this),c.removeClass("is-shown"),this.is_opened=
!1)};return a}(jQuery);this.$wrapper.find(".js-color-toggle").each(function(){var b=d(this);new a({$wrapper:b,$field:b.find(".js-field"),$icon:b.find(".js-toggle"),$colorPicker:b.find(".js-color-picker")})})};CRMVaultEdit.prototype.initNoAccessList=function(){var a=this,b=a.$wrapper.find(".js-no-access-wrapper");b.on("click",".js-show-access-list",function(c){c.preventDefault();b.addClass("is-active");a.dialog.resize()});b.on("click",".js-hide-access-list",function(c){c.preventDefault();b.removeClass("is-active");
a.dialog.resize()})};return CRMVaultEdit}(jQuery);var CRMSettingsMessagesBlock=function(d){CRMSettingsMessagesBlock=function(a){this.$wrapper=a.$wrapper;this.namespace=a.namespace||"";this.type=a.type||"form";this.initClass()};CRMSettingsMessagesBlock.prototype.initClass=function(){var a=this,b=a.$wrapper,c=a.namespace,e=d.crm.app_url+"?module=settings&action=emailTemplateEditor";a.renderCheckboxLabel();b.on("click",".js-crm-add-message-checkbox",function(){var f=d(this),g=b.find(".crm-template").clone();g.removeClass("crm-template");b.find(".crm-one-message:last").after(g.show());
var h=b.find(".crm-editor-wrapper[data-i]").last().data("i");h?h=parseInt(h+"",10):0!==h&&(h=-1);var k=h+1;g.find(".crm-editor-wrapper").data("i",""+k).attr("data-i",""+k);d.post(e,{input_name:c+"["+k+"][tmpl]",to_name:c+"["+k+"][to]",sourcefrom_name:c+"["+k+"][sourcefrom]",add_attachments_name:c+"["+k+"][add_attachments]",type:a.type},function(a){g.find(".crm-editor-wrapper").html(a);b.trigger("loadEditor",[k,g])});a.renderCheckboxLabel();f.prop("checked",!1)});b.on("click",".js-crm-remove-message-checkbox",
function(){d(this).closest(".crm-one-message").remove();a.renderCheckboxLabel()})};CRMSettingsMessagesBlock.prototype.renderCheckboxLabel=function(){var a=this.$wrapper;0<a.find(".crm-one-message:not(.crm-template)").length?(a.find(".js-crm-when-no-messages").hide(),a.find(".js-crm-when-messages").show()):(a.find(".js-crm-when-no-messages").show(),a.find(".js-crm-when-messages").hide())};return CRMSettingsMessagesBlock}(jQuery);var CRMSettingsShop=function(d){CRMSettingsShop=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$button=this.$form.find("[type=submit]");this.source=a.source||{};this.messages=a.messages||{};this.submit_xhr=null;this.initClass()};CRMSettingsShop.prototype.initClass=function(){this.initSubmit();this.initStoreToggle();this.initFooterToggle()};CRMSettingsShop.prototype.initStoreToggle=function(){this.$wrapper.find(".js-ibutton-wrapper").each(function(){var a=d(this).find(".js-ibutton");
a.iButton({labelOn:"",labelOff:"",classContainer:"c-ibutton ibutton-container mini"});a.on("change",function(){var b=a.closest(".c-storefront").find(".c-storefront-params-block");"checked"===a.attr("checked")?b.show():b.hide()})})};CRMSettingsShop.prototype.initSubmit=function(){var a=this,b=a.$form,c=a.$button,e=b.find(".c-loading"),f=b.attr("action");b.submit(function(g){g.preventDefault();e.show();c.attr("disabled",!0);a.submit_xhr&&a.submit_xhr.abort();a.submit_xhr=d.post(f,b.serialize()).done(function(){d.crm.content.load(d.crm.app_url+
"settings/shop/")}).always(function(){c.attr("disabled",!1);e.hide()})})};CRMSettingsShop.prototype.initFooterToggle=function(){var a=this.$wrapper.find(".js-footer-actions"),b=a.find(".js-submit-button");this.$wrapper.on("change keydown","input, textarea, select",function(){b.removeClass("green").addClass("yellow");a.addClass("is-changed")})};return CRMSettingsShop}(jQuery),CRMSettingsShopWorkflowPage=function(d){CRMSettingsShopWorkflowPage=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form").first();
this.initClass()};CRMSettingsShopWorkflowPage.prototype.initClass=function(){d.crm.renderSVG(this.$wrapper);this.initTabs();this.initFooterToggle();this.initSubmit()};CRMSettingsShopWorkflowPage.prototype.initTabs=function(){var a=this.$wrapper.find(".js-funnels-tabs"),b=this.$wrapper.find(".c-funnels-wrapper"),c=b.find(".c-funnels-list"),e=c.find(".c-funnel.selected");(function(){function c(){d.contains(document,a[0])?e():h.off("resize",c)}function e(){var c=a.width()-k-10;b.css("max-width",c+"px")}
var h=d(window),k=a.find(".c-add-wrapper").outerWidth(!0);e();h.on("resize",c)})();d.crm.tabSlider({$wrapper:b,$slider:c,$activeSlide:e.length?e:!1})};CRMSettingsShopWorkflowPage.prototype.initFooterToggle=function(){var a=this.$wrapper.find(".js-footer-actions"),b=a.find(".js-submit-button");this.$wrapper.on("change keydown","input, textarea, select",function(){b.removeClass("green").addClass("yellow");a.addClass("is-changed")})};CRMSettingsShopWorkflowPage.prototype.initSubmit=function(){function a(){var a=
{data:[],errors:[]},b=f.serializeArray();d.each(b,function(b,c){a.data.push(c)});return a}function b(a){a&&a[0]||(a=[]);d.each(a,function(a,b){var c=b.value,h=e.$wrapper.find('[name="'+b.name+'"]'),k=d("<span class='c-error' />").addClass("errormsg").text(c);h.length&&!h.hasClass("error")?(h.parent().append(k),h.addClass("error").one("focus click change",function(){h.removeClass("error");k.remove()})):(g.append(k),f.one("submit",function(){k.remove()}))})}function c(a){h||(h=!0,d.post(d.crm.app_url+
"?module=settings&action=shopWorkflowSave",a,function(a){"ok"===a.status?d.crm.content.reload():b(a.errors)},"json").always(function(){h=!1}))}var e=this,f=e.$form,g=e.$wrapper.find(".js-errors-place"),h=!1;f.on("submit",function(d){d.preventDefault();d=a();d.errors.length?b(d.errors):c(d.data)})};return CRMSettingsShopWorkflowPage}(jQuery);var CRMSettingsPbxPage=function(d){CRMSettingsPbxPage=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.locales=a.locales;this.user_template_html=a.user_template_html;this.initClass()};CRMSettingsPbxPage.prototype.initClass=function(){var a=this;a.$wrapper.find(".c-pair-wrapper").each(function(){a.initPair(d(this))})};CRMSettingsPbxPage.prototype.initPair=function(a){var b=this,c=a.data("plugin-id"),e=a.data("number"),f=!1;a.on("click",".js-user-delete",function(g){g.preventDefault();
var h=d(this).closest(".c-user-wrapper"),k=h.find(".js-name");g=a.find(".js-number");k=k.html();d.crm.confirm.show({title:b.locales.delete_confirm_title.replace("%name%",k).replace("%number%",g.html()),text:b.locales.delete_confirm_text,button:b.locales.delete_confirm_button,onConfirm:function(){var a=h.data("id");f||(f=!0,d.post("?module=settingsPBX&action=delete",{p:c,n:e,u:a},function(a){"ok"===a.status&&h.remove()},"json").always(function(){f=!1}))}})});a.on("click",".js-delete-pbx-num",function(){var a=
d(this).parents("tr"),b={p:c,n:e};a.addClass("hidden");d.post("?module=settingsPBX&action=deleteNumber",b,function(b){"ok"===b.status?a.remove():a.removeClass("hidden")},"json").always(function(){a.removeClass("hidden")})});(function(){function f(a){a?k.addClass("is-shown"):k.removeClass("is-shown")}function h(a){m||(m=!0,d.post("?module=settingsPBX&action=add",{p:c,n:e,u:a.id},function(c){"ok"===c.status&&(c=d(b.user_template_html),a.photo_url&&c.find(".userpic20").css("background-image","url("+
a.photo_url+")"),c.find(".js-name").text(a.name),c.data("id",a.id),l.append(c))}).always(function(){m=!1}))}var k=a.find(".js-user-add-wrapper"),l=a.find(".js-users-list"),m=!1;k.on("click",".js-show-combobox",function(a){a.stopPropagation();f(!0)});k.on("click",".js-hide-combobox",function(a){a.stopPropagation();f(!1)});(function(){var a=k.find(".js-autocomplete");a.length&&(a.autocomplete({appendTo:k,source:d.crm.app_url+"?module=autocomplete&type=user",minLength:0,html:!0,focus:function(){return!1},
select:function(b,c){h(c.item);f(!1);a.val("");return!1}}).data("ui-autocomplete")._renderItem=function(a,b){return d("<li />").addClass("ui-menu-item-html").append("<div>"+b.value+"</div>").appendTo(a)},a.on("focus",function(){a.data("uiAutocomplete").search(a.val())}))})()})()};return CRMSettingsPbxPage}(jQuery);var CRMSettingsTemplate=function(d){CRMSettingsTemplate=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find(".js-template-form");this.$paramsSection=this.$wrapper.find(".c-params-section");this.$param_list=this.$paramsSection.find(".c-params-list");this.$textarea=this.$wrapper.find(".js-content-body");this.preview_dialog_template=a.preview_dialog_template;this.site_app_url=a.site_app_url;this.template=a.template||{};this.param_html=a.param_html;this.template_id=a.template_id;this.locales=
a.locales;this.company_count=a.company_count;this.initClass()};CRMSettingsTemplate.prototype.initClass=function(){var a=this;a.initHelp();a.initBody();a.initSave();a.initDelete();a.initParamsSection();a.initPreviewIframe();a.initIDAutoFiller();setTimeout(function(){a.initElasticFooter()},300);a.$form.on("change","input, select, textarea",function(){a.toggleButton(!0)});a.initResetTemplate()};CRMSettingsTemplate.prototype.initResetTemplate=function(){var a=this,b=a.$wrapper.find(".js-reset-template");
a.$wrapper.find(".js-redactor-wrapper").on("keypress",function(){b.removeClass("hidden")});b.on("click",function(){d.post("?module=settings&action=templatesReset","template_id="+a.template_id,function(b){"ok"===b.status&&(d(".js-content-body").text(b.data.template),a.initBody())},"json").always(function(){})})};CRMSettingsTemplate.prototype.initIDAutoFiller=function(){var a=null,b,c=this.$param_list,e=this.$form;c.on("change","input.js-code-field",function(){d(this).removeClass("auto-filler")});c.on("keyup",
"input.js-name-field",function(){var c=d(this),g=c.val(),h=c.parents("tr").find(".js-code-field"),k=h.hasClass("auto-filler"),l=e.find('[type="submit"]'),m=h.next(".loading");!l.prop("disabled")&&k&&(m=m.length?m:d('<i class="icon16 loading"></i>'),m.insertAfter(h),l.prop("disabled",!0),b&&clearTimeout(b),b=setTimeout(function(){a=d.post(d.crm.app_url+"?module=settings&action=fieldTransliterate",{"name[]":g},function(c){a&&(a.abort(),a=null);b&&clearTimeout(b);l.prop("disabled",!1);m.remove();"ok"===
c.status&&k&&h.val(c.data)},"json")},300))})};CRMSettingsTemplate.prototype.validate=function(){var a=this.$param_list.find(".js-code-field"),b=this.locales;this.$param_list.find(".errormsg").remove();this.$param_list.find(".error").removeClass("error");a.each(function(){var c=d(this),e=d(this).val(),f=d("<span />").addClass("errormsg"),g=e.search(/^\d/),e=e.search(/[^a-zA-Z0-9_]/);0<=g?(c.addClass("error"),c.after(f.text(b.validate_first_num))):0<=e?(c.addClass("error"),c.after(f.text(b.validate_symbols))):
c.hasClass("error")||(f=a.filter(function(){return this.value===c.val()}),2<=f.length&&f.addClass("error").parent().append(d('<span class="errormsg">').text(b.validate_copies)))});return this.$param_list.find(".error").length?!1:!0};CRMSettingsTemplate.prototype.initDelete=function(){function a(){var a={id:b.template_id};c||(c=!0,d.post("?module=settings&action=templatesDelete",a,function(a){d.crm.content.load(d.crm.app_url+"settings/templates/")},"json").always(function(){c=!1}))}var b=this,c=!1;
b.$wrapper.on("click",".js-delete-template",function(c){c.preventDefault();if(b.company_count){var e=d.crm.alert.show({text:b.locales.success_text,button:b.locales.success_button});setTimeout(function(){d.contains(document,e.$wrapper[0])&&e.close()},1E4)}else d.crm.confirm.show({title:b.locales.delete_confirm_title,text:b.locales.delete_confirm_text,button:b.locales.delete_confirm_button,onConfirm:a})})};CRMSettingsTemplate.prototype.initSave=function(){function a(a){d.post("?module=settings&action=templatesSave",
a,function(a){"ok"===a.status&&d.crm.content.load(d.crm.app_url+"settings/templates/"+a.data.id+"/")},"json").always(function(){c=!1})}var b=this,c=!1;b.$form.on("submit",function(e){e.preventDefault();d(document).trigger("updateEditorTextarea");if(!b.validate())return!1;!c&&(e=b.$form.serializeArray())&&(c=!0,a(e))})};CRMSettingsTemplate.prototype.initParamsSection=function(){var a=this,b=a.$paramsSection;b.on("click",".js-delete-param",function(b){b.preventDefault();d(this).closest("tr").remove();
a.toggleButton(!0)});b.on("click",".js-add-param",function(b){b.preventDefault();b=d(a.param_html);a.$param_list.append(b);a.toggleButton(!0)})};CRMSettingsTemplate.prototype.toggleButton=function(a){var b=this.$wrapper.find(".js-template-save-button"),c=this.$wrapper.find(".js-hidden-actions");a?(b.removeClass("green").addClass("yellow"),c.show()):(b.removeClass("yellow").addClass("green"),c.hide())};CRMSettingsTemplate.prototype.initBody=function(){var a=this;a.$wrapper.find(".js-redactor-wrapper").each(function(b){var c=
d(this),e=c.find("textarea"),f=d('<div class="js-redactor" />'),g="js-textarea-"+b;b="js-redactor-"+b;f.attr("id",b).appendTo(c);e.attr("id",g);waEditorAceInit({id:g,ace_editor_container:b});"undefined"!==typeof wa_editor&&f.data("wa_editor",wa_editor);e.data("wa_editor",f.data("wa_editor"));e.on("editorDataUpdated",function(){var a=f.data("wa_editor");a&&a.getSession().setValue(e.val())});setTimeout(function(){f.data("wa_editor").on("input",function(){a.toggleButton(!0)})},100);d(document).on("updateEditorTextarea",
function(){var a=f.data("wa_editor");a&&(a=a.getValue(),e.val(a).trigger("change"))})})};CRMSettingsTemplate.prototype.initHelp=function(){var a=this,b=a.$wrapper,c=d(document),e=d("#wa-editor-help"),f=d("#wa-editor-help-link"),g=function(a){0>=c.find(b).length?c.off("click",g):(a=d(a.target),!a.is(e)&&0>=e.find(a).length&&e.hide())};c.on("click",g);f.on("click",function(){if(e.is(":visible"))return e.hide(),!1;e.load(a.site_app_url+"?module=pages&action=help","app=crm&file=invoice&invoice_template_id="+
a.template_id,function(){e.find("#wa-help-wa").remove();e.find("#wa-help-wa-content").remove();e.show();e.find("ul>li.no-tab>p.bold").hide();e.data("loaded",!0)});return!1});e.on("click","div.fields a.inline-link",function(b){b.preventDefault();b=d(this).find("i");var c=a.$textarea.data("wa_editor");c&&c.insert(d.trim(b.text()))})};CRMSettingsTemplate.prototype.initPreviewIframe=function(){function a(){d(document).trigger("updateEditorTextarea");b.toggleButton(!1);new CRMDialog({html:b.preview_dialog_template,
onOpen:function(a){a.find("#js-preview-content").val(b.$textarea.val());a.find(".js-preview-form").trigger("submit")}})}var b=this;b.$wrapper.on("click",".js-show-preview",function(b){b.preventDefault();a()})};CRMSettingsTemplate.prototype.initElasticFooter=function(){function a(){d.contains(document,f[0])?b():e.off("scroll",a)}function b(){var a=e.scrollTop();k.top+m>a+e.height()?h||(h=!0,g=d("<div />"),g.height(m).insertAfter(f),f.css("left",k.left).width(l).addClass("is-fixed-to-bottom")):c()}
function c(){g&&g.length&&g.remove();g=!1;f.removeAttr("style").removeClass("is-fixed-to-bottom");k=f.offset();l=f.outerWidth();m=f.outerHeight();h=!1}var e=d(window),f=this.$wrapper.find(".js-footer-block"),g=!1,h=!1,k,l,m;c();e.on("scroll",a);e.on("resize",function(){c();e.trigger("scroll")});b()};return CRMSettingsTemplate}(jQuery);var CRMEmailPersonalSettingsDialog=function(d){CRMEmailPersonalSettingsDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$textarea=this.$wrapper.find(".js-wysiwyg-field");this.dialog=this.$wrapper.data("dialog");a=!1;window&&window.parent&&window.parent.$&&window.parent.$.crm?a=window.parent.$.crm:window.$&&window.$.crm&&(a=window.$.crm);this.crm=a;this.initClass()};CRMEmailPersonalSettingsDialog.prototype.initClass=function(){this.initWYSIWYG();this.initSave()};
CRMEmailPersonalSettingsDialog.prototype.initSave=function(){function a(){if(!c){c=!0;var a=b.$form.serialize();d.post(b.crm.app_url+"?module=email&action=personalSettingsSave",a,function(a){"ok"===a.status&&(b.dialog.options.onSave(a.data||{}),b.dialog.close())}).always(function(){c=!1})}}var b=this,c=!1;b.$form.on("submit",function(b){b.preventDefault();a()})};CRMEmailPersonalSettingsDialog.prototype.initWYSIWYG=function(){var a=this.$textarea;this.crm.initWYSIWYG(a,{minHeight:130,maxHeight:130,
keydownCallback:function(a){}});var b=this.dialog.onClose;this.dialog.onClose=function(){b(arguments);var c=a.data("redactor");c&&"core"in c&&c.core.destroy()}};return CRMEmailPersonalSettingsDialog}(jQuery);
