(function(d){d.fn.shiftSelectable=function(){function a(m,n,p){var q=!1,r=m.get(0),u=n.get(0);b.find(k).each(function(){var v=this==r,t=this==u;v&&(q=!0);q&&(p.extra={is_first:v,is_last:t},l&&l(d(this),p));if(t)return q=!1})}var b=this,c=arguments;if(1<b.length)b.each(function(){d.fn.shiftSelectable.apply(d(this),c)});else{var e=b.data("shiftSelectable");if(d.isPlainObject(c[0])){if(d.isPlainObject(e))return;e=c[0]}var f=e.ns||(Math.random()+"").slice(2);if("destroy"===c[0])b.off("."+f),b.data("shiftSelectable");
else{var g,k=e.selector,l=e.onSelect,h=e.behavior_type;"vertical"!==h&&"horizontal"!==h&&"mixed"!==h&&(h="vertical");e=e.disable_text_selection;if(void 0!==e?e:1)b.attr("unselectable","on").css({"-moz-user-select":"-moz-none","-o-user-select":"none","-khtml-user-select":"none","-webkit-user-select":"none","-ms-user-select":"none","user-select":"none"}).on("selectstart",!1).on("mousedown",!1);b.on("click."+f,k,function(m){var n=d(this),p=m.shiftKey;if(g&&p){p=g.offset();var q=n.offset();p="vertical"===
h?q.top>p.top:"horizontal"===h?q.left>p.left:q.top>p.top||q.left>p.left;p?a(g,n,m):a(n,g,m)}g=n})}}}})(jQuery);var CRMDialog=function(d){function a(b){console&&console.log&&console.log(b)}CRMDialog=function(b){this.$wrapper=d(b.html);this.$block=this.$wrapper.find(".crm-dialog-block");this.position=b.position||!1;this.userPosition=b.setPosition||!1;this.options=b.options||!1;this.esc="undefined"===typeof b.esc?!0:!!b.esc;this.remain_after_load=b.remain_after_load||!1;this.$body=d(window.top.document).find("body");this.$window=d(window.top);this.is_closed=!1;this.is_visible=!0;this.onBgClick=b.onBgClick||!1;
this.onOpen=b.onOpen||function(){};this.onClose=b.onClose||function(){};this.onConfirm=b.onConfirm||function(){};this.onCancel=b.onCancel||function(){};this.onResize=b.onResize||!1;this.initClass()};CRMDialog.prototype.initClass=function(){var b=this;b.$wrapper.data("dialog",b);b.render();setTimeout(function(){b.bindEvents()},0)};CRMDialog.prototype.bindEvents=function(){function b(){f.is_closed||f.close();g.off("click",b);g.off("wa_before_load",b)}function c(){d.contains(document,f.$wrapper[0])?
f.resize():d(window).off("resize",c)}function e(){d.contains(document,f.$wrapper[0])?f.resize():d(document).off("refresh resizeDialog",e)}var f=this,g=d(document),k=f.$block?f.$block:f.$wrapper;f.$wrapper.on("close",b);if(!f.remain_after_load)g.on("wa_before_load",b);f.$wrapper.on("click",".crm-dialog-background",function(l){if(f.onBgClick)f.onBgClick(l);else l.stopPropagation()});if(f.esc)g.on("keyup",function(l){27===l.keyCode&&f.is_visible&&f.close()});k.on("click",".js-cancel-dialog",function(){if("function"==
typeof f.onCancel)f.onCancel(f);else a("Error: Cancel is not a function")});k.on("click",".js-confirm-dialog",function(l){l.stopPropagation();"function"==typeof f.onConfirm?!1!==f.onConfirm(f)&&f.close():a("Error: Confirm is not a function")});k.on("click",".js-close-dialog",b);d(window).on("resize",c);g.on("refresh resizeDialog",e)};CRMDialog.prototype.render=function(){try{this.$body.append(this.$wrapper)}catch(b){a("Error: "+b.message)}this.setPosition();this.onOpen(this.$wrapper,this)};CRMDialog.prototype.setPosition=
function(){function b(h){return{left:parseInt((e-h.width)/2),top:parseInt((f-h.height)/2)}}var c=this.$window,e=c.width(),f=c.height();c=this.$block?this.$block:this.$wrapper;var g=c.outerWidth(),k=c.outerHeight();var l=this.position?this.position:(this.userPosition?this.userPosition:b)({width:g,height:k});0<l.left&&l.left+g>e&&(l.left=e-g-20);0<l.top?l.top+k>f&&(l.top=f-k-20):(l.top=20,g=c.find(".crm-dialog-content"),g.hide(),k=c.outerHeight(),g.height(f-k-40).addClass("is-long-content").show());
c.css(l)};CRMDialog.prototype.close=function(){this.is_closed=!0;this.onClose(this.$wrapper,this);this.$wrapper.remove()};CRMDialog.prototype.resize=function(){this.$block.addClass("is-animated");this.setPosition();if(this.onResize)this.onResize(this.$wrapper,this)};CRMDialog.prototype.hide=function(){this.$wrapper.hide();this.is_visible=!1};CRMDialog.prototype.show=function(){this.$wrapper.show();this.is_visible=!0};return CRMDialog}(jQuery);var CRMElasticBlock=function(d){CRMElasticBlock=function(a){this.$window=d(window);this.$wrapper=a.$wrapper;this.$aside=a.$aside;this.$content=a.$content;this.top_fix_class="fixed-to-top";this.bottom_fix_class="fixed-to-bottom";this.debug=a.debug;this.initClass()};CRMElasticBlock.prototype.initClass=function(){function a(){if(d.contains(document,p[0])){var A=Math.floor(k.$content.outerHeight()),D=Math.floor(p.outerHeight()),E=Math.floor(n.height()),F=m.scrollTop(),G=Math.floor(p.offset().top),H=B>
F?1:-1,I=F-v;C=p.width();if(!(!t&&E>r&&760<=q)||A&&A<D)t?(E=Math.floor(n.height()),G=Math.floor(n.offset().top),G=E+G-r-F,H=D-r,t=!1,E>D&&F>v&&(H<G?e(0):f())):g();else{A=r>D+0;var K=F<=v,J=parseInt(G+D-F-r),L=0<J;J=0>=J;if(A)0<I+0?(w||x||!y)&&e(0):(w||y||x||z)&&g();else if(K){if(w||x||y)z?G<=v&&g():g()}else L?0<H?G>=0+F&&(w||!y||x)&&e():(!w||y||x)&&c(G-v):J?u.top+E<F+r?(!w||y||x)&&c(E-D):0<H?(!w||y||x)&&c(G-v):(w||y||!x)&&f():(!w||y||x)&&c(G-v)}B=F}else m.off("scroll",a)}function b(){d.contains(document,
p[0])?(q=Math.floor(m.width()),r=Math.floor(m.height()),g(),m.trigger("scroll")):m.off("scroll",b)}function c(A){k.log("Manual top scroll position");p.css("top",A).width(C).removeClass(l).removeClass(h);w=!0;y=x=z=!1}function e(A){k.log("Fixed to top scroll position");p.removeAttr("style").width(C).removeClass(h).addClass(l);A&&(z=!0,p.css("top",A));w=x=!1;y=!0}function f(){k.log("Fixed to bottom scroll position");p.removeAttr("style").width(C).removeClass(l).addClass(h);w=y=z=!1;x=!0}function g(){k.log("Default scroll position");
p.removeAttr("style").removeClass(h).removeClass(l);w=y=x=z=!1}var k=this,l=k.top_fix_class,h=k.bottom_fix_class,m=k.$window,n=k.$wrapper,p=k.$aside;p.addClass("crm-elastic-block");var q=Math.floor(m.width()),r=Math.floor(m.height()),u=n.offset(),v=p.offset().top,t=!0,w=!1,x=!1,y=!1,z=!1,B=0,C;m.on("scroll",a).on("resize",b)};CRMElasticBlock.prototype.log=function(a){this.debug&&console.log(a)};return CRMElasticBlock}(jQuery);(function(d){function a(c,e){var f=d(window);e=f.scrollTop();var g=f.scrollLeft()+f.width(),k=f.scrollTop()+f.height();f=f.scrollLeft();var l=c.element.offset();l.right=l.left+c.element.outerWidth();l.bottom=l.top+c.element.outerHeight();return e<l.top&&f<l.left&&g>l.right&&k>l.bottom}function b(c,e){return c.clone().addClass(e.fixed_class||"sticky-fixed").css(d.extend({position:"fixed",display:"none"},e.fixed_css||{})).removeAttr("id").insertAfter(c)}d.fn.sticky=function(c){function e(){f.closest("body").length?
d.each(k,function(l,h){g.isStaticVisible.call(h.element,h,g)?h.is_fixed&&(h.is_fixed=!1,h.fixed_clone.hide(),g.hideFixed&&g.hideFixed.call(h.fixed_clone,h,g)):(h.is_fixed||(h.is_fixed=!0,h.fixed_clone.show(),g.showFixed&&g.showFixed.call(h.fixed_clone,h,g)),g.updateFixed&&g.updateFixed.call(h.fixed_clone,h,g))}):d(window).off("resize scroll",e)}var f=this,g=d.extend({fixed_class:"sticky-fixed",isStaticVisible:a,getClone:b},c||{}),k=f.map(function(){var l=d(this);return{element:l,fixed_clone:g.getClone.call(l,
l,g),is_fixed:!1}}).get();d(window).on("resize scroll",e);e();return this}})(jQuery);(function(d){d.ajaxSetup({cache:!1});d(document).ajaxSend(function(a,b,c){c.crossDomain||"POST"!==(c.type||"").toUpperCase()||(a=(a=document.cookie.match(RegExp("(?:^|; )_csrf=([^;]*)")))?decodeURIComponent(a[1]):"",c.data||0===c.data||(c.data=""),"string"===typeof c.data?-1==c.data.indexOf("_csrf=")&&(c.data+=(0<c.data.length?"&":"")+"_csrf="+a,b.setRequestHeader("Content-type","application/x-www-form-urlencoded")):"object"===typeof c.data&&(window.FormData&&c.data instanceof window.FormData?"function"==
typeof c.data.set?c.data.set("_csrf",a):c.data.append("_csrf",a):c.data._csrf=a))});d(document).ajaxError(function(a,b,c,e){if(b.getResponseHeader("wa-session-expired"))return window.location.reload();502===b.status&&"abort"==e||c.url&&0<=c.url.indexOf("background_process")||c.data&&"string"===typeof c.data&&0<=c.data.indexOf("background_process")?console&&console.log&&console.log("Notice: XHR failed on load: "+c.url):200!==b.status&&b.responseText&&(a=b.responseText,d.crm&&d.crm.is_debug&&(a=d.crm.confirm.template.replace("%title%",
"XHR error "+b.status).replace("%text%",b.responseText).replace("%button%","Close")),d.waDialog({html:a,onOpen:function(f,g){f.find(".wa-exception-debug-dump #Trace pre").each(function(){var k=d(this),l=k.html().replace(/^(#(#|\d+)\s+(wa-system|index\.php|\{main\}).*)$/gm,'<span style="color:#999">$1</span>');k.html(l)})}}),-1===a.indexOf("dialog-background")&&(document.open("text/html"),document.write(b.responseText),document.close()))});d.crm=d.extend(d.crm||{},{lang:!1,app_url:!1,backend_url:!1,
is_debug:!1,is_page_loaded:!1,content:!1,sidebar:!1,storage:new d.store,locales:!1,confirm:{show:function(a){var b=a.title||"",c=a.text||"",e=a.button||"",f=a.onConfirm||function(){},g=a.onCancel||function(){};a=a.onClose||function(){};var k=d.crm.confirm.template;return(k=k.replace("%title%",b).replace("%text%",c).replace("%button%",e))?d.waDialog({html:k,onOpen:function(l,h){l.on("click",".js-confirm-dialog",function(m){m.preventDefault();h.options.onConfirm();h.close()});l.on("click",".js-cancel-dialog",
function(m){m.preventDefault();h.options.onCancel();h.close()})},options:{onConfirm:f,onCancel:g,onClose:a}}):d.waDialog.confirm({title:b,text:c,success_button_title:e,success_button_class:"danger",cancel_button_title:d.crm.locales.cancel,cancel_button_class:"light-gray",onSuccess:f,onCancel:g})},template:""},alert:{show:function(a){var b=a.text||"",c=a.button||d.crm.locales.close||"",e=a.button_class||"gray",f=d.crm.alert.template;f=f.replace("%title%",a.title||"").replace("%text%",b).replace("%button%",
c);if(!f)throw"Not found alert dialog";a=d.extend({},a,!0);a.html=f;f=d.waDialog(a);f.$wrapper.find(".js-close-dialog").addClass(e);return f},template:""},title:{pattern:"CRM \u2014 %s",set:function(a){if(a){var b=history.state;b&&(b.title=a);document.title=d.crm.title.pattern.replace("%s",a)}}},check:{email:function(a){var b=!1;0<a.length&&1<=(a.match(/.+?@.+/g)||[]).length&&(b=!0);return b}},encodeHTML:function(a){return a&&(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},
renderSVG:function(a){if("object"!==typeof d3)return!1;var b=function(c,e){b=function(f){this.$icon=f.$icon;this.svg=e.select(this.$icon[0]).append("svg");this.type=this.$icon.data("type");this.icon_w=this.$icon.outerWidth();this.icon_h=this.$icon.outerHeight();this.initClass()};b.prototype.initClass=function(){this.svg.attr("width",this.icon_w).attr("height",this.icon_h);this.$icon.hasClass("funnel-state")?this.renderFunnelState():this.$icon.hasClass("funnel")?this.renderFunnel():this.$icon.hasClass("funnel-1")&&
this.renderFunnel(1);this.$icon.data("icon",this)};b.prototype.renderFunnelState=function(){function f(m){return m/16*k.icon_w}function g(m){return m/16*k.icon_h}var k=this,l=k.$icon.data("color")||"#aaa",h=k.svg.append("g");h.append("polygon").attr("points",f(4)+","+g(16)+" "+f(0)+","+g(16)+" "+f(3.9)+","+g(7.9)+" "+f(0)+","+g(0)+" "+f(4)+","+g(0)+" "+f(8.7)+","+g(7.9)).style("opacity",.33).style("fill",l);h.append("polygon").attr("points",f(8)+","+g(16)+" "+f(4)+","+g(16)+" "+f(7.9)+","+g(7.9)+
" "+f(4)+","+g(0)+" "+f(8)+","+g(0)+" "+f(12.6)+","+g(7.9)).style("opacity",.66).style("fill",l);h.append("polygon").attr("points",f(11.9)+","+g(16)+" "+f(7.9)+","+g(16)+" "+f(11.8)+","+g(7.9)+" "+f(7.9)+","+g(0)+" "+f(11.9)+","+g(0)+" "+f(16)+","+g(7.9)).style("fill",l)};b.prototype.renderFunnel=function(f){function g(){var r=[],u=k.icon_w,v=k.icon_h;0<n&&(u-=n,v-=n);var t=u-6+",0";var w=u+","+v/2;u=u-6+","+v;var x="0,"+v;v="6,"+v/2;r.push("0,0");r.push(t);r.push(w);r.push(u);r.push(x);f&&1===f||
r.push(v);return r.join(" ")}var k=this,l=k.$icon.data("color")||"#aaa",h=c.crm.color(l),m=k.$icon.data("hover-color")||h.getTone(20),n=k.$icon.data("stroke-width")||0,p=k.$icon.data("hover")||!1,q=k.svg.append("g").append("polygon").attr("class","is-animated").attr("points",g()).attr("transform","translate("+n/2+","+n/2+")").style("fill",l);0<n&&(h=h.getTone(-20),q.style("stroke",h).style("stroke-width",n));p&&(p=q.node(),p=c(p).closest(".c-state-item "),p.on("mouseenter",function(){q.style("fill",
m)}),p.on("mouseleave",function(){q.style("fill",l)}));(function(){function r(){v||(v=!0,setTimeout(u,100))}function u(){c.contains(document,k.$icon[0])?(k.refresh(),q.attr("points",g())):c(window).off("resize refresh-icons",r);v=!1}var v=!1;c(window).on("resize refresh-icons",r)})()};b.prototype.refresh=function(){this.icon_w=this.$icon.outerWidth();this.icon_h=this.$icon.outerHeight();this.svg.attr("width",this.icon_w).attr("height",this.icon_h)};return b}(jQuery,d3);"string"===typeof a&&(a=d(a));
a.length&&a.find(".svg-icon").each(function(){var c=d(this),e=c.data("icon");e?e.refresh():b&&new b({$icon:c})})},tabSlider:function(a){var b=function(c){b=function(e){this.$wrapper=e.$wrapper;this.$slider=e.$slider;this.$activeSlide=e.$activeSlide||!1;this.type_class=!1;this.left=0;this.slider_w=this.wrapper_w=!1;this.initClass()};b.prototype.initClass=function(){function e(){c.contains(document,f.$wrapper[0])?f.wrapper_w!==f.$wrapper.outerWidth()&&f.reset():g.off("resize",e)}var f=this,g=c(window);
f.detectSliderWidth();f.initStartPosition();g.on("resize",e);f.$wrapper.on("click",".c-action",function(k){k.preventDefault();k=c(this);k.hasClass("left")&&f.moveSlider(!1);k.hasClass("right")&&f.moveSlider(!0)})};b.prototype.initStartPosition=function(){var e=0;if(this.$activeSlide.length){var f=this.$activeSlide.outerWidth(),g=Math.floor(Math.abs(this.$wrapper.offset().left-this.$activeSlide.offset().left));g+f>this.wrapper_w&&(e=g-40)}e?(this.start_left=e,this.moveSlider(!0,e)):(this.setLeft(0),
this.showArrows())};b.prototype.detectSliderWidth=function(){this.slider_w=this.$slider[0].scrollWidth;this.$slider.css("width",this.slider_w);this.wrapper_w=this.$wrapper.outerWidth()};b.prototype.showArrows=function(){function e(g){f.type_class&&f.$wrapper.removeClass(f.type_class);g&&(f.$wrapper.addClass(g),f.type_class=g)}var f=this;0<=f.left?f.wrapper_w<f.slider_w?e("type-1"):e():f.wrapper_w<f.slider_w-Math.abs(f.left)?e("type-2"):e("type-3")};b.prototype.setLeft=function(e){0<Math.abs(e)||(e=
0);this.$slider.css("left",e?e+"px":0);this.left=e};b.prototype.moveSlider=function(e,f){f=f?f:parseInt(this.wrapper_w/2);var g=this.slider_w-this.wrapper_w,k=0;0<g&&(k=Math.abs(this.left)+(e?f:-f),k>g?k=g:0>k&&(k=0));this.setLeft(-k);this.showArrows()};b.prototype.reset=function(){this.setLeft(0);this.detectSliderWidth();this.showArrows()};return b}(d);return new b(a)},color:function(a){var b=function(){function c(h,m,n){h=parseInt(h,16);m=parseInt(m,16);n=parseInt(n,16);return 0<=h&&0<=m&&0<=n?
[h,m,n]:null}function e(h){h[0]=parseInt(h[0].toFixed());h[1]=parseInt(h[1].toFixed());h[2]=parseInt(h[2].toFixed());var m=h[0].toString(16),n=h[1].toString(16);h=h[2].toString(16);return 0<=m.length&&0<=n.length&&0<=h.length?"#"+(1==m.length?"0"+m:m)+(1==n.length?"0"+n:n)+(1==h.length?"0"+h:h):null}function f(h){var m=(h[0]+16)/116,n=h[1]/500+m,p=m-h[2]/200;n=.95047*(.008856<n*n*n?n*n*n:(n-16/116)/7.787);m=.008856<m*m*m?m*m*m:(m-16/116)/7.787;p=1.08883*(.008856<p*p*p?p*p*p:(p-16/116)/7.787);h=3.2406*
n+-1.5372*m+-.4986*p;var q=-.9689*n+1.8758*m+.0415*p;m=.0557*n+-.204*m+1.057*p;h=.0031308<h?1.055*Math.pow(h,1/2.4)-.055:12.92*h;q=.0031308<q?1.055*Math.pow(q,1/2.4)-.055:12.92*q;m=.0031308<m?1.055*Math.pow(m,1/2.4)-.055:12.92*m;return[255*Math.max(0,Math.min(1,h)),255*Math.max(0,Math.min(1,q)),255*Math.max(0,Math.min(1,m))]}function g(h){var m=h[0]/255,n=h[1]/255,p=h[2]/255;m=.04045<m?Math.pow((m+.055)/1.055,2.4):m/12.92;n=.04045<n?Math.pow((n+.055)/1.055,2.4):n/12.92;p=.04045<p?Math.pow((p+.055)/
1.055,2.4):p/12.92;h=(.4124*m+.3576*n+.1805*p)/.95047;var q=.2126*m+.7152*n+.0722*p;m=(.0193*m+.1192*n+.9505*p)/1.08883;h=.008856<h?Math.pow(h,1/3):7.787*h+16/116;q=.008856<q?Math.pow(q,1/3):7.787*q+16/116;m=.008856<m?Math.pow(m,1/3):7.787*m+16/116;return[116*q-16,500*(h-q),200*(q-m)]}function k(h,m,n){var p=Math.floor(6*h),q=6*h-p;h=n*(1-m);var r=n*(1-q*m);m=n*(1-(1-q)*m);switch(p%6){case 0:var u=n;var v=m;var t=h;break;case 1:u=r;v=n;t=h;break;case 2:u=h;v=n;t=m;break;case 3:u=h;v=r;t=n;break;case 4:u=
m;v=h;t=n;break;case 5:u=n,v=h,t=r}return[255*u,255*v,255*t]}function l(h){var m=h[0]/255,n=h[1]/255,p=h[2]/255,q,r=Math.max(m,n,p);var u=r-Math.min(m,n,p);if(0==u)var v=q=0;else{q=u/r;h=(r-m)/6/u+.5;var t=(r-n)/6/u+.5;u=(r-p)/6/u+.5;m===r?v=u-t:n===r?v=1/3+h-u:p===r&&(v=2/3+t-h);0>v?v+=1:1<v&&--v}return{h:Math.round(360*v),s:Math.round(100*q),b:Math.round(100*r)}}b=function(h){h=this.hex=h;var m=!1;"string"===typeof h?(h=h.replace("#",""),3===h.length?m=c(h[0]+""+h[0],h[1]+""+h[1],h[2]+""+h[2]):
6===h.length&&(m=c(h[0]+""+h[1],h[2]+""+h[3],h[4]+""+h[5]))):"object"===typeof h&&3===h.length&&(m=h);this.rgb=m};b.prototype.getRange=function(){var h=this.rgb?g(this.rgb):!1;if(h){var m=f([90,h[1],h[2]]),n=f([40,h[1],h[2]]);h=e(m);var p=e(n);h=[h,p];h.getColor=function(q){if(0<=q&&100>=q){var r=m[0],u=m[1],v=m[2];return e([Math.floor(r+(n[0]-r)*q/100),Math.floor(u+(n[1]-u)*q/100),Math.floor(v+(n[2]-v)*q/100)])}return null};return h}return null};b.prototype.getTone=function(h){function m(p){100<
p?p=100:0>p&&(p=0);return p}var n=l(this.rgb);n.s=m(n.s*(1+h/100));n.b=m(n.b*(1+h/100));h=k(n.h/360,n.s/100,n.b/100);return e(h)};return b}();return new b(a)},initWYSIWYG:function(a,b){if(!a||!a.length||a.data("redactor"))return a;b=d.extend({minHeight:130,buttons:"inline bold italic underline deleted lists outdent indent image link horizontalrule fontcolor fontsize fontfamily".split(" "),plugins:["fontcolor","fontsize","fontfamily"],allowedTags:"a b i u pre blockquote p strong em del strike span ul ol li div span br".split(" "),
uploadImage:!1,lang:this.lang},b||{});a.redactor(b);d(document).one("wa_before_render",function(){d.contains(document,a[0])&&a.data("redactor")&&a.redactor("core.destroy")});return a},escape:function(a){return d("<div />").text(a).html()},runBackgroundWorker:function(a){var b=Math.floor(100*Math.random())/100,c=Math.floor(100*Math.random())/100,e=a.delay||1E4,f=e/2,g=a.id||(""+Math.random()).slice(2),k=null,l=null,h=a.url;h?(e+=f*b,200>=e?console.error("Delay value too low"):function(){try{var m=
function(){k&&clearTimeout(k);l&&l.abort();l=d.post(h,{process_id:g});l.always(function(){l=null;k=setTimeout(m,e)});l.fail(function(){return!1})};k=setTimeout(m,500+300*c)}catch(n){console.error(["source email worker fail",n])}}()):console.error("Empty url")}})})(jQuery);(function(d,a){d.fn.serializeObject=function(){var b={};d.each(this.serializeArray(),function(c,e){c=e.name;e=e.value;b[c]=b[c]===a?e:d.isArray(b[c])?b[c].concat(e):[b[c],e]});return b}})(jQuery);
(function(d){var a=null,b=!1;d(document).on("dragover",function(c){c.preventDefault();a?clearTimeout(a):b||(b=!0,d(document).trigger("myDragEnter"));a=setTimeout(function(){a=null;b=!1;d(document).trigger("myDragLeave")},100)});d(document).on("drop",function(c){c.preventDefault()})})(jQuery);
var ContentRouter=function(d){ContentRouter=function(a){this.$window=d(window);this.$content=a.$content;this.$spaContainer=a.$spaContainer;this.api_enabled=!(!window.history||!window.history.pushState);this.xhr=!1;this.is_enabled=!0;this.need_confirm=!1;this.initClass()};ContentRouter.prototype.initClass=function(){this.bindEvents()};ContentRouter.prototype.bindEvents=function(){var a=this,b=window.location.origin+d.crm.app_url;d(document).on("click","a",function(c){var e=d(this),f=e.attr("href"),
g=e.data("link"),k=this.href;0<=k.indexOf(d.crm.app_url+"contact/")||k.indexOf(d.crm.app_url+"deal/");f||(e.attr("href","javascript:void(0);"),f=e.attr("href"));var l=e.hasClass("js-disable-router"),h=this.href.substr(0,b.length)==b;f=!("#"===f||"javascript:"===f.substr(0,11));l=a.is_enabled&&!l&&h&&f;c.ctrlKey||c.shiftKey||c.metaKey||!l||(c.preventDefault(),a.need_confirm?d.crm.confirm.show({title:d.crm.locales.unsaved_dialog_title,text:d.crm.locales.unsaved_dialog_text,button:d.crm.locales.unsaved_dialog_button,
onConfirm:function(){d(document).trigger("unsavedChanges",!1);a.load(k,!1,e)}}):d.crm.iframe&&"top"===g?window.parent.$.crm.content.load(k,!1,e):a.load(k,!1,e))});d("#wa-app-crm").on("click","a",function(c){c.stopPropagation()});a.api_enabled&&(window.onpopstate=function(c){c.stopPropagation();a.onPopState(c)});d(document).on("unsavedChanges",function(c,e){a.need_confirm=!!e})};ContentRouter.prototype.load=function(a,b,c){var e=this;if(!(0<=a.indexOf(d.crm.app_url)))return alert("Determine the path error"),
!1;e.animate(!0);e.xhr&&e.xhr.abort();d(document).trigger("wa_before_load",{content_uri:a});c&&c.find("[data-fa-i2svg]").hide().after('<i class="fas fa-spinner fa-spin"></i>');e.xhr=d.ajax({method:"GET",url:a,dataType:"html",global:!1,cache:!1}).done(function(f){e.api_enabled&&!b&&history.pushState({reload:!0,content_uri:a},"",a);c&&(c.find("[data-fa-i2svg]:first").show(),c.find("[data-fa-i2svg]").slice(1).remove());e.setContent(f);e.animate(!1);e.xhr=!1;d(document).trigger("wa_loaded")}).fail(function(f){f.responseText&&
d.crm.alert.show({title:"Error",text:f.responseText,button:"Close"});c&&(c.find("[data-fa-i2svg]:first").show(),c.find("[data-fa-i2svg]").slice(1).remove())});return e.xhr};ContentRouter.prototype.reload=function(){var a=this.api_enabled&&history.state&&history.state.content_uri?history.state.content_uri:location.href;return a?this.load(a,!0):d.when()};ContentRouter.prototype.setContent=function(a){d(document).trigger("wa_before_render");d(a).filter("#app").length?(d.crm.iframe||this.$content.hide(),
this.$spaContainer.show(),this.$spaContainer.is(":empty")&&this.$spaContainer.html(a)):(this.$content.show().html(a),this.$spaContainer.hide())};ContentRouter.prototype.onPopState=function(a){if(a=a.state||!1){var b=a.current?0<=a.current.indexOf("/contact/")||0<=a.current.indexOf("/deal/"):!0;if(!a.content_uri&&!b)return alert("Determine the path error"),!1;d(document).trigger("wa_before_load",{content_uri:a.content_uri});a.reload?this.reload(a.content_uri):a.content&&this.setContent(a.content);
a.title&&d.crm.title.set(a.title);d(document).trigger("wa_loaded")}else location.reload()};ContentRouter.prototype.animate=function(a){};return ContentRouter}(jQuery),CrmEditable=function(d){var a=function(b){this.$wrapper=b.$wrapper;this.save=b.onSave||function(){};this.render=b.onRender||!1;this.placeholder=b.placeholder||"";this.text=(this.is_empty=this.$wrapper.hasClass("is-empty"))?"":d.trim(this.$wrapper.text());this.is_edit=this.$field=!1;this.initClass()};a.prototype.initClass=function(){this.$field=
this.renderField();this.bindEvents()};a.prototype.bindEvents=function(){var b=this;b.$wrapper.on("click",function(){b.toggle()});var c=!1,e=!1;b.$field.on("blur",function(){e||c||(c=!0,b.save(b),c=!1);e=!1});b.$field.on("keyup",function(f){var g=27===f.keyCode;13!==f.keyCode||c?g&&(b.$field.val(b.text),b.toggle("hide"),e=!0):(c=!0,b.save(b),e=!0,c=!1)})};a.prototype.renderField=function(){var b=this.text,c=d('<input class="bold" type="text" name="" />');this.placeholder&&c.attr("placeholder",this.placeholder);
this.is_empty||c.val(b);c.hide();this.$wrapper.after(c);this.render&&this.render(this,c);return c};a.prototype.toggle=function(b){if(b="hide"!==b){var c=this.$wrapper.parent().width(),e=this.$wrapper.width(),f=Math.floor(c/2);c-=10;this.$field.width(e>c?c:e<f?f:e);this.$wrapper.hide();this.$field.show().focus()}else this.$wrapper.show(),this.$field.hide();this.is_edit=b};a.prototype.loading=function(b){this.$field.siblings(".crm-editable-loading").remove();arguments.length&&!b?this.$field.prop("disabled",
!1):(this.$field.after('<span class="icon loading crm-editable-loading"><i class="fas fa-spinner fa-spin"></i></span>'),this.$field.prop("disabled",!0));return this};a.prototype.isLoading=function(b){return 0<this.$field.siblings(".crm-editable-loading").length};a.prototype.getText=function(){return this.$field.val()};a.prototype.setText=function(b,c){this.text=b;this.$field.val(b);this.$wrapper.text(void 0===c?b:c);return this};a.prototype.hide=function(){this.reset();this.loading(!1);this.toggle("hide");
return this};a.prototype.reset=function(){this.setText(this.text,this.$wrapper.text());return this};a.prototype.isChanged=function(){return this.getText()!==this.text};return a}($);(function(d){function a(e,f){var g=new RegExp(d.ui.autocomplete.escapeRegex(f),"i");return d.grep(e,function(k){return g.test(d("<div>").html(k.label||k.value||k).text())})}var b=d.ui.autocomplete.prototype,c=b._initSource;d.extend(b,{_initSource:function(){this.options.html&&d.isArray(this.options.source)?this.source=function(e,f){f(a(this.options.source,e.term))}:c.call(this)},_renderItem:function(e,f){var g=this.options.item_clz||"";this.options.html&&(g+=" ui-menu-item-html");return d("<li class='"+
g+"'></li>").data("item.autocomplete",f).append(d("<div></div>")[this.options.html?"html":"text"](f.label)).appendTo(e)}})})(jQuery);var CRMSidebar=function(d){CRMSidebar=function(a){this.$wrapper=a.$wrapper;this.$ui=a.$ui;this.$body=this.$wrapper.find(".sidebar-body");this.$footer=this.$wrapper.find(".sidebar-footer");this.$toggler=this.$wrapper.find(".sidebar-mobile-toggle");this.$sidebar_open=!1;this.selected_class="selected";this.$activeMenuItem=this.$wrapper.find("li."+this.selected_class+":first")||!1;this.xhr=!1;this.timer=0;this.initClass()};CRMSidebar.prototype.initClass=function(){function a(c){var e=c.indexOf("crm/");
e&&0<e&&(c=c.slice(e+4),e=c.indexOf("/"),c=c.slice(0,e),$item=b.$wrapper.find(`a[href*="${c}"]`)||!1,b.setItem($item.closest("li")),d.crm.title.set($item.data("wa-tooltip-content")))}var b=this;b.initUpdater();b.initMobileToggle();b.$activeMenuItem.length||b.selectLink();b.$wrapper.on("click","li > a",function(){var c=d(this);(it_reminder=c.attr("href").indexOf("reminder")+1)||c.find(".js-indicator").remove()});d(document).ready(function(){a(window.location.href)});d(document).on("wa_before_render",
function(){a(window.location.href)});window.matchMedia("(min-width: 761px) and (pointer: fine)").matches&&(b.$body.find("li > a").each(function(){d(this).waTooltip({placement:"right"})}),b.$footer.find("li > a").each(function(){d(this).waTooltip({placement:"right"})}),b.$body.on("scroll",function(){d(".wa-tooltip-box").parent().remove()}),b.$footer.on("scroll",function(){d(".wa-tooltip-box").parent().remove()}))};CRMSidebar.prototype.setItem=function(a){if(this.$activeMenuItem.length&&this.$activeMenuItem[0]==
a[0])return!1;this.$activeMenuItem.length&&this.$activeMenuItem.removeClass(this.selected_class);a.addClass(this.selected_class);this.$activeMenuItem=a};CRMSidebar.prototype.initMobileToggle=function(){function a(c){b.is_mobile=b.$toggler.is(":visible");b.is_mobile&&("wa_before_render"!==c.type||b.$sidebar_open)&&(c&&c.preventDefault(),window.scrollTo({top:0,behavior:"smooth"}),b.$toggler.siblings().each((e,f)=>{"SCRIPT"!==f.nodeName&&"STYLE"!==f.nodeName&&d(f).slideToggle(400,function(){const g=
d(this);g.is(":hidden")?(g.css("display",""),b.$sidebar_open=!1):b.$sidebar_open=!0})}))}var b=this;b.$toggler.on("click.sidebar touchstart.sidebar",a);d(document).on("wa_before_render",a)};CRMSidebar.prototype.selectLink=function(a){var b;a&&(b=this.$wrapper.find('a[href="'+a+'"]:first'));if(b&&b.length)this.setItem(b.closest("li"));else{a=this.$wrapper.find("a[href^='"+d.crm.app_url+"']");var c=location.pathname,e=0,f=0;a.each(function(g){var k=d(this).attr("href"),l=k.length;0<=c.indexOf(k)&&l>
e&&(e=l,f=g)});if(f||0===f)b=a.eq(f),this.setItem(b.closest("li"))}};CRMSidebar.prototype.reload=function(a){const b=this;let c=d.crm.app_url+"?module=sidebar&ui="+b.$ui+"&reload=1";a&&(c+="&background_process=1");clearTimeout(b.timer);b.xhr&&b.xhr.abort();b.xhr=d.get(c,function(e){b.$toggler.off(".sidebar");b.xhr=!1;b.$body.html(e)})};CRMSidebar.prototype.initUpdater=function(){var a=this;a.timer=setTimeout(function(){d.contains(document,a.$wrapper[0])&&a.reload(!0)},3E5)};return CRMSidebar}(jQuery);var CRMDeal=function(d){var a=function(c){a=function(e){this.$window=c(window);this.$wrapper=e.$wrapper;this.$outer_wrapper=e.$outer_wrapper;this.debug=e.debug;this.indent={top:0};this.$clone=null;this.offset=this.getOffset();this.type=null;this.init()};a.prototype.init=function(){function e(){c.contains(document,g.$wrapper[0])?(g.reset(),g.onScroll()):c(document).off("refresh",e)}function f(){if(c.contains(g.$window[0].document,g.$wrapper[0]))g.onScroll();else g.$window.off("scroll",f)}var g=this;
g.$clone=function(l){var h=c("<div />");l.before(h);return h.hide()}(g.$wrapper);g.onScroll();var k=0;g.$window.on("resize",function(){clearTimeout(k);k=setTimeout(function(){g.reset();g.onScroll()},50)});c(document).on("refresh",e);g.$window.on("scroll",f)};a.prototype.onScroll=function(){var e=this.$window.scrollTop(),f=this.$window,g=f.width();f.height();f=this.offset;var k=this.$outer_wrapper.outerHeight();!(0<g)||k<=this.offset.height?this.fixTo("default"):e<=f.top-this.indent.top?this.fixTo("default"):
this.fixTo("fix_top")};a.prototype.fixTo=function(e,f){e=e?e:null;this.type!==e&&("fix_top"===e?(this.$wrapper.removeAttr("style"),this.$clone.css({height:this.$wrapper.outerHeight()}).show(),this.$wrapper.css({position:"fixed",top:this.indent.top,left:this.offset.left-10,width:this.offset.width+20}),this.$wrapper.addClass("is-fixed-top")):(this.$wrapper.removeClass("is-fixed-top").removeAttr("style"),this.$clone.hide().height(0),this.$wrapper[0].scrollTop=0),c(document).trigger("refresh-icons"),
this.type=e,this.log(e))};a.prototype.reset=function(){this.fixTo("default");this.offset=this.getOffset()};a.prototype.getOffset=function(){var e=this.$wrapper.offset();return{top:e.top,left:e.left,width:this.$wrapper.outerWidth(),height:this.$wrapper.outerHeight()}};a.prototype.log=function(e){this.debug&&console.log(e)};return a}(jQuery),b=function(c){function e(f){var g=0;f.indent&&(g="function"===typeof f.indent?f.indent():f.indent);return g}b=function(f){this.$window=c(window);this.$wrapper=
f.$wrapper;this.$outer_wrapper=f.$outer_wrapper;this.debug=f.debug;this.indent=f.indent;this.$clone=null;this.offset=this.getOffset();this.type=null;this.init()};b.prototype.init=function(){function f(){c.contains(document,k.$wrapper[0])?(k.reset(),k.onScroll()):c(document).off("refresh",f)}function g(){if(c.contains(k.$window[0].document,k.$wrapper[0]))k.onScroll();else k.$window.off("scroll",g)}var k=this;k.$clone=function(h){var m=c("<div />");h.before(m);return m.hide()}(k.$wrapper);k.onScroll();
var l=0;k.$window.on("resize",function(){clearTimeout(l);l=setTimeout(function(){k.reset();k.onScroll()},50)});c(document).on("refresh",f);k.$window.on("scroll",g)};b.prototype.onScroll=function(){var f=this.$window.scrollTop(),g=e(this),k=this.$window,l=k.width();k.height();k=this.offset;var h=this.$outer_wrapper.outerHeight();!(0<l)||h<=this.offset.height?this.fixTo("default"):f<=k.top-g?this.fixTo("default"):this.fixTo("fix_top")};b.prototype.fixTo=function(f,g){function k(){var m=h.getHeight();
h.$wrapper.css({position:"static",top:"auto",left:"auto",width:"auto",height:m});h.$clone.hide().height(0)}function l(){var m=h.getHeight();h.$wrapper.css({position:"fixed",top:e(h),left:h.offset.left,width:h.offset.width,height:m});h.$clone.css({height:m}).show()}var h=this;f=f?f:null;"fix_top"===f?(l(),h.type!==f&&h.$wrapper.addClass("is-fixed")):(k(),h.type!==f&&h.$wrapper.removeClass("is-fixed"));h.type=f;h.log(f)};b.prototype.reset=function(){this.fixTo("default");this.offset=this.getOffset()};
b.prototype.getOffset=function(){var f=this.$wrapper.offset();return{top:f.top,left:f.left,width:this.$wrapper.outerWidth(),height:this.$wrapper.outerHeight()}};b.prototype.log=function(f){this.debug&&console.log(f)};b.prototype.getHeight=function(){var f=this.$window.height(),g=e(this);this.offset.top-this.$window.scrollTop()>g&&(g=this.offset.top-this.$window.scrollTop());var k=this.$outer_wrapper.offset().top+this.$outer_wrapper.outerHeight(),l=this.$window.height()+this.$window.scrollTop();return f-
g-(0>k-l?Math.abs(k-l):0)};return b}(jQuery);CRMDeal=function(c){this.$wrapper=c.$wrapper;this.$aside=this.$wrapper.find(".c-deal-aside");this.$log_section=this.$wrapper.find(".js-deal-log-section");this.locales=c.locales;this.templates=c.templates;this.deal=c.deal||{};this.deal_id=this.deal.id||0;this.order_id=c.order_id||0;this.user_id=c.user_id;this.funnel_id=c.funnel_id;this.can_edit_deal=c.can_edit_deal||!1;this.shop_in_welcome_stage=c.shop_in_welcome_stage||!1;this.remove_is_locked=this.is_locked=
!1;this.init()};CRMDeal.prototype.init=function(){var c=this;d.crm.renderSVG(c.$wrapper);d.crm.sidebar.reload();c.can_edit_deal&&(c.initChangeState(),c.initCloseDeal(),c.initReopenDeal(),c.initAddContact(),c.initRemoveFiles(),c.initEditableName(),c.initChangeDate(),c.initChangePrice(),c.initChangeField(),c.initWYSIWYG(),c.initChangeDescription(),c.initChangeUser(),c.initChangeClient(),c.initDealDelete(),c.initAssignTags(),c.initCreateOrderLink(),c.initEditOrderLink());c.initCall();c.initMessages();
c.initOrderEditShippingDetailLink();c.initSticky();c.initOrderSection();c.initScroll();c.deal_id&&c.initLogSection();c.$wrapper.on("click",".js-remove-owner",function(e){e.preventDefault();c.remove_is_locked||c.removeOwner(d(this).closest(".c-contact"))});c.$wrapper.on("click",".js-remove-contact",function(e){e.preventDefault();c.remove_is_locked||c.removeContact(d(this).closest(".c-contact"))});c.$wrapper.on("click",".js-add-external-contact",function(e){e.preventDefault();c.addExternalContact(d(this))})};
CRMDeal.prototype.initLogSection=function(){var c=this.deal_id;this.$log_section.on("click",".js-open-conversation",function(e){e.preventDefault();e=d(this).attr("href");-1===e.indexOf("?")?window.location.href=e+"?deal_id="+c:window.location.href=e+"&deal_id="+c})};CRMDeal.prototype.initScroll=function(){function c(){d.contains(document,k.$wrapper[0])?f():l.off("scroll",c)}function e(){d.contains(document,k.$wrapper[0])?g():l.off("resize",e)}function f(){0<l.scrollTop()?m||(h.show(),m=!0):m&&(h.hide(),
m=!1)}function g(){var q=p.offset().left;h.css("right",l.width()-q)}var k=this,l=d(window),h=d('<div class="c-scroll-action"><div class="c-icon to-top"></div></div>'),m=!1,n=k.$wrapper.find(".c-deal-board"),p=k.$wrapper.find(".c-deal-aside-wrapper");n.append(h);f();g();h.on("click",function(){d("html, body").animate({scrollTop:0},500)});l.on("scroll",c);l.on("resize",e)};CRMDeal.prototype.initSticky=function(){function c(){0<f[0].scrollTop?f.addClass("is-scrolled"):f.removeClass("is-scrolled")}var e=
this.$wrapper.find(".js-page-header"),f=this.$wrapper.find("#js-deal-aside");new a({$wrapper:e,$outer_wrapper:this.$wrapper,debug:!1});new b({$wrapper:f,$outer_wrapper:f.closest(".c-deal-board"),indent:function(){return e.outerHeight()},debug:!1});c();f.on("scroll",c)};CRMDeal.prototype.initChangeState=function(){function c(f){function g(){d.crm.content.load(d.crm.app_url+"deal/"+e.deal_id+"/")}d.post("?module=deal&action=move",{deal_id:e.deal_id,stage_id:f},function(k){"ok"===k.status&&(k.data.dialog_html&&
k.data.dialog_html.html?new CRMDialog({html:k.data.dialog_html.html,options:{onShopSubmit:g},onConfirm:function(){d.post("?module=deal&action=move",{deal_id:e.deal_id,stage_id:f,force_execute:1},g)}}):g())},"json")}var e=this;e.$wrapper.find(".c-funnel-wrapper").on("click",".c-state-item.js-set-state",function(f){f.preventDefault();f=d(this);if(f.hasClass("selected"))return!1;f=f.data("id");c(f)})};CRMDeal.prototype.initCloseDeal=function(){var c=this,e=!1;c.$wrapper.on("click",".js-close-deal",function(f){f.preventDefault();
e||(e=!0,d.post("?module=deal&action=closeDialog",{id:c.deal_id},function(g){new CRMDialog({html:g})}).always(function(){e=!1}))})};CRMDeal.prototype.initReopenDeal=function(){var c=this,e=!1;c.$wrapper.on("click",".js-reopen-deal",function(f){f.preventDefault();e||(e=!0,d.post("?module=deal&action=reopen",{id:c.deal_id},function(g){"ok"==g.status?d.crm.content.reload():alert("Error: Deal Reopen")},"json").always(function(){e=!1}))})};CRMDeal.prototype.initAddContact=function(){function c(l,h){l=
l.closest(".c-add-contact");h?(k.hide(),l.addClass("is-shown")):(k.show(),l.removeClass("is-shown"))}function e(l,h){function m(n){n=n?n:[];d.each(n,function(p,q){p=q.text;var r=d('<div class="errormsg" />').html(p);k.one("click",function(){r.remove()});g.prepend(r)})}h=h?h:function(){};d.post("?module=deal&action=userAdd",{contact_id:l,deal_id:f.deal_id},function(n){"ok"===n.status?h(n.data.html):n.errors&&m(n.errors)},"json")}var f=this,g=f.$aside.find(".js-add-user-wrapper"),k=g.find(".js-add-contact");
k.on("click",function(l){l.preventDefault();c(d(this),!0)});g.on("click",".js-close-add-contact",function(l){l.preventDefault();c(d(this))});(function(){function l(m,n){var p=f.$aside.find('.c-contact[data-id="'+m+'"]');p.length&&h(p);e(m,function(q){q=d(q);n.before(q);h(q);d(document).trigger("refresh")})}function h(m){m.addClass("is-highlight");setTimeout(function(){d.each(m,function(n,p){d.contains(document,p)&&d(this).removeClass("is-highlight")})},3E3)}f.$aside.find(".js-contact-autocomplete").each(function(){var m=
d(this);m.autocomplete({appendTo:f.$aside,source:d.crm.app_url+"?module=autocomplete&type=user&funnel_id="+f.funnel_id,minLength:0,html:!0,focus:function(){return!1},select:function(n,p){l(p.item.id,m.closest(".c-add-contact"));m.val("");f.$aside.find(".js-close-add-contact").trigger("click");return!1}}).data("ui-autocomplete")._renderItem=function(n,p){var q=d("<li />");q.addClass("ui-menu-item-html").append("<div>"+p.value+"</div>").appendTo(n);p.rights||(q.addClass("is-locked"),q.on("click",function(r){r.preventDefault();
r.stopPropagation()}));return q};m.on("focus",function(){m.data("uiAutocomplete").search(m.val())})})})()};CRMDeal.prototype.initRemoveFiles=function(){function c(g,k){d.post("?module=file&action=delete",{id:g},function(l){"ok"==l.status?k.remove():console&&console.log&&console.log("File Remove Error")})}var e=this,f;e.$wrapper.find(".c-files-wrapper").on("click",".js-remove-file",function(g){g.preventDefault();var k=d(this).closest(".c-file");g=k.find(".c-name").text();var l=parseInt(k.data("id"));
f&&f.abort();g={title:e.locales.remove_file_title,text:e.locales.remove_file_text.replace(/%s/,g),ok_button:e.locales.remove_file_button};0<l?f=d.post("?module=dialogConfirm",g,function(h){new CRMDialog({html:h,onConfirm:function(){c(l,k)}})}).always(function(){f=!1}):console&&console.log&&console.log("File ID is empty")})};CRMDeal.prototype.initEditableName=function(){var c=this.$wrapper.find(".js-editable").first();if(!(0>=c.length)){var e=d.crm.app_url+"?module=deal&action=rename",f=this.deal_id,
g=null;new CrmEditable({$wrapper:c,onSave:function(k){var l=k.$field.val();if(l.length&&k.text!==l){g&&g.abort();l={id:f,name:l};k.$field.attr("disabled",!0);var h=d('<i class="icon16 loading"></i>').css("margin","0 0 0 4px").insertAfter(k.$field);g=d.post(e,l,function(m){k.$field.attr("disabled",!1);h.remove();k.toggle("hide");m&&m.data&&m.data.deal&&(k.text=m.data.deal.name,k.$wrapper.text(m.data.deal.name),d.crm.title.set(m.data.deal.name))})}else l.length||k.$field.val(k.text),k.toggle("hide")}})}};
CRMDeal.prototype.initChangeDate=function(){function c(n){n?(g.addClass("is-shown"),h.focus()):(g.removeClass("is-shown"),h.datepicker("hide"))}function e(n){h.val()||(n="");d.post("?module=deal&action=changeExpectedDate",{id:f.deal_id,expected_date:n?n:""},function(p){"ok"==p.status&&p.data&&p.data.deal&&((p=p.data.deal.expected_date)?(k.hide(),l.show().find(".js-name").text(p)):(l.hide().find(".js-name").text(""),k.show()),c())},"json")}var f=this,g=f.$wrapper.find(".js-date-toggle");if(!g.length)return!1;
var k=g.find(".js-link"),l=g.find(".js-span"),h=g.find(".js-datepicker"),m=g.find(".js-field");g.on("click",".js-set-date",function(n){n.preventDefault();c(!0)});h.on("keydown keypress keyup",function(n){27===n.keyCode&&c()});g.on("click",".js-close-edit-date",function(){c()});(function(){h.datepicker({altField:m,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,onSelect:function(){var n=h.val(),p=m.val(),q=d.datepicker._defaults.dateFormat,r=!1;try{d.datepicker.parseDate(q,n),r=!0}catch(u){}if(r)e(p);
else return!1}});h.val()||h.datepicker("setDate","+0d")})()};CRMDeal.prototype.initChangePrice=function(){function c(p){p?k.addClass("is-shown"):k.removeClass("is-shown")}function e(p,q){d.post("?module=deal&action=changeAmount",{id:g.deal_id,amount:p?p:"",currency_id:q?q:""},function(r){"ok"==r.status&&r.data&&r.data.deal&&((r=r.data.deal.amount)?(l.hide(),h.show().text(r)):(h.hide().text(""),l.show()),c())},"json")}function f(){var p=m.val(),q=n.val(),r=!1;p&&(r=p.replace(",","."));0<=r?e(p,q):
m.addClass("error")}var g=this,k=g.$wrapper.find(".js-price-toggle");if(!k.length)return!1;var l=k.find(".js-link"),h=k.find(".js-span"),m=k.find(".js-price-field"),n=k.find(".js-currency-field");k.on("click",".js-set-price",function(p){p.preventDefault();c(!0)});k.on("click",".js-save-price",function(p){p.preventDefault();f()});k.on("click",".js-cancel",function(p){p.preventDefault();c()});m.on("focus",function(){m.hasClass("error")&&m.removeClass("error")});m.on("keydown",function(p){13===p.keyCode&&
(p.preventDefault(),f())})};CRMDeal.prototype.initChangeField=function(){function c(h,m){var n=d(h).parents(".js-field-toggle");m?(n.find(".c-hidden").css({height:d(h).height()+8}),d(h).closest(".js-field-toggle").hasClass("js-textarea")?(n.addClass("is-shown").find(".c-hidden").css("width","100%"),n.find("textarea").slideDown().next().find(".icon16").removeClass("loading").addClass("disk"),n.css({width:"100%","margin-left":0}).prev().hide()):(n.addClass("is-shown"),n.find(".js-datepicker-field").focus())):
d(document).trigger("mousedown")}function e(h){var m=k.data("deal-id"),n="",p=d(h).data("field-id"),q=d(h).data("field-type"),r=!1;switch(q){case "checkbox":d(h).prop("required")&&!d(h).prop("checked")?(r=!0,d(h).addClass("error")):n=Number(d(h).prop("checked"));break;case "date":var u=d(h).siblings(".js-datepicker-field"),v=d.datepicker._defaults.dateFormat,t=!1;try{d.datepicker.parseDate(v,u.val()),t=!0}catch(x){}""!=u.val()&&""!=u.val().trim()&&t||!d(h).prop("required")?n=u.val():(r=!0,u.addClass("error"));
break;case "text":u=d(h).parents(".c-hidden").find(".js-field-value-text");u.next().find(".icon16").removeClass("disk").addClass("loading");""!=u.val()&&""!=u.val().trim()||!u.prop("required")?n=u.val():(r=!0,d(h).parents(".c-hidden").find(".js-field-value-text").addClass("error"));break;case "select":var w=d(h).val();t=!1;d(h).find("option").each(function(x,y){d(y).val()==w&&(t=!0)});!t||""==w&&d(h).prop("required")?(r=!0,d(h).addClass("error")):n=w;break;case "radio":n=d(h).find(":checked").val();
break;case "number":w=d(h).val().replace(",",".");(""==w||isNaN(Number(w)))&&d(h).prop("required")?(r=!0,d(h).addClass("error")):n=w;break;default:w=d(h).val(),""!=w&&""!=w.trim()||!d(h).prop("required")?n=w:(r=!0,d(h).addClass("error"))}r||f(h,{id:m,field_id:p,value:n,value_type:q})}function f(h,m){d.post("?module=deal&action=changeValue",m,function(n){if("ok"==n.status){if(n.data&&n.data.deal_params){n=n.data.deal_params.value;var p=d(h).parents(".js-field-toggle").find(".js-output-value");n?(p.text(n),
d(h).removeClass("error")):(p.text(p.data("empty-text")),d(h).siblings(".js-datepicker-field").datepicker("hide"));c(h,!1)}}else d(h).addClass("error")},"json")}var g=this.$wrapper.find(".js-field-toggle"),k=d(".c-deal-options-section");if(!g.length)return!1;var l=g.find(".js-field-value");g.on("click",".js-output-value",function(h){h.preventDefault();c(this,!0)});g.on("click",".js-save-field",function(h){h.preventDefault();e(this)});g.on("click",".js-cancel",function(h){h.preventDefault();d(document).trigger("mousedown")});
g.on("click",".js-field-value-checkbox",function(){e(this)});g.on("change",".js-field-value-select",function(h){h.preventDefault();e(this)});g.on("click",".js-field-value-radio-block input",function(){e(d(this).closest(".js-field-value-radio-block"))});g.on("click",".js-field-value-radio-block .js-clear-link",function(h){h.preventDefault();h=d(this).closest(".js-field-value-radio-block");h.find(":checked").attr("checked",!1);e(h)});l.on("focus",function(){l.hasClass("error")&&l.removeClass("error")});
d(document).on("mousedown",function(h){0!==g.has(h.target).length||g.is(h.target)||g.each(function(m,n){var p=d(n);m=p.find("textarea");p.hasClass("js-textarea")?m.slideUp(function(){p.removeClass("is-shown").removeAttr("style").prev().show()}):p.removeClass("is-shown")})});l.on("keydown",function(h){13===h.keyCode&&(h.preventDefault(),d(this).hasClass("js-datepicker-field")?e(d(this).siblings(".js-field-value")):e(this))});(function(){var h=k.find(".js-datepicker-field"),m=h.siblings(".js-field-value");
h.datepicker({altField:m,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,onSelect:function(){var n=d(this).siblings(".js-field-value");e(n)}})})()};CRMDeal.prototype.initWYSIWYG=function(){var c=this.$wrapper.find(".js-wysiwyg");if(!c.length)return!1;d.crm.initWYSIWYG(c,{keydownCallback:function(e){}})};CRMDeal.prototype.initChangeDescription=function(){function c(l){l?g.addClass("is-shown"):g.removeClass("is-shown")}function e(l){d.post("?module=deal&action=changeDescription",l,function(h){if("ok"==
h.status){if(h.data&&h.data.deal_description){h=h.data.deal_description.value;var m=g.find(".js-output-value");h?(m.find(".c-description").html(h).show(),m.find(".js-add-description").hide()):(m.find(".js-add-description").show(),m.find(".c-description").html("").hide());c(!1)}}else d(f).addClass("error")},"json")}var f=this,g=f.$wrapper.find(".c-description-section .js-description-toggle");if(!g.length)return!1;var k=g.find(".js-field-value");g.on("click",".js-add-description, .js-edit-description",
function(l){l.preventDefault();c(!0)});g.on("hover",".c-description-wrapper",function(){""!=g.find(".c-description").html()&&g.find(".js-edit-description").css("visibility","visible")});g.on("mouseleave",".c-description-wrapper",function(){g.find(".js-edit-description").css("visibility","hidden")});g.on("click",".js-save-description",function(l){l.preventDefault();l=g.find('input[name="data[deal_id]"]').val();var h=g.find(".js-description-value").val();e({id:l,value:h})});g.on("click",".js-cancel",
function(l){l.preventDefault();c(!1)});k.on("focus",function(){k.hasClass("error")&&k.removeClass("error")})};CRMDeal.prototype.initChangeUser=function(){function c(h){if(!h.length)return!1;var m=h.closest(".c-contact");h.autocomplete({appendTo:m,source:"?module=autocomplete&type=user&funnel_id="+k.funnel_id,minLength:0,html:!0,focus:function(){return!1},select:function(n,p){e(p.item.id,m);h.val("");return!1}}).data("ui-autocomplete")._renderItem=function(n,p){var q=d("<li />");q.addClass("ui-menu-item-html").append("<div>"+
p.value+"</div>").appendTo(n);p.rights||(q.addClass("is-locked"),q.on("click",function(r){r.preventDefault();r.stopPropagation()}));return q};h.on("focus",function(){h.data("uiAutocomplete").search(h.val())})}function e(h,m){l?g(m):f(h,function(){l=!0;d.post("?module=deal&action=changeUser",{id:k.deal_id,user_contact_id:h},function(n){if("ok"!==n.status)n.errors?console.error(n.errors):console.error(n),d.crm.alert.show({title:"Error",button:"Error"});else if(n.data=n.data||{},n.data.deal_access_denied)window.location.href=
d.crm.app_url+"deal/";else if(n.data.html){n=d(n.data.html);var p=k.$aside.find('.c-users-section .c-contact[data-id="'+h+'"]').not(m);p.length&&p.remove();m.replaceWith(n);c(n.find(".js-owner-autocomplete"))}},"json").always(function(){l=!1})})}function f(h,m){d.post("?module=deal&action=changeUserConfirm",{id:k.deal_id,user_contact_id:h},"json").done(function(n){n.data&&n.data.need_confirm?new CRMDialog({html:n.data.html||"",onOpen:function(p,q){p.find(".js-confirm-button").on("click",function(){m()})}}):
m()})}function g(h,m){m?h.addClass("is-edit"):h.removeClass("is-edit")}var k=this,l=!1;k.$aside.on("click",".js-show-combobox",function(h){h.preventDefault();h=d(this).closest(".c-contact");g(h,!0)});k.$aside.on("click",".js-hide-combobox",function(h){h.preventDefault();h=d(this).closest(".c-contact");g(h)});k.$aside.find(".js-owner-autocomplete").each(function(){c(d(this))});(function(){function h(q){n||f(q,function(){n=!0;d.post("?module=deal&action=changeUser",{id:k.deal_id,user_contact_id:q},
function(r){if("ok"===r.status)if(r.data.deal_access_denied)window.location.href=d.crm.app_url+"deal/";else{r=d(r.data.html);var u=k.$aside.find('.c-users-section .c-contact[data-id="'+k.user_id+'"]');u.length&&u.remove();k.$aside.find('.c-contact[data-id="'+r.data("id")+'"]').remove();p.after(r).css("display","none");k.$aside.find(".js-add-user-wrapper").show();c(r.find(".js-owner-autocomplete"))}},"json").always(function(){n=!1})})}function m(q){q?p.addClass("is-extended"):p.removeClass("is-extended")}
var n=!1,p=k.$aside.find(".js-empty-user-wrapper");p.on("click",".js-set-user-me",function(q){q.preventDefault();h(k.user_id)});p.on("click",".js-set-extended",function(q){q.preventDefault();m(!0)});p.on("click",".js-unset-extended",function(q){q.preventDefault();m(!1)});(function(){p.find(".js-empty-user-autocomplete").each(function(){var q=d(this);q.autocomplete({appendTo:p,source:"?module=autocomplete&type=user&funnel_id="+k.funnel_id,minLength:0,html:!0,focus:function(){return!1},select:function(r,
u){h(u.item.id);q.val("");return!1}}).data("ui-autocomplete")._renderItem=function(r,u){var v=d("<li />");v.addClass("ui-menu-item-html").append("<div>"+u.value+"</div>").appendTo(r);u.rights||(v.addClass("is-locked"),v.on("click",function(t){t.preventDefault();t.stopPropagation()}));return v};q.on("focus",function(){q.data("uiAutocomplete").search(q.val())})})})()})()};CRMDeal.prototype.initChangeClient=function(){function c(l,h,m){g||(g=!0,d.post("?module=deal&action=changeClient",{deal_id:e.deal_id,
client_type:m,contact_id:h},function(n){const p=new CRMDialog({html:n,options:{onChange:function(q){1===p.$block.find(".js-view-toggle > .is-active").data("id")?l.replaceWith(q):(l.replaceWith(q.html),(parseInt(e.deal.contact_id)||0)===h&&q.contact.id!==h&&(e.deal.contact_id=q.contact.id));l.find(".js-add-company-contact").show();d(document).trigger("refresh")}}})}).always(function(){g=!1}))}var e=this,f=e.$wrapper.find(".js-contacts-section"),g=!1;f.on("click",".js-edit-company-owner",function(l){l.preventDefault();
l=d(this).closest(".c-contact");var h=l.data("type"),m=l.data("id");c(l,m,h)});var k=f.find(".js-empty-contact-wrapper");if(k.length)k.on("click",".js-set-company-owner",function(l){l.preventDefault();c(k,"","contact_owner")})};CRMDeal.prototype.initDealDelete=function(){function c(){f||(f=!0,d.post(d.crm.app_url+"?module=deal&action=delete",{id:e.deal_id},function(g){"ok"===g.status&&d.crm.content.load(d.crm.app_url+"deal/")},"json").always(function(){f=!1}))}var e=this,f=!1;e.$wrapper.on("click",
".js-deal-delete",function(g){g.preventDefault();d.crm.confirm.show({title:e.locales.delete_deal_title,text:e.locales.delete_deal_text,button:e.locales.delete_deal_button,onConfirm:c})})};CRMDeal.prototype.initCall=function(){var c=this,e=!1;c.$wrapper.on("click",".js-show-call-dialog",function(f){f.preventDefault();var g=d(this);f=g.data("id");g=g.data("phone");!e&&f&&g&&(e=!0,d.post("?module=call&action=initContactDialog",{deal_id:c.deal_id,contact_id:f,phone:g},function(k){new CRMDialog({remain_after_load:!0,
html:k})}).always(function(){e=!1}))})};CRMDeal.prototype.initOrderSection=function(){var c=this.$wrapper.find(".c-order-section"),e=c.find(".c-order-details"),f=c.find(".c-products-wrapper");e.on("click",".js-details-toggle",function(g){g.preventDefault();g=d(this).find(".icon16");e.hasClass("is-extended")?(g.removeClass("darr").addClass("rarr"),e.removeClass("is-extended")):(g.removeClass("rarr").addClass("darr"),e.addClass("is-extended"));d(document).trigger("refresh")});f.on("click",".js-products-toggle",
function(g){g.preventDefault();g=d(this).find(".icon16");f.hasClass("is-extended")?(g.removeClass("darr").addClass("rarr"),f.removeClass("is-extended")):(g.removeClass("rarr").addClass("darr"),f.addClass("is-extended"));d(document).trigger("refresh")})};CRMDeal.prototype.initMessages=function(){this.initSendEmail();this.initSendSMS()};CRMDeal.prototype.initSendEmail=function(){var c=this,e=!1;c.$wrapper.on("click",".js-show-message-dialog",function(f){f.preventDefault();var g=d(this);f=g.data("id");
g=g.data("email");!e&&f&&(e=!0,d.post("?module=message&action=writeDealDialog",{deal_id:c.deal_id,contact_id:f,email:g},function(k){new CRMDialog({html:k})}).always(function(){e=!1}))})};CRMDeal.prototype.initSendSMS=function(){var c=this,e=!1;c.$wrapper.on("click",".js-show-send-sms-dialog",function(f){f.preventDefault();var g=d(this);f=g.data("id");g=g.data("phone");!e&&f&&(e=!0,d.get("?module=message&action=writeSMSDealDialog",{deal_id:c.deal_id,contact_id:f,phone:g},function(k){new CRMDialog({html:k})}).always(function(){e=
!1}))})};CRMDeal.prototype.addExternalContact=function(c){d.get(d.crm.app_url+"?module=deal&action=addParticipant",{id:this.deal_id},function(e){new CRMDialog({html:e,options:{onAdd:function(f){c.closest(".c-add-contact").before(f);d(document).trigger("refresh")}}})})};CRMDeal.prototype.removeOwner=function(c){function e(l,h){l={owner_id:l,deal_id:h};var m=d(".js-empty-user-wrapper");f.remove_is_locked=!0;d.post("?module=deal&action=ownerDelete",l,function(n){"ok"==n.status&&(c.remove(),m.fadeIn())},
"json").always(function(){f.remove_is_locked=!1})}var f=this,g=c.data("id"),k=d.trim(c.find(".c-name").html());d.crm.confirm.show({title:f.locales.remove_owner_title,text:f.locales.remove_owner_text.replace(/%s/,k),button:f.locales.remove_owner_button,onConfirm:function(){e(g,f.deal_id)}})};CRMDeal.prototype.removeContact=function(c){function e(l,h,m){l={contact_id:l,deal_id:h,role_id:m};f.remove_is_locked=!0;d.post("?module=deal&action=contactDelete",l,function(n){"ok"==n.status&&c.remove()},"json").always(function(){f.remove_is_locked=
!1})}var f=this,g=c.data("id"),k=d.trim(c.find(".c-name").html());d.crm.confirm.show({title:f.locales.remove_contact_title,text:f.locales.remove_contact_text.replace(/%s/,k),button:f.locales.remove_contact_button,onConfirm:function(){e(g,f.deal_id,c.data("role-id"))}})};CRMDeal.prototype.initAssignTags=function(){var c=this.$wrapper.find(".js-assign-tags"),e=d.crm.app_url+"?module=dealOperation&action=assignTags&is_assign=1",f=parseInt(this.deal_id)||0;c.click(function(g){g.preventDefault();d.get(e,
{deal_ids:[f]},function(k){new CRMDialog({html:k})})})};CRMDeal.prototype.initOrderEditShippingDetailLink=function(){var c=this;c.$wrapper.find(".js-order-edit-shipping-details-link").click(function(){var e=d(this).parent().find(".js-order-edit-shipping-details-loading");e.show();c.loadEditOrderShippingDetailsDialog(c.order_id,{onLoad:function(){e.hide()}})})};CRMDeal.prototype.initCreateOrderLink=function(){var c=this;c.$wrapper.on("click",".js-create-order-link",function(e){e.preventDefault();if(c.shop_in_welcome_stage)d.crm.alert.show({title:c.locales.shop_alert_title||
"",text:c.locales.shop_in_welcome_stage||""});else{var f=d(this);f.addClass("is-loading");c.loadEditOrderDialog(0,{onLoad:function(){f.removeClass("is-loading")}})}})};CRMDeal.prototype.initEditOrderLink=function(){var c=this;c.$wrapper.on("click",".js-edit-order-link",function(e){e.preventDefault();if(c.shop_in_welcome_stage)d.crm.alert.show({title:c.locales.shop_alert_title||"",text:c.locales.shop_in_welcome_stage||""});else{var f=d(this);f.addClass("is-loading");c.loadEditOrderDialog(c.order_id,
{onLoad:function(){f.removeClass("is-loading")}})}})};CRMDeal.prototype.loadEditOrderDialog=function(c,e){var f=this.deal||{},g=d(this.templates.create_order_dialog_html),k=e.onLoad||function(){};g.hide();new CRMDialog({html:g,onOpen:function(){var l=this,h=d.crm.backend_url+"shop/?module=order&action=embededit",m=g.find(".crm-dialog-content");0<f.contact_id&&(h+="&customer_id="+f.contact_id);0<c&&(h+="&id="+c);m.html('<iframe src="'+h+'" class="c-content-iframe">');var n=m.find("iframe");n.one("load",
function(){k();l.show();l.resize();var p=n.get(0);d(p.contentWindow.document).find("#order-edit-form").append('<input type="hidden" name="crm_deal[id]" value="'+f.id+'">');p.contentWindow.$.order_edit.container.on("order_edit_save_success",function(){l.close();d.crm.content.reload()})})}})};CRMDeal.prototype.loadEditOrderShippingDetailsDialog=function(c,e){if(0>=c)console.error("Invalid input parameter");else{var f=this.$wrapper.find(".js-deal-edit-order-shipping-details-dialog").clone(),g=e.onLoad||
function(){};f.hide();new CRMDialog({html:f,onOpen:function(){var k=this,l=d.crm.backend_url+"shop/?module=workflow&action=prepare",h=f.find(".crm-dialog-content");d.post(l,{action_id:"editshippingdetails",id:c},function(m){h.html(m);h.find(".js-form-footer-actions").hide();k.show();k.resize();m=h.find("#wf-ship-form").height();f.find(".crm-dialog-block").height(m+150);var n=f.find(".js-submit-dialog-loading"),p=h.find(".js-form-footer-actions .js-submit-button");f.find(".js-submit-dialog-button").on("click",
function(q){q.preventDefault();if(p.is(":disabled"))return!1;h.bind("formSend",function(){n.hide();k.close();d.crm.content.reload()});n.show();p.trigger("click")});g&&g()})}})}};return CRMDeal}(jQuery),CRMDealChangeWorkflowDialog=function(d){CRMDealChangeWorkflowDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form").first();this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMDealChangeWorkflowDialog.prototype.initClass=function(){var a=this;a.$wrapper.find(".js-form-footer-actions").hide();
a.$wrapper.on("click",".js-submit-dialog-button",function(){a.$form.find(".js-submit-button").trigger("click")});a.$form.on("formSend",function(){if(a.dialog.options&&a.dialog.options.onShopSubmit)a.dialog.options.onShopSubmit();a.dialog.close()})};return CRMDealChangeWorkflowDialog}(jQuery);var CRMDealCloseDialog=function(d){CRMDealCloseDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$reasonSelect=this.$wrapper.find(".js-reason-select");this.$reasonFieldW=this.$wrapper.find(".js-reason-text");this.dialog=this.$wrapper.data("dialog");this.deal_id=a.deal_id;this.reason_require=a.reason_require;this.is_locked=!1;this.initClass()};CRMDealCloseDialog.prototype.initClass=function(){var a=this;a.$wrapper.on("click",".js-set-won",function(b){b.preventDefault();
a.setWon()});a.$wrapper.on("click",".js-show-form",function(b){b.preventDefault();a.showLostForm()});a.$wrapper.on("click",".js-set-lost",function(b){b.preventDefault();a.$form.trigger("submit")});a.$form.on("submit",function(b){b.preventDefault();a.setLost()});a.$reasonSelect.on("change",function(){d(this).val()?a.$reasonFieldW.hide():a.$reasonFieldW.show()})};CRMDealCloseDialog.prototype.showLostForm=function(a){var b=this.$wrapper.find(".c-visible"),c=this.$wrapper.find(".c-hidden");a?(b.show(),
c.hide()):(b.hide(),c.show());this.dialog.resize()};CRMDealCloseDialog.prototype.setWon=function(){var a=this;if(!a.is_locked){a.is_locked=!0;var b={id:a.deal_id,action:"WON"};d.post("?module=deal&action=close",b,function(c){"ok"===c.status&&a.afterRequest("?module=deal&action=close",b,c)}).always(function(){a.is_locked=!1})}};CRMDealCloseDialog.prototype.setLost=function(){function a(){var e=b.$form.serializeArray();e.push({name:"id",value:b.deal_id});e.push({name:"action",value:"LOST"});if(b.reason_require&&
!b.$reasonSelect.val())if(b.$reasonFieldW.is(":visible")){var f=b.$reasonFieldW.find("input");f.val()||(f.addClass("error").one("focus",function(){d(this).removeClass("error")}),e=!1)}else b.$reasonSelect.addClass("error").one("change",function(){d(this).removeClass("error")}),e=!1;return e}var b=this;if(!b.is_locked){b.is_locked=!0;var c=a();c?d.post("?module=deal&action=close",c,function(e){"ok"===e.status&&b.afterRequest("?module=deal&action=close",c,e)}).always(function(){b.is_locked=!1}):b.is_locked=
!1}};CRMDealCloseDialog.prototype.afterRequest=function(a,b,c){function e(){f.dialog.close();d.crm.content.reload()}var f=this;c.data.dialog_html&&c.data.dialog_html.html?new CRMDialog({html:c.data.dialog_html.html,onOpen:function(g){var k=g.find("form");k.length&&!d.isEmptyObject(b)&&d.each(b,function(l,h){k.append('<input type="hidden" name="crm_change_workflow_data['+h.name+']" value="'+h.value+'">')})},options:{onShopSubmit:e},onConfirm:function(){b.push({name:"force_execute",value:1});d.post(a,
b,e)}}):e()};return CRMDealCloseDialog}(jQuery);var CRMDealEdit=function(d){CRMDealEdit=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("#js-deal-edit-form");this.$deal_name_input=this.$form.find('[name="deal[name]"]');this.deal_id=a.deal_id;this.locales=a.locales;this.urls=a.urls;this.can_edit_contact=a.can_edit_contact||!1;this.suggester_values={};this.contact_mode=a.contact_mode||"edit";this.initClass()};CRMDealEdit.prototype.initClass=function(){this.initChangeCompanyContact();this.initEstimatedDate();this.initSuggestName();
this.initChangeFunnel();this.initWYSIWYG();this.initFieldsBlock();this.initSave();this.initCombobox()};CRMDealEdit.prototype.initEstimatedDate=function(){function a(){var f=d.datepicker._defaults.dateFormat,g=!1;try{d.datepicker.parseDate(f,c.val()),g=!0}catch(k){}g?(c.data("last-correct-value",c.val()),e.data("last-correct-value",e.val())):(c.val(c.data("last-correct-value")||""),e.val(e.data("last-correct-value")||""))}var b=this.$wrapper.find(".c-estimated-close-date-field").find(".js-datepicker-wrapper"),
c=b.find(".js-datepicker"),e=b.find('[name="deal[expected_date]"]');c.datepicker({altField:e,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,onSelect:a});c.on("blur",a);c.on("keydown keypress keyup",function(f){13===f.which&&f.preventDefault()});c.on("click",".js-icon",function(){c.focus()})};CRMDealEdit.prototype.initSave=function(){function a(){for(var n={data:[],errors:[]},p=k.serializeArray(),q=0;q<p.length-1;q++)for(var r=q+1;r<p.length;r++)p[q].name==p[r].name&&(""==p[q].value?p.splice(q,
1):""==p[r].value&&p.splice(r,1));d.each(p,function(u,v){u=d('[name="'+v.name+'"]');var t=0<d('[name="'+v.name+'"][type="radio"]').length,w=""==v.value||""==v.value.trim();1==d(u).prop("required")&&w&&n.errors.push({name:v.name,value:g.locales.bad_amount,is_radio:t});"deal[amount]"===v.name&&(v.value.length&&(v.value=d.trim(v.value)),t=v.value,u=!1,t.length&&(t=t.replace(",","."),0<t||"0"===t)&&(u=!0),u||n.errors.push({name:v.name,value:g.locales.bad_amount}));n.data.push(v)});"edit"===g.contact_mode?
g.can_edit_contact&&e(n):f(n);return n}function b(n){n&&n[0]||(n=[]);d.each(n,function(p,q){p=q.name;var r=q.value;if(q=q.is_radio)var u=g.$wrapper.find('[name="'+p+"\"][type='hidden']"),v=g.$wrapper.find('[name="'+p+"\"][type='radio']");else u=g.$wrapper.find('[name="'+p+'"]');"contact[firstname]"!==p||u.is(":visible")||(u=g.$wrapper.find(".js-contact-autocomplete"));var t=d("<span class='c-error' />").addClass("errormsg").text(r);if(u.length&&!u.hasClass("error"))if(u.parent().append(t),u.addClass("error"),
q)v.one("focus click change",function(){u.removeClass("error");t.remove()});else u.one("focus click change",function(){u.removeClass("error");t.remove()});else l.append(t),k.one("submit",function(){t.remove()})})}function c(n){if(!m){m=!0;var p=d.crm.app_url+"?module=deal&action=save";h.attr("disabled","disabled").prop("disabled",!0);var q=g.$wrapper.find(".loading");q.show();d.post(p,n,function(r){"ok"===r.status?d.crm.content.load(d.crm.app_url+"deal/"+r.data.deal.id+"/"):r.errors&&b(r.errors)},
"json").always(function(){q.hide();m=!1;h.removeAttr("disabled").prop("disabled",!1)})}}function e(n){var p=g.$wrapper.find("#c-contact-edit-form").closest("form"),q=p.find(".js-phone-list"),r=p.find(".js-email-list");p=p.serializeArray();var u=["contact[firstname]","contact[middlename]","contact[lastname]","contact[name]"],v=!0;d.each(p,function(t,w){n.data.push({name:w.name,value:w.value});0<d.trim(w.value).length&&0<=u.indexOf(w.name)&&(v=!1)});v&&(n.errors.push({name:"contact[firstname]",value:g.locales.empty_name}),
n.errors.push({name:"contact[name]",value:g.locales.empty_name}));q.find("li").each(function(t){var w=d(this),x=w.find(".js-value");w=w.find(".js-ext");var y=x.val(),z=w.val();if(y){var B="contact[phone]["+t+"][value]";x.attr("name",B);n.data.push({name:B,value:y});t="contact[phone]["+t+"][ext]";w.attr("name",t);n.data.push({name:t,value:z})}});r.find("li").each(function(t){var w=d(this),x=w.find(".js-value");w=w.find(".js-ext");var y=x.val(),z=w.val();if(y){var B="contact[email]["+t+"][value]";x.attr("name",
B);n.data.push({name:B,value:y});t="contact[email]["+t+"][ext]";w.attr("name",t);n.data.push({name:t,value:z})}});return n}function f(n){var p=g.$wrapper.find("#c-contact-add-form").closest("form").serializeArray(),q=!1,r=!1;d.each(p,function(u,v){u=v.name;var t=v.value;"deal[contact_id]"===u&&t&&(q=!0);"contact[firstname]"===u&&t&&(r=!0);"contact[lastname]"===u&&t&&(r=!0);"contact[middlename]"===u&&t&&(r=!0);"contact[name]"===u&&t&&(r=!0);n.data.push(v)});q||r||(n.errors.push({name:"contact[name]",
value:g.locales.empty_name}),n.errors.push({name:"contact[firstname]",value:g.locales.empty_name}))}var g=this,k=g.$form,l=g.$form.find(".js-errors-place"),h=g.$wrapper.find(".js-submit-button"),m=!1;h.on("click",function(){k.trigger("submit")});k.on("submit",function(n){n.preventDefault();n=a();n.errors.length?b(n.errors):c(n.data)})};CRMDealEdit.prototype.initSuggestName=function(){var a=this,b=a.$form,c=a.$deal_name_input;if(!c.data("edited")){c.one("mark-edited.crm-deal-suggestion",function(){c.data("edited",
1);c.off(".crm-deal-suggestion");b.off(".crm-deal-suggestion",".js-crm-deal-name-suggester-input")});c.on("keyup.crm-deal-suggestion",function(){var k=d(this);0<d.trim(k.val()).length&&k.trigger("mark-edited")});var e=null,f=null,g=function(){e&&(e.abort(),e=null);c.data("edited")||(e=d.post(d.crm.app_url+"?module=deal&action=suggestName",a.suggester_values,function(k){"ok"!==k.status||c.data("edited")||c.val(d.trim(k.data&&k.data.name)||"")}))};b.on("keyup.crm-deal-suggestion change.crm-deal-suggestion",
".js-crm-deal-name-suggester-input",function(k){var l=d(this);f&&clearTimeout(f);f=setTimeout(function(){if(l.hasClass("crm-find-contact-input")){if("keyup"===k.type)return;l=b.find('[name="deal[id]"]')}var h=l.attr("name")||"",m=d.trim(l.val());if(h){a.suggester_values[h]=d.trim(a.suggester_values[h]);if(a.suggester_values[h]===m)return;a.suggester_values[h]=m}g()},250)})}};CRMDealEdit.prototype.initChangeCompanyContact=function(){var a=this,b=a.$wrapper.find(".js-contact-block"),c=b.find(".js-view-toggle"),
e=c.find(".is-active");c.on("click",".c-toggle",function(f){f.preventDefault();f=d(this);var g=f.data("id");if(f.hasClass("is-active"))return!1;a.contact_mode=g;e.length&&e.removeClass("is-active");f.addClass("is-active");e=f;b.find(".c-hidden.is-active").removeClass("is-active");b.find(".c-hidden-"+g).addClass("is-active")})};CRMDealEdit.prototype.initChangeFunnel=function(){var a=this;a.$form.on("change",".js-select-deal-funnel",function(){a.$form.find(".js-select-stage-wrapper").load("?module=deal&action=stagesByFunnel&id="+
d(this).val())})};CRMDealEdit.prototype.initWYSIWYG=function(){var a=this.$wrapper.find(".js-wysiwyg");if(!a.length)return!1;d.crm.initWYSIWYG(a,{keydownCallback:function(b){}})};CRMDealEdit.prototype.initFieldsBlock=function(){var a=this.$wrapper.find(".js-ext-fields-section");a.on("click",".js-ext-fields-toggle",function(){a.toggleClass("is-extended");d(".js-show-fields-button, .js-hide-fields-button").removeAttr("style")})};CRMDealEdit.prototype.initCombobox=function(){function a(f){f?c.addClass("is-shown"):
c.removeClass("is-shown")}var b=this,c=b.$form.find(".js-contact-owner-wrapper"),e=c.find(".js-field");c.on("click",".js-show-combobox",function(f){f.stopPropagation();a(!0)});c.on("click",".js-hide-combobox",function(f){f.stopPropagation();a(!1)});(function(){var f=c.find(".js-autocomplete");f.autocomplete({appendTo:c,position:{my:"right top",at:"right bottom"},source:b.urls.owner_autocomplete,minLength:0,html:!0,focus:function(){return!1},select:function(g,k){g=k.item;k=c.find(".js-user");g.photo_url&&
k.find(".userpic20").css("background-image","url("+g.photo_url+")");k.find(".c-name").text(g.name);e.val(g.id);a(!1);f.val("");return!1}}).data("ui-autocomplete")._renderItem=function(g,k){return d("<li />").addClass("ui-menu-item-html").append("<div>"+k.value+"</div>").appendTo(g)};f.on("focus",function(){f.data("uiAutocomplete").search(f.val())})})()};return CRMDealEdit}(jQuery);var CRMDealChangeClient=function(d){CRMDealChangeClient=function(a){this.$wrapper=a.$wrapper;this.dialog=this.$wrapper.data("dialog");this.deal_id=a.deal_id;this.contact_id=a.contact_id;this.type=a.type;this.can_edit_contact=a.can_edit_contact||!1;this.initClass()};CRMDealChangeClient.prototype.initClass=function(){this.initViewToggle();this.can_edit_contact&&this.initContactChangeData();this.initSwitchContact()};CRMDealChangeClient.prototype.initViewToggle=function(){var a=this,b=a.$wrapper.find(".js-view-toggle"),
c=b.find(".is-active");b.on("click",".c-toggle",function(e){e.preventDefault();e=d(this);var f=e.data("id");if(e.hasClass("is-active"))return!1;c.length&&c.removeClass("is-active");e.addClass("is-active");c=e;a.$wrapper.find(".c-hidden.is-active").removeClass("is-active");a.$wrapper.find(".c-hidden-"+f).addClass("is-active");a.dialog.resize()})};CRMDealChangeClient.prototype.initContactChangeData=function(){function a(){var m=g.serializeArray(),n={data:[],errors:[]},p=["contact[firstname]","contact[middlename]",
"contact[lastname]","contact[name]"],q=!0;d.each(m,function(r,u){n.data.push({name:u.name,value:u.value});0<d.trim(u.value).length&&0<=p.indexOf(u.name)&&(q=!1)});q&&(n.errors.push({name:"contact[firstname]",value:"Name is empty"}),n.errors.push({name:"contact[name]",value:"Name is empty"}));l.find("li").each(function(r){var u=d(this),v=u.find(".js-value");u=u.find(".js-ext");var t=v.val(),w=u.val();if(t){var x="contact[phone]["+r+"][value]";v.attr("name",x);n.data.push({name:x,value:t});r="contact[phone]["+
r+"][ext]";u.attr("name",r);n.data.push({name:r,value:w})}});h.find("li").each(function(r){var u=d(this),v=u.find(".js-value");u=u.find(".js-ext");var t=v.val(),w=u.val();if(t){var x="contact[email]["+r+"][value]";v.attr("name",x);n.data.push({name:x,value:t});r="contact[email]["+r+"][ext]";u.attr("name",r);n.data.push({name:r,value:w})}});n.data.push({name:"deal_id",value:e.deal_id});return n}function b(m){d.post(e.contact_id?"?module=deal&action=contactUpdate":"?module=contact&action=save",m,function(n){"ok"==
n.status?(e.dialog.options.onChange(n.data.html),e.dialog.close()):n.errors&&c(n.errors)},"json").always(function(){k=!1})}function c(m){m=m?m:[];d.each(m,function(n,p){n=p.name;p=p.value;"contact[name]"===n&&(n="contact[firstname]");var q=g.find('[name="'+n+'"]'),r=d("<span />").addClass("errormsg").text(p);q.length?q.hasClass("error")||(q.parent().append(r),q.addClass("error").one("focus click",function(){q.removeClass("error");r.remove()})):(f.append(r),g.one("submit",function(){r.remove()}))})}
var e=this,f=e.$wrapper.find(".js-errors-place"),g=e.$wrapper.find("#c-contact-edit-form").closest("form"),k=!1,l=g.find(".js-phone-list"),h=g.find(".js-email-list");e.$wrapper.on("click",".js-save-changed-data",function(m){m.preventDefault();g.trigger("submit")});g.on("submit",function(m){m.preventDefault();k||(k=!0,m=a(),m.errors.length?(c(m.errors),k=!1):b(m.data))})};CRMDealChangeClient.prototype.initSwitchContact=function(){function a(k){k=k?k:[];d.each(k,function(l,h){l=h.name;h=h.value;"contact[name]"===
l&&(l="contact[firstname]");var m=f.find('[name="'+l+'"]'),n=d("<span />").addClass("errormsg").text(h);m.length?m.hasClass("error")||(m.parent().append(n),m.addClass("error").one("focus click",function(){m.removeClass("error");n.remove()})):(e.append(n),c.$wrapper.one("click",".js-switch-contact",function(){n.remove()}))})}function b(k){g||(g=!0,k.push({name:"deal_id",value:c.deal_id}),d.post("?module=deal&action=personUpdate",k,function(l){"ok"===l.status?(c.dialog.options.onChange(l.data),c.dialog.close()):
l.errors&&a(l.errors)}).always(function(){g=!1}))}var c=this,e=c.$wrapper.find(".js-errors-place"),f=c.$wrapper.find("#c-contact-add-form").closest("form"),g=!1;c.$wrapper.on("click",".js-switch-contact",function(k){k.preventDefault();k=f.serializeArray();var l=[];l.length?a(l):b(k)})};return CRMDealChangeClient}(jQuery);var CRMDealsFunnel=function(d){CRMDealsFunnel=function(a){this.$wrapper=a.$wrapper;this.$header=this.$wrapper.find("#js-funnel-header");this.$actionsHeader=this.$wrapper.find("#js-actions-header");this.$tableContent=this.$wrapper.find(".js-table-content");this.funnel_id=a.funnel_id;this.locales=a.locales;this.selected_deals=[];this.initClass()};CRMDealsFunnel.prototype.initClass=function(){this.initFixedHeader();this.initDealsMove();this.initMassiveActionsHeader();this.initMassActions()};CRMDealsFunnel.prototype.initFixedHeader=
function(){function a(){if(d.contains(document,e[0])){var m=c.scrollTop();k.top<m?g||(g=!0,f=d("<div />"),f.height(h).insertAfter(e),e.width(l).addClass("is-fixed-to-top")):b()}else c.off("scroll",a)}function b(){f&&f.length&&f.remove();f=!1;e.removeAttr("style").removeClass("is-fixed-to-top");l=e.width();h=e.height();g=!1}var c=d(window),e=this.$header,f=!1,g=!1,k=e.offset(),l=e.width(),h=e.height();c.on("scroll",a);c.on("resize",function(){b();c.trigger("scroll")})};CRMDealsFunnel.prototype.initDealsMove=
function(){function a(g,k,l,h){function m(){d.crm.content.reload()}if(!b){b=!0;var n=l.closest(".js-drop-area");e.draggable("disable");l.addClass("is-loading").removeAttr("style").prependTo(h);d.post("?module=deal&action=move",{deal_id:g,stage_id:k},function(p){"ok"===p.status&&(p.data.dialog_html&&p.data.dialog_html.html?new CRMDialog({html:p.data.dialog_html.html,options:{onShopSubmit:m},onCancel:function(){l.removeClass("is-loading").prependTo(n)},onConfirm:function(){d.post("?module=deal&action=move",
{deal_id:g,stage_id:k,force_execute:1},m)}}):m())},"json").always(function(){e.draggable("enable");b=!1})}}var b=!1,c=!1,e=this.$wrapper.find(".c-deal-wrapper"),f=this.$wrapper.find(".js-drop-area");e.draggable({handle:".js-drag-toggle",revert:!0,start:function(){var g=d(this),k=g.closest(".js-drop-area");g.data("stage-index",k.index()).data("stage-id",k.data("id")).draggable("option","revert",!0);c=k.addClass("is-wrapper")}});f.droppable({tolerance:"pointer",drop:function(g,k){g=d(this);k=d(k.draggable);
var l=g.data("id"),h=k.data("stage-id"),m=k.data("id");h!==l&&(k.draggable("option","revert",!1),a(m,l,k,g));c.length&&(c.removeClass("is-wrapper"),c=!1)}})};CRMDealsFunnel.prototype.initMassiveActionsHeader=function(){function a(){if(d.contains(document,f[0]))if(c.selected_deals.length){f.hasClass("is-hidden")&&f.removeClass("is-hidden");var n=e.scrollTop();l.top+m>n+e.height()?k||(k=!0,g=d("<div />"),g.height(m).insertAfter(f),f.width(h).addClass("is-fixed-to-bottom")):b()}else b(),f.hasClass("is-hidden")||
f.addClass("is-hidden");else e.off("scroll",a)}function b(){g&&g.length&&g.remove();g=!1;f.removeAttr("style").removeClass("is-fixed-to-bottom");h=f.width();m=f.height();k=!1}var c=this,e=d(window),f=c.$actionsHeader,g=!1,k=!1,l=f.offset(),h=f.width(),m=f.height();e.on("scroll",a);e.on("resize",function(){b();e.trigger("scroll")})};CRMDealsFunnel.prototype.initMassActions=function(){function a(l){l.find(".js-check-deal").is(":checked")?(l.addClass("is-active"),k.push(l[0])):(l.removeClass("is-active"),
l=k.indexOf(l[0]),k.splice(l,1));b();d(window).trigger("scroll")}function b(){function l(){var p=c("open"),q=f.find(".js-deals-close").closest(".c-action"),r=q.find(".js-open-count");p.length?(r.text(p.length),q.show()):q.hide()}function h(){var p=f.find(".js-deals-merge").closest(".c-action");1<k.length?p.show():p.hide()}function m(){var p=!1;d(k).each(function(){if(d(this).data("can-delete"))return p=!0,!1});var q=f.find(".js-deals-delete").closest(".c-action");p?q.show():q.hide()}var n=k.length;
0<k.length&&(f.find(".js-count").text(n),l(),h(),m())}function c(l){var h=[];d.each(k,function(m,n){m=d(n);n=m.data("id");(!l||m.data(l))&&n&&h.push(n)});return h}var e=this,f=e.$actionsHeader,g=f.find(".js-checkbox-all"),k=e.selected_deals;e.$wrapper.on("click",".js-deal-wrapper",function(l){l=d(l.target);var h=!(!l.is("a")&&!l.closest("a").length);l=l.is(":checkbox");if(!h){h=d(this);var m=h.find(".js-check-deal");l||m.attr("checked",!m.is(":checked"));a(h)}});e.$tableContent.find(".js-state-column").shiftSelectable({selector:".js-deal-wrapper",
onSelect:function(l,h){var m=d(h.target);m=!(!m.is("a")&&!m.closest("a").length);var n=h.extra.is_first;h=h.extra.is_last;m||n||h||(l.find(".js-check-deal").attr("checked",!0),a(l))}});g.on("change",function(){var l=d(this).is(":checked");e.$wrapper.find(".js-deal-wrapper").each(function(){var h=d(this),m=h.find(".js-check-deal");m.is(":checked")!==l&&(m.attr("checked",l),a(h))})});f.on("click",".js-deals-merge",function(l){l.preventDefault();l=c();l=d.crm.app_url+"deal/merge/?ids="+l.join(",");d.crm.content.load(l)});
(function(){var l=!1;f.on("click",".js-deals-delete",function(h){h.preventDefault();d.crm.confirm.show({title:e.locales.delete_confirm_title.replace("%s",k.length),text:e.locales.delete_confirm_text,button:e.locales.delete_confirm_button,onConfirm:function(m){function n(){var u=[],v=c();d.each(v,function(t,w){u.push({name:"id[]",value:w})});return u}function p(){var u=k.map(function(v){return v});d.each(u,function(v,t){v=d(t);v.find(".js-check-deal").attr("checked",!1).trigger("change");v.remove()})}
if(!l){l=!0;var q=d.crm.app_url+"?module=deal&action=delete",r=n();d.post(q,r,function(u){"ok"===u.status&&(p(),m.close(),d.crm.content.reload(),d.crm.sidebar.reload())}).always(function(){l=!1})}return!1}})})})();(function(){var l=!1;f.on("click",".js-deals-change-responsible",function(h){h.preventDefault();l||(l=!0,h={ids:c().join(",")},d.post("?module=deal&action=changeResponsible",h,function(m){new CRMDialog({html:m})}).always(function(){l=!1}))})})();(function(){var l=!1;f.on("click",".js-deals-close",
function(h){h.preventDefault();l||(l=!0,h={ids:c("open").join(",")},d.post("?module=deal&action=massClose",h,function(m){new CRMDialog({html:m})}).always(function(){l=!1}))})})();(function(){var l=!1;f.on("click",".js-deals-change-funnel",function(h){h.preventDefault();l||(l=!0,h={deal_ids:c().join(",")},d.post("?module=deal&action=changeFunnel",h,function(m){new CRMDialog({html:m})}).always(function(){l=!1}))})})();(function(){var l=!1;f.on("click",".js-deals-export",function(h){h.preventDefault();
l||(l=!0,h=c(),d.post(d.crm.app_url+"?module=deal&action=export",{ids:h},function(m){new CRMDialog({html:m})}).always(function(){l=!1}))})})();(function(){var l=!1;f.on("click",".js-deals-set-tags",function(h){h.preventDefault();if(!l){l=!0;h=c();var m=d.crm.app_url+"?module=dealOperation&action=assignTags",n={deal_ids:h};1===h.length&&(n.is_assign=1);d.post(m,n,function(p){new CRMDialog({html:p})}).always(function(){l=!1})}})})()};return CRMDealsFunnel}(jQuery),CRMDealsList=function(d){CRMDealsList=
function(a){this.$wrapper=a.$wrapper;this.$tableWrapper=this.$wrapper.find(".js-deals-table-wrapper");this.$tableHeaderW=this.$wrapper.find(".js-table-header-wrapper");this.$tableHeader=this.$wrapper.find(".js-table-header");this.$tableActions=this.$wrapper.find(".js-table-actions");this.$tableBody=this.$wrapper.find("#c-table-body");this.funnel_id=a.funnel_id;this.stage_id=a.stage_id;this.contact_id=a.contact_id;this.offset=a.offset;this.locales=a.locales;this.limit=a.limit;this.initClass()};CRMDealsList.prototype.initClass=
function(){this.initLazy();this.initElasticHeader();this.initMassActions()};CRMDealsList.prototype.initLazy=function(){function a(){if(d.contains(document,g[0])){var l=d(window).scrollTop(),h=e.height(),m=g.offset().top;l+h>=m&&(k||b())}else e.off("scroll",a)}function b(){var l={offset:g.data("offset")};c.stage_id&&(l.stage=c.stage_id);c.contact_id&&(l.user=c.contact_id);k=!0;d.post("?module=deal&action=list",l,function(h){var m=d(h).find(".js-lazyload");m.length?(c.limit+=l.offset,m.insertAfter(g),
g.remove(),g=m):g.remove();d(h).find(".c-deal-wrapper").insertAfter(f.find("tr:last"))}).always(function(){k=!1})}var c=this,e=d(window),f=c.$tableBody,g=c.$wrapper.find(".js-lazyload"),k=!1;g.length&&(e.on("scroll",a),g.offset().top<e.height()&&e.trigger("scroll"))};CRMDealsList.prototype.initElasticHeader=function(){function a(){d.contains(document,e[0])?b.scrollTop()>f.top?e.css({left:f.left}).width(c.outerWidth()).addClass("is-fixed"):e.removeAttr("style").removeClass("is-fixed"):b.off("scroll",
a)}var b=d(window),c=this.$tableWrapper,e=this.$tableHeaderW,f=c.offset();b.on("scroll",a)};CRMDealsList.prototype.initMassActions=function(){function a(n){n.find(".js-check-deal").prop("checked",!0).trigger("change",[!0])}function b(n){n.find(".js-check-deal").prop("checked",!1).trigger("change",[!1])}function c(n){n.find(".js-check-deal").is(":checked")?(n.addClass("is-active"),k.push(n[0])):(n.removeClass("is-active"),n=k.indexOf(n[0]),k.splice(n,1));e()}function e(){function n(){var u=f("open"),
v=h.find(".js-deals-close").closest(".c-operation-li"),t=v.find(".js-open-count");u.length?(t.text(u.length),v.show()):v.hide()}function p(){var u=h.find(".js-deals-merge").closest(".c-operation-li");1<k.length?u.show():u.hide()}function q(){var u=!1;d(k).each(function(){if(d(this).data("can-delete"))return u=!0,!1});var v=h.find(".js-deals-delete").closest(".c-operation-li");u?v.show():v.hide()}var r=k.length;0<r?(l.hide(),h.show().find(".js-count").text(r),n(),p(),q(),r<g.limit?m.prop("indeterminate",
!0):m.prop("indeterminate",!1).prop("checked",!0)):(l.show(),h.hide(),m.prop("indeterminate",!1).prop("checked",!1))}function f(n){var p=[];d.each(k,function(q,r){q=d(r);r=q.data("id");(!n||q.data(n))&&r&&p.push(r)});return p}var g=this,k=[],l=g.$tableHeader,h=g.$tableActions,m=g.$tableHeaderW.find(".js-checkbox-all");g.$tableBody.on("click",".js-deal-wrapper",function(n){n=d(n.target);var p=d(this),q=p.find(".js-check-deal");q.closest("td");var r=!(!n.is("a")&&!n.closest("a").length),u=!(!n.is(".c-column-checkbox")&&
!n.closest(".c-column-checkbox").length);if(n.is(":checkbox"))return c(p),!0;if(r)return!0;u&&(q.attr("checked",!q.is(":checked")),c(p))});g.$tableBody.shiftSelectable({selector:".js-deal-wrapper",onSelect:function(n,p){var q=d(p.target);q=!(!q.is("a")&&!q.closest("a").length);var r=p.extra.is_first;p=p.extra.is_last;q||r||p||(n.find(".js-check-deal").attr("checked",!0),c(n))}});m.on("change",function(){var n=d(this).is(":checked"),p=g.$wrapper.find(".js-deal-wrapper"),q=p.find(".js-check-deal").filter(":checked").length;
0<q?q<g.limit||q===g.limit?b(p):a(p):n?a(p):b(p);p.each(function(){c(d(this))})});h.on("click",".js-deals-merge",function(n){n.preventDefault();n=f();n=d.crm.app_url+"deal/merge/?ids="+n.join(",");d.crm.content.load(n)});(function(){var n=!1;h.on("click",".js-deals-delete",function(p){p.preventDefault();d.crm.confirm.show({title:g.locales.delete_confirm_title.replace("%s",k.length),text:g.locales.delete_confirm_text,button:g.locales.delete_confirm_button,onConfirm:function(q){function r(){var w=[],
x=f();d.each(x,function(y,z){w.push({name:"id[]",value:z})});return w}function u(){var w=k.map(function(x){return x});d.each(w,function(x,y){x=d(y);x.find(".js-check-deal").attr("checked",!1).trigger("change");x.remove()})}if(!n){n=!0;var v=d.crm.app_url+"?module=deal&action=delete",t=r();d.post(v,t,function(w){"ok"===w.status&&(u(),q.close(),l.show(),h.hide(),m.prop("indeterminate",!1).prop("checked",!1),d.crm.content.reload(),d.crm.sidebar.reload())}).always(function(){n=!1})}return!1}})})})();
(function(){var n=!1;h.on("click",".js-deals-change-responsible",function(p){p.preventDefault();n||(n=!0,p={ids:f().join(",")},d.post("?module=deal&action=changeResponsible",p,function(q){new CRMDialog({html:q})}).always(function(){n=!1}))})})();(function(){var n=!1;h.on("click",".js-deals-close",function(p){p.preventDefault();n||(n=!0,p={ids:f("open").join(",")},d.post("?module=deal&action=massClose",p,function(q){new CRMDialog({html:q})}).always(function(){n=!1}))})})();(function(){var n=!1;h.on("click",
".js-deals-change-funnel",function(p){p.preventDefault();n||(n=!0,p={deal_ids:f().join(",")},d.post("?module=deal&action=changeFunnel",p,function(q){new CRMDialog({html:q})}).always(function(){n=!1}))})})();(function(){var n=!1;h.on("click",".js-deals-export",function(p){p.preventDefault();n||(n=!0,p=f(),d.post(d.crm.app_url+"?module=deal&action=export",{ids:p},function(q){new CRMDialog({html:q})}).always(function(){n=!1}))})})();(function(){var n=!1;h.on("click",".js-deals-set-tags",function(p){p.preventDefault();
if(!n){n=!0;p=f();var q=d.crm.app_url+"?module=dealOperation&action=assignTags",r={deal_ids:p};1===p.length&&(r.is_assign=1);d.post(q,r,function(u){new CRMDialog({html:u})}).always(function(){n=!1})}})})()};return CRMDealsList}(jQuery),CRMDealsMergePage=function(d){CRMDealsMergePage=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$submitButton=this.$wrapper.find(".js-submit-button");this.$activeDeal=this.is_deal_set=!1;this.initClass()};CRMDealsMergePage.prototype.initClass=
function(){this.initSubmit();this.initSelectDeal()};CRMDealsMergePage.prototype.initSubmit=function(){function a(){function e(g){var k="";d.each(g,function(l,h){if("master_id"===h.name)return k=h.value,!1});return k}if(!c){c=!0;var f=b.serializeArray();d.post("?module=deal&action=mergeRun",f,function(g){g=d.crm.app_url+"deal/"+e(f)+"/";let k=(new URLSearchParams(document.location.search)).get("iframe");window.parent&&k?window.parent.location=g:d.crm.content.load(g)},"json").always(function(){c=!1})}}
var b=this.$form,c=!1;b.on("submit",function(e){e.preventDefault();a()})};CRMDealsMergePage.prototype.initSelectDeal=function(){var a=this;a.$wrapper.on("change",".js-field",function(){var b=d(this);"checked"===b.attr("checked")&&(b=b.closest(".js-deal"),a.$activeDeal&&a.$activeDeal.removeClass("is-active"),a.$activeDeal=b.addClass("is-active"),a.is_deal_set||(a.$submitButton.attr("disabled",!1),a.is_deal_set=!0))});a.$wrapper.on("click",".js-deal",function(b){var c=d(this).find(".js-field"),e=c[0]==
b.target;b=!!d(b.target).attr("href");e||b||c.trigger("click")})};return CRMDealsMergePage}(jQuery),CRMDealsChangeResponsibleDialog=function(d){CRMDealsChangeResponsibleDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$submitButton=this.$wrapper.find(".js-submit-button");this.dialog=this.$wrapper.data("dialog");this.is_responsive_set=!1;this.initClass()};CRMDealsChangeResponsibleDialog.prototype.initClass=function(){this.initSubmit();this.initChangeResponsible()};
CRMDealsChangeResponsibleDialog.prototype.initChangeResponsible=function(){var a=this,b=a.$wrapper.find(".js-users-list"),c=b.find(".js-visible-link"),e=a.$wrapper.find(".js-user-field"),f=b.find(".menu-v");f.on("click","a",function(){var g=d(this),k=g.closest(".js-user");c.find(".js-text").html(g.html());f.find(".selected").removeClass("selected");k.addClass("selected");f.hide();setTimeout(function(){f.removeAttr("style")},200);g=k.data("id");e.val(g).trigger("change");a.is_responsive_set||(a.$submitButton.attr("disabled",
!1),a.is_responsive_set=!0)})};CRMDealsChangeResponsibleDialog.prototype.initSubmit=function(){function a(){if(!e){e=!0;var f=c.serializeArray();d.post("?module=deal&action=changeResponsibleRun",f,function(g){"ok"===g.status?(b.dialog.close(),d.crm.content.reload()):alert("errors")},"json").always(function(){e=!1})}}var b=this,c=b.$form,e=!1;c.on("submit",function(f){f.preventDefault();a()})};return CRMDealsChangeResponsibleDialog}(jQuery),CRMDealsCloseDialog=function(d){CRMDealsCloseDialog=function(a){this.$wrapper=
a.$wrapper;this.$form=this.$wrapper.find("form");this.$reasonSelect=this.$wrapper.find(".js-reason-select");this.$reasonFieldW=this.$wrapper.find(".js-reason-text");this.dialog=this.$wrapper.data("dialog");this.deal_ids=a.deal_ids;this.reason_require=a.reason_require;this.is_locked=!1;this.initClass()};CRMDealsCloseDialog.prototype.initClass=function(){var a=this;a.$wrapper.on("click",".js-set-won",function(b){b.preventDefault();a.setWon()});a.$wrapper.on("click",".js-show-form",function(b){b.preventDefault();
a.showLostForm()});a.$wrapper.on("click",".js-set-lost",function(b){b.preventDefault();a.$form.trigger("submit")});a.$form.on("submit",function(b){b.preventDefault();a.setLost()});a.$reasonSelect.on("change",function(){d(this).val()?a.$reasonFieldW.hide():a.$reasonFieldW.show()})};CRMDealsCloseDialog.prototype.showLostForm=function(a){var b=this.$wrapper.find(".c-visible"),c=this.$wrapper.find(".c-hidden");a?(b.show(),c.hide()):(b.hide(),c.show());this.dialog.resize()};CRMDealsCloseDialog.prototype.setWon=
function(){var a=this;if(!a.is_locked){a.is_locked=!0;var b={deal_ids:a.deal_ids.join(","),action:"WON"};d.post("?module=deal&action=massCloseRun",b,function(c){"ok"==c.status&&(a.dialog.close(),d.crm.content.reload())}).always(function(){a.is_locked=!1})}};CRMDealsCloseDialog.prototype.setLost=function(){function a(){var e=b.$form.serializeArray();e.push({name:"deal_ids",value:b.deal_ids.join(",")});e.push({name:"action",value:"LOST"});if(b.reason_require&&!b.$reasonSelect.val())if(b.$reasonFieldW.is(":visible")){var f=
b.$reasonFieldW.find("input");f.val()||(f.addClass("error").one("focus",function(){d(this).removeClass("error")}),e=!1)}else b.$reasonSelect.addClass("error").one("change",function(){d(this).removeClass("error")}),e=!1;return e}var b=this;if(!b.is_locked){b.is_locked=!0;var c=a();c?d.post("?module=deal&action=massCloseRun",c,function(e){"ok"==e.status&&(b.dialog.close(),d.crm.content.reload())}).always(function(){b.is_locked=!1}):b.is_locked=!1}};return CRMDealsCloseDialog}(jQuery),CRMDealsChangeFunnelDialog=
function(d){CRMDealsChangeFunnelDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.dialog=this.$wrapper.data("dialog");this.funnels=a.funnels;this.stage_template_html=a.stage_template_html;this.initClass()};CRMDealsChangeFunnelDialog.prototype.initClass=function(){this.initChangeFunnel();this.initChangeStage();this.initSubmit();d.crm.renderSVG(this.$wrapper)};CRMDealsChangeFunnelDialog.prototype.initChangeFunnel=function(){function a(k){(k=b.funnels[k]||!1)&&c.trigger("changeFunnel",
k)}var b=this,c=b.$wrapper.find(".js-funnels-list"),e=c.find(".js-visible-link"),f=c.find(".js-field"),g=c.find(".menu-v");g.on("click","a",function(){var k=d(this);e.find(".js-text").html(k.html());g.find(".selected").removeClass("selected");k.closest("li").addClass("selected");g.hide();setTimeout(function(){g.removeAttr("style")},200);k=k.data("id");f.val(k).trigger("change");a(k)})};CRMDealsChangeFunnelDialog.prototype.initChangeStage=function(){function a(l){k.html("");d.each(l,function(h,m){h=
b.stage_template_html;var n=d("<div />").text(m.name).html();h=h.replace("%id%",m.id).replace("%color%",m.color).replace("%name%",n);m=d(h);k.append(m)});d.crm.renderSVG(e);k.find("li:first-child a").trigger("click")}var b=this,c=b.$wrapper.find(".js-funnels-list"),e=b.$wrapper.find(".js-funnel-stages-list"),f=e.find(".js-visible-link"),g=e.find(".js-field"),k=e.find(".menu-v");k.on("click","a",function(){var l=d(this);f.find(".js-text").html(l.html());k.find(".selected").removeClass("selected");
l.closest("li").addClass("selected");k.hide();setTimeout(function(){k.removeAttr("style")},200);l=l.data("id");g.val(l)});c.on("changeFunnel",function(l,h){a(h.stages)})};CRMDealsChangeFunnelDialog.prototype.initSubmit=function(){var a=this,b=a.$form,c=!1;b.on("submit",function(e){e.preventDefault();c||(c=!0,e=b.serializeArray(),d.post("?module=deal&action=changeFunnelRun",e,function(f){"ok"===f.status&&(a.dialog.close(),d.crm.content.reload())},"json").always(function(){c=!1}))})};return CRMDealsChangeFunnelDialog}(jQuery),
CRMDealRemindersFilter=function(d){CRMDealRemindersFilter=function(a){this.$wrapper=a.$wrapper;this.$menu=this.$wrapper.find(".js-hidden-list");this.$buttons=this.$menu.find(".js-buttons");this.apply_url_pattern=a.redirect_uri;this.filters=a.filters;this.selected_filters=a.selected_filters;this.redirect_uri=this.apply_url_pattern;this.selected_ids_before=Object.keys(this.selected_filters);this.initClass()};CRMDealRemindersFilter.prototype.initClass=function(){var a=this;a.$menu.on("change",".js-checkbox",
function(){a.setItem(d(this))});a.$menu.on("click",".js-show-all",function(b){b.preventDefault();a.$menu.find(".js-checkbox").attr("checked",!1).trigger("change");a.update()});a.$menu.on("click",".js-revert",function(b){b.preventDefault();a.$menu.find(".js-checkbox").each(function(){var c=d(this),e=c.closest(".c-item").data("id");console.log(e,0<=a.selected_ids_before.indexOf(e));c.attr("checked",0<=a.selected_ids_before.indexOf(e)).trigger("change")})});a.$menu.on("click",".js-submit",function(b){b.preventDefault();
a.update()})};CRMDealRemindersFilter.prototype.setItem=function(a){var b=a.closest(".c-item"),c=b.data("id"),e=!!this.selected_filters[c];(a=a.is(":checked"))?b.addClass("selected"):b.removeClass("selected");a?e||(this.selected_filters[c]=this.filters[c]):e&&delete this.selected_filters[c];this.setApplyUrl();this.watcher()};CRMDealRemindersFilter.prototype.watcher=function(){(function(a,b){var c=!0;a.length===b.length&&(c=!1,d.each(b,function(e,f){if(0<=a.indexOf(f))c=!1;else return c=!0,!1}));return c})(Object.keys(this.selected_filters),
this.selected_ids_before)?this.$buttons.show():this.$buttons.hide()};CRMDealRemindersFilter.prototype.setApplyUrl=function(){var a=Object.keys(this.selected_filters);this.redirect_uri=this.apply_url_pattern.replace("reminder=none",a.length?"reminder="+a.join("-"):"reminder=none")};CRMDealRemindersFilter.prototype.update=function(){d.crm.content.load(this.redirect_uri)};return CRMDealRemindersFilter}(jQuery);var CRMDealsExport=function(d){CRMDealsExport=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".js-save");this.$cancel=this.$wrapper.find(".crm-js-cancel");this.$download_file_form=this.$wrapper.find(".crm-download-file-form");this.ids=a.ids||[];this.url=d.crm.app_url+"?module=dealExport&action=process";this.$dialog_parent=window.parent.$(".dialog");this.$dialog_parent_close=this.$dialog_parent.find(".dialog-close");this.initClass()};CRMDealsExport.prototype.initClass=function(){this.initStartExport()};
CRMDealsExport.prototype.initStartExport=function(){var a=this,b=a.$button,c=a.$cancel,e=null;b.click(function(f){f.preventDefault();b.attr("disabled",!0);e=a.process()});c.click(function(f){f.preventDefault();e&&e.cancel();a.$dialog_parent_close[0].click()})};CRMDealsExport.prototype.process=function(){var a=this,b=a.url,c=a.$wrapper,e=null,f=null,g=0,k={};let l=a.$wrapper.find(".progressbar-inner");k.separator=c.find("[name=separator]").val();k.encoding=c.find("[name=encoding]").val();k.export_fields_name=
c.find("[name=export_fields_name]").is(":checked")?1:0;k.not_export_empty_columns=c.find("[name=not_export_empty_columns]").is(":checked")?1:0;k.ids=[].concat(a.ids);var h=function(){a.$wrapper.find(".dialog-footer--visible").addClass("hidden");f&&clearTimeout(f);f=setTimeout(h,3200);!e||2<=g||(k.processId=e,d.post(b,k,function(m){var n=m.progress||0;l.width(n+"%")&&l.find(".progressbar-text").text(n+"%");g--;if(e&&m.ready&&(m=e)){f&&clearTimeout(f);e=f=null;n=a.$download_file_form.find('input[name="_csrf"]').val();
var p=a.$download_file_form.find('input[name="file"]').val();d.post(a.url+"&processId="+m,{processId:a.pid,_csrf:n,file:p},function(q){q=JSON.parse(q);q=a.url+"?module=dealExport&action=download&file="+q.file;a.$wrapper.find(".js-download").attr("href",q)});a.$wrapper.find(".dialog-footer--hidden").removeClass("hidden")}},"json"),g++)};a.$wrapper.find(".crm-start-block").hide();a.$wrapper.find(".crm-process-block").show();d.post(b,k,function(m){m.processId||alert("Error processing request.");let n=
m.progress||0;l.width(n+"%")&&l.find(".progressbar-text").text(n+"%");e=m.processId;h()},"json");return{cancel:function(){f&&clearTimeout(f);d.post(b,{processId:e,ready:1})}}};return CRMDealsExport}(jQuery);var CRMDealOperationAssignTags=function(d){CRMDealOperationAssignTags=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".js-save");this.$input=this.$wrapper.find(".crm-tags-input");this.context=a.context||{};this.dialog=this.$wrapper.data("dialog");this.default_text=this.$input.attr("placeholder");this.is_assign=a.is_assign||!1;this.initClass()};CRMDealOperationAssignTags.prototype.initClass=function(){this.initTagsInput();this.initPopularTags();this.initSave()};CRMDealOperationAssignTags.prototype.initTagsInput=
function(){var a=d.crm.app_url+"?module=contact&action=tags";this.$input.tagsInput({defaultText:this.default_text,width:this.$wrapper.find(".crm-dialog-content").width()-16,autocomplete_url:"",autocomplete:{html:!0,source:function(b,c){d.getJSON(a,{term:b.term},function(e){"ok"===e.status?c(e.data.tags||[]):c([])})}}})};CRMDealOperationAssignTags.prototype.initPopularTags=function(){var a=this.$input;this.$wrapper.find(".crm-popular-tags").find(".crm-popular-tag-item-link").click(function(){var b=
d(this);b=d.trim(b.text());a.removeTag(b);a.addTag(b)})};CRMDealOperationAssignTags.prototype.initSave=function(){var a=this,b=a.$button,c=a.$input,e=d.crm.app_url+"?module=dealOperation&action=assignTagsProcess",f=d.extend({},a.context,!0),g=a.$wrapper.find(".crm-loading");b.click(function(k){k.preventDefault();g.show();b.attr("disabled",!0);k=d("#"+c.attr("id")+"_tag");(k=d.trim(k.val()))&&k!==a.default_text&&c.addTag(k);f.tags=d.trim(c.val());f.is_assign=a.is_assign?1:0;var l=function(h){h=d.extend({offset:h||
0},f);d.post(e,h).done(function(m){"ok"==m.status&&(m.data.done?(g.hide(),b.attr("disabled",!1),d.crm.content.reload()):l(m.data.offset||0))})};l()})};return CRMDealOperationAssignTags}(jQuery);var CRMInvoiceEdit=function(d){function a(c,e){c=c.toFixed(2);"ru"===e&&(c=c.replace(".",","));return c}function b(c){var e=0;c&&c.length&&(c=c.replace(/,/g,".").replace(/\s/g,""),e=parseFloat(c)!=c?!1:parseFloat(c));return e}CRMInvoiceEdit=function(c){this.$wrapper=c.$wrapper;this.$form=this.$wrapper.find("form");this.$table=this.$wrapper.find(".c-product-table");this.$tableBody=this.$table.find("tbody");this.$emptyTax=this.$table.find(".js-empty-tax");this.$emptyTaxLink=this.$table.find(".js-empty-tax-link");
this.$tax=this.$table.find(".js-tax-toggle");this.$taxPercent=this.$table.find(".js-tax-percent");this.$taxType=this.$table.find(".js-tax-type");this.$taxName=this.$table.find(".js-tax-name");this.$taxHeader=this.$table.find(".js-tax-header");this.$currencyField=this.$wrapper.find(".js-currency-field");this.$companyField=this.$wrapper.find(".js-company-select");this.locale=c.locale;this.locales=c.locales;this.companies=c.companies||{};this.invoice_id=c.invoice_id;this.row_template_html=c.row_template_html;
this.confirm_dialog_template=c.confirm_dialog_template;this.shop_supported=c.shop_supported;this.tax_set_class="is-changed";this.wa_app_url=c.$wa_app_url;this.currencies=c.currencies;this.supported_currencies=c.supported_currencies;this.company_id=c.company_id;this.tax=c.tax&&c.tax.name?c.tax:!1;this.active_tax_array=[];this.tax_percent=d(this.$tax.find("option")[this.$tax[0].selectedIndex]).data("percent")||"0";this.tax_type=d(this.$tax.find("option")[this.$tax[0].selectedIndex]).data("type");this.initClass()};
CRMInvoiceEdit.prototype.initClass=function(){0==this.$wrapper.find('input[name="invoice[deal_id]"]').val()&&this.initSelectDeal();this.initDatePickers();this.initTableEvents();this.initWYSIWYG();this.initSubmit();this.initChangeContact();this.initDealActions();this.initChangeCurrency();this.shop_supported&&this.initProductName();this.initChangeTax();this.initChangeCompany();this.initToggleButton()};CRMInvoiceEdit.prototype.initTableEvents=function(){function c(f){if(d.contains(document,e.$table[0])){var g=
!0,k=e.$table.find(".js-tax-dropdown.is-active");f=d(f.target).closest(".js-tax-dropdown");f.length&&(g=f.hasClass("is-active"));k.removeClass("is-active");g||"NONE"===e.tax_type||f.addClass("is-active")}else d(document).off("click",c)}var e=this;e.$table.on("focus",".js-name-field",function(){var f=d(this).closest("tr"),g=e.$tableBody.find("tr").length;f.index()+1>=g&&e.addTableRow(g+1)});e.$table.on("keypress",".js-name-field",function(f){13===f.keyCode&&f.preventDefault()});e.$table.on("click",
".js-remove-row",function(f){f.preventDefault();1<e.$tableBody.find("tr").length&&e.removeTableRow(d(this).closest("tr"))});e.$table.on("change",".js-amount-field",function(){e.changeTableRow(d(this))});e.$table.on("change",".js-price-field",function(){var f=d(this).closest("tr").find(".js-amount-field");f.val()||f.val("1");e.changeTableRow(d(this))});e.$table.on("click",".js-set-product-tax",function(){var f=d(this),g=f.closest(".js-tax-dropdown"),k=g.find(".js-product-tax-percent"),l=g.find(".js-product-tax-type");
f=parseInt(f.data("tax-index"));if(f=e.active_tax_array[f])parseInt(e.tax_percent)===parseInt(f.tax_percent)&&e.tax_type===f.tax_type?g.removeClass(e.tax_set_class):g.addClass(e.tax_set_class),g=e.tax_type,"NONE"===f.tax_type&&(g="NONE"),l.val(g).trigger("change"),l=f.tax_percent+"%","NONE"===f.tax_type&&(l=e.companies[e.$companyField.val()],l=e.locales.no_tax.replace("%name",l.tax_name)),k.val(l).trigger("change"),e.refreshTable()});d(document).on("click",c)};CRMInvoiceEdit.prototype.addTableRow=
function(c){var e=d(this.row_template_html);e.find(".js-product-number").text(c);this.renderProductTaxOptions(e);this.$tableBody.append(e);this.renderProductTaxFields();this.shop_supported&&this.$wrapper.trigger("addProduct",e)};CRMInvoiceEdit.prototype.removeTableRow=function(c){c.remove();this.$tableBody.find("tr").each(function(e){d(this).find(".js-product-number").text(e+1)});this.refreshTable()};CRMInvoiceEdit.prototype.changeTableRow=function(c){var e=this.locale,f="price"===c.data("type"),
g=c.val(),k=0;g&&g.length&&(g=g.replace(/,/g,".").replace(/\s/g,""),0<parseFloat(g)&&(k=parseFloat(g)));c.val(f?a(k,e):k);this.refreshTable()};CRMInvoiceEdit.prototype.refreshTable=function(){var c=this,e=function(){var l=[];c.$tableBody.find("tr").each(function(){var h=d(this),m=h.find(".js-amount-field"),n=h.find(".js-price-field"),p=h.find(".js-product-total"),q=h.find(".js-product-tax-percent");m=b(m.val());n=b(n.val());var r=0;0<m&&0<n&&(r=n*m);p.text(a(r,c.locale));(p=parseInt(q.val()))&&(0<
p||0===p)||(p=0);l.push({$tr:h,percent:p,amount:m,price:n,total:r})});return l}(),f=c.tax_type&&"INCLUDE"===c.tax_type,g=0,k=0;d.each(e,function(l,h){g+=h.total;l=h.percent/100;k+=f?l/(1+l)*h.total:h.total*l});c.$table.find(".js-subtotal").text(a(g,c.locale));c.$table.find(".js-tax").text(a(k,c.locale));c.$table.find(".js-total").text(a(g+(f?0:k),c.locale))};CRMInvoiceEdit.prototype.renderProductTaxOptions=function(c){var e=this,f=!1,g;f=c&&c.length?c.find(".js-tax-dropdown"):e.$tableBody.find(".js-tax-dropdown");
var k=f.find(".js-hidden-list").html(""),l=e.companies[e.$companyField.val()],h=[];d.each(e.active_tax_array,function(m,n){g="NONE"===n.tax_type?e.locales.no_tax.replace("%name",l.tax_name):n.tax_percent+"%";0>h.indexOf(g)&&(h.push(g),k.append('<li class="ui-menu-item-html ui-menu-item"><div class="ui-menu-item-wrapper"><div class="js-set-product-tax" data-tax-index="'+m+'">'+g+"</div></div></li>"))})};CRMInvoiceEdit.prototype.renderProductTaxFields=function(c){var e=this,f=e.$tableBody.find(".js-tax-dropdown");
c&&f.removeClass(e.tax_set_class);f.each(function(){var g=d(this),k=g.find(".js-product-tax-percent"),l=g.find(".js-product-tax-type");g.hasClass(e.tax_set_class)&&"NONE"!==e.tax_type||(l.val(e.tax_type).trigger("change"),l=e.tax_percent+"%","NONE"===e.tax_type&&(l="\u2014",g.removeClass(e.tax_set_class)),k.val(l).trigger("change"))})};CRMInvoiceEdit.prototype.initSubmit=function(){function c(){var h={data:[],errors:[]},m=k.serializeArray();d.each(m,function(n,p){"invoice[contact]"!==p.name&&h.data.push(p);
"invoice[contact_id]"===p.name&&(0<p.value||h.errors.push({name:"invoice[contact_id]",value:g.locales.empty_contact}))});(function(n){g.$tableBody.find("tr").each(function(p){var q=d(this),r=q.find(".js-product-field"),u=q.find(".js-amount-field"),v=q.find(".js-price-field"),t=q.find(".js-product-tax-percent"),w=q.find(".js-product-tax-type");q=q.find(".js-name-field");u=b(u.val());v=b(v.val());t=parseInt(t.val());w=w.val();r=r.val();q=q.val();if(u||v||q)n.push({name:"items["+p+"][name]",value:q}),
n.push({name:"items["+p+"][price]",value:v}),n.push({name:"items["+p+"][quantity]",value:u}),n.push({name:"items["+p+"][tax_percent]",value:0<t||0===t?t:""}),n.push({name:"items["+p+"][tax_type]",value:w});r&&n.push({name:"items["+p+"][product_id]",value:r})})})(h.data);return h}function e(h,m){m=m?m:[];if(h){var n=Object.keys(h);d.each(n,function(p,q){m.push({name:q,value:h[q]})})}d.each(m,function(p,q){p=q.value;var r=g.$form.find('[name="'+q.name+'"]');if(r.length&&!r.hasClass("state-error")){var u=
d("<span />").addClass("state-error-hint").text(p);u.insertAfter(r);r.addClass("state-error").one("focus click change",function(){r.removeClass("state-error");u.remove()})}})}function f(h,m){if(!l){l=!0;var n=d.crm.app_url+"?module=invoice&action=save";const p=spinnerView(m);p.show();d.post(n,h,function(q){if("ok"===q.status){if(q.data.id){d(document).trigger("unsavedChanges",!1);var r=d.crm.app_url+"invoice/"+q.data.id+"/";const u=getIframeIfExists();u?(window.parent.iframe_invoice_is_saved=!0,u.dispatchEvent(new CustomEvent("close",
{detail:{id:q.data.id}}))):d.crm.content.load(r)}}else p.hide(),e(q.errors)},"json").always(function(){l=!1})}}var g=this,k=g.$form,l=!1;k.on("submit",function(h){h.preventDefault();h=c();h.errors.length?e(!1,h.errors):f(h.data,k.find(".js-submit-button"))})};CRMInvoiceEdit.prototype.initDatePickers=function(){var c=this,e=c.$wrapper.find(".js-invoice-datepicker"),f=c.$wrapper.find(".js-invoice-due-datepicker"),g=c.$wrapper.find(".js-due-days-field"),k=c.$wrapper.find(".js-clear-due-date");(function(){var l=
e.parent().find("input[type='hidden']");e.datepicker({altField:l,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0});c.invoice_id||e.datepicker("setDate","+0d")})();(function(){var l=f.parent().find("input[type='hidden']");f.datepicker({altField:l,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0});f.on("change",function(){var h=d(this).val();d.trim(h).length?k.show():(l.val(""),k.hide())})})();c.$wrapper.on("click",".js-focus-on-field",function(){d(this).parent().find(".js-invoice-due-datepicker").trigger("focus")});
g.on("change",function(){var l=g.val(),h=0;l&&l.length&&0<parseInt(l)&&(h=parseInt(l),g.val(h));0<h?k.show():k.hide();g.val(h);l=h;h=e.datepicker("getDate");l=new Date(h.getTime()+864E5*l);f.datepicker("setDate",l)});e.on("change",function(){var l=g.val();l&&l.length&&0<parseInt(l)&&g.trigger("change")});f.on("change",function(){g.val("")});k.on("click",function(){f.val("").trigger("change")})};CRMInvoiceEdit.prototype.initChangeContact=function(){var c=this,e=c.$wrapper.find(".js-contact-toggle"),
f=e.find(".js-name"),g=e.find(".js-company-name"),k=e.find(".js-profile-image img"),l=e.find(".js-contact-id"),h=!1;e.on("click",".js-change-contact",function(m){m.preventDefault();var n=d(this);d.get(d.crm.app_url+"?module=invoice&action=contactAdd",function(p){d.waDialog({html:p,options:{onAdd:function(q,r,u,v){l.val(q).trigger("change");f.text(r);g.length&&v?g.text(v):g.text("");k.length&&u?k.attr("src",u):k.attr("src",`${c.wa_app_url}wa-content/img/userpic.svg`);h||(q=n.find(".js-label"),r=q.data("change-text"),
e.find(".c-profile-block").show(),q.find("span").text(r),q.find("svg").addClass("fa-pen"),h=!0)}}})})})};CRMInvoiceEdit.prototype.initDealActions=function(){function c(k,l){let h=null;k.on("click",".js-detach-deal",function(m){m.preventDefault();d.crm.confirm.show({title:e.locales.deal_detach_title,text:e.locales.deal_detach_text.replace(/%s/,l),button:e.locales.deal_detach_confirm_button,onConfirm:function(){h&&h.abort();e.loadDealListByContact(function(n){h=d.post(d.crm.app_url+"?module=invoiceDeal&action=detach",
{invoice_id:e.invoice_id}).done(function(p){p&&"ok"===p.status&&(d.crm.content.reload(),k.data("dialog").close())}).always(function(){h=null})})}})})}let e=this,f=e.$wrapper.find(".js-deal-toggle"),g=e.$wrapper.find(".js-deal-toggle [name='invoice[deal_id]']").val();f.on("click",".js-attach-other-deal, .js-associate-deal",function(k){k.preventDefault();let l=f.find(".js-deal-name").text();e.loadDealListByContact(function(h){d.get(d.crm.app_url+"?module=invoiceDeal&action=attachDialog",{invoice_id:e.invoice_id,
deal_id:g},function(m){let n=d(m);d.waDialog({html:n,onOpen:function(){let p=n.find(".js-invoice-deal"),q=e.initSelectDeal({$wrapper:p,data:h});n.find(".js-save-button").on("click",function(){q.submit()});c(n,l)}})})})});f.on("click",".js-detach-deal",function(k){k.preventDefault();let l=null;k=f.find(".js-deal-name").text();d.crm.confirm.show({title:e.locales.deal_detach_title,text:e.locales.deal_detach_text.replace(/%s/,k),button:e.locales.deal_detach_confirm_button,onConfirm:function(){l&&l.abort();
e.loadDealListByContact(function(h){l=d.post(d.crm.app_url+"?module=invoiceDeal&action=detach",{invoice_id:e.invoice_id}).done(function(m){m&&"ok"===m.status&&d.crm.content.reload()}).always(function(){l=null})})}})})};CRMInvoiceEdit.prototype.initSelectDeal=function(c){function e(){t.html(g.locales.deal_empty);z.val("none");m.val("");h.addClass("c-deal-name-hidden");p.addClass("hidden").removeAttr("title");v.addClass("c-empty-deal-hidden");w.addClass("hidden");y.find("li").removeClass("selected");
0<q.data("deals_count")?(q.removeClass("hidden"),r.addClass("hidden")):(q.addClass("hidden"),r.removeClass("hidden"))}function f(){let C=k.find(".js-created-deal");var A=x.find(".js-visible-link .js-text .funnel-state").clone(),D=d.trim(m.val());let E=l.serializeObject();E.invoice_id=g.invoice_id;E["deal[id]"]=z.val();E["deal[name]"]=m.val();E["deal[funnel_id]"]=l.find(".js-select-deal-funnel").val();E["deal[stage_id]"]=l.find(".js-select-deal-stage").val();if("none"===z.val())return l.addClass("shake animated"),
setTimeout(function(){l.removeClass("shake animated")},500),!1;if(0>=z.val()&&!D)return h.addClass("shake animated"),setTimeout(function(){h.removeClass("shake animated");m.focus()},500),!1;l.addClass("deal-form-hidden");C.removeClass("hidden");0>=z.val()?(C.html(A),C.append(d.crm.escape(D))):(D=q.find(".js-visible-link .js-text"),A=D.find(".funnel-state").clone(),D=D.find(".deal-item--name").text(),C.html(A),C.append(d.crm.escape(D)));d.post(d.crm.app_url+"?module=invoice&action=associateDealSave",
E,function(F){"ok"===F.status?(k.closest(".dialog").data("dialog").close(),d.crm.content.reload()):(C.html(""),C.addClass("hidden"),e(),l.removeClass("deal-form-hidden"))})}c=c||{};let g=this,k=c.$wrapper||g.$wrapper,l=k.find(".js-deal-selector-control-wrapper"),h=l.find(".js-deal-name"),m=l.find(".js-deal-name-input"),n=k.closest(".js-conversation-deal-attach-dialog").find(".js-save-button"),p=l.find(".js-save-deal"),q=l.find(".js-deals-dropdown"),r=l.find(".js-create-new-deal-link"),u=l.find(".js-remove-deal"),
v=q.find(".js-empty-deal"),t=l.find(".js-select-deal .js-visible-link .js-text"),w=l.find(".js-select-funnel-wrapper"),x=l.find(".js-select-stage-wrapper"),y=l.find(".js-deals-list"),z=l.find(".js-deal-id");var B=function(C){C=C||{};let A=C.funnels||{},D=0;d.each(C.deals||{},function(E,F){E=y;var G=E.prepend;var H=A[F.funnel_id];if(!F||0>=F.id)F="";else{var I=F.id,K=F.name||"",J="",L="";H&&H.stages&&H.stages[F.stage_id]&&(J=H.stages[F.stage_id].color||"");d.isEmptyObject(H)&&(L='<span class="hint">'+
g.locales.funnel_deleted+"</span>");F='<li><a href="javascript:void(0);" class="js-deal-item" data-deal-id="'+I+'"><span class="flexbox middle js-text"><i class="fas fa-circle funnel-state" style="color: '+J+'"></i><span class="deal-item--name" style="word-break: break-word;">'+K+"</span></span>"+L+"</a></li>"}G.call(E,F);D++});l.show();q.data("deals_count",D);0<D?(q.removeClass("hidden"),r.addClass("hidden")):(r.removeClass("hidden"),q.addClass("hidden"))};z.val("none");"undefined"===typeof c.data?
g.loadDealListByContact(B):B(c.data);l.on("click",".js-create-new-deal",function(){z.val("0");q.addClass("hidden");r.addClass("hidden");h.removeClass("c-deal-name-hidden");p.attr("title",g.locales.deal_create).removeClass("hidden");w.removeClass("hidden");v.removeClass("c-empty-deal-hidden");m.focus();n.addClass("yellow")});l.on("click",".js-deal-item",function(){var C=d(this).find(".js-text").html();t.html(C);z.val(d(this).data("deal-id"));p.attr("title",g.locales.deal_add).removeClass("hidden");
w.addClass("hidden");v.removeClass("c-empty-deal-hidden");y.find("li").removeClass("selected");d(this).parent().addClass("selected");n.addClass("yellow")});y.on("click",function(){y.hide();setTimeout(function(){y.removeAttr("style")},200)});v.on("click",function(){e()});u.on("click",function(){e()});p.on("click",function(C){C.preventDefault();l.trigger("submit")});l.on("submit",function(C){C.preventDefault();f()});l.on("change",".js-select-deal-funnel",function(){l.find(".js-select-stage-wrapper").load("?module=deal&action=stagesByFunnel&id="+
d(this).val())});return{submit:function(){l.trigger("submit")}}};CRMInvoiceEdit.prototype.loadDealListByContact=function(c){let e=this.$wrapper.find(".js-contact-toggle .js-contact-id").val(),f="?module=deal&action=byContact&id="+e;c=c||function(){};0>=e||this.iframe?c({}):d.get(f,"json").always(function(g){g&&"ok"===g.status?c(g.data||{}):c({})})};CRMInvoiceEdit.prototype.initChangeCompany=function(){function c(k,l,h){k&&k.length&&(e.active_tax_array=k);g.find("option").remove();e.$taxHeader.text(l.length?
l:"\u2014");k&&l?(e.$emptyTax.hide(),e.$tax.parent().show(),d.each(k,function(m,n){m=d('<option value="'+m+'"></option>');if("INCLUDE"===n.tax_type){m.data("type","INCLUDE");var p=e.locales.include_tax}else"APPEND"===n.tax_type?(m.data("type","APPEND"),p=e.locales.append_tax):"NONE"===n.tax_type&&(m.data("type","NONE"),n.tax_percent=0,p=e.locales.no_tax);0<n.tax_percent?(m.data("percent",n.tax_percent),p=p.replace("%value",n.tax_percent+"%")):(m.data("percent",0),p=p.replace("%value",""));if(p=p.replace("%name",
l)){if(e.tax){var q=l===e.tax.name,r=n.tax_type===e.tax.type;n=(+n.tax_percent).toFixed(2)===(+e.tax.percent).toFixed(2);q&&r&&n&&m.attr("selected",!0)}m.text(p);m.data("name",l);g.append(m)}})):(e.$tax.parent().hide(),e.$emptyTax.show(),k=e.$emptyTaxLink.data("href"),e.$emptyTaxLink.attr("href",k+e.$companyField.val().toString()+"/"));g.trigger("change",!h)}var e=this,f=e.$companyField,g=e.$tax;f.on("change",function(k,l){k=d(this).val();var h=e.companies[k];e.active_tax_array=[];h&&(k=h.tax_name||
e.locales.tax,h=JSON.parse(h.tax_options),c(h,k,l))});f.trigger("change",!0)};CRMInvoiceEdit.prototype.initChangeTax=function(){var c=this;c.$tax.on("change",function(e,f){e=d(this).find("option");c.tax_percent=0;c.tax_type="NONE";c.tax_name="";e.length&&(e=e[this.selectedIndex],c.tax_percent=d(e).data("percent")||0,c.tax_type=d(e).data("type"),c.tax_name=d(e).data("name"));c.$taxPercent.val(c.tax_percent);c.$taxType.val(c.tax_type);c.$taxName.val(c.tax_name);c.renderProductTaxOptions();c.renderProductTaxFields(f);
c.refreshTable()})};CRMInvoiceEdit.prototype.initWYSIWYG=function(){var c=this.$wrapper.find(".js-wysiwyg");d.crm.initWYSIWYG(c,{keydownCallback:function(e){}})};CRMInvoiceEdit.prototype.initProductName=function(){function c(g){function k(x){w&&w.abort();var y=d.crm.backend_url+"shop/?action=autocomplete&with_counts=1";x={term:x};h("loading");w=d.get(y,x,function(z){z.length?(r.html(""),d.each(z,function(B,C){B=d("<div />");B.html(C.label).data("product",C).addClass("js-set-product");h(B)})):e.$wrapper.trigger("searchProduct")},
"json").always(function(){w=!1})}function l(x){w&&w.abort();h("loading");var y=e.$currencyField.val();w=d.get(d.crm.backend_url+"shop/?module=orders&action=getProduct",{product_id:x.id,currency:y},function(z){"ok"===z.status?(r.html(""),d.each(z.data.sku_ids,function(B,C){B=d("<div />");C=z.data.product.skus[C];B.text(z.data.product.name+(C.name.length?" ("+C.name+")":"")).data("product",z.data.product).data("sku",C).addClass("js-set-sku");h(B);1===z.data.sku_ids.length&&B.trigger("click")})):e.$wrapper.trigger("searchProduct")},
"json").always(function(){w=!1})}function h(x){if("loading"===x)r.html("").append('<li class="ui-menu-item-html ui-menu-item"><div class="ui-menu-item-wrapper"><i class="fas fa-spinner wa-animation-spin"></i></div></li>');else{var y=d("<li />").addClass("ui-menu-item-html ui-menu-item");d("<div />").addClass("ui-menu-item-wrapper").append(x).appendTo(y);y.appendTo(r)}}function m(){g.removeClass("is-active");r.html("");v=!1}function n(x){var y=r.find("li"),z=y.filter(".is-highlighted");if(!y.length)return!1;
z.length&&1<y.length?(z.removeClass("is-highlighted"),x?(x=z.next(),x.length||(x=y.first())):(x=z.prev(),x.length||(x=y.last()))):x=y.first();x.addClass("is-highlighted")}function p(){var x=r.find("li.is-highlighted");x.length&&x.find(".ui-menu-item-wrapper > *").first().trigger("click")}var q=g.find(".js-name-field"),r=g.find(".js-hidden-list"),u=g.find(".js-product-field"),v=!1,t=0,w=!1;q.on("keyup",function(x){x=x.keyCode;if(0<=[13,27,37,38,39,40].indexOf(x))switch(x){case 13:p();break;case 27:m();
q.trigger("blur");break;case 38:n(!1);break;case 40:n(!0)}else{var y=d(this).val();1<y.length?(v||(e.$wrapper.trigger("searchProduct"),g.addClass("is-active"),v=!0),clearTimeout(t),t=setTimeout(function(){k(y)},500)):e.$wrapper.trigger("searchProduct")}});q.on("change",function(){u.val("").trigger("change")});e.$wrapper.on("searchProduct",m);r.on("click",".js-set-product",function(){var x=d(this).data("product");x&&l(x)});r.on("click",".js-set-sku",function(){var x=d(this),y=x.data("product");x=x.data("sku")||
!1;if(y){var z="shop:"+y.id+(x?":"+x.id:""),B=x.price;q.val(y.name+(x.name.length?" ("+x.name+")":"")).trigger("change");g.closest("tr").find(".js-price-field").val(B).trigger("change");u.val(z).trigger("change")}m();q.trigger("blur")})}var e=this,f=e.$wrapper.find(".js-name-autocomplete");f.length&&(f.each(function(){c(d(this))}),e.refreshTable());e.$wrapper.on("addProduct",function(g,k){g=d(k).find(".js-name-autocomplete");g.length&&c(g)})};CRMInvoiceEdit.prototype.initChangeCurrency=function(){function c(g,
k){e.$tableBody.find(".js-price-field").each(function(){var l=d(this),h=l.val(),m=0;h&&h.length&&(h=h.replace(/,/g,".").replace(/\s/g,""),0<parseFloat(h)&&(m=parseFloat(h)),l.val(m*e.currencies[k].rate/e.currencies[g].rate).trigger("change"))})}var e=this,f=e.$currencyField.val();e.$currencyField.on("change",function(){var g=e.$currencyField.val(),k=!1;e.$tableBody.find(".js-price-field").each(function(){if(d(this).val().length)return k=!0,!1});k?(e.$currencyField.val(f),d.waDialog({html:e.confirm_dialog_template,
options:{changeCurrencyWithPrice:function(){e.$currencyField.val(g);c(g,f);f=g},changeCurrency:function(){e.$currencyField.val(g);f=g}}})):f=g})};CRMInvoiceEdit.prototype.initToggleButton=function(){var c=this.$wrapper.find(".js-footer-actions"),e=c.find(".js-submit-button");this.$wrapper.on("change keydown","input, textarea, select",function(){e.removeClass("green").addClass("yellow");c.addClass("is-changed");d(document).trigger("unsavedChanges",!0)})};return CRMInvoiceEdit}(jQuery),CRMInvoiceContactAdd=
function(d){CRMInvoiceContactAdd=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.dialog=this.$wrapper.data("dialog");this.locales=a.locales;this.initClass()};CRMInvoiceContactAdd.prototype.initClass=function(){function a(){var g=e.$form.serializeArray(),k={data:[],errors:[]},l=!1,h=!1;d.each(g,function(m,n){m=n.name;var p=n.value;"deal[contact_id]"===m&&p&&(l=!0);"contact[firstname]"===m&&p&&(h=!0);"contact[lastname]"===m&&p&&(h=!0);"contact[middlename]"===m&&p&&(h=
!0);"contact[name]"===m&&p&&(h=!0);k.data.push(n)});l||h||(k.errors.push({name:"contact[name]",value:e.locales.empty_name}),k.errors.push({name:"contact[firstname]",value:e.locales.empty_name}));return k}function b(g){d.post("?module=invoice&action=contactAddSave",g,function(k){"ok"===k.status?(e.dialog.options.onAdd(k.data.id,k.data.name,!1,!1),e.dialog.close()):c(k.errors)},"json").always(function(){f=!1})}function c(g,k){k=k?k:[];if(g){var l=Object.keys(g);d.each(l,function(h,m){k.push({name:m,
value:g[m]})})}d.each(k,function(h,m){h=m.name;m=m.value;"name"===h&&(h="contact[firstname]");var n=e.$form.find('[name="'+h+'"]');"contact[firstname]"!==h||n.is(":visible")||(n=e.$form.find(".js-contact-autocomplete"));if(n.length&&!n.hasClass("state-error")){var p=d("<div />").addClass("state-error-hint").text(m);p.insertAfter(n);n.addClass("state-error").one("focus click",function(){n.removeClass("state-error");p.remove()});d(document).on("toggleChanged",function(){n.removeClass("state-error");
p.remove()})}})}var e=this,f=!1;e.$form.on("submit",function(g){g.preventDefault();g=e.$wrapper.find(".js-contact-id-field").val();var k=!1;if(g){var l=e.$wrapper.find(".js-contact-autocomplete");var h=l.val();is_company=l.data("is_company");+is_company||(k=e.$wrapper.find(".js-company-autocomplete").val());l=l.data("photo_url");e.dialog.options.onAdd(g,h,l,k);e.dialog.close()}else f||(f=!0,g=a(),g.errors.length?(c(!1,g.errors),f=!1):b(g.data))})};return CRMInvoiceContactAdd}(jQuery),CRMInvoicePage=
function(d){function a(b,c){if(!b)return!1;b=d('.js-invoices-list .c-invoice[data-id="'+b+'"]');b.length&&(c?b.replaceWith(c):b.remove())}CRMInvoicePage=function(b){this.$wrapper=b.$wrapper;this.invoice_id=b.invoice_id;this.locales=b.locales;this.initClass()};CRMInvoicePage.prototype.initClass=function(){var b=this;b.initChangeState();b.initDelete();b.initRefund();b.initRestore();setTimeout(function(){d(document).trigger("viewInvoice",b.invoice_id)},100);b.$wrapper.data("page",b);d(".js-action-link").one("click",
function(c){spinnerView(d(this)).show()})};CRMInvoicePage.prototype.initChangeState=function(){function b(g,k){if(!f){f=!0;var l={invoice_id:e,action:g};const h=spinnerView(k);h.show();d.post("?module=invoice&action=handleTransaction",l,function(m){if("ok"===m.status){const n=getIframeIfExists();n?(window.parent.iframe_invoice_is_saved=!0,n.contentWindow.location.reload()):(a(c.invoice_id,"delete"===g?"":m.data.html),c.load(d.crm.app_url+"invoice/"+c.invoice_id+"/"))}else alert(m.errors)},"json").always(function(){h.hide();
f=!1})}}var c=this,e=c.invoice_id,f=!1;c.$wrapper.on("click",".js-change-state",function(g){g.preventDefault();(g=d(this).data("action"))&&b(g,d(this))})};CRMInvoicePage.prototype.initDelete=function(){function b(f){if(!e){e=!0;var g={invoice_id:c.invoice_id,action:"delete"};const k=spinnerView(f.$body.find(".js-success-action"));k.show();d.post("?module=invoice&action=handleTransaction",g,function(l){if("ok"===l.status){l=d.crm.app_url+"invoice/";const h=getIframeIfExists();h?h.dispatchEvent(new CustomEvent("close",
{detail:"refresh"})):d.crm.content.load(l)}},"json").always(function(){k.hide();e=!1})}}var c=this,e=!1;c.$wrapper.on("click",".js-delete-invoice",function(f){f.preventDefault();d.waDialog.confirm({title:c.locales.delete_confirm_title,text:c.locales.delete_confirm_text,success_button_title:c.locales.delete_confirm_button,success_button_class:"danger",cancel_button_title:d.crm.locales.cancel,cancel_button_class:"light-gray",onSuccess:b})})};CRMInvoicePage.prototype.initRefund=function(){function b(f){if(!e){e=
!0;var g=d.crm.app_url+"?module=invoice&action=refundDialog",k={invoice_id:c.invoice_id};const l=spinnerView(f,0);l.show();d.post(g,k,function(h){d.waDialog({html:h,options:{onRefund:function(m){const n=getIframeIfExists();n?(window.parent.iframe_invoice_is_saved=!0,n.contentWindow.location.reload()):(a(c.invoice_id,m.html),c.reload())}}})}).always(function(){l.hide();e=!1})}}var c=this,e=!1;c.$wrapper.on("click",".js-change-refund",function(f){f.preventDefault();b(d(this))})};CRMInvoicePage.prototype.initRestore=
function(){function b(f){if(!e){e=!0;var g={id:c.invoice_id};const k=spinnerView(f);k.show();d.post("?module=invoiceRestore",g,function(l){if("ok"===l.status){const h=getIframeIfExists();h?(window.parent.iframe_invoice_is_saved=!0,h.contentWindow.location.reload()):(a(c.invoice_id,l.data.html),c.reload())}else k.hide(),alert(l.errors)},"json").always(function(){e=!1})}}var c=this,e=!1;c.$wrapper.on("click",".js-restore-invoice",function(f){f.preventDefault();b(d(this))})};CRMInvoicePage.prototype.load=
function(b){b=d("<a />").addClass("js-disable-router").attr("href",b).hide();this.$wrapper.append(b);b.trigger("click")};CRMInvoicePage.prototype.reload=function(){this.load(location.href)};return CRMInvoicePage}(jQuery),CRMInvoiceRefundDialog=function(d){CRMInvoiceRefundDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMInvoiceRefundDialog.prototype.initClass=function(){this.initSubmit()};CRMInvoiceRefundDialog.prototype.initSubmit=
function(){function a(){var g={data:[],errors:[]},k=e.serializeArray();d.each(k,function(l,h){g.data.push(h)});return g}function b(g,k){if(!f){f=!0;var l=d.crm.app_url+"?module=invoice&action=handleTransaction";const h=spinnerView(k);h.show();d.post(l,g,function(m){"ok"===m.status?(c.dialog.options.onRefund(m.data),c.dialog.close()):console.log(m.errors)},"json").always(function(){h.hide();f=!1})}}var c=this,e=c.$form,f=!1;e.on("submit",function(g){g.preventDefault();g=a();g.errors.length?console.log(g.errors):
b(g.data,e.find(".js-submit-button"))})};return CRMInvoiceRefundDialog}(jQuery);function getIframeIfExists(){return(new URLSearchParams(document.location.search)).get("iframe")&&window.parent?window.parent.document.getElementById("iframe-invoice"):null}
function spinnerView(d,a=350){const b=$('<span class="icon size-16 custom-mr-8 js-loading"><i class="fas fa-spinner wa-animation-spin"></i></span>'),c=d.find(".icon:not(.js-loading)");return{show:function(){c&&c.hide();d.prepend(b);"BUTTON"===d.prop("tagName")&&d.prop("disabled",!0)},hide:function(){setTimeout(()=>{d.removeAttr("disabled");d.find(".js-loading").remove();c&&c.show()},a)}}};var CRMInvoices=function(d){function a(){var b=!1,c=d("#c-invoice-page");c.length&&(c=c.data("id"))&&(b=c);return b}CRMInvoices=function(b){this.$wrapper=b.$wrapper;this.$content=this.$wrapper.find("#js-inner-content");this.$sidebar=this.$wrapper.find("#js-aside-block");this.$invoiceList=this.$sidebar.find(".js-invoices-list");this.initClass()};CRMInvoices.prototype.initClass=function(){this.showOnlyDesktopClass="desktop-and-tablet-only";this.patternsBeginContent=[".+\\d+\\/",".+new\\/"];this.initWaLoading();
this.filtersDropdown();this.initContentRouter();this.initLazy();this.initInvoiceList();this.initInvoiceSearch();this.initMobileEvents()};CRMInvoices.prototype.hideContentMobile=function(){this.$content.addClass(this.showOnlyDesktopClass);this.$sidebar.removeClass(this.showOnlyDesktopClass)};CRMInvoices.prototype.showContentMobile=function(){this.$sidebar.addClass(this.showOnlyDesktopClass);this.$content.removeClass(this.showOnlyDesktopClass)};CRMInvoices.prototype.initMobileEvents=function(){d(document).on("click",
".js-invoice-hide-mobile",()=>{this.hideContentMobile()});const {pathname:b}=window.location;for(const c of this.patternsBeginContent)if((new RegExp(c,"g")).test(b)){this.showContentMobile();break}};CRMInvoices.prototype.filtersDropdown=function(){d(".dropdown",this.$sidebar).waDropdown({hover:!1,items:".menu > li > a",change:function(b){if("touchend"!==b.type)return!1;b=d(b.target).closest("a");if(!b.length)return!1;if(b=b.attr("href"))window.location=b}})};CRMInvoices.prototype.initWaLoading=function(){var b=
d.waLoading(),c=d(document);c.on("wa_before_load.invoices",function(){b.show();b.animate(1E4,100,!1);c.addClass("is-locked")}).on("wa_loading.invoices",function(e,f){b.set(f.loaded/f.total*100)}).on("wa_abort.invoices",function(){b.abort();c.removeClass("is-locked")}).on("wa_loaded.invoices",function(){b.done();c.removeClass("is-locked")});d("#c-invoices-page").one("remove",function(){c.off(".invoices");b.$bar.remove();b.$wrapper.remove();c.removeClass("is-locked")})};CRMInvoices.prototype.initContentRouter=
function(){function b(l){k&&k.abort();d(document).trigger("wa_before_load");return k=d.ajax({method:"GET",url:l,data:{content_only:1},dataType:"html",global:!1,cache:!1,xhr:function(){var h=new window.XMLHttpRequest;h.addEventListener("progress",function(m){d(document).trigger("wa_loading",m)},!1);h.addEventListener("abort",function(m){d(document).trigger("wa_abort")},!1);return h}}).always(function(){c.xhr=!1}).done(function(h){g&&history.pushState({reload:!0,content_uri:l},"",l);d(document).trigger("wa_before_render");
e.html(h);d(document).trigger("wa_loaded")}).fail(function(h){d(document).trigger("wa_abort");h.responseText&&d.waDialog.alert({title:"Error",text:h.responseText,button_title:"Close"})})}var c=this,e=c.$content.find(".js-inner-content"),f=!1,g=!(!history||!history.pushState),k=!1;c.$wrapper.on("click","a",function(l){const h=d(this),m=h.hasClass("js-disable-router")?h.attr("href"):!1;if(!m)return!0;l.preventDefault();f?d.waDialog.confirm({title:d.crm.locales.unsaved_dialog_title,text:d.crm.locales.unsaved_dialog_text,
success_button_title:d.crm.locales.unsaved_dialog_button,success_button_class:"danger",cancel_button_title:d.crm.locales.cancel,cancel_button_class:"light-gray",onSuccess:function(){d(document).trigger("unsavedChanges",!1);b(m)}}):b(m).then(()=>{c.$content.is(":hidden")&&c.showContentMobile()})});d(document).on("unsavedChanges",function(l,h){f=!!h})};CRMInvoices.prototype.initLazy=function(){function b(){if(!g){var k={offset:f.data("offset")},l=a();l&&(k.invoice_id=l);g=!0;d.post("?module=invoice&action=sidebar",
k,function(h){var m=d(h);h=m.find(".js-lazyload");m=m.find(".c-invoice");e.unobserve(f[0]);h.length?(h.insertAfter(f),f.remove(),f=h,e.observe(f[0])):f.remove();c.append(m)}).always(function(){g=!1})}}let c=this.$invoiceList,e=null,f=this.$wrapper.find(".js-lazyload"),g=!1;this.$invoiceList.on("touchstart",function(){d("body").css({overflow:"hidden"});d(this).closest(".sidebar-body").css({overflow:"overlay"});setTimeout(()=>{d("body").css({overflow:"auto"})})});f.length&&function(){e=new IntersectionObserver(k=>
{0>=k[0].intersectionRatio||b()});e.observe(f[0])}()};CRMInvoices.prototype.initInvoiceList=function(){function b(f){c.$invoiceList.find(".c-invoice").each(function(){var g=d(this),k=g.data("id");f==k&&(g.addClass("selected"),e=g)})}var c=this,e=c.$invoiceList.find(".c-invoice.selected");d(document).on("viewInvoice",function(f,g){e.length&&e.removeClass("selected");g&&b(g)})};CRMInvoices.prototype.initInvoiceSearch=function(){var b=this.$wrapper.find(".js-search-field");b.autocomplete({appendTo:this.$sidebar,
classes:{"ui-autocomplete":"c-search-results-list"},source:d.crm.app_url+"?module=invoiceAutocomplete",minLength:1,html:!0,focus:function(){return!1},select:function(c,e){d.crm.content.load(d.crm.app_url+"invoice/"+e.item.id+"/");b.val("");return!1}}).data("ui-autocomplete")._renderItem=function(c,e){return d("<li />").addClass("ui-menu-item-html").append("<div>"+e.value+"</div>").appendTo(c)}};return CRMInvoices}(jQuery);var CRMReminderFormEdit=function(d){CRMReminderFormEdit=function(a){this.$wrapper=a.$wrapper;this.$main_wrapper=a.$main_wrapper;this.$form=this.$wrapper.find("form");this.$loader_spinner=d(".c-reminders-list-loader");this.reminder_id=a.reminder_id;this.locales=a.locales;this.app_url=a.app_url;this.initialFormValues=this.$form.serialize();this.initialFormData=a.reminder_data;this.tempFormData=jQuery.extend(!0,{},this.initialFormData);this.form_is_change=!1;this.is_first_click=!0;this.initClass()};
CRMReminderFormEdit.prototype.initClass=function(){this.initDatePicker();this.initTextArea();this.initTimeToggle();this.initTimePicker();this.initTypeToggle();this.initSubmit();this.initClickWatcher()};CRMReminderFormEdit.prototype.initCombobox=function(){function a(f){f?(c.addClass("is-shown"),c.find(".js-autocomplete").focus()):c.removeClass("is-shown")}var b=this,c=b.$form.find(".js-contact-wrapper"),e=c.find(".js-contact-field");c.on("click",".js-show-combobox",function(f){a(!0)});c.on("click",
".js-hide-combobox",function(f){f.stopPropagation();a(!1)});(function(){var f=c.find(".js-autocomplete");f.autocomplete({appendTo:c,source:b.app_url+"?module=autocomplete&type=user",minLength:0,html:!0,focus:function(){return!1},select:function(g,k){b.setContact(k.item);a(!1);f.val("");b.form_is_change=!0;return!1}}).data("ui-autocomplete")._renderItem=function(g,k){return d("<li />").addClass("ui-menu-item-html").append("<div>"+k.value+"</div>").appendTo(g)};f.on("focus",function(){f.data("uiAutocomplete").search(f.val())})})();
b.setContact=function(f){var g=c.find(".js-user");f.photo_url&&g.find(".icon.size-24").css("background-image","url("+f.photo_url+")").html("");g.find(".c-name").text(f.name);e.val(f.id)}};CRMReminderFormEdit.prototype.initSearchDeal=function(){var a=this,b=a.$form.find(".c-deal-wrapper"),c=a.$form.find('[name="data[deal_id]"]'),e=a.$form.find('[name="data[contact_id]"]'),f=b.find(".c-search-contact-wrapper"),g=b.find(".c-deal-item"),k=b.find(".js-autocomplete-deal");k.autocomplete({appendTo:f,position:{my:"right top",
at:"right bottom"},source:a.app_url+"?module=autocompleteSidebar",minLength:0,html:!0,focus:function(l,h){return!1},select:function(l,h){a.setDeal(h.item);k.val("");f.find(".ui-autocomplete").hide();a.form_is_change=!0;c.trigger("click");return!1}}).data("ui-autocomplete")._renderItem=function(l,h){return d("<li />").addClass("ui-menu-item-html").append("<div>"+h.value+"</div>").appendTo(l)};b.on("click",function(l){l.preventDefault();l=d(l.target);f.is(":visible")?l.closest(".js-reset-deal").length&&
a.clearDeal():l.closest(".js-open-search").length&&(f.addClass("is-shown"),k.focus())});a.clearDeal=function(){g.html("");f.removeClass("is-hidden is-shown");e.val("");c.val("");a.form_is_change=!0;c.trigger("click");a.tempFormData.contact.id="";a.tempFormData.contact.name="";a.tempFormData.contact.photo_url=""};k.on("focus",function(){k.data("uiAutocomplete").search(k.val())});a.setDeal=function(l,h=!1){var m=a.app_url+(l.photo_url?"contact/":"deal/")+l.id;m=`<a class="flexbox middle c-user" href="${h?
m:"javascript:void(0);"}">
            ${l.photo_url?`<span class="icon size-18 rounded js-open-search" style="background-image: url(${l.photo_url});"></span>`:""}
            <span class="c-user-name">&nbsp;${l.name}</span>
            </a>
            ${h?"":'<div class="hint custom-pl-12 js-open-search cursor-pointer">\n                <span class="icon size-14"><i class="fas fa-pen" title="[`edit`]"></i></span>\n            </div>'}`;if(h)return m;f.addClass("is-hidden").removeClass("is-shown");g.html(m);l.photo_url?(e.val(l.id),c.val(""),a.tempFormData.contact.photo_url=l.photo_url):(c.val(l.id),e.val(""),a.tempFormData.contact.photo_url="");a.tempFormData.contact.id=l.id;a.tempFormData.contact.name=l.name}};CRMReminderFormEdit.prototype.initTextArea=
function(){var a=this,b=a.$wrapper.find(".js-textarea");a.$textField=a.$main_wrapper.find(".js-float-text");b.css("min-height",a.$textField.height()+"px");b.on("input",function(){b.css("height",b[0].scrollHeight+"px")});b.on("focusout",function(){a.form_is_change=!0});b.on("keydown",function(c){13!==c.keyCode||c.shiftKey||(c.preventDefault(),c.stopPropagation(),a.$form.trigger("submit"))})};CRMReminderFormEdit.prototype.initDatePicker=function(){var a=this;a.$form.find(".js-datepicker").each(function(){var b=
d(this);0<this.value.length&&(this.style.width=7*this.value.length+"px");b.datepicker({changeMonth:!0,changeYear:!0,showOtherMonths:!0,selectOtherMonths:!0,gotoCurrent:!0});var c=b.parent(),e=c.find(".calendar"),f=c.find(".js-reset-date");e.on("click",function(){b.focus()});a.reminder_id||b.datepicker("setDate","+1d");b.on("change",function(){this.style.width=0<this.value.length?7*this.value.length+"px":8*(this.getAttribute("placeholder").length+1)+"px";""!==b.val()&&c.addClass("is-active");a.form_is_change=
!0;c.trigger("click")});f.on("click",function(){b.val("");b.trigger("change");c.removeClass("is-active")})})};CRMReminderFormEdit.prototype.initTimeToggle=function(){function a(f){f?c.addClass("is-active"):c.removeClass("is-active")}var b=this,c=b.$form.find(".js-time-toggle"),e=c.find(".js-timepicker");e.on("change",function(){a(!0);""==e.val()&&a();b.form_is_change=!0});c.on("click",".js-show-time",function(){e.focus()});c.on("click",".js-reset-time",function(){e.val("");a();b.form_is_change=!0})};
CRMReminderFormEdit.prototype.initTimePicker=function(){this.$form.find(".js-timepicker").each(function(){d(this).timepicker()})};CRMReminderFormEdit.prototype.initClickWatcher=function(){var a=this,b=a.$main_wrapper,c=a.$wrapper,e=a.$wrapper.find(".js-textarea");b.on("editOpen",function(){d(".c-reminder-wrapper.highlighted").removeClass("highlighted");a.is_first_click&&(a.initCombobox(),a.initSearchDeal(),a.is_first_click=!1,e.css("height",0),e.css("height",e[0].scrollHeight+"px"));d(document).on("click",
a.editClickWatcher);b.on("escKeyPress",a.$clear)});a.close_edit=function(){b.trigger("reminderNotChanged");a.form_is_change=!1;d(document).off("click",a.editClickWatcher);b.off("escKeyPress",a.$clear)};a.editClickWatcher=function(f){if(d.contains(document,c[0])){var g=d(f.target);if(c.is(":visible")){f=d.contains(b[0],f.target);var k=!!g.closest(".js-edit-reminder").length,l=!!g.closest(".ui-timepicker-wrapper").length,h=!!g.closest(".ui-datepicker").length||!!g.closest(".ui-corner-all").length,m=
c.find(".js-contact-wrapper").hasClass("is-shown"),n=!!g.closest(".js-contact-wrapper").length,p=c.find(".c-search-contact-wrapper").hasClass("is-shown");g=!!g.closest(".c-deal-wrapper").length;f||l||h||(a.checkFormChange()?a.close_edit():k&&a.close_edit());m&&!n&&c.find(".js-contact-wrapper").removeClass("is-shown");p&&!g&&c.find(".c-search-contact-wrapper").removeClass("is-shown")}}else d(document).off("click",a.editClickWatcher),b.off("escKeyPress",a.$clear)}};CRMReminderFormEdit.prototype.initTypeToggle=
function(){var a=this,b=a.$wrapper.find(".js-reminder-type-toggle"),c=b.find(".js-type-field"),e=b.find(".menu");b.waDropdown();e.on("click","a",function(){var f=d(this);b.find(".js-text").html(f.html());e.find(".selected").removeClass("selected");f.closest("li").addClass("selected");f=f.data("type-id");c.val(f).trigger("change");a.form_is_change=!0})};CRMReminderFormEdit.prototype.checkFormChange=function(a){var b=this.$form.serialize();if(a){a=this.initialFormData;var c=this.$form.serializeArray();
const e={all:!0,date_time:!0};e.all=this.initialFormValues===b;b=c.filter(g=>"data[due_date]"===g.name)[0].value;const f=c.filter(g=>"data[due_time]"===g.name)[0].value;c=c.filter(g=>"data[user_contact_id]"===g.name)[0].value;e.date_time=a.due_date===b&&a.due_time===f&&a.user_contact.id===c?!0:!1;return e}return this.initialFormValues===b};CRMReminderFormEdit.prototype.initSubmit=function(){function a(){var n={data:[],errors:[]},p=k.serializeArray(),q=!1;type_other=!1;d.each(p,function(r,u){u.value.length&&
(n.data.push(u),"data[due_time]"===u.name&&(q=!0),"OTHER"===u.value&&(type_other=!0))});n.data.length<(q?5:type_other?4:3)&&n.errors.push({name:"content",value:f.locales.at_least});type_other&&(p=n.data.filter(r=>"data[content]"===r.name),p.length&&/\S/.test(p[0].value)||n.errors.push({name:"content",value:f.locales.empty}));return n}function b(n,p){p=p?p:[];if(n){var q=Object.keys(n);d.each(q,function(r,u){p.push({name:u,value:n[u]})})}d.each(p,function(r,u){r=u.value;var v=k.find(`[name="data[${u.name}]"`);
if(!v.hasClass("error")){var t=d("<span />").addClass("errormsg").text(r);h.find(".flexbox.vertical.width-100").append(t);v.addClass("error").one("focus click change clear_error",function(){v.removeClass("error");t.remove()});$has_errors=!0}})}function c(n,p){if(!g){g=!0;var q=f.app_url+"?module=reminder&action=save";$loader=d('<span class="icon"><i class="fas fa-spinner wa-animation-spin"></i></span>');h.find(".c-actions-button.js-save").append($loader);d.post(q,n,function(r){"ok"===r.status?(p?
(l.trigger("reminderIsChanged"),d(document).off("click",f.editClickWatcher),l.off("escKeyPress",f.$clear)):e(n),f.initialFormValues=f.$form.serialize(),f.form_is_change=!1):b(r.errors)},"json").always(function(){$loader.remove();g=!1})}}function e(n){var p=n.filter(q=>"data[content]"===q.name);n=n.filter(q=>"data[type]"===q.name)[0].value;f.tempFormData.content!==p&&(p.length?(f.tempFormData.content=p[0].value,f.$textField.html((p[0].value+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1<br />$2"))):
(f.tempFormData.content="",f.$textField.html("")));if(f.tempFormData.type!==n){p=f.$wrapper.find(".js-reminder-type-toggle button");const q=f.$main_wrapper.find("button.no-hover");"OTHER"===n?q.remove():q.length?q.html(p.html()):(p=`<button class="button button-slim smallest rounded light-gray no-hover">${p.html()}</button>`,f.$main_wrapper.find(".is-view .c-footer").prepend(p));f.tempFormData.type=n}f.tempFormData.contact.id!==f.initialFormData.contact.id&&f.tempFormData.contact.name!==f.initialFormData.contact.name&&
(n=f.$main_wrapper.find(".is-view .c-deal-wrapper"),""!==f.tempFormData.contact.id?n.html(f.setDeal(f.tempFormData.contact,!0)):n.html(""));f.initialFormData=jQuery.extend(!0,{},f.tempFormData);l.addClass("highlighted");l.trigger("reminderNotChanged");l.trigger("updatePadding")}var f=this,g=!1,k=f.$form,l=f.$main_wrapper,h=f.$wrapper,m=k.find(".js-save");$cancel_button=k.find(".js-cancel");$has_errors=!1;m.on("click",function(n){n.stopPropagation();f.$form.trigger("submit")});$cancel_button.on("click",
function(n){n.stopPropagation();n.preventDefault();f.$clear()});f.$clear=function(){const n=k.find(".js-textarea"),p=k.find(".js-datepicker"),q=k.find(".js-timepicker"),r=k.find(".c-search-contact-wrapper").hasClass("is-hidden"),u=k.find(".js-contact-field");if(!f.checkFormChange()){const v=f.initialFormData;n.val(v.content);h.find(`.menu a[data-type-id='${v.type}']`).trigger("click");p.val(v.due_date).trigger("change");q.val(v.due_time).trigger("change");v.contact.id?f.setDeal(v.contact):r&&f.clearDeal();
u!==v.user_contact.id&&f.setContact(v.user_contact);$has_errors&&(k.find('[name="data[content]"').trigger("clear_error"),$has_errors=!1);n.css("height",0);n.css("height",n[0].scrollHeight+"px")}f.close_edit()};k.on("submit",function(n){n.preventDefault();n=f.checkFormChange(!0);n.all?f.close_edit():n.date_time?f.$submit_reminder():f.$submit_reminder(!0)});f.$submit_reminder=function(n){$has_errors&&(k.find('[name="data[content]"').trigger("clear_error"),$has_errors=!1);var p=a();p.errors.length?b(!1,
p.errors):c(p.data,n)}};return CRMReminderFormEdit}(jQuery);var CRMReminders=function(d){CRMReminders=function(a){this.$wrapper=a.$wrapper;this.$sidebar=a.$sidebar;this.$iframe=a.iframe;this.$completedSection=this.$wrapper.find(".c-completed-reminders-section");this.user_id=a.is_all_reminders?"all":a.user_id;this.setting_contact_id=a.setting_contact_id;this.setting_deal_id=a.setting_deal_id;this.current_page=a.current_page;this.assign_to_user=a.assign_to_user;this.locales=a.locales;this.click_reminder_event=!1;this.initClass()};CRMReminders.prototype.initClass=
function(){var a=this;a.initToggleSidebar();a.initAddReminder();a.initLazyLoading();a.initReopenReminder();a.user_id&&a.$completedSection.length&&a.initCompletedReminders();a.initTarget();a.$iframe||(d(window).on("beforeunload",function(b){localStorage.setItem("scrollpos",a.$sidebar.scrollTop())}),a.$sidebar.on("click",".c-user-wrapper",function(){d(document).off("is_completed_loaded_false");d(window).off("resize");a.$wrapper.find(".skeleton-wrapper").show();d("html, body").scrollTop(0);a.click_reminder_event=
!0;localStorage.setItem("scrollpos",a.$sidebar.scrollTop());d(this).find(".js-user-photo").html("").append('<span class="icon user-loader" style="font-size: 24px; color: var(--menu-glyph-color); width: 35px; height: 32px;"><i class="fas fa-spinner fa-spin"></i></span>')}))};CRMReminders.prototype.initToggleSidebar=function(){function a(e,f){0<=f.content_uri.indexOf("/reminder/")&&(b.hasClass("sidebar-opened")&&b.removeClass("sidebar-opened"),b.find(".skeleton-wrapper").show());d(document).off("wa_before_load",
a)}var b=this.$wrapper,c=b.find(".js-expand-sidebar");if(c.length)c.on("click",function(e){e.preventDefault();b.addClass("sidebar-opened")});d(document).on("wa_before_load",a)};CRMReminders.prototype.initAddReminder=function(){function a(){return v===q.serialize()}function b(t){t.stopPropagation();var w=d(t.target),x=d.contains(document,p[0]);t=d.contains(p[0],t.target);var y=!!w.closest(".ui-timepicker-wrapper").length,z=!!w.closest(".ui-datepicker").length||!!w.closest(".ui-corner-all").length,
B=$wrapperContact.hasClass("is-shown");w=!!w.closest(".js-contact-wrapper").length;x?(t||y||z||a()&&c(),B&&!w&&h()):d(document).off("click",b)}function c(){u.slideUp(300);r.blur();p.removeClass(extended_class);wrapper_is_open=!1;d(document).off("click",b)}function e(){a()||(r.val(""),p.find(".menu a[data-type-id='OTHER']").trigger("click"),n.$date_clear.trigger("click"),n.$time_clear.trigger("click"),n.clearDeal(),n.setContact(n.assign_to_user),has_errors&&(q.find('[name="data[content]"').trigger("clear_error"),
has_errors=!1),k());c()}function f(){var t={data:[],errors:[]},w=q.serializeArray(),x=!1;d.each(w,function(y,z){z.value.length&&(t.data.push(z),"OTHER"===z.value&&(x=!0))});x&&(w=t.data.filter(y=>"data[content]"===y.name),w.length&&/\S/.test(w[0].value)||t.errors.push({name:"content",value:n.locales.empty}));return t}function g(t){t=t?t:[];d.each(t,function(w,x){w=x.value;var y=q.find(`[name="data[${x.name}]"`);if(!y.hasClass("error")){var z=d("<span />").addClass("errormsg").text(w);p.find(".flexbox.vertical.width-100").append(z);
y.addClass("error").one("focus click change clear_error",function(){y.removeClass("error");z.remove();has_errors=!1});has_errors=!0}})}function k(){r.css("min-height",0);r.css("min-height",r[0].scrollHeight+"px")}function l(t){var w=t.find(".js-contact-field"),x=t.find(".c-combobox");t.on("click",".js-show-combobox",function(y){y.stopPropagation();h(!0)});t.on("click",".js-hide-combobox",function(y){y.stopPropagation();h(!1)});(function(){var y=t.find(".js-autocomplete");y.autocomplete({appendTo:x,
source:d.crm.app_url+"?module=autocomplete&type=user",minLength:0,html:!0,focus:function(){return!1},select:function(z,B){n.setContact(B.item);h(!1);y.val("");return!1}}).data("ui-autocomplete")._renderItem=function(z,B){return d("<li />").addClass("ui-menu-item-html").append("<div>"+B.value+"</div>").appendTo(z)};y.on("focus",function(){y.data("uiAutocomplete").search(y.val())})})();n.setContact=function(y){var z=t.find(".js-user");y.photo_url&&z.find(".icon.size-24").css("background-image","url("+
y.photo_url+")");z.find(".c-name").text(y.name);w.val(y.id)}}function h(t){t?($wrapperContact.addClass("is-shown"),$wrapperContact.find(".js-autocomplete").focus()):$wrapperContact.removeClass("is-shown")}function m(){var t=q.find(".c-deal-wrapper"),w=q.find('[name="data[deal_id]"]'),x=q.find('[name="data[contact_id]"]'),y=t.find(".c-search-contact-wrapper"),z=t.find(".c-deal-item"),B=t.find(".js-autocomplete-deal");B.autocomplete({appendTo:y,position:{my:"right top",at:"right bottom"},source:d.crm.app_url+
"?module=autocompleteSidebar",minLength:0,html:!0,focus:function(){return!1},select:function(C,A){C=A.item;A=`<a class="flexbox middle c-user" href="javascript:void(0);">
                ${C.photo_url?`<span class="icon size-18 rounded js-open-search" style="background-image: url(${C.photo_url});"></span>`:""}
                <span class="c-user-name">&nbsp;${C.name}</span>
                </a>
                <div class="hint custom-pl-12 js-open-search cursor-pointer">
                    <span class="icon size-14"><i class="fas fa-pen" title="[\`edit\`]"></i></span>
                </div>`;y.addClass("is-hidden").removeClass("is-shown");z.html(A);C.photo_url?(x.val(C.id),w.val("")):(w.val(C.id),x.val(""));B.val("");y.find(".ui-autocomplete").hide();return!1}}).data("ui-autocomplete")._renderItem=function(C,A){return d("<li />").addClass("ui-menu-item-html").append("<div>"+A.value+"</div>").appendTo(C)};t.on("click",function(C){C=d(C.target);y.is(":visible")?C.closest(".js-reset-deal").length&&n.clearDeal():C.closest(".js-open-search").length&&(y.addClass("is-shown"),
B.focus())});n.clearDeal=function(){z.html("");y.removeClass("is-hidden is-shown");x.val("");w.val("")}}var n=this,p=n.$wrapper.find("#c-add-reminder-form"),q=p.find("form"),r=p.find(".js-textarea"),u=p.find(".c-hidden-form");$plus_icon=p.find(".c-icon-column");$wrapperContact=p.find(".js-contact-wrapper");extended_class="is-extended";is_locked=wrapper_is_open=!1;has_errors=is_first_click=!0;var v=q.serialize();r.on("focus",function(){n.$wrapper.find(".c-completed-reminders-section").hasClass("is-shown")||
(u.slideDown(300),p.addClass(extended_class),wrapper_is_open=!0,is_first_click&&(l($wrapperContact),m(),is_first_click=!1),d(document).on("click",b))});r.on("input",k);r.on("keydown",function(t){var w=t.keyCode;wrapper_is_open&&13===w&&!t.shiftKey&&(t.preventDefault(),t.stopPropagation(),a()?c():q.trigger("submit"))});$plus_icon.on("click",function(){wrapper_is_open?a()?c():q.trigger("submit"):r.focus()});p.on("click",".js-save",function(t){t.preventDefault();a()?c():q.trigger("submit")});p.on("click",
".js-cancel",function(t){t.preventDefault();e()});d(document).on("keydown",function(t){t.stopPropagation();if(!n.$wrapper.find(".c-completed-reminders-section").hasClass("is-shown")){var w=d(t.target),x=t.keyCode,y=27===x;13!==x||wrapper_is_open||(w=w.hasClass("c-text-field"),d(".c-step.is-edit.is-shown").length||w||(t.preventDefault(),r.focus()));y&&(t.preventDefault(),t.stopPropagation(),e(),d(".c-reminder-wrapper").trigger("escKeyPress"))}});(function(t){var w=t.find(".js-reminder-type-toggle"),
x=w.find(".js-type-field"),y=w.find(".menu");w.waDropdown();y.on("click","a",function(){var z=d(this);w.find(".js-text").html(z.html());y.find(".selected").removeClass("selected");z.closest("li").addClass("selected");z=z.data("type-id");x.val(z)})})(p);(function(){p.find(".js-datepicker").each(function(){var t=d(this);t.datepicker({changeMonth:!0,changeYear:!0,showOtherMonths:!0,selectOtherMonths:!0,gotoCurrent:!0});var w=t.parent(),x=w.find(".calendar");n.$date_clear=w.find(".js-reset-date");x.on("click",
function(){t.focus()});t.on("change",function(){this.style.width=0<this.value.length?7*this.value.length+"px":8*(this.getAttribute("placeholder").length+1)+"px";""!==t.val()&&w.addClass("is-active")});n.$date_clear.on("click",function(){t.val("");t.trigger("change");w.removeClass("is-active")})})})();(function(){function t(y){y?w.addClass("is-active"):w.removeClass("is-active")}var w=p.find(".js-time-toggle"),x=w.find(".js-timepicker");n.$time_clear=w.find(".js-reset-time");x.on("change",function(){t(!0);
""==x.val()&&t()});w.on("click",".js-show-time",function(){x.focus()});n.$time_clear.on("click",function(){x.val("");t()})})();(function(){p.find(".js-timepicker").each(function(){d(this).timepicker()})})();q.on("submit",function(t,w){t.preventDefault();is_locked||(is_locked=!0,t=f(),data=t.data,a()||(t.errors.length?(g(t.errors),is_locked=!1):($plus_icon.addClass("loading"),$plus_icon.html('<span class="icon size-20"><i class="fas fa-spinner fa-spin"></i></span>'),q.find(".js-save").attr("disabled",
!0),d.post("?module=reminder&action=add",data,function(x){"ok"===x.status?w||(n.$iframe?null:d.crm.sidebar.reload(),d.crm.content.reload()):console.error(x.errors)},"json").always(function(){is_locked=!1}))))})};CRMReminders.prototype.initLazyLoading=function(){function a(){function e(){var h=d.contains(document,$loader[0]);h?f($loader):($loader=$list.find(".js-lazy-load"),(h=d.contains(document,$loader[0]))?f($loader):l.off("scroll",e))}function f(h){var m=d(window).scrollTop(),n=k.height(),p=h.offset().top;
m+n>=p&&(c||g(h))}function g(h){var m=d.crm.app_url+"?module=reminder&action=actual"+((0<b.setting_deal_id?"&deal="+b.setting_deal_id:"")+(0<b.setting_contact_id?"&contact="+b.setting_contact_id:"")+(b.$iframe?"&iframe=1":""));data={user_id:b.user_id,page:++b.current_page};c=!0;d.post(m,data,function(n){b.click_reminder_event||(h&&h.remove(),$list.append(n),a())}).always(function(){c=!1})}var k=d(window),l=k;$list=b.$wrapper.find("#c-main-reminders-list");$loader=$list.find(".js-lazy-load");if($loader.length)if(0<
k.height())if(1==b.current_page&&k.height()>$list.height())e();else l.on("scroll",e);else setTimeout(()=>a(),100)}var b=this,c=!1;a()};CRMReminders.prototype.initCompletedReminders=function(){function a(){var t=m.width();k.width(t)}function b(){var t="?module=reminder&action=completed"+((0<g.setting_deal_id?"&deal="+g.setting_deal_id:"")+(0<g.setting_contact_id?"&contact="+g.setting_contact_id:"")),w={user_id:g.user_id};v=!0;n.append(q);p.hide();d.post(t,w,function(x){r=!0;l.html(x);f();n.children().last().remove();
p.show();d(window).trigger("scroll");c(!0)}).always(function(){v=!1})}function c(t,w){u?(setTimeout(()=>{h.hide();m.css("overflow","unset");g.$iframe||m.css("max-height","unset")},300),d(document).off("click",e)):(m.css("overflow","hidden"),g.$iframe||m.css("max-height","calc(100vh - 4rem)"),h.show(),d(document).on("click",e));w?(k.toggleClass("is-shown"),u=!u,l.slideToggle(300)):t?(k.addClass("is-shown"),u=!0,l.slideDown(300)):(k.removeClass("is-shown"),u=!1,l.slideUp(300))}function e(t){t.preventDefault();
(is_target=d.contains(k[0],t.target))||c(!1)}function f(){function t(){if(d.contains(document,x[0])){if(u){var z=x,B=l.scrollTop(),C=l.height(),A=z.offset().top;list_top=l.offset().top;B+C>=A-list_top&&(y||w(z))}}else l.off("scroll",t)}function w(z){var B="?module=reminder&action=completed"+((0<g.setting_deal_id?"&deal="+g.setting_deal_id:"")+(0<g.setting_contact_id?"&contact="+g.setting_contact_id:"")),C={user_id:g.user_id,min_dt:l.find("> li[data-datetime]:last").data("datetime")};y=!0;d.post(B,
C,function(A){z.remove();l.append(A);f()}).always(function(){y=!1})}d(window);var x=l.find(".js-lazy-load"),y=!1;if(x.length)l.on("scroll",t)}var g=this,k=g.$completedSection,l=k.find(".c-reminders-list"),h=g.$wrapper.find(".drawer"),m=g.$wrapper.find(".article-body"),n=k.find(".c-actions"),p=n.find(".sort-down"),q=d("<span/>").addClass("icon size-16").append("<i/>").addClass("fas fa-spinner wa-animation-spin speed-1000 text-gray"),r=!1,u=!1,v=!1;g.$iframe||(a(),d(window).on("resize",function(){a()}));
d(document).on("is_completed_loaded_false",function(t,w){if(w){w.new_text&&k.find(".js-completed-reminders-btn-text").text(w.new_text);k.hasClass("hidden")&&k.removeClass("hidden");t=w.state;var x=g.$sidebar.find(`[data-id='${w.user_id}'] .details`);w=g.$sidebar.find("[data-id='all'] .details");var y=x.find(".count.all"),z=w.find(".count.all");y.text(y.text()-1);z.text(z.text()-1);if("overdue"==t||"burn"==t)y=x.find(".count.overdue"),x=x.find(".count.burn"),y.length?(x=y.data("due-count"),z=+y.text(),
"overdue"==t?y.data("due-count",--x):null,y.text(--z),0>=x&&y.removeClass("overdue").addClass("burn"),0>=z&&y.remove()):x.length&&(y=+x.text(),x.text(--y),0>=y&&x.remove()),y=w.find(".count.overdue"),w=w.find(".count.burn"),y.length?(w=y.data("due-count"),x=+y.text(),"overdue"==t?y.data("due-count",--w):null,y.text(--x),0>=w&&y.removeClass("overdue").addClass("burn"),0>=x&&y.remove()):w.length&&(t=+w.text(),w.text(--t),0>=t&&w.remove())}else r=!1});k.on("click",".js-load-completed-reminders",function(t){t.preventDefault();
r||u?c(!1,!0):v||b()})};CRMReminders.prototype.initReopenReminder=function(){function a(e){if(!c){c=!0;var f={id:e};d.post("?module=reminder&action=markAsUndone",f,function(g){"ok"==g.status&&(f.id?d.crm.content.load(d.crm.app_url+"reminder/"+(b.user_id?b.user_id:"all")+"/?highlight_id="+f.id+(b.$iframe?"&iframe=1":"")+((0<b.setting_deal_id?"&deal="+b.setting_deal_id:"")+(0<b.setting_contact_id?"&contact="+b.setting_contact_id:"")),!1):d.crm.content.reload())}).always(function(){c=!1})}}var b=this,
c=!1;b.$wrapper.on("click",".js-reopen-reminder",function(e){e.preventDefault();e=d(this);var f=e.closest(".c-reminder-wrapper");e.addClass("is-loading");e.html('<span class="icon size-20"><i class="fas fa-spinner fa-spin"></i></span>');a(f.data("id"))})};CRMReminders.prototype.initTarget=function(){var a=this,b=d(window);if(!a.$iframe){var c=localStorage.getItem("scrollpos");c&&a.$sidebar.scrollTop(c)}d(document).ready(function(){a.$wrapper.find(".skeleton-wrapper").hide();setTimeout(function(){var e=
a.$wrapper.find(".c-reminder-wrapper.highlighted");if(e.length){var f=e.offset().top;target_h=e.height();viewportHeight=b.height();scrollIt=f-(viewportHeight-target_h)/2;d("html, body").animate({scrollTop:scrollIt+"px"},300)}},100);setTimeout(function(){var e=a.$wrapper.find(".c-reminder-wrapper.is-target");e.length&&(e=e.offset().top,b.scrollTop(e-50))},100)})};return CRMReminders}(jQuery),CRMReminder=function(d){CRMReminder=function(a){this.$wrapper=a.$wrapper;this.$marker=this.$wrapper.find(".c-marker");
this.marker_html=this.$marker.html();this.$steps=this.$wrapper.find(".c-step");this.$view=this.$steps.filter(".is-view");this.$edit=this.$steps.filter(".is-edit");this.$confirm=this.$steps.filter(".is-confirm");this.$textarea=this.$edit.find("textarea");this.$dots_button=this.$wrapper.find(".js-dots-wrapper");this.$dots_detail=this.$wrapper.find(".c-dots-detail");this.$main_wrapper=this.$wrapper.closest(".article-body");this.id=a.id;this.$iframe=a.iframe;this.current_page=a.current_page;this.user_id=
a.user_id;this.reminder_user_id=a.reminder_user_id;this.shown_class="is-shown";this.setting_contact_id=a.setting_contact_id;this.setting_deal_id=a.setting_deal_id;this.state=a.state;this.$activeContent=this.$view;this.xhr=!1;this.initClass();this.setPadding()};CRMReminder.prototype.initClass=function(){function a(c){c?b.$confirm.addClass("is-shown"):b.$confirm.removeClass("is-shown")}var b=this;b.$wrapper.on("click",function(c){c.preventDefault();b.$main_wrapper.find(".c-completed-reminders-section").hasClass("is-shown")||
(c=d(c.target),c.closest(".c-deal-wrapper a").length||(c.closest(".js-mark-done").length?b.setDone():c.closest(".js-confirm-delete").length?b.remove():c.closest(".js-remove").length?(a(!0),b.$dots_detail.hide()):(c.closest(".js-edit").length&&b.$dots_detail.hide(),c.closest(".js-confirm-cancel").length?a(!1):c.closest(".js-dots-wrapper").length?b.initDotsDetail():b.$edit.is(":visible")||(b.toggleContent(b.$edit),c.closest(".js-float-text").length&&b.$edit.find(".js-textarea").focus()))))});b.$wrapper.on("reminderIsChanged",
function(){b.toggleContent(b.$view);b.id?(d.crm.content.load(d.crm.app_url+"reminder/"+(b.user_id?b.user_id:"all")+"/?highlight_id="+b.id+(b.$iframe?"&iframe=1":"")+((0<b.setting_deal_id?"&deal="+b.setting_deal_id:"")+(0<b.setting_contact_id?"&contact="+b.setting_contact_id:"")),!0).done(function(){d(".c-reminders-list-loader").hide()}),d(document).off("is_completed_loaded_false"),d(window).off("resize")):d.crm.content.reload().done(function(){d(".c-reminders-list-loader").hide()})});b.$wrapper.on("reminderNotChanged",
function(){b.toggleContent(b.$view)});b.$wrapper.on("updatePadding",function(){b.setPadding(!0)})};CRMReminder.prototype.setPadding=function(a){var b=this.$wrapper;$quick_content=b.find(".js-quick-content-toggle-wrapper");0===$quick_content.height()||0===b.find(".c-footer").height()?$quick_content.css("padding-bottom","0"):a?$quick_content.css("padding-bottom","0.5rem"):null};CRMReminder.prototype.setDone=function(){var a=this,b=a.$wrapper,c=d(this);b.css("display","none");c.addClass("is-done");d(document).trigger("is_completed_loaded_false",
!1);c=a.id;href="?module=reminder&action=markAsDone"+((0<a.setting_deal_id?"&deal="+a.setting_deal_id:"")+(0<a.setting_contact_id?"&contact="+a.setting_contact_id:""));data={id:c,user_id:a.user_id?a.user_id:"all"};is_locked=!0;d.post(href,data,function(e){"ok"===e.status?(e=e?.data?.completed_title,b.remove(),a.$iframe||d.crm.sidebar.reload(),d(document).trigger("is_completed_loaded_false",{user_id:a.reminder_user_id,state:a.state,new_text:e}),d(window).trigger("scroll")):b.css("display","")}).always(function(){is_locked=
!1})};CRMReminder.prototype.initDotsDetail=function(){function a(e){var f=d(e.target);e=!!f.closest(".c-dots-detail").length;f=!!f.closest(".js-dots-wrapper").length;e||f||b.$dots_detail.hide()}var b=this;b.$dots_detail.toggle();const c=b.$dots_detail.height();(function(e){e=e.getBoundingClientRect();return window.innerHeight-e.bottom})(b.$dots_button[0])<c+30?b.$dots_detail.css("bottom","38px"):b.$dots_detail.css("bottom","-"+(c+8)+"px");if(b.$dots_detail.is(":visible"))d(document).on("click",a);
else d(document).off("click",a)};CRMReminder.prototype.remove=function(){var a=this,b={id:a.id};a.xhr&&a.xhr.abort();a.xhr=d.post("?module=reminder&action=delete",b,function(c){"ok"===c.status&&(a.$wrapper.remove(),d.crm.content.reload(),a.$iframe?null:d.crm.sidebar.reload())}).always(function(){a.xhr=!1})};CRMReminder.prototype.toggleContent=function(a){this.$activeContent.length&&this.$activeContent.removeClass(this.shown_class);a.addClass(this.shown_class);this.$activeContent=a;a.focus();this.$edit===
a?this.$wrapper.trigger("editOpen").addClass("editOpen"):this.$wrapper.removeClass("editOpen")};return CRMReminder}(jQuery),CRMCompletedReminder=function(d){CRMCompletedReminder=function(a){this.$wrapper=a.$wrapper;this.$marker=this.$wrapper.find(".c-marker");this.marker_html=this.$marker.html();this.reminder_id=a.reminder_id;this.initClass()};CRMCompletedReminder.prototype.initClass=function(){this.initQuickContentEdit()};CRMCompletedReminder.prototype.initQuickContentEdit=function(){function a(){if(!l){l=
!0;c.renderLoading(!0);var h=f.serializeArray();d.post("?module=reminder&action=save",h,function(m){"ok"===m.status&&(k=!1,g.removeClass("is-changed").blur())}).always(function(){l=!1;c.renderLoading(!1)})}}function b(){g.css("min-height",0);g.css("min-height",g[0].scrollHeight+"px")}var c=this,e=c.$wrapper.find(".js-top-content-toggle-wrapper");0===e.height()&&e.css("padding-bottom","0");if(!e.length)return!1;var f=e.find("form"),g=f.find(".js-textarea"),k=!1,l=!1;g.on("keyup",function(h){g.val().length?
k||=!0:k=!1});g.on("input",b);g.on("keydown",function(h){13!==h.keyCode||h.shiftKey||(h.preventDefault(),k&&a())});g.on("blur",function(){k&&a()});setTimeout(()=>{g.length&&b()},300)};CRMCompletedReminder.prototype.renderLoading=function(a){var b=this.$marker;a?(b.addClass("is-load"),b.html('<i class="fas fa-spinner fa-spin"></i>')):(b.removeClass("is-load"),b.html(this.marker_html))};return CRMCompletedReminder}(jQuery),CRMReminderSettingsDialog=function(d){CRMReminderSettingsDialog=function(a){this.$wrapper=
a.$wrapper;this.$form=this.$wrapper.find("form");this.$button=this.$wrapper.find(".js-submit-button");this.$options=this.$wrapper.find(".js-options-list");this.$groups=this.$wrapper.find(".js-group-list");this.$select=this.$wrapper.find(".js-select-list");this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMReminderSettingsDialog.prototype.initClass=function(){var a=this;a.$form.on("change","input",function(){a.toggleButton(!0)});a.$options.on("change","input",function(){var b=d(this),c=
b.val();"checked"===b.attr("checked")&&("groups"===c?a.$groups.show():a.$groups.hide());a.dialog.resize()});a.$form.on("change",".daily-recap",function(){var b=d(this)["0"].checked,c=a.$select,e=d(".crm-reminders-recap-error");b?(c.attr("disabled",!1),e.length&&(d(e).fadeIn(),a.dialog.resize())):(c.attr("disabled",!0),e.length&&(d(e).fadeOut(),a.dialog.resize()))});a.$form.on("change",".js-pop-up-disabled",function(){var b=d(this),c=a.$wrapper.find(".js-pop-up-min");b.is(":checked")?(c.prop("readonly",
!1),c.focus()):c.prop("readonly",!0)});a.initSave()};CRMReminderSettingsDialog.prototype.initSave=function(){function a(){e||(e=!0,d(".js-submit-button").prop("disabled",!0),d.post("?module=reminder&action=settingsSave",c.serializeArray(),function(g){"ok"===g.status&&("my"==b.$options.find(":checked").val()?d.crm.content.load(d.crm.app_url+"reminder/"):setTimeout(function(){b.dialog.close();d.crm.content.reload()},1E3))},"json").always(function(){b.toggleButton(!1);e=!1}))}var b=this,c=b.$form,e=
!1,f=b.$wrapper.find(".js-pop-up-disabled");d(".js-submit-button").on("click",function(){f.is(":checked")?0<parseInt(d(".js-pop-up-min").val())?a():d(".enter-minutes").fadeIn().delay("2000").fadeOut():a()})};CRMReminderSettingsDialog.prototype.toggleButton=function(a){var b=this.$button;a?b.addClass("yellow"):b.removeClass("yellow")};return CRMReminderSettingsDialog}(jQuery),CRMReminderSettings=function(d){CRMReminderSettings=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".js-submit-button");
this.$options=this.$wrapper.find(".js-options-list");this.$groups=this.$wrapper.find(".js-group-list");this.$select=this.$wrapper.find(".js-select-list");this.$wrapper.data("instance",this);this.initClass()};CRMReminderSettings.prototype.initClass=function(){var a=this;a.$options.on("change","input",function(){var b=d(this),c=b.val();"checked"===b.attr("checked")&&("groups"===c?a.$groups.show():a.$groups.hide())});a.$wrapper.on("change",".daily-recap",function(){var b=d(this)["0"].checked,c=a.$select,
e=d(".crm-reminders-recap-error");b?(c.attr("disabled",!1),e.length&&d(e).fadeIn()):(c.attr("disabled",!0),e.length&&d(e).fadeOut())});a.$wrapper.on("change",".js-pop-up-disabled",function(){var b=d(this),c=a.$wrapper.find(".js-pop-up-min");b.is(":checked")?(c.prop("readonly",!1),c.focus()):c.prop("readonly",!0)})};CRMReminderSettings.prototype.validateBeforeSave=function(){return this.$wrapper.find(".js-pop-up-disabled").is(":checked")&&0>=parseInt(d(".js-pop-up-min").val())?(d(".enter-minutes").fadeIn().delay("2000").fadeOut(),
!1):!0};return CRMReminderSettings}(jQuery);var CRMLogLive=function(d){var a=function(c){a=function(e){this.list_name=e.names.list;this.items_name=e.names.items;this.pagind_name=e.names.paging;this.log=e.log;this.$wrapper=e.$wrapper||!1;this.$list=this.$wrapper.find(this.list_name);this.$window=c(window);this.onLoad=e.onLoad||function(){};this.$paging=this.$wrapper.find(this.pagind_name);this.is_locked=this.xhr=!1;this.addWatcher()};a.prototype.addWatcher=function(){function e(){var k=window&&c.contains(document,f.$paging[0]);k&&g&&window.frameElement&&
(k=c.contains(g.document,window.frameElement));if(k)f.onScroll();else f.$window.off("scroll",e),c(g).off("scroll",e)}var f=this,g=window.parent;f.$window.on("scroll",e);if(g&&window.frameElement)c(g).on("scroll",e)};a.prototype.onScroll=function(){var e=this.$window,f=e.scrollTop();e=e.height();var g=this.$paging.offset().top;if(window.parent&&window.frameElement){var k=c(window.parent);e=k.height();f+=k.scrollTop();g+=c(window.frameElement).offset().top}f+e>=g&&!this.is_locked&&(this.is_locked=!0,
this.loadNextPage())};a.prototype.loadNextPage=function(){var e=this,f=e.log.filtersData.slice(0);f.push({name:"max_id",value:e.$paging.data("max-id")});f.push({name:"timestamp",value:e.$list.find(e.items_name).last().data("timestamp")});e.xhr&&e.xhr.abort();e.xhr=c.get("?module=logLive",f,function(g){var k=c("<div id='c-temp-wrapper' />");e.log.$wrapper.after(k);k.html(g);g=k.find(e.list_name+" "+e.items_name);k=k.find(e.pagind_name);e.$list.append(g);e.$paging.after(k);e.$paging.remove();e.$paging=
k;e.is_locked=!1;e.onLoad()})};return a}(jQuery),b=function(c){function e(l,h){var m=l.offsetWidth;l=l.offsetHeight;return{outer_width:m,outer_height:l,inner_width:m-h.left-h.right,inner_height:l-h.top-h.bottom}}function f(l){function h(t){var w=t.split("-");t=parseInt(w[0]);var x=parseInt(w[1])-1;w=parseInt(w[2]);return new Date(t,x,w)}var m=[];l=function(t){function w(x,y){var z=x.split("-");x=parseInt(z[0]);var B=parseInt(z[1])-1;z=parseInt(z[2]);B=new Date((new Date(x,B,z)).getTime()+(y?864E5:
-864E5));y=parseInt(B.getFullYear());x=parseInt(B.getMonth())+1;B=parseInt(B.getDate());10>B&&(B="0"+B);10>x&&(x="0"+x);return[y,x,B].join("-")}1===t[0].data.length&&c.each(t,function(x){var y=t[x].data[0],z={value:0,date:w(y.date,!1)},B={value:0,date:w(y.date,!0)};t[x].data=[z,y,B]});return t}(l);for(var n=0;n<l.length;n++){for(var p=l[n].data,q=[],r=0;r<p.length;r++){var u=p[r],v=parseInt(u.value);q.push({date:h(u.date),value:v})}m.push(q)}return d3.layout.stack().offset("zero").values(function(t){return t}).x(function(t){return t.date}).y(function(t){return t.value})(m)}
function g(l,h,m){var n=null;m+=1;l&&m&&(n=(l-h*(m-1))/m,1>n&&(n=1));return n}function k(l,h){var m=h[0];h=h[1]||1;m=h-m+(1<h-m?0:1);h=m/(l-1);for(var n=[],p=0;p<l;p++){var q=10<m?Math.round(p*h):parseInt(p*h*10)/10;n.push(q)}return n}b=function(l){this.$wrapper=l.$wrapper;this.$hint=this.$wrapper.find(".js-hint-wrapper");this.node=this.$wrapper.find(".js-chart-wrapper")[0];this.d3node=d3.select(this.node);this.show_class="is-shown";this.charts=l.data;this.data=f(this.charts);this.group_by=l.group_by;
this.locales=l.locales;this.margin={top:14,right:10,bottom:28,left:34};this.area=e(this.node,this.margin);this.column_indent=200<this.data[0].length?2:4;this.column_width=g(this.area.inner_width,this.column_indent,this.data[0].length);this.yAxis=this.xAxis=this.yDomain=this.xDomain=this.y=this.x=this.defs=this.svg=!1;this.initGraph()};b.prototype.initGraph=function(){var l=this,h=l.area;l.initGraphCore();200<l.data[0].length&&l.$wrapper.addClass("is-large");l.svg=l.d3node.append("svg").attr("width",
h.outer_width).attr("height",h.outer_height);l.renderBackground();l.renderCharts();l.renderAxis();setTimeout(function(){function m(){c.contains(document,l.$wrapper[0])?l.update():c(window).off("resize",m)}c(window).on("resize",m)},4)};b.prototype.initGraphCore=function(){var l=this.data,h=this.area,m=this.x=d3.time.scale().range([0,h.inner_width]);h=this.y=d3.scale.linear().range([h.inner_height,0]);this.yDomain=function(){var n=d3.min(l,function(q){return d3.min(q,function(r){return r.value})});
0<n&&(n=0);var p=d3.max(l,function(q){return d3.max(q,function(r){return r.value+r.y0})});return[n,p]}();this.xDomain=function(){var n=l[0][0].date;var p=l[0][l[0].length-1].date;var q=parseInt((l[0][1].date.getTime()-n.getTime())/2);n=new Date(n.getTime()-q);p=new Date(p.getTime()+q);return[n,p]}();m.domain(this.xDomain);h.domain(this.yDomain)};b.prototype.renderAxis=function(){var l=this.x,h=this.y,m=this.svg;this.xAxis=d3.svg.axis().scale(l).orient("bottom").ticks(10);this.yAxis=d3.svg.axis().scale(h).innerTickSize(2).orient("right").tickValues(k(6,
this.yDomain)).tickFormat(function(n){return n+""});l=m.append("g").attr("class","axis");l.append("g").attr("transform","translate(10,"+this.margin.top+")").attr("class","y").call(this.yAxis);l.append("g").attr("class","x").attr("transform","translate("+this.margin.left+","+(this.area.outer_height-this.margin.bottom)+")").call(this.xAxis)};b.prototype.renderBackground=function(){var l=this.area.inner_width,h=this.area.inner_height,m,n=this.svg.append("g").attr("class","background").attr("transform",
"translate("+this.margin.left+","+this.margin.top+")");n.append("rect").attr("width",l).attr("height",h);for(m=0;5>=m;m++){var p=1+(h-2)/5*m;n.append("line").attr("x1",1).attr("x2",l).attr("y1",p).attr("y2",p)}};b.prototype.renderCharts=function(){var l=this,h=l.data;h=l.svg.selectAll(".c-graph-wrapper").data(h);h.enter().append("g").attr("class","c-graph-wrapper").attr("transform","translate("+l.margin.left+","+l.margin.top+")");var m=h.selectAll(".rect").data(function(n){return n});m.enter().append("rect").attr("class",
"rect").style("fill",function(n,p,q){return(n=l.charts[q].color)?n:!1}).on("mouseover",function(n,p,q){l.showHint(d3.event,this,n,l.charts[q])}).on("mousemove",function(){l.moveHint(this)}).on("mouseout",function(){l.hideHint()});m.transition().duration(1E3).attr("x",function(n,p){return l.x(n.date)-l.column_width/2}).attr("y",function(n){return l.y(n.y0)+l.y(n.value)-l.area.inner_height}).attr("height",function(n){return l.area.inner_height-l.y(n.value)}).attr("width",l.column_width);m.exit().remove();
h.exit().remove()};b.prototype.update=function(l){if(!l)return!1;this.data=f(l.chart);this.group_by=l.group_by||"days";this.area=e(this.node,this.margin);this.column_indent=200<this.data[0].length?2:4;this.column_width=g(this.area.inner_width,this.column_indent,this.data[0].length);this.svg.attr("width",this.area.outer_width).attr("height",this.area.outer_height);200<this.data[0].length?this.$wrapper.addClass("is-large"):this.$wrapper.removeClass("is-large");this.initGraphCore();this.yAxis.scale(this.y).tickValues(k(6,
this.yDomain));this.svg.selectAll(".axis .y").transition().duration(600).call(this.yAxis);this.xAxis.scale(this.x);this.svg.selectAll(".axis .x").transition().duration(600).call(this.xAxis);this.renderCharts()};b.prototype.showHint=function(l,h,m,n){var p=this;l=c(h);if(!(0<Math.ceil(l.attr("height"))))return!1;var q=m.date;h=p.$hint.find(".c-date");var r=p.$hint.find(".c-app"),u=p.$hint.find(".c-value");q=function(v,t){var w=parseInt(v.getMonth());"months"==t?(v=p.locales.months,v[w]||(v="\u042f\u043d\u0432\u0430\u0440\u044c \u0424\u0435\u0432\u0440\u0430\u043b\u044c \u041c\u0430\u0440\u0442 \u0410\u043f\u0440\u0435\u043b\u044c \u041c\u0430\u0439 \u0418\u044e\u043d\u044c \u0418\u044e\u043b\u044c \u0410\u0432\u0433\u0443\u0441\u0442 \u0421\u0435\u043d\u0442\u044f\u0431\u0440\u044c \u041e\u043a\u0442\u044f\u0431\u0440\u044c \u041d\u043e\u044f\u0431\u0440\u044c \u0414\u0435\u043a\u0430\u0431\u0440\u044c".split(" ")),
w=v[w]):(t=v.getDate(),w+=1,w=(10>t?"0"+t:t)+"."+(10>w?"0"+w:w)+"."+v.getFullYear());return w}(q,p.group_by);h.text(q);r.text(n.name);u.text(m.value);m=function(v){var t=c(window),w=t.width();t.height();t=p.$hint.outerWidth();var x=p.$hint.outerHeight(),y=Math.ceil(v.attr("width")),z=Math.ceil(v.attr("height")),B=p.$wrapper.offset();v=v.offset();x={left:v.left-B.left+y+10,top:v.top-B.top+(z<x?z-x-2:2)};w<v.left+10+t&&(x.left=v.left-B.left-y-t);return x}(l);p.$hint.css(m).addClass(p.show_class)};b.prototype.moveHint=
function(){};b.prototype.hideHint=function(){this.$hint.removeAttr("style").removeClass(this.show_class)};return b}(jQuery);CRMLogLive=function(c){this.$wrapper=c.$wrapper;this.$filtersForm=this.$wrapper.find("form.js-filters-form");this.chartData=c.chartData;this.chartParams=c.chartParams;this.locales=c.locales;this.chart=!1;this.filtersData=this.$filtersForm.serializeArray();this.initClass()};CRMLogLive.prototype.initClass=function(){this.initLogList();this.initDateFilter();this.initChart()};CRMLogLive.prototype.initLogList=
function(){function c(){e.find(".c-activity-item.is-first").each(function(){var f=d(this).prev().prev();f.hasClass("is-last")||f.addClass("is-last")})}var e=this.$wrapper.find("#c-activity-section");c();new a({$wrapper:e,names:{list:".c-activity-list",items:"> li",paging:".c-paging-wrapper"},log:this,onLoad:c})};CRMLogLive.prototype.initDateFilter=function(){function c(u){var v=u.data("timeframe"),t=u.data("group")||"days";n.html(u.find("a").html());r.length&&r.removeClass("selected");r=u.addClass("selected");
l.hide();setTimeout(function(){l.removeAttr("style")},200);m.val(v);h.val(t);"custom"!==v?(p.removeClass("is-shown"),e()):p.addClass("is-shown")}function e(){var u=k.serializeArray();u.push({name:"chart",value:1});d.post("?module=logLive",u,function(v){"ok"==v.status&&(v=v.data,v.group_by=h.val(),f.chart.update(v))},"json").always(function(){q=!1})}var f=this,g=f.$wrapper.find(".js-dates-filter"),k=g.find("form"),l=g.find(".js-list"),h=g.find(".js-group-field"),m=g.find(".js-timeframe-field"),n=g.find(".js-link-text"),
p=g.find(".js-hidden-part"),q=!1,r=l.find(".selected");l.on("click",".js-toggle",function(u){u.preventDefault();c(d(this))});k.on("submit",function(u){u.preventDefault();q||(q=!0,e())});(function(){g.find(".js-datepicker").each(function(){var u=d(this),v=g.find("."+u.data("selector"));u.datepicker({altField:v,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0})})})()};CRMLogLive.prototype.initChart=function(){var c=this.$wrapper.find(".js-chart-section");c.length&&this.chartData&&this.chartData.length&&
(this.chart=new b({$wrapper:c,data:this.chartData,group_by:this.chartParams.group_by,locales:this.locales}))};return CRMLogLive}(jQuery),CRMLogLiveItem=function(d){CRMLogLiveItem=function(a){this.$wrapper=a.$wrapper;this.initClass()};CRMLogLiveItem.prototype.initClass=function(){d.crm.renderSVG(this.$wrapper);this.$wrapper.data("logLiveItem",this)};return CRMLogLiveItem}(jQuery);var CRMCallPage=function(d){CRMCallPage=function(a){this.$wrapper=a.$wrapper;this.call_ts=a.call_ts;this.locales=a.locales;this.iframe=a.iframe;this.is_lazy_load=a.is_lazy_load;this.current_page=a.current_page;this.numbers_assigned=a.numbers_assigned;this.started_contact=a.contact;this.started_deal=a.deal;this.href_prop="";this.initClass()};CRMCallPage.prototype.initClass=function(){d.wa_push&&d.wa_push.init();this.initRedirectCall();this.initDeleteCall();this.numbers_assigned&&d.wa_push&&d.wa_push.init();
this.initAssociateDeal();this.initBackgroundReload();this.initFinishCallLinks();this.initLazyLoading();this.initCustomAudioPlayer();this.initDotsDetail();this.iframe||this.is_lazy_load||(this.initContactUpdateDialog(),this.initContactCreateDialog(),this.initFilterDrawer())};CRMCallPage.prototype.initContactCreateDialog=function(){function a(c){d.waDialog({html:`<div class="dialog" id="call-create-contact-dialog">
                <div class="dialog-background"></div>
                <div class="dialog-body" style="width: 761px">
                    
                    <div class="dialog-content" style="padding: 0;">
                        <iframe src="${d.crm.app_url+"frame/contact-new/?phone="+c}" frameborder="0" style="height: 94vh; width: 100%;">
                        </iframe>
                    </div>
                </div>
                </div>`,onOpen:function(e,f){e.find(".dialog-body").css("top","2.5%");e.find(".dialog-content").css("min-height","95vh")}})}var b=this;b.escapeHtml=function(c){return c.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")};b.$wrapper.on("click",".js-show-create-dialog",function(c){c.preventDefault();c=b.escapeHtml(""+d(c.target).data("number"));a(c)})};CRMCallPage.prototype.initContactUpdateDialog=function(){function a(c,e){b||
(b=!0,d.post(d.crm.app_url+"?module=contact&action=updateDialog",{call_id:c},function(f){d.waDialog({html:f,onClose:function(g,k){g=g.$content.find(".js-field-autocomplete");g.data("success")&&(g=g.html(),e.closest(".c-column-phone").find(".c-user-wrapper .flexbox.middle.space-8").html(g))}})}).always(function(){b=!1}))}var b=!1;this.$wrapper.on("click",".js-show-update-dialog",function(c){c.preventDefault();c=d(c.target);const e=c.data("id");a(e,c)})};CRMCallPage.prototype.initFilterDrawer=function(){function a(){p.show();
d("#wa-app").addClass("content-on-top");setTimeout(()=>{p.removeClass("is-hide");B?null:d("body").addClass("is-locked").css("padding-right","17px")},50)}function b(){p.addClass("is-hide");setTimeout(()=>{p.hide();d("body").removeClass("is-locked").css("padding-right","");d("#wa-app").removeClass("content-on-top")},300)}function c(A=!1){var D=q.serializeArray();D.forEach((G,H)=>{if(""!==G.value&&"null"!==G.value){if(4===H&&"custom"===G.value){var I=p.find(".js-datepicker");""===I.eq(0).val()&&(D[5].value=
"");""===I.eq(1).val()&&(D[6].value="")}h.href_prop=h.href_prop+(0==H?"":"&")+G.name+"="+G.value}});d.crm.content.load(d.crm.app_url+"call/?"+h.href_prop);var E=d("<span/>").addClass("icon size-20").append("<i/>").addClass("fas fa-spinner wa-animation-spin speed-1000 ");if(A)m.prop("disabled",!0).append(E);else{var F=p.find(".c-filter-buttom");F.append(E);F.children().each(function(){d(this).prop("disabled",!0)});d(document).one("wa_loaded",function(){E.remove();F.children().each(function(){d(this).prop("disabled",
!1)});b()})}}function e(A){var D=p.find(`#dropdown-directions-filter [data-filter='${A[0].value}']`),E=p.find(`#dropdown-states-filter [data-filter='${A[1].value}']`),F=p.find(`#dropdown-responsible-filter [data-filter='${A[7].value}']`),G=p.find(`#dropdown-date-filter [data-timeframe='${A[4].value}']`),H=q.serializeArray(),I=p.find(".js-datepicker"),K=p.find("#switch-deal-off");D.trigger("click");E.trigger("click");F.trigger("click");""===A[2].value?g():f(h.started_contact,A[2].value,w,r);""===A[3].value||
"0"===A[3].value?l():k(h.started_deal,A[3].value);A[3].value===H[3].value||"0"!==H[3].value&&"0"!==A[3].value||K.trigger("click");I.eq(0).datepicker("setDate",new Date(A[5].value));I.eq(1).datepicker("setDate",new Date(A[6].value));G.trigger("click")}function f(A,D,E,F){var G=A.name;A=`<div class="c-user-wrapper">
                    <div class="flexbox space-8">
                        <div class="c-column c-column-image">
                            <div class="flexbox middle">
                                <img src="${A.userpic}" alt="${G}">
                            </div>
                        </div>
                    <div class="c-column nowrap">
                            <div class="c-column--name">${G}</div>
                            <div class="c-jobtitle hint">${F.val()&&A.email?A.email:""}</div>
                            <div class="c-jobtitle hint">${F.val()&&A.phone?A.phone:""}</div>
                    </div>
                    </div>
                </div>
                <span class="icon cursor-pointer js-call-filter-contact-cancel"><i class="fas fa-times-circle"></i></span>`;p.find("#input-contact").val(D);F.val()?F.val(""):null;E.html(A);F.hide()}function g(){r.show();w.html("");p.find("#input-contact").val("")}function k(A,D){var E=h.escapeHtml(A.name);A=`
                <div class="c-deal-wrapper nowrap">
                <div class="flexbox space-8 ">
                    <i class="fas fa-circle" style="color: ${A.stage?A.stage.color:""}"></i>
                </div>
                <div>
                    <div class="c-deal-wrapper--name">${E}</div>
                    <div>
                        <span class="hint">${A.create_datetime?A.create_datetime.split(" ")[0]:""}</span>
                        ${A.closed_datetime?"<span> - </span>":""}
                        <span class="hint">${A.closed_datetime?A.closed_datetime.split(" ")[0]:""}</span>
                    </div>
                    <div class="hint">${A.amount?Math.ceil(+A.amount):""} ${A.currency_id}</div>   
                </div>
            </div>
                <span class="icon js-call-filter-deal-cancel"><i class="fas fa-times-circle"></i></span>`;p.find("#input-deal").val(D);v.val("");x.html(A);v.hide()}function l(){v.show();x.html("");p.find("#input-deal").val("")}var h=this,m=h.$wrapper.find(".js-filter-button"),n=h.$wrapper.find(".js-reload-filter-button"),p=h.$wrapper.find(".c-call-filter"),q=p.find(".c-call-filter-form"),r=p.find(".js-search-field-contact"),u=r.parent(),v=p.find(".js-search-field-deal"),t=v.parent(),w=p.find(".js-call-filter-contact"),
x=p.find(".js-call-filter-deal"),y=q.serializeArray(),z=q.serialize(),B=h.$wrapper.height()<d(".content.blank.c-shadowed-content").height(),C=[{name:"direction",value:"all"},{name:"status",value:"ALL"},{name:"contact",value:""},{name:"deal",value:""},{name:"timeframe",value:"null"},{name:"start",value:""},{name:"end",value:""},{name:"user",value:""}];m.on("click",function(A){A.preventDefault();a()});n.on("click",function(A){A.preventDefault();n.find("svg").removeClass("fa-times").addClass("fa-spinner fa-spin");
d.crm.content.load(d.crm.app_url+"call/?direction=all&status=ALL")});p.on("click",".js-close-drawer",function(A){A.preventDefault();b()});p.on("click",".js-apply-filter",function(A){A.preventDefault();c()});p.on("click",".js-reset-filter",function(A){A.preventDefault();"direction=all&status=ALL&timeframe=null&deal=&contact=&start=&end="!==q.serialize()&&e(C)});p.on("click",".js-restore-filter",function(A){A.preventDefault();z!==q.serialize()&&e(y);b()});p.on("click",".js-call-filter-contact-cancel",
function(A){A.preventDefault();g()});p.on("click",".js-call-filter-deal-cancel",function(A){A.preventDefault();l()});(function(){var A=h.$wrapper.find(".js-search-field-client"),D=A.parent();$search_contact_wrapper=h.$wrapper.find(".js-call-filter-search");$search_contact_cancel=h.$wrapper.find(".c-call-filter-contact .js-call-filter-contact-cancel");A.autocomplete({appendTo:D,source:d.crm.app_url+"?module=autocompleteContact&with_email=1&with_phone=1",minLength:0,html:!0,focus:function(){return!1},
select:function(E,F){f(F.item,F.item.id,$search_contact_wrapper,D);c(!0);return!1}}).data("ui-autocomplete")._renderItem=function(E,F){return d("<li />").addClass("ui-menu-item-html").append("<div><span class='icon userpic custom-mr-4'><i style='background-image: url("+F.userpic+");'></i></span>"+F.name+"</div>").appendTo(E)};$search_contact_cancel.on("click",function(E){E.preventDefault();D.show();$search_contact_wrapper.html("")})})();r.autocomplete({appendTo:u,source:d.crm.app_url+"?module=autocompleteContact&with_email=1&with_phone=1",
minLength:0,html:!0,focus:function(){return!1},select:function(A,D){f(D.item,D.item.id,w,r);return!1}}).data("ui-autocomplete")._renderItem=function(A,D){return d("<li />").addClass("ui-menu-item-html").append("<div class='flexbox'><span class='icon userpic custom-mr-4'><i style='background-image: url("+D.userpic+");'></i></span>"+D.name+"</div>").appendTo(A)};v.autocomplete({appendTo:t,source:d.crm.app_url+"?module=autocompleteDeal",minLength:0,html:!0,focus:function(){return!1},select:function(A,
D){k(D.item,D.item.id);return!1}}).data("ui-autocomplete")._renderItem=function(A,D){return d("<li />").addClass("ui-menu-item-html").append("<div>"+h.escapeHtml(D.name)+"</div>").appendTo(A)};(function(){p.find(".js-datepicker").each(function(){var A=d(this),D=p.find("."+A.data("selector"));A.datepicker({altField:D,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0})})})()};CRMCallPage.prototype.initDownloadLink=function(){$records_array=this.$wrapper.find(".c-call-wrapper .c-call-record-link");setTimeout(function(){$records_array.eq(0).trigger("click")},
2E3)};CRMCallPage.prototype.initCustomAudioPlayer=function(){let a=null;this.$wrapper.on("click",".c-call-record-link",function(b,c){var e=d(this);play=e.find(".play").length||null;loading=e.find(".loading").length||null;pause=e.find(".pause").length||null;$call_wrapper=e.closest(".c-call-wrapper");$call_id=$call_wrapper.data("id");$column_audio=$call_wrapper.find(".c-column-audio");$progressbar_new=$call_wrapper.find("#c-audio-slider");$progressbar_item=$progressbar_new[0];$duration=$call_wrapper.find(".c-audio-duration");
$current_time=$call_wrapper.find(".c-audio-current-time");let f=null;const g=k=>{const l=Math.floor(k%60);return`${Math.floor(k/60)}:${10>l?`0${l}`:`${l}`}`};if(loading||pause){id=setInterval(k,50);function k(){var h=e.find("audio");h.length&&0<h[0].readyState&&l(h)}function l(h){clearTimeout(a);clearInterval(id);var m=h[0];$column_audio.slideDown(200);$duration.text(g(m.duration));$progressbar_item.max=Math.floor(m.duration);$progressbar_new.on("input",p=>{$current_time.text(g($progressbar_item.value));
p=p.target;$column_audio[0].style.setProperty("--seek-before-width",p.value/p.max*100+"%");cancelAnimationFrame(f)});$progressbar_new.on("input",()=>{m.currentTime=$progressbar_item.value;requestAnimationFrame(n)});const n=()=>{$progressbar_item.value=Math.floor(m.currentTime);$current_time.text(g($progressbar_item.value));$column_audio[0].style.setProperty("--seek-before-width",`${$progressbar_item.value/$progressbar_item.max*100}%`);f=requestAnimationFrame(n);m.currentTime==m.duration&&(cancelAnimationFrame(f),
a=setTimeout(()=>$column_audio.slideUp(200),3E3))};h=()=>{const p=Math.floor(m.buffered.end(m.buffered.length-1));$column_audio[0].style.setProperty("--buffered-width",`${p/$progressbar_item.max*100}%`)};m.addEventListener("progress",h);h();requestAnimationFrame(n)}}play&&(a=setTimeout(()=>$column_audio.slideUp(200),3E3),$progressbar_new.off("change"),$progressbar_new.off("input"),cancelAnimationFrame(f))})};CRMCallPage.prototype.initDotsDetail=function(){var a=this;a.$wrapper.on("click",".js-dots",
function(b){$detail=d(this).siblings(".c-dots-detail");$detail_wrapper=$detail.closest(".js-dots-wrapper");$detail.toggle();$detail_wrapper.toggleClass("open");var c=$detail.height();b=$detail.width();let e=$detail_wrapper[0].getBoundingClientRect();window.innerHeight-e.bottom<c+30?$detail.css("bottom","30px"):$detail.css("bottom","unset");c=$detail_wrapper[0].getBoundingClientRect();window.innerWidth-c.left>b+30?$detail.css("left","0"):$detail.css("right","0")});d(document).on("click",function(b){var c=
d(b.target),e=a.$wrapper.find(".js-dots-wrapper.open");c=!!c.closest(".c-dots-detail").length;e.length&&!c&&e.each(function(){d.contains(d(this)[0],b.target)||(d(this).removeClass("open"),d(this).find(".c-dots-detail").hide())})})};CRMCallPage.prototype.initFinishCallLinks=function(){this.$wrapper.on("click",".js-finish-call",function(a){var b=d(this);a=d.crm.app_url+"?module=call&action=finish";var c=b.closest(".c-call-wrapper"),e=c.data("id");0>=e||b.data("loading")||(b.data("loading",1),b.find(".loading").show(),
b.find(".yes-bw").hide(),d.post(a,{id:e},function(f){if("ok"===f.status){f=d("<div>").html(f.data.html);var g=f.find('.c-call-wrapper[data-id="'+e+'"]').find(".c-column-state");c.find(".c-column-state").replaceWith(g);f.remove()}else b.data("loading",0),b.find(".loading").hide(),b.find(".yes-bw").show()}).error(function(){b.data("loading",0);b.find(".loading").hide();b.find(".yes-bw").show()}))})};CRMCallPage.prototype.initRedirectCall=function(){this.$wrapper.on("click",".js-redirect-call",function(a){a=
d(this).parents(".c-call-wrapper").data("id");a=d.crm.app_url+"?module=call&action=redirectDialog&id="+a;var b=d(this);b.prop("disabled",!0).find(".svg-inline--fa").removeClass("fa-exchange-alt").addClass("fa-spinner fa-spin");d.get(a,function(c){d.waDialog({html:c,onOpen:function(){b.prop("disabled",!1).find(".svg-inline--fa").removeClass("fa-spinner fa-spin").addClass("fa-exchange-alt")}})})})};CRMCallPage.prototype.initDeleteCall=function(){function a(e){var f=e.find(".c-delete-call"),g=f.closest(".c-call-wrapper"),
k=g.data("id");e=f.data("title");d.waDialog.confirm({title:`<i class=\"fas fa-exclamation-triangle smaller state-error\"></i> ${e}?`,text:b.locales.delete_confirm_text,success_button_title:b.locales.delete_confirm_button,success_button_class:"danger custom-mr-4",cancel_button_title:`${b.locales.delete_cancel_button}`,cancel_button_class:"light-gray",onSuccess:function(){if(!c){c=!0;var l={id:k},h=f.find(".delete");h.removeClass("delete").addClass("loading");d.post("?module=call&action=delete",l,function(m){"ok"===
m.status&&g.remove()}).always(function(){h.removeClass("loading").addClass("delete");c=!1})}}})}var b=this,c=!1;b.$wrapper.on("click",".js-delete-call",function(e){e.preventDefault();a(d(this))})};CRMCallPage.prototype.initAssociateDeal=function(){this.$wrapper.on("click",".js-associate-deal",function(a){a=d(this).data("dialog-url");var b=d(this);b.prop("disabled",!0);d.get(a,function(c){d.waDialog({html:c,onOpen:function(e,f){b.prop("disabled",!1)}})})})};CRMCallPage.prototype.initBackgroundReload=
function(){function a(){clearTimeout(f);f=setTimeout(b,1E4)}function b(){var g=!1,k=c.$wrapper.find("audio");d.each(k,function(l,h){d(h)[0].ended||(g=!0)});if(g)return a(),!1;e||(e=!0,d.post("?module=call&action=ts&background_process=1",{call_ts:c.call_ts},function(l){"ok"==l.status&&d.contains(document,c.$wrapper[0])&&(l.data!==c.call_ts?d.crm.content.reload():a())}).always(function(){e=!1}))}var c=this,e=!1,f=0;a()};CRMCallPage.prototype.initLazyLoading=function(){function a(){function e(){if(d.contains(document,
l[0])){var h=l,m=d(window).scrollTop(),n=g.height(),p=h.offset().top;m+n>=p&&(c||f(h))}else g.off("scroll",e)}function f(h){var m=window.location.href.split("/crm/call/")[1];m=d.crm.app_url+"?module=call"+(m?"&"+m.slice(1):"");data={lazy:1,page:++b.current_page};c=!0;console.log(m);d.post(m,data,function(n){n=d(n).find("#js-calls-table").html();k.append(n);d(document).trigger("wa_loaded");h&&h.remove();a()}).always(function(){c=!1})}var g=d(window),k=b.$wrapper.find("#js-calls-table"),l=b.$wrapper.find(".js-lazy-load");
if(l.length)g.on("scroll",e)}var b=this,c=!1;a()};return CRMCallPage}(jQuery);var CRMCallAssociateDealDialog=function(d){CRMCallAssociateDealDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$footer=this.$wrapper.find(".js-dialog-footer");this.$submit=this.$form.find(".js-submit");this.$deal_name=this.$form.find(".js-deal-name");this.$deal_funnel=this.$form.find(".js-select-deal-funnel");this.$deal_stage=this.$form.find(".js-select-deal-stage");this.$deal_id=this.$form.find(".js-deal-id");this.initClass()};CRMCallAssociateDealDialog.prototype.initClass=
function(){this.initSelectDeal();this.initSubmit()};CRMCallAssociateDealDialog.prototype.initSelectDeal=function(){var a=this,b=a.$form.find(".js-select-deal .js-visible-link"),c=a.$form.find(".js-select-funnel"),e=a.$form.find(".js-deals-list"),f=a.$form.find(".js-deal-name-field");a.$form.on("click",".js-create-new-deal",function(){a.$submit.addClass("yellow").removeAttr("disabled");var g=d(this).find(".js-text").html();a.deal_selected=!0;c.removeClass("hidden");f.removeClass("hidden");a.$deal_name.focus();
b.html(g);a.$deal_id.val("0")});a.$form.on("click",".js-deal-item",function(){a.$submit.addClass("yellow").removeAttr("disabled");var g=d(this).find(".js-text").html();a.deal_selected=!0;e.find("li").removeClass("selected");d(this).parent().addClass("selected");b.html(g);c.addClass("hidden");f.addClass("hidden");a.$deal_name.val("");a.$deal_id.val(d(this).data("deal-id"))});a.$form.on("change",".js-select-deal-funnel",function(){a.$form.find(".js-select-stage-wrapper").load("?module=deal&action=stagesByFunnel&id="+
d(this).val())})};CRMCallAssociateDealDialog.prototype.initSubmit=function(){function a(){var e=d('<span class="icon size-16 loading"><i class="fas fa-spinner fa-spin"></i></span>'),f=d.crm.app_url+"?module=call&action=associateDealSave",g=b.$form.serializeArray();b.$submit.prop("disabled",!0);b.$footer.append(e);d.post(f,g,function(k){"ok"===k.status?(d.crm.content.reload(),d(".dialog.c-call-associate-deal").data("dialog").close()):(b.$submit.prop("disabled",!1),e.remove())})}var b=this,c=b.$wrapper.find(".js-deal-value");
b.$form.on("submit",function(e){e.preventDefault();if(!b.$deal_id.val())return c.addClass("shake animated").focus(),setTimeout(function(){c.removeClass("shake animated").focus()},500),!1;if(0==b.$deal_id.val()&&!d.trim(b.$deal_name.val()))return b.$deal_name.addClass("shake animated").focus(),setTimeout(function(){b.$deal_name.removeClass("shake animated").focus()},500),!1;a()})};return CRMCallAssociateDealDialog}(jQuery);var CRMCallInitContactDialog=function(d){CRMCallInitContactDialog=function(a){this.$wrapper=a.$wrapper;this.$footer=this.$wrapper.find(".js-dialog-footer");this.$form=this.$wrapper.find("form");this.$call_button=this.$form.find(".js-init-call");this.$content=this.$form.find(".js-content");this.$numbers_list=this.$form.find(".js-numbers-list");this.$plugin_id=this.$form.find(".js-plugin-id");this.dialog=this.$wrapper.data("dialog");this.call_id=0;this.call_ready=a.call_ready;this.locales=a.locales;
this.iframe=a.iframe;this.initClass()};CRMCallInitContactDialog.prototype.initClass=function(){"ready"===this.call_ready?this.initCall():(this.selectExtensionNumber(),this.submit());if(this.iframe)this.$wrapper.on("click",".js-close-dialog",function(a){a.preventDefault();d(".dialog iframe",window.parent.document)[0].dispatchEvent(new Event("close"))})};CRMCallInitContactDialog.prototype.selectExtensionNumber=function(){var a=this;a.$form.on("click",".js-number-item",function(){var b=d(this).data("plugin-id");
a.$plugin_id.val(d.crm.escape(b));a.$call_button.prop("disabled",!1)})};CRMCallInitContactDialog.prototype.submit=function(){var a=this;a.$form.on("submit",function(b){b.preventDefault();if(!a.$plugin_id.val())return a.$numbers_list.addClass("shake animated"),setTimeout(function(){a.$numbers_list.removeClass("shake animated")},500),!1;a.initCall()})};CRMCallInitContactDialog.prototype.initCall=function(){var a=this,b=d('<span class="icon size-16 loading"><i class="fas fa-spinner fa-spin"></i></span>'),
c=d.crm.app_url+"?module=call&action=initNew",e=a.$form.serializeArray();a.$call_button.prop("disabled",!0);a.$footer.append(b);d.post(c,e).done(function(f){"ok"===f.status?(a.call_id=f.data.call_id,a.callChecker()):console.error(f)}).fail(function(){a.iframe?d(".dialog iframe",window.parent.document)[0].dispatchEvent(new Event("close")):a.dialog.close()}).always(function(){a.$call_button.prop("disabled",!1);b.remove()})};CRMCallInitContactDialog.prototype.callChecker=function(){function a(){d.post(d.crm.app_url+
"?module=call&action=checkStatus",{id:c},function(h){try{h.errors&&(clearInterval(l),b.$content.html(k),setTimeout(function(){b.iframe?d(".dialog iframe",window.parent.document)[0].dispatchEvent(new Event("close")):(b.dialog.close(),d.crm.content.reload())},3E3),console.log(h.errors.message)),"PENDING"===h.data.status_id?b.$content.html(f):"CONNECTED"===h.data.status_id?b.$content.html(g):(b.$content.html(k),clearInterval(l),setTimeout(function(){b.iframe?d(".dialog iframe",window.parent.document)[0].dispatchEvent(new Event("close")):
(b.dialog.close(),d.crm.content.reload())},3E3))}catch(m){clearInterval(l),console.log("Error while updating call status"),console.log(m)}})}var b=this,c=b.call_id,e='<input class="button js-close-dialog" type="submit" value="'+b.locales.Close+'">',f='<div class="c-call-pending">'+b.locales.call_pending+'<span class="icon size-16 loading custom-pl-8"><i class="fas fa-spinner fa-spin"></i></span></div>',g='<div style="color: #00ff00;">'+b.locales.call_connected+"</div>",k='<div style="color: #5159c3;">'+
b.locales.call_finished+"</div>";b.$content.html(f);b.$footer.html(e);a();var l=setInterval(a,2E3)};return CRMCallInitContactDialog}(jQuery);var CRMCallRedirectDialog=function(d){CRMCallRedirectDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$button=this.$form.find(".js-submit");this.$autocomplete=this.$form.find(".js-autocomplete");this.$other_radio=this.$form.find(".js-other-candidate");this.$number=this.$form.find(".js-number");this.initClass()};CRMCallRedirectDialog.prototype.initClass=function(){this.initAutocomplete();this.initSelectCandidate();this.initSubmit()};CRMCallRedirectDialog.prototype.initAutocomplete=
function(){var a=this,b=a.$form.find(".js-candidate"),c=b.find(".js-delete-candidate");a.$autocomplete.autocomplete({source:d.crm.app_url+"?module=autocomplete&type=user&phonecomplete=true",appendTo:a.$autocomplete.parent(),minLength:0,focus:function(){return!1},select:function(e,f){a.$number.val(f.item.phone);b.find(".js-label").html(f.item.label);a.$autocomplete.css("display","none");b.removeClass("hidden");return!1}}).data("ui-autocomplete")._renderItem=function(e,f){return d('<li class="ui-menu-item-html"><div>'+
f.value+"</div></li>").appendTo(e)};a.$autocomplete.on("focus",function(){d(this).data("uiAutocomplete").search(d(this).val())});c.on("click",function(){a.$number.val("");b.addClass("hidden");a.$autocomplete.val("").removeAttr("style").focus()})};CRMCallRedirectDialog.prototype.initSelectCandidate=function(){var a=this,b=a.$form.find(".js-other-lbl"),c=a.$form.find(".js-candidate"),e=a.$form.find(".js-number-type");a.$form.on("change",":radio[name='redirect[to]']",function(){a.$other_radio.prop("checked")?
(e.val("external"),a.$number.val(""),a.$autocomplete.removeAttr("style").focus(),b.css("display","none")):(e.val("interior"),a.$number.val(d(this).val()),a.$autocomplete.css("display","none"),c.addClass("hidden"),a.$autocomplete.val(""),b.removeAttr("style"));a.$button.prop("disabled",!1)})};CRMCallRedirectDialog.prototype.initSubmit=function(){var a=this,b=a.$form.find(".js-field-name");a.$form.on("submit",function(c){c.preventDefault();var e=a.$wrapper.find(".js-call-id").val(),f=a.$number.val();
d.trim(f)||(f=d.trim(a.$autocomplete.val()));if(!d.trim(f))return b.addClass("shake animated"),setTimeout(function(){b.removeClass("shake animated")},500),!1;(function(){var g=a.$form.find(".js-number-type").val(),k=a.$wrapper.find(".js-dialog-footer"),l=d('<span class="icon size-16 loading"><i class="fas fa-spinner fa-spin"></i></span>');a.$button.prop("disabled",!0);k.append(l);d.post(d.crm.app_url+"?module=call&action=redirect",{call_id:e,number_type:g,number:f},function(h){"ok"===h.status&&(k.find(".svg-inline--fa.fa-spinner").removeClass("fa-spinner fa-spin").addClass("fa-check text-green"),
a.$wrapper.hide(),setTimeout(function(){d.crm.content.reload()},2E3))})})()})};return CRMCallRedirectDialog}(jQuery);var CRMMessageDeleteLinkMixin=function(d){CRMMessageDeleteLinkMixin=function(){};CRMMessageDeleteLinkMixin.prototype.initMessageDeleteLink=function(){function a(){var c=d.crm.app_url+"?module=message&action=delete",e={id:b.message.id},f=d('<span class="icon loading"><i class="fas fa-spinner wa-animation-spin"></i></span>');f.appendTo(b.$button.parent());b.$button.attr("disabled",!0);d.post(c,e,function(g){if("ok"===g.status)d.crm.content.reload(),d(".dialog.c-message-show-body-dialog")?.data("dialog")?.close();
else{console.log("Error saving Responsible contact classification: "+arguments[2],arguments);var k="Error saving Responsible contact classification: "+arguments[2];k=d('<div class="errormsg" />').text(k);b.$errorsPlace.append(k)}},"json").always(function(){b.$button.attr("disabled",!1);f.remove()})}var b=this;b.$wrapper.find(".js-delete-message").on("click",function(){event.preventDefault();d.crm.confirm.show({title:b.locales.delete_message,text:b.locales.delete_message_text,button:b.locales["delete"],
onConfirm:a})})};CRMMessageDeleteLinkMixin.mixInFor=function(a){a.prototype=d.extend(a.prototype,CRMMessageDeleteLinkMixin.prototype);return a};return CRMMessageDeleteLinkMixin}(jQuery);(function(d){d.message=d.extend(d.message||{},{app_url:!1,is_page_loaded:!1,content:!1,sidebar:!1,locales:!1})})(jQuery);
var MessageContentRouter=function(d){MessageContentRouter=function(a){this.$content=a.$content;this.iframe=a.iframe;this.app_url=a.app_url||d&&d.crm&&d.crm.app_url;this.api_enabled=!(!window.history||!window.history.pushState);this.xhr=!1;this.initClass()};MessageContentRouter.prototype.initClass=function(){this.animate(!0)};MessageContentRouter.prototype.load=function(a,b,c,e,f){var g=this;if(!(0<=a.indexOf(d.crm.app_url)))return alert("Determine the path error"),!1;g.animate(!0);g.xhr&&g.xhr.abort();
d(document).trigger("wa_before_load",{content_uri:a});e&&d(document).trigger("change_active_id",{target_id:e});f&&f.find(".enable-animation [data-fa-i2svg]").hide().after('<i class="fas fa-spinner fa-spin"></i>');g.xhr=d.ajax({method:"GET",url:d.crm.app_url+"?module=messageConversationId&id="+c,dataType:"html",global:!1,cache:!1}).done(function(k){g.api_enabled&&!b&&history.pushState({reload:!0,content_uri:a},"",a);f&&(f.find(".enable-animation [data-fa-i2svg]:first").show(),f.find(".enable-animation [data-fa-i2svg]").slice(1).remove());
g.setContent(k);g.xhr=!1}).fail(function(k){k.responseText&&d.crm.alert.show({title:"Error",text:k.responseText,button:"Close"});f&&(f.find(".enable-animation [data-fa-i2svg]:first").show(),f.find(".enable-animation [data-fa-i2svg]").slice(1).remove())});return g.xhr};MessageContentRouter.prototype.reload=function(a){var b=this.api_enabled&&history.state&&history.state.content_uri?history.state.content_uri:location.href;return b?this.load(b,!0,a):d.when()};MessageContentRouter.prototype.setContent=
function(a){this.$content.html(a)};MessageContentRouter.prototype.animate=function(a){var b=this;b.$content_wrapper=b.$content.find("#js-message-conversation-page");b.$skeleton=b.$content.find(".skeleton-wrapper");var c=b.$skeleton;setTimeout(function(){a?c.show():c.is(":visible")||b.iframe?c.hide():null},10)};return MessageContentRouter}(jQuery),CRMDealMessagesDialog=function(d){CRMDealMessagesDialog=function(a){this.$wrapper=a.$wrapper;this.initClass()};CRMDealMessagesDialog.prototype.initClass=
function(){this.$wrapper.on("click",".c-message-wrapper a",function(a){a.preventDefault()});this.$wrapper.on("click",".c-message-wrapper",function(a){a.preventDefault();a=d(a.target);var b=d(this);a.attr("href")||(a=b.find(".js-message-show-body"),a.length&&a.trigger("click"))})};return CRMDealMessagesDialog}(jQuery),CRMMessageBodyDialog=function(d){CRMMessageBodyDialog=function(a){this.$wrapper=a.$wrapper;this.is_admin=a.is_admin;this.app_url=a.app_url;this.dialog=this.$wrapper.data("dialog")||!1;
this.$button=this.$wrapper.find(".js-close-dialog");this.contact_id=a.contact_id;this.message=a.message||{};this.locales=a.locales;this.initClass()};CRMMessageBodyDialog.prototype.initClass=function(){this.initMessageShowBodyLink();this.is_admin&&(this.initSelectDeal(),this.initMessageDeleteLink())};CRMMessageBodyDialog.prototype.initSelectDeal=function(){function a(){n.html(""+c.locales.deal_empty);u.val("none");g.val("");f.addClass("c-deal-name-hidden");k.addClass("hidden").removeAttr("title");
m.addClass("c-empty-deal-hidden");p.addClass("hidden");r.find("li").removeClass("selected");l.removeClass("hidden")}function b(){var t=c.$wrapper.find(".js-created-deal"),w=q.find(".js-visible-link .js-text .funnel-state").clone(),x=d.trim(g.val()),y=e.serializeObject();y.message_id=c.message.id;if("none"===u.val())return e.addClass("shake animated"),setTimeout(function(){e.removeClass("shake animated")},500),!1;if(0>=u.val()&&!x)return f.addClass("shake animated"),setTimeout(function(){f.removeClass("shake animated");
g.focus()},500),!1;e.addClass("deal-form-hidden");t.removeClass("hidden");0>=u.val()?(t.html(w),t.append(d.crm.escape(x))):(x=l.find(".js-visible-link .js-text"),w=x.find(".funnel-state").clone(),x=x.find("b i").text(),t.html(w),t.append(d.crm.escape(x)));d.post(d.crm.app_url+"?module=message&action=associateDealSave",y,function(z){if("ok"===z.status&&z.data.deal_url){var B=t.html();t.html('<a href="'+z.data.deal_url+'">'+B+"</a>")}else t.html(""),t.addClass("hidden"),a(),e.removeClass("deal-form-hidden")})}
var c=this,e=c.$wrapper.find(".deal-form"),f=e.find(".js-deal-name"),g=e.find(".js-deal-name-input"),k=e.find(".js-save-deal"),l=e.find(".js-deals-dropdown"),h=e.find(".js-remove-deal"),m=l.find(".js-empty-deal"),n=e.find(".js-select-deal .js-visible-link .js-text"),p=e.find(".js-select-funnel-wrapper"),q=e.find(".js-select-stage-wrapper"),r=e.find(".js-deals-list"),u=e.find(".js-deal-id"),v=c.contact_id;u.val("none");v&&d.get("?module=deal&action=byContact&id="+v,function(t){"ok"===t.status&&d.each(t.data.deals,
function(w,x){r.prepend('<li><a href="javascript:void(0);" class="js-deal-item" data-deal-id="'+x.id+'"><i class="fas fa-circle funnel-state" style="color: '+t.data.funnels[x.funnel_id].stages[x.stage_id].color+'"></i><span class="js-text">'+x.name+"</span></a></li>")})},"json");e.on("click",".js-create-new-deal",function(){u.val("0");l.addClass("hidden");f.removeClass("c-deal-name-hidden");k.attr("title",c.locales.deal_create).removeClass("hidden");p.removeClass("hidden");m.removeClass("c-empty-deal-hidden");
g.focus()});e.on("click",".js-deal-item",function(){var t=d(this).find(".js-text").html();n.html(t);u.val(d(this).data("deal-id"));k.attr("title",c.locales.deal_add).removeClass("hidden");p.addClass("hidden");m.removeClass("c-empty-deal-hidden");r.find("li").removeClass("selected");d(this).parent().addClass("selected")});r.on("click",function(){r.hide();setTimeout(function(){r.removeAttr("style")},200)});m.on("click",function(){a()});h.on("click",function(){a()});k.on("click",function(t){t.preventDefault();
e.trigger("submit")});e.on("submit",function(t){t.preventDefault();b()});e.on("change",".js-select-deal-funnel",function(){e.find(".js-select-stage-wrapper").load("?module=deal&action=stagesByFunnel&id="+d(this).val())})};CRMMessageBodyDialog.prototype.initMessageShowBodyLink=function(){var a=this.dialog,b=this.$wrapper;this.initMessageReplyBtn(b,a);this.initMessageForwardBtn(b,a);b.on("click","a",function(c){"javascript:void(0);"!==d(this).prop("href")&&a.close()})};CRMMessageBodyDialog.prototype.initMessageReplyBtn=
function(a,b){var c=this;a.on("click",".js-message-reply",function(){function e(k){var l=f.find(".icon");if(!l.length)return!1;k?l.removeClass("fa-undo").addClass("fa-spinner fa-spin"):l.removeClass("fa-spinner fa-spin").addClass("fa-undo")}var f=d(this),g=f.data("message-id");e(!0);d.post(c.app_url+"?module=message&action=writeReplyDialog",{id:g},function(k){d.waDialog({html:k,onClose:function(){}})}).always(function(){e(!1)})})};CRMMessageBodyDialog.prototype.initMessageForwardBtn=function(a,b){var c=
this;a.on("click",".js-message-forward",function(){function e(k){var l=f.find(".icon");if(!l.length)return!1;k?l.removeClass("fa-redo").addClass("fa-spinner fa-spin"):l.removeClass("fa-spinner fa-spin").addClass("fa-redo")}var f=d(this),g=f.data("message-id");e(!0);d.post(c.app_url+"?module=message&action=writeForwardDialog",{id:g},function(k){d.waDialog({html:k})}).always(function(){e(!1)})})};CRMMessageDeleteLinkMixin.mixInFor(CRMMessageBodyDialog);return CRMMessageBodyDialog}(jQuery),CRMMessagesSidebar=
function(d){CRMMessagesSidebar=function(a){this.$wrapper=a.$wrapper;this.$ui=a.$ui;this.no_messages="true"===a.empty_conversations;this.$sidebar=this.$wrapper.parent();this.$list=this.$wrapper.find(".c-messages-table-section");this.$skeleton=this.$sidebar.find(".skeleton-wrapper");this.page_of_item=a.page_of_item;this.current_page=a.current_page;this.active_id=a.active_id;this.last_message_id=a.last_message_id;this.$settings_contact_id=+a.settings_contact_id;this.$settings_deal_id=+a.settings_deal_id;
this.settings=a;this.iframe=a.iframe;this.initClass()};CRMMessagesSidebar.prototype.initClass=function(){var a=this;a.initLazyLoading();a.initSearchHandler();a.conversationListHandler();new CRMPageMessagesOperations(a.settings);a.no_messages&&a.$wrapper.closest("#c-messages-sidebar").addClass("no-messages-sidebar");a.$wrapper.on("click",".js-associate-deal",function(c){c.preventDefault();c=d(this).data("dialog-url");d.get(c,function(e){d.waDialog({html:e})})});var b=!1;a.$wrapper.on("click",".js-write-message",
function(c){c.preventDefault();b||(b=!0,c=d.crm.app_url+"?module=message&action=writeNewDialog",data={contact_id:a.$settings_contact_id?a.$settings_contact_id:null,deal_id:a.$settings_deal_id?a.$settings_deal_id:null},d.get(c,data,function(e){d.waDialog({html:e,onOpen:function(){b=!1}})}))});a.$wrapper.on("click",".js-filter-open",function(){a.$wrapper.find(".c-message-filter-wrapper").toggle()});a.current_page&&a.initBackgroundUpdate()};CRMMessagesSidebar.prototype.initSearchHandler=function(){var a=
this,b=a.$sidebar;a.$search_wrapper=b.find(".js-search-wrapper");var c=a.$search_wrapper;$page_name=b.find(".js-page-name-header");$autocomplete=c.find(".js-search-field");$search_block=c.find(".state-with-inner-icon");a.iframe||($autocomplete.autocomplete({appendTo:c,source:d.crm.app_url+"?module=autocompleteContact",minLength:0,html:!0,focus:function(){return!1},select:function(e,f){d.crm.content.load(d.crm.app_url+"message/?contact="+f.item.id);a.$skeleton.show();$autocomplete.val("");return!1}}).data("ui-autocomplete")._renderItem=
function(e,f){return d("<li />").addClass("ui-menu-item-html").append("<div><span class='icon userpic custom-mr-4'><i style='background-image: url("+f.userpic+");'></i></span>"+f.name+"</div>").appendTo(e)});c.on("click",".js-search-contact-cancel",function(){a.$skeleton.show();d.crm.content.load(d.crm.app_url+"message/")});c.on("click",".js-search-mobile-show",function(e){c.find(".js-search-mobile-show").removeClass("mobile-only").hide();$page_name.removeClass("mobile-only").hide();$search_block.removeClass("desktop-and-tablet-only");
c.find(".js-search-contact-hide").show()});c.on("click",".js-search-contact-hide",function(e){c.find(".js-search-contact-hide").hide();c.find(".js-search-mobile-show").add("mobile-only").show();$page_name.addClass("mobile-only").show();$search_block.addClass("desktop-and-tablet-only")})};CRMMessagesSidebar.prototype.initBackgroundUpdate=function(){function a(){d(document).off("msg_sidebar_upd_needed");d(document).off("change_active_id")}function b(h=!1){clearTimeout(l);h?c():l=setTimeout(c,12E4)}
function c(){k||(k=!0,d.contains(document,f.$wrapper[0])&&d.post("?module=message&action=listByConversation",{check:1},function(h){"ok"===h.status&&(h=h.data!==g,d.contains(document,f.$wrapper[0])&&(h&&!d(".dialog-background:visible").length?e():b()))},"json").always(function(){k=!1}))}function e(){var h=d.crm.app_url+"message/"+(f.active_id?"conversation/"+f.active_id+"/":"")+"?reload=1"+(f.$settings_contact_id?"&contact="+f.$settings_contact_id:f.$settings_deal_id?"&deal="+f.$settings_deal_id:"")+
(f.iframe?"&iframe="+f.iframe:""),m={ui:f.$ui,id:+f.active_id};a();f.$wrapper.off("click");f.$search_wrapper.off("click");f.$list.off("click");clearTimeout(l);d.get(h,m,function(n){n=d(n).find("#c-messages-conversation-list").html();f.$wrapper.html(n)})}var f=this,g=f.last_message_id,k=!1,l=0;a();d(document).on("change_active_id",function(h,m){m.target_id&&(f.active_id=m.target_id)});d(document).on("msg_sidebar_upd_needed",function(){b(!0)});b()};CRMMessagesSidebar.prototype.conversationListHandler=
function(){function a(g){g.preventDefault();g.stopPropagation();g=d(this);var k=e.next();let l=g.prop("href"),h=g.parent().data("id");target_props=h+(b.iframe?"&iframe=1&view=chat":"&view=chat")+(b.$settings_contact_id?"&contact="+b.$settings_contact_id:b.$settings_deal_id?"&deal="+b.$settings_deal_id:"");d.message.content.load(l,!1,target_props,h,g);c.find(".selected").removeClass("selected");g.parent().addClass("selected").removeClass("unread");k.is(":visible")||(e.addClass("desktop-and-tablet-only"),
k.removeClass("desktop-and-tablet-only"))}var b=this,c=b.$list,e=b.$sidebar,f=d(window);c.on("click","a",a);f.on("beforeunload",function(){c.off("click","a",a)});d(document).ready(function(){b.scrollToSelected();b.$skeleton.hide()})};CRMMessagesSidebar.prototype.scrollToSelected=function(){var a=this.$sidebar,b=this.$list.find(".js-message-wrapper.selected");if(b.length){var c=b.offset().top;target_h=b.height();viewportHeight=d(window).height();scrollIt=c-(viewportHeight-target_h)/2;a.scrollTop(scrollIt)}};
CRMMessagesSidebar.prototype.initLazyLoading=function(){function a(){function m(){if(d.contains(document,n[0])){var q=n,r=f.scrollTop(),u=f.height(),v=q.offset().top;r+u>=v&&(e||b(q))}else g.off("scroll touchmove",m)}var n=l.find(".js-lazy-load");e=!1;if(h&&h>c.current_page)b(n);else if(h&&h==c.current_page&&c.scrollToSelected(),n.length){var p=1==c.current_page&&f.height()-64>k?!0:!1;if(p)m();else g.on("scroll touchmove",m)}}function b(m){var n=d.crm.app_url+"?module=messageListByConversation",p=
c.$settings_contact_id?+c.$settings_contact_id:void 0,q=c.$settings_deal_id?+c.$settings_deal_id:void 0;data={id:+c.active_id,page:++c.current_page,contact:p,deal:q,reload:1,iframe:c.iframe};e=!0;d.post(n,data,function(r){m&&m.remove();r=d(r).find(".c-messages-table-section").html();l.append(r);a()}).always(function(){})}var c=this,e=!1,f=d(window),g=c.$sidebar,k=g.find(".c-messages-conversation-list").height(),l=c.$list,h=c.page_of_item;a()};return CRMMessagesSidebar}(jQuery);var CRMMessageConversationPage=function(d){CRMMessageConversationPage=function(a){this.$wrapper=a.$wrapper;this.locales=a.locales;this.conversation_id=a.conversation_id;this.contact_id=a.contact_id;this.filter_contact_id=a.filter_contact_id;this.filter_deal_id=a.filter_deal_id;this.funnel_id=a.funnel_id;this.last_message_id=a.last_message_id;this.check_interval=a.check_interval;this.$replySection=this.$wrapper.find(".c-reply-section");this.iframe=a.iframe;this.old_message_id=a.old_message_id;this.$dropdown_name=
this.$wrapper.find("#dropdown-c-name");this.short_link=a.short_link;this.do_confirm_verification=a.do_confirm_verification;this.initClass()};CRMMessageConversationPage.prototype.initClass=function(){var a=this;a.$wrapper.find(".js-deal-link").length||a.initSelectDeal();a.short_link&&a.setLinkWithId();a.initDealActions();a.initChangeResponsible();a.initBackgroundActions();a.initDelete();d(document).ready(function(){function b(){0==f&&a.scroll2bottom(!1,!1)}var c=a.$wrapper[0].getElementsByTagName("img"),
e=a.$wrapper[0].getElementsByTagName("video"),f=c.length+e.length;b();for(var g=0;g<e.length;g++)3<=e[g].readyState?(f--,b()):(e[g].addEventListener("loadeddata",function(){f--;b()}),e[g].addEventListener("error",function(){f--;b()}));for(g=0;g<c.length;g++)c[g].complete?(f--,b()):(c[g].addEventListener("load",function(){f--;b()}),c[g].addEventListener("error",function(){f--;b()}))});a.initSingleMessage();a.initToggleSidebar();a.initLazyLoading();a.initBlockquotToggle();a.initScrollToBottom();a.initAuxDropdown()};
CRMMessageConversationPage.prototype.setLinkWithId=function(){var a=window.location.href;a.slice(-8).includes("message")&&(a=a+"conversation/"+this.conversation_id+"/",history.replaceState({reload:!0,content_uri:a},"",a))};CRMMessageConversationPage.prototype.initAuxDropdown=function(){function a(c=!1){d.post("?module=message&action=verification",{message_id:b.last_message_id,no_more_confirmation:c?1:0},function(e){"ok"==e.status?d(document).trigger("msg_conversation_update"):d.waDialog.alert({text:e.errors.message||
"Unknown error",button_title:b.locales.close,button_class:"gray"})})}var b=this;b.$wrapper.find(".js-request-auth").click(function(){b.do_confirm_verification?d.waDialog.confirm({title:b.locales.verify_confirm_title,text:b.locales.verify_confirm_text+'<div class="custom-mt-24"><label><span class="wa-checkbox"><input type="checkbox" value="1" class="js-verification-not-show-confirm-checkbox"><span><span class="icon"><i class="fas fa-check"></i></span></span></span> '+b.locales.verify_no_more_confirmation_label+
"</label></div>",success_button_title:b.locales.verify_confirm_button,cancel_button_title:d.crm.locales.cancel,cancel_button_class:"light-gray",onSuccess:function(){const c=d(".js-verification-not-show-confirm-checkbox").is(":checked");a(c)}}):a()})};CRMMessageConversationPage.prototype.initBlockquotToggle=function(){var a=this.$wrapper.find(".c-message-body");d.each(a,function(b,c){d(c).find(".js-blockquote-toggle").length||(b=d(c).children("blockquote"),d.each(b,function(e,f){e=d('<span class="button light-gray custom-mb-4 size-14 js-blockquote-toggle"><i class="fas fa-ellipsis-h"></i></span>');
e.insertBefore(f);e.on("click",function(g){d(f).slideToggle(400)})}))})};CRMMessageConversationPage.prototype.initLazyLoading=function(){function a(){function m(){if(d.contains(document,n[0])){var p=n;0>=f.scrollTop()&&!e&&(f.off(".lazy"),b(p))}else f.off("scroll.lazy touchmove.lazy",m)}var n=f.find(".js-lazy-load");e=!1;1==c.current_page&&10>l?n.remove():n.length&&(f.on("scroll.lazy touchmove.lazy",m),c.$wrapper.one("bigWindowEvent.lazy",m))}function b(m){var n=d.crm.app_url+"?module=messageConversationId&id="+
c.conversation_id+"&old_message_id="+c.old_message_id;e=!0;d.ajax({url:n,type:"POST",dataType:"html",beforeSend:function(){k.show();h=f.prop("scrollHeight")},complete:function(){},data:{delay:1},success:function(p){var q=d(p).find(".js-messages-list");p=d(p).find(".js-message-wrapper");var r=p.length;if(r){c.old_message_id=p.eq(0).data("id");10>r&&q.find(".js-lazy-load").remove();q=q.html();g.append(q);u();function u(){var t=g[0].getElementsByTagName("img"),w=t.length;if(0==w)v();else for(var x=0;x<
t.length;x++)t[x].complete?w--:(t[x].addEventListener("load",function(){w--;0==w&&v()}),t[x].addEventListener("error",function(){w--;0==w&&v()})),0==w&&v()}function v(){m&&m.remove();f.prepend(g.html());g.html("");f.scrollTop(f.prop("scrollHeight")-h);h=f.prop("scrollHeight");k.hide();a()}}else m&&m.remove();c.current_page++;a()}})}var c=this,e=!1,f=c.$wrapper.find(".js-messages-list"),g=c.$wrapper.find(".c-conversation-body--blank"),k=f.find(".js-messages-list--transparent-layer"),l=f.find(".js-message-wrapper").length,
h=c.$wrapper.prop("scrollHeight");c.current_page=1;a();d(document).on("new_message_lazy",m=>{a()})};CRMMessageConversationPage.prototype.initVisiblityWatcher=function(){function a(e){e?(c.addClass("is-extended").trigger("resize"),b.$wrapper.addClass("scroll-lock")):(c.removeClass("is-extended").trigger("resize"),b.$wrapper.removeClass("scroll-lock"))}var b=this,c=b.$replySection;c.on("click",".js-revert",function(){a(!1)});c.on("click",".js-message-resize",function(){a(!1)});c.on("click",".js-message-resize-open",
function(){a(!0)})};CRMMessageConversationPage.prototype.loadDealListByContact=function(a){a=a||function(){};var b=this.contact_id;0>=b||this.iframe?a({}):d.get("?module=deal&action=byContact&id="+b,"json").always(function(c){c&&"ok"===c.status?a(c.data||{}):a({})})};CRMMessageConversationPage.prototype.initSelectDeal=function(a){function b(){t.html(e.locales.deal_empty);z.val("none");m.val("");h.addClass("c-deal-name-hidden");p.addClass("hidden").removeAttr("title");v.addClass("c-empty-deal-hidden");
w.addClass("hidden");y.find("li").removeClass("selected");0<q.data("deals_count")?(q.removeClass("hidden"),r.addClass("hidden")):(q.addClass("hidden"),r.removeClass("hidden"))}function c(){var B=f.find(".js-created-deal"),C=x.find(".js-visible-link .js-text .funnel-state").clone(),A=d.trim(m.val()),D=l.serializeObject();D.conversation_id=e.conversation_id;if("none"===z.val())return l.addClass("shake animated"),setTimeout(function(){l.removeClass("shake animated")},500),!1;if(0>=z.val()&&!A)return h.addClass("shake animated"),
setTimeout(function(){h.removeClass("shake animated");m.focus()},500),!1;l.addClass("deal-form-hidden");B.removeClass("hidden");0>=z.val()?(B.html(C),B.append(d.crm.escape(A))):(A=q.find(".js-visible-link .js-text"),C=A.find(".funnel-state").clone(),A=A.find(".deal-item--name").text(),B.html(C),B.append(d.crm.escape(A)));d.post(d.crm.app_url+"?module=message&action=conversationAssociateDealSave",D,function(E){"ok"===E.status?(f.closest(".dialog").data("dialog").close(),d.crm.content.reload()):(B.html(""),
B.addClass("hidden"),b(),l.removeClass("deal-form-hidden"))})}var e=this;a=a||{};var f=a.$wrapper||e.$wrapper,g=function(B){B=B||{};var C=B.funnels||{},A=0;d.each(B.deals||{},function(D,E){D=y;var F=D.prepend;var G=C[E.funnel_id];if(!E||0>=E.id)E="";else{var H=E.id,I=E.name||"",K="",J="";G&&G.stages&&G.stages[E.stage_id]&&(K=G.stages[E.stage_id].color||"");d.isEmptyObject(G)&&(J='<span class="hint">'+e.locales.funnel_deleted+"</span>");E='<li><a href="javascript:void(0);" class="js-deal-item" data-deal-id="'+
H+'"><span class="flexbox js-text"><i class="fas fa-circle funnel-state custom-mr-4" style="color: '+K+'"></i><span class="deal-item--name" style="word-break: break-word;">'+I+"</span></span>"+J+"</a></li>"}F.call(D,E);A++});k.show();q.data("deals_count",A);0<A?(q.removeClass("hidden"),r.addClass("hidden")):(r.removeClass("hidden"),q.addClass("hidden"))},k=f.find(".js-deal-selector-control-wrapper"),l=k.find(".deal-form"),h=l.find(".js-deal-name"),m=l.find(".js-deal-name-input"),n=f.closest(".js-conversation-deal-attach-dialog").find(".js-save-button"),
p=l.find(".js-save-deal"),q=l.find(".js-deals-dropdown"),r=l.find(".js-create-new-deal-link"),u=l.find(".js-remove-deal"),v=q.find(".js-empty-deal"),t=l.find(".js-select-deal .js-visible-link .js-text"),w=l.find(".js-select-funnel-wrapper"),x=l.find(".js-select-stage-wrapper"),y=l.find(".js-deals-list"),z=l.find(".js-deal-id");z.val("none");"undefined"===typeof a.data?e.loadDealListByContact(g):g(a.data);l.on("click",".js-create-new-deal",function(){z.val("0");q.addClass("hidden");r.addClass("hidden");
h.removeClass("c-deal-name-hidden");p.attr("title",e.locales.deal_create).removeClass("hidden");w.removeClass("hidden");v.removeClass("c-empty-deal-hidden");m.focus();n.addClass("yellow")});l.on("click",".js-deal-item",function(){var B=d(this).find(".js-text").html();t.html(B);z.val(d(this).data("deal-id"));p.attr("title",e.locales.deal_add).removeClass("hidden");w.addClass("hidden");v.removeClass("c-empty-deal-hidden");y.find("li").removeClass("selected");d(this).parent().addClass("selected");n.addClass("yellow")});
y.on("click",function(){y.hide();setTimeout(function(){y.removeAttr("style")},200)});v.on("click",function(){b()});u.on("click",function(){b()});p.on("click",function(B){B.preventDefault();l.trigger("submit")});l.on("submit",function(B){B.preventDefault();c()});l.on("change",".js-select-deal-funnel",function(){l.find(".js-select-stage-wrapper").load("?module=deal&action=stagesByFunnel&id="+d(this).val())});return{submit:function(){l.trigger("submit")}}};CRMMessageConversationPage.prototype.initDealActions=
function(){function a(f,g){var k=null;f.on("click",".js-detach-deal",function(l){l.preventDefault();d.crm.confirm.show({title:b.locales.deal_detach_title,text:b.locales.deal_detach_text.replace(/%s/,g),button:b.locales.deal_detach_confirm_button,onConfirm:function(){k&&k.abort();b.loadDealListByContact(function(h){k=d.post(d.crm.app_url+"?module=messageConversationDeal&action=detach",{id:b.conversation_id}).done(function(m){m&&"ok"===m.status&&(d.crm.content.reload(),f.data("dialog").close())}).always(function(){k=
null})})}})})}var b=this,c=b.$wrapper,e=c.find(".js-conversation-deal");$deal_second=c.find("#dropdown-c-deal");e.on("click",".js-associate-deal",function(f){f.preventDefault();f=d(this).data("dialog-url");d.get(f,function(g){d.waDialog({html:g})})});e.on("click",".js-attach-other-deal",function(f){setTimeout(()=>{$deal_second.find(".dropdown-toggle").trigger("click")},50)});$deal_second.on("click",".js-return-back",function(f){setTimeout(()=>{b.$dropdown_name.find(".dropdown-toggle.c-name").trigger("click")},
50)});$deal_second.on("click",".js-attach-other-deal",function(f){f.preventDefault();var g=e.find(".js-deal-link").text();b.loadDealListByContact(function(k){d.get(d.crm.app_url+"?module=messageConversationDeal&action=attachDialog",{id:b.conversation_id},function(l){var h=d(l);d.waDialog({html:h,onOpen:function(){var m=h.find(".js-conversation-deal"),n=b.initSelectDeal({$wrapper:m,data:k});h.find(".js-save-button").on("click",function(){n.submit()});a(h,g)}})})})});$deal_second.on("click",".js-detach-deal",
function(f){f.preventDefault();var g=null;f=e.find(".js-deal-link--name").text();d.crm.confirm.show({title:b.locales.deal_detach_title,text:b.locales.deal_detach_text.replace(/%s/,f),button:b.locales.deal_detach_confirm_button,onConfirm:function(){g&&g.abort();b.loadDealListByContact(function(k){g=d.post(d.crm.app_url+"?module=messageConversationDeal&action=detach",{id:b.conversation_id}).done(function(l){l&&"ok"===l.status&&d.crm.content.reload()}).always(function(){g=null})})}})})};CRMMessageConversationPage.prototype.initChangeResponsible=
function(){function a(){e||(e=!0,d.post("?module=message&action=changeConversationUser",{action:"remove",id:c.conversation_id},function(h){"ok"===h.status&&(e=!1)},"json").always(function(){e=!1;d.crm.content.reload()}))}function b(h,m){function n(w){var x="?module=autocomplete&type=user";x=0<c.funnel_id?x+("&funnel_id="+c.funnel_id):x+("&contact_id="+c.contact_id);w.autocomplete({appendTo:w.parent(),source:x,minLength:0,html:!0,focus:function(){return!1},select:function(y,z){p(z.item.id);w.val("");
m.close();d.crm.content.reload();return!1}}).data("ui-autocomplete")._renderItem=function(y,z){var B=d("<li />");B.addClass("ui-menu-item-html").append("<div>"+z.value+"</div>").appendTo(y);z.rights||(B.addClass("is-locked"),B.on("click",function(C){C.preventDefault();C.stopPropagation()}));return B};w.on("focus",function(){w.data("uiAutocomplete").search(w.val())})}function p(w){e||(e=!0,d.post("?module=message&action=changeConversationUser",{action:"set",id:c.conversation_id,user_contact_id:w},
function(x){"ok"===x.status&&(x=d(x.data.html),r.html(x),v.addClass("hidden"),x=r.find(".js-owner-autocomplete"),x.length&&n(x))},"json").always(function(){e=!1}))}function q(){e||(e=!0,d.post("?module=message&action=changeConversationUser",{action:"remove",id:c.conversation_id},function(w){"ok"===w.status&&(r.html(""),v.removeClass("hidden"),e=!1)},"json").always(function(){e=!1;m.close();d.crm.content.reload()}))}h.on("click",".js-cancel",function(w){w.preventDefault();m.close()});var r=h.find(".js-responsible-wrapper"),
u=r.find(".js-owner-autocomplete"),v=h.find(".js-responsible-empty-wrapper"),t=v.find(".js-responsible-empty-autocomplete");t.length&&n(t);u.length&&n(u);v.on("click",".js-set-extended, .js-unset-extended",function(){v.toggleClass("is-extended");v.hasClass("is-extended")&&t.focus()});r.on("click",".js-show-combobox",function(){r.find(".c-conversation-member").addClass("is-edit");r.find(".js-owner-autocomplete").focus()});r.on("click",".c-conversation-member .profile",function(){m.close()});r.on("click",
".js-hide-combobox",function(){r.find(".c-conversation-member").removeClass("is-edit")});r.on("click",".js-remove-owner",function(w){w.preventDefault();w=d.trim(r.find(".c-name").html());d.crm.confirm.show({title:c.locales.remove_owner_title,text:c.locales.remove_owner_text.replace(/%s/,w),button:c.locales.remove_owner_button,onConfirm:function(){q()}})})}var c=this,e=!1,f=c.$wrapper.find(".js-conversation-contact"),g=c.$wrapper.find(".js-open-responsible-dialog"),k=c.$wrapper.find("#dropdown-c-contact");
$responsible_wrapper_dialog=c.$wrapper.find(".js-conversation-responsible-wrapper");html_content=$responsible_wrapper_dialog.html();f.on("click",".js-open-second-menu",function(h){setTimeout(()=>{k.find(".dropdown-toggle").trigger("click")},50)});k.on("click",".js-return-back",function(h){setTimeout(()=>{c.$dropdown_name.find(".dropdown-toggle.c-name").trigger("click")},50)});k.on("click",".js-remove-owner",function(h){h.preventDefault();h=d.trim($responsible_wrapper_dialog.find(".c-name").html());
d.crm.confirm.show({title:c.locales.remove_owner_title,text:c.locales.remove_owner_text.replace(/%s/,h),button:c.locales.remove_owner_button,onConfirm:function(){a()}})});const l=`<div class="dialog dialog-conversation-responsible" id="my-dialog">
        <div class="dialog-background"></div>
        <div class="dialog-body">
        <div class="dialog-header"><h3><i class="fas fa-cogs text-blue smaller"></i> ${c.locales.owner}</h3></div>
        <div class="dialog-content">
        ${html_content}
        </div>
        <div class="dialog-footer">
            <button class="button light-gray js-cancel" type="button">${c.locales.close}</button>
        </div>
        </div>`;g.on("click",function(){d.waDialog({html:l,onOpen:b})})};CRMMessageConversationPage.prototype.triggerChatUpdate=function(){d(document).trigger("msg_conversation_update")};CRMMessageConversationPage.prototype.initBackgroundActions=function(){function a(k=!1){clearTimeout(g);k?b():g=setTimeout(b,e.check_interval)}function b(){f||(f=!0,d.post("?module=message&action=conversationIdCheck",{id:e.conversation_id},function(k){"ok"===k.status&&(+k.data!==e.last_message_id?c().then(function(l){l.length&&
e.scroll2bottom(!0,!0);a()}):a())},"json").always(function(){f=!1}))}function c(){var k=d.Deferred();d.get(location.href,function(l){function h(q){function r(){q.removeClass("is-new");q.off("hover",r);u.off("unmark-new-messages",r)}var u=d(document);q.addClass("is-new");q.on("hover",r);u.on("unmark-new-messages",r);setTimeout(function(){d.contains(document,q[0])&&r()},1E4)}var m=e.last_message_id,n=e.$wrapper.find(".js-messages-list").first();l=d(l).find(".js-messages-list .js-message-wrapper");var p=
[];n.length&&(l.each(function(){var q=d(this),r=!1;message_id=q.data("id");q.hasClass("verification_message")&&(r=q.data("verification"));message_id>e.last_message_id&&(n.append(q),h(q),r&&d(document).trigger("updateProfile",{contact_id:r}),p.push({id:message_id,$message:q}),m=message_id)}),e.last_message_id=m);k.resolve(p)});return k.promise()}var e=this,f=!1,g=0;d(document).on("wa_before_load",function(){clearTimeout(g);d(document).off("wa_before_load")});d(document).on("msg_conversation_update",
function(){c().then(function(k){k.length&&e.scroll2bottom(!0,!0);a()})});a()};CRMMessageConversationPage.prototype.initDelete=function(){function a(){var e=b.filter_contact_id?"contact="+b.filter_contact_id:b.filter_deal_id?"deal="+b.filter_deal_id:null,f=b.iframe?"?iframe=1":"";e=e?(b.iframe?"&":"?")+e:"";var g=b.$wrapper.closest("#c-messages-page").find("#c-messages-sidebar"),k=d.crm.app_url+"message/"+f+e;g.is(":visible")&&(f=g.find(`.c-message-wrapper[data-id='${b.conversation_id}']`).next(".c-message-wrapper"),
k=f.length?f.find("a.item").prop("href")+e:k);d.post(d.crm.app_url+"?module=message&action=conversationIdDelete",{id:b.conversation_id},function(l){"ok"===l.status&&d.crm.content.load(k)}).always(function(){c=!1},"json")}var b=this,c=!1;b.$wrapper.on("click",".js-delete-conversation",function(e){e.preventDefault();c||d.crm.confirm.show({title:b.locales.delete_conversation_title,button:b.locales.delete_conversation_button,onConfirm:a})})};CRMMessageConversationPage.prototype.initSendEmail=function(){var a=
!1;this.$wrapper.on("click",".js-show-message-dialog",function(b){b.preventDefault();var c=d(this);b=c.data("id");c=c.data("email");!a&&b&&(a=!0,d.post("?module=message&action=writeNewDialog",{contact_id:b,email:c},function(e){d.waDialog({html:e})}).always(function(){a=!1}))})};CRMMessageConversationPage.prototype.initSingleMessage=function(){var a=!1;this.$wrapper.on("click",".js-open-detail-message",function(b){b.preventDefault();a||(a=!0,b=d(this).data("dialog-url"),d.get(b,function(c){d.waDialog({html:c,
onClose:function(){a=!1}})}))})};CRMMessageConversationPage.prototype.initScrollToBottom=function(){function a(){if(d.contains(document,e[0])){var f=c.get(0).scrollHeight-c.scrollTop()-c.height();50>=f&&e.is(":visible")?e.hide():50<f&&e.is(":hidden")&&e.show()}else c.off("scroll touchmove",a)}var b=this,c=b.$wrapper.find(".js-messages-list"),e=b.$wrapper.find(".js-messages-list--to-bottom-button");c.on("scroll touchmove",a);e.on("click",()=>b.scroll2bottom(!0,!0));d(document).on("scroll_button_event",
(f,g)=>{b.old_message_id=g.old_message_id;b.last_message_id=g.last_message_id;b.scroll2bottom(!0,!0)})};CRMMessageConversationPage.prototype.scroll2bottom=function(a,b){function c(){setTimeout(function(){d.contains(document,f.$wrapper[0])&&k&&e()},0)}function e(){var l=f.$wrapper.find(".js-messages-list"),h=l.height(),m=l.get(0).scrollHeight;console.log(h,m);0<m?(h<m?b?l.animate({scrollTop:m},500):l.scrollTop(m):f.$wrapper.trigger("bigWindowEvent.lazy"),d.message.content.animate(!1)):setTimeout(()=>
e(),100)}var f=this,g=f.iframe?d(top.window):d(window);g.height();var k=!0;if(a)e();else if(d.crm.is_page_loaded||f.iframe)c();else g.one("scroll",function(){k=!1}).one("load",c)};CRMMessageConversationPage.prototype.initToggleSidebar=function(){var a=this.$wrapper.parent().parent(),b=this.$wrapper.find(".js-expand-sidebar");if(b.length)b.on("click",function(c){c.preventDefault();c=a.prev();if(a.is(":visible")){a.addClass("desktop-and-tablet-only");c.removeClass("desktop-and-tablet-only");c=window.history.state;
const e=c.content_uri.replace("?view=chat","").replace("&view=chat","");c.content_uri=e;window.history.replaceState(c,c.title,e)}})};return CRMMessageConversationPage}(jQuery),CRMMessagesProfileAdditional=function(d){CRMMessagesProfileAdditional=function(a){this.$main_wrapper=a.$wrapper;this.contact_id=a.contact_id;this.$wrapper=this.$main_wrapper.find("#c-messages-info-additional");this.initClass()};CRMMessagesProfileAdditional.prototype.initClass=function(){function a(g){c.$main_wrapper.prepend(`<iframe frameborder="0" src="${d.crm.app_url}frame/contact/${g}" style="width:100%; background-color: var(--background-color);"></iframe>`);
c.$main_wrapper.find("iframe").on("load",b)}function b(){var g=d(this),k=g.contents().find("#app");k.length?(new ResizeObserver(l=>{l=l[0].target.scrollHeight;g.css("height",l);300<l&&c.$wrapper.removeClass("hidden")})).observe(k[0]):setTimeout(()=>b(),100);g.on("beforeShowModal",()=>{g.addClass("height-full");c.$main_wrapper.addClass("freeze-sidebar")});g.on("beforeCloseModal",()=>{g.removeClass("height-full");c.$main_wrapper.removeClass("freeze-sidebar")})}var c=this,e=!1,f=d(window).width();if(1024<=
f)a(c.contact_id),e=!0;else d(window).on("resize",function(){e||d(this).width()===f||(f=d(this).width(),1024<=f&&(a(c.contact_id),e=!0))});d(document).on("updateProfile",(g,k)=>{c.$main_wrapper.find("iframe").remove();a(k.contact_id)});c.initTopInfoFields();c.initAdditionalContentLink()};CRMMessagesProfileAdditional.prototype.initTopInfoFields=function(){function a(){var g=d.crm.app_url+"?module=contact&action=tabs&id="+b.contact_id;f=!0;b.item_html={};d.get(g).done(function(k){d.each(k.data,function(l,
h){e.append(`<li class="custom-mb-16 bold">
                    <a href="javascript:void(0);" class="js-drawer-list-link js-drawer-list--${h.app_id} additional" data-dialog-url="${h.url||""}" data-class-name="custom" data-id="${h.app_id}">
                    <span class="js-drawer-list-link--header" >${h.title}</span>${null!==h.count?`<span class="hint custom-ml-4">${h.count}</span>`:""}</a></li>`);b.item_html[h.app_id]=h.html});e.find(".skeleton").hide();b.$main_wrapper.animate({scrollTop:b.$main_wrapper[0].scrollHeight},450)})}var b=this,c=b.$wrapper.find(".js-info-list"),e=b.$wrapper.find(".js-drawer-list"),f=!1;b.$wrapper.on("click",".js-info-toggle",function(g){g.preventDefault();g=d(this);f||a();g.toggleClass("is-active");c.slideToggle();
g.hasClass("is-active")&&b.$main_wrapper.animate({scrollTop:b.$main_wrapper[0].scrollHeight},450)})};CRMMessagesProfileAdditional.prototype.initAdditionalContentLink=function(){function a(e,f,g){function k(){m.append("\n                    <script>\n                    (() => {\n                        setTimeout( function() {\n                            Array.from(document.getElementsByTagName('a')).forEach(l => {\n                                l.setAttribute('target', '_top');\n                            });\n                        }, 200);\n                    })();\n                    \x3c/script>")}
var l=e.contents(),h=l.find("head"),m=l.find("body");l.find("html").attr("data-theme",document.documentElement.getAttribute("data-theme")).addClass("blank");h.append(`<meta charset="utf-8">
                <link rel="icon" href="data:;base64,iVBORw0KGgo=">
                <meta http-equiv="X-UA-Compatible" content="IE=edge">
                <meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
                <link href="${wa_url}wa-content/css/wa/wa-2.0.css" rel="stylesheet" type="text/css">
                <script src="${wa_url}wa-content/js/jquery/jquery-3.6.0.min.js"><\/script>`);m.addClass("blank custom-px-16");f?d.ajax({method:"GET",url:f,dataType:"html",global:!1,cache:!1}).done(function(n){m.html(n);k()}).fail(function(n){n.statusText&&m.html(n.statusText)}).always(function(){e.trigger("load")}):(g?(m.html(b.item_html[g]),k()):m.html("<div>Not found</div>"),e.trigger("load"))}var b=this,c=!1;b.$wrapper.on("click",".js-drawer-list-link",function(e){e.preventDefault();if(!c){c=!0;
var f=d(this).data("dialog-url"),g=d(this).hasClass("additional"),k=d(this).data("id")||null;e=d(this).data("class-name")||"";var l=d(this).find(".js-drawer-list-link--header").text();drawer_html=`<div class=\"drawer crm-help crm-message-additional ${e}\" id=\"\"> <div class=\"drawer-background\"><\/div> <div class=\"drawer-body\"><header class=\"drawer-header\"><h3>${l}<\/h3><\/header><a href=\"#\" class=\"drawer-close js-close-drawer\"><i class=\"fas fa-times\"><\/i><\/a><div class=\"drawer-block\">${'<div class="flexbox middle width-100 height-100 spinner-wrapper"><div class="spinner custom-p-16"></div></div>'}<\/div><\/div><\/div>`;
var h=`<iframe frameborder="0" src="${f}" style="width:100%;  height: 100vh; background-color: var(--background-color);"></iframe>`;g&&(h='<iframe frameborder="0" style="width:100%; height: 100vh; background-color: var(--background-color-blank);"></iframe>');b.drawer=d.waDrawer({html:drawer_html,direction:"right",onOpen:function(m,n){m.find(".drawer-block").append(h);const p=m.find("iframe");p.length?(p.on("load",function(){m.find(".spinner-wrapper").remove();d(p).contents().on("click","a",function(){d(this).data("link")&&
n.close()})}),p.on("beforeShowModal",()=>{p.addClass("z-10")}),p.on("beforeCloseModal",()=>{p.removeClass("z-10")}),g&&a(p,f,k)):m.find(".spinner-wrapper").remove()},onClose:function(){c=!1}})}})};return CRMMessagesProfileAdditional}(jQuery),CRMMessagesProfile=function(d){CRMMessagesProfile=function(a){this.$wrapper=a.$wrapper;this.photo_dialog_url=a.photo_dialog_url;this.locales=a.locales;this.icons_array={folder:'<i class="fas fa-folder"></i>',search:'<i class="fas fa-search"></i>',user:'<i class="fas fa-user"></i>',
blog:'<i class="fas fa-file-image"></i>',notebook:'<i class="fas fa-file"></i>',lock:'<i class="fas fa-lock"></i>',"lock-unlocked":'<i class="fas fa-lock-open"></i>',broom:'<i class="icon"><svg><use xlink:href="{$wa_url}wa-apps/blog/img/sprites/icons.svg?v={$wa->version()}#clean"></use></svg></i>',star:'<i class="fas fa-star"></i>',livejournal:'<i class="fas fa-pencil-alt"></i>',contact:'<i class="fas fa-users"></i>',lightning:'<i class="fas fa-bolt"></i>',"light-bulb":'<i class="fas fa-lightbulb"></i>',
pictures:'<i class="fas fa-images"></i>',reports:'<i class="fas fa-chart-bar"></i>',books:'<i class="fas fa-book"></i>',marker:'<i class="fas fa-map-marker-alt"></i>',lens:'<i class="icon"><svg><use xlink:href="{$wa_url}wa-apps/blog/img/sprites/icons.svg?v={$wa->version()}#lens"></use></svg></i>',"alarm-clock":'<i class="icon"><svg><use xlink:href="{$wa_url}wa-apps/blog/img/sprites/icons.svg?v={$wa->version()}#alarm"></use></svg></i>',"animal-monkey":'<i class="icon"><svg><use xlink:href="{$wa_url}wa-apps/blog/img/sprites/icons.svg?v={$wa->version()}#monkey"></use></svg></i>',
anchor:'<i class="fas fa-anchor"></i>',bean:'<i class="icon"><svg><use xlink:href="{$wa_url}wa-apps/blog/img/sprites/icons.svg?v={$wa->version()}#coffee-beans"></use></svg></i>',car:'<i class="fas fa-car"></i>',disk:'<i class="fas fa-save"></i>',cookie:'<i class="fas fa-cookie"></i>',burn:'<i class="fas fa-radiation-alt"></i>',clapperboard:'<i class="icon"><svg><use xlink:href="{$wa_url}wa-apps/blog/img/sprites/icons.svg?v={$wa->version()}#clapper"></use></svg></i>',bug:'<i class="fas fa-bug"></i>',
clock:'<i class="fas fa-clock"></i>',cup:'<i class="fas fa-coffee"></i>',home:'<i class="fas fa-home"></i>',fruit:'<i class="fas fa-apple-alt"></i>',luggage:'<i class="fas fa-briefcase"></i>',guitar:'<i class="fas fa-guitar"></i>',smiley:'<i class="fas fa-grin"></i>',"sport-soccer":'<i class="fas fa-futbol"></i>',target:'<i class="fas fa-bullseye"></i>',medal:'<i class="fas fa-award"></i>',phone:'<i class="fas fa-phone"></i>',store:'<i class="fas fa-store"></i>',basket:'<i class="fas fa-shopping-basket"></i>',
pencil:'<i class="fas fa-pen-alt"></i>',lifebuoy:'<i class="fas fa-life-ring "></i>',screen:'<i class="fas fa-tablet-alt"></i>',noname:'<i class="fas fa-user-friends"></i>'};this.contact_id=a.contact_id||!1;this.editable=a.editable||!1;this.initClass()};CRMMessagesProfile.prototype.initClass=function(){this.initResponsibleLink();this.initTopInfoFields();this.initMessage();this.initAssignTags();this.initSegments()};CRMMessagesProfile.prototype.initResponsibleLink=function(){this.$wrapper.find(".profile-responsible-link .responsible-link").on("click",
function(){d.get(d(this).data("dialog-url"),function(a){d.waDialog({remain_after_load:!0,html:a})})})};CRMMessagesProfile.prototype.initTopInfoFields=function(){var a=this.$wrapper.find(".js-info-list");this.$wrapper.on("click",".js-info-toggle",function(b){b.preventDefault();d(this).toggleClass("is-active");a.slideToggle()})};CRMMessagesProfile.prototype.initMessage=function(){this.initSendEmail();this.initSendSMS()};CRMMessagesProfile.prototype.initSendEmail=function(){var a=!1;this.$wrapper.on("click",
".js-show-message-dialog",function(b){b.preventDefault();var c=d(this);b=c.data("id");c=c.data("email");!a&&b&&(a=!0,d.post("?module=message&action=writeNewDialog",{contact_id:b,email:c},function(e){d.waDialog({html:e})}).always(function(){a=!1}))})};CRMMessagesProfile.prototype.initSendSMS=function(){var a=!1;this.$wrapper.on("click",".js-show-send-sms-dialog",function(b){b.preventDefault();var c=d(this);b=c.data("id");c=c.data("phone");!a&&b&&(a=!0,d.get("?module=message&action=writeSMSNewDialog",
{contact_id:b,phone:c},function(e){d.waDialog({html:e})}).always(function(){a=!1}))})};CRMMessagesProfile.prototype.initAssignTags=function(){var a=this.$wrapper.find(".crm-contact-assign-tags"),b=d.crm.app_url+"?module=contactOperation&action=assignTags&is_assign=1",c=parseInt(this.contact_id)||0;a.click(function(e){e.preventDefault();d.get(b,{contact_ids:[c]},function(f){d.waDialog({html:f})})})};CRMMessagesProfile.prototype.initSegments=function(){function a(k){var l=b.$wrapper.find(".js-segment-list"),
h=l.find("a").length;k.length||k.push({id:!1,name:b.locales.no_segments});d.each(k,function(m,n){m="javascript:void(0);";var p="",q='<span class="hint">'+n.name+"</span>";n.id&&(m=d.crm.app_url+"contact/segment/"+n.id+"/",p=b.icons_array[n.icon]?b.icons_array[n.icon]:b.icons_array.noname,q="<span>"+n.name+"</span>");n='<a href="'+m+'">'+p+q+"</a>";h&&(n=", "+n);l.append(n);h=!0})}var b=this,c=b.$wrapper.find(".crm-contact-assign-segments"),e=d.crm.app_url+"?module=contactOperation&action=addToSegments&is_assign=1",
f=parseInt(b.contact_id)||0;c.click(function(k){k.preventDefault();d.get(e,{contact_ids:[f]},function(l){d.waDialog({html:l,onOpen:function(h){new CRMContactsOperationAddToSegments({$wrapper:h,context:{contact_ids:[f]},is_assign:1})}})})});var g=!1;b.$wrapper.on("click",".js-show-dynamic-segments",function(k){k.preventDefault();var l=d(this);l.find(".icon").removeClass("fa-filter").addClass("fa-spinner fa-spin");g&&g.abort();g=d.post("?module=contact&action=segmentSearch",{id:b.contact_id},function(h){"ok"==
h.status&&(a(h.data.segments),l.remove())}).always(function(){g=!1})})};return CRMMessagesProfile}(jQuery),CRMEmailConversationEmailSender=function(d){CRMEmailConversationEmailSender=function(a){var b=this;b.$wrapper=a.$wrapper;b.$replySection=b.$wrapper.closest(".c-reply-section");b.$resize_button=b.$replySection.find(".js-message-resize");b.$skeleton_wrapper=b.$wrapper.closest(".c-messages-conversation-wrapper").find(".skeleton-wrapper");b.$form=b.$wrapper.find("form");b.$textarea=b.$wrapper.find(".js-wysiwyg");
b.$textarea_small=b.$wrapper.find(".js-visible-textarea-small");b.$sender_email_select=b.$wrapper.find(".js-sender-email-select");b.$sender_email_select_val=b.$sender_email_select.val();b.$sender_email=b.$wrapper.find(".js-sender-email");b.$subject_input=b.$replySection.find('input[name="subject"]');b.subject_input_val=b.$subject_input.val();b.$copy_wrapper=b.$wrapper.find(".email-copy-wrapper");b.$copy_wrapper_collapsed=b.$wrapper.find(".email-copy-wrapper-collapsed");b.file_template_html=a.file_template_html;
b.max_upload_size=a.max_upload_size;b.locales=a.locales;b.hash=a.hash;b.send_action_url=a.send_action_url;b.body=a.body||"";b.deal_id=a.deal_id;b.is_changed=!1;b.is_locked=!1;b.body_old=b.body;if(!b.send_action_url)throw Error("send_action_url option required");b.initClass();b.filesController=b.getFilesController();b.disableResizer=function(c){c?(b.is_changed=!0,b.$resize_button.addClass("is-disabled")):(b.is_changed=!1,b.$resize_button.removeClass("is-disabled"))}};CRMEmailConversationEmailSender.prototype.initClass=
function(){this.senderEmailSelect();this.initWYSIWYG();this.initVisiblityWatcher();this.initSave();this.initPersonalSettingsDialog();this.initEmailCopy()};CRMEmailConversationEmailSender.prototype.initVisiblityWatcher=function(){function a(g){g?(e.addClass("is-extended").trigger("resize"),f.addClass("scroll-lock")):b.is_changed||(e.removeClass("is-extended").trigger("resize"),f.removeClass("scroll-lock"))}var b=this,c=b.$textarea,e=b.$replySection,f=d(".c-messages-page-content-wrapper");e.on("click",
".js-revert",function(){c.redactor("code.set",b.body);b.disableResizer(!1);a(!1);b.$body_redactor_p=b.$wrapper.find(".redactor-layer.redactor-styles.redactor-layer-img-edit section p").eq(0);b.$subject_input.val(b.subject_input_val);b.$sender_email_select.val(b.$sender_email_select_val).change();b.$copy_wrapper.find(".email-copy-user").each(function(){d(this).remove()});b.$copy_wrapper_collapsed.find(".email-copy-user").each(function(){d(this).remove()});b.$copy_wrapper.hasClass("email-copy-wrapper-block")&&
b.$wrapper.find(".js-email-copy-link").click();b.$copy_wrapper_collapsed.removeClass("email-copy-wrapper-collapsed-block")});e.on("click",".js-message-resize",function(){a(!1)});e.on("click",".js-message-resize-open",function(){var g=b.$wrapper.find(".redactor-layer.redactor-styles.redactor-layer-img-edit");b.body=g.html();a(!0);b.disableResizer(!1)});b.$subject_input.on("change",function(g){b.disableResizer(!0)})};CRMEmailConversationEmailSender.prototype.senderEmailSelect=function(){var a=this;
a.$wrapper.on("change",a.$sender_email_select,function(b){b.preventDefault();a.$sender_email.val(a.$sender_email_select.val());a.disableResizer(!0)})};CRMEmailConversationEmailSender.prototype.getFilesController=function(){function a(q){q.length&&(d.each(q,function(r,u){r=c.files_storage;var v=r.push,t=d(h);t.find(".js-name").text(u.name);l.prepend(t);f.prop("disabled")&&f.prop("disabled",!1);v.call(r,{$file:t,file:u})}),k.val(""))}function b(q){var r=[];d.each(c.files_storage,function(u,v){q[0]!==
v.$file[0]?r.push(v):q.remove()});c.files_storage=r}var c=this,e=c.$wrapper.find(".js-files-wrapper"),f=c.$wrapper.find(".c-visible .js-save-button");if(!e.length)return!1;var g=c.$wrapper.find(".js-default-drop-area"),k=c.$wrapper.find(".js-drop-field"),l=c.$wrapper.find(".c-upload-list"),h=c.file_template_html,m=d.crm.app_url+"?module=file&action=uploadTmp",n=0,p=0;c.files_storage=[];c.$form.on("click",".js-message-attachment",function(){k.click()});k.on("change",function(q){q.preventDefault();
a(this.files)});g.on("drop",function(q){q.preventDefault();a(q.originalEvent.dataTransfer.files)});g.on("dragover",function(q){q.preventDefault();g.addClass("is-hover");clearTimeout(p);p=setTimeout(function(){g.removeClass("is-hover")},100)});document.onpaste=function(q){a((q.clipboardData||q.originalEvent.clipboardData).files)};c.$form.on("click",".js-file-delete",function(q){q.preventDefault();b(d(this).closest(".c-upload-item"))});return{uploadFiles:function(q,r){function u(t){function w(){var A=
new FormData,D=document.cookie.match(RegExp("(?:^|; )_csrf=([^;]*)"));(D=D?decodeURIComponent(D[1]):"")&&A.append("_csrf",D);q&&q.length&&d.each(q,function(E,F){F.name&&F.value&&A.append(F.name,F.value)});A.append("file_size",t.file.size);A.append("files",t.file);A.append("file_end",1);d.ajax({xhr:function(){var E=new window.XMLHttpRequest;E.upload.addEventListener("progress",function(F){F.lengthComputable&&(F=parseInt(F.loaded/F.total*100),y.css("--progress-value",F),100===F&&(y.css("background",
"transparent"),z.show()))},!1);return E},url:m,data:A,cache:!1,contentType:!1,processData:!1,type:"POST",success:function(E){setTimeout(function(){d.contains(document,x[0])&&(--n,0>=n&&v())},2E3)}}).always(function(){c.is_locked=!1})}var x=t.$file,y=x.find(".js-bar"),z=y.find(".js-progress-success-icon"),B=x.find(".js-status");x.addClass("is-upload");if(c.max_upload_size>t.file.size)w();else{var C=c.$form.find(".js-submit-button");B.addClass("errormsg");x.removeClass("is-upload");c.is_locked=!1;f.find("svg").removeClass("fa-spinner fa-spin").addClass("fa-arrow-up");
C.attr("disabled",!1);c.$textarea_small.attr("disabled",!1);k.prop("disabled",!1);c.$form.find("button").prop("disabled",!1)}}var v=r?r:function(){};c.files_storage.length?(n=c.files_storage.length,d.each(c.files_storage,function(t,w){u(w)})):v()}}};CRMEmailConversationEmailSender.prototype.initWYSIWYG=function(){var a=this,b=a.$textarea;d.crm.initWYSIWYG(b,{maxHeight:50,allowedAttr:[["section","data-role"]],callbacks:{change:function(){a.disableResizer(!0)}}});a.body&&b.redactor("code.set",a.body);
a.$body_redactor_p=a.$wrapper.find(".redactor-layer.redactor-styles.redactor-layer-img-edit section p").eq(0)};CRMEmailConversationEmailSender.prototype.initSave=function(){function a(){k.css("min-height","auto");var p=k[0].scrollHeight;250>p?k.css("min-height",p+"px"):k.css("min-height","250px")}function b(){var p=g.send_action_url,q=g.$form.serializeArray();m.prop("disabled",!0);k.attr("disabled",!0);d.ajax({method:"POST",url:p,data:q,dataType:"json"}).done(function(r){var u=jQuery.parseJSON(r.data.html);
c(r.data.id?r.data.id:r.data.message_id);f();l.attr("disabled",!0);h.attr("disabled",!0);g.body=g.body_old;g.$replySection.find(".js-revert").trigger("click");a();d("#c-messages-page #c-messages-sidebar").length&&d(document).trigger("msg_sidebar_upd_needed");var v=g.$wrapper.find(".redactor-layer.redactor-styles.redactor-layer-img-edit");r=v.find("blockquote").eq(0);v=v.find("> p").eq(1);var t=d(u).find(".c-message-body").html(),w=d(u).find(".c-contact-link--name").html();u=d(u).find(".c-date.hint").data("time");
r.html(t);v.html(`${u}, ${w} ${g.locales.wrote}:`)}).fail(function(r){var u=g.$form.find("#tooltip-error-message");r=Object.values(response.errors);u.addClass("errormsg");d.each(r,function(v,t){u.append(`<span><i class="fas fa-exclamation-triangle state-error"></i> <span class="small">${t}</span></span>`)});f();l.attr("disabled",!0);h.attr("disabled",!0);g.body=g.body_old;g.$replySection.find(".js-revert").trigger("click");a();g.is_locked=!1;response.errors&&console.error(response.errors);g.$textarea.on("focus",
e);k.on("focus",e);g.$form.on("change",e)}).always(function(){g.is_locked=!1})}function c(p){var q=n.find("#js-message-conversation-page"),r=q.data("conv-id"),u=q.find(".c-conversation-body--blank");q.find(".js-messages-list--transparent-layer");d.ajax({url:d.crm.app_url+"?module=messageConversationId&id="+r,type:"POST",dataType:"html",beforeSend:function(){},complete:function(){},data:{delay:1},success:function(v){var t=d(v).find(".js-messages-list");v=d(v).find(".js-message-wrapper");var w=v.eq(0).data("id");
if(v=v.length){10>v&&t.find(".js-lazy-load").remove();t=t.html();u.append(t);x();function x(){function y(){0==C&&(g.$message_list.html(u.html()),u.html(""),d(document).trigger("scroll_button_event",{old_message_id:w,last_message_id:p}),d(document).trigger("new_message_lazy"))}var z=u[0].getElementsByTagName("img"),B=u[0].getElementsByTagName("video"),C=z.length+B.length;y();for(var A=0;A<B.length;A++)3<=B[A].readyState?(C--,y()):(B[A].addEventListener("loadeddata",function(){C--;y()}),B[A].addEventListener("error",
function(){C--;y()}));for(A=0;A<z.length;A++)z[A].complete?(C--,y()):(z[A].addEventListener("load",function(){C--;y()}),z[A].addEventListener("error",function(){C--;y()}))}}}})}function e(){g.$form.find("#tooltip-error-message").removeClass("errormsg").html("");k.off("focus",e);g.$textarea.off("focus",e);g.$form.off("change",e)}function f(){l.find("svg").removeClass("fa-spinner fa-spin").addClass("fa-arrow-up");h.attr("disabled",!1);k.attr("disabled",!1);m.prop("disabled",!1);g.$form.find("button").prop("disabled",
!1);k.val("");760<d(window).width()&&k.focus();if(g.files_storage.length){var p=g.$form.find(".c-upload-item");d.each(p,function(q,r){r.remove()});g.files_storage=[]}}var g=this,k=g.$textarea_small,l=g.$wrapper.find(".c-visible .js-save-button"),h=g.$form.find(".js-submit-button"),m=g.$form.find(".js-drop-field"),n=d(".c-messages-page-content-wrapper");g.$message_list=n.find(".js-messages-list");d(document).on("wa_before_load",function(){d(document).off("wa_before_load")});k.on("keydown",function(p){13!==
p.keyCode&&10!==p.keyCode||p.ctrlKey||p.metaKey||p.shiftKey||(p.preventDefault(),""!==k.val()||g.files_storage.length?g.$form.submit():(k.addClass("shake animated"),setTimeout(function(){k.removeClass("shake animated")},500)))});k.on("focus",function(p){g.$replySection.addClass("focused")});k.on("blur",function(p){g.$replySection.removeClass("focused")});k.on("keyup",function(p){if(13!==p.keyCode&&10!==p.keyCode||!(p.ctrlKey||p.metaKey||p.shiftKey))""!==k.val()||g.files_storage.length?l.prop("disabled")&&
l.prop("disabled",!1):l.prop("disabled")||l.prop("disabled",!0);else if(!p.shiftKey){var q=k.val(),r=k.prop("selectionStart");p=q.slice(0,r);q=q.slice(r);k.val(p+"\n"+q)}a();g.$body_redactor_p.html(k.val())});g.$form.on("submit",function(p){p.preventDefault();g.is_locked||(g.is_locked=!0,p=d('<span class="icon size-16"><i class="fas fa-spinner wa-animation-spin custom-mr-4"></i></span>'),l.find("svg").removeClass("fa-arrow-up").addClass("fa-spinner fa-spin"),h.attr("disabled",!0),p.insertBefore(h),
g.$form.find("button").prop("disabled",!0),g.filesController.uploadFiles([{name:"hash",value:g.hash}],b))})};CRMEmailConversationEmailSender.prototype.initPersonalSettingsDialog=function(){function a(){c||(c=!0,d.post(d.crm.app_url+"?module=email&action=personalSettingsDialog",{},function(e){d.waDialog({html:e,options:{onSave:function(f){b.$textarea.redactor("core.editor").find('[data-role="c-email-signature"]').html(f.email_signature||"");b.$wrapper.find(".js-sender-name").text(f.sender_name||"")}}})}).always(function(){c=
!1}))}var b=this,c=!1;b.$wrapper.on("click",".js-show-personal-settings-dialog",function(e){e.preventDefault();a()})};CRMEmailConversationEmailSender.prototype.initEmailCopy=function(){function a(){var n=d.trim(l.val()).split(/[,:;]/);if(n[0].length)return d.each(n,function(p,q){p=d.trim(q).split(/\s+/);var r=!1,u=q=null;d.each(p,function(v,t){d.crm.check.email(t)&&!r&&(q=t.replace(/<|>/g,""),r=v)});!1!==r&&p.splice(r,1);u=p.join(" ");q&&u&&c(0,q,u);q&&!u&&b(0,q,q);u&&!q&&(l.addClass("shake animated"),
setTimeout(function(){l.removeClass("shake animated")},500));r=!1;u=q=null}),!1}function b(n,p,q){k.children('[data-email="'+p+'"]').length&&"0"!==n||!p.length||(e.$wrapper.find(".email-copy-input-div").before('<div class="email-copy-user" title="'+d.crm.escape(p)+'" data-contact-id="'+d.crm.escape(n)+'" data-email="'+d.crm.escape(p)+'">'+q+' <a title="'+e.locales.remove_form_cc+'" class="remove-cc js-remove-cc">x</a> <input name="cc['+d.crm.escape(p)+'][email]" type="hidden" value="'+d.crm.escape(p)+
'" /><input name="cc['+d.crm.escape(p)+'][id]" type="hidden" value="'+d.crm.escape(n)+'" /></div>'),e.$wrapper.find(".email-copy-text-collapsed").append('<div class="email-copy-user" title="'+d.crm.escape(p)+'" data-email="'+d.crm.escape(p)+'">'+q+"</div>"));l.val("").focus()}function c(n,p,q){k.children('[data-email="'+p+'"]').length&&"0"!==n||!p.length||(e.$wrapper.find(".email-copy-input-div").before('<div class="email-copy-user" title="'+d.crm.escape(p)+'" data-contact-id="'+n+'" data-email="'+
d.crm.escape(p)+'">'+d.crm.escape(q)+' <a title="'+e.locales.remove_form_cc+'" class="remove-cc js-remove-cc">x</a> <input name="cc['+d.crm.escape(p)+'][email]" type="hidden" value="'+d.crm.escape(p)+'" /><input name="cc['+d.crm.escape(p)+'][id]" type="hidden" value="'+d.crm.escape(n)+'" /><input name="cc['+d.crm.escape(p)+'][name]" type="hidden" value="'+d.crm.escape(q)+'" /></div>'),e.$wrapper.find(".email-copy-text-collapsed").append('<div class="email-copy-user" title="'+d.crm.escape(p)+'" data-email="'+
d.crm.escape(p)+'">'+d.crm.escape(q)+"</div>"));l.val("").focus()}var e=this,f=e.$wrapper.find(".email-copy-wrapper"),g=f.find(".email-copy-area"),k=g.find(".email-copy-text"),l=g.find(".email-copy-input"),h=f.find(".deal-participants-area"),m=e.$wrapper.find(".email-copy-wrapper-collapsed");l.autocomplete({source:d.crm.app_url+"?module=autocomplete&emailcomplete=true",appendTo:e.$wrapper,minLength:0,focus:function(){return!1},select:function(n,p){b(p.item.id,p.item.email,'<i class="icon userpic" style="background-image: url('+
p.item.photo_url+');"></i><b>'+p.item.name+"</b>");l.val("");return!1}}).data("ui-autocomplete")._renderItem=function(n,p){return d('<li class="ui-menu-item-html"><div>'+p.value+"</div></li>").appendTo(n)};l.on("focus",function(){l.data("uiAutocomplete").search(l.val())});e.$wrapper.on("click",".js-email-copy-link, .email-copy-text-collapsed",function(n){n.preventDefault();n=e.$wrapper.find(".js-email-copy-link-icon");f.toggleClass("email-copy-wrapper-block");f.is(":visible")?(n.removeClass("fa-caret-right").addClass("fa-caret-down"),
l.focus(),m.removeClass("email-copy-wrapper-collapsed-block")):(n.removeClass("fa-caret-down").addClass("fa-caret-right"),e.$wrapper.find(".email-copy-text-collapsed").children().length&&m.addClass("email-copy-wrapper-collapsed-block"));e.$wrapper.closest(".js-reply-wrapper").trigger("resize")});g.on("click",function(){l.focus()});h.on("click",".email-copy-user",function(){var n=d(this).data("cc-contact-id"),p=d(this).data("cc-email"),q=d(this).html();b(n,p,q)});l.on("focusout",function(n){a()});
l.on("keydown",function(n){13==n.keyCode&&(n.preventDefault(),a())});k.on("click",".js-remove-cc",function(n){n.preventDefault();n=d(this).parent(".email-copy-user");var p=n.data("email");n.remove();e.$wrapper.find(".email-copy-text-collapsed").children('[data-email="'+p+'"]').remove()});l.on("keydown",function(n){if(8==n.keyCode&&0==l.val().length){n=e.$wrapper.find(".email-copy-text .email-copy-user:last");var p=n.data("email");n.remove();e.$wrapper.find(".email-copy-text-collapsed").children('[data-email="'+
p+'"]').remove();l.focus()}})};return CRMEmailConversationEmailSender}(jQuery),CRMImConversationSection=function(d){CRMImConversationSection=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$textarea=this.$form.find(".js-textarea");this.$replySection=this.$wrapper.closest(".c-reply-section");this.$submitButton=this.$form.find(".js-save-button");this.$attachment_icon=this.$form.find(".js-message-attachment");this.$skeleton_wrapper=this.$wrapper.closest(".c-messages-conversation-wrapper").find(".skeleton-wrapper");
this.send_action_url=a.send_action_url;this.file_template_html=a.file_template_html;this.hash=a.hash;this.max_upload_size=a.max_upload_size;this.is_images_enabled=a.is_images_enabled;this.is_files_enabled=a.is_files_enabled;this.hover_class="is-hover";this.files_controller=this.getFilesController();this.is_locked=!1;this.initClass()};CRMImConversationSection.prototype.initClass=function(){this.initSubmit()};CRMImConversationSection.prototype.getFilesController=function(){function a(n){n.length&&(d.each(n,
function(p,q){p=c.files_storage;var r=p.push,u=d(k);u.find(".js-name").text(q.name);f.prepend(u);c.$submitButton.prop("disabled")&&c.$submitButton.prop("disabled",!1);r.call(p,{$file:u,file:q})}),g.val(""))}function b(n){var p=[];d.each(c.files_storage,function(q,r){n[0]!==r.$file[0]?p.push(r):n.remove()});c.files_storage=p}var c=this,e=c.$form.find(".js-default-drop-area"),f=c.$form.find(".js-upload-list"),g=c.$form.find(".js-drop-field"),k=c.file_template_html,l=d.crm.app_url+"?module=file&action=uploadTmp";
c.files_storage=[];var h=0,m=0;c.$attachment_icon.on("click",function(){g.click()});g.on("change",function(n){n.preventDefault();a(this.files)});e.on("drop",function(n){n.preventDefault();a(n.originalEvent.dataTransfer.files)});e.on("dragover",function(n){n.preventDefault();e.addClass(c.hover_class);clearTimeout(m);m=setTimeout(function(){e.removeClass(c.hover_class)},100)});document.onpaste=function(n){a((n.clipboardData||n.originalEvent.clipboardData).files)};c.$wrapper.on("click",".js-file-delete",
function(n){n.preventDefault();b(d(this).closest(".c-upload-item"));c.files_storage.length||""!==c.$textarea.val()||c.$submitButton.prop("disabled")||c.$submitButton.prop("disabled",!0)});return{uploadFiles:function(n,p,q){function r(v){function t(){var C=new FormData,A=document.cookie.match(RegExp("(?:^|; )_csrf=([^;]*)"));(A=A?decodeURIComponent(A[1]):"")&&C.append("_csrf",A);n&&n.length&&d.each(n,function(D,E){E.name&&E.value&&C.append(E.name,E.value)});C.append("file_size",v.file.size);C.append("files",
v.file);C.append("file_end",1);d.ajax({xhr:function(){var D=new window.XMLHttpRequest;D.upload.addEventListener("progress",function(E){E.lengthComputable&&(E=parseInt(E.loaded/E.total*100),B.css("--progress-value",E),100===E&&(B.css("background","transparent"),z.show()))},!1);return D},url:l,data:C,cache:!1,contentType:!1,processData:!1,type:"POST",success:function(D){setTimeout(function(){d.contains(document,x[0])&&(--h,0>=h&&u())},250)}}).always(function(){is_locked=!1})}var w="image"===v.file.type.split("/")[0]?
"image":"file";w=p?w===p:!0;var x=v.$file;x.find(".js-file-delete");var y=x.find(".js-status"),z=x.find(".js-progress-success-icon"),B=x.find(".js-bar");x.addClass("is-upload");c.max_upload_size>v.file.size?w?t():(--h,0>=h&&u()):(y.addClass("errormsg"),x.removeClass("is-upload"),c.is_locked=!1,c.$submitButton.prop("disabled",!1),c.$submitButton.find("svg").removeClass("fa-spinner fa-spin").addClass("fa-arrow-up"),c.$textarea.attr("disabled",!1),g.prop("disabled",!1),c.$form.find("button").prop("disabled",
!1))}var u=q?q:function(){};c.files_storage.length?(h=c.files_storage.length,d.each(c.files_storage,function(v,t){r(t)})):u()}}};CRMImConversationSection.prototype.initSubmit=function(){function a(){c.css("min-height","auto");var l=c[0].scrollHeight;250>l?c.css("min-height",l+"px"):c.css("min-height","250px")}var b=this,c=b.$textarea,e=b.$submitButton;b.$form.find(".js-upload-list");var f=b.is_images_enabled?"files-":"",g=b.$form.find(".js-drop-field"),k=b.is_images_enabled?"file":!1;$main_wrapper=
d(".c-messages-page-content-wrapper");b.$message_list=$main_wrapper.find(".js-messages-list");b.is_locked=!1;d(document).on("wa_before_load",function(){d(document).off("wa_before_load")});c.on("keydown",function(l){13!==l.keyCode&&10!==l.keyCode||l.ctrlKey||l.metaKey||l.shiftKey||(l.preventDefault(),""!==c.val()||b.files_storage.length?b.$form.submit():(c.addClass("shake animated"),setTimeout(function(){c.removeClass("shake animated")},500)))});c.on("focus",function(l){b.$replySection.addClass("focused")});
c.on("blur",function(l){b.$replySection.removeClass("focused")});c.on("keyup",function(l){if(13!==l.keyCode&&10!==l.keyCode||!(l.ctrlKey||l.metaKey||l.shiftKey))""!==c.val()||b.files_storage.length?e.prop("disabled")&&e.prop("disabled",!1):e.prop("disabled")||e.prop("disabled",!0);else if(!l.shiftKey){var h=c.val(),m=c.prop("selectionStart");l=h.slice(0,m);h=h.slice(m);c.val(l+"\n"+h)}a()});b.$form.on("submit",function(l){function h(q){var r=$main_wrapper.find("#js-message-conversation-page"),u=r.data("conv-id"),
v=r.find(".c-conversation-body--blank");r.find(".js-messages-list--transparent-layer");d.ajax({url:d.crm.app_url+"?module=messageConversationId&id="+u,type:"POST",dataType:"html",beforeSend:function(){},complete:function(){},data:{delay:1},success:function(t){var w=d(t).find(".js-messages-list");t=d(t).find(".js-message-wrapper");var x=t.eq(0).data("id");if(t=t.length){10>t&&w.find(".js-lazy-load").remove();w=w.html();v.append(w);y();function y(){function z(){0==A&&(b.$message_list.html(v.html()),
v.html(""),d(document).trigger("scroll_button_event",{old_message_id:x,last_message_id:q}),d(document).trigger("new_message_lazy"))}var B=v[0].getElementsByTagName("img"),C=v[0].getElementsByTagName("video"),A=B.length+C.length;z();for(var D=0;D<C.length;D++)3<=C[D].readyState?(A--,z()):(C[D].addEventListener("loadeddata",function(){A--;z()}),C[D].addEventListener("error",function(){A--;z()}));for(D=0;D<B.length;D++)B[D].complete?(A--,z()):(B[D].addEventListener("load",function(){A--;z()}),B[D].addEventListener("error",
function(){A--;z()}))}}}})}function m(){b.$form.find("#tooltip-error-message").removeClass("errormsg").html("");b.$form.off("change",m);c.off("focus",m)}function n(){e.prop("disabled",!1);e.find("svg").removeClass("fa-spinner fa-spin").addClass("fa-arrow-up");c.attr("disabled",!1);g.prop("disabled",!1);b.$form.find("button").prop("disabled",!1);c.val("");760<d(window).width()&&c.focus();if(b.files_storage.length){var q=b.$form.find(".c-upload-item");d.each(q,function(r,u){u.remove()});b.files_storage=
[]}}l.preventDefault();if(!b.is_locked){b.is_locked=!0;e.prop("disabled",!0);e.find("svg").removeClass("fa-arrow-up").addClass("fa-spinner fa-spin");b.$form.find("button").prop("disabled",!0);if(b.is_images_enabled||b.is_files_enabled){var p=[{name:"hash",value:f+b.hash}];b.is_images_enabled?b.files_controller.uploadFiles([{name:"hash",value:"photos-"+b.hash}],"image",r):r();function r(){b.files_controller.uploadFiles(p,k,q)}}else q();function q(){var r=b.send_action_url,u=b.$form.serializeArray();
c.attr("disabled",!0);g.prop("disabled",!0);d.post(r,u,function(v){if("ok"===v.status)h(v.data.message_id),n(),e.prop("disabled",!0),a(),d("#c-messages-page #c-messages-sidebar").length&&d(document).trigger("msg_sidebar_upd_needed");else{console.error(v);var t=b.$form.find("#tooltip-error-message");v=Object.values(v.errors);t.addClass("errormsg");d.each(v,function(w,x){t.append(`<span><i class="fas fa-exclamation-triangle state-error"></i> <span class="small">${x}</span></span>`)});c.addClass("shake animated");
setTimeout(function(){c.removeClass("shake animated")},500);b.is_locked=!1;n();e.prop("disabled",!0);a();c.on("focus",m);b.$form.on("change",m)}}).always(function(){b.is_locked=!1})}}})};return CRMImConversationSection}(jQuery),CRMConversationAssociateDealDialog=function(d){CRMConversationAssociateDealDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$footer=this.$wrapper.find(".js-dialog-footer");this.$submit=this.$form.find(".js-submit");this.$deal_name=this.$form.find(".js-deal-name");
this.$deal_funnel=this.$form.find(".js-select-deal-funnel");this.$deal_stage=this.$form.find(".js-select-deal-stage");this.$deal_id=this.$form.find(".js-deal-id");this.$dialog=this.$wrapper.data("dialog");this.initClass()};CRMConversationAssociateDealDialog.prototype.initClass=function(){this.initSelectDeal();this.initSubmit()};CRMConversationAssociateDealDialog.prototype.initSelectDeal=function(){var a=this,b=a.$form.find(".js-select-deal .js-visible-link .js-text"),c=a.$form.find(".js-select-funnel"),
e=a.$form.find(".js-deals-list"),f=a.$form.find(".js-deal-name-field");a.$form.on("click",".js-create-new-deal",function(){a.$submit.addClass("yellow").removeAttr("disabled");var g=d(this).find(".js-text").html();a.deal_selected=!0;c.removeClass("hidden");f.removeClass("hidden");a.$deal_name.focus();b.html(g);a.$deal_id.val("0")});a.$form.on("click",".js-deal-item",function(){a.$submit.addClass("yellow").removeAttr("disabled");var g=d(this).find(".js-text").html();a.deal_selected=!0;e.find("li").removeClass("selected");
d(this).parent().addClass("selected");b.html(g);c.addClass("hidden");f.addClass("hidden");a.$deal_name.val("");a.$deal_id.val(d(this).data("deal-id"))});e.on("click",function(){e.hide();setTimeout(function(){e.removeAttr("style")},200)});a.$form.on("change",".js-select-deal-funnel",function(){a.$form.find(".js-select-stage-wrapper").load("?module=deal&action=stagesByFunnel&id="+d(this).val())})};CRMConversationAssociateDealDialog.prototype.initSubmit=function(){function a(){var c=d('<span class="icon size-16"><i class="fas fa-spinner wa-animation-spin custom-mr-4"></i></span>'),
e=d.crm.app_url+"?module=message&action=conversationAssociateDealSave",f=b.$form.serializeArray();b.$submit.prop("disabled",!0);b.$footer.append(c);d.post(e,f,function(g){"ok"===g.status?(d.crm.content.reload(),b.$dialog.close()):(b.$submit.prop("disabled",!1),c.remove())})}var b=this;b.$form.on("submit",function(c){c.preventDefault();if(!b.$deal_id.val())return b.$wrapper.addClass("shake animated"),setTimeout(function(){b.$wrapper.removeClass("shake animated")},500),!1;if(0==b.$deal_id.val()&&!d.trim(b.$deal_name.val()))return b.$deal_name.addClass("shake animated"),
setTimeout(function(){b.$deal_name.removeClass("shake animated")},500),!1;a()})};return CRMConversationAssociateDealDialog}(jQuery);var CRMPageMessagesOperations=function(d){CRMPageMessagesOperations=function(a){this.$wrapper=a.$wrapper;this.$bar=this.$wrapper.find(".js-operation-wrapper");this.$list=this.$wrapper.find(".js-messages-section");this.$list_header=this.$wrapper.find(".c-messages-header");this.$checkbox_all=this.$bar.find("#js-operation-main-checkbox");this.$checkbox_all_counter=this.$bar.find(".js-operation-badge");this.is_admin=a.is_admin;this.page=a.page||1;this.limit=a.limit||30;this.total_count=a.total_count||
0;this.total_items_at_page_count=this.getTotalItemsAtPage()||0;this.view=a.view||"all";this.locales=a.locales||[];this.checked_count=0;this.read_list=[];this.unread_list=[];this.unread_counter=this.read_counter=0;this.deal_list=[];this.deal_counter=0;this.no_deal_list=[];this.no_deal_counter=0;this.is_shown=0<this.checked_count;this.is_checked_all=!1;this.initClass()};CRMPageMessagesOperations.prototype.initClass=function(){this.initCheckboxAll();this.showOrHideBar();this.initOperations();this.initItemCheckbox()};
CRMPageMessagesOperations.prototype.initCheckboxAll=function(){var a=this;a.$checkbox_all.click(function(){var b=d(this),c=b.is(":checked");0<a.checked_count?a.checked_count<=a.getTotalItemsAtPage()?a.unselectAll():a.selectAll():(b.prop("checked",c),c?a.selectAll():a.unselectAll());a.formBar()})};CRMPageMessagesOperations.prototype.initOperations=function(){var a=this;a.$bar.on("click",".crm-operation-link",function(b){b.preventDefault();switch(d(this).data("id")){case "associate":a.associateWithDeal();
break;case "detach":a.detachFromDeals();break;case "read":a.markAsRead();break;case "unread":a.markAsUnread();break;case "delete":a.deleteConversation()}})};CRMPageMessagesOperations.prototype.updateBarCount=function(a,b,c){0<b?(a.removeClass(c),a.find(".crm-count").text(b)):(a.addClass(c),a.find(".crm-count").text(""))};CRMPageMessagesOperations.prototype.showOrHideBar=function(){var a=this;a.$list_header.on("click",".js-operations-show",function(){a.$bar.hasClass("hidden")&&(a.$bar.removeClass("hidden"),
a.$list.addClass("active-operations"))});a.$bar.on("click",".js-operation-hide",function(){a.$bar.addClass("hidden");a.$list.removeClass("active-operations");a.unselectAll()})};CRMPageMessagesOperations.prototype.getSelectedIds=function(){return this.$list.find(".c-checkbox :checkbox:checked").map(function(){return parseInt(d(this).val())}).toArray()};CRMPageMessagesOperations.prototype.getTotalItemsAtPage=function(){return this.$list.find(".c-checkbox :checkbox").length};CRMPageMessagesOperations.prototype.formBar=
function(){var a=this.$bar.find('.crm-operation-li[data-id="detach"] a'),b=this.$bar.find('.crm-operation-li[data-id="read"] a'),c=this.$bar.find('.crm-operation-li[data-id="unread"] a'),e=this.$bar.find('.crm-operation-li[data-id="delete"] a');this.updateBarCount(b,this.unread_counter,"disabled");this.updateBarCount(c,this.read_counter,"disabled");this.updateBarCount(a,this.deal_counter,"disabled");this.updateBarCount(e,this.checked_count,"disabled")};CRMPageMessagesOperations.prototype.initItemCheckbox=
function(){var a=this;a.$list.on("change",".js-checkbox",function(b,c){b=d(this);var e=b.closest(".js-message-wrapper");"undefined"!==typeof c&&b.attr("checked",c);a.markAsReadList(e);a.markAsUnreadList(e);a.detachFromDealsList(e);e.find(".js-checkbox").is(":checked")?a.checked_count+=1:0<a.checked_count&&--a.checked_count;a.$checkbox_all_counter.text(a.checked_count);a.formBar();0<a.checked_count?a.checked_count<a.getTotalItemsAtPage()?a.$checkbox_all.parent().addClass("indeterminate").find("svg").addClass("fa-minus").removeClass("fa-check"):
(a.$checkbox_all.prop("checked",!0),a.$checkbox_all.parent().removeClass("indeterminate").find("svg").removeClass("fa-minus").addClass("fa-check")):(a.$checkbox_all.prop("checked",!1),a.$checkbox_all.parent().removeClass("indeterminate").find("svg").removeClass("fa-minus").addClass("fa-check"))})};CRMPageMessagesOperations.prototype.selectAll=function(){this.$list.find(".c-checkbox :checkbox").prop("checked",!0).trigger("change",[!0]);this.checked_count=this.getSelectedIds().length;this.is_checked_all=
!0};CRMPageMessagesOperations.prototype.unselectAll=function(){this.$list.find(".c-checkbox :checkbox").prop("checked",!1).trigger("change",[!1]);this.$checkbox_all.prop("checked",!1);this.checked_count=0;this.is_checked_all=!1};CRMPageMessagesOperations.prototype.associateWithDeal=function(){var a=this.no_deal_list;1===a.length?this.$list.find('tr[data-id="'+a[0]+'"] .js-associate-deal').trigger("click"):d.get("/webasyst/crm/?module=message&action=conversationAssociateDealDialog&conversation_id="+
a[0],function(b){new CRMDialog({html:b})})};CRMPageMessagesOperations.prototype.associateWithDealList=function(a){var b=this,c=a.data("has-deal");a=a.data("id");c||-1!==b.no_deal_list.indexOf(a)||b.no_deal_list.push(a);b.no_deal_list=b.getSelectedIds().filter(function(e){return-1<b.no_deal_list.indexOf(e)});b.no_deal_counter=b.no_deal_list.length};CRMPageMessagesOperations.prototype.detachFromDeals=function(){var a=this,b=a.view,c=a.deal_list,e={message_ids:c},f="detachDeals";"conversation"===b&&
(e={conversation_ids:c},f="detachDealsFromConversations");var g=d.crm.app_url+"?module=messageOperation&action="+f,k=function(l,h){d.waDialog.confirm({title:`<i class=\"fas fa-exclamation-triangle smaller state-error\"></i> ${l}`,text:d.trim(h),success_button_title:a.locales.detach_button,success_button_class:"danger",cancel_button_title:a.locales.cancel_button,cancel_button_class:"light-gray",onSuccess:function(){d.post(g,e).done(function(m){var n=Object.keys(e)[0];m=m.data[n];m.length&&(m.forEach(function(p){d('.js-message-wrapper[data-id="'+
p+'"]',a.$list).data("has-deal",0).attr("data-has-deal",0);a.no_deal_list.push(p);a.deal_list=a.deal_list.splice(p,1)}),a.no_deal_counter=a.no_deal_list.length,a.deal_counter=a.deal_list.length,a.formBar());m=a.$list.find(".js-message-wrapper.selected").data("id");d.message.content.reload(m)}).fail(function(m){console.error("Detach Deals From Conversations",m)})},onClose:function(m){}})};(function(){if("conversation"===b){var l=d.extend({check:1},e,!0);return d.post(g,l)}return d.Deferred().resolve({})})().done(function(l){k(a.locales.detach_dialog_h2,
"ok"===l.status&&l.data&&l.data.text||"")})};CRMPageMessagesOperations.prototype.detachFromDealsList=function(a){var b=this,c=a.data("has-deal");a=a.data("id");c&&-1===b.deal_list.indexOf(a)&&b.deal_list.push(a);b.deal_list=b.getSelectedIds().filter(function(e){return-1<b.deal_list.indexOf(e)});b.deal_counter=b.deal_list.length};CRMPageMessagesOperations.prototype.markAsRead=function(){var a=this,b=d.crm.app_url+"?module=messageOperation&action=markAsRead",c=a.unread_list,e={message_ids:c};"conversation"===
a.view&&(e={conversation_ids:c});d.post(b,e).done(function(f){var g=Object.keys(e)[0];f=f.data[g];f.length&&(f.map(function(k){a.$list.find('.js-message-wrapper[data-id="'+k+'"]').removeClass("unread").data("read",1).attr("data-read",1);a.read_list.push(k);a.unread_list=a.unread_list.splice(k,1)}),a.read_counter=a.read_list.length,a.unread_counter=a.unread_list.length,a.formBar())}).fail(function(f){console.error("Mark as read",f)})};CRMPageMessagesOperations.prototype.markAsReadList=function(a){var b=
this,c=a.data("id");1===a.data("read")&&-1===b.read_list.indexOf(c)&&b.read_list.push(c);b.read_list=b.getSelectedIds().filter(function(e){return-1<b.read_list.indexOf(e)});b.read_counter=b.read_list.length};CRMPageMessagesOperations.prototype.markAsUnread=function(){var a=this,b=d.crm.app_url+"?module=messageOperation&action=markAsUnread",c=a.read_list,e={message_ids:c};"conversation"===a.view&&(e={conversation_ids:c});d.post(b,e).done(function(f){var g=Object.keys(e)[0];f=f.data[g];f.length&&(f.map(function(k){a.$list.find('.js-message-wrapper[data-id="'+
k+'"]').addClass("unread").data("read",0).attr("data-read",0);a.unread_list.push(k);a.read_list=a.read_list.splice(k,1)}),a.unread_counter=a.unread_list.length,a.read_counter=a.read_list.length,a.formBar())}).fail(function(f){console.error("Mark as unread",f)})};CRMPageMessagesOperations.prototype.markAsUnreadList=function(a){var b=this,c=a.data("id");0===a.data("read")&&-1===b.unread_list.indexOf(c)&&b.unread_list.push(c);b.unread_list=b.getSelectedIds().filter(function(e){return-1<b.unread_list.indexOf(e)});
b.unread_counter=b.unread_list.length};CRMPageMessagesOperations.prototype.deleteConversation=function(){var a=this,b=a.view,c=a.getSelectedIds(),e={message_ids:c},f="delete";"conversation"===b&&(e={conversation_ids:c},f="deleteConversations");var g=d.crm.app_url+"?module=messageOperation&action="+f,k=a.is_admin?`
            <label>
                <span class="wa-checkbox">
                    <input type="checkbox" name="ban_checkbox" id="ban_checkbox">
                    <span>
                        <span class="icon">
                            <i class="fas fa-check"></i>
                        </span>
                    </span>
                </span>
                    ${a.locales.ban_text}
            </label>`:"",l=function(h,m){m=`<div class="flexbox vertical space-16">${k} <span class="text-red">${d.trim(m)}</span></div>`;d.waDialog.confirm({title:`<i class=\"fas fa-exclamation-triangle smaller state-error\"></i> ${h}`,text:m,success_button_title:a.locales.delete_button,success_button_class:"danger",cancel_button_title:a.locales.cancel_button,cancel_button_class:"light-gray",onSuccess:function(n,p){n=n.$content.find("#ban_checkbox").prop("checked");var q=e;n&&(q=d.extend({ban_contacts:1},
e,!0));d.post(g,q).done(function(r){var u=Object.keys(q);r=r.data[u[u.length-1]];r.length&&(r.map(function(v){d('.js-message-wrapper[data-id="'+v+'"]',a.$list).hide()}),a.checked_count-=c.length,a.total_count-=c.length,a.unselectAll(),a.formBar(),1>a.total_count&&(a.$list.hide().before('<div class="no-messages">'+a.locales.no_messages+"</div>"),a.unselectAll(),a.$bar.addClass("hidden"),a.$list.removeClass("active-operations")))}).fail(function(r){console.error("Delete messages",r)})},onClose:function(n){}})};
(function(){if("conversation"===b){var h=d.extend({check:1},e,!0);return d.post(g,h)}return d.Deferred().resolve({})})().done(function(h){l(a.locales.delete_dialog_h2,"ok"===h.status&&h.data&&h.data.text||"")})};return CRMPageMessagesOperations}(jQuery);var CRMSendEmailDialog=function(d){function a(b){(b=b.data("redactor"))&&"core"in b&&b.core.destroy()}CRMSendEmailDialog=function(b){this.$wrapper=b.$wrapper;this.$form=this.$wrapper.find("form");this.$textarea=this.$wrapper.find(".js-wysiwyg");this.$sender_email_select=this.$wrapper.find(".js-sender-email-select");this.$sender_email=this.$wrapper.find(".js-sender-email");this.$to_input=this.$wrapper.find(".js-to-input");this.$to_id=this.$wrapper.find(".js-to-id");this.dialog=this.$wrapper.data("dialog");
this.success_html=b.success_html;this.error_html=b.error_html;this.file_template_html=b.file_template_html;this.max_upload_size=b.max_upload_size;this.locales=b.locales;this.hash=b.hash;this.send_action_url=b.send_action_url;this.body=b.body||"";var c=!1;window&&window.parent&&window.parent.$&&window.parent.$.crm?c=window.parent.$.crm:window.$&&window.$.crm&&(c=window.$.crm);this.crm=c;this.action=b.action;this.deal_id=b.deal_id;this.is_admin=b.is_admin;this.iframe=b.iframe;this.app_url=b.crm_app_url||
this.crm&&this.crm.app_url;if(!this.send_action_url)throw Error("send_action_url option required");this.filesController=this.getFilesController();this.initClass()};CRMSendEmailDialog.prototype.initClass=function(){var b=this;b.initWYSIWYG();b.initSendMessage();b.initPersonalSettingsDialog();b.senderEmailSelect();b.initEmailCopy();"new"==b.action&&(0==b.$to_id.val()&&b.initEmailTo(),b.initSelectDeal(),b.$to_input.focus());"forward"==b.action&&(b.initEmailTo(),b.$to_input.focus(),b.deal_id||b.initSelectDeal());
"reply"!=b.action||b.deal_id||b.initSelectDeal();!b.iframe&&b.dialog.resize();b.iframe&&(760>d(window.parent).width()&&d(".dialog .dialog-content",window.parent.document).css("padding","0 0.75rem"),b.$wrapper.on("click",".js-close-dialog",function(c){c.preventDefault();d(".dialog iframe",window.parent.document)[0].dispatchEvent(new Event("close"));a(b.$textarea)}))};CRMSendEmailDialog.prototype.getFilesController=function(){function b(r){r.length&&d.each(r,function(u,v){u=n;var t=u.push,w=d(h);w.find(".js-name").text(v.name);
l.prepend(w);!e.iframe&&e.dialog.resize();t.call(u,{$file:w,file:v})})}function c(r){var u=[];d.each(n,function(v,t){r[0]!==t.$file[0]?u.push(t):r.remove()});n=u}var e=this,f=e.$wrapper.find(".js-files-wrapper");if(!f.length)return!1;var g=e.$wrapper.find(".js-drop-area"),k=e.$wrapper.find(".js-drop-field"),l=f.find(".c-upload-list"),h=e.file_template_html,m=e.app_url+"?module=file&action=uploadTmp",n=[],p=0,q=0;k.on("change",function(r){r.preventDefault();b(this.files)});g.on("drop",function(r){r.preventDefault();
b(r.originalEvent.dataTransfer.files)});g.on("dragover",function(r){r.preventDefault();g.addClass("is-hover");clearTimeout(q);q=setTimeout(function(){g.removeClass("is-hover")},100)});f.on("click",".js-file-delete",function(r){r.preventDefault();c(d(this).closest(".c-upload-item"))});return{uploadFiles:function(r,u){function v(w){function x(){var E=new FormData,F=document.cookie.match(RegExp("(?:^|; )_csrf=([^;]*)"));(F=F?decodeURIComponent(F[1]):"")&&E.append("_csrf",F);r&&r.length&&d.each(r,function(G,
H){H.name&&H.value&&E.append(H.name,H.value)});E.append("file_size",w.file.size);E.append("files",w.file);E.append("file_end",1);d.ajax({xhr:function(){var G=new window.XMLHttpRequest;G.upload.addEventListener("progress",function(H){H.lengthComputable&&(H=parseInt(H.loaded/H.total*100),z.css("--progress-value",H),100===H&&(z.css("background","transparent"),B.show()))},!1);return G},url:m,data:E,cache:!1,contentType:!1,processData:!1,type:"POST",success:function(G){setTimeout(function(){d.contains(document,
y[0])&&(y.remove(),--p,0>=p&&t())},2E3)}}).always(function(){e.is_locked=!1})}e.is_locked=!0;var y=w.$file,z=y.find(".js-bar"),B=z.find(".js-progress-success-icon"),C=y.find(".js-status");y.addClass("is-upload");if(e.max_upload_size>w.file.size)x();else{C.addClass("errormsg");y.removeClass("is-upload");e.is_locked=!1;C=e.$form.find(".js-submit-button");var A=e.$form.find(".js-drop-field"),D=e.$form.find(".submit-loader");C.attr("disabled",!1);A.attr("disabled",!1);D.remove();e.$form.find("button").prop("disabled",
!1)}}var t=u?u:function(){};n.length?(p=n.length,d.each(n,function(w,x){v(x)})):t()}}};CRMSendEmailDialog.prototype.initWYSIWYG=function(){var b=this,c=b.$textarea,e=0;b.iframe||(b.dialog.onClose=function(){a(c)});b.crm.initWYSIWYG(c,{allowedAttr:[["section","data-role"]],callbacks:{change:function(){var f=b.iframe?0:b.dialog.$block.height();e&&e===f||(e=f,!b.iframe&&b.dialog.resize())}}});b.body&&c.redactor("code.set",b.body)};CRMSendEmailDialog.prototype.initSendMessage=function(){var b=this,c=
b.$wrapper.find(".js-to-email"),e=b.$to_id,f=b.$wrapper.find(".js-to-new-name");b.is_locked=!1;b.$form.on("submit",function(k){k.preventDefault();if(!(0!=e.val()||d.trim(f.val())&&d.trim(c.val())||"new"!=b.action&&"forward"!=b.action))return d(".js-to-input, .js-to-add-name, .js-to-add-email").addClass("shake animated").focus(),setTimeout(function(){d(".js-to-input, .js-to-add-name, .js-to-add-email").removeClass("shake animated").focus()},500),!1;if(!d.trim(c.val()))return b.$to_input.addClass("shake animated").focus(),
setTimeout(function(){b.$to_input.removeClass("shake animated").focus()},500),!1;if(!b.is_locked){b.is_locked=!0;k=b.$form.find(".js-submit-button");var l=b.$form.find(".js-drop-field"),h=d('<span class="icon size-16 submit-loader"><i class="fas fa-spinner wa-animation-spin custom-mr-4"></i></span>');k.attr("disabled",!0);h.insertAfter(k);l.attr("disabled",!0);b.$form.find("button").prop("disabled",!0);b.filesController.uploadFiles([{name:"hash",value:b.hash}],g)}});var g=function(){var k=b.send_action_url,
l=b.$form.serializeArray(),h=function(m,n){if(!d.isEmptyObject(m)){m=d.extend(!0,{},m);var p=b.locales.send_error_title||"Send error",q=b.locales.send_error_text||"Can't send email message";q=d(b.error_html).find(".js-error-text").text(q).end();var r=m.common;b.is_admin&&(r?(q.find(".js-technical-info-block.js-known-error").show(),q.find(".js-technical-info-text").text(r)):q.find(".js-technical-info-block.js-unknown-error").show());d.crm.alert.show({title:p,text:q.get(0).outerHTML,button:b.locales.close||
"close",button_class:"red",onOpen:function(u){u.find(".js-technical-info-link").one("click",function(){d(this).remove();u.find(".js-technical-info-text").show()})}});delete m.common;d.isEmptyObject(m)||console.log.error(m)}n&&console.log.error(n)};d.post(k,l,"json").done(function(m){if("ok"===m.status){a(b.$textarea);b.$wrapper.find(".dialog-body").html(b.success_html);!b.iframe&&b.dialog.resize();var n=null;b.iframe||(b.dialog.onClose=function(){n&&clearTimeout(n);n=null;d.crm?d.crm.content.reload():
b.crm.content.reload()});n=setTimeout(function(){b.iframe?d(".dialog iframe",window.parent.document)[0].dispatchEvent(new Event("close")):b.dialog.close()},2500)}else!b.iframe&&b.dialog.close(),d.isEmptyObject(m.errors)?h({common:"Send error"},m):h(m.errors)}).always(function(){b.is_locked=!1}).fail(function(m){h({},m);!b.iframe&&b.dialog.close()})}};CRMSendEmailDialog.prototype.initPersonalSettingsDialog=function(){function b(){c.is_locked||(c.is_locked=!0,d.post(c.crm.app_url+"?module=email&action=personalSettingsDialog",
{},function(e){d.waDialog({html:e,options:{onSave:function(f){c.$textarea.redactor("core.editor").find('[data-role="c-email-signature"]').html(f.email_signature||"");c.$wrapper.find(".js-sender-name").text(f.sender_name||"")}}})}).always(function(){c.is_locked=!1}))}var c=this;c.$wrapper.on("click",".js-show-personal-settings-dialog",function(e){e.preventDefault();b()})};CRMSendEmailDialog.prototype.senderEmailSelect=function(){var b=this;b.$wrapper.on("change",b.$sender_email_select,function(c){c.preventDefault();
b.$sender_email.val(b.$sender_email_select.val())})};CRMSendEmailDialog.prototype.initEmailTo=function(){function b(){var t=d.trim(k.val()).split(/\s+/),w=!1;d.each(t,function(x,y){d.crm.check.email(y)&&!w&&(g=y.replace(/<|>/g,""),w=x)});!1!==w&&t.splice(w,1);f=t.join(" ");g&&f&&(t='<span class="js-edit-recipient" title="'+e.locales.edit_recipient+'"><b>'+d.crm.escape(f)+'</b> <span style="color: #999;">&lt;'+d.crm.escape(g)+"&gt;</span></span>",c(0,g,t),h.val(d.crm.escape(f)));if(f&&!g)return t=
'<span class="js-edit-recipient" title="'+e.locales.edit_recipient+'"><b>'+d.crm.escape(f)+'</b></span> <input class="c-to-input js-to-add-email" type="text" autocomplete="off" placeholder="'+e.locales.type_email+'" style="margin-left: 8px; width: 150px;" />',c(0,null,t),h.val(d.crm.escape(f)),d(".js-to-add-email").focus(),!1;if(g&&!f)return t='<input class="c-to-input js-to-add-name" type="text" autocomplete="off" placeholder="'+e.locales.type_name+'" style="margin-right: 8px; width: 150px;" > <span class="js-edit-recipient" title="'+
e.locales.edit_recipient+'" style="color: #999;">&lt;'+d.crm.escape(g)+"&gt;</span>",c(0,g,t),d(".js-to-add-name").focus(),!1}function c(t,w,x){n.prepend('<div class="c-email-to-user js-email-to-user">'+x+' <a title="'+e.locales.change_recipient+'" class="c-remove-to-email js-remove-to-email text-gray"><i class="icon fas fa-times-circle delete"></i></a></div>');p.removeClass("hidden");k.addClass("hidden").val("");l.val(w);m.val(t).trigger("change")}var e=this,f=null,g=null,k=e.$to_input,l=e.$wrapper.find(".js-to-email"),
h=e.$wrapper.find(".js-to-new-name"),m=e.$to_id,n=e.$wrapper.find(".js-to-name"),p=e.$wrapper.find(".js-deal-field"),q=e.$wrapper.find(".js-select-funnel"),r=e.$wrapper.find(".js-select-deal .js-visible-link .js-text"),u=e.$wrapper.find(".js-deals-list"),v=e.$wrapper.find(".js-create-new-deal");k.autocomplete({source:d.crm.app_url+"?module=autocomplete&emailcomplete=true",appendTo:e.$wrapper,minLength:0,focus:function(){return!1},select:function(t,w){t=w.item;w=(t.criteria||{}).email||t.email;c(t.id,
w,'<i class="icon userpic" style="background-image: url('+t.photo_url+');"></i>'+t.name+' <span style="color: #999;">&lt;'+w+"&gt;</span>");return!1}}).data("ui-autocomplete")._renderItem=function(t,w){return d('<li class="ui-menu-item-html"><div>'+w.value+"</div></li>").appendTo(t)};k.on("focus",function(){k.data("uiAutocomplete").search(k.val())});k.on("keydown",function(t){if(13==t.keyCode)return t.preventDefault(),k.blur(),!1});k.on("focusout",function(t){t.preventDefault();b();return!1});n.on("click",
".js-remove-to-email",function(){d(this).parent(".js-email-to-user").remove();k.removeClass("hidden").focus();p.addClass("hidden");q.addClass("hidden");u.html(v);r.html(""+e.locales.deal_select);l.val("");h.val("");m.val("").trigger("change");g=f=null});e.$wrapper.on("click",".js-edit-recipient",function(){var t=[f,g].join(" ");k.val(d.trim(t)).removeClass("hidden").focus();d(".js-email-to-user").remove();g=f=null;l.val("");h.val("")});e.$wrapper.on("keydown",".js-to-add-email",function(t){13==t.keyCode&&
(t.preventDefault(),d(this).blur())});e.$wrapper.on("focusout",".js-to-add-email",function(){var t=d(".js-to-add-email"),w=d.trim(t.val());w.length&&!0===d.crm.check.email(w)&&(g=w,l.val(d.crm.escape(w)),t.before(d('<span class="js-edit-recipient" title="'+e.locales.edit_recipient+'" style="color: #999;"></span>').text("<"+w+">")).remove())});e.$wrapper.on("keydown",".js-to-add-name",function(t){13==t.keyCode&&(t.preventDefault(),d(this).blur())});e.$wrapper.on("focusout",".js-to-add-name",function(){var t=
d.trim(d(".js-to-add-name").val());t.length&&(f=t,h.val(d.crm.escape(t)),d(".js-to-add-name:first-child").before(d('<span class="js-edit-recipient" title="'+e.locales.edit_recipient+'"><b></b></span>').text(t)).remove())})};CRMSendEmailDialog.prototype.initEmailCopy=function(){function b(){var p=d.trim(h.val()).split(/[,:;]/);if(p[0].length)return d.each(p,function(q,r){q=d.trim(r).split(/\s+/);var u=!1,v=r=null;d.each(q,function(t,w){d.crm.check.email(w)&&!u&&(r=w.replace(/<|>/g,""),u=t)});!1!==
u&&q.splice(u,1);v=q.join(" ");r&&v&&e(0,r,v);r&&!v&&c(0,r,r);v&&!r&&(h.addClass("shake animated"),setTimeout(function(){h.removeClass("shake animated")},500));u=!1;v=r=null}),!1}function c(p,q,r){l.children('[data-email="'+q+'"]').length&&"0"!==p||!q.length||(d(".email-copy-input-div").before('<div class="email-copy-user" title="'+d.crm.escape(q)+'" data-contact-id="'+d.crm.escape(p)+'" data-email="'+d.crm.escape(q)+'">'+r+' <a title="'+f.locales.remove_form_cc+'" class="remove-cc js-remove-cc">x</a> <input name="cc['+
d.crm.escape(q)+'][email]" type="hidden" value="'+d.crm.escape(q)+'" /><input name="cc['+d.crm.escape(q)+'][id]" type="hidden" value="'+d.crm.escape(p)+'" /></div>'),d(".email-copy-text-collapsed").append('<div class="email-copy-user" title="'+d.crm.escape(q)+'" data-email="'+d.crm.escape(q)+'">'+r+"</div>"));h.val("").focus()}function e(p,q,r){l.children('[data-email="'+q+'"]').length&&"0"!==p||!q.length||(d(".email-copy-input-div").before('<div class="email-copy-user" title="'+d.crm.escape(q)+'" data-contact-id="'+
p+'" data-email="'+d.crm.escape(q)+'">'+d.crm.escape(r)+' <a title="'+f.locales.remove_form_cc+'" class="remove-cc js-remove-cc">x</a> <input name="cc['+d.crm.escape(q)+'][email]" type="hidden" value="'+d.crm.escape(q)+'" /><input name="cc['+d.crm.escape(q)+'][id]" type="hidden" value="'+d.crm.escape(p)+'" /><input name="cc['+d.crm.escape(q)+'][name]" type="hidden" value="'+d.crm.escape(r)+'" /></div>'),d(".email-copy-text-collapsed").append('<div class="email-copy-user" title="'+d.crm.escape(q)+
'" data-email="'+d.crm.escape(q)+'">'+d.crm.escape(r)+"</div>"));h.val("").focus()}var f=this,g=f.$wrapper.find(".email-copy-wrapper"),k=g.find(".email-copy-area"),l=k.find(".email-copy-text"),h=k.find(".email-copy-input"),m=g.find(".deal-participants-area"),n=f.$wrapper.find(".email-copy-wrapper-collapsed");h.autocomplete({source:d.crm.app_url+"?module=autocomplete&emailcomplete=true",appendTo:f.$wrapper,minLength:0,focus:function(){return!1},select:function(p,q){p=q.item;c(p.id,(p.criteria||{}).email||
p.email,'<i class="icon userpic" style="background-image: url('+p.photo_url+');"></i>'+p.name);h.val("");return!1}}).data("ui-autocomplete")._renderItem=function(p,q){return d('<li class="ui-menu-item-html"><div>'+q.value+"</div></li>").appendTo(p)};h.on("focus",function(){h.data("uiAutocomplete").search(h.val())});f.$wrapper.on("click",".js-email-copy-link, .email-copy-text-collapsed",function(p){p.preventDefault();p=f.$wrapper.find(".js-email-copy-link-icon");g.toggleClass("email-copy-wrapper-block");
g.is(":visible")?(p.removeClass("fa-caret-right").addClass("fa-caret-down"),h.focus(),n.removeClass("email-copy-wrapper-collapsed-block")):(p.removeClass("fa-caret-down").addClass("fa-caret-right"),d(".email-copy-text-collapsed").children().length&&n.addClass("email-copy-wrapper-collapsed-block"))});k.on("click",function(){h.focus()});m.on("click",".email-copy-user",function(){var p=d(this).data("cc-contact-id"),q=d(this).data("cc-email"),r=d(this).html();c(p,q,r)});h.on("focusout",function(p){b()});
h.on("keydown",function(p){13==p.keyCode&&(p.preventDefault(),b())});l.on("click",".js-remove-cc",function(p){p.preventDefault();p=d(this).parent(".email-copy-user");var q=p.data("email");p.remove();d(".email-copy-text-collapsed").children('[data-email="'+q+'"]').remove()});h.on("keydown",function(p){if(8==p.keyCode&&0==h.val().length){p=d(".email-copy-text .email-copy-user:last");var q=p.data("email");p.remove();d(".email-copy-text-collapsed").children('[data-email="'+q+'"]').remove();h.focus()}})};
CRMSendEmailDialog.prototype.initSelectDeal=function(){function b(){var n=h.val();l.val("none");n&&d.get("?module=deal&action=byContact&id="+n,function(p){"ok"===p.status&&d.each(p.data.deals,function(q,r){k.prepend('<li><a href="javascript:void(0);" class="js-deal-item" data-deal-id="'+r.id+'"><span class="js-text flexbox"><i class="fas fa-circle funnel-state" style="color: '+p.data.funnels[r.funnel_id].stages[r.stage_id].color+'"></i><span class="flexbox">'+r.name+"</span></span></a></li>")})},
"json")}var c=this,e=c.$form.find(".js-select-deal .js-visible-link .js-text"),f=c.$form.find(".js-select-funnel"),g=c.$wrapper.find(".js-deal-field"),k=c.$form.find(".js-deals-list"),l=c.$form.find(".js-deal-id"),h=c.$to_id,m=c.$form.find(".js-empty-deal");c.$form.on("click",".js-create-new-deal",function(){var n=d(this).find(".js-text").html();f.removeClass("hidden");m.removeClass("c-empty-deal-hidden");e.html(n);l.val("0")});m.on("click",function(){d(this).addClass("c-empty-deal-hidden");f.addClass("hidden");
k.find("li").removeClass("selected");e.html(c.locales.deal_empty);l.val("none")});c.$form.on("click",".js-deal-item",function(){var n=d(this).find(".js-text").html();k.find("li").removeClass("selected");d(this).parent().addClass("selected");e.html(n);m.removeClass("c-empty-deal-hidden");f.addClass("hidden");l.val(d(this).data("deal-id"))});"reply"==c.action&&b();"new"==c.action&&0<h.val()&&(b(),g.removeClass("hidden"));h.on("change",b);k.on("click",function(){k.hide();setTimeout(function(){k.removeAttr("style")},
200)});c.$form.on("change",".js-select-deal-funnel",function(){c.$form.find(".js-select-stage-wrapper").load("?module=deal&action=stagesByFunnel&id="+d(this).val())})};return CRMSendEmailDialog}(jQuery);var CRMSendSmsDialog=function(d){CRMSendSmsDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$textarea=this.$wrapper.find(".js-send-sms-textarea");this.dialog=this.$wrapper.data("dialog");this.success_html=a.success_html;this.error_html=a.error_html;this.hash=a.hash;this.send_action_url=a.send_action_url;var b=!1;window&&window.parent&&window.parent.$&&window.parent.$.crm?b=window.parent.$.crm:window.$&&window.$.crm&&(b=window.$.crm);this.crm=b;this.action=a.action;
this.locales=a.locales||{};this.iframe=a.iframe;this.app_url=a.crm_app_url||this.crm&&this.crm.app_url;if(!this.send_action_url)throw Error("send_action_url option required");this.initClass()};CRMSendSmsDialog.prototype.initClass=function(){this.initSenderSelector();this.initSendMessage();!this.iframe&&this.dialog.resize();if(this.iframe)this.$wrapper.on("click",".js-close-dialog",function(a){a.preventDefault();d(".dialog iframe",window.parent.document)[0].dispatchEvent(new Event("close"))})};CRMSendSmsDialog.prototype.initSenderSelector=
function(){var a=this.$wrapper,b=a.find(".js-specified-sms-sender");a.find(".js-sms-sender-list").change(function(){"specified"===d(this).val()?b.attr("disabled",!1).show():b.attr("disabled",!0).hide()})};CRMSendSmsDialog.prototype.initSendMessage=function(){var a=this,b=!1;a.$form.on("submit",function(c){c.preventDefault();if(!b){b=!0;c=a.$form.find(".js-submit-button");var e=d('<span class="icon loading"><i class="fas fa-spinner wa-animation-spin"></i></span>');c.attr("disabled",!0);e.insertAfter(c);
c=a.send_action_url;e=a.$form.serializeArray();var f=function(g){var k=a.locales.send_error_title||"Send error",l=a.locales.send_error_text||"Can't send sms message",h=d(a.error_html).find(".js-error-text").text(l);a.iframe&&a.$wrapper.find(".dialog-body").html(a.error_html).find(".js-error-text").text(l);a.iframe||d.crm.alert.show({title:k,text:h.get(0).outerHTML,button_class:"red"});g&&console.error(g)};d.post(c,e,function(g){if("ok"===g.status){a.$wrapper.find(".dialog-body").html(a.success_html);
!a.iframe&&a.dialog.resize();var k=null,l=a.dialog.onClose;a.dialog.onClose=function(){l();k&&clearTimeout(k);k=null;a.crm.content.reload()};k=setTimeout(function(){a.iframe?d(".dialog iframe",window.parent.document)[0].dispatchEvent(new Event("close")):a.dialog.close()},2500)}else!a.iframe&&a.dialog.close(),f(g.errors||{})},"json").always(function(){b=!1}).fail(function(g){!a.iframe&&a.dialog.close();f(g)})}})};return CRMSendSmsDialog}(jQuery);var CRMImSourceMessageDialog=function(d){CRMImSourceMessageDialog=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".js-reply-button");this.dialog=this.$wrapper.data("dialog");this.send_dialog=null;this.message=a.message||{};this.locales=a.locales||{};var b=!1;window&&window.parent&&window.parent.$&&window.parent.$.crm?b=window.parent.$.crm:window.$&&window.$.crm&&(b=window.$.crm);this.crm=b;this.app_url=a.crm_app_url||this.crm&&this.crm.app_url;this.initClass()};CRMImSourceMessageDialog.prototype.initClass=
function(){this.initMessageDeleteLink();this.initMessageReplyBtn()};CRMImSourceMessageDialog.prototype.initMessageReplyBtn=function(){function a(l){f.append(g);d.post(b.app_url+"?module=message&action=writeReplyDialog",{id:b.message.id},function(h){d.waDialog({html:h,onOpen:function(m,n){b.send_dialog=n;m.find(".js-cancel-dialog").click(function(){b.send_dialog.hide();e.show()});l&&l()},onClose:function(){b.send_dialog=null;b.dialog&&b.dialog.close();b.dialog=null}})})}var b=this,c=b.$wrapper,e=b.dialog,
f=c.find(".js-dialog-footer"),g=d('<span class="icon size-16"><i class="fas fa-spinner wa-animation-spin custom-mr-4"></i></span>'),k=c.find(".js-reply-button");k.click(function(){k.attr("disabled",!0);var l=function(){g.remove();k.attr("disabled",!1);e.hide()};b.send_dialog?(b.send_dialog.show(),l()):a(function(){l();var h=b.dialog.onClose;b.dialog.onClose=function(){h.apply(this,arguments);b.dialog=null;b.send_dialog&&b.send_dialog.close();b.send_dialog=null}})})};CRMMessageDeleteLinkMixin.mixInFor(CRMImSourceMessageDialog);
return CRMImSourceMessageDialog}(jQuery);var CRMImSourceSendMessageDialog=function(d){CRMImSourceSendMessageDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$button=this.$form.find(":submit");this.dialog=this.$wrapper.data("dialog");this.message=a.message||{};this.locales=a.locales||{};this.success_html=a.success_html||"";var b=!1;window&&window.parent&&window.parent.$&&window.parent.$.crm?b=window.parent.$.crm:window.$&&window.$.crm&&(b=window.$.crm);this.crm=b;this.app_url=a.crm_app_url||this.crm&&
this.crm.app_url;this.send_action_url=a.send_action_url;if(!this.send_action_url)throw Error("send_action_url option required");this.initClass()};CRMImSourceSendMessageDialog.prototype.initClass=function(){this.initSendMessage();this.initErrorCleaner()};CRMImSourceSendMessageDialog.prototype.initErrorCleaner=function(){function a(){b.clearErrors()}var b=this,c=b.$wrapper,e=null;c.on("keydown",":input",function(){e&&clearTimeout(e);e=setTimeout(function(){a()},250)});c.on("change",":input",a)};CRMImSourceSendMessageDialog.prototype.initSendMessage=
function(){var a=this,b=a.$form,c=a.$button;b.on("submit",function(e){function f(l){l&&!d.isEmptyObject(l.errors)?a.showErrors(l.errors):console.error(l?["Server error",l]:"Server error")}e.preventDefault();var g=null,k=d('<span class="icon size-16"><i class="fas fa-spinner wa-animation-spin custom-mr-4"></i></span>');c.attr("disabled",!0).after(k);g&&g.abort();g=d.post(a.send_action_url,a.$form.serializeArray()).done(function(l){if("ok"!==l.status)f(l);else{a.$wrapper.find(".dialog-body").html(a.success_html);
a.dialog.resize();var h=null;a.dialog.onClose=function(){h&&clearTimeout(h);h=null;a.crm.content.reload()};h=setTimeout(function(){a.dialog.close()},2500)}}).fail(f).always(function(){c.attr("disabled",!1);k.remove();g=null})});b.on("click",".js-cancel-dialog",function(){a.$wrapper.css({display:"none"})})};CRMImSourceSendMessageDialog.prototype.showErrors=function(a){var b=this.$wrapper;d.each(a,function(c,e){c=b.find('[name="'+c+'"]');e='<span class="errormsg">'+e+"</span>";c.length?(c.addClass("state-error"),
c.after(e)):b.find(".js-errors-place").append(e)})};CRMImSourceSendMessageDialog.prototype.clearErrors=function(){var a=this.$wrapper;a.find(".state-error").removeClass("state-error");a.find(".errormsg").remove();a.find(".js-errors-place").empty()};return CRMImSourceSendMessageDialog}(jQuery);var CRMContactPage=function(d){CRMContactPage=function(a){this.$wrapper=a.$wrapper;this.$tabsW=this.$wrapper.find(".t-profile-tabs");this.photo_dialog_url=a.photo_dialog_url;this.locales=a.locales;this.contact_id=a.contact_id||!1;this.editable=a.editable||!1;this.initClass()};CRMContactPage.prototype.initClass=function(){this.initTabChange();this.initAddCompanyContactLink();this.initResponsibleLink();this.initClassifyAccessLink();this.initChangePhotoLink();this.initTopInfoFields();this.initEmployee();
this.initAssignTags();this.initSegments();this.initInfoTab();this.editable&&(this.initEditLink(),this.initDeleteLink(),this.initEditableName());this.initRemoveFiles();this.initFixedHeader();this.editInterception();this.deleteInterception();this.initMessage();this.initCall()};CRMContactPage.prototype.editInterception=function(){var a=this,b=location.pathname.replace(d.crm.app_url,"").split("/");d(window).load(function(){0<=b.indexOf("edit")&&a.$wrapper.find(".profile-header-links .js-edit-link").trigger("click")})};
CRMContactPage.prototype.deleteInterception=function(){var a=this,b=location.pathname.replace(d.crm.app_url,"").split("/");d(window).load(function(){0<=b.indexOf("delete")&&a.$wrapper.find(".profile-header-links .js-delete-link").trigger("click")})};CRMContactPage.prototype.initTopInfoFields=function(){var a=this.$wrapper.find(".js-info-list");this.$wrapper.on("click",".js-info-toggle",function(b){b.preventDefault();d(this).toggleClass("is-active");a.slideToggle()})};CRMContactPage.prototype.initChangePhotoLink=
function(){var a=this;a.$wrapper.find(".photo-change-link a").click(function(){d.get(a.photo_dialog_url,function(b){(new CRMDialog({html:b})).$wrapper.on("photo_updated photo_deleted",function(c,e){a.$wrapper.find(".c-userpic").attr("src",e.url)})},"html")})};CRMContactPage.prototype.initTabChange=function(){var a=window.history&&window.history.pushState;this.$wrapper.find(".t-profile-tabs").on("click",".t-tab a",function(b){b.preventDefault();if(a){b=d(this).data("tab-id");var c=window.location.href.match(/^.*\/(id|contact)\/[^\/]+/);
c&&b&&(b=c[0]+"/"+b+"/",history.replaceState({reload:!0,content_uri:b},"",b))}})};CRMContactPage.prototype.initEditLink=function(){var a=this;a.$wrapper.find(".profile-header-links .edit-link").on("click",function(){var c=a.$wrapper.find('.t-tab a[data-tab-id="info"]').closest(".t-tab");d("html, body").animate({scrollTop:c.offset().top},500);a.$wrapper.find(".t-profile-tabs").data("tabs_controller").switchToTab("info",function(e){return"function"===typeof e[0].contentWindow.$.wa.contactEditor.switchMode}).then(function(e){e[0].contentWindow.$.wa.contactEditor.switchMode("edit")})});
var b=a.$wrapper.find(".t-profile-tabs-iframes");b.on("contact_saved",function(c,e){d.crm.content.reload();b.children().hide();a.$wrapper.find(".t-profile-tabs").data("tabs_controller").showTabHtml("__internal",'<div class="block double-padded"><i class="icon16 loading"></i></div>')})};CRMContactPage.prototype.initInfoTab=function(){var a=null;this.$wrapper.find('.t-profile-tabs .t-tab[data-tab-id="info"] a').on("tab_content_updated",function(){a&&clearInterval(a);a=setInterval(function(){var b=d("#c-profile-page .t-profile-tabs-iframes iframe").filter(function(){return"info"==
d(this).data("tab-id")});try{if(!b[0].contentWindow.$.wa.contactEditor)return}catch(g){return}a&&clearInterval(a);a=null;var c=d('script[src*="wa-apps/crm"]:first').attr("src").match(/^(.*\/wa-apps\/crm\/)[^\?]*(\?.*)/),e=c[1],f=c[2];b[0].contentWindow.$("head").append('<link href="'+e+"js/jquery/jquery-ui.css"+f+'" rel="stylesheet" type="text/css">');["js/jquery/jquery-ui.min.js","js/crm.autocomplete.js","js/contact.info.js"].forEach(function(g){b[0].contentWindow.$("head").append('<script src="'+
e+g+f+'">\x3c/script>')})},100)})};CRMContactPage.prototype.initAddCompanyContactLink=function(){this.$wrapper.find(".js-add-company-contact").on("click",function(){d.get(d(this).data("dialog-url"),function(a){new CRMDialog({html:a})})})};CRMContactPage.prototype.initResponsibleLink=function(){this.$wrapper.find(".profile-header-links .responsible-link").on("click",function(){d.get(d(this).data("dialog-url"),function(a){new CRMDialog({remain_after_load:!0,html:a})})})};CRMContactPage.prototype.initDeleteLink=
function(){var a=this.$wrapper,b=a.find(".crm-delete-link"),c=this.contact_id,e=d.crm.app_url+"?module=contactOperation&action=delete",f=a.find(".crm-contact-operation-delete-checking").clone();b.click(function(g){g.preventDefault();new CRMDialog({html:f.show(),onOpen:function(k){var l=this;k.find(".crm-cancel").click(function(){l.close()});d.get(e,{contact_ids:[c],is_contact_page:1},function(h){new CRMDialog({html:h,onOpen:function(){l.close()}})})}})})};CRMContactPage.prototype.initClassifyAccessLink=
function(){this.$wrapper.find(".profile-header-links .classify-access-link").on("click",function(){d.get(d(this).data("dialog-url"),function(a){new CRMDialog({remain_after_load:!0,html:a})})})};CRMContactPage.prototype.initEmployee=function(){var a=this,b=!1;a.$wrapper.on("click",".js-view-employees",function(c){c.preventDefault();a.$tabsW.length&&d("html, body").scrollTop(a.$tabsW.offset().top)});a.$wrapper.on("click",".js-add-employee",function(c){c.preventDefault();c=d.crm.app_url+"?module=contact&action=addEmployee";
var e={company_contact_id:a.contact_id};b&&b.abort();b=d.post(c,e,function(f){new CRMDialog({html:f})})})};CRMContactPage.prototype.initAssignTags=function(){var a=this.$wrapper.find(".crm-contact-assign-tags"),b=d.crm.app_url+"?module=contactOperation&action=assignTags&is_assign=1",c=parseInt(this.contact_id)||0;a.click(function(e){e.preventDefault();d.get(b,{contact_ids:[c]},function(f){new CRMDialog({html:f})})})};CRMContactPage.prototype.initSegments=function(){function a(k){var l=b.$wrapper.find(".js-segment-list"),
h=l.find("a").length;k.length||k.push({id:!1,name:b.locales.no_segments});d.each(k,function(m,n){m="javascript:void(0);";var p="",q='<span class="hint">'+n.name+"</span>";n.id&&(m=d.crm.app_url+"contact/segment/"+n.id+"/",p='<i class="icon16 '+(n.icon?n.icon:"folder-dynamic")+'"></i>',q="<span>"+n.name+"</span>");n='<a href="'+m+'">'+p+q+"</a>";h&&(n=","+n);l.append(n);h=!0})}var b=this,c=b.$wrapper.find(".crm-contact-assign-segments"),e=d.crm.app_url+"?module=contactOperation&action=addToSegments&is_assign=1",
f=parseInt(b.contact_id)||0;c.click(function(k){k.preventDefault();d.get(e,{contact_ids:[f]},function(l){new CRMDialog({html:l,onOpen:function(h){new CRMContactsOperationAddToSegments({$wrapper:h,context:{contact_ids:[f]},is_assign:1})}})})});var g=!1;b.$wrapper.on("click",".js-show-dynamic-segments",function(k){k.preventDefault();var l=d(this);l.find(".icon16").removeClass("folder-dynamic").addClass("loading");g&&g.abort();g=d.post("?module=contact&action=segmentSearch",{id:b.contact_id},function(h){"ok"==
h.status&&(a(h.data.segments),l.remove())}).always(function(){g=!1})})};CRMContactPage.prototype.initEditableName=function(){var a=this.$wrapper.find(".js-name-editable").first();if(!(0>=a.length)){var b=this.contact_id;new CrmEditable({$wrapper:a,saveChanged:!0,saveNonempty:!0,placeholder:a.data("editable-placeholder"),onSave:function(c){if(!c.isLoading())if(c.isChanged()&&d.trim(c.getText())){c.loading();var e=c.getText();d.post(d.crm.app_url+"?module=contact&action=profileSave",{data:JSON.stringify({name:e}),
id:b}).always(function(){c.setText(e);c.loading(!1).hide();d.crm.content.reload()})}else c.hide()}})}};CRMContactPage.prototype.initRemoveFiles=function(){function a(c,e){d.post("?module=file&action=delete",{id:c},function(f){"ok"==f.status?e.remove():console&&console.log&&console.log("File Remove Error")})}var b=this;b.$wrapper.find(".js-files-list").on("click",".js-remove-file",function(c){c.preventDefault();var e=d(this).closest(".c-file");c=e.find(".c-name").text();var f=parseInt(e.data("id"));
0<f?d.crm.confirm.show({title:b.locales.remove_file_title,text:b.locales.remove_file_text.replace(/%s/,c),button:b.locales.remove_file_button,onConfirm:function(){a(f,e)}}):console&&console.log&&console.log("File ID is empty")})};CRMContactPage.prototype.initFixedHeader=function(){function a(){if(d.contains(document,e[0])){var l=b.scrollTop();l>f.top+70?(e.css({left:f.left,width:c.outerWidth()+"px"}).addClass("is-fixed"),l>f.top+c.outerHeight()-e.outerHeight()?e.removeClass("is-hover").css("background",
g):(l="linear-gradient(to bottom, "+g+" 0%, "+g+" 70%, rgba("+k.join(",")+") 100%)",e.addClass("is-hover").css("background",l)),c.addClass("is-over")):(e.removeAttr("style").removeClass("is-fixed"),c.removeClass("is-over"))}else b.off("scroll",a)}var b=d(window),c=this.$wrapper.find(".js-profile"),e=this.$wrapper.find(".js-short-profile"),f=c.offset(),g=c.css("background-color"),k=g.replace("rgba(","").replace("rgb(","").replace(")","").split(",");k=d.map(k,function(l){return parseInt(l)});3>=k.length?
k.push(0):k[3]=0;e.on("click",".js-short-responsible-link",function(){c.find(".profile-header-links .js-responsible-link").trigger("click")});e.on("click",".js-short-access-link",function(){c.find(".profile-header-links .js-access-link").trigger("click")});e.on("click",".js-short-edit-link",function(){c.find(".profile-header-links .js-edit-link").trigger("click")});e.on("click",".js-short-delete-link",function(){c.find(".profile-header-links .js-delete-link").trigger("click")});b.on("scroll",a)};
CRMContactPage.prototype.initMessage=function(){this.initSendEmail();this.initSendSMS()};CRMContactPage.prototype.initSendEmail=function(){var a=!1;this.$wrapper.on("click",".js-show-message-dialog",function(b){b.preventDefault();var c=d(this);b=c.data("id");c=c.data("email");!a&&b&&(a=!0,d.post("?module=message&action=writeNewDialog",{contact_id:b,email:c},function(e){new CRMDialog({html:e})}).always(function(){a=!1}))})};CRMContactPage.prototype.initSendSMS=function(){var a=!1;this.$wrapper.on("click",
".js-show-send-sms-dialog",function(b){b.preventDefault();var c=d(this);b=c.data("id");c=c.data("phone");!a&&b&&(a=!0,d.get("?module=message&action=writeSMSNewDialog",{contact_id:b,phone:c},function(e){new CRMDialog({html:e})}).always(function(){a=!1}))})};CRMContactPage.prototype.initCall=function(){var a=!1;this.$wrapper.on("click",".js-show-call-dialog",function(b){b.preventDefault();var c=d(this);b=c.data("id");c=c.data("phone");!a&&b&&c&&(a=!0,d.post("?module=call&action=initContactDialog",{contact_id:b,
phone:c},function(e){new CRMDialog({remain_after_load:!0,html:e})}).always(function(){a=!1}))})};return CRMContactPage}(jQuery),CRMNewContactPage=function(d){CRMNewContactPage=function(a){this.$wrapper=a.$wrapper;this.$contactSection=this.$wrapper.find(".js-contact-section");this.$accessSection=this.$wrapper.find(".js-access-section");this.$segmentsSection=this.$wrapper.find(".js-segments-section");this.$dealSection=this.$wrapper.find(".js-deal-section");this.$errorsSection=this.$wrapper.find(".js-errors-section");
this.$extendedFieldsW=this.$wrapper.find(".js-contact-extended-fields");this.call_id=a.call_id;this.funnels=a.funnels;this.locales=a.locales;this.contact_data=a.contact_data;this.stage_template_html=a.stage_template_html;this.extended_fields=a.extended_fields||{};this.is_extended=a.is_extended||!1;this.create_deal=this.selected_segments=!1;this.initClass()};CRMNewContactPage.prototype.initClass=function(){d.crm.renderSVG(this.$wrapper);this.contact_data&&this.setContactData(this.contact_data);this.initContactToggle();
this.initAccessToggle();this.initSegmentsToggle();this.initDealToggle();this.initDealSection();this.$extendedFieldsW.length&&this.initExtendedFields();this.initCreate();this.initHeaderActions();this.initWYSIWYG();this.initContactUpdateDialog()};CRMNewContactPage.prototype.initContactToggle=function(){var a=this;a.$contactSection.on("click",".js-extended-toggle",function(b){b.preventDefault();a.$contactSection.hasClass("is-extended")?(a.$contactSection.removeClass("is-extended"),a.is_extended=!1):
(a.$contactSection.addClass("is-extended"),a.is_extended=!0)})};CRMNewContactPage.prototype.initAccessToggle=function(){var a=this,b=a.$accessSection.find(".js-ibutton");b.iButton({labelOn:"",labelOff:"",classContainer:"c-ibutton ibutton-container mini"});b.on("change",function(){"checked"===b.attr("checked")?(a.$accessSection.addClass("is-extended"),a.selected_access=!0):(a.$accessSection.removeClass("is-extended"),a.selected_access=!1)})};CRMNewContactPage.prototype.initSegmentsToggle=function(){var a=
this,b=a.$segmentsSection.find(".js-ibutton");b.iButton({labelOn:"",labelOff:"",classContainer:"c-ibutton ibutton-container mini"});b.on("change",function(){"checked"===b.attr("checked")?(a.$segmentsSection.addClass("is-extended"),a.selected_segments=!0):(a.$segmentsSection.removeClass("is-extended"),a.selected_segments=!1)})};CRMNewContactPage.prototype.initDealToggle=function(){var a=this,b=a.$dealSection.find(".js-ibutton");b.iButton({labelOn:"",labelOff:"",classContainer:"c-ibutton ibutton-container mini"});
b.on("change",function(){"checked"===b.attr("checked")?(a.$dealSection.addClass("is-extended"),a.create_deal=!0):(a.$dealSection.removeClass("is-extended"),a.create_deal=!1)})};CRMNewContactPage.prototype.initDealSection=function(){var a=this,b=a.$wrapper.find(".js-funnels-list");(function(){var c=b.find(".js-visible-link"),e=b.find(".js-field"),f=b.find(".menu-v");f.on("click","a",function(){var g=d(this);c.find(".js-text").html(g.html());f.find(".selected").removeClass("selected");g.closest("li").addClass("selected");
f.hide();setTimeout(function(){f.removeAttr("style")},200);g=g.data("id");e.val(g).trigger("change");(g=a.funnels[g]||!1)&&b.trigger("changeFunnel",g)});d.crm.renderSVG(b)})();(function(){function c(h){l.html("");d.each(h,function(m,n){m=a.stage_template_html;var p=d("<div />").text(n.name).html();m=m.replace("%id%",n.id).replace("%color%",n.color).replace("%name%",p);n=d(m);l.append(n)});d.crm.renderSVG(f);l.find("li:first-child a").trigger("click")}var e=a.$wrapper.find(".js-funnels-list"),f=a.$wrapper.find(".js-funnel-stages-list"),
g=f.find(".js-visible-link"),k=f.find(".js-field"),l=f.find(".menu-v");l.on("click","a",function(){var h=d(this);g.find(".js-text").html(h.html());l.find(".selected").removeClass("selected");h.closest("li").addClass("selected");l.hide();setTimeout(function(){l.removeAttr("style")},200);h=h.data("id");k.val(h)});e.on("changeFunnel",function(h,m){c(m.stages)})})();(function(){function c(){var k=d.datepicker._defaults.dateFormat,l=!1;try{d.datepicker.parseDate(k,f.val()),l=!0}catch(h){}l?(f.data("last-correct-value",
f.val()),g.data("last-correct-value",g.val())):(f.val(f.data("last-correct-value")||""),g.val(g.data("last-correct-value")||""))}var e=a.$wrapper.find(".js-datepicker-wrapper"),f=e.find(".js-datepicker"),g=e.find('[name="deal[expected_date]"]');f.datepicker({altField:g,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,onSelect:c});f.on("blur",c);f.on("keydown keypress keyup",function(k){13===k.which&&k.preventDefault()});e.on("click",".js-icon",function(){f.focus()})})();(function(){var c=a.$wrapper.find(".js-contact-block"),
e=c.find(".js-view-toggle"),f=e.find(".is-active");e.on("click",".c-toggle",function(g){g.preventDefault();g=d(this);var k=g.data("id");if(g.hasClass("is-active"))return!1;a.contact_mode=k;f.length&&f.removeClass("is-active");g.addClass("is-active");f=g;c.find(".c-hidden.is-active").removeClass("is-active");c.find(".c-hidden-"+k).addClass("is-active")})})()};CRMNewContactPage.prototype.initCreate=function(){function a(){function g(){var n=e.$wrapper.find(".js-option-field:checked"),p=e.$wrapper.find(".js-vault-toggle"),
q=e.$wrapper.find(".js-owners-list");n.length&&(n=n.val(),"vaults"===n?(p=p.find(".js-field").val(),m.data.push({name:"vault_id",value:p})):"owners"===n&&(p=q.find(".c-owner"),p.length||m.errors.push({name:"owner[autocomplete]"}),p.each(function(){var r=d(this).data("id");0<r&&m.data.push({name:"owners[]",value:r})})))}function k(){var n=e.$segmentsSection.find("form").serializeArray();d.each(n,function(p,q){m.data.push(q)})}function l(){var n=e.$dealSection.find("form").serializeArray(),p=!0;d.each(n,
function(q,r){m.data.push(r);0<d.trim(r.value).length&&"deal[name]"===r.name&&(p=!1)});p&&m.errors.push({name:"deal[name]",value:e.locales.empty_deal_name})}function h(){var n=e.$extendedFieldsW.data("getFormData")();d.each(n.data,function(p,q){m.data.push(q)});d.each(n.errors,function(p,q){m.errors.push(q)})}var m={data:[],errors:[]};(function(){var n=e.$contactSection.find("form.c-general-form"),p=n.find(".js-phone-list"),q=n.find(".js-email-list");p.find("li .js-value, li .js-ext").removeAttr("name");
q.find("li .js-value, li .js-ext").removeAttr("name");n=n.serializeArray();var r=["contact[firstname]","contact[middlename]","contact[lastname]","contact[name]"],u=!0;d.each(n,function(v,t){t.value=d.trim(t.value);m.data.push(t);0<d.trim(t.value).length&&0<=r.indexOf(t.name)&&(u=!1)});u&&(n=e.$contactSection.find('[name="contact[firstname]"]'),n.length?m.errors.push({name:"contact[firstname]",value:e.locales.empty_contact_name}):(n=e.$contactSection.find('[name="contact[name]"]'),n.length&&m.errors.push({name:"contact[name]",
value:e.locales.empty_contact_name})));p.find("li").each(function(v){var t=d(this),w=t.find(".js-value");t=t.find(".js-ext");var x=w.val(),y=t.val();if(x){var z="contact[phone]["+v+"][value]";w.attr("name",z);m.data.push({name:z,value:x});v="contact[phone]["+v+"][ext]";t.attr("name",v);m.data.push({name:v,value:y})}});q.find("li").each(function(v){var t=d(this),w=t.find(".js-value");t=t.find(".js-ext");var x=w.val(),y=t.val();if(x){var z="contact[email]["+v+"][value]";w.attr("name",z);m.data.push({name:z,
value:x});v="contact[email]["+v+"][ext]";t.attr("name",v);m.data.push({name:v,value:y})}})})();e.$extendedFieldsW.length&&e.is_extended&&h();e.selected_access&&g();e.selected_segments&&k();e.create_deal&&l();return m}function b(g,k){k=k?k:[];g&&(k=g);d.each(k,function(l,h){l=h.value;var m=e.$wrapper.find(':input[name="'+h.name+'"]'),n=d("<div />").addClass("errormsg").text(l);m.length?m.hasClass("error")||(m.parent().append(n),m.addClass("error").one("focus click change",function(){m.removeClass("error");
n.remove()})):e.$errorsSection.append(n)})}function c(g){f||(f=!0,d.post("?module=contact&action=newSave",g,function(k){"ok"===k.status?d.crm.content.load(d.crm.app_url+"contact/"+k.data.contact.id+"/"):b(k.errors)},"json").always(function(){f=!1}))}var e=this,f=!1;e.$wrapper.on("click",".js-submit-form",function(g){g.preventDefault();e.$errorsSection.html("");g=a();g.errors.length?b(!1,g.errors):c(g.data)})};CRMNewContactPage.prototype.initExtendedFields=function(){function a(f){f=f||{};var g=b.$wrapper,
k="c-conditional-field-"+(""+Math.random()).slice(2),l=f.input_name;f.parent_field=f.parent_field||"";f.parent_options=f.parent_options||{};f.index=f.index||0;if(f.parent_field&&!d.isEmptyObject(f.parent_options)){var h=f.parent_field.split(":");if(!(1>=h.length)){h='[name="contact['+h[0]+"]["+f.index+"]["+h[1]+']"]';var m=g.find(h);if(!(0>=m.length)){f.show_empty_option=f.required;var n=f.parent_options,p=g.find(':input[name="'+l+'"]').first();if(!(0>=p.length)){if(p.is("input"))var q=p.next();else q=
p,p=q.prev();var r=function(){p[0].hasAttribute("name")||(p.attr("name",q.attr("name")),q[0].removeAttribute("name"));p.show().val("");q.hide()};g=function(){var u=p.is(":visible")?p.val():q.val();var v=d(this).val().toLowerCase();f.hide_unmatched&&p.closest(".field").show();if(n&&n[v]){v=n[v];p.hide();q.show().children().remove();f.show_empty_option&&q.append(d('<option value=""></option>'));for(var t=0;t<v.length;t++)q.append(d("<option></option>").attr("value",v[t]).text(v[t]));q.val(u);p[0].hasAttribute("name")&&
(q.attr("name",p.attr("name")),p[0].removeAttribute("name"))}else f.hide_unmatched?(r(),p.val(""),p.closest(".field").hide()):p.is(":visible")||(r(),p.val(u))};g.call(m);l=m.closest(".field");l.length?(l.off("."+k),l.on("change."+k,h,g)):(m.off("."+k),m.on("change."+k,g))}}}}}var b=this,c=b.$extendedFieldsW,e=c.find("form");(function(){var f=c.find(".js-dynamic-field-wrapper");f.each(function(){var g=d(this),k=g.find(".js-list"),l=k.find(".c-item")[0].outerHTML;g.on("click",".js-add",function(){k.append(l)});
g.on("click",".js-remove",function(){d(this).closest(".c-item").remove()});k.on("change",".js-ext-toggle",function(){var h=d(this),m=h.closest(".c-item").find(".js-ext-field");"custom"===h.val()?m.attr("disabled",!1).show():m.attr("disabled",!0).hide()})});c.on("prepareSave",function(){f.each(function(){d(this).find(".js-list").find(".c-item").each(function(g){d(this).find("[data-name-pattern]").each(function(){var k=d(this),l=k.data("name-pattern");l&&(l=l.replace("%index%",g),k.attr("name",l))})})})})})();
(function(){function f(g){function k(){h.each(function(){d(this).find(".js-address-wrapper").each(function(n){d(this).find("[data-name-pattern]").each(function(){var p=d(this),q=p.data("name-pattern");if(q&&(q=q.replace("%index%",n),p.attr("name",q),p.is("input"))){var r=p.closest(".js-custom-sub-field-line");r.is('[data-type="Conditional"]')&&(p=r.data("field-id"),r=r.data("subfield-id"),(p=l[p].fields[r])&&a(d.extend(p,{input_name:q,index:n})))}})})})}(function(){g.find(".js-custom-sub-field-line").each(function(){var n=
d(this),p=n.data("name-pattern");n.find(":input").each(function(){var q=d(this);q.attr("data-name-pattern",p);q.removeAttr("name")})});g.find('.js-custom-sub-field-line[data-type="Select"]').each(function(){var n=d(this);n.data("sub-type")||n.find("select").find('option[value=""]').text(n.data("label")+"...")});g.find('.js-custom-sub-field-line[data-type="Checkbox"]').each(function(){var n=d(this),p=n.find(":checkbox");p.wrap("<label>");p=p.parent();p.append("<span>");p.find("span").append(" "+n.data("label"))})})();
var l=b.extended_fields||{},h=g.find(".js-address-list"),m=g.find(".js-address-wrapper")[0].outerHTML;c.on("prepareSave",k);k();g.on("click",".js-add",function(){h.append(m);k()});g.on("click",".js-remove",function(){d(this).closest(".js-address-wrapper").remove()});g.on("click",".js-clear-selected-radio-value",function(){d(this).closest(".js-custom-sub-field-line").find(":radio:checked").attr("checked",!1)});g.on("change",".js-ext-toggle",function(){var n=d(this),p=n.closest(".js-address-wrapper").find(".js-ext-field");
"custom"===n.val()?p.attr("disabled",!1).show():p.attr("disabled",!0).hide()});g.on("change",".js-country-toggle",function(){function n(){w&&w.abort();w=d.post(d.crm.backend_url+"?module=profile&action=regions",{country:t},function(x){"ok"===x.status&&(d.isEmptyObject(x.data.options)?p(!1):p(x.data))}).always(function(){w=!1})}function p(x){u.html("");v.val("");x&&Object.keys(x).length?(u.attr("disabled",!1).show(),v.attr("disabled",!0).hide(),d.each(x.oOrder,function(y,z){(y=x.options[z])&&u.append('<option value="'+
z+'">'+y+"</option>")})):(u.attr("disabled",!0).hide(),v.attr("disabled",!1).show())}var q=d(this),r=q.closest(".js-address-wrapper"),u=r.find(".js-region-select"),v=r.find(".js-region-field"),t=q.val(),w=!1;t?n(t):p(!1)})}c.find(".js-address-section").each(function(){f(d(this))})})();(function(){var f=c.find(".js-bank-section");if(!f.length)return!1;var g=f.find(".js-bank-list"),k=f.find(".js-bank-wrapper")[0].outerHTML;f.on("click",".js-add",function(){g.append(k)});g.on("click",".js-remove",function(){d(this).closest(".js-bank-wrapper").remove()});
f.on("change",".js-ext-toggle",function(){var l=d(this),h=l.closest(".js-bank-wrapper").find(".js-ext-field");"custom"===l.val()?h.attr("disabled",!1).show():h.attr("disabled",!0).hide()});c.on("prepareSave",function(){g.each(function(){d(this).find(".js-bank-wrapper").each(function(l){d(this).find("[data-name-pattern]").each(function(){var h=d(this),m=h.data("name-pattern");m&&(m=m.replace("%index%",l),h.attr("name",m))})})})})})();(function(){c.find(".js-datepicker input:text").each(function(){function f(){try{d.datepicker.parseDate(d.datepicker._defaults.dateFormat,
g.val()),g.data("last-correct-value",g.val()),k.data("last-correct-value",k.val())}catch(l){g.val(g.data("last-correct-value")||""),k.val(k.data("last-correct-value")||"")}}var g=d(this),k=g.siblings('input[type="hidden"]');g.datepicker({altField:k,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,onSelect:f});g.on("blur",f);g.on("keydown keypress keyup",function(l){13===l.which&&l.preventDefault()})})})();c.data("getFormData",function(){c.trigger("prepareSave");var f=e.serializeArray(),g={data:[],
errors:[]};d.each(f,function(k,l){g.data.push(l)});return g})};CRMNewContactPage.prototype.setContactData=function(a){var b=this;d.each(a,function(c,e){"string"===typeof e||"number"===typeof e?(c=b.$wrapper.find('[name="contact['+c+']"]'),c.length&&c.val(e).trigger("change")):("phone"===c&&d.each(e,function(f,g){f={number:g.value,ext:g.ext};d(document).trigger("addContactPhone",f)}),"email"===c&&d.each(e,function(f,g){f={name:g.value,ext:g.ext};d(document).trigger("addContactEmail",f)}))})};CRMNewContactPage.prototype.initHeaderActions=
function(){function a(){b||(b=!0,d.post("?module=contact&action=createSettings",{},function(c){new CRMDialog({html:c})}).always(function(){b=!1}))}var b=!1;this.$wrapper.on("click",".js-show-personal-settings-dialog",function(c){c.preventDefault();a()})};CRMNewContactPage.prototype.initWYSIWYG=function(){var a=this.$wrapper.find(".js-wysiwyg");if(!a.length)return!1;a.each(function(){var b=d(this);d.crm.initWYSIWYG(b,{keydownCallback:function(c){}})})};CRMNewContactPage.prototype.initContactUpdateDialog=
function(){function a(){c||(c=!0,d.post(d.crm.app_url+"?module=contact&action=updateDialog",{call_id:b.call_id},function(e){new CRMDialog({html:e})}).always(function(){c=!1}))}var b=this,c=!1;b.$wrapper.on("click",".js-show-update-dialog",function(e){e.preventDefault();a()})};return CRMNewContactPage}(jQuery),CRMContactAccessDialogNew=function(d){CRMContactAccessDialogNew=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$optionsList=this.$wrapper.find(".js-options-list");
this.$vaultsToggle=this.$wrapper.find(".js-vault-toggle");this.$ownersList=this.$wrapper.find(".js-owners-list");this.$submitButton=this.$wrapper.find(".js-save");this.$errorsPlace=this.$wrapper.find(".js-errors-place");this.dialog=this.$wrapper.data("dialog");this.owner_template_html=a.owner_template_html;this.contact_id=a.contact_id;this.owners=a.owners;this.locales=a.locales;this.initClass()};CRMContactAccessDialogNew.prototype.initClass=function(){this.initChangeOptions();this.initAutocomplete();
this.initVaultToggle()};CRMContactAccessDialogNew.prototype.initChangeOptions=function(){var a=this.$optionsList.find(".c-option.is-active");this.$optionsList.on("change",".js-option-field",function(){var b=d(this),c=b.closest(".c-option");"checked"===b.attr("checked")&&(a.length&&a.removeClass("is-active"),a=c.addClass("is-active"))})};CRMContactAccessDialogNew.prototype.initAutocomplete=function(){function a(e){e.addClass("highlighted");setTimeout(function(){e.removeClass("highlighted")},2E3)}var b=
this,c=b.$ownersList.find(".js-autocomplete");c.autocomplete({source:d.crm.app_url+"?module=autocomplete&type=user",appendTo:b.$wrapper,minLength:0,focus:function(){return!1},select:function(e,f){e=b.$ownersList.find('.c-owner[data-id="'+f.item.id+'"]');e=e.length?e:void 0;if(!e){f=f.item;e=b.owner_template_html;e=e.replace(/%id%/,f.id);var g=e.replace;var k=f.name;k=d("<div></div>").text(k).html();e=g.call(e,"%name%",k).replace("%photo_url%",f.photo_url);f=d(e);b.$ownersList.append(f);e=f}a(e);c.val("");
return!1}}).data("ui-autocomplete")._renderItem=function(e,f){return d('<li class="ui-menu-item-html"><div>'+f.value+"</div></li>").appendTo(e)};c.on("focus",function(){c.data("uiAutocomplete").search(c.val())});b.$ownersList.on("click",".js-delete-owner",function(){d(this).closest(".c-owner").remove()})};CRMContactAccessDialogNew.prototype.initVaultToggle=function(){var a=this.$vaultsToggle,b=a.find(".js-visible-link"),c=a.find(".js-field"),e=a.find(".menu-v");e.on("click","a",function(){var f=d(this);
b.find(".js-text").html(f.html());e.find(".selected").removeClass("selected");f.closest("li").addClass("selected");e.hide();setTimeout(function(){e.removeAttr("style")},200);f=f.data("id");c.val(f)});d.crm.renderSVG(a)};return CRMContactAccessDialogNew}(jQuery),CRMContactResponsibleDialog=function(d){CRMContactResponsibleDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$responsibleList=this.$wrapper.find(".js-responsible-list");this.$submitButton=this.$wrapper.find(".js-save");
this.dialog=this.$wrapper.data("dialog");this.locales=a.locales;this.responsible_template_html=a.responsible_template_html;this.initClass()};CRMContactResponsibleDialog.prototype.initClass=function(){var a=this;a.$wrapper.on("change","input",function(){a.toggleButton(!0)});a.initSubmit();a.initClearResponsible();a.initAutocomplete()};CRMContactResponsibleDialog.prototype.initSubmit=function(){function a(){if(!e){e=!0;var f=d.crm.app_url+"?module=contact&action=responsibleSave",g=b();if(!g)return e=
!1;var k=d('<span class="icon loading"><i class="fas fa-spinner wa-animation-spin"></i></span>');k.appendTo(c.$submitButton.parent());c.$submitButton.attr("disabled",!0);d.post(f,g,function(l){"ok"===l.data.result?d.crm.content.reload().then(function(){c.dialog.close()}):"no_vault_access"===l.data.result&&(d(".no-access-error").html(l.data.message),setTimeout(function(){c.dialog.close()},5E3))},"json").always(function(){c.$submitButton.attr("disabled",!1);c.toggleButton(!1);k.remove();e=!1})}}function b(){var f=
d("#contact_id").val(),g=d("#responsible_id").val();return{contact_id:f,responsible_id:g}}var c=this,e=!1;c.$form.on("submit",function(f){f.preventDefault();a()})};CRMContactResponsibleDialog.prototype.initClearResponsible=function(){function a(){var e=d.crm.app_url+"?module=contact&action=responsibleSave",f={contact_id:d("#contact_id").attr("value"),responsible_id:0},g=d('<span class="icon loading"><i class="fas fa-spinner wa-animation-spin"></i></span>');g.appendTo(c.$submitButton.parent());c.$submitButton.attr("disabled",
!0);d.post(e,f,function(k){"ok"===k.status?d.crm.content.reload().then(function(){c.dialog.close()}):(console.log("Error saving Responsible contact classification: "+arguments[2],arguments),b("Error saving Responsible contact classification: "+arguments[2]))},"json").always(function(){c.$submitButton.attr("disabled",!1);c.toggleButton(!1);g.remove()})}function b(e){e=d('<div class="errormsg" />').text(e);c.$errorsPlace.append(e)}var c=this;c.$wrapper.on("click",".js-clear-responsible",function(e){e.preventDefault();
d.crm.confirm.show({title:c.locales.clear_responsible_title,text:c.locales.clear_responsible_text,button:c.locales.clear_responsible_button,onConfirm:a})})};CRMContactResponsibleDialog.prototype.initAutocomplete=function(){function a(f){f.addClass("highlighted");setTimeout(function(){f.removeClass("highlighted")},2E3)}var b=this,c=d("#contact_id").val(),e=b.$responsibleList.find(".js-autocomplete");e.autocomplete({source:d.crm.app_url+"?module=autocomplete&type=user&contact_id="+c,appendTo:b.$wrapper,
minLength:0,focus:function(){return!1},select:function(f,g){f=b.$responsibleList.find('.c-responsible[data-id="'+g.item.id+'"]');f=f.length?f:void 0;if(!f){g=g.item;f=b.responsible_template_html;f=f.replace(/%id%/,g.id);var k=f.replace;var l=g.name;l=d("<div></div>").text(l).html();f=k.call(f,"%name%",l).replace("%photo_url%",g.photo_url);d("#responsible_id").val(g.id);g=d(f);b.$responsibleList.append(g);d(".js-input").css("display","none");b.$submitButton.attr("disabled",!1);b.toggleButton(!0);f=
g}a(f);b.toggleButton(!0);e.val("");return!1}}).data("ui-autocomplete")._renderItem=function(f,g){var k=d("<li />");k.addClass("ui-menu-item-html").append("<div>"+g.value+"</div>").appendTo(f);g.rights||(k.addClass("is-locked"),k.on("click",function(l){l.preventDefault();l.stopPropagation()}));return k};e.on("focus",function(){e.data("uiAutocomplete").search(e.val())});b.$responsibleList.on("click",".js-delete-responsible",function(){d(this).closest(".c-responsible").remove();d("#responsible_id").val("");
d(".js-input").css("display","");d(".js-autocomplete").focus();b.$submitButton.attr("disabled",!0);b.toggleButton(!0)})};CRMContactResponsibleDialog.prototype.toggleButton=function(a){var b=this.$submitButton;a?b.addClass("yellow"):b.removeClass("yellow")};return CRMContactResponsibleDialog}(jQuery),CRMContactAccessDialog=function(d){CRMContactAccessDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$optionsList=this.$wrapper.find(".js-options-list");this.$vaultsToggle=
this.$wrapper.find(".js-vault-toggle");this.$ownersList=this.$wrapper.find(".js-owners-list");this.$submitButton=this.$wrapper.find(".js-save");this.$errorsPlace=this.$wrapper.find(".js-errors-place");this.dialog=this.$wrapper.data("dialog");this.owner_template_html=a.owner_template_html;this.contact_id=a.contact_id;this.owners=a.owners;this.locales=a.locales;this.initClass()};CRMContactAccessDialog.prototype.initClass=function(){var a=this;a.$wrapper.on("change","input",function(){a.toggleButton(!0)});
a.initChangeOptions();a.initSubmit();a.initAutocomplete();a.initVaultToggle()};CRMContactAccessDialog.prototype.initSubmit=function(){function a(){if(!f){f=!0;e.$errorsPlace.html("");var g=d.crm.app_url+"?module=contact&action=accessSave",k=b();if(!k)return f=!1;var l=d('<span class="icon loading"><i class="fas fa-spinner wa-animation-spin"></i></span>');l.appendTo(e.$submitButton.parent());e.$submitButton.attr("disabled",!0);d.post(g,k,function(h){"ok"===h.status?d.crm.content.reload().then(function(){e.dialog.close()}):
(console.log("Error saving contact access classification: "+arguments[2],arguments),c("Error saving contact access classification: "+arguments[2]))},"json").always(function(){e.$submitButton.attr("disabled",!1);l.remove();e.toggleButton(!1);f=!1})}}function b(){var g=[],k=e.$wrapper.find(".js-option-field:checked");if(k.length){k=k.val();if("vaults"===k){var l=e.$vaultsToggle.find(".js-field").val();g.push({name:"vault_id",value:l})}if("owners"===k){l=e.$ownersList.find(".c-owner");if(!l.length)return c(e.locales.empty_owner),
!1;l.each(function(){var h=d(this).data("id");0<h&&g.push({name:"owners[]",value:h})})}"all"===k&&g.push({name:"vault_id",value:"0"});k=e.$wrapper.find(".js-employees-field");k.length&&"checked"===k.attr("checked")&&g.push({name:"employees",value:"on"});g.push({name:"contact_id",value:e.contact_id})}return g}function c(g){g=d('<div class="errormsg" />').text(g);e.$errorsPlace.append(g)}var e=this,f=!1;e.$form.on("submit",function(g){g.preventDefault();a()})};CRMContactAccessDialog.prototype.initChangeOptions=
function(){var a=this,b=a.$optionsList.find(".c-option.is-active");a.$optionsList.on("change",".js-option-field",function(){var c=d(this),e=c.closest(".c-option");"checked"===c.attr("checked")&&(b.length&&b.removeClass("is-active"),b=e.addClass("is-active"));a.dialog.resize()})};CRMContactAccessDialog.prototype.initAutocomplete=function(){function a(e){e.addClass("highlighted");setTimeout(function(){e.removeClass("highlighted")},2E3)}var b=this,c=b.$ownersList.find(".js-autocomplete");c.autocomplete({source:d.crm.app_url+
"?module=autocomplete&type=user",appendTo:b.$wrapper,minLength:0,focus:function(){return!1},select:function(e,f){e=b.$ownersList.find('.c-owner[data-id="'+f.item.id+'"]');e=e.length?e:void 0;if(!e){f=f.item;e=b.owner_template_html;e=e.replace(/%id%/g,f.id);var g=e.replace;var k=f.name;k=d("<div></div>").text(k).html();e=g.call(e,"%name%",k).replace("%photo_url%",f.photo_url);f=d(e);b.$ownersList.append(f);b.dialog.resize();e=f}a(e);b.toggleButton(!0);c.val("");return!1}}).data("ui-autocomplete")._renderItem=
function(e,f){return d('<li class="ui-menu-item-html"><div>'+f.value+"</div></li>").appendTo(e)};c.on("focus",function(){c.data("uiAutocomplete").search(c.val())});b.$ownersList.on("click",".js-delete-owner",function(){d(this).closest(".c-owner").remove();b.toggleButton(!0)})};CRMContactAccessDialog.prototype.toggleButton=function(a){var b=this.$submitButton;a?b.removeClass("green").addClass("yellow"):b.removeClass("yellow").addClass("green")};CRMContactAccessDialog.prototype.initVaultToggle=function(){var a=
this.$vaultsToggle,b=a.find(".js-visible-link"),c=a.find(".js-field"),e=a.find(".menu-v");e.on("click","a",function(){var f=d(this);b.find(".js-text").html(f.html());e.find(".selected").removeClass("selected");f.closest("li").addClass("selected");e.hide();setTimeout(function(){e.removeAttr("style")},200);f=f.data("id");c.val(f)});d.crm.renderSVG(a)};return CRMContactAccessDialog}(jQuery),CRMContactCreateSettings=function(d){CRMContactCreateSettings=function(a){this.$wrapper=a.$wrapper;this.$form=
this.$wrapper.find("form");this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMContactCreateSettings.prototype.initClass=function(){this.initSave()};CRMContactCreateSettings.prototype.initSave=function(){function a(){var g={data:[],errors:[]},k=e.serializeArray();d.each(k,function(l,h){g.data.push(h)});return g}function b(g){f||(f=!0,d.post("?module=contact&action=createSettingsSave",g,function(k){"ok"===k.status?c.dialog.close():(k=(k=k.errors)?k:[],console.log(k))},"json").always(function(){f=
!1}))}var c=this,e=c.$form,f=!1;e.on("submit",function(g){g.preventDefault();g=a();g.errors.length?(g=(g=g.errors)?g:[],console.log(g)):b(g.data)})};return CRMContactCreateSettings}(jQuery),CRMContactAddEmployeeDialog=function(d){CRMContactAddEmployeeDialog=function(a){this.$wrapper=a.$wrapper;this.contact_id=a.contact_id;this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMContactAddEmployeeDialog.prototype.initClass=function(){this.initAddEmployee()};CRMContactAddEmployeeDialog.prototype.initAddEmployee=
function(){function a(k){function l(m){var n=d('<div class="line errormsg" />').html(m);f.append(n);c.$form.one("submit",function(){n.remove()})}if(k[0])d.each(k,function(m,n){l(n.value)});else{var h=Object.keys(k);d.each(h,function(m,n){l(k[n])})}}function b(k){g||(g=!0,d.post("?module=contact&action=addEmployeeSave",k,function(l){"ok"===l.status?(d.crm.content.reload(),c.dialog.close()):l.errors&&a(l.errors)}).always(function(){g=!1}))}var c=this,e=c.$wrapper.find("#c-contact-add-employee-form"),
f=c.$wrapper.find(".js-errors-place"),g=!1;e.on("submit",function(k){k.preventDefault();k=e.serializeArray();var l=[];l.length?a(l):b(k)})};return CRMContactAddEmployeeDialog}(jQuery),CRMContactUpdateDialog=function(d){CRMContactUpdateDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$dialog=this.$wrapper.data("dialog");this.$footer=this.$wrapper.find(".js-dialog-footer");this.$submitButton=this.$wrapper.find(".js-submit-button");this.initClass()};CRMContactUpdateDialog.prototype.initClass=
function(){this.initAutocomplete();this.initSubmit()};CRMContactUpdateDialog.prototype.initAutocomplete=function(){var a=this,b=a.$wrapper.find(".js-autocomplete-wrapper"),c=b.find(".js-autocomplete"),e=b.find(".js-field"),f=a.$wrapper.find(".js-field-autocomplete");c.autocomplete({appendTo:b,source:d.crm.app_url+"?module=autocomplete",minLength:2,html:!0,focus:function(){return!1},select:function(g,k){g=d("<div />").text(k.item.name).text();c.val(g).blur();e.val(k.item.id).trigger("change");g=f.html;
k=k.item;k=contactHtml=`        
            <div class="c-column c-column-image">
                <a class="flexbox middle" href="${d.crm.app_url}${k.link}" target="_top" data-link="top" >
                    <img src="${k.photo_url}" alt="${k.name}">
                </a>
            </div>
            <div class="c-column middle nowrap">
                <a href="${d.crm.app_url}${k.link}" target="_top" data-link="top" title="${k.name}">${k.name}</a>
            </div>`;g.call(f,k);return!1}}).data("ui-autocomplete")._renderItem=function(g,k){return d("<li />").addClass("ui-menu-item-html").append("<div>"+k.value+"</div>").appendTo(g)};e.on("change",function(){a.$submitButton.attr("disabled",!1)})};CRMContactUpdateDialog.prototype.initSubmit=function(){function a(){var l={data:[],errors:[]},h=f.serializeArray();d.each(h,function(m,n){l.data.push(n)});return l}function b(l){l=l?l:[];d.each(l,function(h,m){h=m.value;var n=f.find('[name="'+m.name+
'"]'),p=d("<span />").addClass("errormsg").text(h);n.length?n.hasClass("error")||(n.parent().append(p),n.addClass("error").one("focus click",function(){n.removeClass("error");p.remove()})):(g.append(p),f.one("submit",function(){p.remove()}))})}function c(l){k||(k=!0,d.post("?module=contact&action=update",l,function(h){"ok"===h.status?(e.$wrapper.find(".js-field-autocomplete").data("success",!0),e.$dialog.close()):b(h.errors)},"json").always(function(){k=!1}))}var e=this,f=e.$form,g=e.$wrapper.find(".js-errors-place"),
k=!1;f.on("submit",function(l){l.preventDefault();l=a();l.errors.length?b(l.errors):c(l.data)})};return CRMContactUpdateDialog}(jQuery),CRMContactAddCompanyContactDialog=function(d){CRMContactAddCompanyContactDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$company_value=this.$wrapper.find(".js-company-value");this.$submit=this.$wrapper.find(".js-submit");this.$footer=this.$wrapper.find(".js-dialog-footer");this.$company_id_input=this.$wrapper.find(".js-company-id");
this.$company_name_input=this.$wrapper.find(".js-autocomplete-company");this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMContactAddCompanyContactDialog.prototype.initClass=function(){var a=this;a.$form.on("click",".js-company-item",function(){a.$submit.prop("disabled",!1)});a.initAutoComplete();a.initSubmit()};CRMContactAddCompanyContactDialog.prototype.initAutoComplete=function(){var a=this,b=a.$wrapper.find(".js-selected-company"),c=a.$wrapper.find(".js-change-company"),e=a.$wrapper.find(".js-label-new-company");
a.$company_name_input.autocomplete({source:function(f,g){d.post("?module=autocomplete&type=company",f,function(k){d.isEmptyObject(k)&&f.term?e.css({color:"#999"}):e.css({color:"#FFF"});g(k)},"json")},minLength:0,focus:function(){return!1},select:function(f,g){a.$company_id_input.val(g.item.id);b.html('<i class="icon userpic size-20" style="background-image: url('+g.item.photo_url+');"></i>').append(d("<span />").text(g.item.name)).removeClass("hidden");a.$company_name_input.addClass("hidden");return!1}}).data("ui-autocomplete")._renderItem=
function(f,g){return d("<li />").addClass("ui-menu-item-html").append("<div>"+g.value+"</div>").appendTo(f)};a.$company_name_input.on("focus",function(){a.$company_name_input.data("uiAutocomplete").search(a.company_name)});c.on("click",function(){a.$company_id_input.val(0);b.html("").addClass("hidden");a.$company_name_input.removeClass("hidden").focus()})};CRMContactAddCompanyContactDialog.prototype.initSubmit=function(){function a(){var c=d('<span class="icon loading"><i class="fas fa-spinner wa-animation-spin"></i></span>'),
e=d.crm.app_url+"?module=contact&action=addCompanyContactSave",f=b.$form.serializeArray();b.$submit.prop("disabled",!0);b.$footer.append(c);d.post(e,f,function(g){"ok"===g.status?d.crm.content.reload():(b.$submit.prop("disabled",!1),c.remove())})}var b=this;b.$form.on("submit",function(c){c.preventDefault();c=b.$company_id_input.val();var e=b.$company_name_input.val();if(0==c&&!d.trim(e))return b.$company_value.addClass("shake animated"),b.$company_name_input.focus(),setTimeout(function(){b.$company_value.removeClass("shake animated");
b.$company_name_input.focus()},500),!1;a()})};return CRMContactAddCompanyContactDialog}(jQuery);var CRMContactsPage=function(d){CRMContactsPage=function(a){this.$wrapper=a.$wrapper;this.$content=this.$wrapper.find("#js-content-block");this.is_admin=a.is_admin;this.context=a.context||{};this.view=a.view||"thumbs";this.total_count=a.total_count||0;this.page_count=a.page_count||0;this.locales=a.locales;this.sidebar=this.$wrapper.find(".c-contacts-sidebar").data("sidebar_controller");this.initClass()};CRMContactsPage.prototype.initClass=function(){this.initElastic();"segment"===this.context.type&&
this.initEditableName(d.crm.app_url+"?module=contactSegment&action=save&is_rename=1",this.context);"list"===this.view&&(this.initContactsColumnsSection(),this.initContactsTable());"thumbs"===this.view&&this.initContactsThumbs();this.initOperationsMenu();"segment"===this.context.type?this.initSegmentContext():"search"===this.context.type&&this.initCreateFilterLink();this.$wrapper.on("click",".pager a",function(){d(this).replaceWith('<i class="icon16 loading"></i>');d(document).one("wa_loaded",function(){d("html, body").scrollTop(0)})});
this.initTableSlider();this.initHoverNames();this.initDroppable()};CRMContactsPage.prototype.initEditableName=function(a,b){var c=this.$wrapper.find(".js-name-editable").first();if(!(0>=c.length)){var e=this,f=!1,g=null;new CrmEditable({$wrapper:c,onSave:function(k){var l=k.$field.val();l.length&&k.text!==l?(g&&g.abort(),l={id:b.info.id,name:l},k.$field.attr("disabled",!0),f||=d('<i class="icon16 loading"></i>').css("margin","0 0 0 4px").insertAfter(k.$field),g=d.post(a,l,function(h){h&&h.data&&h.data.segment&&
(k.text=h.data.segment.name,k.$wrapper.text(h.data.segment.name),e.sidebar.updateItem(b,{name:h.data.segment.name}))},"json").always(function(){k.$field.attr("disabled",!1);k.toggle("hide");f.length&&(f.remove(),f=!1)})):(l.length||k.$field.val(k.text),k.toggle("hide"))}})}};CRMContactsPage.prototype.initElastic=function(){var a=this.$wrapper,b=this.$wrapper.find("#js-aside-block"),c=this.$content;new CRMElasticBlock({$wrapper:a,$aside:b,$content:c});new CRMElasticBlock({$wrapper:a,$content:b,$aside:c})};
CRMContactsPage.prototype.initContactsColumnsSection=function(){function a(l){if(d.contains(document,e[0])){var h=e.hasClass("is-active");l=d.contains(e[0],l.target);h&&!l&&c()}else d(document).off("click",a)}function b(l){l.preventDefault();k||(k=!0,l=d.crm.app_url+"?module=contact&action=columns",f.html(g),c(!0),d.post(l,{},function(h){f.html(h)}).always(function(){k=!1}))}function c(l){l?e.addClass("is-active"):e.removeClass("is-active")}var e=this.$wrapper.find(".js-contacts-columns-section"),
f=e.find(".js-load-here"),g=f.html(),k=!1;e.on("click",".js-show-contact-columns-dialog",function(l){e.hasClass("is-active")?c(!1):b(l)});d(document).on("click",a);e.on("close",function(){c(!1)})};CRMContactsPage.prototype.initContactsTable=function(){var a=this;(function(){a.$wrapper.find(".js-width-toggle-wrapper").each(function(){var b=d(this),c=b.data("fullColumnId");b.on("click",".js-set-width",function(){var e=d(this).data("id");d.post(d.crm.app_url+"?module=contactColumns&action=saveWidth",
{width:e,full_column_id:c},function(){d.crm.content.reload()})})})})()};CRMContactsPage.prototype.initContactsThumbs=function(){};CRMContactsPage.prototype.initOperationsMenu=function(){new CRMContactsOperations({$wrapper:this.$wrapper,total_count:this.total_count,page_count:this.page_count,context:this.context,sidebar:this.sidebar,is_admin:this.is_admin,view:this.view})};CRMContactsPage.prototype.initSegmentContext=function(){var a=this.$wrapper;this.initSegmentLinks();this.sidebar.updateItem(this.context,
{count:this.context.info.count});var b=d.crm.storage.get("crm/create/category")||{},c=+new Date;d.crm.storage.del("crm/create/category");"category"===this.context.info.type&&(a=a.find(".js-segment-add-contacts"),b.id==this.context.info.id&&3E4>=c-b.timestamp&&a.click())};CRMContactsPage.prototype.initSegmentLinks=function(){function a(g){g.preventDefault();f&&f.abort();f=d.post(d.crm.app_url+"?module=contactSegment&action=addContacts",{id:b.context.info.id},function(k){new CRMDialog({html:k})}).always(function(){f=
!1})}var b=this,c=b.$wrapper.find(".js-segment-actions-list"),e=!1,f=!1;c.on("click",".js-show-edit-dialog",function(g){g.preventDefault();f&&f.abort();f=d.post(d.crm.app_url+"?module=contactSegment&action=edit",{id:b.context.info.id},function(k){new CRMDialog({html:k})}).always(function(){f=!1})});c.on("click",".js-show-archive-dialog",function(g){g.preventDefault();if(!e){e=!0;var k=d(this).closest(".crm-segment-archive-li"),l=k.hasClass("archived");k.removeClass("archived not-archived").addClass("loading");
d.post(d.crm.app_url+"?module=contactSegment&action=archive",{id:b.context.info.id,archive:l?0:1},function(){k.addClass(l?"not-archived":"archived")}).always(function(){k.removeClass("loading");e=!1})}});c.on("click",".js-show-delete-confirm",function(){function g(){d.post(d.crm.app_url+"?module=contactSegment&action=delete",{id:b.context.info.id},function(k){"ok"===k.status&&d.crm.content.load(d.crm.app_url+"contact/")}).always(function(){e=!1})}e||(e=!0,d.crm.confirm.show({title:b.locales.delete_segment_title,
text:b.locales.delete_segment_text,button:b.locales.delete_segment_button,onConfirm:g}))});c.on("click","a",function(){c.hide();setTimeout(function(){c.removeAttr("style")},200)});if("category"===b.context.info.type)c.on("click",".js-segment-add-contacts",a)};CRMContactsPage.prototype.initCreateFilterLink=function(){var a=this.$wrapper;a.find(".crm-create-filter-link").click(function(b){b.preventDefault();var c=d(this).data("hash");b=d.crm.app_url+"?module=contactSegment&action=edit";c={type:"search",
hash:c,name:a.find(".crm-contact-list-name").text()};d.get(b,c).done(function(e){new CRMDialog({html:e})})})};CRMContactsPage.prototype.initTableSlider=function(){function a(){d.contains(document,g[0])?(q=g.outerWidth(),r=k.outerWidth(),b(),u&&(u=!1,v=0,e(v))):d(window).off("resize",a)}function b(){if(r>q){var t=v+q>=r,w=v+q<r;0<v?t?(n.addClass("is-active"),p.removeClass("is-active")):w&&(n.addClass("is-active"),p.addClass("is-active")):(n.removeClass("is-active"),p.addClass("is-active"))}else n.removeClass("is-active"),
p.removeClass("is-active")}function c(t){var w=q/3;t?(t=v+w,t>r-q&&(t=r-q)):(t=v-w,0>t&&(t=0));v=t;u=!0;e(t);b()}function e(t){var w="-"+t+"px";k.data("isLeftSet",0<t);k.css({"-webkit-transform":"translate("+w+",0)",transform:"translate("+w+",0)"});h.css({"-webkit-transform":"translate("+w+",0)",transform:"translate("+w+",0)"})}var f=this,g=f.$wrapper.find(".js-contacts-section");if(!g.length)return!1;var k=g.find(".js-slider-body"),l=g.find(".js-header-table-wrapper"),h=l.find(".js-header-table"),
m=g.find(".js-arrows-wrapper"),n=m.find(".js-arrow-left"),p=m.find(".js-arrow-right"),q=g.outerWidth(),r=k.outerWidth(),u=!1,v=0;b();(function(){function t(){if(d.contains(document,x[0])){var z=w.scrollTop()>y.top,B=f.$content.height()>w.height();z&&B?(l.css({left:y.left}).width(g.outerWidth()).addClass("is-fixed"),x.addClass("is-fixed")):(l.removeAttr("style").removeClass("is-fixed"),x.removeClass("is-fixed"))}else w.off("scroll",t)}var w=d(window),x=m,y=g.offset();w.on("scroll",t)})();n.on("click",
function(){c(!1)});p.on("click",function(){c(!0)});d(window).on("resize",a)};CRMContactsPage.prototype.initHoverNames=function(){function a(){g=setTimeout(function(){c.removeClass("is-shown").html("")},500)}var b=this.$wrapper.find(".js-contacts-section");if(!b.length)return!1;var c=b.find(".c-hint-wrapper"),e=this.$wrapper.find(".js-contacts-table"),f=e.offset(),g=0;e.on("mouseenter","tr",function(){var k=d(this);if(e.data("isLeftSet")){clearTimeout(g);var l=k.find(".c-name").html();k=k.find("td:first").offset();
c.html(l).css({top:k.top+10-(f.top-28),left:10}).addClass("is-shown")}});e.on("mouseleave","tr",function(){a()});c.on("mouseenter",function(){clearTimeout(g)});c.on("mouseleave",a)};CRMContactsPage.prototype.initDroppable=function(){function a(c,e){d.post(d.crm.app_url+"?module=contactSegment&action=addContactsSave",{id:c,contact_id:e},"json").done(function(f){"ok"===f.status&&f.data.segment&&b.sidebar.updateItem({type:"segment",info:{id:c}},{count:f.data.segment.count})})}var b=this;b.$wrapper.find(".js-sidebar").find(".js-segment-droparea").each(function(){var c=
d(this);c.droppable({tolerance:"pointer",hoverClass:"is-hovered",over:function(e,f){f.draggable.hasClass("ui-draggable")||c.removeClass("is-hovered")},drop:function(e,f){e=d(this).data("id");var g=[],k=f.helper.data("user-id");f=f.helper.data("user-ids");k="undefined"!==typeof k?k+"":null;f="undefined"!==typeof f?f+"":null;k?g.push(k):f&&(0<f.indexOf(",")?g=f.split(","):g.push(f));0<e&&0<g.length&&a(e,g)}})})};return CRMContactsPage}(jQuery),CRMContactsColumnsDialog=function(d){CRMContactsColumnsDialog=
function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$activeList=this.$wrapper.find(".js-active-list");this.$unactiveList=this.$wrapper.find(".js-unactive-list");this.initClass()};CRMContactsColumnsDialog.prototype.initClass=function(){this.initSubmit();this.initSort();this.initComboList();this.$wrapper.on("click",".js-close-dialog",function(){d(this).closest(".js-contacts-columns-section").trigger("close")})};CRMContactsColumnsDialog.prototype.initSubmit=function(){function a(){if(!e){e=
!0;var f=d.crm.app_url+"?module=contactColumns&action=save",g=b();d.post(f,g,function(k){"ok"===k.status?d.crm.content.reload():alert("Error")}).always(function(){e=!1})}}function b(){var f=c.serializeArray();d.each(f,function(g,k){k.value=g+1});return f}var c=this.$form,e=!1;c.on("submit",function(f){f.preventDefault();a()})};CRMContactsColumnsDialog.prototype.initSort=function(){this.$activeList.sortable({distance:10,handle:".c-toggle",helper:"clone",items:".js-item",axis:"y"})};CRMContactsColumnsDialog.prototype.initComboList=
function(){var a=this;a.$activeList.on("change",".c-field",function(){var b=d(this),c=b.closest(".js-item");"checked"===b.attr("checked")?c.appendTo(a.$activeList):c.appendTo(a.$unactiveList)});a.$unactiveList.on("change",".c-field",function(){var b=d(this),c=b.closest(".js-item");"checked"===b.attr("checked")?c.appendTo(a.$activeList):c.appendTo(a.$unactiveList)})};return CRMContactsColumnsDialog}(jQuery),CRMThumbContact=function(d){CRMThumbContact=function(a){this.$wrapper=a.$wrapper;this.user_id=
this.$wrapper.data("user-id");this.can_be_drag=a.can_be_drag;this.initClass()};CRMThumbContact.prototype.initClass=function(){this.can_be_drag&&this.initDraggable()};CRMThumbContact.prototype.initDraggable=function(){var a=d("#c-contacts-sidebar .js-segment-droparea");this.$wrapper.draggable({handle:".js-userpic",delay:200,cursorAt:{top:0,left:0},helper:function(){var b=d("#c-users-list .js-move-user.is-active").map(function(){return d(this).data("user-id")}).toArray();return 1<b.length?'<div id="c-users-helper" data-user-ids="'+
b.join(",")+'"><span class="indicator red">'+b.length+"</span></div>":d(this).clone().addClass("is-clone")},start:function(){a.length&&a.addClass("c-drop-here")},stop:function(b,c){b=c.helper;var e=b.clone();e.insertAfter(b).fadeOut(270);setTimeout(function(){e.remove()},300);a.length&&a.removeClass("c-drop-here")}})};return CRMThumbContact}(jQuery),CRMTableContact=function(d){CRMTableContact=function(a){this.$wrapper=a.$wrapper;this.user_id=this.$wrapper.data("user-id");this.can_be_drag=a.can_be_drag;
this.initClass()};CRMTableContact.prototype.initClass=function(){this.can_be_drag&&this.initDraggable()};CRMTableContact.prototype.initDraggable=function(){var a=this,b=d("#c-contacts-sidebar .js-segment-droparea"),c=d(".js-contacts-table .js-move-user");a.$wrapper.draggable({helper:function(){var e=[],f="";c.filter(".is-active").each(function(){var g=d(this).data("user-id");g&&e.push(g)});1>=e.length?(e.push(a.user_id),f=a.$wrapper.find(".userpic")[0].outerHTML,f='<div id="c-users-helper" data-user-ids="'+
e.join(",")+'">'+f+"</div>"):f='<div id="c-users-helper" data-user-ids="'+e.join(",")+'"><span class="indicator red">'+e.length+"</span></div>";return f},appendTo:"body",delay:200,cursorAt:{top:0,left:0},start:function(e,f){f.helper.addClass("is-clone");b.length&&b.addClass("c-drop-here")},stop:function(e,f){e=f.helper;var g=e.clone();g.insertAfter(e).fadeOut(270);setTimeout(function(){g.remove()},300);b.length&&b.removeClass("c-drop-here")}})};return CRMTableContact}(jQuery);var CRMContactsSidebar=function(d){CRMContactsSidebar=function(a){this.$wrapper=a.$wrapper;this.$segmentsLists=this.$wrapper.find(".c-segment-list");this.$add_new_segment_link=this.$wrapper.find(".c-create-new-segment");this.is_admin=a.is_admin;this.initClass()};CRMContactsSidebar.prototype.initClass=function(){this.initSortable();this.initAddLink();this.initAddNewSegmentLink();this.initHighlight();this.initSelectedLink();this.initArchivedToggles();this.initScrollTopOnClick()};CRMContactsSidebar.prototype.initSortable=
function(){function a(k){return k.find("> li").map(function(){var l=parseInt(d(this).data("id"),10);return 0<l?l:!1}).toArray()}function b(k,l){g&&(g.abort(),g=!1);g=d.post(k,l,function(){g=!1})}var c=this,e=d.crm.app_url+"?module=contact&action=sortSave",f,g=!1;c.$segmentsLists.each(function(){var k=d(this),l=k.data("shared")?1:0;!c.is_admin&&l||k.sortable({distance:10,items:"> li:not(.sort-disabled)",axis:"y",delay:200,tolerance:"pointer",start:function(h,m){f=m.item.index()},stop:function(h,m){m.item.removeAttr("style");
f!=m.item.index()&&(h=a(k),b(e,{segments:h,shared:l}))}})})};CRMContactsSidebar.prototype.initAddLink=function(){var a=!1,b=this.$wrapper.find(".js-add-link"),c=b.find(".icon16"),e=c.attr("class");b.on("click",function(){if(!a){a=!0;var f=d.crm.app_url+"?module=contact&action=add";c.attr("class","icon16 loading");d.post(f,{},function(g){new CRMDialog({html:g})}).always(function(){a=!1;c.attr("class",e)})}})};CRMContactsSidebar.prototype.initAddNewSegmentLink=function(){var a=this.$add_new_segment_link;
a.click(function(b){b.preventDefault();d.get(d.crm.app_url+"?module=contactSegment&action=edit").done(function(c){new CRMDialog({html:c})}).always(function(){a.find(".icon16").hide()})})};CRMContactsSidebar.prototype.updateItem=function(a,b){"segment"===a.type&&(a=this.$segmentsLists.find('li[data-id="'+a.info.id+'"]'),a.length&&(void 0!==b.name&&a.find(".name").text(b.name||""),void 0!==b.count&&a.find(".count").text(b.count||"")))};CRMContactsSidebar.prototype.initHighlight=function(a,b){var c=
d(".all-contacts-link");this.$wrapper.find('a[href^="'+d.crm.app_url+'"]').each(function(e,f){if(location.pathname==f.pathname)return e=d(f),f=e.closest("li"),f.length||(f=e),c.removeClass("selected"),f.addClass("selected"),!1;c.addClass("selected")})};CRMContactsSidebar.prototype.initSelectedLink=function(){var a=this;sessionStorage.getItem("selected_contacts")||sessionStorage.setItem("selected_contacts","[]");var b=this.$wrapper.find(".js-selected-contacts"),c=b.find(".count"),e=sessionStorage.getItem("selected_contacts");
if(e=JSON.parse(e).length)c.text(e),b.removeClass("js-selected-contacts-hidden");b.on("click",function(f){f.preventDefault();f=d.crm.app_url+"?module=contact&action=selected";var g=sessionStorage.getItem("selected_contacts");d.post(f,{selected_ids:g},function(k){k&&(history.pushState(null,null,d.crm.app_url+"contact/selected/"),d(document).find("#c-content-block").html(k),a.initHighlight())})})};CRMContactsSidebar.prototype.initArchivedToggles=function(){this.$wrapper.find(".js-archived-section").each(function(){var a=
d(this);a.on("click",".js-show-list",function(){a.find(".js-archive-show-link").hide();a.find(".js-archive-list").show()});a.on("click",".js-hide-list",function(){a.find(".js-archive-show-link").show();a.find(".js-archive-list").hide()})})};CRMContactsSidebar.prototype.initScrollTopOnClick=function(){this.$wrapper.on("click","a:not(.js-add-link)",function(){var a=d(this),b=!a.hasClass("js-stop-scroll");a.find(".icon16").attr("class","icon16 loading").attr("style","");b&&d(window).scrollTop(0)})};
return CRMContactsSidebar}(jQuery);
CRMContactsSidebar.initCollapsibleSidebar=function(){$.each(["mylists-my","tags","vaults","responsibles","admin"],function(){1==localStorage.getItem("collapsible_sidebar_"+this)&&($("#collapsible-"+this).find(".js-collapsible").css({display:"none"}),$("#collapsible-"+this).find(".caret .fas").removeClass("fa-caret-down").addClass("fa-caret-right"))});$(".c-contacts-sidebar").on("click",".collapse-handler",function(){var d=$(this).parents(".js-collapse-wrapper").data("block"),a=$(this).parents(".js-collapse-wrapper");
a=$(a).find(".js-collapsible");a.is(":visible")?($(a).css({display:"none"}),$(this).find("[data-fa-i2svg]").removeClass("fa-caret-down").addClass("fa-caret-right").attr("data-icon","caret-right"),localStorage.setItem("collapsible_sidebar_"+d,1)):($(a).css({display:""}),$(this).find("[data-fa-i2svg]").removeClass("fa-caret-right").addClass("fa-caret-down").attr("data-icon","caret-down"),localStorage.setItem("collapsible_sidebar_"+d,0))})};var CRMContactsOperations=function(d){CRMContactsOperations=function(a){this.$wrapper=a.$wrapper;this.$bar=this.$wrapper.find(".js-operations-wrapper");this.$list=this.$wrapper.find(".js-contacts-list");this.$list_header=this.$list.find(".c-list-header");this.$checkbox_all=this.$wrapper.find(".js-checkbox-all");this.$content=this.$wrapper.find("#js-content-block");this.$selected_link=this.$wrapper.find(".js-selected-contacts");this.$selected_count=this.$selected_link.find(".count");this.$remove_from_selected_list=
this.$bar.find('[data-id="remove_from_selected_list"]');this.page=a.page||1;this.limit=a.limit||30;this.total_items_at_page_count=this.getTotalItemsAtPage()||0;this.total_count=a.total_count||0;this.page_count=a.page_count||0;this.context=a.context||{};this.selected_page=d(document).find("#contact_selected_page").length;this.is_category_segment="segment"===this.context.type&&this.context.info&&"category"===this.context.info.type;this.view=a.view||"";this.sidebar=a.sidebar||null;this.checked_count=
0;this.is_shown=0<this.checked_count;this.is_checked_all=!1;this.initClass()};CRMContactsOperations.prototype.initClass=function(){this.initCheckboxAll();this.initOperations();this.initItemCheckbox();this.initElasticHeader();0<this.selected_page&&this.$remove_from_selected_list.show()};CRMContactsOperations.prototype.initCheckboxAll=function(){var a=this;a.$checkbox_all.click(function(){var b=d(this),c=b.is(":checked");0<a.checked_count?a.unselectAll():(b.prop("checked",c),c?a.selectAll():a.unselectAll());
a.formBar();a.showOrHideBar()})};CRMContactsOperations.prototype.initOperations=function(){var a=this;a.$bar.on("click",".crm-operation-link",function(b){b.preventDefault();switch(d(this).data("id")){case "add_to_segments":a.addToSegmentsOperation();break;case "export":a.exportOperation();break;case "merge":a.mergeOperation();break;case "delete":a.deleteOperation();break;case "exclude_from_list":a.excludeFromListOperation();break;case "assign_tags":a.assignTagsOperation();break;case "assign_responsible":a.assignResponsibleOperation();
break;case "remove_from_selected_list":a.removeFromSelectedListOperation()}})};CRMContactsOperations.prototype.showBar=function(){this.is_shown||(this.$bar.addClass("is-shown"),this.$list_header.removeClass("is-shown"),this.is_shown=!0)};CRMContactsOperations.prototype.hideBar=function(){this.is_shown&&(this.$bar.removeClass("is-shown"),this.$list_header.addClass("is-shown"),this.is_shown=!1)};CRMContactsOperations.prototype.updateBarCount=function(){this.$bar.find(".crm-count").text("("+this.checked_count+
")")};CRMContactsOperations.prototype.showOrHideBar=function(){0<this.checked_count?(this.showBar(),this.updateBarCount()):this.hideBar()};CRMContactsOperations.prototype.getSelectedContactList=function(){var a=sessionStorage.getItem("selected_contacts");return a?JSON.parse(a):null};CRMContactsOperations.prototype.setSelectedContacts=function(){this.getSelectedContactList()||sessionStorage.setItem("selected_contacts","[]");if(!(0<this.selected_page)){var a=this.getSelectedContactList(),b=this.getSelectedContactIds();
d.each(b,function(c,e){0>d.inArray(e,a)&&(a[a.length]=e)});sessionStorage.setItem("selected_contacts",JSON.stringify(a));this.showOrHideSelectedLink()}};CRMContactsOperations.prototype.delSelectedContact=function(a){var b=this.getSelectedContactList();a=b.indexOf(a);b.splice(a,1);sessionStorage.setItem("selected_contacts",JSON.stringify(b));this.showOrHideSelectedLink()};CRMContactsOperations.prototype.updateSelectedCount=function(){var a=this.getSelectedContactList().length;this.$selected_count.text(a)};
CRMContactsOperations.prototype.showOrHideSelectedLink=function(){this.updateSelectedCount();this.getSelectedContactList().length?this.showSelectedLink():this.hideSelectedLink()};CRMContactsOperations.prototype.showSelectedLink=function(){this.$selected_link.removeClass("js-selected-contacts-hidden")};CRMContactsOperations.prototype.hideSelectedLink=function(){this.$selected_link.addClass("js-selected-contacts-hidden")};CRMContactsOperations.prototype.getSelectedContactIds=function(){return this.$list.find(".c-checkbox :checkbox:checked").map(function(){return d(this).val()}).toArray()};
CRMContactsOperations.prototype.getTotalItemsAtPage=function(){return this.page*this.limit>this.total_count?this.total_count%this.limit:this.limit};CRMContactsOperations.prototype.formBar=function(){var a=this.$bar.find('.crm-operation-li[data-id="merge"]'),b=this.$bar.find('.crm-operation-li[data-id="delete"]'),c=this.$bar.find('.crm-operation-li[data-id="assign_responsible"]'),e=this.$bar.find('.crm-operation-li[data-id="exclude_from_list"]');1>=this.checked_count||this.checked_count>this.page_count?
a.hide():a.show();this.checked_count>this.page_count?b.hide():b.show();this.checked_count>this.page_count?c.hide():c.show();this.is_category_segment&&this.context.can_edit?e.show():e.hide()};CRMContactsOperations.prototype.initItemCheckbox=function(){function a(c){var e=c.find(".js-checkbox"),f=e.is(":checked");e=e.val();f?c.addClass("is-active"):c.removeClass("is-active");b.is_checked_all?(b.is_checked_all=!1,b.checked_count=b.$list.find(".c-checkbox :checkbox:checked").length):f?b.checked_count+=
1:--b.checked_count;b.formBar();b.showOrHideBar();b.showOrHideSelectedLink();0<b.selected_page||(f?b.setSelectedContacts():b.delSelectedContact(e))}var b=this;b.$list.on("change",".js-checkbox",function(c,e){c=d(this);var f=c.closest(".js-contact-wrapper");"undefined"!==typeof e&&c.attr("checked",e);a(f);0<b.checked_count?b.checked_count<b.limit&&b.checked_count!==b.total_items_at_page_count?b.$checkbox_all.prop("indeterminate",!0):b.$checkbox_all.prop("indeterminate",!1).prop("checked",!0):b.$checkbox_all.prop("indeterminate",
!1).prop("checked",!1)});b.$list.on("click",".js-contact-wrapper",function(c){var e=d(c.target);c=!(!e.is("a")&&!e.closest("a").length);e=e.is(":checkbox");c||(c=d(this),e||(c=c.find(".js-checkbox"),c.trigger("change",[!c.is(":checked")])))});b.$list.shiftSelectable({selector:".js-contact-wrapper",behavior_type:"thumbs"===b.view?"mixed":"vertical",onSelect:function(c,e){var f=d(e.target);f=!(!f.is("a")&&!f.closest("a").length);var g=e.extra.is_first;e=e.extra.is_last;f||g||e||(c.find(".js-checkbox").attr("checked",
!0),a(c))}})};CRMContactsOperations.prototype.removeFromSelectedListOperation=function(){var a=this,b=a.$list.find(".c-checkbox :checkbox:checked");d.each(b,function(){a.delSelectedContact(this.value);d(this).parents(".js-contact-wrapper").remove()});a.$checkbox_all.prop("checked",!1);a.checked_count=0;a.is_checked_all=!1;a.showOrHideBar();a.getSelectedContactList().length||(b=a.$wrapper.find(".js-header-table-wrapper"),a.$wrapper.find(".c-no-contacts").removeClass("hidden"),b.remove())};CRMContactsOperations.prototype.selectAll=
function(){this.$list.find(".c-checkbox :checkbox").prop("checked",!0).trigger("change",[!0]);this.checked_count=this.total_count;this.is_checked_all=!0;this.setSelectedContacts()};CRMContactsOperations.prototype.unselectAll=function(){this.$list.find(".c-checkbox :checkbox").prop("checked",!1).trigger("change",[!1]);this.$checkbox_all.prop("checked",!1);this.checked_count=0;this.is_checked_all=!1};CRMContactsOperations.prototype.getSelectedContext=function(){var a=d.extend({total_count:this.total_count,
page_count:this.page_count,checked_count:this.checked_count,is_checked_all:this.is_checked_all?1:0,contact_ids:null},this.context);a.is_checked_all||(a.contact_ids=this.getSelectedContactIds());return a};CRMContactsOperations.prototype.addToSegmentsOperation=function(){var a=this;d.get(d.crm.app_url+"?module=contactOperation&action=addToSegments",function(b){new CRMDialog({html:b,onOpen:function(c){new CRMContactsOperationAddToSegments({$wrapper:c,context:a.getSelectedContext(),sidebar:a.sidebar})}})})};
CRMContactsOperations.prototype.exportOperation=function(){var a=this,b=d.crm.app_url+"?module=contactOperation&action=export",c=a.getSelectedContext().checked_count;d.get(b,{checked_count:c},function(e){var f=null;new CRMDialog({html:e,esc:!1,onOpen:function(g){f=new CRMContactsOperationExport({$wrapper:g,context:a.getSelectedContext()})},onClose:function(){f&&f.cancel()}})})};CRMContactsOperations.prototype.mergeOperation=function(){if(!(1>=this.checked_count||this.checked_count>this.page_count)){var a=
this.getSelectedContactIds().join(",");d.crm.content.load(d.crm.app_url+"contact/merge/?ids="+a)}};CRMContactsOperations.prototype.deleteOperation=function(){if(!(this.checked_count>this.page_count)){var a=d.crm.app_url+"?module=contactOperation&action=delete",b=this.$wrapper,c=this.getSelectedContext();b=b.find(".crm-contact-operation-delete-checking").clone();new CRMDialog({html:b.show(),onOpen:function(e){var f=this;e.find(".crm-cancel").click(function(){f.close()});d.get(a,c,function(g){new CRMDialog({html:g,
onOpen:function(){f.close()}})})}})}};CRMContactsOperations.prototype.excludeFromListOperation=function(){var a=this;if(a.is_category_segment){var b=d.crm.app_url+"?module=contactOperation&action=excludeFromSegment",c=a.getSelectedContext();d.get(b,{id:a.context.info.id,checked_count:c.checked_count},function(e){new CRMDialog({html:e,onOpen:function(f){new CRMContactsOperationExcludeFromSegment({$wrapper:f,segment:a.context.info,context:a.getSelectedContext(),sidebar:a.sidebar})}})})}};CRMContactsOperations.prototype.assignTagsOperation=
function(){var a=d.crm.app_url+"?module=contactOperation&action=assignTags",b=d.extend({},this.getSelectedContext(),!0);b.is_checked_all||1!=b.checked_count||(a+="&is_assign=1");d.post(a,b,function(c){new CRMDialog({html:c})})};CRMContactsOperations.prototype.assignResponsibleOperation=function(){var a=d.crm.app_url+"?module=contactOperation&action=assignResponsible",b=d.extend({},this.getSelectedContext(),!0);d.post(a,b,function(c){new CRMDialog({html:c})})};CRMContactsOperations.prototype.initElasticHeader=
function(){function a(){if(d.contains(document,g[0])){var m=e.scrollTop()>k.top,n=c.$content.height()>e.height();m&&n?(g.addClass("is-fixed").css({left:k.left,width:l}),h=!0):(g.removeClass("is-fixed").removeAttr("style"),h=!1)}else e.off("scroll",a)}function b(){d.contains(document,g[0])?(l=f.outerWidth(),h&&g.width(l)):e.off("resize",b)}var c=this,e=d(window),f=c.$wrapper.find(".js-contacts-section"),g=c.$bar,k=f.offset(),l=g.outerWidth(),h=!1;e.on("scroll",a).on("resize",b)};return CRMContactsOperations}(jQuery);var CRMContactsOperationAddToSegments=function(d){CRMContactsOperationAddToSegments=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".js-save");this.$add_new_link=this.$wrapper.find(".crm-add-new-segment-link");this.context=a.context||{};this.dialog=this.$wrapper.data("dialog");this.url=d.crm.app_url+"?module=contactOperation&action=addToSegments";this.is_assign=a.is_assign?1:0;this.onSave=a.onSave||null;this.sidebar=a.sidebar||null;this.initClass()};CRMContactsOperationAddToSegments.prototype.initClass=
function(){this.is_assign||this.initButton();this.initSave();this.initAddNewLink()};CRMContactsOperationAddToSegments.prototype.initButton=function(){var a=this,b=function(){0<a.$wrapper.find('[name="segment[]"]:checked').length?a.$button.attr("disabled",!1):a.$button.attr("disabled",!0)};a.$wrapper.on("click",'[name="segment[]"]',b);b()};CRMContactsOperationAddToSegments.prototype.initSave=function(){var a=this,b=a.$button,c=a.$wrapper.find(".crm-loading"),e=d.crm.app_url+"?module=contactOperation&action=addToSegmentsProcess",
f=[],g=d.extend({},a.context,!0);g.is_assign=a.is_assign?1:0;var k=function(h){c.hide();b.attr("disabled",!1);a.sidebar&&d.each(h.segments||{},function(m,n){a.sidebar.updateItem({type:"segment",info:{id:n.id}},n)});g.is_assign?d.crm.content.reload():1==f.length?d.crm.content.load(d.crm.app_url+"contact/segment/"+f[0]+"/"):d.crm.content.load(d.crm.app_url)},l=function(h){h=d.extend({offset:h||0},g);d.post(e,h).done(function(m){"ok"==m.status&&(m.data.done?k(m.data):l(m.data.offset||0))})};b.click(function(h){h.preventDefault();
c.show();b.attr("disabled",!0);f=a.$wrapper.find('[name="segment[]"]:checked').map(function(){return d(this).val()}).toArray();g=d.extend({segment_ids:f},g);a.onSave&&!1===a.onSave(g,a.$wrapper)||l()})};CRMContactsOperationAddToSegments.prototype.reloadDialog=function(a){var b=this;d.get(b.url,function(c){b.dialog=d.waDialog({html:c,onOpen:function(e){a&&a(e);new CRMContactsOperationAddToSegments({$wrapper:e,context:b.context,sidebar:b.sidebar,onSave:b.onSave})}})})};CRMContactsOperationAddToSegments.prototype.initAddNewLink=
function(){var a=this;a.$add_new_link.click(function(b){b.preventDefault();a.$wrapper.find(".crm-add-new-segment-loading").show();d.get(d.crm.app_url+"?module=contactSegment&action=edit").done(function(c){a.dialog.close();var e=d.waDialog({html:c,onOpen:function(f){f.find(".js-close-dialog").hide();f.find(".crm-cancel-link").show().click(function(){f.find(".crm-cancel-loading").show();a.reloadDialog(function(){e.close()})})},options:{afterSave:function(f){a.reloadDialog(function(g){e.close();f.data.segment&&
g.find('input[name="segment[]"][value="'+f.data.segment.id+'"]').prop("checked",!0)});return!1}}})})})};return CRMContactsOperationAddToSegments}(jQuery);var CRMContactsOperationExcludeFromSegment=function(d){CRMContactsOperationExcludeFromSegment=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".js-save");this.$add_new_link=this.$wrapper.find(".crm-add-new-segment-link");this.context=a.context||{};this.segment=a.segment||{};this.dialog=this.$wrapper.data("dialog");this.sidebar=a.sidebar||null;this.initClass()};CRMContactsOperationExcludeFromSegment.prototype.initClass=function(){this.initStartExclude()};CRMContactsOperationExcludeFromSegment.prototype.initStartExclude=
function(){var a=this,b=a.$button,c=d.crm.app_url+"?module=contactOperation&action=excludeFromSegmentProcess",e=a.$wrapper.find(".crm-loading"),f=d.extend({},a.context);f.segment_id=a.segment.id;var g=function(k,l){k=d.extend({offset:k||0,process_count:l||0},f);d.post(c,k).done(function(h){"ok"==h.status&&(h.data.done?(h=h.data,e.hide(),b.attr("disabled",!1),a.segment=h.segment,a.sidebar.updateItem({type:"segment",info:{id:a.segment.id}},a.segment),a.dialog.close(),d.crm.content.load(d.crm.app_url+
"contact/segment/"+a.segment.id+"/")):g(h.data.offset,h.data.process_count))})};b.click(function(k){k.preventDefault();e.show();b.attr("disabled",!0);g()})};return CRMContactsOperationExcludeFromSegment}(jQuery);var CRMContactsOperationExport=function(d){CRMContactsOperationExport=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".js-save");this.$download_button=this.$wrapper.find(".js-download");this.$cancel=this.$wrapper.find(".crm-js-cancel");this.$download_file_form=this.$wrapper.find(".crm-download-file-form");this.context=a.context||{};this.url=d.crm.app_url+"?module=contactOperationExport&action=process";this.dialog=this.$wrapper.data("dialog");this.$dialog_parent=window.parent.$(".dialog");
this.$dialog_parent_close=this.$dialog_parent.find(".dialog-close");this.pid="";this.currentProcess=null;this.initClass()};CRMContactsOperationExport.prototype.initClass=function(){this.initStartExport()};CRMContactsOperationExport.prototype.initStartExport=function(){var a=this,b=a.$button;b.click(function(c){c.preventDefault();b.attr("disabled",!0);a.currentProcess=a.process()});a.$wrapper.on("click",".crm-js-cancel",function(c){c.preventDefault();a.currentProcess&&a.currentProcess.cancel();a.$dialog_parent_close[0].click()});
a.dialog&&(a.dialog.onCancel=function(){a.currentProcess&&a.currentProcess.cancel();a.dialog.close()})};CRMContactsOperationExport.prototype.cancel=function(){this.currentProcess&&this.currentProcess.cancel()};CRMContactsOperationExport.prototype.process=function(){var a=this,b=a.url,c=a.$wrapper,e=c.find(".js-export-contacts-progressbar").find(".js-export-contacts-progressbar-progress"),f=c.find(".progressbar-text"),g=null,k=null,l=!1,h=0,m=d.extend({},a.context,!0);m.separator=c.find("[name=separator]").val();
m.encoding=c.find("[name=encoding]").val();m.export_fields_name=c.find("[name=export_fields_name]").is(":checked")?1:0;m.not_export_empty_columns=c.find("[name=not_export_empty_columns]").is(":checked")?1:0;var n=function(q,r){0>=q?q=0:100<=q&&(q=100);r?(e.stop(),e.clearQueue(),e.animate({width:""+Math.round(q)+"%"},{duration:250,queue:!0})):e.css({width:""+Math.round(q)+"%"});100>q?f.text(Math.round(100*q/100)+"%"):(a.$wrapper.find(".crm-process-block .loader").html('<i class="icon fas fa-check yes"></i>'),
f.text("100%"),l=!0)},p=function(){a.$wrapper.find(".dialog-footer--visible").addClass("hidden");k&&clearTimeout(k);k=setTimeout(p,3200);!g||2<=h||(m.processId=g,d.post(b,m,function(q){h--;if(g&&q.ready){if(a.pid=g,a.pid){k&&clearTimeout(k);g=k=null;q=d.crm.app_url+"?module=contactOperationExport&action=process&processId="+a.pid;var r=a.$download_file_form.find('input[name="_csrf"]').val(),u=a.$download_file_form.find('input[name="file"]').val();d.post(q,{processId:a.pid,_csrf:r,file:u},function(v){v=
JSON.parse(v);a.$download_button.attr("href",d.crm.app_url+"?module=contactOperation&action=download&file="+v.file)});a.$wrapper.find(".dialog-footer--hidden").removeClass("hidden")}}else q.progress&&n(q.progress,!l)},"json"),h++)};a.$wrapper.find(".crm-start-block").hide();a.$wrapper.find(".crm-process-block").show();n(0,!1);d.post(b,m,function(q){q.processId||alert("Error processing request.");g=q.processId;p()},"json");return{cancel:function(){k&&clearTimeout(k);d.post(b,{processId:g,ready:1})}}};
return CRMContactsOperationExport}(jQuery);var CRMContactsOperationAssignTags=function(d){CRMContactsOperationAssignTags=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".js-save");this.$input=this.$wrapper.find(".crm-tags-input");this.context=a.context||{};this.dialog=this.$wrapper.data("dialog");this.default_text=this.$input.attr("placeholder");this.is_assign=a.is_assign||!1;this.initClass()};CRMContactsOperationAssignTags.prototype.initClass=function(){this.initTagsInput();this.initPopularTags();this.initSave()};CRMContactsOperationAssignTags.prototype.initTagsInput=
function(){var a=d.crm.app_url+"?module=contact&action=tags";this.$input.tagsInput({defaultText:this.default_text,width:this.$wrapper.find(".crm-dialog-content").width()-16,autocomplete_url:"",autocomplete:{html:!0,source:function(b,c){d.getJSON(a,{term:b.term},function(e){"ok"===e.status?c(e.data.tags||[]):c([])})}}})};CRMContactsOperationAssignTags.prototype.initPopularTags=function(){var a=this.$input;this.$wrapper.find(".crm-popular-tags").find(".crm-popular-tag-item-link").click(function(){var b=
d(this);b=d.trim(b.text());a.removeTag(b);a.addTag(b)})};CRMContactsOperationAssignTags.prototype.initSave=function(){var a=this,b=a.$button,c=a.$input,e=d.crm.app_url+"?module=contactOperation&action=assignTagsProcess",f=d.extend({},a.context,!0),g=a.$wrapper.find(".crm-loading");b.click(function(k){k.preventDefault();g.show();b.attr("disabled",!0);k=d("#"+c.attr("id")+"_tag");(k=d.trim(k.val()))&&k!==a.default_text&&c.addTag(k);f.tags=d.trim(c.val());f.is_assign=a.is_assign?1:0;var l=function(h){h=
d.extend({offset:h||0},f);d.post(e,h).done(function(m){"ok"==m.status&&(m.data.done?(g.hide(),b.attr("disabled",!1),d.crm.content.reload(),a.dialog.close()):l(m.data.offset||0))})};l()})};return CRMContactsOperationAssignTags}(jQuery);var CRMContactsOperationAssignResponsible=function(d){CRMContactsOperationAssignResponsible=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$responsibleList=this.$wrapper.find(".js-responsible-list");this.$submitButton=this.$wrapper.find(".js-save");this.$close_dialog=a.Close_dialog;this.$errorh1=a.Error_h1;this.dialog=this.$wrapper.data("dialog");this.responsible_template_html=a.responsible_template_html;this.initClass()};CRMContactsOperationAssignResponsible.prototype.initClass=
function(){var a=this;a.$wrapper.on("change","input",function(){a.toggleButton(!0)});a.initSubmit();a.initAutocomplete()};CRMContactsOperationAssignResponsible.prototype.initSubmit=function(){function a(){if(!e){e=!0;var f=d.crm.app_url+"?module=contactOperation&action=assignResponsibleProcess",g=b();if(!g)return e=!1;var k=d('<i class="icon16 loading" style="vertical-align: middle; margin: 0;"></i>');k.appendTo(c.$submitButton.parent());c.$submitButton.attr("disabled",!0);var l=d("#responsible_id").val(),
h=l?d.crm.app_url+"contact/responsible/"+l+"/":d.crm.app_url+"contact/";d.post(f,g,function(m){"ok"===m.data.result?d.crm.content.reload().then(function(){c.dialog.close();d.crm.content.load(h)}):"no_vault_access"===m.data.result&&(d(".crm-dialog-header h1").html(c.$errorh1),d(".crm-dialog-content p, .js-responsible-list").html(""),d(".crm-dialog-footer").html('<a class="button js-close-dialog" href="javascript:void(0);">'+c.$close_dialog+"</a>"),d(".no-access-error").html(m.data.message),d.each(m.data.users,
function(n,p){d(".no-access-users").append('<a href="'+p.id+'" style="display: block; margin-top: 10px;"><i class="icon16 userpic20" style="background-image: url('+p.photo+');"></i><span>'+p.name+"</span></a>")}))},"json").always(function(){c.$submitButton.attr("disabled",!1);c.toggleButton(!1);k.remove();e=!1})}}function b(){var f=d("#responsible_id").val();return{contact_ids:d("#contact_ids").val(),responsible_id:f}}var c=this,e=!1;c.$form.on("submit",function(f){f.preventDefault();a()})};CRMContactsOperationAssignResponsible.prototype.initAutocomplete=
function(){function a(e){e.addClass("highlighted");setTimeout(function(){e.removeClass("highlighted")},2E3)}var b=this,c=b.$responsibleList.find(".js-autocomplete");c.autocomplete({source:d.crm.app_url+"?module=autocomplete&type=user",appendTo:b.$wrapper,minLength:0,focus:function(){return!1},select:function(e,f){e=b.$responsibleList.find('.c-responsible[data-id="'+f.item.id+'"]');e=e.length?e:void 0;if(!e){f=f.item;e=b.responsible_template_html;e=e.replace(/%id%/,f.id);var g=e.replace;var k=f.name;
k=d("<div></div>").text(k).html();e=g.call(e,"%name%",k).replace("%photo_url%",f.photo_url);d("#responsible_id").val(f.id);f=d(e);b.$responsibleList.append(f);d(".js-input").css("display","none");b.$submitButton.attr("disabled",!1);b.toggleButton(!0);e=f}a(e);b.toggleButton(!0);c.val("");return!1}}).data("ui-autocomplete")._renderItem=function(e,f){return d('<li class="ui-menu-item-html"><div>'+f.value+"</div></li>").appendTo(e)};c.on("focus",function(){c.data("uiAutocomplete").search(c.val())});
b.$responsibleList.on("click",".js-delete-responsible",function(){d(this).closest(".c-responsible").remove();d("#responsible_id").val("");d(".js-input").css("display","");d(".js-autocomplete").focus();b.$submitButton.attr("disabled",!0);b.toggleButton(!0)})};CRMContactsOperationAssignResponsible.prototype.toggleButton=function(a){var b=this.$submitButton;a?b.removeClass("green").addClass("yellow"):b.removeClass("yellow").addClass("green")};return CRMContactsOperationAssignResponsible}(jQuery);var CRMContactsOperationDelete=function(d){CRMContactsOperationDelete=function(a){this.$wrapper=a.$wrapper;this.$button=this.$wrapper.find(".crm-delete");this.context=a.context||{};this.dialog=this.$wrapper.data("dialog");this.is_contact_page=a.is_contact_page||0;this.initClass()};CRMContactsOperationDelete.prototype.initClass=function(){this.initStartDelete()};CRMContactsOperationDelete.prototype.initStartDelete=function(){var a=this,b=a.$button,c=d(".crm-loading",a.$wrapper),e=d.crm.app_url+"?module=contactOperation&action=deleteProcess",
f=d.extend({},a.context,!0);b.click(function(g){g.preventDefault();c.show();b.attr("disabled",!0);d.post(e,f).done(function(k){a.dialog.close();"ok"===k.status&&(a.is_contact_page?d.crm.content.load(d.crm.app_url+"contact/"):d.crm.content.reload(),d.crm.sidebar.reload())}).always(function(){c.hide();b.attr("disabled",!1)})})};return CRMContactsOperationDelete}(jQuery);var CRMContactSegmentEdit=function(d){CRMContactSegmentEdit=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$button=this.$form.find(":submit");this.$icons_block=this.$wrapper.find(".crm-icons-block");this.$icon_input=this.$wrapper.find("[name=icon]");this.segment=a.segment||{};this.messages=a.messages||{};this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMContactSegmentEdit.prototype.initClass=function(){this.$wrapper.find(".crm-name-input").focus();this.initIcons();
this.initSubmit();this.bindEvents();0<this.segment.id&&this.initDeleteLink()};CRMContactSegmentEdit.prototype.initIcons=function(){var a=this;a.$icons_block.on("click","li a",function(b){b.preventDefault();b=d(this).closest("li");var c=b.data("icon");a.$icons_block.find("li.selected").removeClass("selected");a.$icon_input.val(c);b.addClass("selected");a.clearValidateErrors()})};CRMContactSegmentEdit.prototype.bindEvents=function(){var a=this,b=a.$form,c=null;b.on("change",":input",function(){a.clearValidateErrors()});
b.on("keyup",":input",function(){c&&clearTimeout(c);c=setTimeout(function(){a.clearValidateErrors()},200)})};CRMContactSegmentEdit.prototype.showValidateErrors=function(a){var b=this.$form;d.each(a||{},function(c,e){b.find(':input[name="'+c+'"]').addClass("state-error").after('<span class="errormsg">'+e+"</span>")})};CRMContactSegmentEdit.prototype.clearValidateErrors=function(){var a=this.$form;a.find(".state-error").removeClass("state-error");a.find(".errormsg").remove()};CRMContactSegmentEdit.prototype.initSubmit=
function(){var a=this,b=a.$form,c=b.find(".crm-loading"),e=a.$button;b.submit(function(f){f.preventDefault();a.clearValidateErrors();e.attr("disabled",!0);c.show();d.post(b.attr("action"),b.serialize()).done(function(g){if("ok"!==g.status)e.attr("disabled",!1),c.hide(),a.showValidateErrors(g.errors||{});else if(!a.dialog.options.afterSave||!1!==a.dialog.options.afterSave(g))a:if(g.data.segment){var k="search"==a.segment.type,l="category"===g.data.segment.type?"category":"search",h=g.data.segment.id;
if(0>=a.segment.id){if("search"===l&&!k){d.crm.content.load(d.crm.app_url+"contact/search/segment/"+g.data.segment.id+"/");break a}d.crm.storage.set("crm/create/category",{id:h,timestamp:+new Date})}d.crm.content.load(d.crm.app_url+"contact/segment/"+g.data.segment.id+"/")}})})};CRMContactSegmentEdit.prototype.initDeleteLink=function(){var a=this,b=a.$wrapper.find(".crm-delete-link"),c=null,e=d.crm.app_url+"?module=dialogConfirm",f=null,g=d.crm.app_url+"?module=contactSegment&action=delete";b.click(function(k){k.preventDefault();
c&&c.abort();c=d.post(e,{title:a.messages.delete_confirm_title,text:a.messages.delete_confirm_text,ok_button:a.messages.delete_button}).done(function(l){a.dialog.close();new CRMDialog({html:l,onConfirm:function(){f&&f.abort();f=d.post(g,{id:a.segment.id}).done(function(h){"ok"===h.status&&d.crm.content.load(d.crm.app_url+"contact/")}).always(function(){f=null});return!1}})}).always(function(){c=null})})};return CRMContactSegmentEdit}(jQuery);var CRMContactSegmentAddContacts=function(d){CRMContactSegmentAddContacts=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$button=this.$form.find(".js-submit-button");this.$find_contact=this.$wrapper.find(".js-find-contact");this.$contact_list=this.$wrapper.find(".c-contact-list");this.segment=a.segment||{};this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMContactSegmentAddContacts.prototype.initClass=function(){this.initAutocomplete();this.initDeleteLinks();
this.initSubmit()};CRMContactSegmentAddContacts.prototype.initAutocomplete=function(){var a=this.$find_contact,b=this.$contact_list,c=b.find(".is-template");a.focus();a.autocomplete({source:"?module=autocomplete",minLength:2,focus:function(){return!1},select:function(e,f){e=c.clone().removeClass("is-template");e.find(".c-contact-id").val(f.item.id);e.find(".c-contact-name").text(f.item.name);e.find(".c-contact-icon").css("backgroundImage","url("+f.item.photo_url+")");b.append(e.show());a.val("");
return!1}}).data("ui-autocomplete")._renderItem=function(e,f){return d("<li />").addClass("ui-menu-item-html").append("<div>"+f.value+"</div>").appendTo(e)}};CRMContactSegmentAddContacts.prototype.initDeleteLinks=function(){this.$wrapper.on("click",".c-contact-delete-link",function(a){a.preventDefault();d(this).closest(".c-contact-item").remove()})};CRMContactSegmentAddContacts.prototype.initSubmit=function(){var a=this,b=a.$form,c=a.$button,e=b.find(".c-loading");b.submit(function(f){f.preventDefault();
e.show();c.prop("disabled",!0);d.post(b.attr("action"),b.serialize()).done(function(g){"ok"==g.status&&d.crm.content.load(d.crm.app_url+"contact/segment/"+a.segment.id+"/")}).always(function(){e.hide();c.prop("disabled",!1);a.dialog.close()})})};return CRMContactSegmentAddContacts}(jQuery);var CRMContactEditForm=function(d){CRMContactEditForm=function(a){this.$wrapper=a.$wrapper;this.$phoneList=this.$wrapper.find(".js-phone-list");this.$emailList=this.$wrapper.find(".js-email-list");this.phone_template_html=a.phone_template_html;this.email_template_html=a.email_template_html;this.initClass()};CRMContactEditForm.prototype.initClass=function(){this.initAddPhone();this.initAddEmail();this.initCompanyAutocomplete()};CRMContactEditForm.prototype.initAddPhone=function(){function a(e,f){e.preventDefault();
e=d(b.phone_template_html);f&&(e.find(".js-value").val(f.number).trigger("change"),e.find(".js-ext").val(f.ext).trigger("change"));c.append(e)}var b=this,c=b.$phoneList;b.$wrapper.on("click",".js-add-phone",a);b.$wrapper.on("click",".js-remove-phone",function(e){e.preventDefault();d(this).closest("li").remove()});d(document).on("addContactPhone",function(e,f){a(e,f)})};CRMContactEditForm.prototype.initAddEmail=function(){function a(e,f){e.preventDefault();e=d(b.email_template_html);f&&(e.find(".js-value").val(f.name).trigger("change"),
e.find(".js-ext").val(f.ext).trigger("change"));c.append(e)}var b=this,c=b.$emailList;b.$wrapper.on("click",".js-add-email",a);b.$wrapper.on("click",".js-remove-email",function(e){e.preventDefault();d(this).closest("li").remove()});d(document).on("addContactEmail",function(e,f){a(e,f)})};CRMContactEditForm.prototype.initCompanyAutocomplete=function(){var a=this.$wrapper.find('[name="contact[company]"]'),b=this.$wrapper.find('[name="contact[company_contact_id]"]');a.length&&(a.autocomplete({appendTo:this.$wrapper,
source:"?module=autocomplete&type=company",minLength:2,focus:function(){return!1},select:function(c,e){c=d("<div />").text(e.item.name).text();a.val(c);b.val(0<e.item.id?e.item.id:"");return!1},search:function(){b.val("")}}).data("ui-autocomplete")._renderItem=function(c,e){return d("<li />").addClass("ui-menu-item-html").append("<div>"+e.value+"</div>").appendTo(c)})};return CRMContactEditForm}(jQuery),CRMContactAddDialog=function(d){CRMContactAddDialog=function(a){this.$wrapper=a.$wrapper;this.contact_id=
a.contact_id;this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMContactAddDialog.prototype.initClass=function(){this.$wrapper.find(".js-focus-field").focus();this.initToggle();this.initContactForm();this.initCompanyForm()};CRMContactAddDialog.prototype.initToggle=function(){var a=this,b=a.$wrapper.find(".js-content-toggle-wrapper"),c=b.find(".js-ibutton"),e=a.$wrapper.find(".js-toggle-content.is-selected");c.iButton({labelOn:"",labelOff:"",classContainer:"c-ibutton ibutton-container mini"});
c.on("change",function(){var f="checked"===c.attr("checked"),g=a.$wrapper.find('.js-toggle-content[data-content="'+(f?"company":"contact")+'"]');f?b.addClass("is-on"):b.removeClass("is-on");e.length&&e.removeClass("is-selected");g.length&&(e=g.addClass("is-selected"));a.$wrapper.find(".js-focus-field").focus();a.dialog.resize()})};CRMContactAddDialog.prototype.initContactForm=function(){function a(){var f=c.find(".js-phone-list"),g=c.find(".js-email-list");f.find("li .js-value, li .js-ext").removeAttr("name");
g.find("li .js-value, li .js-ext").removeAttr("name");var k=e.serializeArray(),l={data:[],errors:[]},h=["contact[firstname]","contact[middlename]","contact[lastname]","contact[name]"],m=!0;d.each(k,function(n,p){l.data.push({name:p.name,value:p.value});0<d.trim(p.value).length&&0<=h.indexOf(p.name)&&(m=!1)});m&&(l.errors.push({name:"contact[firstname]",value:"Name is empty"}),l.errors.push({name:"contact[name]",value:"Name is empty"}));f.find("li").each(function(n){var p=d(this),q=p.find(".js-value");
p=p.find(".js-ext");var r=q.val(),u=p.val();if(r){var v="contact[phone]["+n+"][value]";q.attr("name",v);l.data.push({name:v,value:r});n="contact[phone]["+n+"][ext]";p.attr("name",n);l.data.push({name:n,value:u})}});g.find("li").each(function(n){var p=d(this),q=p.find(".js-value");p=p.find(".js-ext");var r=q.val(),u=p.val();if(r){var v="contact[email]["+n+"][value]";q.attr("name",v);l.data.push({name:v,value:r});n="contact[email]["+n+"][ext]";p.attr("name",n);l.data.push({name:n,value:u})}});return l}
var b=this,c=b.$wrapper.find('.js-toggle-content[data-content="contact"]'),e=c.find("form");(function(){function f(h){d.post(b.contact_id?"?module=deal&action=contactUpdate":"?module=contact&action=save",h,function(m){"ok"==m.status?(b.dialog.close(),d.crm.content.load(d.crm.app_url+"contact/"+m.data.contact.id+"/")):m.errors&&g(m.errors)},"json").always(function(){l=!1})}function g(h){h=h?h:[];d.each(h,function(m,n){m=n.name;n=n.value;"name"===m&&(m="contact[firstname]");var p=e.find('[name="'+m+
'"]'),q=d("<span />").addClass("errormsg").text(n);p.length?p.hasClass("error")||(p.parent().append(q),p.addClass("error").one("focus click",function(){p.removeClass("error");q.remove()})):(k.append(q),e.one("submit",function(){q.remove()}))})}var k=b.$wrapper.find(".js-errors-place"),l=!1;e.on("submit",function(h){h.preventDefault();l||(l=!0,h=a(),h.errors.length?(g(h.errors),l=!1):f(h.data))})})();(function(){c.on("click",".js-extended-form",function(){var f=a(),g=[];g.push("extended=true");d.each(f.data,
function(k,l){(k=d.trim(l.value))&&g.push(l.name+"="+k)});f=d.crm.app_url+"contact/new/?"+g.join("&");d.crm.content.load(f)})})();a()};CRMContactAddDialog.prototype.initCompanyForm=function(){function a(){var f=c.find(".js-phone-list"),g=c.find(".js-email-list");f.find("li .js-value, li .js-ext").removeAttr("name");g.find("li .js-value, li .js-ext").removeAttr("name");var k=e.serializeArray(),l={data:[],errors:[]},h=["contact[firstname]","contact[middlename]","contact[lastname]","contact[name]"],
m=!0;d.each(k,function(n,p){l.data.push({name:p.name,value:p.value});0<d.trim(p.value).length&&0<=h.indexOf(p.name)&&(m=!1)});m&&(l.errors.push({name:"contact[firstname]",value:"Name is empty"}),l.errors.push({name:"contact[name]",value:"Name is empty"}));f.find("li").each(function(n){var p=d(this),q=p.find(".js-value");p=p.find(".js-ext");var r=q.val(),u=p.val();if(r){var v="contact[phone]["+n+"][value]";q.attr("name",v);l.data.push({name:v,value:r});n="contact[phone]["+n+"][ext]";p.attr("name",
n);l.data.push({name:n,value:u})}});g.find("li").each(function(n){var p=d(this),q=p.find(".js-value");p=p.find(".js-ext");var r=q.val(),u=p.val();if(r){var v="contact[email]["+n+"][value]";q.attr("name",v);l.data.push({name:v,value:r});n="contact[email]["+n+"][ext]";p.attr("name",n);l.data.push({name:n,value:u})}});return l}var b=this,c=b.$wrapper.find('.js-toggle-content[data-content="company"]'),e=c.find("form");(function(){function f(){var m={data:[],errors:[]},n=e.serializeArray();d.each(n,function(p,
q){q.value=d.trim(q.value);"contact[company]"===q.name&&m.data.push({name:"contact[name]",value:q.value});m.data.push(q)});n=c.find(".js-phone-list");n.find("li .js-value, li .js-ext").removeAttr("name");n.find("li").each(function(p){var q=d(this),r=q.find(".js-value");q=q.find(".js-ext");var u=r.val(),v=q.val();if(u){var t="contact[phone]["+p+"][value]";r.attr("name",t);m.data.push({name:t,value:u});p="contact[phone]["+p+"][ext]";q.attr("name",p);m.data.push({name:p,value:v})}});n=c.find(".js-email-list");
n.find("li .js-value, li .js-ext").removeAttr("name");n.find("li").each(function(p){var q=d(this),r=q.find(".js-value");q=q.find(".js-ext");var u=r.val(),v=q.val();if(u){var t="contact[email]["+p+"][value]";r.attr("name",t);m.data.push({name:t,value:u});p="contact[email]["+p+"][ext]";q.attr("name",p);m.data.push({name:p,value:v})}});m.data.push({name:"contact[is_company]",value:1});return m}function g(m){m=m?m:[];d.each(m,function(n,p){n=p.name;p=p.value;var q=c.find('[name="'+n+'"]');"contact[firstname]"!==
n||q.is(":visible")||(q=c.find(".js-contact-autocomplete"));var r=d("<span class='c-error' />").addClass("errormsg").text(p);q.length&&!q.hasClass("error")?(q.parent().append(r),q.addClass("error").one("focus click change",function(){q.removeClass("error");r.remove()})):(h.append(r),e.one("submit",function(){remove(r)}))})}function k(m){l||(l=!0,d.post(b.contact_id?"?module=deal&action=contactUpdate":"?module=contact&action=save",m,function(n){"ok"===n.status?(b.dialog.close(),d.crm.content.load(d.crm.app_url+
"contact/"+n.data.contact.id+"/")):n.errors&&g(n.errors)},"json").always(function(){l=!1}))}var l=!1,h=c.find(".js-errors-place");e.on("submit",function(m){m.preventDefault();m=f();m.errors.length?g(errors):k(m.data)})})();(function(){c.on("click",".js-extended-form",function(){var f=a(),g=[];g.push("extended=true");g.push("type=company");d.each(f.data,function(k,l){(k=d.trim(l.value))&&g.push(l.name+"="+k)});f=d.crm.app_url+"contact/new/?"+g.join("&");d.crm.content.load(f)})})()};return CRMContactAddDialog}(jQuery),
CRMDealParticipantAdd=function(d){CRMDealParticipantAdd=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$content=this.$wrapper.find(".crm-dialog-content");this.dialog=this.$wrapper.data("dialog");this.deal_id=a.deal_id;this.initClass()};CRMDealParticipantAdd.prototype.initClass=function(){var a=this.$wrapper.find(".js-contact-autocomplete");a.length&&a.focus();this.initAddParticipant()};CRMDealParticipantAdd.prototype.initAddParticipant=function(){function a(f){function g(l){var h=
d('<div class="line errormsg" />').html(l);c.$content.append(h);c.$form.one("submit",function(){h.remove()})}if(f[0])d.each(f,function(l,h){g(h.value)});else{var k=Object.keys(f);d.each(k,function(l,h){g(f[h])})}}function b(f){e||(e=!0,d.post("?module=deal&action=addParticipantSave",f,function(g){"ok"==g.status?(c.dialog.options.onAdd(g.data.html),c.dialog.close()):g.errors&&a(g.errors)}).always(function(){e=!1}))}var c=this,e=!1;c.$form.on("submit",function(f){f.preventDefault();f=c.$form.serializeArray();
var g=[];g.length?a(g):b(f)})};return CRMDealParticipantAdd}(jQuery),CRMContactAddForm=function(d){CRMContactAddForm=function(a){this.$wrapper=a.$wrapper;this.$locales=a.locales;this.$toggleW=this.$wrapper.find(".js-contact-view-toggle");this.initClass()};CRMContactAddForm.prototype.initClass=function(){this.initToggle();this.initContactAutocomplete();this.initCompanyAutocomplete()};CRMContactAddForm.prototype.initContactAutocomplete=function(){function a(m){if(0<m.id)e.val(m.name),e.data("photo_url",
m.photo_url),e.data("is_company",m.data.is_company),g.val(m.id),b(m.data);else if(0>m.id){g.val("");c.$toggleW.find(".js-show-fio").trigger("click",!0);f.val("");var n=0<=m.name.indexOf("@"),p=!!m.name.match(/^\+?\d/);n?c.$wrapper.find(".js-email-field").val(m.name).trigger("change"):p?c.$wrapper.find(".js-phone-field").val(m.name).trigger("change"):c.$wrapper.find(".js-firstname,.js-name").val(m.name).trigger("change")}}function b(m){d.each(k,function(n,p){n=m[p];var q="phone"===p||"email"===p,r;
if(q){n="";for(r=(m[p]||[]).reverse();""==n&&0<r.length;)n=r.pop();d.isPlainObject(n)&&(n=n.value)}n=d.trim(n||"");""!=n&&(p=q?c.$wrapper.find('[name="contact['+p+'][0][value]"]'):c.$wrapper.find('[name="contact['+p+']"]'),p.val(n))});f.attr("disabled",!0)}var c=this,e=c.$wrapper.find(".js-contact-autocomplete"),f=c.$wrapper.find(".js-field"),g=c.$wrapper.find(".js-contact-id-field"),k=["firstname","company","jobtitle","phone","email"],l="?module=autocomplete&add_new=true&join="+k.join(","),h=!1;
e.autocomplete({appendTo:e.closest(".value"),source:l,minLength:2,html:!0,focus:function(){return!1},select:function(m,n){h=!0;a(n.item);e.blur();return!1},search:function(){g.val("")},open:function(){h=!1},change:function(){h||a({id:-1,name:e.val()})}}).data("ui-autocomplete")._renderItem=function(m,n){return d("<li />").addClass("ui-menu-item-html").append("<div>"+n.value+"</div>").appendTo(m)};e.on("keydown",function(m){13!==m.keyCode&&(f.attr("disabled",!1),f.val(""))})};CRMContactAddForm.prototype.initCompanyAutocomplete=
function(){var a=this.$wrapper.find(".js-company-autocomplete"),b=this.$wrapper.find(".js-company-id-field");if(!a.length||!b.length)return!1;a.autocomplete({appendTo:this.$wrapper,source:"?module=autocomplete&type=company",minLength:2,html:!0,focus:function(){return!1},select:function(c,e){a.val(e.item.name);b.val(e.item.id);return!1},search:function(){b.val("")}}).data("ui-autocomplete")._renderItem=function(c,e){return d("<li />").addClass("ui-menu-item-html").append("<div>"+e.value+"</div>").appendTo(c)}};
CRMContactAddForm.prototype.initToggle=function(){function a(h,m){m&&b.$wrapper.find("input").val("").trigger("change");"fio"===h?(k.show(),l.hide(),e.val("new"),f.val(b.$locales.add),g.attr("disabled",!1)):(k.hide(),l.show(),e.val("search"),f.val(b.$locales.select));d(document).trigger("toggleChanged");d(document).trigger("resizeDialog")}var b=this,c=b.$toggleW;c.find(".is-active");var e=b.$wrapper.find(".js-action-field"),f=b.$wrapper.closest(".dialog-body").find(".js-some-action"),g=b.$wrapper.find(".js-field"),
k=b.$wrapper.find(".js-fio"),l=b.$wrapper.find(".js-combo-name");c.waSwitch({ready:function(h){let m=h.$wrapper.siblings("label");h.$label=m;h.active_text=m.data("active-text");h.inactive_text=m.data("inactive-text")},change:function(h,m){h?(a("fio",!1),m.$label.text(m.active_text)):(a("name",!1),m.$label.text(m.inactive_text))}})};return CRMContactAddForm}(jQuery),CRMCompanyAddForm=function(d){CRMCompanyAddForm=function(a){this.$wrapper=a.$wrapper;this.phone_template_html=a.phone_template_html;this.email_template_html=
a.email_template_html;this.initClass()};CRMCompanyAddForm.prototype.initClass=function(){this.initAddPhone();this.initAddEmail()};CRMCompanyAddForm.prototype.initAddPhone=function(){var a=this,b=a.$wrapper.find(".js-phone-list");a.$wrapper.on("click",".js-add-phone",function(c){c.preventDefault();c=d(a.phone_template_html);b.append(c)});a.$wrapper.on("click",".js-remove-phone",function(c){c.preventDefault();d(this).closest("li").remove()})};CRMCompanyAddForm.prototype.initAddEmail=function(){function a(e,
f){e.preventDefault();e=d(b.email_template_html);f&&(e.find(".js-value").val(f.name).trigger("change"),e.find(".js-ext").val(f.ext).trigger("change"));c.append(e)}var b=this,c=b.$wrapper.find(".js-email-list");b.$wrapper.on("click",".js-add-email",a);b.$wrapper.on("click",".js-remove-email",function(e){e.preventDefault();d(this).closest("li").remove()});d(document).on("addContactEmail",function(e,f){a(e,f)})};return CRMCompanyAddForm}(jQuery);var CRMContactImportPage=function(d){CRMContactImportPage=function(a){this.$wrapper=a.$wrapper;this.$iframe=this.$wrapper.find("iframe");this.initClass()};CRMContactImportPage.prototype.initClass=function(){this.initViewToggle();this.initSubmit()};CRMContactImportPage.prototype.initSubmit=function(){function a(f){f.on("change keydown","input, select, textarea",function(){f.find("input:submit").attr("disabled",!1)});f.on("submit",function(){f.find(".loading").show();e=!0})}var b=this,c=b.$iframe,e=
!1;b.$wrapper.find("form").each(function(){a(d(this))});c.on("load",function(){if(!e)return!1;var f=d(this).contents().find("body").html(),g=null;try{g=JSON.parse(f)}catch(k){}g&&g.errors?(b.$wrapper.find(".loading").hide(),alert(g.errors)):d.crm.content.load(d.crm.app_url+"contact/import/upload/")})};CRMContactImportPage.prototype.initViewToggle=function(){var a=this,b=a.$wrapper.find(".js-view-toggle"),c=b.find(".selected").data("content");b.on("click",".c-toggle",function(e){e.preventDefault();
var f=d(this).data("content"),g=f===c;console.log(e.target);if(g)return!1;c=f;a.$wrapper.find(".js-toggle-content.is-active").removeClass("is-active");e=a.$wrapper.find('.js-toggle-content[data-content="'+f+'"]');e.length&&e.addClass("is-active")})};return CRMContactImportPage}(jQuery);var crmContactImportUpload=function(d){var a=function(c){var e=c.$wrapper,f=e.find("form"),g=e.find(".crm-import-upload-table"),k=e.find(".crm-import-upload-button"),l=e.find(".crm-total-count-column .crm-count");this.$wrapper=e;this.$form=f;var h=c.fieldInfo,m=/[\s~!@#\$%\^&\*\(\)_\+\|\\=\-`\{\}:"<>\?\[\];',\.\/]+/g,n=function(u,v){u+=1;v?(g.find("td:nth-child("+u+")").addClass("crm-highlight-cell"),k.attr("disabled",!1)):g.find("td:nth-child("+u+")").removeClass("crm-highlight-cell")};d("select",
g).each(function(u){d(this).change(function(){n(u,d(this).val())})});var p=function(){d(this).is(":checked")?(g.find("tbody tr:first").removeClass("crm-ignored-row"),l.html((parseInt(l.html(),10)||0)+1)):(g.find("tbody tr:first").addClass("crm-ignored-row"),l.html(parseInt(l.html(),10)-1||""))};d("input[name='first_line']",f).change(p);var q=!1,r=g.find("select");g.find("tbody tr:first-child td").each(function(u,v){var t=null,w=0,x=!1;v=d(v).text().toLowerCase().replace(m,"");for(var y in h){var z=
h[y],B=!1,C=0,A=!1;y.length>w&&!x&&0==v.indexOf(y)&&(C=y.length,B=!0);var D=z.name.toLowerCase().replace(m,"");D&&D.length>w&&0==v.indexOf(D)&&(C=D.length,A=B=!0);if(B){D=B=null;if(z.fields){for(var E in z.fields){if(0<=v.indexOf(E)){B=E;C+=E.length;break}if(0<=v.indexOf(z.fields[E].name.toLowerCase().replace(m,""))){B=E;C+=z.fields[E].name.length;break}}if(!B)continue}if(z.ext)for(var F in z.ext){if(0<=v.indexOf(F)){D=F;break}if(0<=v.indexOf(z.ext[F].toLowerCase().replace(m,""))){D=F;break}}t=y+
(B?":"+B:"")+(D?"."+D:"");w=C;x=A}}t&&w&&(r.eq(u).val(t),n(u,!0),q=!0)});q&&p.call(f.find("input[name='first_line']").attr("checked",!1));this.initCreateDealsSettings();this.initAddToSegments();f.submit(function(u){u.preventDefault();u=e.find(".crm-warning-require-primary-fields").hide();var v=!1;g.find("select").each(function(){var t=d(this).val();if("firstname"==t||"lastname"==t||"company"==t||"email"==t.substr(0,5))return v=!0,!1});v?(e.find(".crm-loading").show(),(new b({$wrapper:e,need_validation:f.find("[name=validate]").is(":checked"),
messages:c.messages||{}})).run()):u.show()})};a.prototype.initCreateDealsSettings=function(){var c=this.$form,e=c.find('[name="create_deals"]'),f=c.find(".crm-deals-settings-wrapper"),g=c.find('[name="deal_funnel_id"]'),k=c.find('[name="deal_stage_id"]');e.click(function(){d(this).is(":checked")?f.show():f.hide()});g.change(function(){k.load("?module=contactImportUpload&action=stagesByFunnel&id="+d(this).val())})};a.prototype.initAddToSegments=function(){var c=this.$form;c.find('[name="add_to_segments"]').click(function(){d(this).is(":checked")?
d.get(d.crm.app_url+"?module=contactOperation&action=AddToSegments",function(e){d.waDialog({html:e,onOpen:function(f){new CRMContactsOperationAddToSegments({$wrapper:f,onSave:function(g,k){var l=k.data("dialog"),h=[],m=[];k=d(".c-segment-item",k);for(var n=0;n<g.segment_ids.length;n+=1){var p=g.segment_ids[n],q=k.filter('[data-id="'+p+'"]');h.push(q.find(".c-name").text());m.push('<input type="hidden" name="segment_id[]" value="'+p+'">')}h="<span>"+h.join(",")+"</span>";m=m.join(" ");d(".c-add-to-segments-names",
c).html(h+m);l.close();return!1}})}})}):d(".c-add-to-segments-names",c).html("")})};var b=function(c){this.$wrapper=c.$wrapper;this.$form=this.$wrapper.find("form");this.processId=null;this.requests=0;this.$loading=this.$wrapper.find(".crm-loading");this.timer=null;this.messages=c.messages||{};this.url=d.crm.app_url+"?module=contact&action=importProcess"+(c.need_validation?"&need_validation=1":"");this.$progress_bar_dialog=this.$wrapper.find(".crm-import-progressbar-dialog");this.$progress_bar=this.$progress_bar_dialog.find(".crm-progressbar")};
b.prototype.run=function(){var c=this,e=function(){c.timer&&clearTimeout(c.timer);c.timer=setTimeout(e,3E3+400*(Math.random()-.5));!c.processId||2<=c.requests||(d.get(c.url,{processid:c.processId,t:Math.random()},function(f){c.requests--;var g=c.$progress_bar.find(".ui-progressbar-value");g.stop();g.clearQueue();c.processId&&f.ready?c.processId&&(c.timer&&clearTimeout(c.timer),c.timer=null,g.animate({width:"100%"},{duration:500,complete:function(){d.post(c.url,{processid:c.processId,file:1},"json");
let k="";k=0<f.rowsRejected?0>=f.rowsAdded?c.messages.no_imported:c.messages.some_imported:c.messages.all_imported;d.waDialog.alert({text:k,button_title:c.messages.button,button_class:"gray",onClose:function(){location.href=0<f.rowsAdded?d.crm.app_url+"contact/import/result/"+f.timeStart+"/":d.crm.app_url+"contact/import/"}})},queue:!1})):g.animate({width:""+Math.round(100*f.done/f.total)+"%"},{duration:500,queue:!1})},"json"),c.requests++)};d.post(c.url,c.$form.serializeArray(),function(f){c.processId=
f.processId;c.processId&&(c.$progress_bar_dialog.show(),c.$progress_bar.progressbar({value:0}),e())},"json")};return a}(jQuery);var CRMContactsMergePage=function(d){CRMContactsMergePage=function(a){this.$wrapper=a.$wrapper;this.$table=this.$wrapper.find(".js-duplicates-table");this.$form=this.$wrapper.find("form");this.$merge_field=this.$wrapper.find(".crm-search-duplicates-by-field");this.$auto_merge_link=this.$wrapper.find(".crm-auto-merge-duplicates-link");this.$auto_merge_start_button=this.$wrapper.find(".crm-auto-merge-duplicates-start");this.$auto_merge_pause_button=this.$wrapper.find(".crm-auto-merge-duplicates-break");
this.$auto_merge_resume_button=this.$wrapper.find(".crm-auto-merge-duplicates-resume");this.is_admin=a.is_admin;this.groups_count=a.groups_count;this.messages=a.messages;this.initClass()};CRMContactsMergePage.prototype.initClass=function(){this.initSubmit();this.initAutoMerge();this.initGroupMergeLinks()};CRMContactsMergePage.prototype.initSubmit=function(){var a=this;a.$form.on("submit",function(b){b.preventDefault();d(this).find(".js-icon").remove().end().find(".js-loading").show();b=a.$merge_field.val();
location.href=d.crm.app_url+"?module=contactMergeDuplicates&field="+b+(d.crm.iframe?"&iframe=1":"")})};CRMContactsMergePage.prototype.initAutoMerge=function(){var a=this,b=a.$wrapper,c=a.$merge_field,e=a.$wrapper.find(".crm-auto-merge-duplicates-start-text"),f=a.$wrapper.find(".crm-auto-merge-duplicates-progress"),g=a.$table,k=a.$auto_merge_start_button,l=a.$auto_merge_pause_button,h=a.$auto_merge_resume_button,m=null,n=!1;a.$auto_merge_link.on("click",function(r){r.preventDefault();e.toggle();k.toggle()});
var p=function(r,u){var v=a.messages.progress,t=Math.round(1E3*parseFloat(r/u))/10;r=v.replace(":percentage:",t||0).replace(":count:",r).replace(":total_count:",u);f.find(".crm-text").text(r)},q=function(){var r=c.val(),u=0,v=a.groups_count;l.show();k.hide();h.hide();f.show();b.find(".pager").hide();var t=function(){var C=b.find(".crm-merge.crm-js-partial").length;d.get(d.crm.app_url+"?module=contact&action=mergeDuplicates",{offset:C,field:r,no_js:1}).done(function(A){if(A){A=d("<div>").html(A);var D=
A.find(".crm-duplicates-table tbody").find(".crm-mergeduplicates-row");D.length?(g.find("tbody").append(D),z()):B();A.remove()}else B()})},w=function(C){var A=d.crm.app_url+"?module=contact&action=mergeDuplicatesGetContacts";C.attr("data-field-value");d.get(A,{field:r,value:C.attr("data-field-value"),master_slaves:1},function(D){D&&"ok"===D.status&&!d.isEmptyObject(D.data)?x(C,D.data):(C.addClass("crm-finished"),m.resolve())},"json").fail(function(){m.resolve()})},x=function(C,A){crmContactMerger.merge({master_id:A.master,
slave_ids:A.slaves,onDone:function(D){if(D.result&&D.result.total_count===D.result.merged_count){var E=d.crm.app_url+"contact/"+D.master.id+"/";C.closest("tr").find("td:not(:first)").css({textDecoration:"line-through"}).end().find("td:first").html('<a href="'+E+'" target="_blank">'+d.crm.encodeHTML(D.master.name)+"</a>")}else C.addClass("crm-partial");D=D.message||a.messages.done||"Done";C.closest("td").css({textDecoration:""}).html('<span class="float-right" style="margin-right: 10px;">'+D+"</span>").append(C.hide().addClass("crm-finished"));
m.resolve()},onError:function(){m.resolve()}})},y=function(){n?setTimeout(y,1E3):z()},z=function(){var C=b.find(".crm-merge:not(.crm-finished):first");C.length?(C.parent().find(".crm-loading").css("opacity",1),m=new d.Deferred,m.fail(function(){l.hide();h.show()}),m.done(function(){u+=1;p(u,v);n?y():z()}),w(C)):u<v?t():B()},B=function(){k.hide();h.hide();l.hide();f.hide();a.$wrapper.find(".crm-attention-message").hide();a.$wrapper.find(".crm-done-message").show()};z()};k.click(function(r){r.preventDefault();
q()});h.click(function(r){r.preventDefault();l.show();h.hide();n=!1});l.click(function(r){r.preventDefault();n=!0;l.hide();h.show()});p(0,a.groups_count)};CRMContactsMergePage.prototype.initGroupMergeLinks=function(){let a=(new URLSearchParams(document.location.search)).get("iframe");if(window.parent&&a)this.$table.find(".js-merge-group-link").on("click",function(b){b.preventDefault();window.parent.history&&window.parent.history.pushState?window.parent.history.pushState({reload:!0},"",this.href):
window.parent.location.href=this.href})};return CRMContactsMergePage}(jQuery);var crmContactMerge=function(d){var a=function(b){this.$wrapper=b.$wrapper;this.$button=this.$wrapper.find(".crm-merge-submit");this.slave_ids=b.slave_ids||[];this.messages=b.messages||{};this.is_admin=b.is_admin;this.initClass()};a.prototype.initClass=function(){this.initSelectors();this.initMergeButton();this.$wrapper.on("click",".crm-contact-row-wrapper",function(b){var c=d(this).find(".crm-selector");c[0]!==b.target&&c.click()})};a.prototype.initSelectors=function(){var b=this;b.$wrapper.on("click",
".crm-selector",function(c){var e=d(this).closest(".crm-contact-row-wrapper"),f=e.find(".crm-contact-row");c=b.$wrapper.find(".crm-merge-description");b.$wrapper.find(".crm-js-hide-when-not-selected").hide();b.$wrapper.find(".crm-selected").removeClass("crm-selected");f.addClass("crm-selected");f.find(".crm-js-hide-when-not-selected").show();e=e.find(".crm-merge-description-for-master").html();c.html(e);c.find(".crm-js-not-allowed-as-master").length?b.$button.prop("disabled",!0):b.$button.prop("disabled",
!1)})};a.prototype.initMergeButton=function(){var b=this,c=b.slave_ids,e=b.$wrapper.find(".crm-loading");b.$button.click(function(f){f.preventDefault();var g=b.$wrapper.find(".crm-selector:checked").val();g?0<=c.indexOf(g)&&1===c.length?alert(b.messages.choose_master):(b.$button.attr("disabled",!0),e.show(),crmContactMerger.merge({master_id:g,slave_ids:c,onDone:function(){d.crm.storage.del("crm/merge/field");var k=d.crm.app_url+"contact/"+g+"/";let l=(new URLSearchParams(document.location.search)).get("iframe");
window.parent&&l?window.history&&history.pushState?window.parent.history.pushState({reload:!0},"",k):window.parent.location=k:d.crm.content.load(k)},onError:function(){b.$button.attr("disabled",!1);e.hide()}})):alert(b.messages.choose_master)})};return a}(jQuery);var crmContactMerger=function(d){var a=function(b){this.master_id=b.master_id||0;this.slave_ids=b.slave_ids||[];this.url=d.crm.app_url+"?module=contact&action=mergeRun";this.processId=this.timer=null;this.onDone=b.onDone||function(){};this.onError=b.onError||function(){throw Error("Error processing request.");}};a.prototype.process=function(){var b=this,c=b.url,e=0,f={};f.master_id=b.master_id;f.slave_ids=b.slave_ids;var g=function(){b.timer&&clearTimeout(b.timer);b.timer=setTimeout(g,3200);!b.processId||
2<=e||(f.processId=b.processId,d.post(c,f,null,"json").done(function(k){e--;b.processId&&k.ready&&b.processId&&(b.timer&&clearTimeout(b.timer),b.timer=null,b.processId=null,b.onDone(k))}).fail(b.onError),e++)};d.post(c,f,null,"json").done(function(k){if(!k.processId)b.onError();b.processId=k.processId;g()}).fail(b.onError);return this};a.prototype.cancel=function(){this.timer&&clearTimeout(this.timer);d.post(this.url,{processId:this.processId,ready:1});return this};a.merge=function(b){return(new a(b)).process()};
return a}(jQuery);var CRMReportPage=function(d){CRMReportPage=function(a){this.$wrapper=a.$wrapper;this.funnel_id=a.funnel_id;this.funnel_color=a.funnel_color;this.group_by=a.group_by;this.locales=a.locales;this.chartsData=a.chartsData;this.stages_data=a.stages_data;this.initClass()};CRMReportPage.prototype.initClass=function(){this.initSVG();"undefined"!==typeof d3&&(this.chartsData&&this.initChart(),this.stages_data&&this.initStageCharts(this.stages_data));this.initDateFilter();this.initTagsFilter()};CRMReportPage.prototype.initTagsFilter=
function(){var a=this.$wrapper.find(".js-tags-filter"),b=a.find(".js-show-all"),c=a.find(".js-popular-tags-part"),e=a.find(".js-hidden-tags-part");b.on("click",function(f){f.preventDefault();f.stopPropagation();c.remove();b.remove();e.slideDown(300)})};CRMReportPage.prototype.initDateFilter=function(){var a=this.$wrapper.find(".js-dates-filter"),b=a.find("form"),c=a.find(".js-list");a.find(".js-timeframe-field");var e=a.find(".js-link-text"),f=a.find(".js-hidden-part"),g=!1,k=c.find(".selected");
c.on("click",".js-toggle",function(l){l.preventDefault();l=d(this);var h=l.data("timeframe");e.html(l.find("a").html());k.length&&k.removeClass("selected");k=l.addClass("selected");"custom"!==h?f.removeClass("is-shown"):f.addClass("is-shown")});b.on("submit",function(l){l.preventDefault();g||(g=!0,l=b.serialize(),d.crm.content.load(d.crm.app_url+"report/?"+l))});(function(){a.find(".js-datepicker").each(function(){var l=d(this),h=a.find("."+l.data("selector"));l.datepicker({altField:h,altFormat:"yy-mm-dd",
changeMonth:!0,changeYear:!0})})})()};CRMReportPage.prototype.initSVG=function(){if("object"!==typeof d3)return!1;var a=function(b,c){function e(g){var k=g.$wrapper;g=g.start/100;var l={};l.width=k.outerWidth();l.height=k.outerHeight();l.inner_width=parseInt(l.width*g);l.inner_height=l.height;l.top=l.height-l.inner_height;l.left=parseInt((l.width-l.inner_width)/2);return l}function f(g){var k=[],l=parseInt((g.start-g.end)/200*g.area.width);k.push("0,0");k.push(g.area.inner_width+",0");k.push(g.area.inner_width-
l+","+g.area.height);k.push(l+","+g.area.height);return k.join(" ")}a=function(g){this.$wrapper=g.$wrapper;this.svg=c.select(this.$wrapper[0]).append("svg");this.start=parseInt(this.$wrapper.data("start"));this.end=parseInt(this.$wrapper.data("end"));this.color=this.$wrapper.data("color");this.polygon=!1;this.area=e(this);this.initClass()};a.prototype.initClass=function(){function g(){b.contains(document,k.$wrapper[0])?k.refresh():b(window).off("resize",g)}var k=this;k.svg.attr("width",k.area.width).attr("height",
k.area.height);k.renderRectangle();k.$wrapper.data("svg",k);b(window).on("resize",g)};a.prototype.renderRectangle=function(){var g=this.svg.append("g"),k=f(this);this.polygon=g.append("polygon").attr("points",k).attr("transform","translate("+this.area.left+","+this.area.top+")").style("fill",this.color)};a.prototype.refresh=function(){this.area=e(this);this.svg.attr("width",this.area.width).attr("height",this.area.height);this.polygon.attr("points",f(this)).attr("transform","translate("+this.area.left+
","+this.area.top+")")};return a}(jQuery,d3);this.$wrapper.find(".js-svg-bar").each(function(){var b=d(this);new a({$wrapper:b})})};CRMReportPage.prototype.initChart=function(){function a(f,g){function k(l,h,m){var n=l.date.split("-");l=parseInt(n[0]);var p=parseInt(n[1]);n=parseInt(n[2]);l=[l,p,n];"years"===m?(m=l.slice(),m[0]+=h?1:-1):"months"===m?(m=l.slice(),m[1]+=h?1:-1):(m=l.slice(),m[2]+=h?1:-1);m[1]=(10>m[1]?"0":"")+m[1];m[2]=(10>m[2]?"0":"")+m[2];return{date:m.join("-"),value:0}}d.each(f,
function(l){l=f[l];if(1===l.data.length){var h=l.data[0],m=k(h,!1,g),n=k(h,!0,g);console.log(h);console.log(m);console.log(n);h=[m].concat(l.data);h.push(n);l.data=h;console.log(l.data)}});return f}var b=this.$wrapper.find(".js-graph-section");if(!b.length)return!1;var c=function(f){function g(h){function m(w){var x=w.split("-");w=parseInt(x[0]);var y=parseInt(x[1])-1;x=parseInt(x[2]);return new Date(w,y,x)}for(var n=[],p=0;p<h.length;p++){for(var q=h[p].data,r=[],u=0;u<q.length;u++){var v=q[u],t=
parseInt(v.value);r.push({date:m(v.date),value:t})}n.push(r)}return d3.layout.stack().offset("zero").values(function(w){return w}).x(function(w){return w.date}).y(function(w){return w.value})(n)}function k(h,m){m=(m[1]||1)-m[0]+1;for(var n=m/(h-1),p=[],q=0;q<h;q++){var r=10<m?Math.round(q*n):parseInt(q*n*10)/10;p.push(r)}return p}function l(h,m){var n=f(window),p=n.width();n.height();n=m.$hint.outerWidth();var q=m.$hint.outerHeight(),r=m.$wrapper.offset();m=h.pageX;h={left:m-r.left+10,top:h.pageY-
r.top+(0<q?0-q-2:2)};p<h.left+n&&(h.left=m-(n+10));return h}c=function(h){this.$wrapper=h.$wrapper;this.$hint=this.$wrapper.find(".c-hint-wrapper");this.node=this.$wrapper.find(".js-graph")[0];this.d3node=d3.select(this.node);this.show_class="is-shown";this.charts=h.data;this.data=g(this.charts);this.color=h.color;this.group_by=h.group_by;this.locales=h.locales;this.margin={top:14,right:10,bottom:20,left:34};var m=this.node;h=this.margin;var n=m.offsetWidth;m=m.offsetHeight;this.area={outer_width:n,
outer_height:m,inner_width:n-h.left-h.right,inner_height:m-h.top-h.bottom};this.column_indent=4;h=this.area.inner_width;n=this.data[0].length;m=null;n+=1;h&&n&&(m=(h-this.column_indent*(n-1))/n,0>m&&(m=0));this.column_width=m;this.axisIndent=2;this.yDomain=this.xDomain=this.svgArea=this.svgLine=this.y=this.x=this.defs=this.svg=!1;this.initGraph()};c.prototype.initGraph=function(){var h=this,m=h.area;h.initGraphCore();h.svg=h.d3node.append("svg").attr("width",m.outer_width).attr("height",m.outer_height);
h.renderBackground();f.each(h.data,function(n,p){n=h.data.length-1-n;h.renderChart(h.data[n],h.charts[n])});h.renderAxis()};c.prototype.initGraphCore=function(){var h=this,m=h.data,n=h.area,p=h.x=d3.time.scale().range([0,n.inner_width]),q=h.y=d3.scale.linear().range([n.inner_height,0]);h.yDomain=function(){var r=d3.min(m,function(v){return d3.min(v,function(t){return t.value})});0<r&&(r=0);var u=d3.max(m,function(v){return d3.max(v,function(t){return t.value+t.y0})});return[r,u]}();h.xDomain=function(){var r=
m[0][0].date;var u=m[0][m[0].length-1].date;var v=.05*(u.getTime()-r.getTime());r=new Date(r.getTime()-v);u=new Date(u.getTime()+v);return[r,u]}();p.domain(h.xDomain);q.domain(h.yDomain);h.svgArea=d3.svg.area().interpolate("monotone").x(function(r){return p(r.date)}).y(function(r){return q(r.value+r.y0)-h.axisIndent}).y0(function(r){return q(0)});h.svgLine=d3.svg.line().interpolate("monotone").x(function(r){return p(r.date)}).y(function(r){return q(r.value+r.y0)-h.axisIndent})};c.prototype.renderAxis=
function(){var h=this.x,m=this.y,n=this.svg;h=d3.svg.axis().scale(h).orient("bottom").ticks(10);m=d3.svg.axis().scale(m).innerTickSize(2).orient("right").tickValues(k(6,this.yDomain)).tickFormat(function(p){return p+""});n=n.append("g").attr("class","axis");n.append("g").attr("transform","translate(10,"+this.margin.top+")").attr("class","y").call(m);n.append("g").attr("class","x").attr("transform","translate("+this.margin.left+","+(this.area.outer_height-this.margin.bottom)+")").call(h)};c.prototype.renderBackground=
function(){var h=this.area.inner_width,m=this.area.inner_height,n,p=this.svg.append("g").attr("class","background").attr("transform","translate("+this.margin.left+","+this.margin.top+")");p.append("rect").attr("width",h).attr("height",m);for(n=0;5>=n;n++){var q=1+(m-2)/5*n;p.append("line").attr("x1",1).attr("x2",h).attr("y1",q).attr("y2",q)}};c.prototype.renderChart=function(h,m){var n=this,p=m.color;n.svg.append("g").attr("class","c-graph-wrapper").attr("transform","translate("+n.margin.left+","+
n.margin.top+")").datum(h).append("path").style("stroke",function(){return 1<n.charts.length?"":n.color}).style("fill",function(){return p?p:n.color}).attr("class","area").attr("d",n.svgArea(h)).on("mouseover",function(q){n.showHint(d3.event,this,m)}).on("mousemove",function(){n.moveHint(this)}).on("mouseout",function(){n.hideHint()})};c.prototype.update=function(h){this.data=g(this.charts,h);this.initGraphCore();h=d3.svg.axis().scale(this.y).innerTickSize(2).orient("right").tickValues(k(6,this.yDomain)).tickFormat(function(m){return m+
""});this.svg.selectAll(".axis .y").call(h);this.renderCharts()};c.prototype.showHint=function(h,m,n){m=this.$hint.find(".js-name");this.$hint.find(".js-date");this.$hint.find(".js-value");n.name&&(m.text(n.name),h=l(h,this),this.$hint.css(h).addClass(this.show_class))};c.prototype.moveHint=function(){if(this.$hint.hasClass(this.show_class)){var h=l(event,this);this.$hint.css(h)}};c.prototype.hideHint=function(){this.$hint.removeAttr("style").removeClass(this.show_class)};return c}(jQuery),e=function(f){function g(l){function h(t){var w=
t.split("-");t=parseInt(w[0]);var x=parseInt(w[1])-1;w=parseInt(w[2]);return new Date(t,x,w)}for(var m=[],n=0;n<l.length;n++){for(var p=l[n].data,q=[],r=0;r<p.length;r++){var u=p[r],v=parseInt(u.value);q.push({date:h(u.date),value:v})}m.push(q)}return d3.layout.stack().offset("zero").values(function(t){return t}).x(function(t){return t.date}).y(function(t){return t.value})(m)}function k(l,h){var m=h[0];h=h[1]||1;m=0<h-m?h-m:1;h=m/(l-1);for(var n=[],p=0;p<l;p++){var q=10<m?Math.round(p*h):parseInt(p*
h*10)/10;q=0<parseInt(q)?parseInt(q):1;n.push(q)}return n}e=function(l){this.$wrapper=l.$wrapper;this.$hint=this.$wrapper.find(".c-hint-wrapper");this.node=this.$wrapper.find(".js-graph")[0];this.d3node=d3.select(this.node);this.show_class="is-shown";this.charts=l.data;this.data=g(this.charts);this.color=l.color;this.group_by=l.group_by;this.locales=l.locales;this.margin={top:8,right:10,bottom:4,left:34};var h=this.node;l=this.margin;var m=h.offsetWidth;h=h.offsetHeight;this.area={outer_width:m,outer_height:h,
inner_width:m-l.left-l.right,inner_height:h-l.top-l.bottom};this.column_indent=200<this.data[0].length?2:4;l=this.area.inner_width;m=this.data[0].length;h=null;m+=1;l&&m&&(h=(l-this.column_indent*(m-1))/m,1>h?h=1:20<h&&(h=20));this.column_width=h;this.yDomain=this.xDomain=this.y=this.x=this.defs=this.svg=!1;this.initGraph()};e.prototype.initGraph=function(){var l=this.area;this.initGraphCore();200<this.data[0].length?this.$wrapper.addClass("is-large"):this.$wrapper.removeClass("is-large");this.svg=
this.d3node.append("svg").attr("width",l.outer_width).attr("height",l.outer_height);this.renderBackground();this.renderCharts();this.renderAxis()};e.prototype.initGraphCore=function(){var l=this.data,h=this.area,m=this.x=d3.time.scale().range([0,h.inner_width]);h=this.y=d3.scale.linear().range([0,h.inner_height]);this.yDomain=function(){var n=d3.min(l,function(q){return d3.min(q,function(r){return r.value})});0<n&&(n=0);var p=d3.max(l,function(q){return d3.max(q,function(r){return r.value+r.y0})});
return[n,p]}();this.xDomain=function(){var n=l[0][0].date;var p=l[0][l[0].length-1].date;var q=.05*(p.getTime()-n.getTime());n=new Date(n.getTime()-q);p=new Date(p.getTime()+q);return[n,p]}();m.domain(this.xDomain);h.domain(this.yDomain)};e.prototype.renderAxis=function(){var l=this.x,h=this.y,m=this.svg;d3.svg.axis().scale(l).orient("bottom").ticks(10);l=d3.svg.axis().scale(h).innerTickSize(2).orient("right").tickValues(k(6,this.yDomain)).tickFormat(function(n){return n+""});m.append("g").attr("class",
"axis").append("g").attr("transform","translate(10,"+this.margin.top+")").attr("class","y").call(l)};e.prototype.renderBackground=function(){var l=this.area.inner_width,h=this.area.inner_height,m,n=this.svg.append("g").attr("class","background").attr("transform","translate("+this.margin.left+","+this.margin.top+")");n.append("rect").attr("width",l).attr("height",h);for(m=0;5>=m;m++){var p=1+(h-2)/5*m;n.append("line").attr("x1",1).attr("x2",l).attr("y1",p).attr("y2",p)}};e.prototype.renderCharts=function(){var l=
this,h=l.data;h=l.svg.selectAll(".c-graph-wrapper").data(h);h.enter().append("g").attr("class","c-graph-wrapper").attr("transform","translate("+l.margin.left+","+l.margin.top+")");var m=h.selectAll(".rect").data(function(q){return q}),n=!1;if(l.color){var p=f.crm.color(l.color).rgb;p.push(.5);n="rgba("+p.join(",")+")"}m.enter().append("rect").attr("class","rect").on("mouseover",function(q,r,u){l.showHint(d3.event,this,q,l.charts[u])}).on("mousemove",function(){l.moveHint(this)}).on("mouseout",function(){l.hideHint()});
m.transition().duration(1E3).attr("x",function(q,r){return l.x(q.date)-l.column_width/2}).attr("y",function(q){return l.y(q.y0)}).attr("height",function(q){return l.y(q.value)}).style("stroke",function(q,r,u){return l.charts[u].color?"":l.color}).style("fill",function(q,r,u){q=l.charts[u];return q.color?q.color:n}).attr("width",l.column_width);m.exit().remove();h.exit().remove()};e.prototype.update=function(l){this.data=g(this.charts,l);this.column_indent=200<this.data[0].length?2:4;200<this.data[0].length?
this.$wrapper.addClass("is-large"):this.$wrapper.removeClass("is-large");this.initGraphCore();l=d3.svg.axis().scale(this.y).innerTickSize(2).orient("right").tickValues(k(6,this.yDomain)).tickFormat(function(h){return h+""});this.svg.selectAll(".axis .y").call(l);this.renderCharts()};e.prototype.showHint=function(l,h,m,n){var p=this;l=f(h);if(!(0<Math.ceil(l.attr("height"))))return!1;var q=m.date;h=p.$hint.find(".js-name");var r=p.$hint.find(".js-date"),u=p.$hint.find(".js-value");q=function(v,t){var w=
parseInt(v.getMonth());"months"==t?(v=p.locales.months,v[w]||(v="\u042f\u043d\u0432\u0430\u0440\u044c \u0424\u0435\u0432\u0440\u0430\u043b\u044c \u041c\u0430\u0440\u0442 \u0410\u043f\u0440\u0435\u043b\u044c \u041c\u0430\u0439 \u0418\u044e\u043d\u044c \u0418\u044e\u043b\u044c \u0410\u0432\u0433\u0443\u0441\u0442 \u0421\u0435\u043d\u0442\u044f\u0431\u0440\u044c \u041e\u043a\u0442\u044f\u0431\u0440\u044c \u041d\u043e\u044f\u0431\u0440\u044c \u0414\u0435\u043a\u0430\u0431\u0440\u044c".split(" ")),w=v[w]):
(t=v.getDate(),w+=1,w=(10>t?"0"+t:t)+"."+(10>w?"0"+w:w)+"."+v.getFullYear());return w}(q,p.group_by);n.name?h.text(n.name+": ").show():h.hide();r.text(q);u.text(m.value);m=function(v){var t=f(window),w=t.width();t.height();t=p.$hint.outerWidth();var x=p.$hint.outerHeight(),y=Math.ceil(v.attr("width")),z=Math.ceil(v.attr("height")),B=p.$wrapper.offset();v=v.offset();x={left:v.left-B.left+y+10,top:v.top-B.top+(z<x?z-x-2:2)};w<x.left+t&&(x.left=v.left-(t+10));return x}(l);p.$hint.css(m).addClass(p.show_class)};
e.prototype.moveHint=function(){};e.prototype.hideHint=function(){this.$hint.removeAttr("style").removeClass(this.show_class)};return e}(jQuery);new c({$wrapper:b.find(".js-sum-graph"),data:a(this.chartsData.sum,this.group_by),color:this.funnel_color,group_by:this.group_by,locales:this.locales});new e({$wrapper:b.find(".js-amount-graph"),data:a(this.chartsData.qty,this.group_by),color:this.funnel_color,group_by:this.group_by,locales:this.locales})};CRMReportPage.prototype.initStageCharts=function(a){var b=
this.$wrapper.find(".js-stage-graph-section"),c=a.stages;if(!b.length||!c.length)return!1;var e=[0,2*c.length],f=function(k){f=function(l){this.$wrapper=l.$wrapper;this.$hint=this.$wrapper.find(".c-hint-wrapper");this.node=this.$wrapper.find(".js-graph")[0];this.d3node=d3.select(this.node);this.show_class="is-shown";console.log(l.data);for(var h=l.data,m=0;m<h.length;m++){var n=h[m];1!==m||n.color||(n.color="#e07d6e")}h=this.charts=h;m=[];for(n=0;n<h.length;n++){for(var p=h[n].data,q=[],r=0;r<p.length;r++){var u=
parseInt(p[r].value);q.push({index:1+2*r,value:u})}m.push(q)}this.data=m;this.color=l.color;this.group_by=l.group_by;this.locales=l.locales;this.margin={top:20,right:0,bottom:0,left:0};m=this.node;l=this.margin;h=m.offsetWidth;m=m.offsetHeight;this.area={outer_width:h,outer_height:m,inner_width:h-l.left-l.right,inner_height:m-l.top-l.bottom};this.column_indent=8;l=this.area.inner_width;h=this.data[0].length;m=null;l&&h&&(m=(l-this.column_indent*(h-1))/h,1>m&&(m=1));this.column_width=m;this.yDomain=
this.xDomain=this.y=this.x=this.defs=this.svg=!1;this.initGraph()};f.prototype.initGraph=function(){var l=this.area;this.initGraphCore();this.svg=this.d3node.append("svg").attr("width",l.outer_width).attr("height",l.outer_height);this.renderCharts()};f.prototype.initGraphCore=function(){var l=this.data,h=this.area,m=this.x=d3.scale.linear().range([0,h.inner_width]);h=this.y=d3.scale.linear().range([0,h.inner_height]);this.yDomain=function(){var n=d3.min(l,function(q){return d3.min(q,function(r){return r.value})});
0<n&&(n=0);var p=d3.max(l,function(q){return d3.max(q,function(r){return r.value})});return[n,p]}();this.xDomain=e;m.domain(this.xDomain);h.domain(this.yDomain)};f.prototype.renderCharts=function(){var l=this,h=l.data;h=l.svg.selectAll(".c-graph-wrapper").data(h);h.enter().append("g").attr("class","c-graph-wrapper").attr("transform","translate("+l.margin.left+","+l.margin.top+")");var m=h.selectAll(".rect").data(function(q){return q});m.enter().append("rect").attr("class","rect");m.transition().duration(1E3).attr("x",
function(q,r){return l.x(q.index)-l.column_width/2}).attr("y",function(q){return l.area.inner_height-l.y(q.value)}).attr("height",function(q){return l.y(q.value)}).style("stroke",function(q,r,u){return l.charts[u].color?"":l.color}).style("fill",function(q,r,u){q=l.charts[u];return q.color?q.color:l.color}).attr("width",l.column_width);var n=h.selectAll(".base-text").data(function(q){return q});n.enter().append("text").attr("class","base-text");n.transition().duration(1E3).attr("text-anchor","middle").attr("x",
function(q){return l.x(q.index)}).attr("y",function(q){return l.area.inner_height-10}).text(function(q,r,u){q="";if(r=l.charts[u].data[r])q=r.base_text;return q});var p=h.selectAll(".over-text").data(function(q){return q});p.enter().append("text").attr("class","base-text");p.transition().duration(1E3).attr("text-anchor","middle").attr("x",function(q){return l.x(q.index)}).attr("y",function(q){return l.area.inner_height-l.y(q.value)-6}).style("fill",function(q,r,u){return 1===u?"#cc270e":""}).text(function(q,
r,u){q="";if(r=l.charts[u].data[r])q=r.over_text;return q});n.exit().remove();p.exit().remove();m.exit().remove();h.exit().remove()};return f}(jQuery),g=function(k){function l(h){for(var m=[],n=0;n<h.length;n++){for(var p=h[n].data,q=[],r=0;r<p.length;r++){var u=parseInt(p[r].value);q.push({index:1+2*r,value:u})}m.push(q)}return d3.layout.stack().offset("zero").values(function(v){return v}).x(function(v){return v.index}).y(function(v){return v.value})(m)}g=function(h){this.$wrapper=h.$wrapper;this.$hint=
this.$wrapper.find(".c-hint-wrapper");this.node=this.$wrapper.find(".js-graph")[0];this.d3node=d3.select(this.node);this.show_class="is-shown";this.charts=h.data;this.data=l(this.charts);this.color=h.color;this.group_by=h.group_by;this.locales=h.locales;this.margin={top:0,right:0,bottom:20,left:0};var m=this.node;h=this.margin;var n=m.offsetWidth;m=m.offsetHeight;this.area={outer_width:n,outer_height:m,inner_width:n-h.left-h.right,inner_height:m-h.top-h.bottom};this.column_indent=8;h=this.area.inner_width;
n=this.data[0].length;m=null;h&&n&&(m=(h-this.column_indent*(n-1))/n,1>m&&(m=1));this.column_width=m;this.yDomain=this.xDomain=this.y=this.x=this.defs=this.svg=!1;this.initGraph()};g.prototype.initGraph=function(){var h=this.area;this.initGraphCore();this.svg=this.d3node.append("svg").attr("width",h.outer_width).attr("height",h.outer_height);this.renderCharts()};g.prototype.initGraphCore=function(){var h=this.data,m=this.area,n=this.x=d3.scale.linear().range([0,m.inner_width]);m=this.y=d3.scale.linear().range([0,
m.inner_height]);this.yDomain=function(){var p=d3.min(h,function(r){return d3.min(r,function(u){return u.value})});0<p&&(p=0);var q=d3.max(h,function(r){return d3.max(r,function(u){return u.value+u.y0})});return[p,q]}();this.xDomain=e;n.domain(this.xDomain);m.domain(this.yDomain)};g.prototype.renderCharts=function(){var h=this,m=h.data;m=h.svg.selectAll(".c-graph-wrapper").data(m);m.enter().append("g").attr("class","c-graph-wrapper").attr("transform","translate("+h.margin.left+","+h.margin.top+")");
var n=m.selectAll(".rect").data(function(r){return r});n.enter().append("rect").attr("class","rect");n.transition().duration(1E3).attr("x",function(r,u){return h.x(r.index)-h.column_width/2}).attr("y",function(r){return h.y(r.y0)}).attr("height",function(r){return h.y(r.value)}).style("stroke",function(r,u,v){return h.charts[v].color?"":h.color}).style("fill",function(r,u,v){r=h.charts[v];return r.color?r.color:h.color}).attr("width",h.column_width);var p=m.selectAll(".base-text").data(function(r){return r});
p.enter().append("text").attr("class","base-text").text(function(r,u,v){r="";if(u=h.charts[v].data[u])r=u.base_text;return r}).append("tspan").style("fill","#cc270e").text(function(r,u,v){r="";(u=h.charts[v].data[u])&&u.sub_text&&(r=" ("+u.sub_text+")");return r});p.transition().duration(1E3).attr("text-anchor","middle").attr("x",function(r){return h.x(r.index)}).attr("y",16);var q=m.selectAll(".over-text").data(function(r){return r});q.enter().append("text").attr("class","over-text");q.transition().duration(1E3).attr("text-anchor",
"middle").attr("x",function(r){return h.x(r.index)}).attr("y",function(r){r=h.y(r.y0)+h.y(r.value)+16;34>r&&(r=34);return r}).text(function(r,u,v){r="";if(u=h.charts[v].data[u])r=u.over_text;return r});p.exit().remove();q.exit().remove();n.exit().remove();m.exit().remove()};return g}(jQuery);c=b.find(".js-graph-wrapper-1");c.length&&new f({$wrapper:c,data:a.charts[0],color:"#d0d0d0",group_by:this.group_by,locales:this.locales});b=b.find(".js-graph-wrapper-2");b.length&&new g({$wrapper:b,data:[a.charts[1]],
color:"#b0b0b0",group_by:this.group_by,locales:this.locales})};return CRMReportPage}(jQuery);(function(d){d.crm=d.crm||{};d.crm.search={state:null,url:d.crm.app_url+"?module=contactSearch",serialize:function(a,b,c,e){var f={},g=a.serializeArray();a=0;for(var k=g.length;a<k;a+=1){var l=(g[a].value||"").trim();try{l=JSON.parse(l)}catch(t){}var h=g[a].name;if(!(!h||!l||d.isPlainObject(l)&&d.isEmptyObject(l)||b&&0!==h.indexOf(b)||void 0!==c&&-1===h.indexOf("["+c+"]"))){var m=""+(d.isPlainObject(l)?l.val:l);if(m=d.trim(m)){l=d.isPlainObject(l)?l.op||"=":"=";m=m.replace(/\//g,"\\/").replace(/&/,
"\\&");h=h.split(".");for(var n=f,p=0,q=h.length-1;p<q;p+=1){var r=(h[p]||"").trim();if("undefined"===typeof n[r]||"object"!==typeof n[r])n[r]={};n=n[r]}r=h[h.length-1];d.isArray(n[r])?n[r].push({val:m,op:l}):d.isPlainObject(n[r])||(n[r]=[{val:m,op:l}])}}}var u=function(t,w,x){if(d.isPlainObject(t))for(var y in t)t.hasOwnProperty(y)&&u(t[y],w,x?x+"."+y:y);else"undefined"!==typeof t&&(w[x]=t)};b={};u(f,b,"");f=[];for(var v in b)if(b.hasOwnProperty(v))if(d.isArray(b[v])&&1<b[v].length)for(a=0,k=b[v].length;a<
k;a+=1)m=b[v][a].val,e||(m=this.encodeURIComponent(b[v][a].val)),f.push(v+"["+a+"]"+b[v][a].op+m);else m=b[v][0].val,e||(m=this.encodeURIComponent(b[v][0].val)),f.push(v+b[v][0].op+m);return f.join("&")},encodeURIComponent:function(a){a=encodeURIComponent(a);return a=a.replace(RegExp("%2F","g"),"%252F").replace(RegExp("%5C","g"),"%255C")},indexBlocks:function(a){var b={},c=d('#c-search-block .js-field[data-multiple="1"]');a&&(c=c.filter('[data-id="'+a+'"]'));c.each(function(){var e=d(this),f=e.data("id"),
g=void 0!==b[f]?++b[f]:b[f]=0;e.attr("data-index",g);e.data("index",g);e.find(":input").each(function(){var k=d(this),l=k.attr("name").replace(/\[\d+\]/,"").replace(f,f+"["+g+"]");k.attr("name",l)})})}}})(jQuery);(function(d){d.widget("custom.combobox",{_create:function(){this.element.data("custom.combobox.inited")||(this.wrapper=d("<div style='position:relative;'>").addClass("custom-combobox").insertAfter(this.element),this.element.hide(),this._createAutocomplete(),this._createShowAllButton(),this.element.data("custom.combobox.inited",1))},_createAutocomplete:function(){this.ns=this.element.attr("name")||"element-"+(""+Math.random()).slice(2);_other_version_=!0;if(this.element.is("select")){var a=this.element.children(":selected"),
b=a.val()?a.text():"";this.h=24;var c=this;this.input=d("<input type='search'>").appendTo(this.wrapper).val(b).attr("title","").addClass("custom-combobox-input ui-widget");this.element.data("autocomplete")||this.element.data("readonly")?(this.input.autocomplete({delay:200,minLength:0,html:!0,source:d.proxy(this,"_source"),item_clz:"crm-search-ui-autocomplete-item",width:270}),this.ul=d(this.input).autocomplete("widget")):this.ul=d();this.offset=this.limit=this.element.data("limit");this.count=this.element.data("count");
this.wrapper.width(this.input.width()+30);this.ul.css({overflowY:"auto",overflowX:"hidden",maxHeight:10*this.h});this.element.attr("disabled")&&this.input.attr("disabled",!0);this.options.css&&this.input.css(this.options.css);this.element.find("option.cond").remove();this.element.data("readonly")&&this.input.attr("readonly",!0).addClass("readonly").css({cursor:"pointer"}).click(function(){d(this).autocomplete("widget").is(":visible")?d(this).autocomplete("close"):c._showSelectItems();return!1});this.hidden=
d("<input type='hidden'>").appendTo(this.wrapper);this.label=!1!==this.options.label?d('<span class="c-label"></span>').css({top:"3px",left:"-20px",position:"absolute"}).prependTo(this.wrapper):d();this.element.attr("name","");this.element.data("readonly")&&this.label.hide();this.element.attr("disabled")&&this.input.attr("disabled",!0);"*="===a.data("op")&&this.label.text("\u2248");if(a.val()&&!a.hasClass("value"))a.data("period")?(this.element.data("value",""),a=a.val().split("--"),this._updatePeriodInput((a[0]||
"").trim(),(a[1]||"").trim())):(this.element.data("value",""),"value"===this.element.data("pass")?this.hidden.attr("name",this.ns).val(a.val()):this.hidden.attr("name",this.ns+"."+a.val()).val("1"),this.input.val(a.text()),this.label.text("=")),this._removeIcon();else if(a.hasClass("value")||a.text()){this.element.val("");b=a.hasClass("value")?a.val()||a.text():a.text();var e=a.hasClass("value")?a.text():b;"*="===a.data("op")?this.element.data("readonly")?this.hidden.attr("name",this.ns).val(b):this.hidden.attr("name",
this.ns).val(JSON.stringify({op:"*=",val:b})):this.hidden.attr("name",this.ns).val(b);this.input.val(e);a.data("icon")&&this._addIcon(a.data("icon"))}else this.hidden.attr("name",this.ns);this.input.bind("autocompleteselect",function(g,k){k.item.option&&(k.item.option.selected=!0,d(this).trigger("select",g,{item:k.item.option}));if(k.item.option&&!d(k.item.option).hasClass("value"))if(d(k.item.option).data("period")){var l=c._showPeriodDialog();l.bind("select",function(m,n,p){c._updatePeriodInput(n,
p);c._removeIcon()});l.bind("cancel",function(){c.input.val("");c.hidden.attr("name",c.ns).val("");c.label.text("")})}else(l=d(k.item.option).val())?"value"===c.element.data("pass")?c.hidden.attr("name",c.ns).val(l):c.hidden.attr("name",c.ns+"."+l).val("1"):c.hidden.attr("name",c.ns).val(""),c.input.val(d(k.item.option).text()),c.label.text("="),c._removeIcon();else{l=k.item.value;var h=k.item.text||k.item.name;k.item.option&&(l=d(k.item.option).val());c.hidden.attr("name",c.ns).val(l);c.input.val(h);
c.label.text("=");k.item.icon?c._addIcon(k.item.icon):c._removeIcon()}c.element.trigger("change");c.element.data("readonly")&&setTimeout(function(){c.input.blur()});"function"===typeof c.options.select&&c.options.select.apply(this,[g,k]);return!1}).bind("autocompletechange",function(g,k){c._removeIfInvalid.call(c,g,k)});var f="";this.element.data("readonly")||(this.input.bind("keydown",function(){f=d(this).val()}),this.input.bind("keyup",function(){var g=d(this).val();f!==g&&(c._removeIcon(),g?(c.label.text("\u2248"),
c.hidden.attr("name",c.ns).val(JSON.stringify({val:g,op:"*="}))):(c.label.text(""),c.hidden.attr("name",c.ns).val("")));"function"===typeof c.options.keyup&&c.options.keyup.apply(this,[g,f]);f=g}));this.input.bind("keyup",function(g){13==g.keyCode&&!d(this).data("hold")&&d(this).val().trim()&&d(this).trigger("enter")});this.input.bind("search",function(){d(this).val()||(c._removeIcon(),c.hidden.attr("name",c.ns).val(""),c.label.text(""),c.ul.is(":visible")&&d(this).autocomplete("search",""),"function"===
typeof c.options.clear&&c.options.clear.apply(this))});this.input.bind("autocompleteopen",function(g,k){var l=c.input.width();c.ul.find("li.ui-menu-item").each(function(){var h=d(this),m=h.find(".count"),n=h.find(".crm-text");m.insertBefore(n);n.width(Math.max(l-m.outerWidth(!0)-30,0)).data("sep")&&h.css({borderTop:"0px solid #ccc"})});c.ul.width(l)});_other_version_||(this.input.bind("autocompleteopen",function(g,k){c.ul.width(c.input.outerWidth(!0)-5);void 0!==c.offset&&void 0!==c.count&&(c.offset<
c.count?(c.height=c.ul.height(),c.ul.unbind("scroll."+c.ns).bind("scroll."+c.ns,function(){var m=d(this).find(".dummy-end");m.length?d(this).scrollTop()+c.height>=m.position().top&&c.input.trigger("autocompleteload"):c.ul.unbind("scroll."+c.ns)}),g=c.ul.find(".ui-menu-item:first").height(),d('<li class="dummy-end ignore-hover" role="menuitem"><a class="ui-corner-all" style="padding: .2em .4em; line-height: 1.5; display: block;"></a></li>').height(g).appendTo(c.ul),c.ul.css({overflowY:"scroll",overflowX:"hidden",
height:c.height})):(c.ul.unbind("scroll."+c.ns),c.ul.css({overflowY:"",overflowX:""})));c.ul.find(".sep").closest("li").addClass("ignore-hover");var l=c.ul.width(),h="scroll"===c.ul.css("overflowY");c.ul.find("li.ui-menu-item").each(function(){var m=d(this);m.find(".sep").length?m.find(".sep").width(h?l-25:l-10):m.find(".crm-text").width(Math.max(l-m.find(".count").outerWidth(!0)-30,0))})}),this.input.bind("autocompleteload",function(g){!c.loading&&c.offset<c.count&&(c.loading=!0,c.input.addClass("ui-autocomplete-loading"),
d.get(c.options.url,{id:c.ns,offset:c.offset,limit:c.limit,term:c.input.val()},function(k){if("ok"===k.status){var l=k.data.values,h=[];c.ul.find(".ui-menu-item").each(function(){h.push(d(this).data("item.autocomplete"))});for(var m=0;m<l.length;m+=1)h.push(c._formItem(l[m]));c.count=k.data.count;c.response(h);c.offset+=l.length;c.offset>=c.count&&c.ul.find(".dummy-end").remove()}c.loading=!1;c.input.removeClass("ui-autocomplete-loading")},"json"))}));this.input.bind("autocompletefocus",function(g,
k){d(this).val(k.item.name);d(this).data("hold",1);return!1});this.input.bind("autocompleteclose",function(g,k){if(13===g.keyCode){var l=d(this);setTimeout(function(){l.data("hold",0)},200)}else d(this).data("hold",0)});this.input.focus(function(){c.arrow.show()}).blur(function(){c.wrapper.data("mouserover")||c.arrow.hide()});this.wrapper.mouseover(function(){d(this).data("mouserover",1);c.arrow.show()}).mouseout(function(){d(this).data("mouserover",0);c.input.is(":focus")||c.arrow.hide()})}},_createShowAllButton:function(){var a=
this.input,b=this.hidden,c=this.ns,e=this.element,f=this;e.find("option").length?(this.arrow=d("<a href='javascript:void(0);' style='margin: -2px 0 0 -20px;'><i class='fas fa-caret-down'></i></a>").attr("tabIndex",-1).appendTo(this.wrapper).removeClass("ui-corner-all").addClass("custom-combobox-toggle ui-corner-right").mousedown(function(){a.focus();b.attr("name",c);f.ul.is(":hidden")?f._showSelectItems():a.autocomplete("search","");return!1}).hide(),e.data("readonly")&&this.wrapper.find("svg").css({backgroundColor:"white"}).parent().css({})):
this.arrow=d()},_addIcon:function(a){this.input.after('<img class="flag" style="position: absolute; top: 3px; right: 41px; padding: 2px; background: white;" src="'+a+'"/>')},_removeIcon:function(){this.input.nextAll(".flag").remove()},_formItem:function(a,b){var c=a.label;!b||a.value||a.name||(c='<span style="visibility: hidden">empty</span>');_other_version_||(c=d.wa.encodeHTML(a.name));c='<span class="crm-text" data-sep="'+(a.sep?1:0)+'">'+c;a.icon&&(c+=' <img src="'+a.icon+'" />');c+="</span>";
d.isNumeric(a.count)&&(c+='<span class="count" style="float: right;">'+a.count+"</span>");a.label=c;a.value||(a.value=a.name);return a},_showSelectItems:function(){var a=this,b=null,c=a.element.data("readonly"),e=!1;a.input.autocomplete("search","");b=this.response;b(this.element.children("option").map(function(){var f=d(this);if(f.hasClass("sep"))e=!0;else return f=a._formItem({icon:f.data("icon"),count:f.data("count"),label:f.html(),name:f.text(),value:this.value,sep:e,option:this},c),e=!1,f}).toArray())},
_source:function(a,b){var c=new RegExp(d.ui.autocomplete.escapeRegex(a.term),"i"),e=this;e.response=b;if(_other_version_&&!a.term)b([]);else{var f=function(k,l){_other_version_&&(k.highlight=1);d.get(e.options.url,k,function(h){var m=[],n=0;h&&"ok"===h.status&&(d.isArray(h.data.values)&&h.data.values.length&&(m=h.data.values),h.data.count&&(n=h.data.count));h=0;for(var p=m.length;h<p;h+=1)m[h]=e._formItem(d.extend(m[h],{option:null}));e.offset=m.length;e.count=n;b(m)},"json")};if(_other_version_)a.term?
f({term:a.term,id:this.ns}):b(this.element.children("option").map(function(){var k=d(this),l=k.html();if(k.hasClass("sep"))return d.extend({},sep,{option:this});if(this.value&&(!a.term||c.test(l))){var h=l;k.data("icon")&&(h+=' <img src="'+k.data("icon")+'" />');d.isNumeric(k.data("count"))&&(h+='<span class="count">'+k.data("count")+"</span>");return{label:h,text:l,value:this.value,option:this}}}).toArray());else if(a.term&&this.element.data("autocomplete"))f({term:a.term,id:this.ns},function(k){e.ul.height(e.h*
k.length);return k});else{var g=this.element.children("option").map(function(){var k=d(this),l=k.html();if(k.hasClass("sep"))return d.extend({},sep,{option:this});if(this.value&&(!a.term||c.test(l))){var h=l;k.data("icon")&&(h+=' <img src="'+k.data("icon")+'" />');d.isNumeric(k.data("count"))&&(h+='<span class="count">'+k.data("count")+"</span>");return{label:h,text:l,value:this.value,option:this}}}).toArray();this.element.data("autocomplete")?f({term:"",id:this.ns},function(k){k.length&&g[g.length-
1]&&!d(g[g.length-1].option).hasClass("sep")&&g.push(sep);g=g.concat(k);e.ul.height(e.h*g.length);return g}):b(g)}}},_removeIfInvalid:function(a,b){if(!b.item){a=this.input;var c=a.val().toLowerCase(),e=!1;this.element.children("option").each(function(){if(d(this).text().toLowerCase()===c)return this.selected=e=!0,!1});e||((b=a.data("uiAutocomplete"))||(b=a.date("autocomplete")),b&&(b.term=""))}},_updatePeriodInput:function(a,b){this.label.text("");this.hidden.attr("name",this.ns+".period").val("");
var c=d.datepicker.formatDate("dd.mm.yy",new Date(a)),e=d.datepicker.formatDate("dd.mm.yy",new Date(b));a&&b?(this.hidden.val([d.datepicker.formatDate("yy-mm-dd",new Date(a)),d.datepicker.formatDate("yy-mm-dd",new Date(b))].join("--")),this.input.val(c===e?c:c+"\u2013"+e),this.label.text("=")):a?(this.hidden.val(JSON.stringify({val:d.datepicker.formatDate("yy-mm-dd",new Date(a)),op:">="})),this.input.val(c),this.label.text(">=")):b&&(this.hidden.val(JSON.stringify({val:d.datepicker.formatDate("yy-mm-dd",
new Date(b)),op:"<="})),this.label.text("<="))},_renderItem:function(a,b){return d("<li class='crm-search-ui-menu-item'>").append(d("<div>").text(b.label)).appendTo(a)},_showPeriodDialog:function(){d("#c-combobox-dialog").remove();return d('<div id="c-combobox-dialog"></div>').appendTo("body").periodDialog()},_destroy:function(){this.wrapper.remove();this.element.show()}})})(jQuery);(function(d){d.fn.periodDialog=function(a,b){function c(l){var h=g().find(".datepicker.start");h=new Date(h.datepicker("getDate"));return d.datepicker.formatDate(l,h)}function e(l){var h=g().find(".datepicker.end");h=new Date(h.datepicker("getDate"));return d.datepicker.formatDate(l,h)}function f(l,h,m){return d.datepicker.formatDate(l,new Date(h),m)}function g(){return this.data("$dialog")}if(!this.length)return this;if("getStartDate"===a)return c();if("getEndDate"===a)return e();if("formatDate"===
a)return f.apply(this,Array.prototype.slice.call(arguments,1));var k={};"object"===typeof a&&(this.data("periodDialogOptions",d.extend({start_datetime:null,end_datetime:null},a)),k=this.data("periodDialogOptions"));return function(){var l=d(".crm-dialog-search-period-wrapper.is-template").clone(),h="crm-dialog-search-period-wrapper-"+(Math.random()+"").slice(2);d(".crm-dialog-search-period-wrapper:not(.is-template)").remove();l.removeClass("is-template");l.attr("id",h);l.show();d.waDialog({html:l,
onOpen:function(m,n){m.find(".datepicker").datepicker();k.start_datetime&&m.find(".datepicker.start").datepicker("setDate",d.datepicker.parseDate("yy-mm-dd",k.start_datetime));k.end_datetime&&m.find(".datepicker.end").datepicker("setDate",d.datepicker.parseDate("yy-mm-dd",k.end_datetime));var p=m.find(".js-apply-action"),q=m.find(".js-cancel-action");p.click(function(r){r.preventDefault();r=m.find(".start").datepicker("getDate");var u=m.find(".end").datepicker("getDate");m.trigger("select",[r,u]);
n.close()});q.click(function(r){r.preventDefault();m.trigger("cancel");n.close()});n.resize()}});this.data("$dialog",d("#"+h));return this.data("$dialog")}.call(this)}})(jQuery);var CRMSettings=function(d){CRMSettings=function(a){this.$wrapper=a.$wrapper;this.$sidebar=a.$sidebar;this.$activeMenuItem=!1;this.initClass()};CRMSettings.prototype.initClass=function(){this.initMenu();this.initToggleSidebar()};CRMSettings.prototype.initToggleSidebar=function(){function a(f,g){0>g.content_uri.indexOf("/settings/")&&d("body").removeClass("noscroll");d(document).off("wa_before_load",a);e.off("click")}var b=this,c=b.$wrapper.find(".sidebar:first"),e=c.find(".js-expand-sidebar");e.length&&
(e.on("click",function(f){f.preventDefault();b.sidebarIsOpen=!b.sidebarIsOpen;c.toggleClass("sidebar-opened");e.find(".fa-arrow-right").toggleClass("fa-rotate-180");d("body").toggleClass("noscroll")}),d(document).on("wa_before_load",a))};CRMSettings.prototype.initMenu=function(){function a(f){if(e.length&&e[0]==f[0])return!1;e.length&&e.removeClass("selected");f.addClass("selected");e=f}function b(f){var g;f&&(g=c.find('a[href="'+f+'"]:first'));if(g&&g.length)a(g.closest("li"));else{f=c.find("a[href^='"+
d.crm.app_url+"']");var k=location.pathname,l=0,h=0;f.each(function(m){var n=d(this),p=n.attr("href");n=n.data("alias");var q=p.length;n&&p==n?h=m:0<=k.indexOf(p)&&q>l&&(l=q,h=m)});if(h||0===h)g=f.eq(h),a(g.closest("li"))}}var c=this.$sidebar,e=c.find("li.selected:first")||!1;e.length||b();c.on("click","li > a",function(){var f=d(this),g=f.attr("href");g&&"javascript:"!=g.substr(0,11)&&!f.hasClass("js-no-highlight")&&(a(f.closest("li")),d.crm.title.set(f.text()))})};return CRMSettings}(jQuery);var CRMSettingsCompanies=function(d){CRMSettingsCompanies=function(a){this.$wrapper=a.$wrapper;this.$footer=this.$wrapper.find(".js-footer-actions");this.$company=this.$wrapper.find(".c-company-section");this.$taxList=this.$company.find(".c-options-list");this.$logoWrapper=this.$wrapper.find(".js-logo-section");this.$submitButton=this.$wrapper.find(".js-submit-button");this.locales=a.locales;this.company_id=a.company_id;this.tax_option_template=a.tax_option_template;this.empty_class="is-empty";this.start_left=
0;this.logo=!1;this.files=[];this.initClass()};CRMSettingsCompanies.prototype.initClass=function(){var a=this;a.initTabs();a.initTaxActions();a.initLogoChange();a.initSubmit();a.initDeleteCompany();a.initTemplatesSection();a.$wrapper.on("change","input, select, textarea",function(){a.toggleButton(!0)})};CRMSettingsCompanies.prototype.initTabs=function(){var a=this.$wrapper.find(".c-tabs-wrapper"),b=this.$wrapper.find(".c-companies-wrapper"),c=b.find(".c-companies-list"),e=c.find(".c-company.selected");
(function(){function f(){d.contains(document,a[0])?g():k.off("resize",f)}function g(){var h=a.outerWidth(!0)-l-38;b.css("max-width",h+"px")}var k=d(window),l=a.find(".c-add-wrapper").outerWidth(!0);g();k.on("resize",f)})();d.crm.tabSlider({$wrapper:b,$slider:c,$activeSlide:e.length?e:!1});(function(){function f(){var k={ids:function(){var l=[];c.find(".c-company").each(function(){l.push(d(this).data("id"))});return l.join(",")}()};g&&g.abort();g=d.post("?module=settings&action=companiesSortSave",
k,function(l){}).always(function(){g=!1})}var g=!1;c.sortable({distance:10,items:"> li",axis:"x",start:function(k,l){},stop:f,onUpdate:f})})()};CRMSettingsCompanies.prototype.initTaxActions=function(){var a=this,b=a.$company.find(".js-tax-name"),c=a.$taxList;a.$company.on("click",".js-delete-option",function(e){e.preventDefault();d(this).closest("li").remove();b.find("li").length||b.attr("required",!1);a.toggleButton(!0)});a.$company.on("click",".js-add-option",function(e){e.preventDefault();d(a.tax_option_template).appendTo(c);
b.attr("required",!0);a.toggleButton(!0)});(function(){c.sortable({handler:".js-sort-toggle",helper:"clone",distance:10,items:"> li",axis:"y",start:function(e,f){},stop:function(e,f){a.toggleButton(!0)},onUpdate:function(e,f){a.toggleButton(!0)}})})()};CRMSettingsCompanies.prototype.initLogoChange=function(){function a(h){h=h[0];if(h.type.match(/^image\/(png|jpe?g|gif)$/)){var m=new FileReader;m.onload=function(n){l.attr("src",n.target.result);b.$logoWrapper.removeClass(b.empty_class)};m.readAsDataURL(h);
b.logo=h}}var b=this,c=!1,e=!1,f=b.$logoWrapper,g=f.find(".js-drop-area"),k=g.find(".js-field"),l=f.find(".js-image");g.on("drop",function(h){h.stopPropagation();h=h.originalEvent.dataTransfer.files;h.length&&(a(h),b.toggleButton(!0))});k.on("change",function(){var h=this.files;h.length&&(a(h),b.toggleButton(!0))});f.on("click",".js-delete-logo",function(h){h.preventDefault();l.attr("src","");if(h=k.attr("name")){var m=d('<input type="hidden" />').attr("name",h).val("delete");k.attr("name","").data("name",
h).after(m)}f.addClass(b.empty_class);b.logo=!1;b.toggleButton(!0)});d(document).on("myDragEnter",function(){d.contains(document,g[0])?g.addClass("is-highlighted"):d(document).off("myDragEnter",b.watcher)});d(document).on("myDragLeave",function(){d.contains(document,g[0])?g.removeClass("is-highlighted"):d(document).off("myDragLeave",b.watcher)});g.on("dragover",function(h){h.preventDefault();c?clearTimeout(c):e||(e=!0,g.addClass("is-hover"));c=setTimeout(function(){c=null;e=!1;g.removeClass("is-hover")},
100)})};CRMSettingsCompanies.prototype.initSubmit=function(){var a=this,b=a.$wrapper.find(".js-form"),c=a.$wrapper.find(".js-errors-place"),e=a.$taxList,f=!1;b.on("submit",function(g){function k(){e.find(".c-tax-option").each(function(m){var n=d(this),p=n.find(".js-type");n=n.find(".js-percent");p.attr("name","company[tax_options]["+m+"][tax_type]");n.attr("name","company[tax_options]["+m+"][tax_percent]")});return b.serializeArray()}function l(m){m=m?m:[];d.each(m,function(n,p){n=p.name;p=p.value;
var q=a.$wrapper.find('[name="'+n+'"]');q.removeClass("error");q.parent().find("span.errormsg").remove();"contact[firstname]"!==n||q.is(":visible")||(q=a.$wrapper.find(".js-contact-autocomplete"));var r=d("<span class='c-error' />").addClass("errormsg").text(p);q.length&&!q.hasClass("error")?(q.parent().append(r),q.addClass("error").one("focus click change",function(){q.removeClass("error");r.remove()})):(c.append(r),b.one("submit",function(){remove(r)}))})}g.preventDefault();if(!f){f=!0;g=k();g=
m(g);var h=d(a.locales.loading);h.insertAfter(a.$submitButton);d.ajax({url:"?module=settings&action=companiesSave",data:g,dataType:"json",processData:!1,contentType:!1,type:"POST",success:function(n){"ok"===n.status?(d(a.locales.saved_html).insertAfter(a.$submitButton),a.company_id?d.crm.content.reload():d.crm.content.load(d.crm.app_url+"settings/companies/"+n.data.id+"/")):n.errors&&l(n.errors)}}).always(function(){h.remove();f=!1});function m(n){var p=new FormData;d.each(n,function(q,r){p.append(r.name,
r.value)});d.each(a.files,function(q,r){p.append("images["+r.code+"]",r.file)});a.logo&&p.append("logo",a.logo);(n=(n=document.cookie.match(RegExp("(?:^|; )_csrf=([^;]*)")))?decodeURIComponent(n[1]):"")&&p.append("_csrf",n);return p}}});b.on("keydown keypress keyup","input",function(g){13===g.keyCode&&g.preventDefault()})};CRMSettingsCompanies.prototype.initDeleteCompany=function(){var a=this,b=!1;a.$wrapper.on("click",".js-company-delete",function(c){c.preventDefault();b||(b=!0,d.post("?module=settings&action=companyDeleteDialog",
{id:a.company_id},function(e){d.waDialog({html:e})}).always(function(){b=!1}))})};CRMSettingsCompanies.prototype.toggleButton=function(a){var b=this.$submitButton,c=this.$footer.find(".js-edit-actions");a?(b.addClass("yellow"),c.show()):(b.removeClass("yellow"),c.hide())};CRMSettingsCompanies.prototype.initTemplatesSection=function(){function a(m,n){xhr&&xhr.abort();xhr=d.post("?module=settings&action=companiesRenderParams",{company_id:n,template_id:m},function(p){g.html(p);g.find(".c-color-section").each(function(){b(d(this))});
g.find(".js-image-section").each(function(){c(d(this))})}).always(function(){xhr=!1})}function b(m){var n=m.find(".c-colors"),p=m.find(".js-color-field"),q=n.find(".is-active"),r=function(v){r=function(t){this.$wrapper=t.$wrapper;this.$field=p;this.$icon=this.$wrapper.find(".js-toggle");this.$colorPicker=this.$wrapper.find(".js-color-picker");this.farbtastic=this.is_opened=!1;this.initClass()};r.prototype.initClass=function(){function t(){q.length&&(q.removeClass("is-active"),q=!1)}var w=this;w.farbtastic=
v.farbtastic(w.$colorPicker,function(x){w.$field.val()!==x&&(t(),w.$field.val(x).change())});w.$wrapper.data("colorPicker",w);w.$field.on("change keyup",function(){var x=v(this).val();w.$icon.css("background-color",x);w.farbtastic.setColor(x)});w.$icon.on("click",function(x){x.preventDefault();w.displayToggle(!w.is_opened)});w.$field.on("focus",function(){w.is_opened||w.displayToggle(!0)});w.$field.on("keyup",t);v(document).on("keyup",w.watcher);w.watcher=function(x){v.contains(document,w.$wrapper[0])?
27===x.keyCode&&w.is_opened&&w.displayToggle(!1):v(document).off("keyup",w.watcher)}};r.prototype.displayToggle=function(t){t?(this.$wrapper.removeClass("is-hidden"),this.is_opened=!0):(this.$wrapper.addClass("is-hidden"),this.is_opened=!1)};return r}(jQuery),u=new r({$wrapper:m.find(".js-toggle-wrapper").first()});n.on("click",".js-set-color",function(v){v.preventDefault();v=d(this);q.length&&q.removeClass("is-active");v.addClass("is-active");q=v;v=v.data("color");p.val(v).change();u.is_opened&&
u.displayToggle(!1)});p.trigger("change")}function c(m){function n(w){w=w[0];if(w.type.match(/^image\/(png|jpe?g|gif)$/)){var x=new FileReader;x.onload=function(y){t.attr("src",y.target.result);m.removeClass(e.empty_class)};x.readAsDataURL(w);w={code:m.data("code"),type:"param_image",file:w};e.files.push(w);p();m.data("file",w)}}function p(){var w=m.data("file");w&&(w=e.files.indexOf(w),e.files.splice(w,1),m.data("file",!1))}var q=!1,r=!1,u=m.find(".js-drop-area"),v=u.find(".js-field"),t=m.find(".js-image");
u.on("drop",function(w){w.stopPropagation();w=w.originalEvent.dataTransfer.files;w.length&&(n(w),e.toggleButton(!0))});v.on("change",function(){var w=this.files;w.length&&(n(w),e.toggleButton(!0))});m.on("click",".js-delete-image",function(w){w.preventDefault();t.attr("src","");if(w=v.attr("name")){var x=d('<input type="hidden" />').attr("name",w).val("delete");v.attr("name","").data("name",w).after(x)}m.addClass(e.empty_class);p();e.toggleButton(!0)});d(document).on("myDragEnter",function(){d.contains(document,
u[0])?u.addClass("is-highlighted"):d(document).off("myDragEnter",e.watcher)});d(document).on("myDragLeave",function(){d.contains(document,u[0])?u.removeClass("is-highlighted"):d(document).off("myDragLeave",e.watcher)});u.on("dragover",function(w){w.preventDefault();q?clearTimeout(q):r||(r=!0,u.addClass("is-hover"));q=setTimeout(function(){q=null;r=!1;u.removeClass("is-hover")},100)})}var e=this,f=e.$wrapper.find(".c-templates-section"),g=f.find(".js-template-options-wrapper"),k=f.find(".c-templates-slider"),
l=f.find(".c-templates-list"),h=l.find(".js-template-wrapper.is-active");xhr=!1;(function(){var m=f.find(".js-template-wrapper.is-active");f.on("click",".js-template-wrapper",function(n){n.preventDefault();n=d(this);if(!n.hasClass("is-active")){var p=n.data("id");n.find(".js-field").attr("checked",!0).trigger("change");m.length&&m.removeClass("is-active");m=n.addClass("is-active");a(p,e.company_id)}})})();d.crm.tabSlider({$wrapper:k,$slider:l,$activeSlide:h.length?h:!1});f.find(".c-color-section").each(function(){b(d(this))});
f.find(".js-image-section").each(function(){c(d(this))})};return CRMSettingsCompanies}(jQuery),CRMCompanyDeleteDialog=function(d){CRMCompanyDeleteDialog=function(a){this.$wrapper=a.$wrapper;this.company_id=a.company_id;this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMCompanyDeleteDialog.prototype.initClass=function(){this.initDelete()};CRMCompanyDeleteDialog.prototype.initDelete=function(){function a(){var k={data:[],errors:[]},l=f.serializeArray();d.each(l,function(h,m){k.data.push(m)});
return k}function b(k,l){l=l?l:[];if(k){var h=Object.keys(k);d.each(h,function(m,n){l.push({name:n,value:k[n]})})}d.each(l,function(m,n){m=n.value;var p=e.$form.find('[name="'+n.name+'"]');if(p.length&&!p.hasClass("error")){var q=d("<span />").addClass("errormsg").text(m);e.$wrapper.append(q);p.addClass("error").one("focus click change",function(){p.removeClass("error");q.remove()})}})}function c(k){g||(g=!0,d.post("?module=settings&action=companyDelete",k,function(l){"ok"===l.status?d.crm.content.load(d.crm.app_url+
"settings/companies/"):b(l.errors)},"json").always(function(){g=!1;e.dialog.close()}))}var e=this,f=e.$wrapper.find("form"),g=!1;f.on("submit",function(k){k.preventDefault();k=a();k.errors.length?b(!1,k.errors):c(k.data)})};return CRMCompanyDeleteDialog}(jQuery);var CRMSettingsCurrencies=function(d){CRMSettingsCurrencies=function(a){this.$wrapper=a.$wrapper;this.$currenciesList=this.$wrapper.find(".js-currencies-list");this.$currencySelect=this.$wrapper.find(".js-add-currency");this.currencies_is_locked=a.currencies_is_locked;this.currency_template_html=a.currency_template_html;this.copy_shop_currencies_dialog_html=a.copy_shop_currencies_dialog_html;this.locales=a.locales;this.currencies=a.currencies;this.initClass()};CRMSettingsCurrencies.prototype.initClass=
function(){this.currencies_is_locked||(this.initCurrencyAdd(),this.initCurrencyRemove(),this.initCurrenciesSort(),this.initChangePrimary(),this.initCurrencyEdit());this.initShopToggle()};CRMSettingsCurrencies.prototype.initCurrencyAdd=function(){function a(c,e){c=c.toLowerCase();b.$currencySelect.find("option").each(function(){var f=d(this);f.attr("value").toLowerCase()===c&&f.attr("disabled",!!e)})}var b=this;b.$currencySelect.on("change",function(){var c=d(this),e=c.val(),f=b.currencies[e],g=f.title;
f=f.sign;c.attr("disabled",!0);c=d(b.currency_template_html);c.data("code",e);c.find(".js-name").text(g);c.find(".js-current-code").text(e);c.find(".js-sign").text(f);c.find(".js-save-currency").addClass("js-save-new");c.addClass("is-edit");b.$currenciesList.append(c);c.find(".c-rate").select()}).on("removeCurrency",function(c,e){a(e)})};CRMSettingsCurrencies.prototype.initCurrencyRemove=function(){var a=this,b=!1;a.$wrapper.on("click",".js-remove-currency",function(c){function e(){b||(b=!0,d.post("?module=settings&action=currenciesDelete",
{code:k},function(l){"ok"==l.status&&(a.$currencySelect.trigger("removeCurrency",k),f.remove())}).always(function(){b=!1}))}c.preventDefault();var f=d(this).closest(".c-currency"),g=f.data("title"),k=f.data("code");if(!k)return!1;(function(){b||(b=!0,d.waDialog.confirm({title:'<i class="fas fa-exclamation-triangle smaller state-error"></i> '+a.locales.confirm_delete_title.replace("%currency_name",g),text:a.locales.confirm_delete_text,success_button_title:a.locales.confirm_delete_button,success_button_class:"danger",
cancel_button_title:a.locales.confirm_cancel_button,cancel_button_class:"light-gray",onSuccess:function(){e()}}),b=!1)})()})};CRMSettingsCurrencies.prototype.initCurrenciesSort=function(){function a(){e&&e.abort();var f={codes:b()};e=d.post("?module=settings&action=currenciesSort",f,function(g){}).always(function(){e=!1})}function b(){var f=[];c.$currenciesList.find(".c-currency").each(function(){var g=d(this).data("code");g&&f.push(g)});return f}var c=this,e=!1;c.$wrapper.find(".js-currencies-list").sortable({distance:10,
handle:".js-sort-toggle",helper:"clone",items:"> .c-currency",axis:"y",stop:a,onUpdate:a})};CRMSettingsCurrencies.prototype.initShopToggle=function(){function a(){l.set(!1)}function b(){var h=d.waDialog({html:e.copy_shop_currencies_dialog_html}).$wrapper.find("form");h.on("submit",function(m){m.preventDefault();is_locked||(is_locked=!0,m=h.serializeArray(),d.post("?module=settings&action=currenciesShopCopy",m,function(){d.crm.content.reload()}).always(function(){is_locked=!1}))});h.on("click",".js-cancel-button",
a)}function c(h){is_locked||(is_locked=!0,d.post("?module=settings&action=currenciesShopCopy",h?{}:{disable:1},function(m){d.crm.content.reload()}).always(function(){is_locked=!1}))}var e=this,f=e.$wrapper.find(".js-shop-currency-toggle"),g=e.$wrapper.find("#shop-currency-switch");is_locked=!1;if(!f.length)return!1;var k=f.data("use-shop")||!1;g.waSwitch({change:function(h,m){is_locked||(h?k?d.waDialog.confirm({title:'<i class="fas fa-exclamation-triangle smaller state-error"></i> '+e.locales.confirm_shop_title,
text:e.locales.confirm_shop_text,success_button_title:e.locales.confirm_shop_button,success_button_class:"danger",cancel_button_title:`${e.locales.confirm_cancel_button}`,cancel_button_class:"light-gray",onSuccess:function(){c(!0)},onCancel:a}):b():c(!1))}});var l=g.waSwitch("switch")};CRMSettingsCurrencies.prototype.initChangePrimary=function(){function a(){b||(b=!0,d.post("?module=settings&action=currenciesPrimary",{},function(c){d.waDialog({html:c,options:{onChange:function(e){d.crm.content.reload()}}})}).always(function(){b=
!1}))}var b=!1;this.$wrapper.on("click",".js-change-primary",function(c){c.preventDefault();a()})};CRMSettingsCurrencies.prototype.initCurrencyEdit=function(){var a=this.$currencySelect;this.$wrapper.on("click",".js-edit-currency",function(b){b.preventDefault();d(this).closest(".c-currency").addClass("is-edit")});this.$wrapper.on("click",".js-save-currency",function(b){function c(h){h=h?h:[];d.each(h,function(m,n){m=n.value;var p=e.find('[name="'+n.name+'"]'),q=d("<span />").addClass("errormsg").text(m);
p.length&&!p.hasClass("error")&&(p.closest("div").append(q),p.addClass("error").one("focus click",function(){p.removeClass("error");q.remove()}))})}b.preventDefault();var e=d(this).closest(".c-currency"),f=!1;b="?module=settings&action=currenciesSave";0<e.find(".js-save-new").length&&(b="?module=settings&action=currenciesAdd");if(!f){f=!0;var g=e.find(".js-rate"),k=g.val();k=k.replace(",",".");String(k).split(".");if(!(0<k)||9999999<k)return g.addClass("error").one("click",function(){g.removeClass("error")}),
f=!1;var l={code:e.data("code"),rate:k};d.post(b,l,function(h){"ok"===h.status?e.toggleClass("is-edit").find(".js-rate-text").text(k):h.errors&&c(h.errors)}).always(function(){f=!1;a.attr("disabled",!1);a.find(":selected").attr("disabled",!0);a.prop("selectedIndex",0)})}});this.$wrapper.on("click",".js-cancel",function(b){b.preventDefault();b=d(this).closest(".c-currency");0<b.find(".js-save-new").length?(b.remove(),a.attr("disabled",!1),a.prop("selectedIndex",0)):b.removeClass("is-edit")});this.$wrapper.on("keyup",
".js-rate",function(b){13===b.keyCode&&d(this).closest(".c-currency").find(".js-save-currency").trigger("click")})};return CRMSettingsCurrencies}(jQuery),CRMSettingsCurrenciesPrimary=function(d){CRMSettingsCurrenciesPrimary=function(a){this.$wrapper=a.$wrapper;this.$toggle=this.$wrapper.find(".js-currencies-toggle");this.dialog=this.$wrapper.data("dialog");this.currency_code=a.currency_code;this.initClass()};CRMSettingsCurrenciesPrimary.prototype.initClass=function(){var a=this,b=!1;a.$wrapper.on("click",
".js-change-currency",function(c){c.preventDefault();var e=a.$toggle.val();e!==a.currency_code?b||(b=!0,d.post("?module=settings&action=currenciesPrimarySave",{code:e},function(f){"ok"==f.status&&(a.dialog.options.onChange(e),a.dialog.close())}).always(function(){b=!1})):a.dialog.close()})};return CRMSettingsCurrenciesPrimary}(jQuery);var CRMSettingsFunnel=function(d){CRMSettingsFunnel=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$stagesSection=this.$wrapper.find(".c-stages-section");this.$stages=this.$stagesSection.find(".c-stages-list");this.funnel_id=a.funnel_id;this.stage_html=a.stage_html;this.locales=a.locales;this.initClass()};CRMSettingsFunnel.prototype.initClass=function(){var a=this;a.initSave();a.initDelete();a.initColorSection();a.initStagesSection();a.initNoAccessList();a.$form.on("input",
function(){a.toggleButton(!0)})};CRMSettingsFunnel.prototype.initColorSection=function(){function a(h){var m=g.find(".c-stage .c-ornament .svg-icon"),n=m.length;if(4===h.length||7===h.length){var p=(new d.crm.color(h)).getRange();b.val(p[0]);c.val(p[1]);m.each(function(q){q=p.getColor(Math.floor(100*(q+1)/n));var r=d(this),u=r.find("svg");u.length?u.find("polygon").css("fill",q):r.data("color",q)})}}var b=this.$wrapper.find(".js-start-color-field"),c=this.$wrapper.find(".js-end-color-field"),e=this.$wrapper.find(".c-color-section .c-colors"),
f=this.$wrapper.find(".c-color-section .js-color-field"),g=this.$wrapper.find(".c-color-section .c-stages"),k=e.find(".is-active"),l=function(h){l=function(m){this.$wrapper=m.$wrapper;this.$field=f;this.$icon=this.$wrapper.find(".js-toggle");this.$colorPicker=this.$wrapper.find(".js-color-picker");this.farbtastic=this.is_opened=!1;this.initClass()};l.prototype.initClass=function(){function m(){k.length&&(k.removeClass("is-active"),k=!1)}var n=this;n.farbtastic=h.farbtastic(n.$colorPicker,function(p){n.$field.val()!==
p&&(m(),n.$field.val(p).change())});n.$wrapper.data("colorPicker",n);n.$field.on("change keyup",function(){var p=h(this).val();n.$icon.css("background-color",p);n.farbtastic.setColor(p)});n.$icon.on("click",function(p){p.preventDefault();n.displayToggle(!n.is_opened)});n.$field.on("click",function(){n.displayToggle(!n.is_opened)});n.$field.on("keyup",m)};l.prototype.displayToggle=function(m){m?(this.$wrapper.removeClass("is-hidden"),this.is_opened=!0):(this.$wrapper.addClass("is-hidden"),this.is_opened=
!1)};return l}(jQuery);e.on("click",".js-set-color",function(h){h.preventDefault();h=d(this);k.length&&k.removeClass("is-active");h.addClass("is-active");k=h;h=h.data("color");f.val(h).change()});f.on("change",function(){a(f.val())});new l({$wrapper:this.$wrapper.find(".js-toggle-wrapper").first()});f.change();d.crm.renderSVG(this.$wrapper)};CRMSettingsFunnel.prototype.initStagesSection=function(){function a(f){function g(k){function l(){var q=parseInt(m.val()),r=parseInt(p.val()),u="";0<q&&0<r&&
(u=q*r);n.val(u)}function h(q){q?(k.addClass("is-extended"),m.focus()):(k.removeClass("is-extended"),m.val(""),n.val(""),b.toggleButton(!0))}var m=k.find(".js-visible-time-field"),n=k.find(".js-hidden-time-field"),p=k.find(".js-time-period-select");k.on("click",".js-show-time",function(){h(!0)});k.on("click",".js-remove-limit",function(){h(!1)});m.on("change",l);p.on("change",l);m.on("keyup",function(){var q=d(this),r=q.val();r=parseInt(r.replace(",","").replace(".",""));isNaN(r)?q.val(""):r?q.val(r):
q.val("")});(function(){var q=n.val();q&&0<parseInt(q)&&(0===parseInt(q)%24?(p.val("24"),m.val(parseInt(q)/24)):p.val("1"))})()}f.find(".js-time-limit-wrapper").each(function(){g(d(this))})}var b=this,c=b.$stagesSection,e=b.$stages;e.on("click",".js-delete-stage",function(f){f.preventDefault();1<b.$stages.find("li").length&&d(this).closest(".c-stage").remove();b.toggleButton(!0)});e.on("keydown keypress keyup","input",function(f){13===f.keyCode&&f.preventDefault()});c.on("click",".js-add-stage",function(f){f.preventDefault();
f=d(b.stage_html);b.$stages.append(f);a(f);b.toggleButton(!0)});e.sortable({distance:10,handle:".js-sort-toggle",helper:"clone",items:"> li",axis:"y",start:function(f,g){},stop:function(f,g){b.toggleButton(!0)}});a(e)};CRMSettingsFunnel.prototype.initSave=function(){function a(){var l=c.$form.serializeArray();c.$stages.find("li").each(function(h){var m=d(this),n=m.data("id");l.push({name:"stages["+h+"][name]",value:m.find(".js-name-field").val()});n&&l.push({name:"stages["+h+"][id]",value:n})});return l}
function b(l){f.insertAfter(k);d.post("?module=settings&action=funnelSave",l,function(h){"ok"===h.status&&(f.remove(),g.insertAfter(k),d.crm.content.load(d.crm.app_url+"settings/funnels/"+h.data.id+"/"))},"json").always(function(){e=!1})}var c=this,e=!1,f=d('<span class="c-notice"><i class="fas fa-spinner wa-animation-spin speed-1000 js-loading"></i></span>'),g=d('<span class="c-notice"><i class="fas fa-check"></i></span>'),k=c.$wrapper.find(".js-funnel-save-button");c.$form.on("submit",function(l){l.preventDefault();
!e&&(l=a())&&(e=!0,b(l))})};CRMSettingsFunnel.prototype.initDelete=function(){function a(){var e={id:b.funnel_id};c||(c=!0,d.post("?module=settings&action=funnelDelete",e,function(f){d.crm.content.load(d.crm.app_url+"settings/funnels/")},"json").always(function(){c=!1}))}var b=this,c=!1;b.$wrapper.on("click",".js-delete-funnel",function(e){e.preventDefault();d.waDialog.confirm({title:`<i class=\"fas fa-exclamation-triangle smaller state-error\"></i> ${b.locales.delete_confirm_title}?`,text:b.locales.delete_confirm_text,
success_button_title:b.locales.delete_confirm_button,success_button_class:"danger",cancel_button_title:`${b.locales.delete_cancel_button}`,cancel_button_class:"light-gray",onSuccess:a})})};CRMSettingsFunnel.prototype.toggleButton=function(a){var b=this.$wrapper.find(".js-funnel-save-button"),c=this.$wrapper.find(".js-hidden-actions");a?(b.removeClass("green").addClass("yellow"),c.show()):(b.removeClass("yellow").addClass("green"),c.hide())};CRMSettingsFunnel.prototype.initNoAccessList=function(){var a=
this.$wrapper.find(".js-no-access-wrapper");a.on("click",".js-show-access-list",function(b){b.preventDefault();a.addClass("is-active")});a.on("click",".js-hide-access-list",function(b){b.preventDefault();a.removeClass("is-active")})};return CRMSettingsFunnel}(jQuery);var CRMSettingsFunnels=function(d){CRMSettingsFunnels=function(a){this.$wrapper=a.$wrapper;this.initClass()};CRMSettingsFunnels.prototype.initClass=function(){this.initTabs()};CRMSettingsFunnels.prototype.initTabs=function(){var a=this.$wrapper.find(".js-funnels-tabs"),b=this.$wrapper.find(".c-funnels-wrapper"),c=b.find(".c-funnels-list"),e=c.find(".c-funnel.selected");(function(){function f(){d.contains(document,a[0])?g():k.off("resize",f)}function g(){var h=a.outerWidth(!0)-l-38;b.css("max-width",
h+"px")}var k=d(window),l=a.find(".c-add-wrapper").outerWidth();g();k.on("resize",f)})();d.crm.tabSlider({$wrapper:b,$slider:c,$activeSlide:e.length?e:!1});(function(){function f(){var k={ids:function(){var l=[];c.find(".c-funnel").each(function(){l.push(d(this).data("id"))});return l.join(",")}()};g&&g.abort();g=d.post("?module=settings&action=funnelsSortSave",k,function(l){}).always(function(){g=!1})}var g=!1;c.sortable({distance:10,items:"> li",axis:"x",stop:f,onUpdate:f})})()};return CRMSettingsFunnels}(jQuery);var crmSettingsField=function(d){var a=function(b){this.$wrapper=b.$wrapper;this.initClass()};a.prototype.initClass=function(){this.initSortable();this.bindEvents()};a.prototype.initSortable=function(){function b(l){return l.find(".field").map(function(){return d.trim(d(this).data("id"))||""}).toArray()}function c(l,h){g&&(g.abort(),g=null);return d.post(l,h,function(){g=null})}var e=d.crm.app_url+"?module=settings&action=fieldSaveSort",f,g=!1,k=this.$wrapper.find(".js-other-fields");k.sortable({helper:"clone",
handle:".sort",items:"> .field",axis:"y",tolerance:"pointer",start:function(l,h){f=h.item.index()},stop:function(l,h){f!=h.item.index()&&(l=b(k),c(e,{fields:l}))},onUpdate:function(l){l=b(k);c(e,{fields:l})}})};a.prototype.bindEvents=function(){var b=!1,c=d.crm.app_url+"?module=settings&action=fieldEdit",e=null;this.$wrapper.on("click",".crm-edit-field-link",function(){var f=d(this);b||(b=!0,e&&(e.abort(),e=null),e=d.post(c,{id:f.data("id")||null},function(g){d.waDialog({html:g,onOpen:function(k,
l){l.resize()},onClose:function(k,l){b=!1}})}))})};return a}(jQuery);var crmSettingsFieldEdit=function(d){var a=function(b){this.$wrapper=b.$wrapper;this.$form=this.$wrapper.find("form");this.dialog=this.$wrapper.data("dialog");this.field=b.field||null;this.locales=b.locales;this.initClass()};a.prototype.initClass=function(){var b=this.$form.find(".crm-local-input-wrapper").eq(0).find("input"),c=b.val();b.focus().val("").val(c);this.bindEvents();this.editSubFields();this.field||this.initIDAutoFiller()};a.prototype.bindEvents=function(){var b=this.$form;b.on("change",
".crm-field-type-select",function(){var c=d(this).val(),e=b.find(".crm-values-textarea-wrapper").hide();"Select"!==c&&"Radio"!==c||e.show()});b.on("change",".crm-add-name-another-language-wrapper",function(){let c=d(this).find("option:selected"),e=c.data("id"),f=c.data("nameRegion"),g=b.find(".crm-local-input-wrapper"),k=g.clone();k.find("input").attr("name","name["+e+"]").val("").attr("disabled",!1).attr("data-main-locale","").attr("data-error-id",e).removeClass("error").end().find(".crm-name-region").text(f).end().find(".state-error-hint").text("").end().insertAfter(g);
k.find("input").focus();c.closest("li").hide();0>=b.find(".crm-add-name-another-language:not(:hidden)").length&&b.find(".crm-add-name-another-language-wrapper").hide()});this.initSubmit();this.field&&(this.field.editable?this.initDeleteLink():this.initDisableLink())};a.prototype.initSubmit=function(){var b=this,c=null;b.$form.submit(function(e){e.preventDefault();c&&(c.abort(),c=null);c=b.save()})};a.prototype.initDeleteLink=function(){var b=this,c=d.crm.app_url+"?module=settings&action=fieldDeleteConfirm";
b.$wrapper.on("click",".crm-field-delete",function(e){e.preventDefault();d.post(c,{id:b.field.id},function(f){d.waDialog({html:f,options:{edit_dialog:b.dialog},onOpen:function(){b.dialog.$wrapper.hide()}})})})};a.prototype.initDisableLink=function(){var b=this,c=b.$form,e=null;c.on("click",".crm-field-enable,.crm-field-disable",function(f){f.preventDefault();e&&(e.abort(),e=null);f={enable:d(this).hasClass("crm-field-enable")};e=d.post(c.attr("action"),f,function(g){"ok"==g.status&&(b.dialog.close(),
location.href=d.crm.app_url+"settings/field/")})})};a.prototype.save=function(){var b=this,c=b.$form,e=d(".crm-dialog-edit-field-wrapper").find(".js-save"),f=d('<span class="icon loading" style="vertical-align: middle;margin-left: 10px;"><i class="fas fa-spinner fa-spin"></i></span>');d(".loading").remove();e.prop("disabled",!0);var g=!0;c.find(".errormsg").text("");c.find(".state-error").removeClass("state-error");d('[name$="[localized_names]"]').each(function(){var k=d(this);!k.val()&&0>=k.parents(".template").length&&
k.closest("tr").find('[name$="[_disabled]"]:checked').length&&(g=!1,k.addClass("state-error").parent().append(d('<span class="errormsg"></span>').text(b.locales.field_is_required)))});if(!g)return e.attr("disabled",!1),c.one("input, keydown",".state-error",function(){d(this).removeClass("state-error").nextAll(".state-error-hint:first, .errormsg:first").empty()}),!1;f.appendTo(e.parent());return d.post(c.attr("action"),c.serialize(),function(k){"ok"==k.status&&(d(".loading").remove(),d('<i class="fas fa-check-circle" style="vertical-align: middle;margin-left: 10px;"></i>').appendTo(e.parent()),
setTimeout(function(){d.crm.content.reload();b.dialog.close()},1E3));if("ok"!==k.status&&k.errors){e.removeProp("disabled");d(".loading").remove();for(var l=0,h=k.errors.length;l<h;l+=1){var m=k.errors[l];if("string"===typeof m)c.find(".errormsg.crm-common-errors").append(m);else if("object"===typeof m)for(var n in m)if(m.hasOwnProperty(n)){var p=c.find('[data-error-id="'+n+'"]');p.addClass("state-error");p.nextAll(".state-error-hint:first").text(m[n])}}c.one("input, keydown",".state-error",function(){d(this).removeClass("state-error").nextAll(".state-error-hint:first, .errormsg:first").empty()});
c.find("[type=submit]").attr("disabled",!1)}})};a.prototype.initIDAutoFiller=function(){var b,c=this.$form,e=c.find('input[name^="name["][data-main-locale]'),f=c.find('input[name="id_val"]'),g=null;f.on("keydown.check_edited",function(){var k=d(this);k.data("val",k.val())}).on("keyup.check_edited",function(){var k=d(this);k.val()&&k.val()!=k.data("value")&&(k.off(".check_edited"),k.data("edited",1))});if(!f.prop("disabled")&&!f.data("edited"))c.on("keydown.crm-id-auto-filler",'input[name^="name["]',
function(){var k=d(this),l=c.find('[type="submit"]'),h=f.next(".loading");if(k.data("main-locale")||!e.val())f.prop("disabled")||f.data("edited")?c.off(".crm-id-auto-filler"):(l.prop("disabled",!0),h=h.length?h:d('<i class="icon16 loading"></i>'),h.insertAfter(f),b&&clearTimeout(b),b=setTimeout(function(){var m=function(){g&&(g.abort(),g=null);b&&clearTimeout(b);l.prop("disabled",!1);h.remove()};f.data("edited")?m():g=d.post(d.crm.app_url+"?module=settings&action=fieldTransliterate",c.find('input[name^="name["]').serialize(),
function(n){m();"ok"!==n.status||f.data("edited")||f.val(n.data)},"json")},300))})};a.prototype.editSubFields=function(){function b(k){var l=d(".crm-dialog-edit-field-wrapper").find(".js-save");k?l.addClass("yellow").removeAttr("disabled"):l.removeClass("yellow")}var c=this,e=d(".crm-dialog-edit-field-wrapper"),f=e.find(".subfields-list > .ui-sortable"),g=1;f.sortable({items:".field-row",handle:".js-subfield-sort",axis:"y",update:function(k){b(!0)}});f.on("click","a.js-add-subfield",function(){var k=
f.find(".field-row.template");k=k.clone().insertBefore(k).removeClass("template").removeClass("hidden");c.dialog.resize();var l="__"+g;g++;k.find("[name]").each(function(){var h=d(this);h.attr("name",h.attr("name").replace(/%FID%/g,l))});k.data("fieldId",l);k.find("select.type-selector").change();b(!0);return!1});e.on("click",".js-edit-subfield",function(k){k.preventDefault();d(this).closest("tr").addClass("editor-on").removeClass("editor-off");b(!0)});e.on("click",".js-delete-subfield",function(k){k.preventDefault();
var l=d(this).closest("tr");l.hasClass("just-added")&&l.remove();d.crm.confirm.show({title:c.locales.delete_subfield_title,text:c.locales.delete_subfield_text,button:c.locales.delete_subfield_button,onConfirm:function(){l.addClass("editor-off").removeClass("editor-on");var h=l.find('input:hidden[name$="[_disabled]"]').attr("name").replace("[_disabled]","[_deleted]");d(".js-field-form-edit").append(d('<input type="hidden" name="" value="1">').attr("name",h));l.children().children(":not(label)").remove();
l.find("label").addClass("gray").addClass("strike");b(!0)}})});f.on("click","a.add-item",function(){c.dialog.resize()});e.on("change","select.type-selector",function(){var k=d(this),l=k.closest("tr"),h=l.closest("table"),m=l.find(".field-advanced-settings").html('<span class="icon"><i class="fas fa-spinner fa-spin"></i></span>');d.post(d.crm.app_url+"?module=settings&action=fieldEditor",{ftype:k.val(),fid:l.data("fieldId"),parent:h.data("fieldParent")||"",prefix:h.data("fieldPrefix")},function(n){m.html(n);
b(!0)})});e.on("change",":checkbox, .name-input",function(){b(!0)});e.on("input change",function(){b(!0)})};return a}(jQuery);var crmSettingsFieldEditSubfieldValues=function(d){var a=function(c){this.$wrapper=d(".subfields-list");this.$hidden=c.hidden;this.$dialog_link=c.dialog_link;this.dialog_url=c.dialog_url;this.locales=c.locales;this.initClass()};a.prototype.initClass=function(){this.initValuesLink()};a.prototype.initValuesLink=function(){var c=this,e=!1;c.$wrapper.find(c.$dialog_link).on("click",function(){e||(e=!0,d.get(c.dialog_url,function(f){d.waDialog({html:f,onOpen:function(g,k){k.resize();c.editValues(g,k);
c.initSubmit(g,k)},onClose:function(g,k){e=!1}})}))})};a.prototype.editValues=function(c,e){var f=c.find("form");c.on("click",".s-add-rule",function(){var g=c.find(".s-new-rule");if(g.length){var k=g.clone();k.removeClass("s-new-rule").show().insertBefore(g);k.find('input[name^="parent"]').attr("disabled",!1);k.find(".s-add-value").click();b(c);k=parseInt(g.find('input[name="parent[]"]').val(),10)+1||1;g.find('input[name="parent[]"]').val(k);g.find('input[name^="parent_value"]').attr("name","parent_value["+
k+"]");g.find('input[name^="value"]').attr("name","value["+k+"][0]");e.resize()}return!1});c.on("click",".s-add-value",function(){var g=d(this).parents("table:first").find(".s-new-value");if(g.length){var k=g.clone();k.addClass("sortable").removeClass("s-new-value").show().insertBefore(g);k.find("input").attr("disabled",!1);k=g.find("input:first").attr("name");var l=k.lastIndexOf("["),h=(parseInt(k.substr(l+1),10)||0)-1;k=k.substr(0,l)+"["+h+"]";g.find("input:first").attr("name",k)}e.resize();return!1});
c.on("click",".s-delete-value",function(){var g=d(this),k=g.attr("data-id");g=g.parents("tr:first");var l=g.parents("table:first");k&&f.append('<input type="hidden" name="delete[]" value="'+k+'">');g.remove();l.find("tr.sortable:first").length||l.parents("div.field:first").remove();e.resize();return!1});b(c);this.$hidden.val()?c.find("select.otherwise-options").val("hide"):c.find("select.otherwise-options").val("input")};a.prototype.initSubmit=function(c,e){var f=this,g=c.find("form"),k=c.find(".js-save-values"),
l=d('<span class="icon loading custom-ml-4"><i class="fas fa-spinner fa-spin"></i></span>'),h=d('<span class="icon yes custom-ml-4"><i class="icon fas fa-check"></i>');g.submit(function(m){m.preventDefault();k.prop("disabled",!0);d(".loading").remove();l.appendTo(k.parent());var n=!0;c.find(".errormsg").remove();c.find(".state-error").removeClass("state-error");c.find('[name^="parent_value["]:not(:disabled)').each(function(){this.value||(n=!1,d(this).addClass("state-error").after(d('<span class="errormsg"></span>').text(f.locales.field_is_required)))});
c.find('[name^="value["]:not(:disabled)').each(function(){this.value||(n=!1,d(this).addClass("state-error").after(d('<span class="errormsg"></span>').text(f.locales.field_is_required)))});if(!n)return d("#s-field-values").closest(".dialog").find(".dialog-buttons :submit").attr("disabled",!1),!1;"input"==c.find("select.otherwise-options").val()?f.$hidden.val(""):f.$hidden.val("1").closest("td").find('input:checkbox[name$="[required]"]').attr("checked",!1);d.post(g.attr("action"),g.serialize()).done(function(p){d(".loading").remove();
h.appendTo(k.parent());"ok"==p.status&&(f.$dialog_link.parents(".field-advanced-settings").find(".show-when-modified").show(),f.$dialog_link.parents(".field-advanced-settings").find(".hide-when-modified").hide(),setTimeout(function(){e.close()},1E3))})})};var b=function(c,e){c.find(".value table>tbody").sortable({distance:5,helper:"clone",items:"tr.sortable",opacity:.75,axis:"y",tolerance:"pointer"})};return a}(jQuery);var crmSettingsFieldDeleteConfirm=function(d){var a=function(b){this.$wrapper=b.$wrapper;this.$form=this.$wrapper.find("form");this.dialog=this.$wrapper.data("dialog");this.edit_dialog=this.dialog.options.edit_dialog;this.initClass()};a.prototype.initClass=function(){this.bindEvents()};a.prototype.bindEvents=function(){var b=this,c=b.$form;b.$form.find(".crm-cancel").click(function(){b.dialog.close();b.edit_dialog.$wrapper.show()});c.submit(function(e){e.preventDefault();b.save()})};a.prototype.save=
function(){var b=this,c=b.$form;d.post(c.attr("action"),c.serialize(),function(){b.dialog.close();b.edit_dialog.close();location.href=d.crm.app_url+"settings/field/"})};return a}(jQuery);var CRMSettingsSources=function(d){CRMSettingsSources=function(a){this.$wrapper=a.$wrapper;this.messages=a.messages||{};this.messages.enable=this.messages.enable||"";this.messages.disable=this.messages.disable||"";this.source_type=a.source_type;this.initClass()};CRMSettingsSources.prototype.initClass=function(){this.initTabs();this.initWebFormLinks();this.initSourcesClick();this.initDisableLinks()};CRMSettingsSources.prototype.initTabs=function(){var a=this.$wrapper,b=function(e){var f=a.find('.c-tab[data-type="'+
e+'"]'),g=a.find('.c-tab-content[data-type="'+e+'"]');a.find(".c-tab.selected").removeClass("selected");a.find(".c-tab-content").hide();f.addClass("selected");g.show();d.crm.storage.set("crm/settings/source_tab",e)},c=d.crm.storage.get("crm/settings/source_tab");c||="email";this.source_type&&(c=this.source_type);b(c);a.on("click",".c-tab-link",function(e){e.preventDefault();b(d(this).closest(".c-tab").data("type"))})};CRMSettingsSources.prototype.initWebFormLinks=function(){this.$wrapper.on("click",
".js-c-web-form-link",function(){d.crm.storage.set("crm/settings/web_form_referrer","settings/sources")})};CRMSettingsSources.prototype.initSourcesClick=function(){var a=this.$wrapper,b=d('<span class="icon size-16 loading " ><i class="fas fa-spinner fa-spin"></i></span>');a.on("click",".c-source-details a",function(){d(this).parent().append(b)})};CRMSettingsSources.prototype.initDisableLinks=function(){var a=this.$wrapper.find(".js-c-disable-link"),b=null,c=d.crm.app_url+"?module=settingsSource&action=disable";
a.each(function(){var e=d(this),f=e.closest(".c-source"),g=f.data("id"),k=f.find(".c-loading");e.find("#switch-"+g).waSwitch({ready:function(l){let h=l.$wrapper.siblings("label");l.$label=h;l.active_text=h.data("active-text");l.inactive_text=h.data("inactive-text")},change:function(l,h){k.show();h.disable(!0);b&&b.abort();b=d.post(c,{id:g,disabled:l?0:1}).done(function(m){"ok"===m.status&&(l?(h.$label.text(h.inactive_text),f.removeClass("c-is-disabled")):(h.$label.text(h.active_text),f.addClass("c-is-disabled")),
h.disable(!1))}).always(function(){b=null;k.hide()})}})})};CRMSettingsSources.deleteSource=function(a,b){b=b.messages||{};d.crm.confirm.show({title:b.delete_confirm_title,text:b.delete_confirm_text,button:b.delete_confirm_button,onConfirm:function(){var c=d.crm.app_url+"?module=settings&action=sourceDelete",e=d(".crm-confirm-dialog"),f=e.find(".crm-loading").show(),g=e.find(".js-confirm-dialog").attr("disabled",!0);d.post(c,{id:a}).always(function(){d.crm.content.load(d.crm.app_url+"settings/sources/");
f.hide();g.attr("disabled",!1)});return!1}})};return CRMSettingsSources}(jQuery);var CRMSettingsSourceEmail=function(d){CRMSettingsSourceEmail=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$button=this.$form.find("[type=submit]");this.source=a.source||{};this.messages=a.messages||{};this.changed=!1;this.submit_xhr=null;this.initClass()};CRMSettingsSourceEmail.prototype.initClass=function(){this.initBlockToggles();this.initSubmit();this.initSecureCheckboxes();this.initChangeListeners();this.initIButton();0<this.source.id&&this.initDeleteLink();
this.initBlocks()};CRMSettingsSourceEmail.prototype.initSecureCheckboxes=function(){var a=this.$form.find(".c-secure-checkbox");a.click(function(){var b=d(this);b.is(":checked")&&a.not(b).attr("checked",!1)})};CRMSettingsSourceEmail.prototype.initChangeListeners=function(){var a=this,b=a.$form;b.on("change","input,textarea,select",function(c){a.setFormChanged();c.isTrigger||CRMSettingsSourceEmail.clearValidateErrors(b)});b.on("keyup","input:text,input:password,textarea",function(c){a.setFormChanged();
c.isTrigger||CRMSettingsSourceEmail.clearValidateErrors(b)})};CRMSettingsSourceEmail.prototype.initBlockToggles=function(){this.initDealCreateToggle()};CRMSettingsSourceEmail.prototype.initDealCreateToggle=function(){var a=this.$wrapper;a.find(".crm-source-settings-block-create_deal").on("toggled",function(b,c){b=a.find(".js-responsible-section").data("block_object");c?b.reload({}):b.reload({funnel_id:0})})};CRMSettingsSourceEmail.prototype.setFormChanged=function(a){(a=void 0!==a?a:!0)?this.$button.addClass("yellow"):
this.$button.removeClass("yellow");this.changed=a};CRMSettingsSourceEmail.prototype.clearValidateErrors=function(){var a=this.$form;a.find(".error").removeClass("error");a.find(".crm-errors-block").remove()};CRMSettingsSourceEmail.prototype.initSubmit=function(){var a=this,b=a.$form,c=a.$wrapper.find(".crm-form-buttons").find(".crm-loading"),e=a.$button,f=b.find(".crm-success-status"),g=d.crm.app_url+"?module=settingsSource&action=save";CRMSettingsSourceEmail.clearValidateErrors(b);b.submit(function(k){function l(){CRMSettingsSourceEmail.showValidateErrors(b,
{"":a.messages.connection_failed})}function h(){c.hide();e.prop("disabled",!1);a.submit_xhr=null}k.preventDefault();k=b.serializeArray();k.push({name:"id",value:0<a.source.id?a.source.id:a.source.provider});c.show();e.prop("disabled",!0);a.submit_xhr&&a.submit_xhr.abort();a.submit_xhr=d.post(g,k,null,"json").done(function(m){m?"ok"!=m.status?CRMSettingsSourceEmail.showValidateErrors(b,m.errors||{}):(a.setFormChanged(!1),f.show().fadeOut(500,function(){m.data.source?d.crm.content.load(d.crm.app_url+
"settings/sources/"+m.data.source.id+"/"):d.crm.content.reload()})):(h(),l())}).fail(l).always(h)})};CRMSettingsSourceEmail.prototype.initDeleteLink=function(){var a=this;a.$wrapper.find(".crm-delete-source-link").click(function(b){b.preventDefault();CRMSettingsSources.deleteSource(a.source.id,{messages:a.messages})})};CRMSettingsSourceEmail.prototype.initIButton=function(){var a=this;a.$wrapper.find("#js-ibutton").each(function(){var b=d(this),c=b.closest(".fields-group").find(".js-crm-block");if(b.data("iButtonInit"))return b;
a.$switch=b.waSwitch({ready:function(e){let f=e.$wrapper.siblings("label");e.$label=f;e.active_text=f.data("active-text");e.inactive_text=f.data("inactive-text")},change:function(e,f){e?(f.$label.text(f.active_text),b.find(".js-ibutton").attr("checked",!0),c.slideDown(350)):(f.$label.text(f.inactive_text),b.find(".js-ibutton").attr("checked",!1),c.slideUp(350))}})})};CRMSettingsSourceEmail.prototype.initBlocks=function(){var a=this.$wrapper,b=a.find(".js-deal-section");a=a.find(".js-responsible-section");
b=b.data("block_object");a=a.data("block_object");b.setResponsibleBlock(a)};CRMSettingsSourceEmail.clearValidateErrors=function(a){a.find(".state-error").removeClass("state-error");a.find(".crm-errors-block").remove()};CRMSettingsSourceEmail.showValidateErrors=function(a,b){var c={};d.each(b||{},function(e,f){"params"===e?d.each(f,function(g,k){c["source[params]["+g+"]"]=d.isArray(k)?k:[k]}):c[e?"source["+e+"]":""]=d.isArray(f)?f:[f]});CRMSettingsSourceEmail.clearValidateErrors(a);d.each(c,function(e,
f){var g=d('<div class="crm-errors-block"></div>');e=e?a.find('[name="'+e+'"]'):d();e.addClass("state-error");d.each(f,function(k,l){g.append('<span class="errormsg text-red">'+l+"</span>")});e.length?e.after(g):a.find(".crm-common-errors-block").append(g)})};return CRMSettingsSourceEmail}(jQuery);var CRMSettingsSourceEmailConnectionTestBlock=function(d){CRMSettingsSourceEmailConnectionTestBlock=function(a){this.$wrapper=a.$wrapper;this.source=a.source||{};this.url=a.url||d.crm.app_url+"?module=settingsSource&action=testConnection";this.initClass()};CRMSettingsSourceEmailConnectionTestBlock.prototype.initClass=function(){var a=this,b=a.$wrapper,c=b.find(".c-test-connection-button-block"),e=c.find(".c-loading"),f=c.find(".c-test-connection-success-message"),g=c.find(".c-test-connection-fail-message"),
k=null,l=b.find(".js-connection-settings-input"),h=b.find(".js-connection-settings-checkbox"),m=b.find(".c-test-connection-button"),n=function(){var p=a.url;k&&k.abort();f.hide();g.hide();e.show();l.attr("disabled",!0);var q=function(){g.show()};d.post(p,function(){var r=function(v){return{name:d.trim(v.attr("name")).match(/^source\[params\]\[(.+)\]$/)[1],value:v.val()}},u=[];l.each(function(){u.push(r(d(this)))});h.each(function(){var v=d(this);v.is(":checked")&&u.push(r(v))});0<a.source.id?u.push({name:"id",
value:a.source.id}):u.push({name:"id",value:a.source.provider});return u}(),null,"json").done(function(r){r&&"ok"==r.status?f.show():(q(),CRMSettingsSourceEmail.showValidateErrors(b,r.errors||{}))}).fail(q).always(function(){k=null;l.attr("disabled",!1);e.hide()})};(function(){var p=l.length,q=function(){var y=0;l.each(function(){0<d.trim(d(this).val()).length&&(y+=1)});return 0>=a.source.id?y==p:y==p-1},r=function(){var y=[];l.each(function(){y.push(d.trim(d(this).val()))});h.each(function(){y.push(d(this).is(":checked")?
"1":"0")});return y.join("@")},u=r(),v=function(){var y=r(),z=y!==u;u=y;return z},t=function(){c.show();m.show();f.hide();g.hide()},w=function(){q()?v()&&t():c.hide()},x=null;l.on("change",w).on("keydown",function(){x&&clearTimeout(x);x=setTimeout(function(){w()},250)});h.on("change",function(){v()&&t()})})();(function(){m.click(function(p){p.preventDefault();n()})})()};return CRMSettingsSourceEmailConnectionTestBlock}(jQuery);var CRMSettingsSourceIm=function(d){CRMSettingsSourceIm=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$button=this.$form.find("[type=submit]");this.source=a.source||{};this.messages=a.messages||{};this.changed=!1;this.submit_xhr=null;this.initClass()};CRMSettingsSourceIm.prototype.initClass=function(){this.initBlockToggles();this.initSubmit();this.initChangeListeners();0<this.source.id&&this.initDeleteLink()};CRMSettingsSourceIm.prototype.initChangeListeners=function(){var a=
this,b=a.$form;b.on("change","input,textarea,select",function(c){a.setFormChanged();c.isTrigger||CRMSettingsSourceIm.clearValidateErrors(b)});b.on("keyup","input:text,input:password,textarea",function(c){a.setFormChanged();c.isTrigger||CRMSettingsSourceIm.clearValidateErrors(b)})};CRMSettingsSourceIm.prototype.initBlockToggles=function(){this.initVerifyToggle();this.initDealCreateToggle()};CRMSettingsSourceIm.prototype.initVerifyToggle=function(){this.$wrapper.find(".js-crm-value-switch .switch").each(function(a,
b){d(b).waSwitch({ready:function(c){let e=c.$wrapper.siblings("label"),f=c.$wrapper.siblings("input"),g=c.$wrapper.find("input");c.$label=e;c.$input=g;c.$input_hidden=f;c.active_text=e.data("active-text");c.inactive_text=e.data("inactive-text")},change:function(c,e){var f=e.$wrapper.closest(".fields-group").find(".params");c?(f.slideDown(),e.$input_hidden.val(1),e.$input.val(1),e.$label.text(e.active_text)):(f.slideUp(),e.$input_hidden.val(0),e.$input.val(0),e.$label.text(e.inactive_text))}})})};
CRMSettingsSourceIm.prototype.initDealCreateToggle=function(){var a=this.$wrapper;a.find(".crm-source-settings-block-create_deal").on("toggled",function(b,c){b=a.find(".js-responsible-section").data("block_object");c?b.reload({}):b.reload({funnel_id:0})})};CRMSettingsSourceIm.prototype.setFormChanged=function(a){(a=void 0!==a?a:!0)?this.$button.addClass("yellow"):this.$button.removeClass("yellow");this.changed=a};CRMSettingsSourceIm.prototype.clearValidateErrors=function(){var a=this.$form;a.find(".error").removeClass("error");
a.find(".crm-errors-block").remove()};CRMSettingsSourceIm.prototype.initSubmit=function(){var a=this,b=a.$form,c=a.$wrapper.find(".crm-form-buttons").find(".crm-loading"),e=a.$button,f=b.find(".crm-success-status"),g=d.crm.app_url+"?module=settingsSource&action=save";CRMSettingsSourceIm.clearValidateErrors(b);b.submit(function(k){k.preventDefault();k=b.serializeArray();k.push({name:"id",value:0<a.source.id?a.source.id:a.source.provider});c.show();e.prop("disabled",!0);a.submit_xhr&&a.submit_xhr.abort();
a.submit_xhr=d.post(g,k,null,"json").done(function(l){"ok"===l.status?(a.setFormChanged(!1),f.show().fadeOut(500,function(){l.data.source?d.crm.content.load(d.crm.app_url+"settings/sources/"+l.data.source.id+"/"):d.crm.content.reload()})):CRMSettingsSourceIm.showValidateErrors(b,l.errors||{})}).always(function(){c.hide();e.prop("disabled",!1);a.submit_xhr=null})})};CRMSettingsSourceIm.prototype.initDeleteLink=function(){var a=this;a.$wrapper.find(".crm-delete-source-link").click(function(b){b.preventDefault();
CRMSettingsSources.deleteSource(a.source.id,{messages:a.messages})})};CRMSettingsSourceIm.prototype.initIButton=function(){var a=this;a.$wrapper.find(".c-checkbox .js-ibutton").each(function(){var b=d(this),c=b.parent();$switch_wrapper=d('<span class="switch smaller"></span>');$switch_wrapper.prependTo(c);b.clone().appendTo($switch_wrapper);b.remove();a.$switch=$switch_wrapper.waSwitch({ready:function(e){let f=e.$wrapper.siblings("label");e.$label=f;e.inactive_text=f.eq(0).text();e.active_text=f.eq(1).text();
f.eq(0).removeClass("gray");f.eq(1).hide()},change:function(e,f){e?f.$label.text(f.active_text):f.$label.text(f.inactive_text)}})})};CRMSettingsSourceIm.clearValidateErrors=function(a){a.find(".state-error").removeClass("state-error");a.find(".crm-errors-block").remove()};CRMSettingsSourceIm.showValidateErrors=function(a,b){var c={};d.each(b||{},function(e,f){"params"===e?d.each(f,function(g,k){c["source[params]["+g+"]"]=d.isArray(k)?k:[k]}):c[e?"source["+e+"]":""]=d.isArray(f)?f:[f]});CRMSettingsSourceIm.clearValidateErrors(a);
d.each(c,function(e,f){var g=d('<div class="crm-errors-block"></div>');e=e?a.find('[name="'+e+'"]'):d();e.addClass("state-error");d.each(f,function(k,l){g.append('<span class="errormsg error">'+l+"</span>")});e.length?e.after(g):a.find(".crm-common-errors-block").append(g)})};return CRMSettingsSourceIm}(jQuery);var CRMSettingsSourceWithContactBlock=function(d){CRMSettingsSourceWithContactBlock=function(a){this.$wrapper=a.$wrapper;this.segments_list_stages=a.segments_list_stages||{};this.init()};CRMSettingsSourceWithContactBlock.prototype.init=function(){this.initAddToSegments()};CRMSettingsSourceWithContactBlock.prototype.initAddToSegments=function(){var a=this.$wrapper,b=this.segments_list_stages,c=a.find(".c-segments-ul-fold-link"),e=a.find(".c-segments-ul");c.click(function(){var f=c.data("state");f=
"fold"===f?"unfold":"fold";var g=(b[f]||{}).link_text||"";c.data("state",f).find(".c-link-text").text(g);"fold"===f?e.slideUp():e.slideDown()})};return CRMSettingsSourceWithContactBlock}(jQuery);var CRMSettingsSourceCreateDealBlock=function(d){CRMSettingsSourceCreateDealBlock=function(a){this.$wrapper=a.$wrapper;this.$funnel=this.$wrapper.find(".js-funnel-id");this.$stage=this.$wrapper.find(".js-stage-id");this.url=d.crm.app_url+"?module=settingsSourceBlock&action=createDeal";this.source=a.source||{};this.ns="."+d.trim(this.$wrapper.attr("id"));this.id=a.id;this.namespace=a.namespace||"";this.class_id=a.class_id||"";this.responsible_block=null;this.initClass();this.$wrapper.data("block_object",
this)};CRMSettingsSourceCreateDealBlock.prototype.setResponsibleBlock=function(a){this.responsible_block=a};CRMSettingsSourceCreateDealBlock.prototype.initClass=function(){var a=this;a.$funnel.on("change"+a.ns,function(){var b=a.$stage.closest(".dropdown"),c=b.find(".js-visible-link");b.find(".menu.with-icons").remove();c.find(".funnel-state").remove();c.prepend('<span class="icon size-16"><i class="fas fa-spinner fa-spin"></i></span>');a.reload()});a.initFunnelsSelect();a.initStagesSelect()};CRMSettingsSourceCreateDealBlock.prototype.initFunnelsSelect=
function(){var a=this.$wrapper.find(".js-funnels-list"),b=a.find(".js-visible-link"),c=a.find(".js-field"),e=a.find(".menu");e.on("click","a",function(){var f=d(this);b.html(f.html());e.find(".selected").removeClass("selected");f.closest("li").addClass("selected");e.hide();setTimeout(function(){e.removeAttr("style")},200);f=f.data("id");c.val(f).trigger("change")})};CRMSettingsSourceCreateDealBlock.prototype.initStagesSelect=function(){var a=this.$wrapper.find(".js-stages-list"),b=a.find(".js-visible-link"),
c=a.find(".js-field"),e=a.find(".menu");e.on("click","a",function(){var f=d(this);b.html(f.html());e.find(".selected").removeClass("selected");f.closest("li").addClass("selected");e.hide();setTimeout(function(){e.removeAttr("style")},200);f=f.data("id");c.val(f).trigger("change")})};CRMSettingsSourceCreateDealBlock.prototype.reload=function(){var a=this,b=a.$stage,c=a.url,e=a.responsible_block;b={id:a.id,funnel_id:a.$funnel.val(),stage_id:b.val(),namespace:a.namespace};var f=d.Deferred(),g=d.Deferred();
d.when(f,g).done(function(k,l){l&&k.setResponsibleBlock(l)});d.get(c,b,function(k){k=d("<div>").html(k);var l=k.find("."+a.class_id);a.$wrapper.replaceWith(l);f.resolve(l.data("block_object"));a.destroy();k.remove()});e?e.reload({funnel_id:b.funnel_id},function(k){g.resolve(k)}):g.resolve()};CRMSettingsSourceCreateDealBlock.prototype.destroy=function(){var a=this;a.$funnel.off(a.ns);a.$wrapper.removeData("block_object");d.each(a,function(b){delete a[b]})};return CRMSettingsSourceCreateDealBlock}(jQuery);var CRMSettingsSourceResponsibleBlock=function(d){CRMSettingsSourceResponsibleBlock=function(a){this.$wrapper=a.$wrapper;this.$group=this.$wrapper.find(".crm-group-id");this.$user=this.$wrapper.find(".crm-user");this.$user_id=this.$wrapper.find(".crm-responsible-contact_id");this.$user_info=this.$wrapper.find(".crm-user-info-block");this.$user_delete_link=this.$user_info.find(".crm-delete-link");this.url=d.crm.app_url+"?module=settingsSourceBlock&action=responsible";this.ns="."+d.trim(this.$wrapper.attr("id"));
this.source=a.source||{};this.funnel_id=this.source.funnel_id;this.namespace=a.namespace||"";this.class_id=a.class_id||"";this.initClass();this.$wrapper.data("block_object",this)};CRMSettingsSourceResponsibleBlock.prototype.initClass=function(){var a=this,b=a.$wrapper,c=a.$group,e=a.$user,f=a.$user_id,g=a.$user_delete_link,k=a.$user_info,l=f.val(),h=function(){e.show().attr("disabled",!1).attr("required",!0)},m=function(){e.hide().attr("disabled",!0).attr("required",!1)};c.on("change"+a.ns,function(){var n=
d(this),p=n.parents(".crm-fields").find(".js-group-hint");f.val("");"personally"===n.val()?h():(m(),k.hide());"personally"===n.val()||""===n.val()?p.hide():p.show();0<n.val()&&f.val(-n.val());l!=f.val()&&(b.trigger("changeResponsibleUser",[l,f.val()]),l=f.val())});g.on("click"+a.ns,function(n){n.preventDefault();f.val("");h();k.hide()});e.autocomplete({source:d.crm.app_url+"?module=autocomplete&type=user&funnel_id="+a.funnel_id,minLength:0,html:!0,focus:function(){return!1},select:function(n,p){e.val("");
if(0>=p.item.rights)return!1;m();k.show();k.find(".crm-user-icon").css("background-image","url("+p.item.photo_url+")");k.find(".crm-user-name").text(p.item.name).attr("title",p.item.name);f.val(p.item.id);l!=f.val()&&(b.trigger("changeResponsibleUser",[l,f.val()]),l=f.val());return!1}}).data("ui-autocomplete")._renderItem=function(n,p){var q=d("<li />");q.addClass("ui-menu-item-html").append("<div>"+p.value+"</div>").appendTo(n);0<a.funnel_id&&!p.rights&&(q.addClass("is-locked"),q.on("click"+a.ns,
function(r){r.preventDefault();r.stopPropagation()}));return q};e.on("focus"+a.ns,function(){e.data("uiAutocomplete").search(e.val())})};CRMSettingsSourceResponsibleBlock.prototype.reload=function(a,b){var c=this,e=this.$user_info,f=d('<span class="icon loading"><i class="fas fa-spinner fa-spin"></i></span>'),g=c.url;e.is(":visible")&&(c.$user_delete_link.hide(),f.css({marginTop:"-16px",marginRight:"-16px",float:"right"}));e.after(f);a=a||{};a.namespace=c.namespace;"undefined"===typeof a.funnel_id&&
(a.funnel_id=c.funnel_id);a.responsible_contact_id=c.$user_id.val();a.group_id=c.$group.val();f.show();d.get(g,a,function(k){k=d("<div>").html(k);var l=k.find("."+c.class_id);c.$wrapper.replaceWith(l);l=l.data("block_object");b&&b(l);k.remove();c.destroy()})};CRMSettingsSourceResponsibleBlock.prototype.destroy=function(){var a=this;a.$user_delete_link.off(a.ns);a.$group.off(a.ns);a.$wrapper.removeData("block_object");a.$user.data("ui-autocomplete")&&(a.$user.autocomplete("destroy"),a.$user.removeData("ui-autocomplete"));
d.each(a,function(b){delete a[b]})};return CRMSettingsSourceResponsibleBlock}(jQuery);var CRMSettingsForms=function(d){CRMSettingsForms=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$button=this.$form.find("[type=submit]");this.submit_xhr=null;this.initClass()};CRMSettingsForms.prototype.initClass=function(){};return CRMSettingsForms}(jQuery);var crmSettingsForm=function(d){crmSettingsForm=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find(".crm-form-settings-form");this.$form_fields=this.$wrapper.find(".crm-form-fields");this.$form_available_fields=this.$wrapper.find(".crm-available-fields");this.$confirmation_checkbox=this.$wrapper.find(".crm-confirmation-checkbox");this.$confirmation_enable_text=this.$wrapper.find(".crm-confirmation-enable-text");this.$email_confirm_block=this.$wrapper.find(".crm-form-email-confirm-block");
this.$back_button=this.$wrapper.find(".crm-form-header .js-back-button");this.$create_deal_block_wrapper=this.$wrapper.find(".crm-form-settings-block-form_create_deal");this.$button=this.$form.find("[type=submit]");this.$delete_link=this.$wrapper.find(".crm-delete-form-link");this.$copy=this.$wrapper.find(".js-copy");this.$iframe_textarea=this.$wrapper.find(".crm-iframe-code");this.$available_deal_related_field=this.$form_available_fields.find('.crm-form-field[data-form-field-type="deal"]').add(this.$form_available_fields.find('.crm-form-field[data-id="!deal_description"]')).add(this.$form_available_fields.find('.crm-form-field[data-id="!deal_attachments"]'));
this.$edit_dialog_template=this.$wrapper.find('.crm-settings-form-edit-field-wrapper[data-template="1"]');this.$paragraph_edit_dialog_template=this.$wrapper.find('.crm-settings-form-paragraph-edit-wrapper[data-template="1"]');this.$agreement_checkbox_edit_dialog_tempalte=this.$wrapper.find('.c-settings-form-agreement-checkbox-edit-wrapper[data-template="1"]');this.referrer=d.crm.storage.get("crm/settings/web_form_referrer");d.crm.storage.del("crm/settings/web_form_referrer");this.form=a.form||{};
this.form.params=this.form.params||{};this.form.params.fields=this.form.params.fields||{};this.available_fields=a.available_fields||{};this.lang=a.lang;this.messages=a.messages||{};a=a.default_checked_fields||[];if(0>=this.form.id&&"settings/sources"===this.referrer){var b=a.indexOf("password");0<=b?a[b]="!deal_description":a.push("!deal_description")}this.default_checked_fields=a;this.changed=!1;this.submit_xhr=null;this.initClass()};crmSettingsForm.prototype.initClass=function(){this.initDealCreateCheckbox();
this.renderDealDescription();this.bindEvents();this.initIButtons();this.initAddNewFieldLink();this.initAvailableFields();this.initDeleteFieldLinks();this.initPreviewButton();this.initFormWidthInput();this.initFields();this.initSubmit();this.initDeleteLink();this.initSortable();this.initTextEditor();this.initCopySmartyHelper();this.initIframeTextarea();this.initMessagesBlock();this.initCancelLink();this.initBlocks()};crmSettingsForm.prototype.renderDealDescription=function(a){var b=this.$form_fields.find('[data-id="!deal_description"]').find("textarea");
a||=this.getField("!deal_description");!a||0>=a.checked||!b.length||(a.redactor?b.data("redactor")?(a=b.redactor("core.editor"))&&0<a.length&&a[0].attr("placeholder",b.attr("placeholder")):d.crm.initWYSIWYG(b,{focus:!1,buttons:["bold","italic","underline","link"],plugins:[],maxHeight:100,minHeight:100}):(b.data("redactor")&&b.redactor("core.destroy"),b.show()))};crmSettingsForm.prototype.bindEvents=function(){var a=this;a.$form.on("change","input,textarea,select",function(b){a.setFormChanged();b.isTrigger||
a.clearValidateErrors()});a.$form.on("keyup","input:text,textarea",function(b){a.setFormChanged();b.isTrigger||a.clearValidateErrors()});a.$form.find(".crm-iframe-code-block-toggle").click(function(){a.$iframe_textarea.toggle()})};crmSettingsForm.prototype.initDealCreateCheckbox=function(){var a=this,b=a.referrer,c=function(e){var f=a.$wrapper.find(".js-responsible-section").data("block_object");e?(a.$available_deal_related_field.removeClass("crm-disabled"),a.$wrapper.find(".js-hint-about-deal-fields").hide(),
a.$wrapper.find(".js-hint-about-deal-fields").next().addClass("crm-top-bordered"),f.reload({})):(a.$available_deal_related_field.each(function(){var g=d(this).data("id");a.getFormField(g).find(".crm-delete-field-link").trigger("click")}),a.$available_deal_related_field.addClass("crm-disabled"),a.$wrapper.find(".js-hint-about-deal-fields").show(),a.$wrapper.find(".js-hint-about-deal-fields").next().removeClass("crm-top-bordered"),f.reload({funnel_id:0}))};a.$create_deal_block_wrapper.on("toggled",
function(e,f){c(f,!0)});0>=a.form.id&&"settings/sources"===b&&(a.$create_deal_block_wrapper.find(":checkbox").attr("checked",!0).trigger("change"),c(!0,!1))};crmSettingsForm.prototype.setFormChanged=function(a){(a=void 0!==a?a:!0)?this.$button.addClass("yellow"):this.$button.removeClass("yellow");this.changed=a};crmSettingsForm.prototype.initPreviewButton=function(){var a=this.$wrapper,b=a.find(".crm-form-preview-submit-button-caption-input"),c=a.find(".crm-form-preview-submit-button"),e=function(f){f?
(b.show(),c.hide(),b.val(c.val())):(b.hide(),c.show())};c.click(function(){e(!0)});b.blur(function(){c.val(b.val());e(!1)}).keyup(function(f){f.preventDefault();13==f.keyCode?(c.val(b.val()),e(!1)):27==f.keyCode&&e(!1)})};crmSettingsForm.prototype.initFormWidthInput=function(){var a=this.$wrapper,b=a.find(".crm-form-width-input"),c=a.find(".crm-form-preview-block");b.keyup(function(e){13==e.keyCode&&(b.val(Math.max(Math.min(parseInt(b.val(),10)||0,600),200)),c.width(b.val()))})};crmSettingsForm.prototype.initTextEditor=
function(){var a=this,b=a.$form.find('[name="form[params][confirm_mail_body]"]');b.waEditor({focus:!1,buttons:["formatting","bold","italic","link"],plugins:["fontcolor","fontsize","fontfamily"],minHeight:200,callbacks:{keydown:function(c){},change:function(){b.waEditor("sync");a.setFormChanged()}},lang:a.lang})};crmSettingsForm.prototype.initMessagesBlock=function(){var a=this,b=a.$wrapper,c=b.find(".c-settings-messages-block");b=b.find(".js-deal-section");a.renderToVariantSelectors();c.on("loadEditor",
function(){a.renderToVariantSelectors()});b.on("changeResponsibleUser",function(){a.renderToVariantSelectors()})};crmSettingsForm.prototype.renderToVariantSelectors=function(){var a=this.$wrapper.find(".c-settings-messages-block"),b=this.getField("email"),c=b&&0<b.checked,e=function(f,g){var k=f.closest("label");g?(f.data("checked",f.is(":checked")),f.prop("disabled",!0).prop("checked",!1)):f.prop("disabled",!1).prop("checked",f.data("checked"));f.is(":checked")?k.addClass("bold"):k.removeClass("bold")};
a.find(".c-message-to-selector").each(function(){var f=d(this),g=f.find(".c-label");f=f.find(".c-message-to-variants-list");var k=f.find(':checkbox[data-id="client"]');e(k,!c);var l=[];f.find(":checkbox:checked:not(:disabled)").each(function(){var h=d(this).closest("li");l.push(h.find(".c-variant-name-text").text())});l=0<l.length?l.join(", "):g.data("initial_text");g.text(l)})};crmSettingsForm.prototype.getField=function(a,b){var c=this.form.params.fields,e=c.length,f=null;b="undefined"===typeof b?
1:parseInt(b,10)||0;if(0>=b)return null;for(var g=0;g<e;g+=1)if(c[g].id==a&&c[g].checked==b){f=c[g];break}if(!f)return f;f.required=f.required||"";f.captionplace=f.captionplace||"left";f.caption=f.caption||"string"===typeof f.caption?f.caption:f.name;f.placeholder=f.placeholder||"";return f};crmSettingsForm.prototype.getAvailableField=function(a){if(this.available_fields[a]){a=d.extend({},this.available_fields[a]);if("!horizontal_rule"===a.id||"!paragraph"===a.id)a.captionplace="none";return a}return null};
crmSettingsForm.prototype.updateAvailableField=function(a,b){this.available_fields[a]&&d.extend(this.available_fields[a],b)};crmSettingsForm.prototype.addField=function(a,b,c){b=parseInt(b,10)||0;0>=b||!c||(this.deleteField(a,b),c=d.extend({},c,{id:a,checked:b}),this.form.params.fields.push(c))};crmSettingsForm.prototype.deleteField=function(a,b){var c=this.form.params.fields,e=c.length;b=parseInt(b,10)||0;for(var f=[],g=0;g<e;g+=1)c[g].id==a&&c[g].checked==b||f.push(c[g]);b=0;e=f.length;for(g=0;g<
e;g+=1)f[g].id==a&&(b+=1,f[g].checked=b);this.form.params.fields=f};crmSettingsForm.prototype.updateField=function(a,b,c){0>=b||(b=this.getField(a,b),b=d.extend(b,c),this.form.params.fields[a]=b,this.setFormChanged())};crmSettingsForm.prototype.renderField=function(a,b){var c=this.getField(a,b),e=this.$form_fields.find('.crm-form-field:not(.crm-form-field-template)[data-id="'+a+'"][data-checked="'+b+'"]');if(c)if(e.length||(e=this.$form_fields.find('.crm-form-field-template.crm-form-field-template[data-id="'+
a+'"]').clone(),e.removeClass("crm-form-field-template"),e.attr("data-checked",b),e.insertBefore(this.$form_fields.find(".crm-form-field-template:first")),e.show()),"!paragraph"===c.id)e.find(".crm-paragraph").html(c.text||"");else{a=e.find(".crm-caption");b=a.html;var f=(f=c.caption)&&(""+f).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");b.call(a,"<label>"+f+(c.required&&"!captcha"!==c.id?" *":"")+"</label>");e.removeClass("crm-caption-style-none crm-caption-style-above").addClass("crm-caption-style-"+
c.captionplace);e.find(":input:eq(0)").prop("placeholder",c.placeholder||"");"password"===c.id&&e.find(":input:eq(1)").prop("placeholder",c.placeholder_confirm||"");"!deal_description"===c.id&&this.renderDealDescription(c)}else e.remove()};crmSettingsForm.prototype.initFields=function(){var a=this;a.$form_fields.on("click",".crm-caption-col, .crm-input-col",function(b){a.editField(d(this).closest(".crm-form-field"))})};crmSettingsForm.prototype.editField=function(a){var b=a.data("id");a=a.data("checked");
if("!horizontal_rule"!==b){var c={html:"",id:b,checked:a,settingsForm:this};a="!agreement_checkbox"===b?this.$agreement_checkbox_edit_dialog_tempalte.clone():"!paragraph"===b?this.$paragraph_edit_dialog_template.clone():this.$edit_dialog_template.clone();a.removeAttr("data-template").attr("id","crm-settings-dialog-wrapper-"+b);a.appendTo("body");a.show();c.html=a;"!agreement_checkbox"===b?new crmSettingsFormAgreementCheckboxEditDialog(c):"!paragraph"===b?new crmSettingsFormParagraphEditDialog(c):
new crmSettingsFormFieldEditDialog(c)}};crmSettingsForm.prototype.initSubmit=function(){var a=this,b=a.$form,c=b.find(".crm-loading"),e=b.find(".crm-success-status");b.on("keypress","input",function(f){13==f.keyCode&&f.preventDefault()});b.submit(function(f){f.preventDefault();f=b.serializeArray();var g=[];d.each(a.form.params.fields,function(k,l){if(0<l.checked){var h=g.length;d.each(l,function(m,n){"html"!==m&&(g[h]=g[k]||{},g[h][m]=n)})}});f.push({name:"form[params][fields]",value:JSON.stringify(g)});
a.clearValidateErrors();c.show();a.$button.prop("disabled",!0);a.submit_xhr&&a.submit_xhr.abort();a.submit_xhr=d.post(b.attr("action"),f).done(function(k){"ok"!==k.status?(a.showValidateErrors(k.errors||{}),c.hide(),a.$button.prop("disabled",!1)):(e.show().fadeOut(500),d.crm.content.load(d.crm.app_url+"settings/form/"+k.data.form.id).then(function(){c.hide();a.$button.prop("disabled",!1);a.setFormChanged(!1)}))}).fail(function(){a.showValidateErrors({"":a.messages.unknown_server_error});c.hide();
a.$button.prop("disabled",!1)}).always(function(){})})};crmSettingsForm.prototype.clearValidateErrors=function(){var a=this.$form;a.find(".state-error").removeClass("state-error");a.find(".crm-errors-block").remove()};crmSettingsForm.prototype.showValidateErrors=function(a){var b=this.$form,c={};d.each(a||{},function(e,f){"params"===e?d.each(f,function(g,k){c["form[params]["+g+"]"]=d.isArray(k)?k:[k]}):c[e?"form["+e+"]":""]=d.isArray(f)?f:[f]});this.clearValidateErrors();d.each(c,function(e,f){var g=
d('<div class="crm-errors-block"></div>');e=e?b.find('[name="'+e+'"]'):d();e.addClass("state-error");d.each(f,function(k,l){g.append('<span class="errormsg">'+l+"</span>")});e.length?e.after(g):b.find(".crm-common-errors-block").append(g)})};crmSettingsForm.prototype.initDeleteLink=function(){var a=this,b=a.messages||{};a.$delete_link.click(function(c){c.preventDefault();d.crm.confirm.show({title:b.delete_confirm_title,text:b.delete_confirm_text,button:b.delete_confirm_button,onConfirm:function(){var e=
d(".crm-confirm-dialog"),f=e.find(".crm-loading").show(),g=e.find(".js-confirm-dialog").attr("disabled",!0);d.post(d.crm.app_url+"?module=settings&action=formDelete",{id:a.form.id}).always(function(){d.crm.content.load(d.crm.app_url+"settings/form");f.hide();g.attr("disabled",!1)});return!1}})})};crmSettingsForm.prototype.initSortable=function(){function a(){for(var c=b.form.params.fields,e=c.length,f={},g=[],k=b.$form_fields.find(".crm-form-field:not(.crm-form-field-template)"),l=0;l<e;l+=1)f[c[l].id+
"-"+c[l].checked]=l;k.each(function(){var h=d(this),m=h.data("id");h=h.data("checked");g.push(c[f[m+"-"+h]])});b.form.params.fields=g;b.setFormChanged()}var b=this;b.$form_fields.sortable({distance:5,helper:"clone",items:".crm-form-field:not(:hidden)",opacity:.75,handle:".sort",tolerance:"pointer",containment:b.$form_fields,stop:a,onUpdate:a})};crmSettingsForm.prototype.initDeleteFieldLinks=function(){var a=this;a.$wrapper.on("click",".crm-delete-field-link",function(){var b=d(this).closest(".crm-form-field");
a.deleteFormField(b)})};crmSettingsForm.prototype.deleteFormField=function(a){if(!(0>=a.length)){var b=this,c=a.data("id"),e=a.data("checked"),f=b.getAvailableField(c);b.$form_available_fields.find('.crm-form-field[data-id="'+c+'"]').removeClass("crm-disabled");b.deleteField(c,e);a.remove();f&&b.updateAvailableField(c,{checked:f.checked-1});"email"===c&&(b.disableIButton(b.$confirmation_checkbox),b.$confirmation_checkbox.attr("disabled",!0),b.$confirmation_enable_text.show(),b.$form_available_fields.find('.crm-form-field[data-id="password"]').addClass("crm-disabled"),
a=b.getFormField("password"),b.deleteFormField(a),b.renderToVariantSelectors());"company"===c&&b.$form_available_fields.find(".crm-form-field[data-person-enabled=0][data-company-enabled=1]").each(function(){var g=d(this),k=g.data("id");k=b.getFormField(k);b.deleteFormField(k);g.addClass("crm-disabled")});b.setFormChanged()}};crmSettingsForm.prototype.getFormField=function(a,b){var c='.%clz%[data-id="%id%"]%extra%:not(.%not_clz%)';a=[["%clz%","crm-form-field"],["%id%",a],["%extra%",void 0!==b?'[data-id="'+
b+'"]':""],["%not_clz%","crm-form-field-template"]];b=0;for(var e=a.length;b<e;b+=1)c=c.replace(a[b][0],a[b][1]);return this.$form_fields.find(c)};crmSettingsForm.prototype.initAvailableFields=function(){var a=this,b=a.default_checked_fields,c=a.$form_available_fields;c.on("click",".crm-form-field:not(.crm-disabled)",function(e){a.addFormField(d(this))});0>=a.form.id&&0<b.length&&d.each(b,function(e,f){e=c.find('.crm-form-field[data-id="'+f+'"]:not(.crm-disabled)');a.addFormField(e)})};crmSettingsForm.prototype.addFormField=
function(a){if(!(0>=a.length)){var b=a.data("id"),c=this.getAvailableField(b);this.$form_available_fields.hide();var e=c.checked+1;c.is_multi||a.addClass("crm-disabled");this.getField(c.id,e)||this.addField(b,e,c);this.updateAvailableField(b,{checked:e});"email"===b&&(this.$confirmation_enable_text.hide(),this.enableIButton(this.$confirmation_checkbox),this.$confirmation_checkbox.attr("disabled",!1),(a=this.getAvailableField("password"))&&0>=a.checked&&this.$form_available_fields.find('.crm-form-field[data-id="password"]').removeClass("crm-disabled"));
"company"===b&&this.$form_available_fields.find(".crm-form-field.crm-disabled[data-person-enabled=0][data-company-enabled=1]").removeClass("crm-disabled");this.renderField(b,e);"!paragraph"===b&&(b=this.$form_fields.find('.crm-form-field[data-id="'+b+'"][data-checked="'+e+'"]'),this.editField(b));this.setFormChanged();this.renderToVariantSelectors()}};crmSettingsForm.prototype.initAddNewFieldLink=function(){function a(e){d.contains(document,c[0])?27===e.keyCode&&c.is(":visible")&&c.hide():d(document).off("keypress",
a)}function b(e){if(d.contains(document,c[0])){var f=d.contains(c[0],e.target);e=c[0]===e.target;!c.is(":visible")||e||f||c.hide()}else d(document).off("keypress",b)}var c=this.$form_available_fields;this.$wrapper.on("click",".crm-add-new-field-link",function(e){e.stopPropagation();c.toggle()});d(document).on("keydown",a).on("click",b)};crmSettingsForm.prototype.initIButtons=function(){var a=this;a.$wrapper.find("#js-ibutton").each(function(){if(d(this).data("iButtonInit"))return d(this);a.$switch=
d(this).waSwitch({ready:function(b){let c=b.$wrapper.siblings("label");b.$label=c;b.active_text=c.data("active-text");b.inactive_text=c.data("inactive-text")},change:function(b,c){b?(a.$switch.has(a.$confirmation_checkbox).length&&(a.$email_confirm_block.slideDown(300),a.$confirmation_checkbox.attr("checked",!0)),c.$label.text(c.active_text)):(a.$switch.has(a.$confirmation_checkbox).length&&(a.$email_confirm_block.slideUp(300),a.$confirmation_checkbox.attr("checked",!1)),c.$label.text(c.inactive_text))}})})};
crmSettingsForm.prototype.disableIButton=function(){var a=this.$switch.waSwitch("switch");a.set(!1);a.disable(!0)};crmSettingsForm.prototype.enableIButton=function(){this.$switch.waSwitch("switch").disable(!1)};crmSettingsForm.prototype.initCopySmartyHelper=function(){this.$copy.on("click",function(){var a=d(this),b=a.data("content"),c=d("<input>");d("body").append(c);c.val(b).select();document.execCommand("copy");c.remove();a.html('<i class="fas fa-check-circle"></i>');setTimeout(function(){a.html('<i class="fas fa-copy"></i>')},
2E3)})};crmSettingsForm.prototype.initIframeTextarea=function(){var a=this;a.$iframe_textarea.click(function(){a.$iframe_textarea.select()})};crmSettingsForm.prototype.initCancelLink=function(){var a=this.referrer;this.$wrapper.on("click",".js-c-cancel-link",function(b){b.preventDefault();"settings/sources"==a?(d.crm.storage.set("crm/settings/source_tab","form"),d.crm.content.load(d.crm.app_url+"settings/sources/")):d.crm.content.load(d.crm.app_url+"settings/form/")})};crmSettingsForm.prototype.initBlocks=
function(){var a=this.$wrapper,b=a.find(".js-deal-section");a=a.find(".js-responsible-section");b=b.data("block_object");a=a.data("block_object");b.setResponsibleBlock(a)};return crmSettingsForm}(jQuery);var crmSettingsFormFieldEditDialog=function(d){var a=function(b){var c=this,e=b.onClose;b.onClose=function(g,k){e&&e(g,k)};var f=b.onOpen;b.onOpen=function(g,k){f&&f(g,k);c.$wrapper=g;c.$form=c.$wrapper.find("form");c.$button=c.$form.find("[type=submit]");c.id=b.id;c.checked=b.checked;c.settingsForm=b.settingsForm;c.dialog=k;c.initClass()};d.waDialog(b)};a.prototype.initClass=function(){var b=this.dialog.$block,c=this.settingsForm.getField(this.id,this.checked);d.each(c,function(g,k){"id"===g?d(".crm-field-id",
b).find(".value").text(c.name+" (ID="+k+")"):"name"!==g&&(g=d(".crm-field-"+g,b).find(".value").find(":input"),g.is(":checkbox")?g.prop("checked",!!k):g.is(":radio")?g.filter('[value="'+k+'"]').prop("checked",!0):g.val(k))});var e=function(g){d(".crm-field-"+g,b).hide().find(":input").attr("disabled",!0)},f=function(g){d(".crm-field-"+g,b).show().find(":input").attr("disabled",!1)};"Checkbox"!==c.type?f("captionplace"):e("captionplace");c.placeholder_need?f("placeholder"):e("placeholder");c.placeholder_need&&
"password"===c.id?f("placeholder_confirm"):e("placeholder_confirm");c.required_always?e("required"):f("required");"!deal_description"==c.id?f("redactor"):e("redactor");this.bindEvents()};a.prototype.bindEvents=function(){var b=this,c=b.$form,e=b.settingsForm.getField(b.id,b.checked);c.submit(function(f){f.preventDefault();c.find(":input[name*=params]:not(:disabled)").each(function(){var g=d(this),k=g.attr("name").replace("params[","").replace("]",""),l=g.val();g.is(":checkbox")?e[k]=g.is(":checked")?
!0:!1:g.is(":radio")?g.is(":checked")&&(e[k]=l):e[k]=l});b.settingsForm.updateField(b.id,b.checked,e);b.settingsForm.renderField(b.id,b.checked);b.dialog.close()});b.$form.on("change","input,textarea,select",function(){b.setFormChanged()});b.$form.on("keyup","input:text,textarea",function(){b.setFormChanged()})};a.prototype.setFormChanged=function(){this.$button.addClass("yellow")};return a}(jQuery);var crmSettingsFormParagraphEditDialog=function(d){var a=function(b){var c=this,e=b.onClose;b.onClose=function(g,k){e&&e(g,k);d(".redactor-dropdown").remove()};var f=b.onOpen;b.onOpen=function(g,k){f&&f(g,k);c.$wrapper=g;c.$textarea=c.$wrapper.find(".crm-paragraph-textarea");c.$button=c.$wrapper.find("[type=button]");c.id=b.id;c.checked=b.checked;c.settingsForm=b.settingsForm;c.dialog=k;c.initClass()};new CRMDialog(b)};a.prototype.initClass=function(){var b=this.$textarea,c=this.settingsForm.getField(this.id,
this.checked);b.val(c&&c.text||"");this.initWYSIWYG();this.initSaveButton()};a.prototype.initWYSIWYG=function(){var b=this,c=b.$textarea,e=b.settingsForm.getField(b.id,b.checked);d.crm.initWYSIWYG(c,{focus:!0,changeCallback:function(){b.setFormChanged()}});c.val(e.text||"");c.redactor("code.set",e.text||"")};a.prototype.initSaveButton=function(){var b=this,c=b.$textarea;b.$button.click(function(e){e.preventDefault();b.settingsForm.updateField(b.id,b.checked,{text:c.val()});b.settingsForm.renderField(b.id,
b.checked);b.dialog.close()})};a.prototype.setFormChanged=function(){this.$button.removeClass("green").addClass("yellow")};return a}(jQuery);var crmSettingsFormAgreementCheckboxEditDialog=function(d){d=function(a){var b=this,c=a.onOpen;a.onOpen=function(e,f){c&&c(e,f);b.$wrapper=e;b.$html_label=b.$wrapper.find(".c-html-label-textarea-wrapper textarea");b.$field_id=b.$wrapper.find(".c-field-id .value");b.$checked_by_default=b.$wrapper.find(".c-field-checked-by-default :checkbox");b.$button=b.$wrapper.find("[type=button]");b.id=a.id;b.checked=a.checked;b.settingsForm=a.settingsForm;b.dialog=f;b.initClass()};new CRMDialog(a)};d.prototype.initClass=
function(){var a=this.getField();this.$field_id.text(a.name+" (ID="+a.id+")");this.initHtmlLabel();this.initDefaultChecked();this.initSaveButton()};d.prototype.initHtmlLabel=function(){var a=this,b=a.$html_label,c=a.getField(),e=function(){a.setFormChanged()};b.val(c.html_label);var f=null;b.on("keyup",function(){f&&clearTimeout(f);f=setTimeout(function(){e()},300)});b.on("change",e)};d.prototype.initDefaultChecked=function(){var a=this,b=a.getField(),c=a.$checked_by_default;c.attr("checked",!!b.default_checked);
c.on("change",function(){a.setFormChanged()})};d.prototype.getField=function(){var a=this.settingsForm.getField(this.id,this.checked);a.name=a.name||"";a.id=a.id||"";a.html_label=a.html_label||"";a.default_checked=a.default_checked&&"0"!==a.default_checked?1:0;a.html_label_default_href_placeholder=a.html_label_default_href_placeholder||"";return a};d.prototype.initSaveButton=function(){var a=this,b=a.$html_label,c=a.$checked_by_default;a.$button.click(function(e){e.preventDefault();e={html_label:b.val(),
default_checked:c.is(":checked")?1:0};a.settingsForm.updateField(a.id,a.checked,e);a.renderField();a.dialog.close()})};d.prototype.renderField=function(){var a=this.id,b=this.checked,c=this.getField(a,b),e=this.settingsForm.$form_fields,f=e.find('.crm-form-field:not(.crm-form-field-template)[data-id="'+a+'"][data-checked="'+b+'"]');c?(f.length||(f=e.find('.crm-form-field-template.crm-form-field-template[data-id="'+a+'"]').clone(),f.removeClass("crm-form-field-template"),f.attr("data-checked",b),f.insertBefore(e.find(".crm-form-field-template:first")),
f.show()),a=c.html_label,a=a.replace(c.html_label_default_href_placeholder,"javascript:void(0)"),f.find(".c-agreement-checkbox-html-label").html(a),f.find(":checkbox").attr("checked",!!c.default_checked)):f.remove()};d.prototype.setFormChanged=function(){this.$button.removeClass("green").addClass("yellow")};return d}(jQuery);var CRMSettingsGeneral=function(d){CRMSettingsGeneral=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.initClass()};CRMSettingsGeneral.prototype.initClass=function(){this.initFooterToggle();this.initSubmit()};CRMSettingsGeneral.prototype.initSubmit=function(){var a=this.$form,b=a.find(".js-submit-button:first");a.submit(function(c){c.preventDefault();let e=b.text();b.empty();b.html(e+' <i class="fas fa-spinner fa-spin"></i>');d.post(a.attr("action"),a.serialize(),function(f){"ok"===
f.status&&(b.empty().html(e+' <i class="fas fa-check-circle"></i>'),d.crm.content.reload())})})};CRMSettingsGeneral.prototype.initFooterToggle=function(){var a=this.$wrapper.find(".js-footer-actions"),b=a.find(".js-submit-button");this.$wrapper.on("change keydown","input, textarea, select",function(){b.addClass("yellow");a.addClass("is-changed")})};return CRMSettingsGeneral}(jQuery);var CRMSettingsPersonal=function(d){CRMSettingsPersonal=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.initClass()};CRMSettingsPersonal.prototype.initClass=function(){this.initFooterToggle();this.initSubmit()};CRMSettingsPersonal.prototype.initSubmit=function(){var a=this.$wrapper.find(".c-reminder-settings-wrapper").data("instance"),b=this.$form,c=b.find(".js-submit-button:first");b.submit(function(e){e.preventDefault();let f=c.text();c.empty();c.html(f+' <i class="fas fa-spinner fa-spin"></i>');
a&&!1===a.validateBeforeSave()?c.empty().html(f):d.post(b.attr("action"),b.serialize(),function(g){"ok"===g.status&&(c.empty().html(f+' <i class="fas fa-check-circle"></i>'),d.crm.content.reload())})})};CRMSettingsPersonal.prototype.initFooterToggle=function(){var a=this.$wrapper.find(".js-footer-actions"),b=a.find(".js-submit-button");this.$wrapper.on("change keydown","input, textarea, select",function(){b.addClass("yellow");a.addClass("is-changed")})};return CRMSettingsPersonal}(jQuery);var CRMNotificationEdit=function(d){CRMNotificationEdit=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$footer=this.$wrapper.find(".js-footer-actions");this.messages=a.messages||{};this.messages.enable=this.messages.enable||"";this.messages.disable=this.messages.disable||"";this.$name=this.$wrapper.find(".js-notification-name");this.$subject=this.$wrapper.find(".js-notification-subject");this.$emailBody=this.$wrapper.find(".js-email-body");this.$smsBody=this.$wrapper.find(".js-sms-body");
this.$recipient=this.$wrapper.find(".js-recipient-list");this.$sender=this.$wrapper.find(".js-sender-list");this.$sender_block=this.$wrapper.find(".js-senders-block");this.$sms_sender=this.$wrapper.find(".js-sms-sender-list");this.$sms_sender_block=this.$wrapper.find(".js-sms-senders-block");this.notifications=a.notifications;this.locales=a.locales;this.notification_id=(this.notification=a.notification||{},this.notification.id);this.notification_event=this.notification&&this.notification.event;this.site_app_url=
a.site_app_url;this.recipients=a.recipients;this.sender=a.sender.split("|",2);this.user_data=a.user_data;this.dialog_template=a.dialog_template;this.success_html=a.success_html;this.transport="";this.initClass()};CRMNotificationEdit.prototype.initClass=function(){0>=this.notification.id&&this.initTransport();this.initRecipient();this.initBody();this.notification_id||this.initChangeEvent();this.initSubmit();this.initDelete();this.initFooterActions();this.initHelp();this.initSender();this.initSendTest()};
CRMNotificationEdit.prototype.initSendTest=function(){var a=this,b=!1,c=null;a.$wrapper.on("click",".js-send-test",function(e){e.preventDefault();d(document).trigger("updateEditorTextarea");d.waDialog.confirm({title:a.locales.send_confirm_title,text:function(){var f=d(a.dialog_template);c="sms"==a.$wrapper.find(".js-transport-toggle").filter(":checked").first().val()?a.user_data.phone:a.user_data.email;f.find(".js-user-contact").attr("value",c);return f["0"].outerHTML}(),success_button_title:a.locales.send_confirm_button,
success_button_class:"warning",cancel_button_title:a.locales.delete_cancel_button,cancel_button_class:"light-gray",onSuccess:function(f){b||(b=!0,f=a.$form.serializeArray(),f.push({name:"data[contact]",value:d(".dialog").find(".js-user-contact").val()}),d.post("?module=settingsNotifications&action=SendTest",f,function(g){"ok"===g.status&&(d.waDialog.alert({text:a.locales.success_text,button_title:a.locales.close_button,button_class:"light-gray"}),setTimeout(function(){d.contains(document,d(".dialog")[0])&&
d(".dialog").remove()},1E4))},"json").always(function(){b=!1}));return!1}})})};CRMNotificationEdit.prototype.initSender=function(){function a(){return l&&0<l.id?l.transport||"email":h.filter(":checked").first().val()}function b(){"email"===a()?(c("specified"===k.$sender.val()),g()):(f("specified"===k.$sms_sender.val()),e())}function c(m){var n=k.$sender_block.find(".js-specified-sender-name"),p=k.$sender_block.find(".js-specified-sender-email");k.$sender_block.show();k.$sender.attr("disabled",!1);
m?(n.attr("disabled",!1).show(),p.attr("disabled",!1).show(),"system"!==k.sender[0]&&(p.val(k.sender[0]),n.val(k.sender[1]))):(n.attr("disabled",!0).hide(),p.attr("disabled",!0).hide())}function e(){k.$sender_block.hide();k.$sender.attr("disabled",!0);k.$sender_block.find(".js-specified-sender-name").attr("disabled",!0).hide();k.$sender_block.find(".js-specified-sender-email").attr("disabled",!0).hide()}function f(m){var n=k.$sms_sender_block.find(".js-specified-sms-sender");k.$sms_sender_block.show();
k.$sms_sender.attr("disabled",!1);m?(n.attr("disabled",!1).show(),"system"!==k.sender[0]&&n.val(k.sender[0])):n.attr("disabled",!0).hide()}function g(){k.$sms_sender_block.hide();k.$sms_sender.attr("disabled",!0);k.$sms_sender_block.find(".js-specified-sms-sender").attr("disabled",!0).hide()}var k=this,l=k.notification,h=k.$wrapper.find(".js-transport-toggle");"email"===a()?(c("specified"===k.$sender.val()),g()):(f("specified"===k.$sms_sender.val()),e());h.on("change",b);k.$sender.on("change",b);
k.$sms_sender.on("change",b)};CRMNotificationEdit.prototype.initRecipient=function(){function a(){b(c.$recipient.val())}function b(l){var h=k.filter(":checked").first().val();!h&&0<c.notification.id&&(h=c.notification.transport);h=c.$wrapper.find('.c-recipient-content[data-id="'+h+'"]');c.$wrapper.find(".c-recipient-content").hide().attr("disabled",!0);"other"===l?(h.show(),h.attr("disabled",!1)):h.hide()}var c=this,e=c.notification.recipient,f=c.recipients,g=c.$recipient,k=c.$wrapper.find(".js-transport-toggle");
g.on("change",a);k.on("change",a);f[e]||(c.$recipient.val("other"),b("other"),c.$wrapper.find('.c-recipient-content[data-id="'+k.filter(":checked").first().val()+'"]').val(e))};CRMNotificationEdit.prototype.initChangeEvent=function(){var a=this,b=a.$wrapper.find(".js-event-toggle"),c=a.$wrapper.find(".js-event-company"),e=a.$wrapper.find(".js-fields-group");b.on("change",function(){var f=d.trim(d(this).val());a.notification_event=f;var g=a.notifications[f];g&&(a.$name.val(g.name),a.$subject.val(g.subject),
a.$emailBody.val(g.body).trigger("editorDataUpdated"),a.$smsBody.val(g.sms).trigger("editorDataUpdated"),g.recipient?a.$recipient.val(g.recipient):a.$recipient.val("client"));"invoice."===f.substr(0,8)?c.removeAttr("disabled").show():c.attr("disabled",!0).hide();e.show()})};CRMNotificationEdit.prototype.initTransport=function(){function a(f){f=f.val();b.transport=f;f=b.$wrapper.find('.c-transport-content[data-id="'+f+'"]');e?(e.removeClass("is-active"),e.find("input, textarea").attr("disabled",!0)):
b.$wrapper.find(".c-transport-content").find("input, textarea").attr("disabled",!0);f.find("input, textarea").attr("disabled",!1);e=f.addClass("is-active")}var b=this,c=b.$wrapper.find(".js-transport-toggle"),e=!1;a(c.filter(":checked").first());c.on("change",function(){a(d(this));b.$emailBody.trigger("editorDataUpdated");b.$smsBody.trigger("editorDataUpdated")})};CRMNotificationEdit.prototype.initBody=function(){this.$wrapper.find(".js-redactor-wrapper").each(function(a){var b=d(this),c=b.find("textarea"),
e=d('<div class="js-redactor" />'),f="js-textarea-"+a;a="js-redactor-"+a;e.attr("id",a).appendTo(b);c.attr("id",f);waEditorAceInit({id:f,ace_editor_container:a});"undefined"!==typeof wa_editor&&e.data("wa_editor",wa_editor);c.data("wa_editor",e.data("wa_editor"));c.on("editorDataUpdated",function(){var g=e.data("wa_editor");g&&g.getSession().setValue(c.val())});d(document).on("updateEditorTextarea",function(){var g=e.data("wa_editor");g&&(g=g.getValue(),c.val(g).trigger("change"))})})};CRMNotificationEdit.prototype.initSubmit=
function(){function a(){var k={data:[],errors:[]},l=f.serializeArray();d.each(l,function(h,m){k.data.push(m)});return k}function b(k,l){l=l?l:[];if(k){var h=Object.keys(k);d.each(h,function(m,n){l.push({name:n,value:k[n]})})}d.each(l,function(m,n){m=n.value;var p=e.$form.find('[name="'+n.name+'"]');if(p.length&&!p.hasClass("error")){var q=d("<span />").addClass("errormsg").text(m);e.$wrapper.append(q);p.addClass("error").one("focus click change",function(){p.removeClass("error");q.remove()})}})}function c(k){if(!g){g=
!0;var l=d(e.locales.saving);e.$footer.append(l);d.post("?module=settings&action=notificationsEditSave",k,"json").done(function(h){if("ok"!==h.status)b(h.errors||{});else if(0>=e.notification_id)d.crm.content.load(d.crm.app_url+"settings/notifications/edit/"+h.data.notification.id+"/");else{var m=d(e.locales.saved);e.$footer.append(m);setTimeout(function(){d.contains(document,m[0])&&m.remove()},2E3);d(document).trigger("formIsSaved")}}).always(function(){l.remove();g=!1})}}var e=this,f=e.$form,g=
!1;f.on("submit",function(k){k.preventDefault();d(document).trigger("updateEditorTextarea");k=a();k.errors.length?b(!1,k.errors):c(k.data)})};CRMNotificationEdit.prototype.initDelete=function(){var a=this,b=!1;a.$wrapper.on("click",".js-remove-notification",function(c){c.preventDefault();d.waDialog.confirm({title:'<i class="fas fa-exclamation-triangle smaller state-error"></i> '+a.locales.delete_confirm_title,text:a.locales.delete_confirm_text,success_button_title:a.locales.delete_confirm_button,
success_button_class:"danger",cancel_button_title:a.locales.delete_cancel_button,cancel_button_class:"light-gray",onSuccess:function(e){b||(b=!0,d.post("?module=settings&action=notificationsDelete",{id:a.notification_id},function(f){"ok"===f.status&&d.crm.content.load(d.crm.app_url+"settings/notifications/")}).always(function(){b=!1;e.close()}));return!1}})})};CRMNotificationEdit.prototype.initFooterActions=function(){function a(c){c?b.removeClass("yellow"):b.addClass("yellow")}var b=this.$footer.find(".js-submit-button");
this.$wrapper.on("change","input, textarea, select",function(){a()});d(document).on("formIsSaved",function(){a(!0)})};CRMNotificationEdit.prototype.initHelp=function(){function a(g){e.drawerWrapper=d(".drawer");e.drawerContent=e.drawerWrapper.find(".drawer-content");g?(e.drawerWrapper.on("click","ul.tabs li",b),e.drawerWrapper.on("click",".wa-help-vars-item",c),e.drawerWrapper.on("click",".drawer-background",()=>e.drawer.hide())):(e.drawerWrapper.off("click"),f=!1)}function b(g){g.preventDefault();
if(d(this).hasClass("selected"))return!1;g=d(this).attr("id")+"-content";d(this).addClass("selected").siblings().removeClass("selected");g=e.drawerContent.find(`#${g}`);g.siblings().hide();g.show()}function c(g){g.preventDefault();$body=e.$emailBody;"sms"===e.transport&&($body=e.$smsBody);if(g=$body.data("wa_editor"))g.insert(d.trim(d(this).find(".js-var").text())),e.drawer.hide()}var e=this,f=!1;d("#wa-editor-help-link").on("click",function(g){g.preventDefault();g=d.crm.app_url+"?module=settings&action=help";
var k="app=crm&key=notification."+e.notification_event;if(f)return e.drawer.show(),!1;e.drawer=d.waDrawer({html:'<div class="drawer crm-help" id=""> <div class="drawer-background"></div> <div class="drawer-body"> <a href="#" class="drawer-close js-close-drawer"><i class="fas fa-times"></i></a> <div class="drawer-block"><div class="flexbox middle width-100 height-100 spinner-wrapper"><div class="spinner custom-p-16"></div></div></div> </div> </div> ',direction:"right",onClose:()=>a(!1)});d.get(g,k,
function(l){d(".drawer .drawer-block").html(l);a(!0);f=!0},"html")})};return CRMNotificationEdit}(jQuery),CRMNotificationStatus=function(d){CRMNotificationStatus=function(a){this.$wrapper=a.$wrapper;this.messages=a.messages||{};this.messages.enable=this.messages.enable||"";this.messages.disable=this.messages.disable||"";this.notifications=a.notifications;this.initDisableLinks()};CRMNotificationStatus.prototype.initDisableLinks=function(){var a=this.$wrapper.find(".js-c-disable-link"),b=null,c=d.crm.app_url+
"?module=settingsNotifications&action=status";a.each(function(){var e=d(this),f=e.closest(".c-notification"),g=f.data("id"),k=f.find(".c-loading");e.find("#switch-"+g).waSwitch({ready:function(l){let h=l.$wrapper.siblings("label");l.$label=h;l.active_text=h.data("active-text");l.inactive_text=h.data("inactive-text")},change:function(l,h){k.show();h.disable(!0);b&&b.abort();b=d.post(c,{id:g,status:l?0:1}).done(function(m){"ok"===m.status&&(l?(h.$label.text(h.inactive_text),f.removeClass("c-is-disabled")):
(h.$label.text(h.active_text),f.addClass("c-is-disabled")),h.disable(!1))}).always(function(){b=null;k.hide()})}})})};return CRMNotificationStatus}(jQuery);var CRMSettingsPayments=function(d){CRMSettingsPayments=function(a){this.$wrapper=a.$wrapper;this.$dropdown=this.$wrapper.find(".dropdown");this.$pluginsDropdown=this.$wrapper.find(".js-plugins-dropdown");this.$table=this.$wrapper.find(".js-payments-table");this.company_id=a.company_id;this.locales=a.locales;this.initClass()};CRMSettingsPayments.prototype.initClass=function(){this.initTabs();this.initDelete();this.initSortable();this.initDropDown();var a=this.$wrapper.find(".c-payments-list");(new MutationObserver(function(b){a.trigger("refresh")})).observe(a[0],
{childList:!0,attributes:!0,subtree:!0})};CRMSettingsPayments.prototype.initTabs=function(){var a=this.$wrapper.find(".c-tabs-wrapper"),b=this.$wrapper.find(".c-companies-wrapper"),c=b.find(".c-companies-list"),e=c.find(".c-company.selected");(function(){function f(){d.contains(document,a[0])?g():k.off("resize refresh",f)}function g(){var h=a.outerWidth(!0)-l-38;b.css("max-width",h+"px")}var k=d(window),l=a.find(".c-add-wrapper").outerWidth();g();k.on("resize refresh",f)})();d.crm.tabSlider({$wrapper:b,
$slider:c,$activeSlide:e.length?e:!1})};CRMSettingsPayments.prototype.initDropDown=function(){this.$dropdown.waDropdown()};CRMSettingsPayments.prototype.initDelete=function(){var a=this,b=!1;a.$wrapper.on("click",".js-delete-payment",function(c){c.preventDefault();c=d(this);var e=c.closest("tr"),f=c.data("payment-id"),g=c.data("plugin");(function(){d.waDialog.confirm({title:'<i class="fas fa-exclamation-triangle smaller state-error"></i> '+a.locales.confirm_delete_title.replace("%payment",e.find(".js-name").text()),
text:a.locales.confirm_delete_text,success_button_title:a.locales.confirm_delete_button,success_button_class:"danger",cancel_button_title:a.locales.confirm_cancel_button,cancel_button_class:"light-gray",onSuccess:function(){b||(b=!0,d.post("?module=settings&action=paymentDelete",{id:f,company_id:a.company_id},function(k){"ok"==k.status&&(e.remove(),k=a.$pluginsDropdown.find('li[data-plugin="'+g+'"]'),k.length&&k.show())}).always(function(){b=!1}))}})})()})};CRMSettingsPayments.prototype.initSortable=
function(){function a(){var e={ids:function(){var f=[];b.$table.find("tr").each(function(){f.push(d(this).data("id"))});return f}(),company_id:b.company_id};c&&c.abort();c=d.post("?module=settings&action=paymentSort",e,function(f){}).always(function(){c=!1})}var b=this,c=!1;b.$table.find("tbody").sortable({distance:10,handle:".js-sort-toggle",helper:"clone",items:"> .payments-table-row",axis:"y",stop:a,onUpdate:a})};return CRMSettingsPayments}(jQuery),CRMPaymentEdit=function(d){CRMPaymentEdit=function(a){this.$wrapper=
a.$wrapper;this.$form=this.$wrapper.find("form");this.$footer=this.$wrapper.find(".js-footer");this.instance_id=a.instance_id;this.company_id=a.company_id;this.locales=a.locales;this.initClass()};CRMPaymentEdit.prototype.initClass=function(){this.initSubmit();this.initDelete()};CRMPaymentEdit.prototype.initSubmit=function(){function a(g){if(!e){e=!0;var k=d(c.locales.saving);c.$footer.append(k);d.post("?module=settings&action=paymentSave",g,function(l){if("ok"==l.status)if(k.remove(),c.instance_id){var h=
d(c.locales.saved);c.$footer.append(h);setTimeout(function(){d.contains(document,h[0])&&h.remove()},2E3)}else d.crm.content.load(d.crm.app_url+"settings/payment/?company="+c.company_id)}).always(function(){e=!1})}}function b(g,k){g=g?g:[];if(k){var l=Object.keys(k);d.each(l,function(h,m){g.push({name:m,value:k[m]})})}d.each(g,function(h,m){h=m.value;var n=c.$wrapper.find('[name="'+m.name+'"]');if(n.length&&!n.hasClass("error")){var p=d("<span />").addClass("errormsg").text(h);p.insertAfter(n);n.addClass("error").one("focus click",
function(){n.removeClass("error");p.remove()})}})}var c=this,e=!1,f=c.$form;f.on("submit",function(g){g.preventDefault();g=f.serializeArray();var k=[];k.length?b(k):a(g)})};CRMPaymentEdit.prototype.initDelete=function(){var a=this,b=!1;a.$wrapper.on("click",".js-delete-payment",function(c){function e(){b||(b=!0,d.post("?module=settings&action=paymentDelete",{id:a.instance_id,company_id:a.company_id},function(f){"ok"==f.status&&d.crm.content.load(d.crm.app_url+"settings/payment/?company="+a.company_id)}).always(function(){b=
!1}))}c.preventDefault();b||(b=!0,d.waDialog.confirm({title:'<i class="fas fa-exclamation-triangle smaller state-error"></i> '+a.locales.confirm_delete_title,text:a.locales.confirm_delete_text,success_button_title:a.locales.confirm_delete_button,success_button_class:"danger",cancel_button_title:a.locales.confirm_cancel_button,cancel_button_class:"light-gray",onSuccess:e}));b=!1})};return CRMPaymentEdit}(jQuery);var CRMReasonsPage=function(d){CRMReasonsPage=function(a){this.$wrapper=a.$wrapper;this.$reasonsList=this.$wrapper.find(".js-reasons-list");this.$footer=this.$wrapper.find(".js-footer-actions");this.$form=this.$wrapper.find("form");this.$freeField=this.$wrapper.find(".js-free-field");this.$submitButton=this.$wrapper.find(".js-submit-button");this.$hiddenActions=this.$footer.find(".js-hidden-actions");this.reason_template_html=a.reason_template_html;this.locales=a.locales;this.is_changed=!1;this.initClass()};
CRMReasonsPage.prototype.initClass=function(){var a=this;a.initSortable();a.initAddReason();a.initRemoveReason();a.initSubmit();a.$form.on("input change",function(){a.toggleButton(!0)})};CRMReasonsPage.prototype.initSortable=function(){var a=this;a.$reasonsList.sortable({distance:10,handle:".js-sort-toggle",helper:"clone",items:"> li",axis:"y",change:function(){a.toggleButton(!0)}})};CRMReasonsPage.prototype.initRemoveReason=function(){var a=this;a.$wrapper.on("click",".js-delete-reason",function(b){b.preventDefault();
d(this).closest(".c-reason").remove();a.$reasonsList.find(".c-reason").length||a.$freeField.attr("checked",!0).attr("disabled",!0);a.toggleButton(!0)})};CRMReasonsPage.prototype.initAddReason=function(){var a=this;a.$wrapper.on("click",".js-add-reason",function(b){b.preventDefault();b=d(a.reason_template_html);a.$reasonsList.append(b);a.$freeField.attr("disabled",!1);a.toggleButton(!0)})};CRMReasonsPage.prototype.initSubmit=function(){function a(f){if(!e){e=!0;var g=d(c.locales.saving);c.$submitButton.append(g);
f=b(f);d.post("?module=settings&action=lostReasonsSave",f,function(k){if("ok"==k.status){g.remove();var l=d(c.locales.saved);c.$submitButton.append(l);c.toggleButton(!1);setTimeout(function(){d.contains(document,l[0])&&l.remove()},2E3)}}).always(function(){e=!1})}}function b(f){var g=f.serializeArray();c.$freeField.is(":disabled")&&(c.$freeField.attr("disabled",!1),g=f.serializeArray(),c.$freeField.attr("disabled",!0));(function(k){c.$reasonsList.find(".c-reason").each(function(l){var h=d(this),m=
h.data("id"),n=h.find(".js-name-field").val();h=h.find(".js-funnel-id-field").val();n&&(m&&k.push({name:"reasons["+l+"][id]",value:m}),k.push({name:"reasons["+l+"][name]",value:n}),k.push({name:"reasons["+l+"][funnel_id]",value:h}))})})(g);return g}var c=this,e=!1;c.$form.on("submit",function(f){f.preventDefault();a(d(this))})};CRMReasonsPage.prototype.toggleButton=function(a){var b=this.$submitButton,c=this.$hiddenActions;a?(b.addClass("yellow"),c.show()):(b.removeClass("yellow"),c.hide())};return CRMReasonsPage}(jQuery);var CRMSettingsVaults=function(d){CRMSettingsVaults=function(a){this.$wrapper=a.$wrapper;this.$list=this.$wrapper.find(".js-vaults-list");this.locales=a.locales;this.vault_template_html=a.vault_template_html;this.initClass()};CRMSettingsVaults.prototype.initClass=function(){this.initEdit();this.initSort()};CRMSettingsVaults.prototype.initEdit=function(){function a(e,f){c&&c.abort();c=d.post("?module=settings&action=vaultDialog",{id:e?e:""},function(g){d.waDialog({html:g,options:{onSave:function(k,
l,h){f&&f.length||(f=d(b.vault_template_html),f.data("id",k).appendTo(b.$list));f.find(".js-name").text(l);f.find(".js-color").css("background-color",h)},onDelete:function(){f.remove()}}})}).always(function(){c=!1})}var b=this,c=!1;b.$wrapper.on("click",".js-vault-edit",function(){var e=d(this).closest(".c-vault-item"),f=e.data("id");a(f,e)});b.$wrapper.on("click",".js-vault-add",function(){a()})};CRMSettingsVaults.prototype.initSort=function(){function a(f,g){var k=f.item?d(f.item):d(g.item);e&&
e.abort();f={vaults:b()};var l=d(c.locales.saving);l.appendTo(k);e=d.post("?module=settings&action=vaultsSave",f,function(h){if("ok"==h.status){var m=d(c.locales.saved);m.appendTo(k);setTimeout(function(){d.contains(document,m[0])&&m.remove()},2E3)}}).always(function(){l.remove();e=!1})}function b(){var f=[];c.$list.find(".c-vault-item").each(function(){var g=d(this).data("id");g&&f.push(g)});return f}var c=this,e=!1;c.$list.sortable({distance:10,handle:".js-sort-toggle",helper:"clone",items:"> .c-vault-item",
axis:"y",stop:a,onUpdate:a})};return CRMSettingsVaults}(jQuery),CRMVaultEdit=function(d){CRMVaultEdit=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.locales=a.locales;this.count=a.count;this.vault_id=a.vault_id;this.dialog=this.$wrapper.data("dialog");this.initClass()};CRMVaultEdit.prototype.initClass=function(){this.initDelete();this.initSave();this.initColorPicker();this.initNoAccessList()};CRMVaultEdit.prototype.initDelete=function(){function a(c,e){d.post("?module=settings&action=vaultDialogDelete",
{id:c},function(f){"ok"===f.status&&e&&"function"===typeof e&&e()})}var b=this;b.$wrapper.on("click",".js-vault-delete",function(c){c.preventDefault();var e=b.vault_id;d.waDialog.confirm({title:`<i class=\"fas fa-exclamation-triangle smaller state-error\"></i> ${b.locales.confirm_delete_title}?`,text:b.locales.confirm_delete_text,success_button_title:`${b.locales.confirm_delete_button}`,success_button_class:"danger",cancel_button_title:`${b.locales.confirm_cancel_button}`,cancel_button_class:"light-gray",
onSuccess:function(){a(e,function(){b.dialog.options.onDelete();b.dialog.close()})}})})};CRMVaultEdit.prototype.initSave=function(){function a(){var h={data:[],errors:[]},m=f.serializeArray();d.each(m,function(n,p){"data[name]"===p.name&&(k=p.value);"data[color]"===p.name&&(l=p.value);h.data.push(p)});return h}function b(h,m){m=m?m:[];if(h){var n=Object.keys(h);d.each(n,function(p,q){m.push({name:q,value:h[q]})})}d.each(m,function(p,q){p=q.value;var r=e.$form.find('[name="'+q.name+'"]');if(r.length&&
!r.hasClass("error")){var u=d("<span />").addClass("errormsg").text(p);e.$wrapper.append(u);r.addClass("error").one("focus click change",function(){r.removeClass("error");u.remove()})}})}function c(h){g||(g=!0,d.post("?module=settings&action=vaultDialogSave",h,function(m){"ok"===m.status?(console.log(e.dialog),e.dialog.options.onSave(m.data.id,k,l),e.dialog.close()):m.errors&&b(m.errors)},"json").always(function(){g=!1}))}var e=this,f=e.$form,g=!1,k="",l="#aaa";f.on("submit",function(h){h.preventDefault();
h=a();h.errors.length?b(!1,h.errors):c(h.data)})};CRMVaultEdit.prototype.initColorPicker=function(){var a=function(b){a=function(c){this.$wrapper=c.$wrapper;this.$field=c.$field;this.$icon=c.$icon;this.$colorPicker=c.$colorPicker;this.farbtastic=this.is_opened=!1;this.initClass()};a.prototype.initClass=function(){var c=this;c.farbtastic=b.farbtastic(c.$colorPicker,function(e){c.$field.val(e).change()});c.$wrapper.data("colorPicker",c);c.bindEvents()};a.prototype.bindEvents=function(){var c=this;c.$icon.on("click",
function(e){e.preventDefault();e.stopPropagation();c.displayToggle(!c.is_opened)});c.$colorPicker.on("click",function(e){e.stopPropagation()});c.$field.on("click",function(e){e.stopPropagation()});c.$field.on("focus",function(){c.is_opened||c.displayToggle(!0)});c.$field.on("change keyup",function(){var e=b(this).val();c.$icon.css("background-color",e);c.farbtastic.setColor(e)});b(document).on("click",function(){c.displayToggle(!1)});b(document).on("colorPickerIsOpened",function(){c.is_opened&&c.displayToggle(!1)})};
a.prototype.displayToggle=function(c){var e=this.$colorPicker;c?(b(document).trigger("colorPickerIsOpened",this),e.addClass("is-shown"),this.is_opened=!0):(b(document).trigger("colorPickerIsClosed",this),e.removeClass("is-shown"),this.is_opened=!1)};return a}(jQuery);this.$wrapper.find(".js-color-toggle").each(function(){var b=d(this);new a({$wrapper:b,$field:b.find(".js-field"),$icon:b.find(".js-toggle"),$colorPicker:b.find(".js-color-picker")})})};CRMVaultEdit.prototype.initNoAccessList=function(){var a=
this,b=a.$wrapper.find(".js-no-access-wrapper");b.on("click",".js-show-access-list",function(c){c.preventDefault();b.addClass("is-active");a.dialog.resize()});b.on("click",".js-hide-access-list",function(c){c.preventDefault();b.removeClass("is-active");a.dialog.resize()})};return CRMVaultEdit}(jQuery);var CRMSettingsMessagesBlock=function(d){CRMSettingsMessagesBlock=function(a){this.$wrapper=a.$wrapper;this.namespace=a.namespace||"";this.type=a.type||"form";this.initClass()};CRMSettingsMessagesBlock.prototype.initClass=function(){var a=this,b=a.$wrapper,c=a.namespace,e=d.crm.app_url+"?module=settings&action=emailTemplateEditor";a.renderCheckboxLabel();b.on("click",".js-crm-add-message-checkbox",function(){var f=d(this),g=b.find(".crm-template").clone();g.removeClass("crm-template");b.find(".crm-one-message:last").after(g.show());
var k=b.find(".crm-editor-wrapper[data-i]").last().data("i");k?k=parseInt(k+"",10):0!==k&&(k=-1);var l=k+1;g.find(".crm-editor-wrapper").data("i",""+l).attr("data-i",""+l);d.post(e,{input_name:c+"["+l+"][tmpl]",to_name:c+"["+l+"][to]",sourcefrom_name:c+"["+l+"][sourcefrom]",add_attachments_name:c+"["+l+"][add_attachments]",type:a.type},function(h){g.find(".crm-editor-wrapper").html(h);b.trigger("loadEditor",[l,g])});a.renderCheckboxLabel();f.prop("checked",!1)});b.on("click",".js-crm-remove-message-checkbox",
function(){d(this).closest(".crm-one-message").remove();a.renderCheckboxLabel()})};CRMSettingsMessagesBlock.prototype.renderCheckboxLabel=function(){var a=this.$wrapper;0<a.find(".crm-one-message:not(.crm-template)").length?(a.find(".js-crm-when-no-messages").hide(),a.find(".js-crm-when-messages").show()):(a.find(".js-crm-when-no-messages").show(),a.find(".js-crm-when-messages").hide())};return CRMSettingsMessagesBlock}(jQuery);var CRMSettingsShop=function(d){CRMSettingsShop=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$button=this.$form.find("[type=submit]");this.source=a.source||{};this.messages=a.messages||{};this.submit_xhr=null;this.initClass()};CRMSettingsShop.prototype.initClass=function(){this.initToggle();this.initSubmit();this.initStoreToggle();this.initFooterToggle()};CRMSettingsShop.prototype.initToggle=function(){d("#toggle-menu").waToggle()};CRMSettingsShop.prototype.initStoreToggle=
function(){this.$wrapper.find(".js-ibutton-wrapper").each(function(){var a=d(this).find("#c-storefront-switch");a.waSwitch({ready:function(b){let c=b.$wrapper.siblings("label");b.$label=c;b.active_text=c.data("active-text");b.inactive_text=c.data("inactive-text")},change:function(b,c){var e=a.closest(".c-storefront").find(".c-storefront-params-block");b?(c.$label.text(c.active_text),e.slideDown(300)):(c.$label.text(c.inactive_text),e.slideUp(300))}})})};CRMSettingsShop.prototype.initSubmit=function(){var a=
this,b=a.$form,c=a.$button,e=b.find(".c-loading"),f=b.attr("action");b.submit(function(g){g.preventDefault();e.show();c.attr("disabled",!0);a.submit_xhr&&a.submit_xhr.abort();a.submit_xhr=d.post(f,b.serialize()).done(function(){d.crm.content.load(d.crm.app_url+"settings/shop/")}).always(function(){c.attr("disabled",!1);e.hide()})})};CRMSettingsShop.prototype.initFooterToggle=function(){var a=this.$wrapper.find(".js-footer-actions"),b=a.find(".js-submit-button");this.$wrapper.on("change keydown","input, textarea, select",
function(){b.addClass("yellow");a.addClass("is-changed")})};return CRMSettingsShop}(jQuery),CRMSettingsShopWorkflowPage=function(d){CRMSettingsShopWorkflowPage=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form").first();this.initClass()};CRMSettingsShopWorkflowPage.prototype.initClass=function(){d.crm.renderSVG(this.$wrapper);this.initToggle();this.initTabs();this.initFooterToggle();this.initSubmit()};CRMSettingsShopWorkflowPage.prototype.initToggle=function(){d("#toggle-menu").waToggle()};
CRMSettingsShopWorkflowPage.prototype.initTabs=function(){var a=this.$wrapper.find(".js-funnels-tabs"),b=this.$wrapper.find(".c-funnels-wrapper"),c=b.find(".c-funnels-list"),e=c.find(".c-funnel.selected");(function(){function f(){d.contains(document,a[0])?g():k.off("resize",f)}function g(){var l=a.width();b.css("max-width",l+"px")}var k=d(window);g();k.on("resize",f)})();d.crm.tabSlider({$wrapper:b,$slider:c,$activeSlide:e.length?e:!1})};CRMSettingsShopWorkflowPage.prototype.initFooterToggle=function(){var a=
this.$wrapper.find(".js-footer-actions"),b=a.find(".js-submit-button");this.$wrapper.on("change keydown","input, textarea, select",function(){b.addClass("yellow");a.addClass("is-changed")})};CRMSettingsShopWorkflowPage.prototype.initSubmit=function(){function a(){var l={data:[],errors:[]},h=f.serializeArray();d.each(h,function(m,n){l.data.push(n)});return l}function b(l){l&&l[0]||(l=[]);d.each(l,function(h,m){h=m.value;var n=e.$wrapper.find('[name="'+m.name+'"]'),p=d("<span class='c-error' />").addClass("errormsg").text(h);
n.length&&!n.hasClass("error")?(n.parent().append(p),n.addClass("error").one("focus click change",function(){n.removeClass("error");p.remove()})):(g.append(p),f.one("submit",function(){p.remove()}))})}function c(l){if(!k){k=!0;var h=d.crm.app_url+"?module=settings&action=shopWorkflowSave",m=e.$form.find(".c-loading");m.show();d.post(h,l,function(n){"ok"===n.status?d.crm.content.reload():b(n.errors)},"json").always(function(){k=!1;m.hide()})}}var e=this,f=e.$form,g=e.$wrapper.find(".js-errors-place"),
k=!1;f.on("submit",function(l){l.preventDefault();l=a();l.errors.length?b(l.errors):c(l.data)})};return CRMSettingsShopWorkflowPage}(jQuery);var CRMSettingsPbxPage=function(d){CRMSettingsPbxPage=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.locales=a.locales;this.user_template_html=a.user_template_html;this.initClass()};CRMSettingsPbxPage.prototype.initClass=function(){var a=this;a.$wrapper.find(".c-pair-wrapper").each(function(){a.initPair(d(this))})};CRMSettingsPbxPage.prototype.initPair=function(a){function b(k){d.each(k,function(l,h){d.waDialog.alert({title:c.locales.dialog_error_title,text:h,button_title:c.locales.dialog_error_button,
button_class:"warning"});setTimeout(()=>{d(".js-dialog-close").click()},5E3)})}var c=this,e=a.data("plugin-id"),f=a.data("number"),g=!1;a.on("click",".js-user-delete",function(k){k.preventDefault();var l=d(this).closest(".c-user-wrapper"),h=l.find(".js-name");k=a.find(".js-number");h=h.html();d.waDialog.confirm({title:c.locales.delete_confirm_title.replace("%name%",h).replace("%number%",k.html()),text:c.locales.delete_confirm_text,success_button_title:c.locales.delete_confirm_button,success_button_class:"danger",
cancel_button_title:c.locales.dialog_error_button,cancel_button_class:"light-gray",onSuccess:function(){var m=l.data("id");g||(g=!0,d.post("?module=settingsPBX&action=delete",{p:e,n:f,u:m},function(n){"ok"===n.status&&l.remove()},"json").always(function(){g=!1}))}})});a.on("click",".js-delete-pbx-num",function(){var k=d(this).parents("tr"),l={p:e,n:f};k.addClass("hidden");d.post("?module=settingsPBX&action=deleteNumber",l,function(h){"ok"===h.status?k.remove():k.removeClass("hidden")},"json").always(function(){k.removeClass("hidden")})});
(function(){function k(p){p?h.addClass("is-shown"):h.removeClass("is-shown")}function l(p){n||(n=!0,d.post("?module=settingsPBX&action=add",{p:e,n:f,u:p.id},function(q){"ok"===q.status?(q=d(c.user_template_html),p.photo_url&&q.find(".userpic i").css("background-image","url("+p.photo_url+")"),q.find(".js-name").text(p.name),q.data("id",p.id),m.append(q)):b(q.errors)}).always(function(){n=!1}))}var h=a.find(".js-user-add-wrapper"),m=a.find(".js-users-list"),n=!1;h.on("click",".js-show-combobox",function(p){p.stopPropagation();
k(!0)});h.on("click",".js-hide-combobox",function(p){p.stopPropagation();k(!1)});(function(){var p=h.find(".js-autocomplete");p.length&&(p.autocomplete({appendTo:h,source:d.crm.app_url+"?module=autocomplete&type=user",minLength:0,html:!0,focus:function(){return!1},select:function(q,r){l(r.item);k(!1);p.val("");return!1}}).data("ui-autocomplete")._renderItem=function(q,r){return d("<li />").addClass("ui-menu-item-html").append("<div>"+r.value+"</div>").appendTo(q)},p.on("focus",function(){p.data("uiAutocomplete").search(p.val())}))})()})()};
return CRMSettingsPbxPage}(jQuery);var CRMSettingsTemplate=function(d){CRMSettingsTemplate=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find(".js-template-form");this.$paramsSection=this.$wrapper.find(".c-params-section");this.$param_list=this.$paramsSection.find(".c-params-list");this.$textarea=this.$wrapper.find(".js-content-body");this.$loading_icon=d('<span class="c-notice"><i class="fas fa-spinner wa-animation-spin speed-1000"></i></span>');this.preview_dialog_template=a.preview_dialog_template;this.site_app_url=
a.site_app_url;this.template=a.template||{};this.param_html=a.param_html;this.template_id=a.template_id;this.locales=a.locales;this.company_count=a.company_count;this.ace=null;this.initClass()};CRMSettingsTemplate.prototype.initClass=function(){var a=this;a.initHelp();a.initTabs();a.initAce();a.initSave();a.initDelete();a.initParamsSection();a.initPreviewIframe();a.initIDAutoFiller();a.$form.on("change","input, select, textarea",function(){a.toggleButton(!0)});a.$form.on("input change",function(){a.toggleButton(!0)});
a.initResetTemplate()};CRMSettingsTemplate.prototype.initTabs=function(){var a=this.$wrapper.find(".c-tabs-wrapper"),b=this.$wrapper.find(".c-companies-wrapper"),c=b.find(".c-companies-list"),e=c.find(".c-company.selected");(function(){function f(){d.contains(document,a[0])?g():k.off("resize refresh",f)}function g(){var h=a.outerWidth(!0)-l-38;b.css("max-width",h+"px")}var k=d(window),l=a.find(".c-add-wrapper").outerWidth();g();k.on("resize refresh",f)})();d.crm.tabSlider({$wrapper:b,$slider:c,$activeSlide:e.length?
e:!1})};CRMSettingsTemplate.prototype.initResetTemplate=function(){var a=this,b=a.$wrapper.find(".js-reset-template");a.$wrapper.find(".js-redactor-wrapper").on("keypress",function(){b.removeClass("hidden")});b.on("click",function(){d.post("?module=settings&action=templatesReset","template_id="+a.template_id,function(c){"ok"===c.status&&(d(".js-content-body").text(c.data.template),a.initAce(),a.toggleButton(!0))},"json").always(function(){});b.addClass("hidden")})};CRMSettingsTemplate.prototype.initIDAutoFiller=
function(){var a=null,b,c=this.$param_list,e=this.$form;c.on("change","input.js-code-field",function(){d(this).removeClass("auto-filler")});c.on("keyup","input.js-name-field",function(){var f=d(this),g=f.val(),k=f.parents("tr").find(".js-code-field"),l=k.hasClass("auto-filler"),h=e.find('[type="submit"]');f=k.next(".fa-spinner");!h.prop("disabled")&&l&&(f=f.length?f:d('<span class="c-notice"><i class="fas fa-spinner wa-animation-spin speed-1000"></i></span>'),f.insertAfter(k),h.prop("disabled",!0),
b&&clearTimeout(b),b=setTimeout(function(){a=d.post(d.crm.app_url+"?module=settings&action=fieldTransliterate",{"name[]":g},function(m){a&&(a.abort(),a=null);b&&clearTimeout(b);h.prop("disabled",!1);d(".fa-spinner").remove();"ok"===m.status&&l&&k.val(m.data)},"json")},300))})};CRMSettingsTemplate.prototype.validate=function(){var a=this.$param_list.find(".js-code-field"),b=this.locales;this.$param_list.find(".errormsg").remove();this.$param_list.find(".error").removeClass("error");a.each(function(){var c=
d(this),e=d(this).val(),f=d("<span />").addClass("errormsg"),g=e.search(/^\d/);e=e.search(/[^a-zA-Z0-9_]/);0<=g?(c.addClass("error"),c.after(f.text(b.validate_first_num))):0<=e?(c.addClass("error"),c.after(f.text(b.validate_symbols))):c.hasClass("error")||(f=a.filter(function(){return this.value===c.val()}),2<=f.length&&f.addClass("error").parent().append(d('<span class="errormsg">').text(b.validate_copies)))});return this.$param_list.find(".error").length?!1:!0};CRMSettingsTemplate.prototype.initDelete=
function(){function a(){var e={id:b.template_id};c||(c=!0,d.post("?module=settings&action=templatesDelete",e,function(f){d.crm.content.load(d.crm.app_url+"settings/templates/")},"json").always(function(){c=!1}))}var b=this,c=!1;b.$wrapper.on("click",".js-delete-template",function(e){e.preventDefault();if(b.company_count){var f=d.waDialog.alert({text:b.locales.success_text,button_title:b.locales.success_button});setTimeout(function(){d.contains(document,f.$wrapper[0])&&f.close()},1E4)}else d.waDialog.confirm({title:'<i class="fas fa-exclamation-triangle smaller state-error"></i> '+
b.locales.delete_confirm_title,text:b.locales.delete_confirm_text,success_button_title:b.locales.delete_confirm_button,success_button_class:"danger",cancel_button_title:b.locales.success_button,cancel_button_class:"light-gray",onSuccess:a})})};CRMSettingsTemplate.prototype.initSave=function(){function a(f){d.post("?module=settings&action=templatesSave",f,function(g){"ok"===g.status&&(d(".fa-spinner").remove(),d('<span class="c-notice"><i class="fas fa-check"></i></span>').insertAfter(e),d.crm.content.load(d.crm.app_url+
"settings/templates/"+g.data.id+"/"))},"json").always(function(){c=!1})}var b=this,c=!1,e=b.$wrapper.find(".js-template-save-button");$loading=b.$loading_icon;b.$form.on("submit",function(f){f.preventDefault();d(document).trigger("updateEditorTextarea");$loading.insertAfter(e);if(!b.validate())return!1;!c&&(f=b.$form.serializeArray())&&(c=!0,a(f))})};CRMSettingsTemplate.prototype.initParamsSection=function(){var a=this,b=a.$paramsSection;b.on("click",".js-delete-param",function(c){c.preventDefault();
d(this).closest("tr").remove();a.toggleButton(!0)});b.on("click",".js-add-param",function(c){c.preventDefault();c=d(a.param_html);a.$param_list.append(c);a.toggleButton(!0)})};CRMSettingsTemplate.prototype.toggleButton=function(a){var b=this.$wrapper.find(".js-template-save-button"),c=this.$wrapper.find(".js-hidden-actions");a?(b.addClass("yellow"),c.show()):(b.removeClass("yellow"),c.hide())};CRMSettingsTemplate.prototype.initAce=function(){var a=this;a.$wrapper.find(".js-redactor-wrapper").each(function(b){var c=
d(this),e=c.find("textarea"),f=d('<div class="js-redactor" />'),g="js-textarea-"+b;b="js-redactor-"+b;f.attr("id",b).appendTo(c);e.attr("id",g);waEditorAceInit({id:g,ace_editor_container:b});"undefined"!==typeof wa_editor&&f.data("wa_editor",wa_editor);e.data("wa_editor",f.data("wa_editor"));e.on("editorDataUpdated",function(){var k=f.data("wa_editor");k&&k.getSession().setValue(e.val())});setTimeout(function(){f.data("wa_editor").on("input",function(){a.toggleButton(!0)})},100);d(document).on("updateEditorTextarea",
function(){var k=f.data("wa_editor");k&&(k=k.getValue(),e.val(k).trigger("change"))})})};CRMSettingsTemplate.prototype.initHelp=function(){function a(g){e.drawerWrapper=d(".drawer");e.drawerContent=e.drawerWrapper.find(".drawer-content");g?(e.drawerWrapper.on("click","ul.tabs li",b),e.drawerWrapper.on("click",".wa-help-vars-item",c),e.drawerWrapper.on("click",".drawer-background",()=>e.drawer.hide())):(e.drawerWrapper.off("click"),f=!1)}function b(g){g.preventDefault();if(d(this).hasClass("selected"))return!1;
g=d(this).attr("id")+"-content";d(this).addClass("selected").siblings().removeClass("selected");g=e.drawerContent.find(`#${g}`);g.siblings().hide();g.show()}function c(g){g.preventDefault();$body=e.$textarea;if(g=$body.data("wa_editor"))g.insert(d.trim(d(this).find(".js-var").text())),e.toggleButton(!0),e.$wrapper.find(".js-reset-template").removeClass("hidden"),e.drawer.hide()}var e=this,f=!1;d("#wa-editor-help-link").on("click",function(g){g.preventDefault();g=d.crm.app_url+"?module=settings&action=help";
var k="app=crm&key=invoice&invoice_template_id="+e.template_id;if(f)return e.drawer.show(),!1;e.drawer=d.waDrawer({html:'<div class="drawer crm-help" id=""> <div class="drawer-background"></div> <div class="drawer-body"> <a href="#" class="drawer-close js-close-drawer"><i class="fas fa-times"></i></a> <div class="drawer-block"><div class="flexbox middle width-100 height-100 spinner-wrapper"><div class="spinner custom-p-16"></div></div></div> </div> </div> ',direction:"right",onClose:()=>a(!1)});d.get(g,
k,function(l){d(".drawer .drawer-block").html(l);a(!0);f=!0},"html")})};CRMSettingsTemplate.prototype.initPreviewIframe=function(){function a(){d(document).trigger("updateEditorTextarea");b.toggleButton(!1);d.waDialog({html:b.preview_dialog_template,onOpen:function(c){c.find("#js-preview-content").val(b.$textarea.val());c.find(".js-preview-form").trigger("submit")}})}var b=this;b.$wrapper.on("click",".js-show-preview",function(c){c.preventDefault();a()})};return CRMSettingsTemplate}(jQuery);var CRMEmailPersonalSettingsDialog=function(d){CRMEmailPersonalSettingsDialog=function(a){this.$wrapper=a.$wrapper;this.$form=this.$wrapper.find("form");this.$textarea=this.$wrapper.find(".js-wysiwyg-field");this.dialog=this.$wrapper.data("dialog");a=!1;window&&window.parent&&window.parent.$&&window.parent.$.crm?a=window.parent.$.crm:window.$&&window.$.crm&&(a=window.$.crm);this.crm=a;this.initClass()};CRMEmailPersonalSettingsDialog.prototype.initClass=function(){this.initWYSIWYG();this.initSave()};
CRMEmailPersonalSettingsDialog.prototype.initSave=function(){function a(){if(!c){c=!0;var e=b.$form.serialize();d.post(b.crm.app_url+"?module=email&action=personalSettingsSave",e,function(f){"ok"===f.status&&(b.dialog.options.onSave(f.data||{}),b.dialog.close())}).always(function(){c=!1})}}var b=this,c=!1;b.$form.on("submit",function(e){e.preventDefault();a()})};CRMEmailPersonalSettingsDialog.prototype.initWYSIWYG=function(){var a=this.$textarea;this.crm.initWYSIWYG(a,{minHeight:130,maxHeight:130,
keydownCallback:function(b){}});this.dialog.onClose=function(){var b=a.data("redactor");b&&"core"in b&&b.core.destroy()}};return CRMEmailPersonalSettingsDialog}(jQuery);
//# sourceMappingURL=crm.min.js.map